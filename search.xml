<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Linux环境下MySQL的搭建</title>
      <link href="/2021/11/22/15217/hub/"/>
      <url>/2021/11/22/15217/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20211122090644997.png" alt="image-20211122090644997"></p><p>&emsp;&emsp;MySQL是一个关系型数据库管理系统、本章内容我采用MySQL5.7版本进行一个安装。当然，我依旧建议使用云服务器，可以避免一系列的未知问题。由于本章内容涉及到了Docker容器化技术，如果没有学习过Docker可以跳过Docker部分的安装，使用前面三种方式依旧可以安装部署好MySQL。如果想要Docker的安装可以查看Docker相关的文章。</p><p>&emsp;&emsp;需要注意的是如果文件、文件夹的名称不同下面的命令一定要注意改成自己的名称。每一种方式的安装我都进行了<strong>重装系统</strong>。</p><h2 id="MySQL相关的下载"><a href="#MySQL相关的下载" class="headerlink" title="MySQL相关的下载"></a>MySQL相关的下载</h2><h3 id="进入mysql的下载页"><a href="#进入mysql的下载页" class="headerlink" title="进入mysql的下载页"></a>进入mysql的下载页</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//dev.mysql.com/downloads/mysql/5.7.html#downloads</span></span><br></pre></td></tr></table></figure><h3 id="选择对应的版本"><a href="#选择对应的版本" class="headerlink" title="选择对应的版本"></a>选择对应的版本</h3><p><img src="/image/hexo/image-20211122124118776.png" alt="image-20211122124118776"></p><p>&emsp;&emsp;这里下载缓慢、我后面会提供百度网盘的下载地址。有兴趣的可以在官方网站进行下载。</p><h2 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h2><p>&emsp;&emsp;注意一定要到<strong>/usr/local</strong>这个目录。</p><h3 id="百度网盘下载地址"><a href="#百度网盘下载地址" class="headerlink" title="百度网盘下载地址"></a>百度网盘下载地址</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">链接: https:<span class="comment">//pan.baidu.com/s/1ZZCrwewVa8GY2hPG1K0neA  密码: viv0</span></span><br><span class="line">上传到服务器/data/mysql目录</span><br></pre></td></tr></table></figure><h3 id="或者在官网找到下载地址、例如这里我使用wget下载到服务器"><a href="#或者在官网找到下载地址、例如这里我使用wget下载到服务器" class="headerlink" title="或者在官网找到下载地址、例如这里我使用wget下载到服务器"></a>或者在官网找到下载地址、例如这里我使用wget下载到服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/mysql</span><br><span class="line">cd /data/mysql</span><br><span class="line">wget https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-5.7.36-linux-glibc2.12-x86_64.tar.gz</span><br></pre></td></tr></table></figure><h3 id="解压二进制安装包"><a href="#解压二进制安装包" class="headerlink" title="解压二进制安装包"></a>解压二进制安装包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">tar -xvf mysql-5.7.36-linux-glibc2.12-x86_64.tar.gz -C /usr/local/</span><br><span class="line">cd /usr/local/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重命名</span></span><br><span class="line">mv mysql-5.7.36-linux-glibc2.12-x86_64 mysql</span><br></pre></td></tr></table></figure><h3 id="检查并且添加mysql用户、授权"><a href="#检查并且添加mysql用户、授权" class="headerlink" title="检查并且添加mysql用户、授权"></a>检查并且添加mysql用户、授权</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加mysql用户</span></span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql mysql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 授权</span></span><br><span class="line">chown -R mysql:mysql /usr/local/mysql</span><br><span class="line">chmod -R 755 /usr/local/mysql/</span><br></pre></td></tr></table></figure><h3 id="添加data目录"><a href="#添加data目录" class="headerlink" title="添加data目录"></a>添加data目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/mysql</span><br><span class="line">mkdir data</span><br></pre></td></tr></table></figure><h3 id="删除-etc-my-cnf"><a href="#删除-etc-my-cnf" class="headerlink" title="删除/etc/my.cnf"></a>删除/etc/my.cnf</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /etc/my.cnf</span><br></pre></td></tr></table></figure><h3 id="初始化mysql"><a href="#初始化mysql" class="headerlink" title="初始化mysql"></a>初始化mysql</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --datadir=/usr/local/mysql/data --basedir=/usr/local/mysql</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;–initialize-insecure表示初始化不需要密码登陆。登陆后修改密码。</p><h3 id="复制资源脚本"><a href="#复制资源脚本" class="headerlink" title="复制资源脚本"></a>复制资源脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/mysql/support-files/mysql.server /etc/rc.d/init.d/mysqld</span><br></pre></td></tr></table></figure><h3 id="服务控制脚本添加加执行权限"><a href="#服务控制脚本添加加执行权限" class="headerlink" title="服务控制脚本添加加执行权限"></a>服务控制脚本添加加执行权限</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /etc/rc.d/init.d/mysqld</span><br></pre></td></tr></table></figure><h3 id="添加mysql自启动服务"><a href="#添加mysql自启动服务" class="headerlink" title="添加mysql自启动服务"></a>添加mysql自启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --add mysqld</span><br></pre></td></tr></table></figure><h3 id="添加mysql软链接"><a href="#添加mysql软链接" class="headerlink" title="添加mysql软链接"></a>添加mysql软链接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/lcoal/mysql/bin/mysql /usr/bin</span><br></pre></td></tr></table></figure><h3 id="启动mysql"><a href="#启动mysql" class="headerlink" title="启动mysql"></a>启动mysql</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br></pre></td></tr></table></figure><h3 id="无密码登陆mysql"><a href="#无密码登陆mysql" class="headerlink" title="无密码登陆mysql"></a>无密码登陆mysql</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql</span><br></pre></td></tr></table></figure><h3 id="修改root密码"><a href="#修改root密码" class="headerlink" title="修改root密码"></a>修改root密码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新密码</span></span><br><span class="line">update user set authentication_string=PASSWORD("adminxxx") where user='root';</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 授权远程root访问 生产环境不开放 也不建议采用弱密码口令</span></span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'adminxxx' WITH GRANT OPTION; </span><br><span class="line"></span><br><span class="line">update user set plugin="mysql_native_password";</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 刷新权限</span></span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">exit;</span><br></pre></td></tr></table></figure><h3 id="重启mysql"><a href="#重启mysql" class="headerlink" title="重启mysql"></a>重启mysql</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart;</span><br></pre></td></tr></table></figure><h3 id="使用root登陆"><a href="#使用root登陆" class="headerlink" title="使用root登陆"></a>使用root登陆</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211122135851556.png" alt="image-20211122135851556"></p><h3 id="测试root远程链接"><a href="#测试root远程链接" class="headerlink" title="测试root远程链接"></a>测试root远程链接</h3><p>&emsp;&emsp;可以使用其他软件进行连接，我使用DataGrid可以正常连接数据库。</p><p><img src="/image/hexo/image-20211122140436730.png" alt="image-20211122140436730"></p><h2 id="源码编译安装"><a href="#源码编译安装" class="headerlink" title="源码编译安装"></a>源码编译安装</h2><h3 id="百度网盘源码包"><a href="#百度网盘源码包" class="headerlink" title="百度网盘源码包"></a>百度网盘源码包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">链接: https://pan.baidu.com/s/1NZ2g-WR-5oi6cMSH05ETdg  密码: 0sap</span><br><span class="line"><span class="meta">#</span><span class="bash"> 手动上传到服务器的/data/mysql目录</span></span><br></pre></td></tr></table></figure><h3 id="下载源码包"><a href="#下载源码包" class="headerlink" title="下载源码包"></a>下载源码包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/mysql</span><br><span class="line">cd /data/mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> mysql-boost方式安装</span></span><br><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.32.tar.gz</span><br></pre></td></tr></table></figure><h3 id="yum安装相关所需依赖"><a href="#yum安装相关所需依赖" class="headerlink" title="yum安装相关所需依赖"></a>yum安装相关所需依赖</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ ncurses ncurses-devel cmake bison bison-devel libaio-devel</span><br></pre></td></tr></table></figure><h3 id="解压源文件"><a href="#解压源文件" class="headerlink" title="解压源文件"></a>解压源文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-boost-5.7.32.tar.gz -C /usr/local/</span><br></pre></td></tr></table></figure><h3 id="cmake编译"><a href="#cmake编译" class="headerlink" title="cmake编译"></a>cmake编译</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/mysql5.7</span><br><span class="line">cmake -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -DWITH_BOOST=boost</span><br></pre></td></tr></table></figure><h3 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="make编译"><a href="#make编译" class="headerlink" title="make编译"></a>make编译</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 这里可能会等待很久很久</span></span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h3 id="初始化目录"><a href="#初始化目录" class="headerlink" title="初始化目录"></a>初始化目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建data</span></span><br><span class="line">mkdir -p /data/mysql/data</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建<span class="built_in">log</span></span></span><br><span class="line">mkdir -p /var/mysql/log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 授权data</span></span><br><span class="line">chown -R mysql:mysql /data</span><br><span class="line">chown -R mysql:mysql /usr/local/mysql</span><br></pre></td></tr></table></figure><h3 id="编辑配置文件"><a href="#编辑配置文件" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 覆盖内容</span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">user=mysql</span><br><span class="line">datadir=/data/mysql/data</span><br><span class="line">log_error=/data/mysql/log/error.log</span><br><span class="line">basedir=/usr/local/mysql</span><br><span class="line">socket=/usr/local/mysql/mysql.sock</span><br><span class="line">pid-file=/usr/local/mysql/mysqld.pid</span><br><span class="line">default-storage-engine=INNODB</span><br><span class="line">max_connections=200</span><br><span class="line">character-set-server=utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">port=3306</span><br><span class="line">default-character-set=utf8</span><br><span class="line">socket=/usr/local/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">port=3306</span><br><span class="line">default-character-set=utf8</span><br><span class="line">socket=/usr/local/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">!includedir /etc/my.cnf.d</span><br></pre></td></tr></table></figure><h3 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mysql/bin/mysqld  --initialize --user=mysql</span><br><span class="line">cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br></pre></td></tr></table></figure><h3 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure><h3 id="设置自启动"><a href="#设置自启动" class="headerlink" title="设置自启动"></a>设置自启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig mysqld on</span><br></pre></td></tr></table></figure><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> 底部添加内容</span></span><br><span class="line">PATH=$PATH:/usr/local/mysql/bin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 刷新</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h3 id="获取默认root密码"><a href="#获取默认root密码" class="headerlink" title="获取默认root密码"></a>获取默认root密码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /data/mysql/log/error.log |grep 'password'</span><br></pre></td></tr></table></figure><h3 id="测试登陆并且修改root密码"><a href="#测试登陆并且修改root密码" class="headerlink" title="测试登陆并且修改root密码"></a>测试登陆并且修改root密码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入密码</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新root密码</span></span><br><span class="line">use mysql;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新密码</span></span><br><span class="line">update user set authentication_string=PASSWORD("adminxxx") where user='root';</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 授权远程root访问 生产环境不开放 也不建议采用弱密码口令</span></span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'adminxxx' WITH GRANT OPTION; </span><br><span class="line"></span><br><span class="line">update user set plugin="mysql_native_password";</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 刷新权限</span></span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">exit;</span><br></pre></td></tr></table></figure><h3 id="测试mysql远程访问"><a href="#测试mysql远程访问" class="headerlink" title="测试mysql远程访问"></a>测试mysql远程访问</h3><p><img src="/image/hexo/image-20211122140436730.png" alt="image-20211122140436730"></p><h2 id="rpm包安装"><a href="#rpm包安装" class="headerlink" title="rpm包安装"></a>rpm包安装</h2><h2 id="docker默认安装"><a href="#docker默认安装" class="headerlink" title="docker默认安装"></a>docker默认安装</h2><h2 id="docker挂载安装"><a href="#docker挂载安装" class="headerlink" title="docker挂载安装"></a>docker挂载安装</h2>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> shelle </category>
          
          <category> docker </category>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> shelle </tag>
            
            <tag> docker </tag>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux环境下Nginx的部署</title>
      <link href="/2021/11/18/48707/hub/"/>
      <url>/2021/11/18/48707/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20211118155731285.png" alt="image-20211118155731285"></p><p>&emsp;&emsp;本章内容需要1-2台虚拟机或者服务器。建议使用云服务器、使用虚拟机可能会有很多不可预知的情况出现。使用云服务器的话需要注意安全组的开放以及云服务器的防火墙设置。</p><h2 id="Nginx介绍"><a href="#Nginx介绍" class="headerlink" title="Nginx介绍"></a>Nginx介绍</h2><h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>&emsp;&emsp;Nginx是一款轻量级的Web服务器、反向代理服务器，由于它的内存占用少，启动极快，高并发能力强，在互联网项目中广泛应用。</p><p>&emsp;&emsp;1.图片、音视频等资源类的文件、我们需要提供给外部访问的时候，大多数需要tomcat等web容器。但是Nginx可以直接更加简单方便的实现一点。</p><p>&emsp;&emsp;2.多个内网应用的时候，我们需要将内部的端口在外网进行访问，但是80端口只有一个。那可以采用域名的方式反向代理内网的域名。实现多个内网应用使用不同的域名进行80端口的访问或者443端口的访问。</p><p>&emsp;&emsp;3.当我们有多个集群的内网应用时，我们可以根据Nginx的负载均衡更快捷的实现集群环境下的内网部署。</p><h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p><img src="/image/hexo/image-20211118160828644.png" alt="image-20211118160828644"></p><h3 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h3><p><img src="/image/hexo/image-20211118160810958.png" alt="image-20211118160810958"></p><h2 id="搭建Nginx单机-yum"><a href="#搭建Nginx单机-yum" class="headerlink" title="搭建Nginx单机(yum)"></a>搭建Nginx单机(yum)</h2><h3 id="安装epel-release"><a href="#安装epel-release" class="headerlink" title="安装epel-release"></a>安装epel-release</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release</span><br></pre></td></tr></table></figure><h3 id="更新yum"><a href="#更新yum" class="headerlink" title="更新yum"></a>更新yum</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update</span><br></pre></td></tr></table></figure><h3 id="使用yum安装nginx"><a href="#使用yum安装nginx" class="headerlink" title="使用yum安装nginx"></a>使用yum安装nginx</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx -y</span><br></pre></td></tr></table></figure><h3 id="测试启动Nginx"><a href="#测试启动Nginx" class="headerlink" title="测试启动Nginx"></a>测试启动Nginx</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;使用IP访问看见Nginx的页面表示成功安装。</p><p><img src="/image/hexo/image-20211118171436891.png" alt="image-20211118171436891"></p><h3 id="默认配置文件目录"><a href="#默认配置文件目录" class="headerlink" title="默认配置文件目录"></a>默认配置文件目录</h3><p>&emsp;&emsp;后面配置反向代理的时候会有用。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/</span><br></pre></td></tr></table></figure><h2 id="搭建Nginx单机-编译源文件"><a href="#搭建Nginx单机-编译源文件" class="headerlink" title="搭建Nginx单机(编译源文件)"></a>搭建Nginx单机(编译源文件)</h2><h3 id="安装所需的依赖包"><a href="#安装所需的依赖包" class="headerlink" title="安装所需的依赖包"></a>安装所需的依赖包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pcre-devel zlib-devel openssl-devel wget gcc tree vim</span><br></pre></td></tr></table></figure><h3 id="查看最新的Nginx版本"><a href="#查看最新的Nginx版本" class="headerlink" title="查看最新的Nginx版本"></a>查看最新的Nginx版本</h3><p><a href="http://nginx.org/download/" target="_blank" rel="noopener">Nginx官网</a>目前最新的版本为1.9.9</p><p><img src="/image/hexo/image-20211118170013048.png" alt="image-20211118170013048"></p><h3 id="下载解压Nginx安装包"><a href="#下载解压Nginx安装包" class="headerlink" title="下载解压Nginx安装包"></a>下载解压Nginx安装包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/nginx</span><br><span class="line">cd /data/nginx</span><br><span class="line">wget https://nginx.org/download/nginx-1.9.9.tar.gz</span><br><span class="line">tar -xzvf nginx-1.9.9.tar.gz</span><br><span class="line">cd nginx-1.9.9</span><br></pre></td></tr></table></figure><h3 id="查看Nginx的目录结构"><a href="#查看Nginx的目录结构" class="headerlink" title="查看Nginx的目录结构"></a>查看Nginx的目录结构</h3><p><img src="/image/hexo/image-20211118170805602.png" alt="image-20211118170805602"></p><h3 id="添加SSL模块"><a href="#添加SSL模块" class="headerlink" title="添加SSL模块"></a>添加SSL模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx --with-http_ssl_module</span><br></pre></td></tr></table></figure><h3 id="编译Nginx"><a href="#编译Nginx" class="headerlink" title="编译Nginx"></a>编译Nginx</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="启动Nginx"><a href="#启动Nginx" class="headerlink" title="启动Nginx"></a>启动Nginx</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure><h3 id="测试Nginx是否安装成功"><a href="#测试Nginx是否安装成功" class="headerlink" title="测试Nginx是否安装成功"></a>测试Nginx是否安装成功</h3><p><img src="/image/hexo/image-20211118171439538.png" alt="image-20211118171439538"></p><p>&emsp;&emsp;注意以下的操作会使用编译源文件的方式进行配置、使用yum的方式配置大同小异。</p><h2 id="配置静态文件代理"><a href="#配置静态文件代理" class="headerlink" title="配置静态文件代理"></a>配置静态文件代理</h2><h3 id="查看默认的nginx-conf"><a href="#查看默认的nginx-conf" class="headerlink" title="查看默认的nginx.conf"></a>查看默认的nginx.conf</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">    #                  '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">    #                  '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       <span class="number">80</span>;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /<span class="number">50</span>x.html;</span><br><span class="line">        location = /<span class="number">50</span>x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    proxy_pass   http://127.0.0.1;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    root           html;</span><br><span class="line">        #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        #    fastcgi_index  index.php;</span><br><span class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">        #    include        fastcgi_params;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        # deny access to .htaccess files, if Apache's document root</span><br><span class="line">        # concurs with nginx's one</span><br><span class="line">        #</span><br><span class="line">        #location ~ /\.ht &#123;</span><br><span class="line">        #    deny  all;</span><br><span class="line">        #&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # another virtual host using mix of IP-, name-, and port-based configuration</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       8000;</span><br><span class="line">    #    listen       somename:8080;</span><br><span class="line">    #    server_name  somename  alias  another.alias;</span><br><span class="line"></span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # HTTPS server</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       443 ssl;</span><br><span class="line">    #    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #    ssl_certificate      cert.pem;</span><br><span class="line">    #    ssl_certificate_key  cert.key;</span><br><span class="line"></span><br><span class="line">    #    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    #    ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">    #    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    #    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="修改默认的nginx-conf"><a href="#修改默认的nginx-conf" class="headerlink" title="修改默认的nginx.conf"></a>修改默认的nginx.conf</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">user  root;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line">error_log  /usr/local/nginx/logs/error.log notice;</span><br><span class="line">pid        /<span class="keyword">var</span>/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /usr/local/nginx/conf/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /usr/local/nginx/logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    include /usr/local/nginx/conf/conf.d<span class="comment">/*.conf;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;注意<strong>* include /usr/local/nginx/conf/conf.d/*.conf;</strong>这里会将conf.d目录下的配置文件全部加载。这样可以根据不同的需求配置很多个不同的文件，不需要全部在nginx.conf里面杂糅。</p><h3 id="新增conf-d文件夹"><a href="#新增conf-d文件夹" class="headerlink" title="新增conf.d文件夹"></a>新增conf.d文件夹</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/nginx/conf/conf.d</span><br></pre></td></tr></table></figure><h3 id="在conf-d文件夹新增recouse-conf"><a href="#在conf-d文件夹新增recouse-conf" class="headerlink" title="在conf.d文件夹新增recouse.conf"></a>在conf.d文件夹新增recouse.conf</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/conf/conf.d</span><br><span class="line">vi recouse.conf</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       801;</span><br><span class="line">        # 这里可以写ip也可以写域名</span><br><span class="line">        server_name  192.168.9.223;</span><br><span class="line">        </span><br><span class="line">        root         /usr/local/nginx/; </span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="重启Nginx"><a href="#重启Nginx" class="headerlink" title="重启Nginx"></a>重启Nginx</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin</span><br><span class="line">./nginx</span><br><span class="line">/usr/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure><h3 id="测试访问下能否正常下载"><a href="#测试访问下能否正常下载" class="headerlink" title="测试访问下能否正常下载"></a>测试访问下能否正常下载</h3><p><a href="http://192.168.9.223:801/conf/nginx.conf" target="_blank" rel="noopener">http://192.168.9.223:801/conf/nginx.conf</a></p><p>&emsp;&emsp;这里会将/usr/local/nginx/下的文件进行一个代理，直接通过浏览器就能直接进行下载文件了。如果是html文件，那就可以直接部署成为一个网站应用。</p><h2 id="配置路由转发代理"><a href="#配置路由转发代理" class="headerlink" title="配置路由转发代理"></a>配置路由转发代理</h2><h3 id="在conf-d建立proxy-conf"><a href="#在conf-d建立proxy-conf" class="headerlink" title="在conf.d建立proxy.conf"></a>在conf.d建立proxy.conf</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen <span class="number">802</span>;</span><br><span class="line">        server_name <span class="number">192.168</span><span class="number">.9</span><span class="number">.223</span>;</span><br><span class="line">       </span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="comment">//127.0.0.1:9528;</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果我们部署了一个tomcat或者说其他的web应用。我们可以通过proxy_pass进行一个转发。那这样我们可以用<a href="http://192.168.9.223:801的方式访问到服务器内部http://127.0.0.1:9528的资源。">http://192.168.9.223:801的方式访问到服务器内部http://127.0.0.1:9528的资源。</a></p><h3 id="重启Nginx-1"><a href="#重启Nginx-1" class="headerlink" title="重启Nginx"></a>重启Nginx</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -s reload</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211118174028351.png" alt="image-20211118174028351"></p><p>&emsp;&emsp;由于我这里没有启动端口为9528的应用，所以访问502了，也证明了转发是正常的。</p><h2 id="配置负载均衡"><a href="#配置负载均衡" class="headerlink" title="配置负载均衡"></a>配置负载均衡</h2><h3 id="在conf-d下新建load-conf"><a href="#在conf-d下新建load-conf" class="headerlink" title="在conf.d下新建load.conf"></a>在conf.d下新建load.conf</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream load &#123;</span><br><span class="line">    server <span class="number">192.168</span><span class="number">.9</span><span class="number">.223</span>:<span class="number">9528</span> weight=<span class="number">10</span>;</span><br><span class="line">    server <span class="number">192.168</span><span class="number">.9</span><span class="number">.223</span>:<span class="number">9529</span> weight=<span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen <span class="number">803</span>;</span><br><span class="line">        server_name <span class="number">192.168</span><span class="number">.9</span><span class="number">.223</span>;</span><br><span class="line">       </span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="comment">//load;</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果有集群应用的情况、那么我们可以通过upstream模块进行一个负载均衡配置。nginx会根据weight权重实现一个负载均衡，当然他还有一系列的策略，这里不进行展开的描述里。</p><h2 id="一些常见的域名配置"><a href="#一些常见的域名配置" class="headerlink" title="一些常见的域名配置"></a>一些常见的域名配置</h2><h3 id="例如配置80端口的转发"><a href="#例如配置80端口的转发" class="headerlink" title="例如配置80端口的转发"></a>例如配置80端口的转发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen <span class="number">80</span>;</span><br><span class="line">        server_name xxxxA.com;</span><br><span class="line">       </span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="comment">//127.0.0.1:9528;</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen <span class="number">80</span>;</span><br><span class="line">        server_name xxxxB.com;</span><br><span class="line">       </span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http:<span class="comment">//127.0.0.1:9529;</span></span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="例如配置80端口的静态页面"><a href="#例如配置80端口的静态页面" class="headerlink" title="例如配置80端口的静态页面"></a>例如配置80端口的静态页面</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       <span class="number">80</span>; </span><br><span class="line">        server_name  xxxxA.com;</span><br><span class="line">        </span><br><span class="line">        root         /usr/local/nginxA/; </span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen       <span class="number">80</span>;</span><br><span class="line">        # 这里可以写ip也可以写域名</span><br><span class="line">        server_name  xxxxB.com;</span><br><span class="line">        </span><br><span class="line">        root         /usr/local/nginxB/; </span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="Nginx配置Https"><a href="#Nginx配置Https" class="headerlink" title="Nginx配置Https"></a>Nginx配置Https</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">443</span>;</span><br><span class="line">       server_name xxx.com;</span><br><span class="line">       ssl on;</span><br><span class="line">  </span><br><span class="line">       ssl_certificate   xxxxx.pem;</span><br><span class="line">       ssl_certificate_key  xxxx.key;</span><br><span class="line">       ssl_session_timeout <span class="number">5</span>m;</span><br><span class="line">       ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">       ssl_protocols TLSv1 TLSv1<span class="number">.1</span> TLSv1<span class="number">.2</span>;</span><br><span class="line">       ssl_prefer_server_ciphers on;</span><br><span class="line">        location / &#123;</span><br><span class="line">           proxy_pass   http:<span class="comment">//127.0.0.1:9527;</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;https需要监听443端口，并且配置https安全证书。</p><p>&emsp;&emsp;ssl_certificate:这里需要把pem证书上传到服务器、这里填写pem的绝对路径地址。<br>&emsp;&emsp;ssl_certificate_key:这里需要把key上传到服务器、这里填写key的绝对路径地址。</p><p>&emsp;&emsp;实际上https的配置和http差距不大，只是监听的端口不同、以及需要配置https安全证书。https安全证书可以阿里云或者腾讯云免费申请，有一年的免费使用权，过期可以重新再次申请。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>yum源不可用快捷修改的方式</title>
      <link href="/2021/11/18/15217/hub/"/>
      <url>/2021/11/18/15217/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20211118161940532.png" alt="image-20211118161940532"></p><p>&emsp;&emsp;大多在使用虚拟机部署的Linux服务器的时候会遇到yum源不可用的情况。这里我们提供两个快捷的更新yum源的方式。</p><h2 id="wget方式"><a href="#wget方式" class="headerlink" title="wget方式"></a>wget方式</h2><h3 id="备份CentOS-Base-repo"><a href="#备份CentOS-Base-repo" class="headerlink" title="备份CentOS-Base.repo"></a>备份CentOS-Base.repo</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/yum.repos.d/</span><br><span class="line">mv CentOS-Base.repo CentOS-Base.repo.back</span><br></pre></td></tr></table></figure><h3 id="下载阿里云CentOS-Base-repo"><a href="#下载阿里云CentOS-Base-repo" class="headerlink" title="下载阿里云CentOS-Base.repo"></a>下载阿里云CentOS-Base.repo</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</span><br></pre></td></tr></table></figure><h3 id="重新加载yum源"><a href="#重新加载yum源" class="headerlink" title="重新加载yum源"></a>重新加载yum源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h2 id="手动下载CentOS-Base-repo"><a href="#手动下载CentOS-Base-repo" class="headerlink" title="手动下载CentOS-Base.repo"></a>手动下载CentOS-Base.repo</h2><p>&emsp;&emsp;可能虚拟机本来都没有wget指令、也无法通过yum进行安装。那我们可以在电脑上下载</p><p>CentOS-Base.repo文件、拷贝到虚拟机内。重新加载yum源即可。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> yum </category>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> yum </tag>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>水印PDFdemo搭建流程(Gradle)</title>
      <link href="/2021/11/15/51167/hub/"/>
      <url>/2021/11/15/51167/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20211115112836340.png" alt="image-20211115112836340"></p><p>&emsp;&emsp;此文章需要安装<strong>Gradle</strong>环境、<strong>Gradle</strong>与<strong>Maven</strong>类似、用法上大同小异。</p><h2 id="构建项目"><a href="#构建项目" class="headerlink" title="构建项目"></a>构建项目</h2><h3 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h3><p><img src="/image/hexo/image-20211115113040774.png" alt="image-20211115113040774"></p><p><img src="/image/hexo/image-20211115113125232.png" alt="image-20211115113125232"></p><p><img src="/image/hexo/image-20211115113401861.png" alt="image-20211115113401861"></p><h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p><img src="/image/hexo/image-20211115113815894.png" alt="image-20211115113815894"></p><h3 id="添加SpringBoot依赖"><a href="#添加SpringBoot依赖" class="headerlink" title="添加SpringBoot依赖"></a>添加SpringBoot依赖</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">implementation</span> <span class="string">'org.springframework.boot:spring-boot-starter-web:2.5.6'</span></span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211115114644873.png" alt="image-20211115114644873"></p><h3 id="使用阿里云国内maven库"><a href="#使用阿里云国内maven库" class="headerlink" title="使用阿里云国内maven库"></a>使用阿里云国内maven库</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">repositories</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">//mavenCentral()</span></span><br><span class="line">    <span class="string">maven&#123;</span></span><br><span class="line">        <span class="string">url</span> <span class="string">'https://maven.aliyun.com/nexus/content/repositories/central/'</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211115115501793.png" alt="image-20211115115501793"></p><h3 id="刷新依赖"><a href="#刷新依赖" class="headerlink" title="刷新依赖"></a>刷新依赖</h3><p><img src="/image/hexo/image-20211115114750223.png" alt="image-20211115114750223"></p><p>&emsp;&emsp;安静等待依赖刷新完成……</p><h3 id="新建SpringBoot启动类"><a href="#新建SpringBoot启动类" class="headerlink" title="新建SpringBoot启动类"></a>新建SpringBoot启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">        System.out.println(<span class="string">"SpringBoot启动成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211115115729814.png" alt="image-20211115115729814"></p><h3 id="启动Application"><a href="#启动Application" class="headerlink" title="启动Application"></a>启动Application</h3><p>&emsp;&emsp; 执行Application的main方法便可启动SpringBoot.观察控制台是否输出成功信息。</p><p><img src="/image/hexo/image-20211115115913215.png" alt="image-20211115115913215"></p><p>&emsp;&emsp;从控制台的信息中可以查看到Tomcat启动的端口<strong>8080</strong>,以及启动成功的日志信息。</p><h3 id="使用SpringBoot测试Web访问是否成功"><a href="#使用SpringBoot测试Web访问是否成功" class="headerlink" title="使用SpringBoot测试Web访问是否成功"></a>使用SpringBoot测试Web访问是否成功</h3><p>&emsp;&emsp;  新增一个控制器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我是第一个SpringBoot应用"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211115120226657.png" alt="image-20211115120226657"></p><p>&emsp;&emsp;重新启动Application。在浏览器进行访问<strong><a href="http://127.0.0.1:8080/hello" target="_blank" rel="noopener">http://127.0.0.1:8080/hello</a></strong></p><p><img src="/image/hexo/image-20211115120342891.png" alt="image-20211115120342891"></p><p>&emsp;&emsp;第一章节SpringBoot项目搭建完成。</p><h2 id="水印PDF项目V1"><a href="#水印PDF项目V1" class="headerlink" title="水印PDF项目V1"></a>水印PDF项目V1</h2><h3 id="流程拆解"><a href="#流程拆解" class="headerlink" title="流程拆解"></a>流程拆解</h3><p><img src="/image/hexo/image-20211115143844303.png" alt="image-20211115143844303"></p><h3 id="代码拆解"><a href="#代码拆解" class="headerlink" title="代码拆解"></a>代码拆解</h3><p><img src="/image/hexo/image-20211115145242952.png" alt="image-20211115145242952"></p><h3 id="编写控制器"><a href="#编写控制器" class="headerlink" title="编写控制器"></a>编写控制器</h3><p><img src="/image/hexo/image-20211115151721036.png" alt="image-20211115151721036"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传控制器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filenames 批量上传的文件集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/pdf/watermark/upload"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile[] filenames)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (MultipartFile multipartFile : filenames) &#123;</span><br><span class="line">            <span class="comment">//打印数据</span></span><br><span class="line">            System.out.println(multipartFile.getOriginalFilename() + <span class="string">" FileSize:"</span> + multipartFile.getSize());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"这是等待生成的下载地址"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>PostMapping:</strong>指定POST请求方式。</p><p>&emsp;&emsp;<strong>MultipartFile[] filenames:</strong>接受web提交的多个文件。</p><p>&emsp;&emsp;<strong>/pdf/watermark/upload:</strong>指定web请求的url。</p><h3 id="使用POSTMAN测试文件上传"><a href="#使用POSTMAN测试文件上传" class="headerlink" title="使用POSTMAN测试文件上传"></a>使用POSTMAN测试文件上传</h3><p>&emsp;&emsp;需要先安装好软件<strong>POSTMAN</strong>。</p><p><img src="/image/hexo/image-20211115152031813.png" alt="image-20211115152031813"></p><p>&emsp;&emsp;选择File类型。</p><p><img src="/image/hexo/image-20211115152102198.png" alt="image-20211115152102198"></p><p>&emsp;&emsp;执行send、查看IDEA控制台。</p><p><img src="/image/hexo/image-20211115152147538.png" alt="image-20211115152147538"></p><p>&emsp;&emsp;正常输出、表示我们从web层获取到了上传的文件内容。我们接着编写下一步的代码。</p><h3 id="编写PDF拆分图片代码"><a href="#编写PDF拆分图片代码" class="headerlink" title="编写PDF拆分图片代码"></a>编写PDF拆分图片代码</h3><h4 id="新建实体对象FileDTO"><a href="#新建实体对象FileDTO" class="headerlink" title="新建实体对象FileDTO"></a>新建实体对象FileDTO</h4><p>&emsp;&emsp;主要用户保存文件和文件的序号的关系。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件序号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIndex</span><span class="params">(Integer index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.index = index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.path = path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="新增常量定义PdfWatermarkConstants"><a href="#新增常量定义PdfWatermarkConstants" class="headerlink" title="新增常量定义PdfWatermarkConstants"></a>新增常量定义PdfWatermarkConstants</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkConstants</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基础路径</span></span><br><span class="line"><span class="comment">     * 当前项目的根目录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BASE = <span class="string">"data/res/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * pdf转化成为图片</span></span><br><span class="line"><span class="comment">     * 图片的存储的未知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PDF_2_IMAGE = BASE + <span class="string">"pdf2image/"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="添加Gradle相关PDF依赖支持"><a href="#添加Gradle相关PDF依赖支持" class="headerlink" title="添加Gradle相关PDF依赖支持"></a>添加Gradle相关PDF依赖支持</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'com.itextpdf:itextpdf:5.5.13'</span></span><br><span class="line">implementation <span class="string">'com.itextpdf:itext-asian:5.2.0'</span></span><br><span class="line">  </span><br><span class="line">implementation <span class="string">'org.apache.pdfbox:pdfbox:2.0.4'</span></span><br><span class="line">implementation <span class="string">'org.apache.pdfbox:pdfbox-tools:2.0.4'</span></span><br><span class="line"></span><br><span class="line">implementation <span class="string">'commons-io:commons-io:2.7'</span></span><br></pre></td></tr></table></figure><h4 id="新增PDF处理图片Pdf2Image"><a href="#新增PDF处理图片Pdf2Image" class="headerlink" title="新增PDF处理图片Pdf2Image"></a>新增PDF处理图片Pdf2Image</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.pdfbox.pdmodel.PDDocument;</span><br><span class="line"><span class="keyword">import</span> org.apache.pdfbox.rendering.ImageType;</span><br><span class="line"><span class="keyword">import</span> org.apache.pdfbox.rendering.PDFRenderer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pdf2Image</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将File PDF文件转化为每一张图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file PDF文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回每一张图片的实体对象集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;FileDTO&gt; <span class="title">generate</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Long now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//读取PDF</span></span><br><span class="line">            PDDocument document = PDDocument.load(file);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//加载PDF对象</span></span><br><span class="line">            PDFRenderer pdfRenderer = <span class="keyword">new</span> PDFRenderer(document);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//存储的PDF每一张图片的路径以及索引</span></span><br><span class="line">            List&lt;FileDTO&gt; dataList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> page = <span class="number">0</span>;page&lt;document.getNumberOfPages();page++)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//读取PDF每一页的图片</span></span><br><span class="line">                BufferedImage img = pdfRenderer.renderImageWithDPI(page, <span class="number">300</span>, ImageType.RGB);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//生成图片的本地路径</span></span><br><span class="line">                String pathname = PdfWatermarkConstants.PDF_2_IMAGE + now + <span class="string">"/"</span> + file.getName() + page + <span class="string">".png"</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//创建本地文件</span></span><br><span class="line">                File imageFile = <span class="keyword">new</span> File(pathname);</span><br><span class="line">                <span class="comment">//创建文件夹</span></span><br><span class="line">                imageFile.mkdirs();</span><br><span class="line">                <span class="comment">//创建文件</span></span><br><span class="line">                imageFile.createNewFile();</span><br><span class="line"></span><br><span class="line">                FileDTO dto = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                dataList.add(dto);</span><br><span class="line"></span><br><span class="line">                dto.setIndex(page);</span><br><span class="line">                dto.setPath(pathname);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//生成PNG格式的图片</span></span><br><span class="line">                ImageIO.write(img, <span class="string">"png"</span>, imageFile);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//关闭Doc流</span></span><br><span class="line">            document.close();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> dataList;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改控制器调用PDF转换Image"><a href="#修改控制器调用PDF转换Image" class="headerlink" title="修改控制器调用PDF转换Image"></a>修改控制器调用PDF转换Image</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传控制器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filenames 批量上传的文件集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/pdf/watermark/upload"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile[] filenames)</span> </span>&#123;</span><br><span class="line">        Long now = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (MultipartFile multipartFile : filenames) &#123;</span><br><span class="line">            <span class="comment">//打印数据</span></span><br><span class="line">            System.out.println(multipartFile.getOriginalFilename() + <span class="string">" FileSize:"</span> + multipartFile.getSize());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//指定本地的PDF文件路径以及名称</span></span><br><span class="line">                String pathname = PdfWatermarkConstants.BASE + now + <span class="string">"/"</span> + multipartFile.getOriginalFilename();</span><br><span class="line">                <span class="comment">//创建本地的PDF</span></span><br><span class="line">                File pdfFile = <span class="keyword">new</span> File(pathname);</span><br><span class="line">                <span class="comment">//将网络流 MultipartFile 转化为本地 PDF文件</span></span><br><span class="line">                FileUtils.copyInputStreamToFile(multipartFile.getInputStream(), pdfFile);</span><br><span class="line">                <span class="comment">//PDF转化为图片</span></span><br><span class="line">                List&lt;FileDTO&gt; imageDTOs = Pdf2Image.generate(pdfFile);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; PDF转化image："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"这是等待生成的下载地址"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="项目结构-1"><a href="#项目结构-1" class="headerlink" title="项目结构"></a>项目结构</h4><p><img src="/image/hexo/image-20211115163513148.png" alt="image-20211115163513148"></p><h4 id="测试转化效果"><a href="#测试转化效果" class="headerlink" title="测试转化效果"></a>测试转化效果</h4><p><img src="/image/hexo/image-20211115163542395.png" alt="image-20211115163542395"></p><h3 id="编写图片水印图片代码"><a href="#编写图片水印图片代码" class="headerlink" title="编写图片水印图片代码"></a>编写图片水印图片代码</h3><h4 id="增加ImageWatemark"><a href="#增加ImageWatemark" class="headerlink" title="增加ImageWatemark"></a>增加ImageWatemark</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageWatemark</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片增加图片水印</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> iconPath 水印的地址 http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> srcImgPath 原本的图片地址 File</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> degree 旋转角度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">markImage</span><span class="params">(String iconPath, String srcImgPath, Integer degree)</span> </span>&#123;</span><br><span class="line">        OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//读取原图片文件</span></span><br><span class="line">            Image srcImg = ImageIO.read(<span class="keyword">new</span> File(srcImgPath));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//加载图片</span></span><br><span class="line">            BufferedImage buffImg = <span class="keyword">new</span> BufferedImage(srcImg.getWidth(<span class="keyword">null</span>), srcImg.getHeight(<span class="keyword">null</span>),</span><br><span class="line">                    BufferedImage.TYPE_INT_RGB);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//得到画笔对象</span></span><br><span class="line">            Graphics2D g = buffImg.createGraphics();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置对线段的锯齿状边缘处理</span></span><br><span class="line">            g.setRenderingHint(RenderingHints.KEY_INTERPOLATION, RenderingHints.VALUE_INTERPOLATION_BILINEAR);</span><br><span class="line">            g.drawImage(srcImg.getScaledInstance(srcImg.getWidth(<span class="keyword">null</span>),</span><br><span class="line">                            srcImg.getHeight(<span class="keyword">null</span>),</span><br><span class="line">                            Image.SCALE_SMOOTH),</span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line">                    <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != degree) &#123;</span><br><span class="line">                <span class="comment">//设置水印旋转</span></span><br><span class="line">                g.rotate(Math.toRadians(degree), (<span class="keyword">double</span>) buffImg.getWidth() / <span class="number">2</span>, (<span class="keyword">double</span>) buffImg.getHeight() / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//水印图象</span></span><br><span class="line">            ImageIcon imgIcon = <span class="keyword">new</span> ImageIcon(<span class="keyword">new</span> URL(iconPath));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//得到Image对象</span></span><br><span class="line">            Image img = imgIcon.getImage();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置透明度</span></span><br><span class="line">            <span class="keyword">float</span> alpha = <span class="number">0.5f</span>;</span><br><span class="line">            g.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_ATOP, alpha));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置水印图片坐标</span></span><br><span class="line">            g.drawImage(img, <span class="number">150</span>, <span class="number">300</span>, <span class="keyword">null</span>);</span><br><span class="line">            g.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER));</span><br><span class="line">            g.dispose();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//生成新的图片</span></span><br><span class="line"></span><br><span class="line">            String targerPath = srcImgPath + <span class="string">"_image_mark.png"</span>;</span><br><span class="line">            os = <span class="keyword">new</span> FileOutputStream(targerPath);</span><br><span class="line">            ImageIO.write(buffImg, <span class="string">"png"</span>, os);</span><br><span class="line">            <span class="keyword">return</span> targerPath;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != os)</span><br><span class="line">                    os.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改控制器、测试图片水印"><a href="#修改控制器、测试图片水印" class="headerlink" title="修改控制器、测试图片水印"></a>修改控制器、测试图片水印</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">package com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.io.FileUtils;</span><br><span class="line">import org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line">import org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">public class PdfWatermarkApi &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 文件上传控制器</span><br><span class="line">     * @param filenames 批量上传的文件集合</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @PostMapping(value &#x3D; &quot;&#x2F;pdf&#x2F;watermark&#x2F;upload&quot;)</span><br><span class="line">    public String upload(MultipartFile[] filenames) &#123;</span><br><span class="line">        Long now &#x3D; System.currentTimeMillis();</span><br><span class="line">        for (MultipartFile multipartFile : filenames) &#123;</span><br><span class="line">            &#x2F;&#x2F;打印数据</span><br><span class="line">            System.out.println(multipartFile.getOriginalFilename() + &quot; FileSize:&quot; + multipartFile.getSize());</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F;指定本地的PDF文件路径以及名称</span><br><span class="line">                String pathname &#x3D; PdfWatermarkConstants.BASE + now + &quot;&#x2F;&quot; + multipartFile.getOriginalFilename();</span><br><span class="line">                &#x2F;&#x2F;创建本地的PDF</span><br><span class="line">                File pdfFile &#x3D; new File(pathname);</span><br><span class="line">                &#x2F;&#x2F;将网络流 MultipartFile 转化为本地 PDF文件</span><br><span class="line">                FileUtils.copyInputStreamToFile(multipartFile.getInputStream(), pdfFile);</span><br><span class="line">                &#x2F;&#x2F;PDF转化为图片</span><br><span class="line">                List&lt;FileDTO&gt; imageDTOs &#x3D; Pdf2Image.generate(pdfFile);</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F;图片水印后的图片</span><br><span class="line">                List&lt;FileDTO&gt; imageMarkDTOs &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F;打印日志输出语句</span><br><span class="line">                for (FileDTO fileDTO : imageDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + &quot; -&gt; PDF转化image：&quot; + fileDTO.getIndex() + &quot; 文件路径：&quot; + fileDTO.getPath());</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F;图片水印</span><br><span class="line">                    String markImage &#x3D; ImageWatemark.markImage(&quot;https:&#x2F;&#x2F;www.wwei.cn&#x2F;yasuotu&#x2F;images&#x2F;logo.png&quot;, fileDTO.getPath(), null);</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F;添加到图片水印后的图片集合</span><br><span class="line">                    FileDTO newFileDTO &#x3D; new FileDTO();</span><br><span class="line">                    newFileDTO.setPath(markImage);</span><br><span class="line">                    newFileDTO.setIndex(fileDTO.getIndex());</span><br><span class="line">                    imageMarkDTOs.add(newFileDTO);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F;打印日志输出语句</span><br><span class="line">                for (FileDTO fileDTO : imageMarkDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + &quot; -&gt; Image添加图片水印：&quot; + fileDTO.getIndex() + &quot; 文件路径：&quot; + fileDTO.getPath());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;这是等待生成的下载地址&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211115165830311.png" alt="image-20211115165830311"></p><h3 id="编写图片水印文字代码"><a href="#编写图片水印文字代码" class="headerlink" title="编写图片水印文字代码"></a>编写图片水印文字代码</h3><h4 id="修改ImageWatemark-添加图片水印文字方法"><a href="#修改ImageWatemark-添加图片水印文字方法" class="headerlink" title="修改ImageWatemark,添加图片水印文字方法"></a>修改ImageWatemark,添加图片水印文字方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageWatemark</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片增加图片水印</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> iconPath 水印的地址 http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> srcImgPath 原本的图片地址 File</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> degree 旋转角度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">markImage</span><span class="params">(String iconPath, String srcImgPath, Integer degree)</span> </span>&#123;</span><br><span class="line">        OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//读取原图片文件</span></span><br><span class="line">            Image srcImg = ImageIO.read(<span class="keyword">new</span> File(srcImgPath));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//加载图片</span></span><br><span class="line">            BufferedImage buffImg = <span class="keyword">new</span> BufferedImage(srcImg.getWidth(<span class="keyword">null</span>), srcImg.getHeight(<span class="keyword">null</span>),</span><br><span class="line">                    BufferedImage.TYPE_INT_RGB);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//得到画笔对象</span></span><br><span class="line">            Graphics2D g = buffImg.createGraphics();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置对线段的锯齿状边缘处理</span></span><br><span class="line">            g.setRenderingHint(RenderingHints.KEY_INTERPOLATION, RenderingHints.VALUE_INTERPOLATION_BILINEAR);</span><br><span class="line">            g.drawImage(srcImg.getScaledInstance(srcImg.getWidth(<span class="keyword">null</span>),</span><br><span class="line">                            srcImg.getHeight(<span class="keyword">null</span>),</span><br><span class="line">                            Image.SCALE_SMOOTH),</span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line">                    <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != degree) &#123;</span><br><span class="line">                <span class="comment">//设置水印旋转</span></span><br><span class="line">                g.rotate(Math.toRadians(degree), (<span class="keyword">double</span>) buffImg.getWidth() / <span class="number">2</span>, (<span class="keyword">double</span>) buffImg.getHeight() / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//水印图象</span></span><br><span class="line">            ImageIcon imgIcon = <span class="keyword">new</span> ImageIcon(<span class="keyword">new</span> URL(iconPath));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//得到Image对象</span></span><br><span class="line">            Image img = imgIcon.getImage();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置透明度</span></span><br><span class="line">            <span class="keyword">float</span> alpha = <span class="number">0.5f</span>;</span><br><span class="line">            g.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_ATOP, alpha));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置水印图片坐标</span></span><br><span class="line">            g.drawImage(img, <span class="number">150</span>, <span class="number">300</span>, <span class="keyword">null</span>);</span><br><span class="line">            g.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER));</span><br><span class="line">            g.dispose();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//生成新的图片</span></span><br><span class="line"></span><br><span class="line">            String targerPath = srcImgPath + <span class="string">"_image_mark.png"</span>;</span><br><span class="line">            os = <span class="keyword">new</span> FileOutputStream(targerPath);</span><br><span class="line">            ImageIO.write(buffImg, <span class="string">"png"</span>, os);</span><br><span class="line">            <span class="keyword">return</span> targerPath;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != os)</span><br><span class="line">                    os.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片添加文字水印</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> srcImgPath 原图片地址 File</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> markContentColor 水印文字颜色</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waterMarkContent 水印文字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">mark</span><span class="params">(String srcImgPath,Color markContentColor, String waterMarkContent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//读取原图片信息</span></span><br><span class="line">            File srcImgFile = <span class="keyword">new</span> File(srcImgPath);</span><br><span class="line">            Image srcImg = ImageIO.read(srcImgFile);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//读取原图片高度、宽度</span></span><br><span class="line">            <span class="keyword">int</span> srcImgWidth = srcImg.getWidth(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">int</span> srcImgHeight = srcImg.getHeight(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置图片水印</span></span><br><span class="line">            BufferedImage bufImg = <span class="keyword">new</span> BufferedImage(srcImgWidth, srcImgHeight, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">            Graphics2D g = bufImg.createGraphics();</span><br><span class="line">            g.drawImage(srcImg, <span class="number">0</span>, <span class="number">0</span>, srcImgWidth, srcImgHeight, <span class="keyword">null</span>);</span><br><span class="line">            Font font = <span class="keyword">new</span> Font(<span class="string">"宋体"</span>, Font.PLAIN, <span class="number">20</span>);</span><br><span class="line">            g.setColor(markContentColor);</span><br><span class="line"></span><br><span class="line">            g.setFont(font);</span><br><span class="line">            <span class="keyword">int</span> x = srcImgWidth - getWatermarkLength(waterMarkContent, g) - <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">int</span> y = srcImgHeight - <span class="number">3</span>;</span><br><span class="line">            g.drawString(waterMarkContent, x, y);</span><br><span class="line">            g.dispose();</span><br><span class="line">            <span class="comment">// 输出图片</span></span><br><span class="line">            String outImgPath = srcImgPath + <span class="string">"_txt_water.png"</span>;</span><br><span class="line">            FileOutputStream outImgStream = <span class="keyword">new</span> FileOutputStream(outImgPath);</span><br><span class="line">            ImageIO.write(bufImg, <span class="string">"jpg"</span>, outImgStream);</span><br><span class="line">            outImgStream.flush();</span><br><span class="line">            outImgStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> outImgPath;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取水印文字的长度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waterMarkContent</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> g</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getWatermarkLength</span><span class="params">(String waterMarkContent, Graphics2D g)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> g.getFontMetrics(g.getFont()).charsWidth(waterMarkContent.toCharArray(), <span class="number">0</span>, waterMarkContent.length());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改控制器、测试图片文字水印"><a href="#修改控制器、测试图片文字水印" class="headerlink" title="修改控制器、测试图片文字水印"></a>修改控制器、测试图片文字水印</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传控制器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filenames 批量上传的文件集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/pdf/watermark/upload"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile[] filenames)</span> </span>&#123;</span><br><span class="line">        Long now = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (MultipartFile multipartFile : filenames) &#123;</span><br><span class="line">            <span class="comment">//打印数据</span></span><br><span class="line">            System.out.println(multipartFile.getOriginalFilename() + <span class="string">" FileSize:"</span> + multipartFile.getSize());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//指定本地的PDF文件路径以及名称</span></span><br><span class="line">                String pathname = PdfWatermarkConstants.BASE + now + <span class="string">"/"</span> + multipartFile.getOriginalFilename();</span><br><span class="line">                <span class="comment">//创建本地的PDF</span></span><br><span class="line">                File pdfFile = <span class="keyword">new</span> File(pathname);</span><br><span class="line">                <span class="comment">//将网络流 MultipartFile 转化为本地 PDF文件</span></span><br><span class="line">                FileUtils.copyInputStreamToFile(multipartFile.getInputStream(), pdfFile);</span><br><span class="line">                <span class="comment">//PDF转化为图片</span></span><br><span class="line">                List&lt;FileDTO&gt; imageDTOs = Pdf2Image.generate(pdfFile);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//图片水印后的图片</span></span><br><span class="line">                List&lt;FileDTO&gt; imageMarkDTOs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; PDF转化image："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//图片水印</span></span><br><span class="line">                    String markImage = ImageWatemark.markImage(<span class="string">"https://www.wwei.cn/yasuotu/images/logo.png"</span>, fileDTO.getPath(), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//添加到图片水印后的图片集合</span></span><br><span class="line">                    FileDTO newFileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                    newFileDTO.setPath(markImage);</span><br><span class="line">                    newFileDTO.setIndex(fileDTO.getIndex());</span><br><span class="line">                    imageMarkDTOs.add(newFileDTO);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//图片文字水印后的图片集合</span></span><br><span class="line">                List&lt;FileDTO&gt; imageTxtMarkDTOs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageMarkDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; Image添加图片水印："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line"></span><br><span class="line">                    String txtMark = ImageWatemark.mark(fileDTO.getPath(), Color.BLUE, <span class="string">"水印文字"</span>);</span><br><span class="line">                    <span class="comment">//添加到图片水印后的图片集合</span></span><br><span class="line">                    FileDTO newFileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                    newFileDTO.setPath(txtMark);</span><br><span class="line">                    newFileDTO.setIndex(fileDTO.getIndex());</span><br><span class="line">                    imageTxtMarkDTOs.add(newFileDTO);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageTxtMarkDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; Image添加文字水印："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"这是等待生成的下载地址"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211115170219859.png" alt="image-20211115170219859"></p><h3 id="编写图片合并PDF代码"><a href="#编写图片合并PDF代码" class="headerlink" title="编写图片合并PDF代码"></a>编写图片合并PDF代码</h3><h4 id="新增Image2Pdf"><a href="#新增Image2Pdf" class="headerlink" title="新增Image2Pdf"></a>新增Image2Pdf</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.Document;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.Image;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.Rectangle;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.pdf.PdfWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Image2Pdf</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将图片集合合并成为PDF</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataList</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> baseFileName</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">image2Pdf</span><span class="params">(List&lt;FileDTO&gt; dataList, String baseFileName)</span> </span>&#123;</span><br><span class="line">        String pdfPath = PdfWatermarkConstants.BASE_PDF + System.currentTimeMillis() + <span class="string">"/"</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建文件夹</span></span><br><span class="line">            <span class="keyword">new</span> File(pdfPath).mkdirs();</span><br><span class="line">            <span class="comment">//创建文件</span></span><br><span class="line">            pdfPath = pdfPath + baseFileName;</span><br><span class="line">            File file = <span class="keyword">new</span> File(pdfPath);</span><br><span class="line">            file.createNewFile();</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(pdfPath);</span><br><span class="line">            <span class="comment">// 创建文档</span></span><br><span class="line">            Document doc = <span class="keyword">new</span> Document(<span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 写入PDF文档</span></span><br><span class="line">            PdfWriter.getInstance(doc, fos);</span><br><span class="line">            <span class="comment">// 读取图片流</span></span><br><span class="line">            BufferedImage img = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 实例化图片</span></span><br><span class="line">            Image image = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 循环获取图片文件夹内的图片</span></span><br><span class="line">            <span class="keyword">for</span> (FileDTO fileDTO : dataList) &#123;</span><br><span class="line">                <span class="comment">//读取图片流</span></span><br><span class="line">                img = ImageIO.read(<span class="keyword">new</span> File(fileDTO.getPath()));</span><br><span class="line">                <span class="comment">//根据图片大小设置文档大小</span></span><br><span class="line">                doc.setPageSize(<span class="keyword">new</span> Rectangle(img.getWidth(), img.getHeight()));</span><br><span class="line">                <span class="comment">//实例化图片</span></span><br><span class="line">                image = Image.getInstance(fileDTO.getPath());</span><br><span class="line">                <span class="comment">//添加图片到文档</span></span><br><span class="line">                doc.open();</span><br><span class="line">                doc.add(image);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 关闭文档</span></span><br><span class="line">            doc.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pdfPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改控制器、测试图片合并"><a href="#修改控制器、测试图片合并" class="headerlink" title="修改控制器、测试图片合并"></a>修改控制器、测试图片合并</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传控制器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filenames 批量上传的文件集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/pdf/watermark/upload"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile[] filenames)</span> </span>&#123;</span><br><span class="line">        Long now = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (MultipartFile multipartFile : filenames) &#123;</span><br><span class="line">            <span class="comment">//打印数据</span></span><br><span class="line">            System.out.println(multipartFile.getOriginalFilename() + <span class="string">" FileSize:"</span> + multipartFile.getSize());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//指定本地的PDF文件路径以及名称</span></span><br><span class="line">                String pathname = PdfWatermarkConstants.BASE + now + <span class="string">"/"</span> + multipartFile.getOriginalFilename();</span><br><span class="line">                <span class="comment">//创建本地的PDF</span></span><br><span class="line">                File pdfFile = <span class="keyword">new</span> File(pathname);</span><br><span class="line">                <span class="comment">//将网络流 MultipartFile 转化为本地 PDF文件</span></span><br><span class="line">                FileUtils.copyInputStreamToFile(multipartFile.getInputStream(), pdfFile);</span><br><span class="line">                <span class="comment">//PDF转化为图片</span></span><br><span class="line">                List&lt;FileDTO&gt; imageDTOs = Pdf2Image.generate(pdfFile);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//图片水印后的图片</span></span><br><span class="line">                List&lt;FileDTO&gt; imageMarkDTOs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; PDF转化image："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//图片水印</span></span><br><span class="line">                    String markImage = ImageWatemark.markImage(<span class="string">"https://www.wwei.cn/yasuotu/images/logo.png"</span>, fileDTO.getPath(), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//添加到图片水印后的图片集合</span></span><br><span class="line">                    FileDTO newFileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                    newFileDTO.setPath(markImage);</span><br><span class="line">                    newFileDTO.setIndex(fileDTO.getIndex());</span><br><span class="line">                    imageMarkDTOs.add(newFileDTO);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//图片文字水印后的图片集合</span></span><br><span class="line">                List&lt;FileDTO&gt; imageTxtMarkDTOs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageMarkDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; Image添加图片水印："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line"></span><br><span class="line">                    String txtMark = ImageWatemark.mark(fileDTO.getPath(), Color.BLUE, <span class="string">"水印文字"</span>);</span><br><span class="line">                    <span class="comment">//添加到图片水印后的图片集合</span></span><br><span class="line">                    FileDTO newFileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                    newFileDTO.setPath(txtMark);</span><br><span class="line">                    newFileDTO.setIndex(fileDTO.getIndex());</span><br><span class="line">                    imageTxtMarkDTOs.add(newFileDTO);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageTxtMarkDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; Image添加文字水印："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//将图片再次合并成为PDF</span></span><br><span class="line">                String image2Pdf = Image2Pdf.image2Pdf(imageTxtMarkDTOs, multipartFile.getOriginalFilename());</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"水印后的原始PDF文件："</span> + image2Pdf);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"这是等待生成的下载地址"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211115173518934.png" alt="image-20211115173518934"></p><h3 id="编写PDF加密代码"><a href="#编写PDF加密代码" class="headerlink" title="编写PDF加密代码"></a>编写PDF加密代码</h3><h4 id="新增PdfEncrypt"><a href="#新增PdfEncrypt" class="headerlink" title="新增PdfEncrypt"></a>新增PdfEncrypt</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.pdf.PdfReader;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.pdf.PdfStamper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfEncrypt</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增pdf密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> src</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">addAttachment</span><span class="params">(String src,String password)</span> </span>&#123;</span><br><span class="line">        String dest = src + <span class="string">"encrypt.pdf"</span>;</span><br><span class="line">        <span class="comment">//pdf权限，值为"PdfWriter.ALLOW_PRINTING"</span></span><br><span class="line">        <span class="keyword">int</span> permission = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PdfReader reader = <span class="keyword">new</span> PdfReader(src);</span><br><span class="line">            PdfStamper stamper = <span class="keyword">new</span> PdfStamper(reader, <span class="keyword">new</span> FileOutputStream(dest));</span><br><span class="line">            <span class="comment">//设置密码文件打开密码文件编辑密码</span></span><br><span class="line">            <span class="comment">//final byte userPassword[], final byte ownerPassword[]</span></span><br><span class="line">            stamper.setEncryption(password.getBytes(),password.getBytes(), permission, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//关闭流</span></span><br><span class="line">            stamper.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dest;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改控制器、测试PDF加密"><a href="#修改控制器、测试PDF加密" class="headerlink" title="修改控制器、测试PDF加密"></a>修改控制器、测试PDF加密</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传控制器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filenames 批量上传的文件集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/pdf/watermark/upload"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile[] filenames)</span> </span>&#123;</span><br><span class="line">        Long now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//最终的PDF集合</span></span><br><span class="line">        List&lt;FileDTO&gt; pdfDTOs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (MultipartFile multipartFile : filenames) &#123;</span><br><span class="line">            <span class="comment">//打印数据</span></span><br><span class="line">            System.out.println(multipartFile.getOriginalFilename() + <span class="string">" FileSize:"</span> + multipartFile.getSize());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//指定本地的PDF文件路径以及名称</span></span><br><span class="line">                String pathname = PdfWatermarkConstants.BASE + now + <span class="string">"/"</span> + multipartFile.getOriginalFilename();</span><br><span class="line">                <span class="comment">//创建本地的PDF</span></span><br><span class="line">                File pdfFile = <span class="keyword">new</span> File(pathname);</span><br><span class="line">                <span class="comment">//将网络流 MultipartFile 转化为本地 PDF文件</span></span><br><span class="line">                FileUtils.copyInputStreamToFile(multipartFile.getInputStream(), pdfFile);</span><br><span class="line">                <span class="comment">//PDF转化为图片</span></span><br><span class="line">                List&lt;FileDTO&gt; imageDTOs = Pdf2Image.generate(pdfFile);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//图片水印后的图片</span></span><br><span class="line">                List&lt;FileDTO&gt; imageMarkDTOs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; PDF转化image："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//图片水印</span></span><br><span class="line">                    String markImage = ImageWatemark.markImage(<span class="string">"https://www.wwei.cn/yasuotu/images/logo.png"</span>, fileDTO.getPath(), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//添加到图片水印后的图片集合</span></span><br><span class="line">                    FileDTO newFileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                    newFileDTO.setPath(markImage);</span><br><span class="line">                    newFileDTO.setIndex(fileDTO.getIndex());</span><br><span class="line">                    imageMarkDTOs.add(newFileDTO);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//图片文字水印后的图片集合</span></span><br><span class="line">                List&lt;FileDTO&gt; imageTxtMarkDTOs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageMarkDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; Image添加图片水印："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line"></span><br><span class="line">                    String txtMark = ImageWatemark.mark(fileDTO.getPath(), Color.BLUE, <span class="string">"水印文字"</span>);</span><br><span class="line">                    <span class="comment">//添加到图片水印后的图片集合</span></span><br><span class="line">                    FileDTO newFileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                    newFileDTO.setPath(txtMark);</span><br><span class="line">                    newFileDTO.setIndex(fileDTO.getIndex());</span><br><span class="line">                    imageTxtMarkDTOs.add(newFileDTO);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageTxtMarkDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; Image添加文字水印："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//将图片再次合并成为PDF</span></span><br><span class="line">                String image2Pdf = Image2Pdf.image2Pdf(imageTxtMarkDTOs, multipartFile.getOriginalFilename());</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"水印后的原始PDF文件："</span> + image2Pdf);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//加密PDF</span></span><br><span class="line">                String encryptPath = PdfEncrypt.addAttachment(image2Pdf, <span class="string">"123456"</span>);</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"PDF 加密后的文件："</span> + encryptPath);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"这是等待生成的下载地址"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211115182925599.png" alt="image-20211115182925599"></p><h3 id="编写多个PDF进行ZIP压缩代码"><a href="#编写多个PDF进行ZIP压缩代码" class="headerlink" title="编写多个PDF进行ZIP压缩代码"></a>编写多个PDF进行ZIP压缩代码</h3><h4 id="新增Zip"><a href="#新增Zip" class="headerlink" title="新增Zip"></a>新增Zip</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Zip</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * pdf压缩为Zip</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileDTOS</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">pdf2Zip</span><span class="params">(List&lt;FileDTO&gt; fileDTOS)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置zip的路径</span></span><br><span class="line">        String zipName = PdfWatermarkConstants.ZIP_PDF + System.currentTimeMillis();</span><br><span class="line">        ZipOutputStream zipos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> File(zipName).mkdirs();</span><br><span class="line"></span><br><span class="line">            zipName = zipName + <span class="string">"/"</span> + System.currentTimeMillis() + <span class="string">".zip"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">new</span> File(zipName).createNewFile();</span><br><span class="line"></span><br><span class="line">            zipos = <span class="keyword">new</span> ZipOutputStream(<span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(zipName)));</span><br><span class="line">            <span class="comment">//设置压缩方法</span></span><br><span class="line">            zipos.setMethod(ZipOutputStream.DEFLATED);</span><br><span class="line">            DataOutputStream os = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//循环将文件写入压缩流</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fileDTOS.size(); i++) &#123;</span><br><span class="line">                FileDTO fileDTO = fileDTOS.get(i);</span><br><span class="line">                String filename = fileDTO.getPath().substring(fileDTO.getPath().lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>);</span><br><span class="line">                InputStream inputStream = <span class="keyword">new</span> FileInputStream(fileDTO.getPath());</span><br><span class="line">                <span class="comment">//添加ZipEntry，并ZipEntry中写入文件流</span></span><br><span class="line">                zipos.putNextEntry(<span class="keyword">new</span> ZipEntry(filename));</span><br><span class="line">                os = <span class="keyword">new</span> DataOutputStream(zipos);</span><br><span class="line">                <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">10</span>];</span><br><span class="line">                <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">//循环读写</span></span><br><span class="line">                <span class="keyword">while</span> ((len = inputStream.read(buff)) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                    os.write(buff, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//关闭此文件流</span></span><br><span class="line">                inputStream.close();</span><br><span class="line">                <span class="comment">//关闭当前ZIP项，并将流放置到写入的位置。下一个条目。</span></span><br><span class="line">                zipos.closeEntry();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//释放资源</span></span><br><span class="line">            os.flush();</span><br><span class="line">            os.close();</span><br><span class="line">            zipos.close();</span><br><span class="line">            zipos.close();</span><br><span class="line">            <span class="keyword">return</span> zipName;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改控制器、测试压缩PDF"><a href="#修改控制器、测试压缩PDF" class="headerlink" title="修改控制器、测试压缩PDF"></a>修改控制器、测试压缩PDF</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传控制器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filenames 批量上传的文件集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/pdf/watermark/upload"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile[] filenames)</span> </span>&#123;</span><br><span class="line">        Long now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//最终的PDF集合</span></span><br><span class="line">        List&lt;FileDTO&gt; pdfDTOs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (MultipartFile multipartFile : filenames) &#123;</span><br><span class="line">            <span class="comment">//打印数据</span></span><br><span class="line">            System.out.println(multipartFile.getOriginalFilename() + <span class="string">" FileSize:"</span> + multipartFile.getSize());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//指定本地的PDF文件路径以及名称</span></span><br><span class="line">                String pathname = PdfWatermarkConstants.BASE + now + <span class="string">"/"</span> + multipartFile.getOriginalFilename();</span><br><span class="line">                <span class="comment">//创建本地的PDF</span></span><br><span class="line">                File pdfFile = <span class="keyword">new</span> File(pathname);</span><br><span class="line">                <span class="comment">//将网络流 MultipartFile 转化为本地 PDF文件</span></span><br><span class="line">                FileUtils.copyInputStreamToFile(multipartFile.getInputStream(), pdfFile);</span><br><span class="line">                <span class="comment">//PDF转化为图片</span></span><br><span class="line">                List&lt;FileDTO&gt; imageDTOs = Pdf2Image.generate(pdfFile);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//图片水印后的图片</span></span><br><span class="line">                List&lt;FileDTO&gt; imageMarkDTOs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; PDF转化image："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//图片水印</span></span><br><span class="line">                    String markImage = ImageWatemark.markImage(<span class="string">"https://www.wwei.cn/yasuotu/images/logo.png"</span>, fileDTO.getPath(), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//添加到图片水印后的图片集合</span></span><br><span class="line">                    FileDTO newFileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                    newFileDTO.setPath(markImage);</span><br><span class="line">                    newFileDTO.setIndex(fileDTO.getIndex());</span><br><span class="line">                    imageMarkDTOs.add(newFileDTO);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//图片文字水印后的图片集合</span></span><br><span class="line">                List&lt;FileDTO&gt; imageTxtMarkDTOs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageMarkDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; Image添加图片水印："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line"></span><br><span class="line">                    String txtMark = ImageWatemark.mark(fileDTO.getPath(), Color.BLUE, <span class="string">"水印文字"</span>);</span><br><span class="line">                    <span class="comment">//添加到图片水印后的图片集合</span></span><br><span class="line">                    FileDTO newFileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                    newFileDTO.setPath(txtMark);</span><br><span class="line">                    newFileDTO.setIndex(fileDTO.getIndex());</span><br><span class="line">                    imageTxtMarkDTOs.add(newFileDTO);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//打印日志输出语句</span></span><br><span class="line">                <span class="keyword">for</span> (FileDTO fileDTO : imageTxtMarkDTOs) &#123;</span><br><span class="line">                    System.out.println(pdfFile.getName() + <span class="string">" -&gt; Image添加文字水印："</span> + fileDTO.getIndex() + <span class="string">" 文件路径："</span> + fileDTO.getPath());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//将图片再次合并成为PDF</span></span><br><span class="line">                String image2Pdf = Image2Pdf.image2Pdf(imageTxtMarkDTOs, multipartFile.getOriginalFilename());</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"水印后的原始PDF文件："</span> + image2Pdf);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//加密PDF</span></span><br><span class="line">                String encryptPath = PdfEncrypt.addAttachment(image2Pdf, <span class="string">"123456"</span>);</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"PDF 加密后的文件："</span> + encryptPath);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//添加水印后的PDF</span></span><br><span class="line">                FileDTO pdfDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                pdfDTO.setPath(encryptPath);</span><br><span class="line">                pdfDTOs.add(pdfDTO);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//进行PDF 压缩</span></span><br><span class="line">        String pdf2Zip = Zip.pdf2Zip(pdfDTOs);</span><br><span class="line">        System.out.println(<span class="string">"PDF 经过ZIP压缩后的地址:"</span> + pdf2Zip);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"这是等待生成的下载地址"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211115183218283.png" alt="image-20211115183218283"></p><h3 id="优化与建议"><a href="#优化与建议" class="headerlink" title="优化与建议"></a>优化与建议</h3><p>&emsp;&emsp;1.由于不断的进行图片、PDF间的转化、导致转化效率低下。</p><p>&emsp;&emsp;2.PDF如果有编辑密码那么这里还可以进行一个免密的处理。</p><p>&emsp;&emsp;3.图片分辨率过于大情况、导致产生的压缩包或者PDF过大。可以采用压缩生成后的图片进而压缩PDF。</p><p>&emsp;&emsp;4.由于所有的操作都是在本地完成、可以将最后的ZIP上传到文件服务中心,例如MINIO。</p><p>&emsp;&emsp;5.很多参数都是在代码里面写死的、那么我们可以再次抽取这些变量作为可配置的参数。</p><p>&emsp;&emsp;6.V2的版本中我们再次对V1的功能以及代码进行一个演进。</p><h2 id="水印PDF项目V2"><a href="#水印PDF项目V2" class="headerlink" title="水印PDF项目V2"></a>水印PDF项目V2</h2><p>&emsp;&emsp;<strong>目标1:</strong>减少图片、PDF间的转化、减少File对象的创建、减少频繁的IO操作。</p><p>&emsp;&emsp;<strong>目标2:</strong>针对有保护密码（非编辑密码）的PDF进行免密处理。</p><p>&emsp;&emsp;<strong>目标3:</strong>对参数的一个抽取。</p><h3 id="增加依赖文件"><a href="#增加依赖文件" class="headerlink" title="增加依赖文件"></a>增加依赖文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'org.bouncycastle:bcprov-jdk15on:1.62'</span></span><br></pre></td></tr></table></figure><h3 id="复制pdfwatermark包下的文件"><a href="#复制pdfwatermark包下的文件" class="headerlink" title="复制pdfwatermark包下的文件"></a>复制pdfwatermark包下的文件</h3><p>&emsp;&emsp;1.复制FileDTO</p><p>&emsp;&emsp;2.复制Zip</p><p>&emsp;&emsp;3.复制PdfWatermarkConstants</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件序号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIndex</span><span class="params">(Integer index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.index = index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.path = path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Zip</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * pdf压缩为Zip</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileDTOS</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">pdf2Zip</span><span class="params">(List&lt;FileDTO&gt; fileDTOS)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置zip的路径</span></span><br><span class="line">        String zipName = PdfWatermarkConstants.ZIP_PDF + System.currentTimeMillis();</span><br><span class="line">        ZipOutputStream zipos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> File(zipName).mkdirs();</span><br><span class="line"></span><br><span class="line">            zipName = zipName + <span class="string">"/"</span> + System.currentTimeMillis() + <span class="string">".zip"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">new</span> File(zipName).createNewFile();</span><br><span class="line"></span><br><span class="line">            zipos = <span class="keyword">new</span> ZipOutputStream(<span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(zipName)));</span><br><span class="line">            <span class="comment">//设置压缩方法</span></span><br><span class="line">            zipos.setMethod(ZipOutputStream.DEFLATED);</span><br><span class="line">            DataOutputStream os = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//循环将文件写入压缩流</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fileDTOS.size(); i++) &#123;</span><br><span class="line">                FileDTO fileDTO = fileDTOS.get(i);</span><br><span class="line">                String filename = fileDTO.getPath().substring(fileDTO.getPath().lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>);</span><br><span class="line">                InputStream inputStream = <span class="keyword">new</span> FileInputStream(fileDTO.getPath());</span><br><span class="line">                <span class="comment">//添加ZipEntry，并ZipEntry中写入文件流</span></span><br><span class="line">                zipos.putNextEntry(<span class="keyword">new</span> ZipEntry(filename));</span><br><span class="line">                os = <span class="keyword">new</span> DataOutputStream(zipos);</span><br><span class="line">                <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">10</span>];</span><br><span class="line">                <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">//循环读写</span></span><br><span class="line">                <span class="keyword">while</span> ((len = inputStream.read(buff)) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                    os.write(buff, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//关闭此文件流</span></span><br><span class="line">                inputStream.close();</span><br><span class="line">                <span class="comment">//关闭当前ZIP项，并将流放置到写入的位置。下一个条目。</span></span><br><span class="line">                zipos.closeEntry();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//释放资源</span></span><br><span class="line">            os.flush();</span><br><span class="line">            os.close();</span><br><span class="line">            zipos.close();</span><br><span class="line">            zipos.close();</span><br><span class="line">            <span class="keyword">return</span> zipName;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkConstants</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基础路径</span></span><br><span class="line"><span class="comment">     * 当前项目的根目录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BASE = <span class="string">"data/res/"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PDF压缩成ZIP</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZIP_PDF = BASE + <span class="string">"zip/"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="增加FileUtil"><a href="#增加FileUtil" class="headerlink" title="增加FileUtil"></a>增加FileUtil</h3><p>&emsp;&emsp;进行一些文件的转换。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * File转换字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] file2bytes(File file) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream input = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[input.available()];</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"文件转化失败！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字节数组转化File</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">bytes2File</span><span class="params">(<span class="keyword">byte</span>[] bytes,String filePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(filePath);</span><br><span class="line">            OutputStream output = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            BufferedOutputStream bufferedOutput = <span class="keyword">new</span> BufferedOutputStream(output);</span><br><span class="line">            bufferedOutput.write(bytes);</span><br><span class="line">            <span class="keyword">return</span> file;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"文件转化失败！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将url文件转化为字节流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urlPath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteArrayInputStream <span class="title">getImageStream</span><span class="params">(String urlPath)</span> </span>&#123;</span><br><span class="line">        InputStream in = <span class="keyword">null</span>;</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(urlPath);</span><br><span class="line">            URLConnection connection = url.openConnection();</span><br><span class="line">            in = connection.getInputStream();</span><br><span class="line">            <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">while</span> ((len = in.read(data)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                out.write(data, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException me) &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ByteArrayInputStream(out.toByteArray());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="增加MyPdfReader"><a href="#增加MyPdfReader" class="headerlink" title="增加MyPdfReader"></a>增加MyPdfReader</h3><p>&emsp;&emsp;用于解密pdf。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.pdf.PdfReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPdfReader</span> <span class="keyword">extends</span> <span class="title">PdfReader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyPdfReader</span><span class="params">(<span class="keyword">final</span> String filename)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decryptOnPurpose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        encrypted = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="增加PdfPassword"><a href="#增加PdfPassword" class="headerlink" title="增加PdfPassword"></a>增加PdfPassword</h3><p>&emsp;&emsp;PDF解密的核心逻辑。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.DocumentException;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.exceptions.BadPasswordException;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.exceptions.InvalidPdfException;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.pdf.PdfStamper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfPassword</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MyPdfReader pdfReader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解密PDF</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">unProtected</span><span class="params">(File file)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">null</span>;</span><br><span class="line">        ByteArrayInputStream bis = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            bis = <span class="keyword">new</span> ByteArrayInputStream(FileUtil.file2bytes(file));</span><br><span class="line"></span><br><span class="line">            initPdfReader(file.getPath());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (checkProtected()) &#123;</span><br><span class="line">                unProtectedPdf(bos);</span><br><span class="line">                <span class="keyword">byte</span>[] newBytes = bos.toByteArray();</span><br><span class="line">                bos.flush();</span><br><span class="line">                <span class="keyword">return</span> FileUtil.bytes2File(newBytes, file.getPath() + <span class="string">"unProtected.pdf"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> FileUtil.bytes2File(bos.toByteArray(), file.getPath() + <span class="string">"unProtected.pdf"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != bos) &#123;</span><br><span class="line">                bos.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != bis) &#123;</span><br><span class="line">                bis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initPdfReader</span><span class="params">(String filePath)</span> <span class="keyword">throws</span> BadPasswordException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pdfReader = <span class="keyword">new</span> MyPdfReader(filePath);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BadPasswordException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadPasswordException(<span class="string">"Bad password. It should be user password."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkProtected</span><span class="params">()</span> <span class="keyword">throws</span> InvalidPdfException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == pdfReader) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidPdfException(<span class="string">"Invalid pdf."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pdfReader.isEncrypted()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unProtectedPdf</span><span class="params">(OutputStream os)</span> </span>&#123;</span><br><span class="line">        PdfStamper stamper = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            MyPdfReader.unethicalreading = <span class="keyword">true</span>;</span><br><span class="line">            pdfReader.decryptOnPurpose();</span><br><span class="line"></span><br><span class="line">            stamper = <span class="keyword">new</span> PdfStamper(pdfReader, os);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DocumentException e) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != stamper) &#123;</span><br><span class="line">                    stamper.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="新增PdfWatermarkUtil"><a href="#新增PdfWatermarkUtil" class="headerlink" title="新增PdfWatermarkUtil"></a>新增PdfWatermarkUtil</h3><p>&emsp;&emsp;PDF水印的核心逻辑。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.BaseColor;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.Element;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.Image;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.pdf.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PDF水印</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> location 图片坐标 10,10,30,30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password pdf密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pdfFile 需要加入水印的pdf文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desc 文本水印</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imageUrl 图片水印地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 水印后的PDF地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">watermark</span><span class="params">(String location,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 String password,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 File pdfFile,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 String desc,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 String imageUrl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String makerFile = pdfFile.getName() + <span class="string">"_maker.pdf"</span>;</span><br><span class="line"></span><br><span class="line">        BufferedOutputStream outs = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(makerFile)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        PdfReader reader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//加载PdfReader对象</span></span><br><span class="line">            reader = <span class="keyword">new</span> PdfReader(pdfFile.getPath());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//PDF是否加密</span></span><br><span class="line">            <span class="keyword">if</span> (reader.isEncrypted()) &#123;</span><br><span class="line">                <span class="comment">//解密PDF</span></span><br><span class="line">                File decryptFile = PdfPassword.unProtected(pdfFile);</span><br><span class="line">                <span class="comment">//重新加载PdfReader</span></span><br><span class="line">                reader = <span class="keyword">new</span> PdfReader(decryptFile.getPath());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(pdfFile + <span class="string">"失败...."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载stamper</span></span><br><span class="line">        PdfStamper stamper = <span class="keyword">new</span> PdfStamper(reader, outs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置水印文本字体</span></span><br><span class="line">        BaseFont base = BaseFont.createFont(<span class="string">"simkai.ttf"</span>, BaseFont.IDENTITY_H, BaseFont.NOT_EMBEDDED);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载画笔工具</span></span><br><span class="line">        PdfGState gs = <span class="keyword">new</span> PdfGState();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置pdf密码</span></span><br><span class="line">        stamper.setEncryption(<span class="keyword">null</span>,</span><br><span class="line">                password.getBytes(),</span><br><span class="line">                com.itextpdf.text.pdf.PdfWriter.ALLOW_PRINTING,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载水印坐标</span></span><br><span class="line">        String[] coordinate = location.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载图片水印</span></span><br><span class="line">        ByteArrayInputStream imageStream = FileUtil.getImageStream(imageUrl);</span><br><span class="line">        <span class="keyword">byte</span> images[] = <span class="keyword">new</span> <span class="keyword">byte</span>[imageStream.available()];</span><br><span class="line">        imageStream.read(images, <span class="number">0</span>, imageStream.available());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对每一页的页页面进行处理</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; reader.getNumberOfPages() + <span class="number">1</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//读取水印图片</span></span><br><span class="line">            Image image = Image.getInstance(images);</span><br><span class="line">            <span class="comment">//设置百分比</span></span><br><span class="line">            image.scalePercent(<span class="number">100</span>);</span><br><span class="line">            <span class="comment">//设置对齐方式</span></span><br><span class="line">            image.setAlignment(Image.UNDERLYING);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置图片水印坐标</span></span><br><span class="line">            image.setAbsolutePosition(Float.valueOf(coordinate[<span class="number">0</span>]), Float.valueOf(coordinate[<span class="number">1</span>]));</span><br><span class="line">            image.scaleAbsolute(Float.valueOf(coordinate[<span class="number">2</span>]), Float.valueOf(coordinate[<span class="number">3</span>]));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取页面宽度</span></span><br><span class="line">            Float width = reader.getPageSize(i).getWidth();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置水印文本</span></span><br><span class="line">            PdfContentByte content = stamper.getUnderContent(i);</span><br><span class="line">            <span class="comment">//添加图片水印</span></span><br><span class="line">            content.addImage(image);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置透明度</span></span><br><span class="line">            gs.setFillOpacity(<span class="number">0.5f</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置画笔工具</span></span><br><span class="line">            content.setGState(gs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//开始设置文本水印</span></span><br><span class="line">            content.beginText();</span><br><span class="line">            <span class="comment">//设置文本矩阵</span></span><br><span class="line">            content.setTextMatrix(<span class="number">70</span>, <span class="number">200</span>);</span><br><span class="line">            <span class="comment">//设置文本颜色</span></span><br><span class="line">            content.setColorFill(BaseColor.BLACK);</span><br><span class="line">            <span class="comment">//设置文本字体大小</span></span><br><span class="line">            content.setFontAndSize(base, <span class="number">8</span>);</span><br><span class="line">            <span class="comment">//设置水印文本未知</span></span><br><span class="line">            content.showTextAligned(Element.ALIGN_CENTER, desc, width / <span class="number">2</span>, <span class="number">10</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//结束水印文本</span></span><br><span class="line">            content.endText();</span><br><span class="line">        &#125;</span><br><span class="line">        stamper.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> makerFile;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="新增PdfwatermarkV2Api"><a href="#新增PdfwatermarkV2Api" class="headerlink" title="新增PdfwatermarkV2Api"></a>新增PdfwatermarkV2Api</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermark.PdfWatermarkConstants;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkV2Api</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传控制器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filenames 批量上传的文件集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/pdf/watermark/upload/v2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile[] filenames)</span> </span>&#123;</span><br><span class="line">        Long now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        String location = <span class="string">"10,10,30,30"</span>;</span><br><span class="line">        String password = <span class="string">"123456"</span>;</span><br><span class="line">        String desc = <span class="string">"水印文本"</span>;</span><br><span class="line">        String imageUrl = <span class="string">"https://www.wwei.cn/yasuotu/images/logo.png"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//水印后的FileDTO</span></span><br><span class="line">        List&lt;FileDTO&gt; fileDTOList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (MultipartFile multipartFile : filenames) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//指定本地的PDF文件路径以及名称</span></span><br><span class="line">                String pathname = PdfWatermarkConstants.BASE + now + <span class="string">"/"</span> + multipartFile.getOriginalFilename();</span><br><span class="line">                <span class="comment">//创建本地的PDF</span></span><br><span class="line">                File pdfFile = <span class="keyword">new</span> File(pathname);</span><br><span class="line">                <span class="comment">//将网络流 MultipartFile 转化为本地 PDF文件</span></span><br><span class="line">                FileUtils.copyInputStreamToFile(multipartFile.getInputStream(), pdfFile);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//水印后的PDF</span></span><br><span class="line">                String watermarkFile = PdfWatermarkUtil.watermark(location, password, pdfFile, desc, imageUrl);</span><br><span class="line"></span><br><span class="line">                FileDTO fileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                fileDTO.setPath(watermarkFile);</span><br><span class="line">                fileDTOList.add(fileDTO);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//打包ZIP</span></span><br><span class="line">        String pdf2Zip = Zip.pdf2Zip(fileDTOList);</span><br><span class="line">        System.out.println(<span class="string">"ZIP打包后的PDF:"</span> + pdf2Zip);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"这是等待生成的下载地址"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="完成后的包结构"><a href="#完成后的包结构" class="headerlink" title="完成后的包结构"></a>完成后的包结构</h3><p><img src="/image/hexo/image-20211117180133186.png" alt="image-20211117180133186"></p><h3 id="添加simkai-ttf字体"><a href="#添加simkai-ttf字体" class="headerlink" title="添加simkai.ttf字体"></a>添加simkai.ttf字体</h3><p>&emsp;&emsp;可以在百度下载，然后放到项目的根目录。</p><h3 id="使用POSTMAN测试一下水印程序"><a href="#使用POSTMAN测试一下水印程序" class="headerlink" title="使用POSTMAN测试一下水印程序"></a>使用POSTMAN测试一下水印程序</h3><p>&emsp;&emsp;注意请求接口的变化。</p><p><img src="/image/hexo/image-20211117180221155.png" alt="image-20211117180221155"></p><p><img src="/image/hexo/image-20211117180229914.png" alt="image-20211117180229914"></p><p>&emsp;&emsp;正常水印PDF。整个过程删减了图片之间的转化以及合并。水印时间大大缩减。</p><p>&emsp;&emsp;而且对有编辑保护密码的PDF进行了一个免密处理。</p><p><img src="/image/hexo/image-20211117180509027.png" alt="image-20211117180509027"></p><p>&emsp;&emsp;同时也实现了简单的一个参数的抽取。</p><h2 id="水印PDF项目V3"><a href="#水印PDF项目V3" class="headerlink" title="水印PDF项目V3"></a>水印PDF项目V3</h2><p>&emsp;&emsp;<strong>目标1:</strong>增加多线程处理PDF。</p><p>&emsp;&emsp;<strong>目标2:</strong>编写前端页面提供下载功能。</p><p>&emsp;&emsp;<strong>目标3:</strong>Spring标准化。</p><h3 id="增加SpringBoot文件上传限制"><a href="#增加SpringBoot文件上传限制" class="headerlink" title="增加SpringBoot文件上传限制"></a>增加SpringBoot文件上传限制</h3><p>&emsp;&emsp;Springboot由于默认限制了文件上传的大小，这里我们需要测试大文件的水印，所以这里我们开放Springboot的文件大小的限制。在resources目录增加application.yaml文件。添加配置参数。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">multipart:</span></span><br><span class="line">      <span class="attr">max-request-size:</span> <span class="string">1000MB</span></span><br><span class="line">      <span class="attr">max-file-size:</span> <span class="string">1000MB</span></span><br></pre></td></tr></table></figure><h3 id="新建service、impl层"><a href="#新建service、impl层" class="headerlink" title="新建service、impl层"></a>新建service、impl层</h3><p>&emsp;&emsp;搭建经典的三层架构，controller、service、dao(V4版本再实现)。</p><h4 id="IPdfMarkService"><a href="#IPdfMarkService" class="headerlink" title="IPdfMarkService"></a>IPdfMarkService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV3.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPdfMarkService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="PdfMarkService"><a href="#PdfMarkService" class="headerlink" title="PdfMarkService"></a>PdfMarkService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV3.service.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.service.IPdfMarkService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfMarkService</span> <span class="keyword">implements</span> <span class="title">IPdfMarkService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="标准化包"><a href="#标准化包" class="headerlink" title="标准化包"></a>标准化包</h4><p><img src="/image/hexo/image-20211118101720090.png" alt="image-20211118101720090"></p><p>&emsp;&emsp;<strong>api:</strong>存放controller相关的控制器。</p><p>&emsp;&emsp;<strong>constants:</strong>存放静态常量、魔法值。</p><p>&emsp;&emsp;<strong>service:</strong> service业务层实现class。</p><p>&emsp;&emsp;<strong>service.impl:</strong> service业务层接口定义class。</p><p>&emsp;&emsp;<strong>dto:</strong>存放实体对象。</p><p>&emsp;&emsp;<strong>util:</strong>存放所有的工具类。</p><p>&emsp;&emsp;代码进行一个分包管理、当然也可以再继续往下分包。</p><h3 id="改造原有的Api、加入service业务层。"><a href="#改造原有的Api、加入service业务层。" class="headerlink" title="改造原有的Api、加入service业务层。"></a>改造原有的Api、加入service业务层。</h3><h4 id="封装水印参数DTO"><a href="#封装水印参数DTO" class="headerlink" title="封装水印参数DTO"></a>封装水印参数DTO</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV3.dto;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MarkDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片水印坐标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String location = <span class="string">"10,10,30,30"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * pdf密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password = <span class="string">"123456"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文本水印</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String desc = <span class="string">"水印文本"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片水印</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String imageUrl = <span class="string">"https://www.wwei.cn/yasuotu/images/logo.png"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> location;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocation</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.location = location;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDesc</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getImageUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> imageUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImageUrl</span><span class="params">(String imageUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.imageUrl = imageUrl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="定义接口pdfMark"><a href="#定义接口pdfMark" class="headerlink" title="定义接口pdfMark"></a>定义接口pdfMark</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV3.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.dto.MarkDTO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPdfMarkService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * pdf水印</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataFiles 需要水印的PDF集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> markDTO 水印参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回ZIP后的地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">pdfMark</span><span class="params">(List&lt;File&gt; dataFiles, MarkDTO markDTO)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现接口pdfMark"><a href="#实现接口pdfMark" class="headerlink" title="实现接口pdfMark"></a>实现接口pdfMark</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV3.service.impl;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.dto.FileDTO;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.dto.MarkDTO;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.service.IPdfMarkService;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.util.PdfWatermarkUtil;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.util.Zip;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfMarkService</span> <span class="keyword">implements</span> <span class="title">IPdfMarkService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">pdfMark</span><span class="params">(List&lt;File&gt; dataFiles, MarkDTO markDTO)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//水印后的FileDTO</span></span><br><span class="line">        List&lt;FileDTO&gt; fileDTOList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (File pdfFile : dataFiles) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//水印后的PDF</span></span><br><span class="line">                String watermarkFile = PdfWatermarkUtil.watermark(markDTO.getLocation(),</span><br><span class="line">                        markDTO.getPassword(), pdfFile, markDTO.getDesc(), markDTO.getImageUrl());</span><br><span class="line"></span><br><span class="line">                FileDTO fileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                fileDTO.setPath(watermarkFile);</span><br><span class="line">                fileDTOList.add(fileDTO);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Zip.pdf2Zip(fileDTOList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="改造Api、调用service接口"><a href="#改造Api、调用service接口" class="headerlink" title="改造Api、调用service接口"></a>改造Api、调用service接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV3.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermark.PdfWatermarkConstants;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.dto.MarkDTO;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.service.IPdfMarkService;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkV3Api</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spring的方式注入接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IPdfMarkService pdfMarkService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传控制器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filenames 批量上传的文件集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/pdf/watermark/upload/v3"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile[] filenames)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;File&gt; files = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        Long now = System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (MultipartFile multipartFile : filenames) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//指定本地的PDF文件路径以及名称</span></span><br><span class="line">                String pathname = PdfWatermarkConstants.BASE + now + <span class="string">"/"</span> + multipartFile.getOriginalFilename();</span><br><span class="line">                <span class="comment">//创建本地的PDF</span></span><br><span class="line">                File pdfFile = <span class="keyword">new</span> File(pathname);</span><br><span class="line">                <span class="comment">//将网络流 MultipartFile 转化为本地 PDF文件</span></span><br><span class="line">                FileUtils.copyInputStreamToFile(multipartFile.getInputStream(), pdfFile);</span><br><span class="line"></span><br><span class="line">                files.add(pdfFile);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用接口</span></span><br><span class="line">        MarkDTO markDTO = <span class="keyword">new</span> MarkDTO();</span><br><span class="line">        <span class="comment">//MarkDTO设置了默认参数这里只需要new就行了、如果需要更改可以自己进行set</span></span><br><span class="line">        String pdfMark = pdfMarkService.pdfMark(files, markDTO);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"PDF 完成后的ZIP地址："</span> + pdfMark);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"这是等待生成的下载地址"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试改造后功能是否正常"><a href="#测试改造后功能是否正常" class="headerlink" title="测试改造后功能是否正常"></a>测试改造后功能是否正常</h4><p><img src="/image/hexo/image-20211118103838273.png" alt="image-20211118103838273"></p><h3 id="多线程处理每一个PDF"><a href="#多线程处理每一个PDF" class="headerlink" title="多线程处理每一个PDF"></a>多线程处理每一个PDF</h3><p>&emsp;&emsp;进行标准的分包处理后、业务逻辑由service进行负责、所有仅需要对service的业务代码进行改造即可。</p><p>&emsp;&emsp;涉及到的知识点java8的特性:stream流、CompletableFuture异步任务。</p><p>&emsp;&emsp;此处使用的技术标准术语为:多线程异步组合式编程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV3.service.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.dto.FileDTO;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.dto.MarkDTO;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.service.IPdfMarkService;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.util.PdfWatermarkUtil;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.util.Zip;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CompletableFuture;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfMarkService</span> <span class="keyword">implements</span> <span class="title">IPdfMarkService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">pdfMark</span><span class="params">(List&lt;File&gt; dataFiles, MarkDTO markDTO)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//java8特性stream进行批量处理PDF</span></span><br><span class="line">        List&lt;CompletableFuture&lt;FileDTO&gt;&gt; taskList = dataFiles</span><br><span class="line">                .stream()</span><br><span class="line">                .map(file -&gt; process(file, markDTO))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取所有的并行任务</span></span><br><span class="line">        CompletableFuture&lt;Void&gt; allFutures =</span><br><span class="line">                CompletableFuture</span><br><span class="line">                        .allOf(taskList.toArray(<span class="keyword">new</span> CompletableFuture[taskList.size()]));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//等待每一个子线程完成水印</span></span><br><span class="line">        CompletableFuture&lt;List&lt;FileDTO&gt;&gt; finalResults = allFutures</span><br><span class="line">                .thenApply(v -&gt; taskList</span><br><span class="line">                        .stream()</span><br><span class="line">                        .map(future -&gt; future.join())</span><br><span class="line">                        .collect(Collectors.toList()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取任务结果</span></span><br><span class="line">            List&lt;FileDTO&gt; fileDTOList = finalResults.get();</span><br><span class="line">            <span class="comment">//Zip打包</span></span><br><span class="line">            <span class="keyword">return</span> Zip.pdf2Zip(fileDTOList);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * CompletableFuture进行水印</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pdfFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> markDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CompletableFuture&lt;FileDTO&gt; <span class="title">process</span><span class="params">(File pdfFile, MarkDTO markDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//水印后的PDF</span></span><br><span class="line">                String watermarkFile = PdfWatermarkUtil.watermark(markDTO.getLocation(),</span><br><span class="line">                        markDTO.getPassword(), pdfFile, markDTO.getDesc(), markDTO.getImageUrl());</span><br><span class="line">                FileDTO fileDTO = <span class="keyword">new</span> FileDTO();</span><br><span class="line">                fileDTO.setPath(watermarkFile);</span><br><span class="line">                <span class="keyword">return</span> fileDTO;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试多线程是否正常"><a href="#测试多线程是否正常" class="headerlink" title="测试多线程是否正常"></a>测试多线程是否正常</h3><p><img src="/image/hexo/image-20211118110023723.png" alt="image-20211118110023723"></p><h3 id="多线程处理PDF内的页数水印"><a href="#多线程处理PDF内的页数水印" class="headerlink" title="多线程处理PDF内的页数水印"></a>多线程处理PDF内的页数水印</h3><p>&emsp;&emsp;修改util业务逻辑。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV3.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.BaseColor;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.Element;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.Image;</span><br><span class="line"><span class="keyword">import</span> com.itextpdf.text.pdf.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CompletableFuture;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PDF水印</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> location 图片坐标 10,10,30,30</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password pdf密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pdfFile  需要加入水印的pdf文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desc     文本水印</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imageUrl 图片水印地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 水印后的PDF地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">watermark</span><span class="params">(String location,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   String password,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   File pdfFile,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   String desc,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   String imageUrl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String makerFile = pdfFile.getName() + <span class="string">"_maker.pdf"</span>;</span><br><span class="line"></span><br><span class="line">        BufferedOutputStream outs = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(makerFile)));</span><br><span class="line"></span><br><span class="line">        PdfReader reader = getPdfReader(pdfFile);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载stamper</span></span><br><span class="line">        PdfStamper stamper = <span class="keyword">new</span> PdfStamper(reader, outs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置水印文本字体</span></span><br><span class="line">        BaseFont base = BaseFont.createFont(<span class="string">"simkai.ttf"</span>, BaseFont.IDENTITY_H, BaseFont.NOT_EMBEDDED);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载画笔工具</span></span><br><span class="line">        PdfGState gs = <span class="keyword">new</span> PdfGState();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置pdf密码</span></span><br><span class="line">        stamper.setEncryption(<span class="keyword">null</span>,</span><br><span class="line">                password.getBytes(),</span><br><span class="line">                PdfWriter.ALLOW_PRINTING,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载水印坐标</span></span><br><span class="line">        String[] coordinate = location.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载图片水印</span></span><br><span class="line">        ByteArrayInputStream imageStream = FileUtil.getImageStream(imageUrl);</span><br><span class="line">        <span class="keyword">byte</span> images[] = <span class="keyword">new</span> <span class="keyword">byte</span>[imageStream.available()];</span><br><span class="line">        imageStream.read(images, <span class="number">0</span>, imageStream.available());</span><br><span class="line"></span><br><span class="line">        List&lt;Integer&gt; taskList = IntStream.rangeClosed(<span class="number">1</span>, reader.getNumberOfPages())</span><br><span class="line">                .boxed().collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; partition = ListUtil.partition(taskList, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        Image image = Image.getInstance(images);</span><br><span class="line"></span><br><span class="line">        CompletableFuture[] cfs = partition.stream()</span><br><span class="line">                .map(indexList -&gt; mark(gs, image, coordinate, reader, stamper, base, desc, indexList))</span><br><span class="line">                .toArray(CompletableFuture[]::<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">        CompletableFuture.allOf(cfs).join();</span><br><span class="line"></span><br><span class="line">        stamper.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> makerFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PdfReader <span class="title">getPdfReader</span><span class="params">(File pdfFile)</span> </span>&#123;</span><br><span class="line">        PdfReader reader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//加载PdfReader对象</span></span><br><span class="line">            reader = <span class="keyword">new</span> PdfReader(pdfFile.getPath());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//PDF是否加密</span></span><br><span class="line">            <span class="keyword">if</span> (reader.isEncrypted()) &#123;</span><br><span class="line">                <span class="comment">//解密PDF</span></span><br><span class="line">                File decryptFile = PdfPassword.unProtected(pdfFile);</span><br><span class="line">                <span class="comment">//重新加载PdfReader</span></span><br><span class="line">                reader = <span class="keyword">new</span> PdfReader(decryptFile.getPath());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(pdfFile + <span class="string">"失败...."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title">mark</span><span class="params">(PdfGState gs, Image image, String[] coordinate,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                PdfReader reader, PdfStamper stamper,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                BaseFont base, String desc, List&lt;Integer&gt; indexs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (Integer index : indexs) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                    <span class="comment">//读取水印图片</span></span><br><span class="line">                    <span class="comment">//设置百分比</span></span><br><span class="line">                    image.scalePercent(<span class="number">100</span>);</span><br><span class="line">                    <span class="comment">//设置对齐方式</span></span><br><span class="line">                    image.setAlignment(Image.UNDERLYING);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//设置图片水印坐标</span></span><br><span class="line">                    image.setAbsolutePosition(Float.valueOf(coordinate[<span class="number">0</span>]), Float.valueOf(coordinate[<span class="number">1</span>]));</span><br><span class="line">                    image.scaleAbsolute(Float.valueOf(coordinate[<span class="number">2</span>]), Float.valueOf(coordinate[<span class="number">3</span>]));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//获取页面宽度</span></span><br><span class="line">                    Float width = reader.getPageSize(index).getWidth();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//设置水印文本</span></span><br><span class="line">                    PdfContentByte content = stamper.getOverContent(index);</span><br><span class="line">                    <span class="comment">//添加图片水印</span></span><br><span class="line">                    content.addImage(image);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//设置透明度</span></span><br><span class="line">                    gs.setFillOpacity(<span class="number">0.5f</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//设置画笔工具</span></span><br><span class="line">                    content.setGState(gs);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//开始设置文本水印</span></span><br><span class="line">                    content.beginText();</span><br><span class="line">                    <span class="comment">//设置文本矩阵</span></span><br><span class="line">                    content.setTextMatrix(<span class="number">70</span>, <span class="number">200</span>);</span><br><span class="line">                    <span class="comment">//设置文本颜色</span></span><br><span class="line">                    content.setColorFill(BaseColor.BLACK);</span><br><span class="line">                    <span class="comment">//设置文本字体大小</span></span><br><span class="line">                    content.setFontAndSize(base, <span class="number">8</span>);</span><br><span class="line">                    <span class="comment">//设置水印文本未知</span></span><br><span class="line">                    content.showTextAligned(Element.ALIGN_CENTER, desc, width / <span class="number">2</span>, <span class="number">10</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="comment">//结束水印文本</span></span><br><span class="line">                    content.endText();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;经过测试<strong>PdfReader</strong>对多线程的支持其实并不太好、所以这仅是一个临时的方案。可能是页数过多导致出现异常。具体的原因暂时还不知道。但是可以满足百页内的快速水印、如果需要对它进行一个再次优化的话，这里提供一个方案。将PDF按页数进行拆分成一个小的PDF、然后每一个小的PDF再次进行多线程水印，最后再将多个PDF进行一个合并操作。这样每一份数据水印都是安全的。并且效率也会有所提升。</p><p>&emsp;&emsp;其中PDF的页面很多不是A4排版、里面的坐标可能由于页面大小导致不能出现等等、这些参数需要自己去适配或者动态的计算。目前这个版本支持百页内的A4水印。</p><h3 id="编写前端页面、摒弃POSTMAN"><a href="#编写前端页面、摒弃POSTMAN" class="headerlink" title="编写前端页面、摒弃POSTMAN"></a>编写前端页面、摒弃POSTMAN</h3><p>&emsp;&emsp;由于我们调试都是使用的POSTMAN软件，非常的不人性化。所有我们需要编写一个前端页面，进行一个上传的操作。至于下载的功能需要等到V5版本接入MINIO文件服务器我们再处理。</p><h4 id="增加前端文件文件夹"><a href="#增加前端文件文件夹" class="headerlink" title="增加前端文件文件夹"></a>增加前端文件文件夹</h4><p><img src="/image/hexo/image-20211118115839751.png" alt="image-20211118115839751"></p><h4 id="static文件夹下增加pdfMark-html文件"><a href="#static文件夹下增加pdfMark-html文件" class="headerlink" title="static文件夹下增加pdfMark.html文件"></a>static文件夹下增加pdfMark.html文件</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>PDF文件水印<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">PDF文件水印</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211118120023638.png" alt="image-20211118120023638"></p><p>&emsp;&emsp;可以正常访问。</p><h4 id="增加响应参数DTO"><a href="#增加响应参数DTO" class="headerlink" title="增加响应参数DTO"></a>增加响应参数DTO</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV3.dto;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">R</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据响应码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String code = <span class="string">"200"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据响应描述</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String desc = <span class="string">"success"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">R</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">R <span class="title">success</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        R r = <span class="keyword">new</span> R();</span><br><span class="line">        r.setData(t);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(String code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDesc</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改Api"><a href="#修改Api" class="headerlink" title="修改Api"></a>修改Api</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.pdfwatermarkV3.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermark.PdfWatermarkConstants;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.dto.MarkDTO;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.dto.R;</span><br><span class="line"><span class="keyword">import</span> com.example.pdfwatermarkV3.service.IPdfMarkService;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PdfWatermarkV3Api</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spring的方式注入接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IPdfMarkService pdfMarkService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传控制器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filenames 批量上传的文件集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/pdf/watermark/upload/v3"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> R&lt;String&gt; <span class="title">upload</span><span class="params">(MultipartFile[] filenames)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;File&gt; files = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        Long now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (MultipartFile multipartFile : filenames) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//指定本地的PDF文件路径以及名称</span></span><br><span class="line">                String pathname = PdfWatermarkConstants.BASE + now + <span class="string">"/"</span> + multipartFile.getOriginalFilename();</span><br><span class="line">                <span class="comment">//创建本地的PDF</span></span><br><span class="line">                File pdfFile = <span class="keyword">new</span> File(pathname);</span><br><span class="line">                <span class="comment">//将网络流 MultipartFile 转化为本地 PDF文件</span></span><br><span class="line">                FileUtils.copyInputStreamToFile(multipartFile.getInputStream(), pdfFile);</span><br><span class="line"></span><br><span class="line">                files.add(pdfFile);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用接口</span></span><br><span class="line">        MarkDTO markDTO = <span class="keyword">new</span> MarkDTO();</span><br><span class="line">        <span class="comment">//MarkDTO设置了默认参数这里只需要new就行了、如果需要更改可以自己进行set</span></span><br><span class="line">        String pdfMark = pdfMarkService.pdfMark(files, markDTO);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"PDF 完成后的ZIP地址："</span> + pdfMark);</span><br><span class="line">        <span class="keyword">return</span> R.success(pdfMark);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="引入相关的资源文件"><a href="#引入相关的资源文件" class="headerlink" title="引入相关的资源文件"></a>引入相关的资源文件</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- axios --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/axios/dist/axios.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- vue --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.jsdelivr.net/npm/vue/dist/vue.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- elementUI --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/element-ui@2.13.0/lib/index.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://unpkg.com/element-ui/lib/theme-chalk/index.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>PDF文件水印<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.el-header</span>,</span></span><br><span class="line"><span class="css">    <span class="selector-class">.el-footer</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">background-color</span>: <span class="selector-id">#b3c0d1</span>;</span></span><br><span class="line">        color: var(--el-text-color-primary);</span><br><span class="line">        text-align: center;</span><br><span class="line">        line-height: 60px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">    <span class="selector-class">.el-aside</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">background-color</span>: <span class="selector-id">#d3dce6</span>;</span></span><br><span class="line">        color: var(--el-text-color-primary);</span><br><span class="line">        text-align: center;</span><br><span class="line">        line-height: 200px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">    <span class="selector-class">.el-main</span> &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">background-color</span>: <span class="selector-id">#e9eef3</span>;</span></span><br><span class="line">        color: var(--el-text-color-primary);</span><br><span class="line">        text-align: center;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">    <span class="selector-tag">body</span> &gt; <span class="selector-class">.el-container</span> &#123;</span></span><br><span class="line">        margin-bottom: 40px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">    <span class="selector-class">.el-container</span><span class="selector-pseudo">:nth-child(5)</span> <span class="selector-class">.el-aside</span>,</span></span><br><span class="line"><span class="css">    <span class="selector-class">.el-container</span><span class="selector-pseudo">:nth-child(6)</span> <span class="selector-class">.el-aside</span> &#123;</span></span><br><span class="line">        line-height: 260px;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">    <span class="selector-class">.el-container</span><span class="selector-pseudo">:nth-child(7)</span> <span class="selector-class">.el-aside</span> &#123;</span></span><br><span class="line">        line-height: 320px;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">'app'</span> <span class="attr">v-cloak</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-container</span> <span class="attr">v-loading</span>=<span class="string">"loading"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">el-header</span>&gt;</span>PDF头部<span class="tag">&lt;/<span class="name">el-header</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">el-main</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">el-upload</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">ref</span>=<span class="string">"upload"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">class</span>=<span class="string">"upload-demo"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">drag</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">accept</span>=<span class="string">".pdf, .PDF"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">action</span>=<span class="string">"#"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">multiple</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">:http-request</span>=<span class="string">"upload"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">:before-remove</span>=<span class="string">"beforeremove"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">:before-upload</span>=<span class="string">"beforeupload"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">:auto-upload</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">                &gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">el-icon</span> <span class="attr">class</span>=<span class="string">"el-icon--upload"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">upload-filled</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">el-icon</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"el-upload__text"</span>&gt;</span></span><br><span class="line">                        拖拽上传 或者<span class="tag">&lt;<span class="name">em</span>&gt;</span>点击上传<span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">template</span> #<span class="attr">tip</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"el-upload__tip"</span>&gt;</span></span><br><span class="line">                            上传正确的文件</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">el-upload</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">el-button</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">style</span>=<span class="string">"margin-left: 10px"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">size</span>=<span class="string">"small"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">type</span>=<span class="string">"success"</span></span></span><br><span class="line"><span class="tag">                        @<span class="attr">click</span>=<span class="string">"submitUpload"</span></span></span><br><span class="line"><span class="tag">                &gt;</span>上传并执行水印<span class="tag">&lt;/<span class="name">el-button</span></span></span><br><span class="line"><span class="tag">                &gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">el-main</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">el-footer</span>&gt;</span>PDF底部<span class="tag">&lt;/<span class="name">el-footer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">el-container</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="actionscript">        el: <span class="string">'#app'</span>,</span></span><br><span class="line"><span class="actionscript">        name: <span class="string">"index"</span>,</span></span><br><span class="line">        data() &#123;</span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line">                fileList:[],</span><br><span class="line"><span class="actionscript">                download:<span class="string">''</span>,</span></span><br><span class="line"><span class="actionscript">                loading:<span class="literal">false</span>,</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line"><span class="actionscript">        created: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            submitUpload() &#123;</span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">"submitUpload-------"</span>)</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">this</span>.$refs.upload.submit();</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">this</span>.uploadData();</span></span><br><span class="line">            &#125;,</span><br><span class="line">            beforeupload(file,fileList) &#123;</span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> flag = <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.fileList.forEach(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span></span><br><span class="line">                    if (item.uid == file.uid) &#123;</span><br><span class="line"><span class="actionscript">                        flag = <span class="literal">true</span>;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                if (!flag) &#123;</span><br><span class="line"><span class="actionscript">                    <span class="keyword">this</span>.fileList.push(file);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            upload()&#123;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            beforeremove(file,dataList) &#123;</span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> fileList = [];</span></span><br><span class="line"><span class="javascript">                dataList.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span></span><br><span class="line">                    if (item.uid != file.uid) &#123;</span><br><span class="line">                        fileList.push(item);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"><span class="actionscript">                <span class="keyword">this</span>.fileList = fileList;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            uploadData() &#123;</span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">"upload-------"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">                <span class="keyword">if</span> (<span class="keyword">this</span>.fileList.length == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">this</span>.$notify(&#123;</span></span><br><span class="line"><span class="actionscript">                        title: <span class="string">'警告'</span>,</span></span><br><span class="line"><span class="actionscript">                        message: <span class="string">'请先选择文件后再上传执行水印!'</span>,</span></span><br><span class="line"><span class="actionscript">                        type: <span class="string">'warning'</span></span></span><br><span class="line">                    &#125;);</span><br><span class="line"><span class="actionscript">                    <span class="keyword">return</span>;</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">                <span class="keyword">this</span>.loading = <span class="literal">true</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> self = <span class="keyword">this</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> forms = <span class="keyword">new</span> FormData()</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> configs = &#123;</span></span><br><span class="line"><span class="actionscript">                    headers:&#123;<span class="string">'Content-Type'</span>:<span class="string">'multipart/form-data'</span>&#125;</span></span><br><span class="line">                &#125;;</span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.fileList.forEach(<span class="function"><span class="params">file</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="actionscript">                    forms.append(<span class="string">'filenames'</span>,file)</span></span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line"><span class="javascript">                axios.post(<span class="string">"/pdf/watermark/upload/v3"</span>,forms ,configs).then(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="actionscript">                    self.loading = <span class="literal">false</span>;</span></span><br><span class="line">                    if (res.data.code = 200) &#123;</span><br><span class="line"><span class="javascript">                        <span class="keyword">var</span> url = <span class="built_in">window</span>.location.host;</span></span><br><span class="line"><span class="actionscript">                        self.download = url + <span class="string">'/'</span> + res.data.data;</span></span><br><span class="line"><span class="javascript">                        <span class="built_in">console</span>.log(self.download)</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">this</span>.$confirm(<span class="string">'水印结束、请下载文件!'</span>, <span class="string">'提示'</span>, &#123;</span></span><br><span class="line"><span class="actionscript">                            confirmButtonText: <span class="string">'下载'</span>,</span></span><br><span class="line"><span class="actionscript">                            cancelButtonText: <span class="string">'取消'</span>,</span></span><br><span class="line"><span class="actionscript">                            type: <span class="string">'warning'</span></span></span><br><span class="line"><span class="javascript">                        &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">console</span>.log(self.download)</span></span><br><span class="line"><span class="javascript">                            <span class="built_in">window</span>.location.href = self.download;</span></span><br><span class="line"><span class="javascript">                        &#125;).catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="keyword">this</span>.$message(&#123;</span></span><br><span class="line"><span class="actionscript">                                type: <span class="string">'info'</span>,</span></span><br><span class="line"><span class="actionscript">                                message: <span class="string">'已取消下载'</span></span></span><br><span class="line">                            &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">                            self.download = <span class="string">''</span>;</span></span><br><span class="line">                        &#125;);</span><br><span class="line"><span class="actionscript">                    &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="actionscript">                        <span class="keyword">this</span>.$notify(&#123;</span></span><br><span class="line"><span class="actionscript">                            title: <span class="string">'警告'</span>,</span></span><br><span class="line"><span class="actionscript">                            message: <span class="string">'服务异常、请稍后再试!'</span>,</span></span><br><span class="line"><span class="actionscript">                            type: <span class="string">'warning'</span></span></span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ,</span><br><span class="line">        mounted() &#123;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="测试功能"><a href="#测试功能" class="headerlink" title="测试功能"></a>测试功能</h4><p><img src="/image/hexo/image-20211118140513008.png" alt="image-20211118140513008"></p><p><img src="/image/hexo/image-20211118140832755.png" alt="image-20211118140832755"></p><p>&emsp;&emsp;由于是本地启动的、这个地址并不能下载。所以这里需要完成最后一步、将程序打成jar包然后上传到服务器、并且使用Nginx执行反向代理使得资源文件可以执行下载。</p><h3 id="生成jar"><a href="#生成jar" class="headerlink" title="生成jar"></a>生成jar</h3><h4 id="增加SpringBoot打包插件依赖"><a href="#增加SpringBoot打包插件依赖" class="headerlink" title="增加SpringBoot打包插件依赖"></a>增加SpringBoot打包插件依赖</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">'org.springframework.boot'</span> version <span class="string">'2.5.6'</span></span><br><span class="line">    id <span class="string">'io.spring.dependency-management'</span> version <span class="string">'1.0.9.RELEASE'</span></span><br><span class="line">    id <span class="string">'java'</span></span><br><span class="line">    id <span class="string">'idea'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211118142106728.png" alt="image-20211118142106728"></p><h4 id="上传服务器、运行程序"><a href="#上传服务器、运行程序" class="headerlink" title="上传服务器、运行程序"></a>上传服务器、运行程序</h4><p>&emsp;&emsp;执行完打包的指令将会生成一个jar。我们将这个jar上传到服务器运行即可。需要注意的是，项目根目录有一个字体文件simkai.ttf需要和jar包一同上传，并且处于同一目录下。Linux这一块也不详细讲解。</p><p><img src="/image/hexo/image-20211118142225099.png" alt="image-20211118142225099"></p><p>&emsp;&emsp;这里依旧不能下载、需要在服务器部署Nginx反向代理。这里不对Nginx做详细讲解、可以参考其他文章关于Nginx的反向代理设置。</p><h2 id="水印PDF项目V4"><a href="#水印PDF项目V4" class="headerlink" title="水印PDF项目V4"></a>水印PDF项目V4</h2><p>&emsp;&emsp;<strong>目标1:</strong>集成Mybatis、使用Mysql完成登录注册。</p><p>&emsp;&emsp;<strong>目标2:</strong>增加权限、没有登录则不允许访问水印页面。</p><p>&emsp;&emsp;<strong>目标3:</strong>存储用户转换的PDF源文件以及目标文件。</p><p><strong>&emsp;&emsp;目标4:</strong>限制PDF上传大小、限制PDF页数。</p><p><strong>&emsp;&emsp;目标5:</strong>实现手机验证码登录注册。</p><h2 id="水印PDF项目V5"><a href="#水印PDF项目V5" class="headerlink" title="水印PDF项目V5"></a>水印PDF项目V5</h2><p>&emsp;&emsp;<strong>目标1:</strong>增加MINIO执行文件上传。</p><p>&emsp;&emsp;<strong>目标2:</strong>增加请求日志记录、限制IP访问。</p><p>&emsp;&emsp;<strong>目标3:</strong>增加百分比转换显示、websocket实时推送。</p><p>&emsp;&emsp;<strong>目标4:</strong>增加PDF秒水印功能（查询历史的水印记录）。</p><p>&emsp;&emsp;<strong>目标6:</strong>接入Redis组件、实现高性能缓存。</p><hr><h2 id="PDF解除编辑密码项目"><a href="#PDF解除编辑密码项目" class="headerlink" title="PDF解除编辑密码项目"></a>PDF解除编辑密码项目</h2><h2 id="PDF转换图片项目"><a href="#PDF转换图片项目" class="headerlink" title="PDF转换图片项目"></a>PDF转换图片项目</h2><h2 id="PDF转化长图项目"><a href="#PDF转化长图项目" class="headerlink" title="PDF转化长图项目"></a>PDF转化长图项目</h2><h2 id="图片OCR识别项目"><a href="#图片OCR识别项目" class="headerlink" title="图片OCR识别项目"></a>图片OCR识别项目</h2>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> gradle </category>
          
          <category> SpringBoot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> gradle </tag>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch、Kibana安装-Linux下docker单机环境版</title>
      <link href="/2021/10/25/15217/hub/"/>
      <url>/2021/10/25/15217/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20211025140334110.png" alt="image-20211025140334110"></p><h2 id="相关准备"><a href="#相关准备" class="headerlink" title="相关准备"></a>相关准备</h2><h5 id="1-centos7服务器"><a href="#1-centos7服务器" class="headerlink" title="1.centos7服务器"></a>1.centos7服务器</h5><h5 id="2-docker环境"><a href="#2-docker环境" class="headerlink" title="2.docker环境"></a>2.docker环境</h5><h3 id="安装elasticsearch"><a href="#安装elasticsearch" class="headerlink" title="安装elasticsearch"></a>安装elasticsearch</h3><h4 id="创建映射的配置文件"><a href="#创建映射的配置文件" class="headerlink" title="创建映射的配置文件"></a>创建映射的配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/soft/elasticsearch/config</span><br><span class="line">mkdir -p /data/soft/elasticsearch/data</span><br><span class="line">mkdir -p /data/soft/elasticsearch/plugins</span><br><span class="line"></span><br><span class="line">vi /data/soft/elasticsearch/config/elasticsearch.yml</span><br><span class="line">vi /data/soft/elasticsearch/config/jvm.options</span><br></pre></td></tr></table></figure><h4 id="docker-pull"><a href="#docker-pull" class="headerlink" title="docker pull"></a>docker pull</h4><p><strong>需要注意的是、我们此处采用了挂载容器文件的方式。这样更加方便的修改配置文件。</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name elasticsearch  -p 9200:9200  -p 9300:9300 --net=host  -v /data/soft/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v /data/soft/elasticsearch/config/jvm.options:/usr/share/elasticsearch/config/jvm.options  -v /data/soft/elasticsearch/data:/usr/share/elasticsearch/data -v /data/soft/elasticsearch/plugins:/usr/share/elasticsearch/plugins -e "discovery.type=single-node"  -e ES_JAVA_OPTS="-Xms1024m -Xmx2048m" elasticsearch:7.14.2</span><br></pre></td></tr></table></figure><h4 id="验证elasticsearch是否安装成功"><a href="#验证elasticsearch是否安装成功" class="headerlink" title="验证elasticsearch是否安装成功"></a>验证elasticsearch是否安装成功</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9200</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211025164514489.png" alt="image-20211025164514489"></p><h4 id="开启elasticsearch远程访问"><a href="#开启elasticsearch远程访问" class="headerlink" title="开启elasticsearch远程访问"></a>开启elasticsearch远程访问</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /data/soft/elasticsearch/config</span><br><span class="line">vi elasticsearch.yml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加内容 http.host: 0.0.0.0 保存</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启docker容器</span></span><br><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211025165119535.png" alt="image-20211025165119535"></p><h3 id="安装Kibana"><a href="#安装Kibana" class="headerlink" title="安装Kibana"></a>安装Kibana</h3><h4 id="创建映射的配置文件-1"><a href="#创建映射的配置文件-1" class="headerlink" title="创建映射的配置文件"></a>创建映射的配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/soft/elasticsearch/kibana </span><br><span class="line">vi /data/soft/elasticsearch/kibana/kibana.yml</span><br></pre></td></tr></table></figure><h4 id="添加内容"><a href="#添加内容" class="headerlink" title="添加内容"></a>添加内容</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server.name: kibana</span><br><span class="line">server.host: "0"</span><br><span class="line">elasticsearch.hosts: [ "http://192.168.9.124:9200" ]</span><br><span class="line">xpack.monitoring.ui.container.elasticsearch.enabled: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> elasticsearch.hosts根据自己实际IP处理</span></span><br></pre></td></tr></table></figure><h4 id="docker-pull-1"><a href="#docker-pull-1" class="headerlink" title="docker pull"></a>docker pull</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name kibana -p 5601:5601 --net&#x3D;host -v &#x2F;data&#x2F;soft&#x2F;elasticsearch&#x2F;kibana&#x2F;kibana.yml:&#x2F;usr&#x2F;share&#x2F;kibana&#x2F;config&#x2F;kibana.yml kibana:7.14.2</span><br></pre></td></tr></table></figure><h4 id="验证kibana是否安装成功"><a href="#验证kibana是否安装成功" class="headerlink" title="验证kibana是否安装成功"></a>验证kibana是否安装成功</h4><p><img src="/image/hexo/image-20211025172029076.png" alt="image-20211025172029076"></p><h3 id="Elasticsearch-amp-amp-Kibana-安装结束"><a href="#Elasticsearch-amp-amp-Kibana-安装结束" class="headerlink" title="Elasticsearch &amp;&amp; Kibana 安装结束"></a>Elasticsearch &amp;&amp; Kibana 安装结束</h3><p><strong>不熟悉docker的情况下:注意docker中的参数:–net=host、可以进一步的了解。</strong></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Docker </category>
          
          <category> Elasticsearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch-Head、IK分词器安装-Linux下docker单机环境版</title>
      <link href="/2021/10/25/15217/hub/"/>
      <url>/2021/10/25/15217/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20211025140334110.png" alt="image-20211025140334110"></p><h3 id="安装elasticsearch-head"><a href="#安装elasticsearch-head" class="headerlink" title="安装elasticsearch-head"></a>安装elasticsearch-head</h3><h4 id="docker-run"><a href="#docker-run" class="headerlink" title="docker run"></a>docker run</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name elasticsearch-head -p 9100:9100 mobz/elasticsearch-head:5</span><br></pre></td></tr></table></figure><h4 id="验证elasticsearch-head是否安装成功"><a href="#验证elasticsearch-head是否安装成功" class="headerlink" title="验证elasticsearch-head是否安装成功"></a>验证elasticsearch-head是否安装成功</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.9.124:9100 # 根据自己实际ip进行访问</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211026170249011.png" alt="image-20211026170249011"></p><h4 id="尝试连接Elasticsearch"><a href="#尝试连接Elasticsearch" class="headerlink" title="尝试连接Elasticsearch"></a>尝试连接Elasticsearch</h4><p><img src="/image/hexo/image-20211026170440161.png" alt="image-20211026170440161"></p><h4 id="解决集群健康值：未连接"><a href="#解决集群健康值：未连接" class="headerlink" title="解决集群健康值：未连接"></a>解决集群健康值：未连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改elasticsearch配置文件</span></span><br><span class="line">vi /data/soft/elasticsearch/config/elasticsearch.yml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 追加内容</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: "*"</span><br><span class="line">http.cors.allow-methods: OPTIONS, HEAD, GET, POST, PUT, DELETE</span><br><span class="line">http.cors.allow-headers: "X-Requested-With, Content-Type, Content-Length, X-User"</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 重启docker elasticseaerch容器</span></span><br><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure><h4 id="连接成功"><a href="#连接成功" class="headerlink" title="连接成功"></a>连接成功</h4><p><img src="/image/hexo/image-20211026171323490.png" alt="image-20211026171323490"></p><h4 id="开启elasticsearch远程访问"><a href="#开启elasticsearch远程访问" class="headerlink" title="开启elasticsearch远程访问"></a>开启elasticsearch远程访问</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /data/soft/elasticsearch/config</span><br><span class="line">vi elasticsearch.yml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加内容 http.host: 0.0.0.0 保存</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启docker容器</span></span><br><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211025165119535.png" alt="image-20211025165119535"></p><h3 id="安装中文IK分词器"><a href="#安装中文IK分词器" class="headerlink" title="安装中文IK分词器"></a>安装中文IK分词器</h3><h4 id="查询对应的版本"><a href="#查询对应的版本" class="headerlink" title="查询对应的版本"></a>查询对应的版本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/medcl/elasticsearch-analysis-ik/releases</span><br><span class="line"><span class="meta">#</span><span class="bash">本文采用7.14.2版本</span></span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211026171759731.png" alt="image-20211026171759731"></p><h4 id="下载IK分词器安装包"><a href="#下载IK分词器安装包" class="headerlink" title="下载IK分词器安装包"></a>下载IK分词器安装包</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 创建目录</span></span></span><br><span class="line">mkdir /data/soft/elasticsearch/plugins/ik</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 进入目录</span></span></span><br><span class="line">cd /data/soft/elasticsearch/plugins/ik</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 下载</span></span></span><br><span class="line">wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.14.2/elasticsearch-analysis-ik-7.14.2.zip</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 解压</span></span></span><br><span class="line">unzip elasticsearch-analysis-ik-7.14.2.zip</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 删除压缩包</span></span></span><br><span class="line">rm -rf elasticsearch-analysis-ik-7.14.2.zip</span><br></pre></td></tr></table></figure><p><strong>由于安装Elasticsearch的时候我们将plugins目录从容器内部挂载到了宿主机、所以我们不需要进入容器内部。</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 重启elasticsearch</span></span></span><br><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></figure><h4 id="使用postman添加数据"><a href="#使用postman添加数据" class="headerlink" title="使用postman添加数据"></a>使用postman添加数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># api</span></span></span><br><span class="line">http://192.168.9.124:9200/blog1/_analyze</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># json</span></span></span><br><span class="line">&#123;</span><br><span class="line">   "text":"sanmengcc yyds","tokenizer": "ik_max_word"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20211026174139109.png" alt="image-20211026174139109"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Docker </category>
          
          <category> Elasticsearch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>平时常见所需的SQL积累(MySQL)</title>
      <link href="/2021/10/22/63396/hub/"/>
      <url>/2021/10/22/63396/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20211022133817250.png" alt="image-20211022133817250"></p><h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><h4 id="1-多字段去除重复保留ID最小的一条"><a href="#1-多字段去除重复保留ID最小的一条" class="headerlink" title="1.多字段去除重复保留ID最小的一条"></a>1.多字段去除重复保留ID最小的一条</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM table_name_a</span><br><span class="line">WHERE (field_a, field_b) IN (</span><br><span class="line">SELECT field_a, field_b</span><br><span class="line">FROM (</span><br><span class="line">SELECT field_a, field_b</span><br><span class="line">FROM table_name_A</span><br><span class="line">GROUP BY field_a, field_b</span><br><span class="line">HAVING COUNT(*) &gt; 1</span><br><span class="line">) tableA</span><br><span class="line">)</span><br><span class="line">AND id NOT IN (</span><br><span class="line">SELECT id</span><br><span class="line">FROM (</span><br><span class="line">SELECT MIN(id) AS id</span><br><span class="line">FROM table_name_A</span><br><span class="line">GROUP BY field_a, field_b</span><br><span class="line">HAVING COUNT(*) &gt; 1</span><br><span class="line">) tableB</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><h2 id="插入-创建"><a href="#插入-创建" class="headerlink" title="插入/创建"></a>插入/创建</h2><h3 id="1-根据查询的结果集插入到新表"><a href="#1-根据查询的结果集插入到新表" class="headerlink" title="1.根据查询的结果集插入到新表"></a>1.根据查询的结果集插入到新表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO table_name_b (field_a, field_b)</span><br><span class="line">SELECT field_a, field_b</span><br><span class="line">FROM table_name_a</span><br></pre></td></tr></table></figure><h3 id="2-创建备份表-表结构"><a href="#2-创建备份表-表结构" class="headerlink" title="2.创建备份表(表结构)"></a>2.创建备份表(表结构)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE new_table_name LIKE old_table_name;</span><br></pre></td></tr></table></figure><h3 id="3-创建备份表-表结构-数据"><a href="#3-创建备份表-表结构-数据" class="headerlink" title="3.创建备份表(表结构+数据)"></a>3.创建备份表(表结构+数据)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE new_table_name </span><br><span class="line">SELECT [field_a,field_b... | *] FROM old_table_name;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> MySQL </category>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>支付系列-01-技术选型</title>
      <link href="/2021/07/15/52943/hub/"/>
      <url>/2021/07/15/52943/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20210715145717436.png" alt="image-20210715145717436"></p><h3 id="支付体系来源"><a href="#支付体系来源" class="headerlink" title="支付体系来源"></a>支付体系来源</h3><p>&emsp;&emsp;目的是接入支付宝、微信支付，完成业务内的支付。同时也并不是为了单一的支付功能而接入支付体系，由于saas平台，同时也是属于多租户、多机构、多应用概念的平台，自然也逃避不了支付中心的独立。搭建一个独立的支付中心、同时为多个机构、多个租户提供支付服务。提供聚合的支付方式，简单化平台内部用户与机构支付手续流程。</p><p>&emsp;&emsp;由平台提供统一的支付账号、也支持各商家、机构自己可以申请自己的支付、可以很简单的完成自己内部的支付配置。并且平台内的对接并不需要如同第三方的支付一样需要一写手续费。更加方便的一个支付中心也就应运而生。</p><h3 id="支付开通的商家"><a href="#支付开通的商家" class="headerlink" title="支付开通的商家"></a>支付开通的商家</h3><p>&emsp;&emsp;1:支付宝</p><p>&emsp;&emsp;2.微信</p><p>&emsp;&emsp;暂时只考虑仅接入两个使用广泛的商家、以后如果增加支付的商家只需要按部就班的对接即可。很方便的一个叠加。</p><h3 id="支付设计"><a href="#支付设计" class="headerlink" title="支付设计"></a>支付设计</h3><p>&emsp;&emsp;1.商户</p><p>&emsp;&emsp;机构、应用、用户、租户等都可当作一个商户,例如一个租户下所有的支付都归属于这个租户，还可以租户下的机构也可以自己独立的进行支付、与租户的利益并无关系。商户的概念可以很灵活的处理任意一个层级的支付利益关系。</p><p><img src="/image/hexo/image-20210715151935248.png" alt="image-20210715151935248"></p><p>&emsp;&emsp;2.支付渠道</p><p>&emsp;&emsp;每一个商户都应该有一个支付渠道的配置、例如支付宝、微信都可以算作一个渠道、某些商户只需要其中一个渠道即可。这样平台也可以更细粒度的控制支付。</p><p><img src="/image/hexo/image-20210715151952294.png" alt="image-20210715151952294"></p><p>3.支付订单与子订单</p><p>&emsp;&emsp;任何一笔支付请求都应该对应一笔订单。那么一笔订单可能涉及了多个商家的订单，例如退款的时候应该只是退款某一笔订单、或者全部订单。那么也就会产生了子订单的一个关系，否则无法进行多个商家间的自定义退款。此问题的产生也就是一次支付、多次退款产生出来的。</p><p><img src="/image/hexo/image-20210715151921871.png" alt="image-20210715151921871"></p><p>4.支付通知</p><p>&emsp;&emsp;任何一笔订单在支付完成以后、第三方支付商家会执行一次支付成功的回调通知，由于是支付中心级别的，那么我们的支付通知肯定是要进行一个存储，然后对己方的系统服务进行一个自己实现的通知广播。那么实际上第三方商家的回调我们只需要接收一次即可。</p><p><img src="/image/hexo/image-20210715152514288.png" alt="image-20210715152514288"></p><p>5.支付退款</p><p>&emsp;&emsp;一笔订单可能经过多次退款，那么支付退款和支付订单之间应该一对多的关系。</p><p><img src="/image/hexo/image-20210715152612932.png" alt="image-20210715152612932"></p><p>&emsp;&emsp;这样我们一个简易的支付中心的设计就完成了,既然是简易那么很多细节的功能我并没有设计进去、仅仅是满足V1.0版本的需要，并且需要快速开发。那么后续的细节问题我们在下个版本再去逐步实现。</p><h3 id="对接方式"><a href="#对接方式" class="headerlink" title="对接方式"></a>对接方式</h3><p>&emsp;&emsp;1.对内提供服务间的rpc统一调用接口</p><p>&emsp;&emsp;2.对外提供第三方间的http统一调用接口（此版本不做实现）</p><p>&emsp;&emsp;3.平台内的系统需要对接支付接口、并且暴露出自己系统的http的接口。具体的支付业务各不相同、那么具体的业务实现由各自系统去进行实现。并且还需提供标准的统一回调接口，由支付中心进行下发支付成功的支付。</p><p>&emsp;&emsp;4.系统需要自己实现补偿机制。</p><h3 id="支付中心接口标准-rpc"><a href="#支付中心接口标准-rpc" class="headerlink" title="支付中心接口标准-rpc"></a>支付中心接口标准-rpc</h3><p>&emsp;&emsp;1.统一支付下单接口</p><p>&emsp;&emsp;2.通知支付订单查询结果接口</p><p>&emsp;&emsp;3.支付回调接口</p><p>&emsp;&emsp;4.支付回调二阶段提交接口</p><p>&emsp;&emsp;5.统一支付退款接口</p><p>&emsp;&emsp;以上五个接口即可满足系统接入支付中心。支付中心需要针对rpc的接口调用实现加密、鉴权、幂等。</p><h3 id="系统接口标准-http"><a href="#系统接口标准-http" class="headerlink" title="系统接口标准-http"></a>系统接口标准-http</h3><p>&emsp;&emsp;1.提供标准的支付、退款、查询等接口</p><p>&emsp;&emsp;2.支付、退款等涉及金额操作的接口、需要对接口进行幂等、日志记录等严格的控制、审查。</p><h3 id="对接的支付方式"><a href="#对接的支付方式" class="headerlink" title="对接的支付方式"></a>对接的支付方式</h3><p>&emsp;&emsp;小程序支付、二维码支付、app支付、H5支付。</p><h3 id="支付中心设计"><a href="#支付中心设计" class="headerlink" title="支付中心设计"></a>支付中心设计</h3><p>&emsp;&emsp;1.调用时、应当采用策略模版方式。由模板方法制定规则、对每一种接口进行规则定义。统一的校验、以及各自的校验。策略应该采用holder模式、使用注解的方式把每一种支付的方式注册到holder中。实现动态的一个调用、统一的入口。（这里以支付为例、实际上每一种对接的接口都应该按此标准进行实现）</p><p>&emsp;&emsp;2.针对重要的方法、需要对请求参数，响应参数进行一个原封不动的一个记录。日志记录由于需要另一个日志服务进行处理、因此此处不对其进行一个详细的描述。</p><p>&emsp;&emsp;3.针对每一笔订单都需要进行校验、还需要处理支付方式的转变。可能支付订单生成的过程中由支付宝转变为了微信支付，此时编码需要注意订单支付渠道的转变。</p><p>&emsp;&emsp;4.支付通知由于第三方会进行多次推送、我们需要保存任意一次推送即可。然后我们内部再使用死信队列的方式针对内部系统进行二次通知的效果、同时内部系统收到支付通过的时候，也需要将处理的结果进行一个二阶段提交、否则支付中心也将再次进行一个补偿机制的推送。</p><p>&emsp;&emsp;5.整体的流程大致没有什么问题、毕竟作为一个简易的支付中心已经能够满足基本的需求。接下来将从头到尾的不断解析支付中心的演变之路。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 支付 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 设计模式 </tag>
            
            <tag> 支付 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSR更新以及YouTube下载服务</title>
      <link href="/2021/07/12/27227/hub/"/>
      <url>/2021/07/12/27227/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20210712111556924.png" alt="image-20210712111556924"></p><h2 id="SSR节点更新"><a href="#SSR节点更新" class="headerlink" title="SSR节点更新"></a>SSR节点更新</h2><p>【2021-07-13】</p><p>香港阿里云节点：ssr://NDcuMjQyLjEwOS4yMjg6MTAwMDM6YXV0aF9zaGExX3Y0OmFlcy0xMjgtY3RyOnBsYWluOllXUnRhVzQ</p><h2 id="YouTube下载服务"><a href="#YouTube下载服务" class="headerlink" title="YouTube下载服务"></a>YouTube下载服务</h2><p>&emsp;&emsp;<a href="http://47.242.109.228:8080/youtubeDown.html" target="_blank" rel="noopener">http://47.242.109.228:8080/youtubeDown.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
            <tag> Linux </tag>
            
            <tag> Shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hadoop集群模式搭建-基础版</title>
      <link href="/2021/03/31/15217/hub/"/>
      <url>/2021/03/31/15217/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20210331203322676.png" alt="image-20210331203322676"></p><p>&emsp;&emsp;本篇内容需要有<strong>Linux</strong>以及基本的<strong>Java</strong>的基础知识。</p><h2 id="相关准备"><a href="#相关准备" class="headerlink" title="相关准备"></a>相关准备</h2><h3 id="服务器准备"><a href="#服务器准备" class="headerlink" title="服务器准备"></a>服务器准备</h3><p>&emsp;&emsp;这里使用<strong>WINDOWS</strong>的电脑,使用VM开启三台<strong>Centos7</strong>的服务器。我们使用<strong>Xshell</strong>进行链接，链接之前请确保虚拟机的网络正常。</p><p><img src="/../image/hexo/image-20210331204205335.png" alt="image-20210331204205335"></p><p>&emsp;&emsp;大多数的虚拟机镜像并不完整，请一定要检查相关的指令依赖是否拥有，如果还没有下载则先安装好相关的依赖环境后再执行以下的操作步骤。</p><p><img src="/../image/hexo/image-20210331211656008.png" alt="image-20210331211656008"></p><h3 id="节点属性"><a href="#节点属性" class="headerlink" title="节点属性"></a>节点属性</h3><p>&emsp;&emsp;节点之间的关系。</p><table><thead><tr><th>主机名称</th><th>IP</th><th>节点</th></tr></thead><tbody><tr><td>centos1.com</td><td>192.168.25.128</td><td>Master</td></tr><tr><td>centos2.com</td><td>192.168.9.52</td><td>Slave</td></tr><tr><td>centos3.com</td><td>192.168.9.51</td><td>Slave</td></tr></tbody></table><h3 id="JDK的安装以及hosts文件的配置"><a href="#JDK的安装以及hosts文件的配置" class="headerlink" title="JDK的安装以及hosts文件的配置"></a>JDK的安装以及hosts文件的配置</h3><p>&emsp;&emsp;本文需要一定的<strong>Java</strong>基础、所以此处忽略掉<strong>JDK</strong>的安装，针对<strong>JDK</strong>我采用的依旧是1.8的版本。然后修改三台节点上的<strong>hosts</strong>配置。并且修改主机名称为上面列表的名称。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.25.128  centos1.com</span><br><span class="line">192.168.9.52centos2.com</span><br><span class="line">192.168.9.51centos3.com</span><br></pre></td></tr></table></figure><h3 id="SSH处理"><a href="#SSH处理" class="headerlink" title="SSH处理"></a>SSH处理</h3><p>&emsp;&emsp;先在<strong>Master</strong>的节点服务器生成<strong>SSH</strong>的私钥与公钥。特别说明此处需要配置三台服务器的主机名称(我们拷贝是通过服务器主机名称进行操作的)。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /root/.ssh/</span><br><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;拷贝到其他两个<strong>Slave</strong>节点。执行以下脚本会提示输入服务器密码。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id centos2.com</span><br><span class="line">ssh-copy-id centos3.com</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;测试<strong>Master</strong>服务器连接<strong>Slave</strong>服务器。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh centos2.com</span><br><span class="line">ssh centos3.com</span><br></pre></td></tr></table></figure><p><img src="/../image/hexo/image-20210331224531817.png" alt="image-20210331224531817"></p><h3 id="下载hadoop"><a href="#下载hadoop" class="headerlink" title="下载hadoop"></a>下载hadoop</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://archive.apache.org/dist/hadoop/core/hadoop-2.7.2/</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;我们这里使用2.7.2的版本进行搭建。我们在将最后的安装包上传到<strong>/data</strong>目录。这里可以使用<strong>Xftp</strong>工具进行上传，我采用<strong>rz</strong>命令进行上传。</p><p><img src="/../image/hexo/image-20210331230113624.png" alt="image-20210331230113624"></p><h2 id="hadoop的安装"><a href="#hadoop的安装" class="headerlink" title="hadoop的安装"></a>hadoop的安装</h2><h3 id="Master节点"><a href="#Master节点" class="headerlink" title="Master节点"></a>Master节点</h3><h4 id="删除doc"><a href="#删除doc" class="headerlink" title="删除doc"></a>删除doc</h4><p>&emsp;&emsp;此处为你安装<strong>hadoop</strong>的位置。我的为<strong>/data/hadoop-2.7.2</strong>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /data/hadoop-2.7.2/share/doc/*</span><br></pre></td></tr></table></figure><h4 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;在尾部加上环境变量。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_HOME=/data/hadoop-2.7.2</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/bin</span><br></pre></td></tr></table></figure><h4 id="刷新环境变量"><a href="#刷新环境变量" class="headerlink" title="刷新环境变量"></a>刷新环境变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h4 id="修改hadoop配置"><a href="#修改hadoop配置" class="headerlink" title="修改hadoop配置"></a>修改hadoop配置</h4><p>&emsp;&emsp;进入配置目录。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /data/hadoop-2.7.2/etc/hadoop</span><br></pre></td></tr></table></figure><h5 id="修改hadoop-env-sh"><a href="#修改hadoop-env-sh" class="headerlink" title="修改hadoop-env.sh"></a>修改hadoop-env.sh</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改JAVA_HOME 这个为你的JDK安装目录</span></span><br><span class="line"></span><br><span class="line">export JAVA_HOME = /data/jdk1.8.0_221</span><br></pre></td></tr></table></figure><h5 id="修改core-site-xml"><a href="#修改core-site-xml" class="headerlink" title="修改core-site.xml"></a>修改core-site.xml</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi core-site.xml</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 修改configuration节点 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 指定HDFSnamenode通信地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://centos1.com:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 指定hadoop存储路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 根据自己的安装hadoop的路径配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/data/hadoop-2.7.2/etc/hadoop/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="修改hdfs-site-xml"><a href="#修改hdfs-site-xml" class="headerlink" title="修改hdfs-site.xml"></a>修改hdfs-site.xml</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi hdfs-site.xml</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 修改configuration节点 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置namenode的http通讯地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>centos1.com:50070<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置secondarynamenode的http通讯地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>centos2.com:50090<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置namenode存放路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.name.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/data/hadoop-2.7.2/etc/hadoop/name<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置hdfs副本数量 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置datanode存放路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">value</span>&gt;</span>/data/hadoop-2.7.2/etc/hadoop/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="修改mapred-site-xml"><a href="#修改mapred-site-xml" class="headerlink" title="修改mapred-site.xml"></a>修改mapred-site.xml</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv mapred-site.xml.template mapred-site.xml</span><br><span class="line">vi mapred-site.xml</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 修改configuration节点 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="修改yarn-site-xml"><a href="#修改yarn-site-xml" class="headerlink" title="修改yarn-site.xml"></a>修改yarn-site.xml</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi yarn-site.xml</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 修改configuration节点 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置 resourcemanager --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>centos1.com<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- reducer方式mapreduce_shuffle --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services.mapreduce.shuffle.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.mapred.ShuffleHandler<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="修改slaves"><a href="#修改slaves" class="headerlink" title="修改slaves"></a>修改slaves</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi slaves</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改为以下内容</span></span><br><span class="line">centos1.com</span><br><span class="line">centos2.com</span><br></pre></td></tr></table></figure><h5 id="新建masters文件"><a href="#新建masters文件" class="headerlink" title="新建masters文件"></a>新建masters文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch masters</span><br><span class="line">vi masters</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 新增为以下内容</span></span><br><span class="line">centos1.com</span><br></pre></td></tr></table></figure><h5 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir data name tmp</span><br></pre></td></tr></table></figure><h3 id="Slaves节点"><a href="#Slaves节点" class="headerlink" title="Slaves节点"></a>Slaves节点</h3><h4 id="拷贝环境变量"><a href="#拷贝环境变量" class="headerlink" title="拷贝环境变量"></a>拷贝环境变量</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/profile root@centos2.com:/etc/</span><br><span class="line">scp /etc/profile root@centos3.com:/etc/</span><br></pre></td></tr></table></figure><h2 id="拷贝hadoop"><a href="#拷贝hadoop" class="headerlink" title="拷贝hadoop"></a>拷贝hadoop</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r /data/hadoop-2.7.2 root@centos2.com:/data/</span><br><span class="line">scp -r /data/hadoop-2.7.2 root@centos3.com:/data/</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;分别在两个<strong>Slaves</strong>节点服务器进行刷新环境配置操作。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><h3 id="初始化namenode"><a href="#初始化namenode" class="headerlink" title="初始化namenode"></a>初始化namenode</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/hdfs namenode -format</span><br></pre></td></tr></table></figure><h3 id="启动hadoop"><a href="#启动hadoop" class="headerlink" title="启动hadoop"></a>启动hadoop</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh /data/hadoop-2.7.2/sbin/start-all.sh</span><br></pre></td></tr></table></figure><h3 id="停止hadoop"><a href="#停止hadoop" class="headerlink" title="停止hadoop"></a>停止hadoop</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh /data/hadoop-2.7.2/sbin/stop-add.sh</span><br></pre></td></tr></table></figure><h3 id="检查master"><a href="#检查master" class="headerlink" title="检查master"></a>检查master</h3><p><img src="/image/hexo/image-20210401011033746.png" alt="image-20210401011033746"></p><h3 id="检查slaves"><a href="#检查slaves" class="headerlink" title="检查slaves"></a>检查slaves</h3><p><img src="/image/hexo/image-20210401011056586.png" alt="image-20210401011056586"></p><h3 id="检查hdfs"><a href="#检查hdfs" class="headerlink" title="检查hdfs"></a>检查hdfs</h3><p><img src="/image/hexo/image-20210401011127700.png" alt="image-20210401011127700"></p><h3 id="检查yarn"><a href="#检查yarn" class="headerlink" title="检查yarn"></a>检查yarn</h3><p><img src="/image/hexo/image-20210401011207620.png" alt="image-20210401011207620"></p><h2 id="补充说明"><a href="#补充说明" class="headerlink" title="补充说明"></a>补充说明</h2><p>&emsp;&emsp;到此为止<strong>hadoop</strong>的基础集群版环境已经搭建完成。</p><p>&emsp;&emsp;虚拟机安装的centos系统存在各种依赖问题、请尽量使用完整一点的镜像进行搭建。在最后浏览器测试的时候需要注意centos的系统的防火墙的开放。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Java </category>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Java </tag>
            
            <tag> Hadoop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSR教程以及锐速安装(阿里云应用服务器)</title>
      <link href="/2021/03/30/27227/hub/"/>
      <url>/2021/03/30/27227/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20210330233108125.png" alt="image-20210330233108125"></p><p>&emsp;&emsp;本篇内容需要有<strong>Linux</strong>以及基本的<strong>Shell</strong>的基础知识。</p><h2 id="服务器的购买"><a href="#服务器的购买" class="headerlink" title="服务器的购买"></a>服务器的购买</h2><p>&emsp;&emsp;由于国内的防火墙原因、导致我们无法连上国外的网站,例如<strong>谷歌</strong>等。所以我们的服务的选用均为境外的服务器。这个有多种途径可以购买,我们采用最简单的<strong>阿里云</strong>平台进行购买。</p><h3 id="注册并完成相关认证进行购买"><a href="#注册并完成相关认证进行购买" class="headerlink" title="注册并完成相关认证进行购买"></a>注册并完成相关认证进行购买</h3><p>&emsp;&emsp;1.这里提供<a href="https://www.aliyun.com" target="_blank" rel="noopener">官方网站</a>的地址,可以使用支付宝等完成认证。</p><p>&emsp;&emsp;2.可以选择<a href="https://common-buy.aliyun.com/?spm=5176.10173289.101.1.4e802e77nohSdk&commodityCode=swas&regionId=cn-hongkong" target="_blank" rel="noopener">轻量应用型服务器</a>,选择合适的配置进行购买、这里需要选择境外的节点。例如：香港。</p><p><img src="/image/hexo/image-20210330233921224.png" alt="image-20210330233921224"></p><p>&emsp;&emsp;3.这里我选择了新加坡的节点,镜像需要选择Centos7.3,如果对这方面比较熟悉的可以自行选择。</p><h2 id="服务器的链接与配置"><a href="#服务器的链接与配置" class="headerlink" title="服务器的链接与配置"></a>服务器的链接与配置</h2><h3 id="链接服务器"><a href="#链接服务器" class="headerlink" title="链接服务器"></a>链接服务器</h3><p>&emsp;&emsp;1.当购买完成以后我们可以进入控制台看到如下界面。并且我们可以进入详情查看服务器的具体信息。</p><p><img src="/image/hexo/image-20210330234318779.png" alt="image-20210330234318779"></p><p>&emsp;&emsp;2.我们可以从详情里面看到服务器的<strong>IP</strong>、<strong>CPU</strong>等相关信息。我们链接服务器需要<strong>IP</strong>、<strong>端口</strong>、<strong>账号密码</strong>。由于我们购买服务器的时候没有设置密码、所以我们先将服务器的密码重置一下。</p><p><img src="/image/hexo/image-20210330234526455.png" alt="image-20210330234526455"></p><p>&emsp;&emsp;3.这样我们得到了服务器的基本参数,其中端口默认为<strong>22</strong>,账号默认为<strong>root</strong>。</p><h4 id="准备链接服务器的工具"><a href="#准备链接服务器的工具" class="headerlink" title="准备链接服务器的工具"></a>准备链接服务器的工具</h4><p>&emsp;&emsp;1.链接服务器的工具比较多,这里我们采用<strong>Xshell</strong>进行链接。</p><p>&emsp;&emsp;2.<a href="https://xshell.en.softonic.com" target="_blank" rel="noopener">官方网站</a></p><p>&emsp;&emsp;3.我们打开软件新建一个会话、输入相关的参数。</p><p><img src="/image/hexo/image-20210330234957526.png" alt="image-20210330234957526"></p><p><img src="/image/hexo/image-20210330235021668.png" alt="image-20210330235021668"></p><p>&emsp;&emsp;4.输入账号、为了方便我们选择记住用户名。</p><p><img src="/image/hexo/image-20210330235115009.png" alt="image-20210330235115009"></p><p>&emsp;&emsp;5.输入密码、同时我们也选择记住密码。</p><p><img src="/image/hexo/image-20210330235153648.png" alt="image-20210330235153648"></p><h2 id="搭建服务端SSR"><a href="#搭建服务端SSR" class="headerlink" title="搭建服务端SSR"></a>搭建服务端SSR</h2><h3 id="新建ssr文件夹"><a href="#新建ssr文件夹" class="headerlink" title="新建ssr文件夹"></a>新建ssr文件夹</h3><p><img src="/image/hexo/image-20210331084752975.png" alt="image-20210331084752975"></p><h3 id="下载、授权、执行脚本"><a href="#下载、授权、执行脚本" class="headerlink" title="下载、授权、执行脚本"></a>下载、授权、执行脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -N –no-check-certificate https://raw.githubusercontent.com/ToyoDAdoubi/doubi/master/ssr.sh</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x ssr.sh</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash ssr.sh</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20210331085314722.png" alt="image-20210331085314722"></p><p>&emsp;&emsp;这里我们不进行任何的个性化设置、使用默认参数进行搭建。所以接下来我们可以开始一路回车。</p><p><img src="/image/hexo/image-20210331085425642.png" alt="image-20210331085425642"></p><p> &emsp;&emsp;我们仅需要静静的等待安装完成即可。完成安装我们可以得到如下的信息。我们复制这个SSR的链接导入的影梭里面进行链接。</p><p><img src="/image/hexo/image-20210331085520597.png" alt="image-20210331085520597"></p><h3 id="设置服务器防火墙"><a href="#设置服务器防火墙" class="headerlink" title="设置服务器防火墙"></a>设置服务器防火墙</h3><p><img src="/image/hexo/image-20210331085943927.png" alt="image-20210331085943927"></p><p>&emsp;&emsp;在阿里云服务器控制台进行防火墙的开放。</p><p><img src="/image/hexo/image-20210331085812025.png" alt="image-20210331085812025"></p><p>&emsp;&emsp;至此SSR搭建完毕。</p><h2 id="锐速的安装"><a href="#锐速的安装" class="headerlink" title="锐速的安装"></a>锐速的安装</h2><p>&emsp;&emsp;执行脚本、同样一路回车即可，当内核更换完成后服务器会自行重启。我们重新再次链接。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate -O rskernel.sh https://raw.githubusercontent.com/uxh/awesome-linux-tools/master/rskernel_2.sh &amp;&amp; bash rskernel.sh</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20210331090425997.png" alt="image-20210331090425997"></p><p>&emsp;&emsp;我们继续执行脚本,并且一路回车。静静等待安装完成。出现以下图片则安装完毕。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install net-tools -y &amp;&amp; wget --no-check-certificate -O appex.sh https://raw.githubusercontent.com/uxh/serverSpeeder_Install/master/appex.sh &amp;&amp; bash appex.sh install</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20210331090637491.png" alt="image-20210331090637491"></p><h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>&emsp;&emsp;SSR也存在封掉IP的风险，如果一旦封掉那么我们可以阿里云的费用模块进行退款，然后重新购买服务器进行搭建。科学上网、且行且珍惜。</p><p>&emsp;&emsp;以防脚本失效这里备份一下上面用到的<a href="https://sanmeng.lanzous.com/iCDxVnhv55g" target="_blank" rel="noopener">所有脚本</a>。以及<a href="https://sanmeng.lanzous.com/iSwU7nhv8dc" target="_blank" rel="noopener">客户端</a>的链接软件。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
          <category> Shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
            <tag> Linux </tag>
            
            <tag> Shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-53-Phaser详解</title>
      <link href="/2020/07/25/56893/hub/"/>
      <url>/2020/07/25/56893/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200725140252917.png" alt="image-20200725140252917"></p><p>&emsp;&emsp;<strong>Phaser</strong>是从JDK1.7引入的，更多的是对<strong>CountDownLatch</strong>和<strong>CyclicBarrier</strong>功能的增强。更加的类似一个多阶段的栅栏。它可以在初始化时设定参与线程的数量，也可以在中途注册或者注销参与者，若达到的参与数量满足栅栏的条件后会进行阶段性的升级(advance)。</p><h2 id="Phaser流程"><a href="#Phaser流程" class="headerlink" title="Phaser流程"></a>Phaser流程</h2><p><img src="/image/hexo/image-20200725151806247.png" alt="image-20200725151806247"></p><h3 id="phaser"><a href="#phaser" class="headerlink" title="phaser"></a>phaser</h3><p>&emsp;&emsp;<strong>phaser</strong>初始阶段为0，当所有的<strong>phaser</strong>参与者都到达后<strong>phaser</strong>值进行递增，最大为<code>Integer.MAX_VALUE</code>，再次归零。</p><h3 id="parties"><a href="#parties" class="headerlink" title="parties"></a>parties</h3><p>&emsp;&emsp;主要指的是执行任务的线程。可以初始化指定参与者的数量也可以中途<code>register</code>,<code>bulkRegister</code>,<code>arriveAndDeregister</code>进行注册或者注销参与者。</p><h4 id="arrive-advance"><a href="#arrive-advance" class="headerlink" title="arrive/advance"></a>arrive/advance</h4><p>&emsp;&emsp;<strong>Phaser</strong>注册完<strong>parties</strong>后，参与者的初始状态为<code>unarrived</code>，如果参与者达到(<code>arrvie</code>)当前的阶段后，状态会变成<code>arrvied</code>。当阶段的参与数满足条件后，阶段就会进阶(<code>advance</code>)。</p><h3 id="Termination"><a href="#Termination" class="headerlink" title="Termination"></a>Termination</h3><p>&emsp;&emsp;当前<strong>Phaser</strong>对象达到了终止状态。</p><h3 id="Tiering"><a href="#Tiering" class="headerlink" title="Tiering"></a>Tiering</h3><p>&emsp;&emsp;可以通过构造函数指定当前的<strong>Phaser</strong>对象的父节点，主要还是出现了大量的<strong>parties</strong>内部的操作会导致整体的性能急剧下降，通过<strong>Tiering</strong>减小同步操作所带来的性能开销。</p><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="案例一（控制时机）"><a href="#案例一（控制时机）" class="headerlink" title="案例一（控制时机）"></a>案例一（控制时机）</h3><p>&emsp;&emsp;值得注意的是<code>arriveAndAwaitAdvance</code>方法是不响应中断的，如果某个正在执行的线程被打断也不会返回或者抛出异常信息，那么整个程序就会陷入继续等待。<code>awaitAdvanceInterruptibly</code>则可以解决该问题。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Phaser phaser = <span class="keyword">new</span> Phaser();</span><br><span class="line">    IntStream.rangeClosed(<span class="number">1</span>,<span class="number">10</span>)</span><br><span class="line">        .forEach(i-&gt;&#123;</span><br><span class="line">            phaser.register();</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> PhaserWorker(phaser), <span class="string">"T-"</span> + i).start();</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PhaserWorker</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">    PhaserWorker(Phaser phaser) &#123;</span><br><span class="line">        <span class="keyword">this</span>.phaser = phaser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">": 执行完任务，当前phase ="</span> + phaser.arriveAndAwaitAdvance() + <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="案例二（开关）"><a href="#案例二（开关）" class="headerlink" title="案例二（开关）"></a>案例二（开关）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Phaser phaser = <span class="keyword">new</span> Phaser(<span class="number">1</span>);</span><br><span class="line">    IntStream.rangeClosed(<span class="number">1</span>,<span class="number">10</span>)</span><br><span class="line">        .forEach(i-&gt;&#123;</span><br><span class="line">            phaser.register();</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> SwitchWorker(phaser), <span class="string">"T-"</span> + i).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    System.out.println(<span class="string">"请输入命令，打开程序开关"</span>);</span><br><span class="line">    BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));</span><br><span class="line">    reader.readLine();</span><br><span class="line">    phaser.arriveAndDeregister();</span><br><span class="line">    System.out.println(<span class="string">"程序开关已打开，开始执行任务......"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SwitchWorker</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">    SwitchWorker(Phaser phaser) &#123;</span><br><span class="line">        <span class="keyword">this</span>.phaser = phaser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">": 执行完任务，当前phase ="</span> + phaser.arriveAndAwaitAdvance() + <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="案例三（控制任务执行次数）"><a href="#案例三（控制任务执行次数）" class="headerlink" title="案例三（控制任务执行次数）"></a>案例三（控制任务执行次数）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//线程任务最多执行的次数</span></span><br><span class="line">    <span class="keyword">int</span> repeats = <span class="number">5</span>;</span><br><span class="line">    Phaser phaser = <span class="keyword">new</span> Phaser()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="comment">//重写onAdvance，当最后一个参与者到达时，会触发onAdvance方法</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAdvance</span><span class="params">(<span class="keyword">int</span> phase, <span class="keyword">int</span> registeredParties)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"---------------PHASE["</span> + phase + <span class="string">"],Parties["</span> + registeredParties + <span class="string">"] ---------------"</span>);</span><br><span class="line">            <span class="keyword">return</span> phase + <span class="number">1</span> &gt;= repeats  || registeredParties == <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    IntStream.rangeClosed(<span class="number">1</span>,<span class="number">10</span>)</span><br><span class="line">        .forEach(i-&gt;&#123;</span><br><span class="line">            phaser.register();</span><br><span class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> CountWorker(phaser), <span class="string">"T-"</span> + i).start();</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CountWorker</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">    CountWorker(Phaser phaser) &#123;</span><br><span class="line">        <span class="keyword">this</span>.phaser = phaser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (!phaser.isTerminated()) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">": 执行完任务，当前phase ="</span> + phaser.arriveAndAwaitAdvance() + <span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="案例四（任务分层）"><a href="#案例四（任务分层）" class="headerlink" title="案例四（任务分层）"></a>案例四（任务分层）</h3><p><img src="/image/hexo/image-20200725170019018.png" alt="image-20200725170019018"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  TASKS_PER_PHASER = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> phaseToTerminate = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">final</span> Phaser phaser = <span class="keyword">new</span> Phaser() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAdvance</span><span class="params">(<span class="keyword">int</span> phase, <span class="keyword">int</span> registeredParties)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"onAdvance:"</span> + phase);</span><br><span class="line">            <span class="keyword">return</span> phase == phaseToTerminate || registeredParties == <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">final</span> Task tasks[] = <span class="keyword">new</span> Task[<span class="number">10</span>];</span><br><span class="line">    build(tasks, <span class="number">0</span>, tasks.length, phaser);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tasks.length; i++) &#123;</span><br><span class="line">        System.out.println(<span class="string">"starting thread, id: "</span> + i);</span><br><span class="line">        <span class="keyword">final</span> Thread thread = <span class="keyword">new</span> Thread(tasks[i]);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//递归分层，</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">(Task[] tasks, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi, Phaser ph)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如果任务的数量超过每一层的phaser的阈值TASKS_PER_PHASER，则要继续分层</span></span><br><span class="line">    <span class="keyword">if</span> (hi - lo &gt; TASKS_PER_PHASER) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lo; i &lt; hi; i += TASKS_PER_PHASER) &#123;</span><br><span class="line">            <span class="keyword">int</span> j = Math.min(i + TASKS_PER_PHASER, hi);</span><br><span class="line">            build(tasks, i, j, <span class="keyword">new</span> Phaser(ph));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lo; i &lt; hi; ++i) &#123;</span><br><span class="line">            tasks[i] = <span class="keyword">new</span> Task(i, ph);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Task</span><span class="params">(<span class="keyword">int</span> id, Phaser phaser)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.phaser = phaser;</span><br><span class="line">        <span class="keyword">this</span>.phaser.register();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (!phaser.isTerminated()) &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Thread run :"</span> + phaser.getPhase() + <span class="string">", id: "</span> + <span class="keyword">this</span>.id);</span><br><span class="line">            phaser.arriveAndAwaitAdvance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Phaser相关API"><a href="#Phaser相关API" class="headerlink" title="Phaser相关API"></a>Phaser相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Phaser</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无参构造</span></span><br><span class="line">Phaser p1 = <span class="keyword">new</span> Phaser();</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定parties</span></span><br><span class="line">Phaser p2 = <span class="keyword">new</span> Phaser(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定父Phaser</span></span><br><span class="line">Phaser p3 = <span class="keyword">new</span> Phaser(p1);</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定父Phaser同时指定当前parties</span></span><br><span class="line">Phaser p4 = <span class="keyword">new</span> Phaser(p1,<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h3 id="相关属性"><a href="#相关属性" class="headerlink" title="相关属性"></a>相关属性</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 状态变量，用于存储当前阶段phase、参与者数parties、未完成的参与者数unarrived_count</span></span><br><span class="line"><span class="comment">//state的最高位是一个标志位，1表示Phaser的线程同步已经结束，0表示线程同步正在进行</span></span><br><span class="line"><span class="comment">//state的低32位中，低16位表示没有到达的线程数量，高16位表示Parties值</span></span><br><span class="line"><span class="comment">//state的高32位除了最高位之外的其他31位表示的Phaser的phase，可以理解为第多少次同步（从0开始计算）</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> state;</span><br><span class="line"><span class="comment">// 最多可以有多少个参与者，即每个阶段最多有多少个任务</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  MAX_PARTIES     = <span class="number">0xffff</span>;</span><br><span class="line"><span class="comment">// 最多可以有多少阶段</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  MAX_PHASE       = Integer.MAX_VALUE;</span><br><span class="line"><span class="comment">// 参与者数量的偏移量</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  PARTIES_SHIFT   = <span class="number">16</span>;</span><br><span class="line"><span class="comment">// 当前阶段的偏移量</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  PHASE_SHIFT     = <span class="number">32</span>;</span><br><span class="line"><span class="comment">// 未完成的参与者数的掩码，低16位</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  UNARRIVED_MASK  = <span class="number">0xffff</span>;      <span class="comment">// to mask ints</span></span><br><span class="line"><span class="comment">// 参与者数，中间16位</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> PARTIES_MASK    = <span class="number">0xffff0000L</span>; <span class="comment">// to mask longs</span></span><br><span class="line"><span class="comment">// counts的掩码，counts等于参与者数和未完成的参与者数的'|'操作</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> COUNTS_MASK     = <span class="number">0xffffffffL</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> TERMINATION_BIT = <span class="number">1L</span> &lt;&lt; <span class="number">63</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 一次一个参与者完成</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  ONE_ARRIVAL     = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 增加减少参与者时使用</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  ONE_PARTY       = <span class="number">1</span> &lt;&lt; PARTIES_SHIFT;</span><br><span class="line"><span class="comment">// 减少参与者时使用</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  ONE_DEREGISTER  = ONE_ARRIVAL|ONE_PARTY;</span><br><span class="line"><span class="comment">// 没有参与者时使用</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  EMPTY           = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="register"><a href="#register" class="headerlink" title="register"></a>register</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Phaser phaser = <span class="keyword">new</span> Phaser();</span><br><span class="line"></span><br><span class="line"><span class="comment">//register</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.添加一个需要同步的线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">phaser.register();</span><br></pre></td></tr></table></figure><h4 id="bulkRegister"><a href="#bulkRegister" class="headerlink" title="bulkRegister"></a>bulkRegister</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bulkRegister</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.添加parties个需要同步的线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">phaser.bulkRegister(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="arrive"><a href="#arrive" class="headerlink" title="arrive"></a>arrive</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arrive</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.等待其他线程的到达</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">phaser.arrive();</span><br></pre></td></tr></table></figure><h4 id="arriveAndDeregister"><a href="#arriveAndDeregister" class="headerlink" title="arriveAndDeregister"></a>arriveAndDeregister</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arriveAndDeregister</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.不等待其他线程的到达，立即返回</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">phaser.arriveAndDeregister();</span><br></pre></td></tr></table></figure><h4 id="arriveAndAwaitAdvance"><a href="#arriveAndAwaitAdvance" class="headerlink" title="arriveAndAwaitAdvance"></a>arriveAndAwaitAdvance</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arriveAndAwaitAdvance</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.等到下一个phase开始再返回</span></span><br><span class="line"><span class="comment"> * 2.类似doArrive方法+awaitAdvance方法的功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">phaser.arriveAndAwaitAdvance();</span><br></pre></td></tr></table></figure><h4 id="awaitAdvance"><a href="#awaitAdvance" class="headerlink" title="awaitAdvance"></a>awaitAdvance</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//awaitAdvance</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.线程等待，任务线程不可中断，不处理异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">phaser.awaitAdvance(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><h4 id="awaitAdvanceInterruptibly"><a href="#awaitAdvanceInterruptibly" class="headerlink" title="awaitAdvanceInterruptibly"></a>awaitAdvanceInterruptibly</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//awaitAdvanceInterruptibly</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.线程等待，可以中断</span></span><br><span class="line"><span class="comment"> * 2.有用超时的机制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">phaser.awaitAdvanceInterruptibly(<span class="number">1</span>);</span><br><span class="line">phaser.awaitAdvanceInterruptibly(<span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure><h2 id="Phaser源码解析"><a href="#Phaser源码解析" class="headerlink" title="Phaser源码解析"></a>Phaser源码解析</h2><p><img src="/image/hexo/image-20200725183216245.png" alt="image-20200725183216245"></p><h3 id="Phaser几种节点"><a href="#Phaser几种节点" class="headerlink" title="Phaser几种节点"></a>Phaser几种节点</h3><h4 id="孤立的Phaser结点"><a href="#孤立的Phaser结点" class="headerlink" title="孤立的Phaser结点"></a>孤立的Phaser结点</h4><p><img src="/image/hexo/image-20200725184044267.png" alt="image-20200725184044267"></p><h4 id="非孤立的Phaser叶子节点"><a href="#非孤立的Phaser叶子节点" class="headerlink" title="非孤立的Phaser叶子节点"></a>非孤立的Phaser叶子节点</h4><p><img src="/image/hexo/image-20200725184121902.png" alt="image-20200725184121902"></p><h3 id="内部数据结构QNode"><a href="#内部数据结构QNode" class="headerlink" title="内部数据结构QNode"></a>内部数据结构QNode</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无锁栈、Treiber Stack栈顶指针</span></span><br><span class="line"><span class="comment">//使用Treiber Stack结构保存等待线程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//phase奇偶切换交替使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//偶数栈</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;QNode&gt; evenQ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//奇数栈</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;QNode&gt; oddQ;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要保存了线程信息和Phaser对象信息</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">QNode</span> <span class="keyword">implements</span> <span class="title">ForkJoinPool</span>.<span class="title">ManagedBlocker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Phaser phaser;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> phase;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> interruptible;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> timed;</span><br><span class="line">    <span class="keyword">boolean</span> wasInterrupted;</span><br><span class="line">    <span class="keyword">long</span> nanos;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> deadline;</span><br><span class="line">    <span class="keyword">volatile</span> Thread thread; <span class="comment">// nulled to cancel wait</span></span><br><span class="line">    QNode next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="构造函数-1"><a href="#构造函数-1" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Phaser</span><span class="params">(Phaser parent, <span class="keyword">int</span> parties)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parties &gt;&gt;&gt; PARTIES_SHIFT != <span class="number">0</span>)</span><br><span class="line">        <span class="comment">//parties右移16为如果不为0：parties超出了最大的限制数量</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal number of parties"</span>);</span><br><span class="line">    <span class="comment">//定义初始值</span></span><br><span class="line">    <span class="keyword">int</span> phase = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.parent = parent;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//存在父节点</span></span><br><span class="line">        <span class="comment">//当前Phaser的root节点指向父节点的root</span></span><br><span class="line">        <span class="keyword">final</span> Phaser root = parent.root;</span><br><span class="line">        <span class="keyword">this</span>.root = root;</span><br><span class="line">        <span class="comment">//共用父节点的无锁栈</span></span><br><span class="line">        <span class="keyword">this</span>.evenQ = root.evenQ;</span><br><span class="line">        <span class="keyword">this</span>.oddQ = root.oddQ;</span><br><span class="line">        <span class="comment">//向父类注册一个参与者</span></span><br><span class="line">        <span class="keyword">if</span> (parties != <span class="number">0</span>)</span><br><span class="line">            phase = parent.doRegister(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//root节点指向自身</span></span><br><span class="line">        <span class="keyword">this</span>.root = <span class="keyword">this</span>;</span><br><span class="line">        <span class="comment">//创建新的无锁栈结构</span></span><br><span class="line">        <span class="keyword">this</span>.evenQ = <span class="keyword">new</span> AtomicReference&lt;QNode&gt;();</span><br><span class="line">        <span class="keyword">this</span>.oddQ = <span class="keyword">new</span> AtomicReference&lt;QNode&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新同步state状态值</span></span><br><span class="line">    <span class="keyword">this</span>.state = (parties == <span class="number">0</span>) ? (<span class="keyword">long</span>)EMPTY :</span><br><span class="line">        ((<span class="keyword">long</span>)phase &lt;&lt; PHASE_SHIFT) |</span><br><span class="line">        ((<span class="keyword">long</span>)parties &lt;&lt; PARTIES_SHIFT) |</span><br><span class="line">        ((<span class="keyword">long</span>)parties);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="register-1"><a href="#register-1" class="headerlink" title="register"></a>register</h3><p>&emsp;&emsp;1.增加一个参与者：同时增加<code>parties</code>和<code>unarrived</code>两个参数，对应<code>state</code>的中16位和低16位。</p><p>&emsp;&emsp;2.第一个参与者：尝试原子性更新<code>state</code>，成功则退出。</p><p>&emsp;&emsp;3.不是第一个参与者:检测是否在执行<code>onAdvance</code>方法，等待其执行完毕（自旋+入队等待的方式），否则尝试原子更新<code>state</code>，成功则退出。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册一个参与者</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> doRegister(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doRegister</span><span class="params">(<span class="keyword">int</span> registrations)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//计算state需要加的值</span></span><br><span class="line">    <span class="comment">//同时增加parties和unarrived</span></span><br><span class="line">    <span class="keyword">long</span> adjust = ((<span class="keyword">long</span>)registrations &lt;&lt; PARTIES_SHIFT) | registrations;</span><br><span class="line">    <span class="comment">//获取当前的父节点</span></span><br><span class="line">    <span class="keyword">final</span> Phaser parent = <span class="keyword">this</span>.parent;</span><br><span class="line">    <span class="keyword">int</span> phase;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//获取state值</span></span><br><span class="line">        <span class="keyword">long</span> s = (parent == <span class="keyword">null</span>) ? state : reconcileState();</span><br><span class="line">        <span class="comment">//state的低32位：parties和unarrived的值</span></span><br><span class="line">        <span class="keyword">int</span> counts = (<span class="keyword">int</span>)s;</span><br><span class="line">        <span class="comment">//parties值</span></span><br><span class="line">        <span class="keyword">int</span> parties = counts &gt;&gt;&gt; PARTIES_SHIFT;</span><br><span class="line">        <span class="comment">//unarrived值</span></span><br><span class="line">        <span class="keyword">int</span> unarrived = counts &amp; UNARRIVED_MASK;</span><br><span class="line">        <span class="comment">//检测是否溢出</span></span><br><span class="line">        <span class="keyword">if</span> (registrations &gt; MAX_PARTIES - parties)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(badRegister(s));</span><br><span class="line">        <span class="comment">//计算当前阶段的phase</span></span><br><span class="line">        phase = (<span class="keyword">int</span>)(s &gt;&gt;&gt; PHASE_SHIFT);</span><br><span class="line">        <span class="keyword">if</span> (phase &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//不是第一个参与者，退出循环</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (counts != EMPTY) &#123;                  <span class="comment">// not 1st registration</span></span><br><span class="line">            <span class="keyword">if</span> (parent == <span class="keyword">null</span> || reconcileState() == s) &#123;</span><br><span class="line">                <span class="keyword">if</span> (unarrived == <span class="number">0</span>)             <span class="comment">// wait out advance</span></span><br><span class="line">                    <span class="comment">//unarrived == 0 表示正在执行advance方法等待执行完毕</span></span><br><span class="line">                    root.internalAwaitAdvance(phase, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, stateOffset,</span><br><span class="line">                                                   s, s + adjust))</span><br><span class="line">                    <span class="comment">//尝试CAS修改state的值，增加之前计算的adjust</span></span><br><span class="line">                    <span class="comment">//修改成功则退出循环</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;              <span class="comment">// 1st root registration</span></span><br><span class="line">            <span class="comment">//第一个参与者</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//计算state值</span></span><br><span class="line">            <span class="keyword">long</span> next = ((<span class="keyword">long</span>)phase &lt;&lt; PHASE_SHIFT) | adjust;</span><br><span class="line">            <span class="comment">//尝试CAS修改state的值，增加之前计算的adjust</span></span><br><span class="line">            <span class="comment">//修改成功则退出循环</span></span><br><span class="line">            <span class="keyword">if</span> (UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, stateOffset, s, next))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//分层操作</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (state == s) &#123;</span><br><span class="line">                    <span class="comment">//向父类注册一个参与之</span></span><br><span class="line">                    phase = parent.doRegister(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">if</span> (phase &lt; <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">while</span> (!UNSAFE.compareAndSwapLong</span><br><span class="line">                           (<span class="keyword">this</span>, stateOffset, s,</span><br><span class="line">                            ((<span class="keyword">long</span>)phase &lt;&lt; PHASE_SHIFT) | adjust)) &#123;</span><br><span class="line">                        s = state;</span><br><span class="line">                        phase = (<span class="keyword">int</span>)(root.state &gt;&gt;&gt; PHASE_SHIFT);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> phase;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="internalAwaitAdvance"><a href="#internalAwaitAdvance" class="headerlink" title="internalAwaitAdvance"></a>internalAwaitAdvance</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//等待onAdvance方法执行完毕</span></span><br><span class="line"><span class="comment">//采用自旋方式</span></span><br><span class="line"><span class="comment">//自旋如果达到限制则当前线程加入队列，等待onAdvance方法执行完毕后唤醒线程</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">internalAwaitAdvance</span><span class="params">(<span class="keyword">int</span> phase, QNode node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//保证队列为空</span></span><br><span class="line">    releaseWaiters(phase-<span class="number">1</span>);          <span class="comment">// ensure old queue clean</span></span><br><span class="line">    <span class="keyword">boolean</span> queued = <span class="keyword">false</span>;           <span class="comment">// true when node is enqueued</span></span><br><span class="line">    <span class="keyword">int</span> lastUnarrived = <span class="number">0</span>;            <span class="comment">// to increase spins upon change</span></span><br><span class="line">    <span class="comment">//自旋的次数</span></span><br><span class="line">    <span class="keyword">int</span> spins = SPINS_PER_ARRIVAL;</span><br><span class="line">    <span class="keyword">long</span> s;</span><br><span class="line">    <span class="keyword">int</span> p;</span><br><span class="line">    <span class="comment">//检测当前阶段是否发生了变化</span></span><br><span class="line">    <span class="comment">//发送变化：进入下一阶段结束自旋</span></span><br><span class="line">    <span class="keyword">while</span> ((p = (<span class="keyword">int</span>)((s = state) &gt;&gt;&gt; PHASE_SHIFT)) == phase) &#123;</span><br><span class="line">        <span class="comment">//如果node为空，那么注册的时候传入为空</span></span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;    </span><br><span class="line">            <span class="comment">//计算unarrived</span></span><br><span class="line">            <span class="keyword">int</span> unarrived = (<span class="keyword">int</span>)s &amp; UNARRIVED_MASK;</span><br><span class="line">            <span class="comment">//unarrived变化则增加自旋次数</span></span><br><span class="line">            <span class="keyword">if</span> (unarrived != lastUnarrived &amp;&amp;</span><br><span class="line">                (lastUnarrived = unarrived) &lt; NCPU)</span><br><span class="line">                spins += SPINS_PER_ARRIVAL;</span><br><span class="line">            <span class="comment">//判断线程是否interrupted</span></span><br><span class="line">            <span class="keyword">boolean</span> interrupted = Thread.interrupted();</span><br><span class="line">            <span class="keyword">if</span> (interrupted || --spins &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//线程interrupted或者自旋次数达到限制</span></span><br><span class="line">                <span class="comment">//新建一个节点</span></span><br><span class="line">                node = <span class="keyword">new</span> QNode(<span class="keyword">this</span>, phase, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="number">0L</span>);</span><br><span class="line">                <span class="comment">//设置线程的wasInterrupted属性</span></span><br><span class="line">                node.wasInterrupted = interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node.isReleasable()) <span class="comment">// done or aborted</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!queued) &#123; </span><br><span class="line">            <span class="comment">//节点入队</span></span><br><span class="line">            AtomicReference&lt;QNode&gt; head = (phase &amp; <span class="number">1</span>) == <span class="number">0</span> ? evenQ : oddQ;</span><br><span class="line">            QNode q = node.next = head.get();</span><br><span class="line">            <span class="keyword">if</span> ((q == <span class="keyword">null</span> || q.phase == phase) &amp;&amp;</span><br><span class="line">                (<span class="keyword">int</span>)(state &gt;&gt;&gt; PHASE_SHIFT) == phase) <span class="comment">// avoid stale enq</span></span><br><span class="line">                queued = head.compareAndSet(q, node);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//当前线程进入阻塞</span></span><br><span class="line">                <span class="comment">//等待被唤醒</span></span><br><span class="line">                ForkJoinPool.managedBlock(node);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                node.wasInterrupted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该线程由阻塞被唤醒</span></span><br><span class="line">    <span class="keyword">if</span> (node != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//重置节点中的线程</span></span><br><span class="line">        <span class="keyword">if</span> (node.thread != <span class="keyword">null</span>)</span><br><span class="line">            node.thread = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//判断线程的状态</span></span><br><span class="line">        <span class="keyword">if</span> (node.wasInterrupted &amp;&amp; !node.interruptible)</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        <span class="keyword">if</span> (p == phase &amp;&amp; (p = (<span class="keyword">int</span>)(state &gt;&gt;&gt; PHASE_SHIFT)) == phase)</span><br><span class="line">            <span class="keyword">return</span> abortWait(phase);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//唤醒当前节点等待的线程</span></span><br><span class="line">    releaseWaiters(phase);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="arriveAndAwaitAdvance-1"><a href="#arriveAndAwaitAdvance-1" class="headerlink" title="arriveAndAwaitAdvance"></a>arriveAndAwaitAdvance</h3><p>&emsp;&emsp;1.修改<code>state</code>中的<code>unarrived</code>的值-1</p><p>&emsp;&emsp;2.不是最后一个到达：调用<code>internalAwaitAdvance</code>进入自旋+线程入队等待的方式排队</p><p>&emsp;&emsp;3.最后一个到达：调用<code>onAdvance</code>方法，原子性修改<code>state</code>值为下一阶段的值，唤醒其他等待的线程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当前线程当前的阶段执行完毕</span></span><br><span class="line"><span class="comment">//等待其他线程的当前完成当前阶段</span></span><br><span class="line"><span class="comment">//如果最后一个到达的线程，则执行onAdvance方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">arriveAndAwaitAdvance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Phaser root = <span class="keyword">this</span>.root;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//获取state</span></span><br><span class="line">        <span class="keyword">long</span> s = (root == <span class="keyword">this</span>) ? state : reconcileState();</span><br><span class="line">        <span class="comment">//计算phase</span></span><br><span class="line">        <span class="keyword">int</span> phase = (<span class="keyword">int</span>)(s &gt;&gt;&gt; PHASE_SHIFT);</span><br><span class="line">        <span class="keyword">if</span> (phase &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> phase;</span><br><span class="line">        <span class="comment">//获取unarrived和parties</span></span><br><span class="line">        <span class="keyword">int</span> counts = (<span class="keyword">int</span>)s;</span><br><span class="line">        <span class="keyword">int</span> unarrived = (counts == EMPTY) ? <span class="number">0</span> : (counts &amp; UNARRIVED_MASK);</span><br><span class="line">        <span class="keyword">if</span> (unarrived &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(badArrive(s));</span><br><span class="line">        <span class="comment">//尝试CAS修改state</span></span><br><span class="line">        <span class="keyword">if</span> (UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, stateOffset, s,</span><br><span class="line">                                      s -= ONE_ARRIVAL)) &#123;</span><br><span class="line">            <span class="comment">//判断当前阶段是否最后一个线程到达</span></span><br><span class="line">            <span class="keyword">if</span> (unarrived &gt; <span class="number">1</span>)</span><br><span class="line">                <span class="comment">//不是：调用internalAwaitAdvance进入自旋+入队等待被唤醒</span></span><br><span class="line">                <span class="keyword">return</span> root.internalAwaitAdvance(phase, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (root != <span class="keyword">this</span>)</span><br><span class="line">                <span class="comment">//最后一个到达</span></span><br><span class="line">                <span class="keyword">return</span> parent.arriveAndAwaitAdvance();</span><br><span class="line">            <span class="comment">//n保留了state的中16位：parties</span></span><br><span class="line">            <span class="keyword">long</span> n = s &amp; PARTIES_MASK;</span><br><span class="line">            <span class="comment">//执行onAdvance</span></span><br><span class="line">            <span class="comment">//返回true:表示结束</span></span><br><span class="line">            <span class="keyword">int</span> nextUnarrived = (<span class="keyword">int</span>)n &gt;&gt;&gt; PARTIES_SHIFT;</span><br><span class="line">            <span class="keyword">if</span> (onAdvance(phase, nextUnarrived))</span><br><span class="line">                n |= TERMINATION_BIT;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (nextUnarrived == <span class="number">0</span>)</span><br><span class="line">                n |= EMPTY;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">//n加上unarrived的值</span></span><br><span class="line">                n |= nextUnarrived;</span><br><span class="line">            <span class="comment">//下一阶段phase == 当前阶段+1</span></span><br><span class="line">            <span class="keyword">int</span> nextPhase = (phase + <span class="number">1</span>) &amp; MAX_PHASE;</span><br><span class="line">            n |= (<span class="keyword">long</span>)nextPhase &lt;&lt; PHASE_SHIFT;</span><br><span class="line">            <span class="comment">//CAS修改state</span></span><br><span class="line">            <span class="keyword">if</span> (!UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, stateOffset, s, n))</span><br><span class="line">                <span class="keyword">return</span> (<span class="keyword">int</span>)(state &gt;&gt;&gt; PHASE_SHIFT);</span><br><span class="line">            <span class="comment">//唤醒其他的参与者进入下一个阶段</span></span><br><span class="line">            releaseWaiters(phase);</span><br><span class="line">            <span class="comment">//返回下一个阶段的phase值</span></span><br><span class="line">            <span class="keyword">return</span> nextPhase;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="awaitAdvance-1"><a href="#awaitAdvance-1" class="headerlink" title="awaitAdvance"></a>awaitAdvance</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">awaitAdvance</span><span class="params">(<span class="keyword">int</span> phase)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取当前的root</span></span><br><span class="line">    <span class="keyword">final</span> Phaser root = <span class="keyword">this</span>.root;</span><br><span class="line">    <span class="comment">//获取state</span></span><br><span class="line">    <span class="keyword">long</span> s = (root == <span class="keyword">this</span>) ? state : reconcileState();</span><br><span class="line">    <span class="comment">//检测传入的phase和当前的phase是否一致</span></span><br><span class="line">    <span class="keyword">int</span> p = (<span class="keyword">int</span>)(s &gt;&gt;&gt; PHASE_SHIFT);</span><br><span class="line">    <span class="keyword">if</span> (phase &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> phase;</span><br><span class="line">    <span class="keyword">if</span> (p == phase)</span><br><span class="line">        <span class="keyword">return</span> root.internalAwaitAdvance(phase, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="awaitAdvanceInterruptibly-1"><a href="#awaitAdvanceInterruptibly-1" class="headerlink" title="awaitAdvanceInterruptibly"></a>awaitAdvanceInterruptibly</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//增加中断异常</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">awaitAdvanceInterruptibly</span><span class="params">(<span class="keyword">int</span> phase)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Phaser root = <span class="keyword">this</span>.root;</span><br><span class="line">    <span class="keyword">long</span> s = (root == <span class="keyword">this</span>) ? state : reconcileState();</span><br><span class="line">    <span class="keyword">int</span> p = (<span class="keyword">int</span>)(s &gt;&gt;&gt; PHASE_SHIFT);</span><br><span class="line">    <span class="keyword">if</span> (phase &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> phase;</span><br><span class="line">    <span class="keyword">if</span> (p == phase) &#123;</span><br><span class="line">        <span class="comment">//使用QNode实现了中断异常</span></span><br><span class="line">        QNode node = <span class="keyword">new</span> QNode(<span class="keyword">this</span>, phase, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="number">0L</span>);</span><br><span class="line">        p = root.internalAwaitAdvance(phase, node);</span><br><span class="line">        <span class="comment">//针对中断的情况抛出中断异常</span></span><br><span class="line">        <span class="keyword">if</span> (node.wasInterrupted)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">awaitAdvanceInterruptibly</span><span class="params">(<span class="keyword">int</span> phase,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException, TimeoutException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">    <span class="keyword">final</span> Phaser root = <span class="keyword">this</span>.root;</span><br><span class="line">    <span class="keyword">long</span> s = (root == <span class="keyword">this</span>) ? state : reconcileState();</span><br><span class="line">    <span class="keyword">int</span> p = (<span class="keyword">int</span>)(s &gt;&gt;&gt; PHASE_SHIFT);</span><br><span class="line">    <span class="keyword">if</span> (phase &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> phase;</span><br><span class="line">    <span class="keyword">if</span> (p == phase) &#123;</span><br><span class="line">        <span class="comment">//通过QNode实现了线程的中断、以及超时机制</span></span><br><span class="line">        QNode node = <span class="keyword">new</span> QNode(<span class="keyword">this</span>, phase, <span class="keyword">true</span>, <span class="keyword">true</span>, nanos);</span><br><span class="line">        p = root.internalAwaitAdvance(phase, node);</span><br><span class="line">        <span class="comment">//线程中断抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (node.wasInterrupted)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        <span class="comment">//执行超时抛出异常</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == phase)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="internalAwaitAdvance-1"><a href="#internalAwaitAdvance-1" class="headerlink" title="internalAwaitAdvance"></a>internalAwaitAdvance</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">internalAwaitAdvance</span><span class="params">(<span class="keyword">int</span> phase, QNode node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 释放上一个phase的资源</span></span><br><span class="line">    releaseWaiters(phase-<span class="number">1</span>);    </span><br><span class="line">    <span class="comment">//node是否被加入到了队列</span></span><br><span class="line">    <span class="keyword">boolean</span> queued = <span class="keyword">false</span>;   </span><br><span class="line">    <span class="comment">//记录前一个unarrived、用于增加spin</span></span><br><span class="line">    <span class="keyword">int</span> lastUnarrived = <span class="number">0</span>;            </span><br><span class="line">    <span class="keyword">int</span> spins = SPINS_PER_ARRIVAL;</span><br><span class="line">    <span class="keyword">long</span> s;</span><br><span class="line">    <span class="keyword">int</span> p;</span><br><span class="line">    <span class="comment">//进入循环操作、直到phase值发生变化</span></span><br><span class="line">    <span class="keyword">while</span> ((p = (<span class="keyword">int</span>)((s = state) &gt;&gt;&gt; PHASE_SHIFT)) == phase) &#123;</span><br><span class="line">        <span class="comment">//采用自旋、不可中断</span></span><br><span class="line">        <span class="keyword">if</span> (node == <span class="keyword">null</span>) &#123;           </span><br><span class="line">            <span class="keyword">int</span> unarrived = (<span class="keyword">int</span>)s &amp; UNARRIVED_MASK;</span><br><span class="line">            <span class="keyword">if</span> (unarrived != lastUnarrived &amp;&amp;</span><br><span class="line">                (lastUnarrived = unarrived) &lt; NCPU)</span><br><span class="line">                spins += SPINS_PER_ARRIVAL;</span><br><span class="line">            <span class="keyword">boolean</span> interrupted = Thread.interrupted();</span><br><span class="line">            <span class="comment">//出现了中断、QNode记录中断</span></span><br><span class="line">            <span class="keyword">if</span> (interrupted || --spins &lt; <span class="number">0</span>) &#123; </span><br><span class="line">                node = <span class="keyword">new</span> QNode(<span class="keyword">this</span>, phase, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="number">0L</span>);</span><br><span class="line">                node.wasInterrupted = interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//当前线程的node可以结束等待、退出循环</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node.isReleasable())</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!queued) &#123;   </span><br><span class="line">            <span class="comment">//node加入队列</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//根据phase选用不同的队列</span></span><br><span class="line">            AtomicReference&lt;QNode&gt; head = (phase &amp; <span class="number">1</span>) == <span class="number">0</span> ? evenQ : oddQ;</span><br><span class="line">            QNode q = node.next = head.get();</span><br><span class="line">            <span class="comment">//符合条件加入队列</span></span><br><span class="line">            <span class="keyword">if</span> ((q == <span class="keyword">null</span> || q.phase == phase) &amp;&amp;</span><br><span class="line">                (<span class="keyword">int</span>)(state &gt;&gt;&gt; PHASE_SHIFT) == phase) <span class="comment">// avoid stale enq</span></span><br><span class="line">                queued = head.compareAndSet(q, node);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//node如果已经加入了队列那么直接等待</span></span><br><span class="line">            <span class="comment">//这个主要是直到isReleasable返回true或者block方法返回true</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ForkJoinPool.managedBlock(node);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                node.wasInterrupted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重置入队的node属性</span></span><br><span class="line">    <span class="keyword">if</span> (node != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//释放Thread</span></span><br><span class="line">        <span class="keyword">if</span> (node.thread != <span class="keyword">null</span>)</span><br><span class="line">            node.thread = <span class="keyword">null</span>;  </span><br><span class="line">        <span class="comment">//不可中断模式下发生的中断，清除中断状态</span></span><br><span class="line">        <span class="keyword">if</span> (node.wasInterrupted &amp;&amp; !node.interruptible)</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        <span class="comment">//phase任然没有发生变化：同步过程已经终止</span></span><br><span class="line">        <span class="keyword">if</span> (p == phase &amp;&amp; (p = (<span class="keyword">int</span>)(state &gt;&gt;&gt; PHASE_SHIFT)) == phase)</span><br><span class="line">            <span class="keyword">return</span> abortWait(phase); <span class="comment">// possibly clean up on abort</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//通知所有等待的线程</span></span><br><span class="line">    releaseWaiters(phase);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="releaseWaiters"><a href="#releaseWaiters" class="headerlink" title="releaseWaiters"></a>releaseWaiters</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">releaseWaiters</span><span class="params">(<span class="keyword">int</span> phase)</span> </span>&#123;</span><br><span class="line">    QNode q; </span><br><span class="line">    Thread t; </span><br><span class="line">    AtomicReference&lt;QNode&gt; head = (phase &amp; <span class="number">1</span>) == <span class="number">0</span> ? evenQ : oddQ;</span><br><span class="line">    <span class="comment">//知道phase发生变化、才能释放</span></span><br><span class="line">    <span class="keyword">while</span> ((q = head.get()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">           q.phase != (<span class="keyword">int</span>)(root.state &gt;&gt;&gt; PHASE_SHIFT)) &#123;</span><br><span class="line">        <span class="comment">//释放节点并转到下一个节点</span></span><br><span class="line">        <span class="keyword">if</span> (head.compareAndSet(q, q.next) &amp;&amp;</span><br><span class="line">            (t = q.thread) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//释放线程</span></span><br><span class="line">            q.thread = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//唤醒等待的线程</span></span><br><span class="line">            LockSupport.unpark(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="QNode-isReleasable"><a href="#QNode-isReleasable" class="headerlink" title="QNode.isReleasable"></a>QNode.isReleasable</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//表示等待可以结束</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReleasable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//没有等待线程</span></span><br><span class="line">    <span class="keyword">if</span> (thread == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//phase发生变化、结束</span></span><br><span class="line">    <span class="keyword">if</span> (phaser.getPhase() != phase) &#123;</span><br><span class="line">        thread = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//线程中断</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        wasInterrupted = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//可中断模式发生中断、结束</span></span><br><span class="line">    <span class="keyword">if</span> (wasInterrupted &amp;&amp; interruptible) &#123;</span><br><span class="line">        thread = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//超时判断、结束</span></span><br><span class="line">    <span class="keyword">if</span> (timed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nanos &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">            nanos = deadline - System.nanoTime();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">            thread = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="QNode-block"><a href="#QNode-block" class="headerlink" title="QNode.block"></a>QNode.block</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">block</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isReleasable())</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//没有设置超时</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!timed)</span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//设置了超时</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; <span class="number">0L</span>)</span><br><span class="line">        LockSupport.parkNanos(<span class="keyword">this</span>, nanos);</span><br><span class="line">    <span class="keyword">return</span> isReleasable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-52-ForkJoin详解</title>
      <link href="/2020/07/19/47803/hub/"/>
      <url>/2020/07/19/47803/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200719101018337.png" alt="image-20200719101018337"></p><p><img src="/image/hexo/image-20200719102418252.png" alt="image-20200719102418252"></p><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="RecursiveTask"><a href="#RecursiveTask" class="headerlink" title="RecursiveTask"></a>RecursiveTask</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ForkJoinPool forkJoinPool = <span class="keyword">new</span> ForkJoinPool();</span><br><span class="line">    ForkJoinTask&lt;Integer&gt; futureTask = forkJoinPool.submit(<span class="keyword">new</span> CalculatedRecursiveTask(<span class="number">1</span>, <span class="number">10</span>));</span><br><span class="line">    System.out.println(futureTask.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Integer MAX_SIZE = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//RecursiveTask</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculatedRecursiveTask</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">java</span>.<span class="title">lang</span>.<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> start;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CalculatedRecursiveTask</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> java.lang.<span class="function">Integer <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (end - start &lt;= MAX_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span> IntStream.rangeClosed(start, end).sum();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> middle = (start + end) / <span class="number">2</span>;</span><br><span class="line">            CalculatedRecursiveTask left = <span class="keyword">new</span> CalculatedRecursiveTask(start, middle);</span><br><span class="line">            CalculatedRecursiveTask right = <span class="keyword">new</span> CalculatedRecursiveTask(middle + <span class="number">1</span>, end);</span><br><span class="line">            left.fork();</span><br><span class="line">            right.fork();</span><br><span class="line">            <span class="keyword">return</span> left.join() + right.join();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="RecursiveAction"><a href="#RecursiveAction" class="headerlink" title="RecursiveAction"></a>RecursiveAction</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger sum = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ForkJoinPool forkJoinPool = <span class="keyword">new</span> ForkJoinPool();</span><br><span class="line">    forkJoinPool.submit(<span class="keyword">new</span> CalculatedRecursiveTask(<span class="number">1</span>, <span class="number">100</span>));</span><br><span class="line">    forkJoinPool.awaitQuiescence(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    System.out.println(sum.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Integer MAX_SIZE = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//RecursiveAction</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculatedRecursiveTask</span> <span class="keyword">extends</span> <span class="title">RecursiveAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> start;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CalculatedRecursiveTask</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.start = start;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (end - start &lt;= MAX_SIZE) &#123;</span><br><span class="line">            sum.getAndAdd(IntStream.rangeClosed(start, end).sum());</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> middle = (start + end) / <span class="number">2</span>;</span><br><span class="line">            CalculatedRecursiveTask left = <span class="keyword">new</span> CalculatedRecursiveTask(start, middle);</span><br><span class="line">            CalculatedRecursiveTask right = <span class="keyword">new</span> CalculatedRecursiveTask(middle + <span class="number">1</span>, end);</span><br><span class="line">            left.fork();</span><br><span class="line">            right.fork();</span><br><span class="line">            left.join();</span><br><span class="line">            right.join();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>&emsp;&emsp;<strong>ForkJoin</strong>的理念可以使用<strong>分而治之</strong>来理解。把一个比较难处理的任务细化为多个任务，若是还不能解决那么可以再进行细化，最终将各个分支把处理的结果进行合并。</p><p>&emsp;&emsp;这个理念其实是比较常规的，大家都能很容易的想到，并且能够熟练的运用。但是它还运用了<strong>work-stealing</strong>算法(工作窃取)，该算法主要是把分解以后的多个任务放入了多个双端队列，那么工作线程可以从头部或者尾部获取任务。如果某个线程的任务执行完毕，那么它可以从其他线程中获取没有执行完毕的任务（从尾部获取），这样充分的利用线程的空余时间。</p><p><img src="/image/hexo/image-20200719205547339.png" alt="image-20200719205547339"></p><h3 id="主要的角色"><a href="#主要的角色" class="headerlink" title="主要的角色"></a>主要的角色</h3><p><strong>ForkJoinPool</strong>:</p><p>&emsp;&emsp;<strong>ForkJoin</strong>的管理者，任务都需要提交给它去处理，负责了整个<strong>workerThread</strong>的创建以及激活等操作、<strong>workQueue</strong>的创建以及分配等操作，它相当于整个<strong>ForkJoin</strong>的容器。</p><h3 id="ForkJoinWorkerThread"><a href="#ForkJoinWorkerThread" class="headerlink" title="ForkJoinWorkerThread:"></a>ForkJoinWorkerThread:</h3><p>&emsp;&emsp;工作线程，处理任务的线程。内部有一个<strong>ForkJoinPool.WorkQueue</strong>的任务队列，<strong>WorkQueue</strong>依赖与<strong>ForkJoinPool</strong>。</p><h3 id="ForkJoinPool-WorkQueue"><a href="#ForkJoinPool-WorkQueue" class="headerlink" title="ForkJoinPool.WorkQueue:"></a>ForkJoinPool.WorkQueue:</h3><p>&emsp;&emsp;双端任务队列，主要存储了当前线程需要执行的任务，<code>工作窃取</code>就是通过尾部获取未执行的任务。</p><h3 id="ForkJoinTask："><a href="#ForkJoinTask：" class="headerlink" title="ForkJoinTask："></a>ForkJoinTask：</h3><p>&emsp;&emsp;任务类型(<strong>RecursiveTask、RecursiveAction</strong>),<code>RecursiveTask</code>：主要是有返回值。<code>RecursiveAction</code>:不具备返回值。<code>fork</code>用于分解任务并异步执行，<code>join</code>用于处理任务执行完毕执行结果的合并。</p><h2 id="ForkJoinTask详解"><a href="#ForkJoinTask详解" class="headerlink" title="ForkJoinTask详解"></a>ForkJoinTask详解</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinTask</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt;, <span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure><h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//任务状态值、通过ForkJoinPool或者工作线程去修改</span></span><br><span class="line"><span class="comment">//volatile保证内存可见性</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> status;</span><br><span class="line"><span class="comment">//用于屏蔽完成状态位</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DONE_MASK   = <span class="number">0xf0000000</span>;</span><br><span class="line"><span class="comment">//表示正常完成（负值）</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NORMAL      = <span class="number">0xf0000000</span>;</span><br><span class="line"><span class="comment">//表示被取消(负值且&lt; NORMAL)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED   = <span class="number">0xc0000000</span>;</span><br><span class="line"><span class="comment">//异常完成(负值且&lt;CANCELLED)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXCEPTIONAL = <span class="number">0x80000000</span>;</span><br><span class="line"><span class="comment">//用于signal(1&lt;&lt;16)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL      = <span class="number">0x00010000</span>;</span><br><span class="line"><span class="comment">//后十六位的task标签</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SMASK       = <span class="number">0x0000ffff</span>;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200720074842646.png" alt="image-20200720074842646"></p><h3 id="常见方法"><a href="#常见方法" class="headerlink" title="常见方法"></a>常见方法</h3><h4 id="fork"><a href="#fork" class="headerlink" title="fork"></a>fork</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ForkJoinTask&lt;V&gt; <span class="title">fork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread t;</span><br><span class="line">    <span class="comment">//判断当前的线程是否是ForkJoinWorkerThread</span></span><br><span class="line">    <span class="keyword">if</span> ((t = Thread.currentThread()) <span class="keyword">instanceof</span> ForkJoinWorkerThread)</span><br><span class="line">        <span class="comment">//尝试将任务添加到workQueue中</span></span><br><span class="line">        ((ForkJoinWorkerThread)t).workQueue.push(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">//尝试将任务添加到common的线程池中</span></span><br><span class="line">        ForkJoinPool.common.externalPush(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="join"><a href="#join" class="headerlink" title="join"></a>join</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">join</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line">    <span class="comment">//doJoin会尝试获取任务执行的结果</span></span><br><span class="line">    <span class="keyword">if</span> ((s = doJoin() &amp; DONE_MASK) != NORMAL)</span><br><span class="line">        reportException(s);</span><br><span class="line">    <span class="keyword">return</span> getRawResult();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="doJoin"><a href="#doJoin" class="headerlink" title="doJoin"></a>doJoin</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doJoin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s; Thread t; ForkJoinWorkerThread wt; ForkJoinPool.WorkQueue w;</span><br><span class="line">    <span class="comment">//如果任务执行完毕返回status</span></span><br><span class="line">    <span class="keyword">return</span> (s = status) &lt; <span class="number">0</span> ? s :</span><br><span class="line">    <span class="comment">//判断当前是否是ForkJoinWorkerThread</span></span><br><span class="line">        ((t = Thread.currentThread()) <span class="keyword">instanceof</span> ForkJoinWorkerThread) ?</span><br><span class="line">        (w = (wt = (ForkJoinWorkerThread)t).workQueue).</span><br><span class="line">        <span class="comment">//尝试从任务队列取出this、并且执行恩物    </span></span><br><span class="line">        tryUnpush(<span class="keyword">this</span>) &amp;&amp; (s = doExec()) &lt; <span class="number">0</span> ? s :</span><br><span class="line">    <span class="comment">//等待任务执行结束、会尝试帮助其他的线程完成任务</span></span><br><span class="line">        wt.pool.awaitJoin(w, <span class="keyword">this</span>, <span class="number">0L</span>) :</span><br><span class="line">        externalAwaitDone();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="setCompletion"><a href="#setCompletion" class="headerlink" title="setCompletion"></a>setCompletion</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要用于标记当前task的completion状态</span></span><br><span class="line"><span class="comment">//满足条件则唤醒等待该task的线程</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">setCompletion</span><span class="params">(<span class="keyword">int</span> completion)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> s;;) &#123;</span><br><span class="line">        <span class="comment">//如果当前task的status已经完成(&lt;0)，返回status</span></span><br><span class="line">        <span class="comment">//status可能是某一次循环被其他线程操作完全</span></span><br><span class="line">        <span class="keyword">if</span> ((s = status) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        <span class="comment">//CAS:尝试将原来的status设置为它与completion位或的结果</span></span><br><span class="line">        <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, STATUS, s, s | completion)) &#123;</span><br><span class="line">            <span class="comment">//SIGNAL标记</span></span><br><span class="line">            <span class="comment">//task只要完成(发生异常或取消)，或者completion传入的值1&lt;&lt;16</span></span><br><span class="line">            <span class="comment">//唤醒其他的线程</span></span><br><span class="line">            <span class="keyword">if</span> ((s &gt;&gt;&gt; <span class="number">16</span>) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123; notifyAll(); &#125;</span><br><span class="line">            <span class="comment">//CAS成功、返回参数中的completion</span></span><br><span class="line">            <span class="keyword">return</span> completion;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="doExec"><a href="#doExec" class="headerlink" title="doExec"></a>doExec</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//运行ForkJoinTask的核心</span></span><br><span class="line"><span class="comment">//使用final修饰</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">doExec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s; <span class="keyword">boolean</span> completed;</span><br><span class="line">    <span class="comment">//如果任务未完成则会继续运行</span></span><br><span class="line">    <span class="keyword">if</span> ((s = status) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//exec</span></span><br><span class="line">            completed = exec();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable rex) &#123;</span><br><span class="line">            <span class="comment">//发生异常情况、setExceptionalCompletion设置结果</span></span><br><span class="line">            <span class="keyword">return</span> setExceptionalCompletion(rex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (completed)</span><br><span class="line">            <span class="comment">//正常完成、调用setCompletio将返回s</span></span><br><span class="line">            s = setCompletion(NORMAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="setExceptionalCompletion"><a href="#setExceptionalCompletion" class="headerlink" title="setExceptionalCompletion"></a>setExceptionalCompletion</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要用于记录异常并且在满足条件的情形下传播异常</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">setExceptionalCompletion</span><span class="params">(Throwable ex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//记录异常信息到结果</span></span><br><span class="line">    <span class="keyword">int</span> s = recordExceptionalCompletion(ex);</span><br><span class="line">    <span class="keyword">if</span> ((s &amp; DONE_MASK) == EXCEPTIONAL)</span><br><span class="line">        <span class="comment">//status去除非完成标志位 == EXCEPTIONAL</span></span><br><span class="line">        <span class="comment">//内部传播异常</span></span><br><span class="line">        <span class="comment">//internalPropagateException空的方法，需要子类去实现</span></span><br><span class="line">        internalPropagateException(ex);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="reportException"><a href="#reportException" class="headerlink" title="reportException"></a>reportException</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//任务执行期间抛出未捕获的异常或者被取消</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reportException</span><span class="params">(<span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s == CANCELLED)</span><br><span class="line">        <span class="comment">//任务取消抛出CancellationException</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CancellationException();</span><br><span class="line">    <span class="keyword">if</span> (s == EXCEPTIONAL)</span><br><span class="line">        <span class="comment">//未捕获异常则通过rethrow包装为RunTimeException</span></span><br><span class="line">        rethrow(getThrowableException());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="getThrowableException"><a href="#getThrowableException" class="headerlink" title="getThrowableException"></a>getThrowableException</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取给定任务的执行异常</span></span><br><span class="line"><span class="comment">//如果异常不是当前的线程抛出</span></span><br><span class="line"><span class="comment">//尝试以记录的异常为原因创建一个与抛出异常类型相同的新的异常</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Throwable <span class="title">getThrowableException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((status &amp; DONE_MASK) != EXCEPTIONAL)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//通过当前任务对象的哈希值从哈希链表中找到对应的异常节点</span></span><br><span class="line">    <span class="keyword">int</span> h = System.identityHashCode(<span class="keyword">this</span>);</span><br><span class="line">    ExceptionNode e;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = exceptionTableLock;</span><br><span class="line">    <span class="comment">//加锁操作</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//清理被GC回收的任务的异常节点</span></span><br><span class="line">        expungeStaleExceptions();</span><br><span class="line">        ExceptionNode[] t = exceptionTable;</span><br><span class="line">      <span class="comment">//取模运算获取对应的索引进而获取哈希数组槽位中的节点</span></span><br><span class="line">        e = t[h &amp; (t.length - <span class="number">1</span>)];</span><br><span class="line">      <span class="comment">//遍历找到当前任务对应的异常节点</span></span><br><span class="line">        <span class="keyword">while</span> (e != <span class="keyword">null</span> &amp;&amp; e.get() != <span class="keyword">this</span>)</span><br><span class="line">            e = e.next;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//解锁</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    Throwable ex;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span> || (ex = e.ex) == <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">//没有出现任何的异常、退出</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//存在异常、当不是当前线程所抛出</span></span><br><span class="line">    <span class="keyword">if</span> (e.thrower != Thread.currentThread().getId()) &#123;</span><br><span class="line">        <span class="comment">//反射找到构造方法、并且开始构造一个新的异常</span></span><br><span class="line">        Class&lt;? extends Throwable&gt; ec = ex.getClass();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Constructor&lt;?&gt; noArgCtor = <span class="keyword">null</span>;</span><br><span class="line">            Constructor&lt;?&gt;[] cs = ec.getConstructors();<span class="comment">// public ctors only</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cs.length; ++i) &#123;</span><br><span class="line">                Constructor&lt;?&gt; c = cs[i];</span><br><span class="line">                Class&lt;?&gt;[] ps = c.getParameterTypes();</span><br><span class="line">                <span class="keyword">if</span> (ps.length == <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//标记无参构造方法、在没有找到期望的构造方法的时候去使用</span></span><br><span class="line">                    noArgCtor = c;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ps.length == <span class="number">1</span> &amp;&amp; ps[<span class="number">0</span>] == Throwable<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                    <span class="comment">//发现了期望的Throwable类型的参数的构造方法</span></span><br><span class="line">                    Throwable wx = (Throwable)c.newInstance(ex);</span><br><span class="line">                    <span class="keyword">return</span> (wx == <span class="keyword">null</span>) ? ex : wx;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//没有找到期望的构造方法</span></span><br><span class="line">            <span class="keyword">if</span> (noArgCtor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//通过无参构造的方法进行构建一个新的异常</span></span><br><span class="line">                Throwable wx = (Throwable)(noArgCtor.newInstance());</span><br><span class="line">                <span class="keyword">if</span> (wx != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//设置原始的异常信息</span></span><br><span class="line">                    wx.initCause(ex);</span><br><span class="line">                    <span class="keyword">return</span> wx;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="recordExceptionalCompletion"><a href="#recordExceptionalCompletion" class="headerlink" title="recordExceptionalCompletion"></a>recordExceptionalCompletion</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//记录异常</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">recordExceptionalCompletion</span><span class="params">(Throwable ex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line">    <span class="keyword">if</span> ((s = status) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//判断是否是异常的状态status</span></span><br><span class="line">        <span class="comment">//禁止重写hash值，不适用子类的hashCode函数</span></span><br><span class="line">        <span class="keyword">int</span> h = System.identityHashCode(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock lock = exceptionTableLock;</span><br><span class="line">        <span class="comment">//获取异常锁</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//抹除脏异常数据</span></span><br><span class="line">            expungeStaleExceptions();</span><br><span class="line">            <span class="comment">//异常表数组，exceptionTable全局静态变量</span></span><br><span class="line">            ExceptionNode[] t = exceptionTable;</span><br><span class="line">            <span class="comment">//通过hash值和数组长度进行一个运算获取一个初始的索引</span></span><br><span class="line">            <span class="keyword">int</span> i = h &amp; (t.length - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">for</span> (ExceptionNode e = t[i]; ; e = e.next) &#123;</span><br><span class="line">                <span class="comment">//找到空的索引位</span></span><br><span class="line">                <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//创建一个新的ExceptionNode、保存this</span></span><br><span class="line">                    <span class="comment">//退出循环</span></span><br><span class="line">                    t[i] = <span class="keyword">new</span> ExceptionNode(<span class="keyword">this</span>, ex, t[i]);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//如果已经设置了相同的元素在索引中、退出循环</span></span><br><span class="line">                <span class="keyword">if</span> (e.get() == <span class="keyword">this</span>) </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//记录成功、更新task为异常完成</span></span><br><span class="line">        s = setCompletion(EXCEPTIONAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="exceptionTable相关"><a href="#exceptionTable相关" class="headerlink" title="exceptionTable相关"></a>exceptionTable相关</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//全局异常Node表</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ExceptionNode[] exceptionTable;</span><br><span class="line"><span class="comment">//异常可重入锁</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantLock exceptionTableLock;</span><br><span class="line"><span class="comment">//变量表引用队列</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; exceptionTableRefQueue;</span><br><span class="line"><span class="comment">//异常表的固定容量32</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXCEPTION_MAP_CAPACITY = <span class="number">32</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化操作</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    exceptionTableLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    exceptionTableRefQueue = <span class="keyword">new</span> ReferenceQueue&lt;Object&gt;();</span><br><span class="line">    exceptionTable = <span class="keyword">new</span> ExceptionNode[EXCEPTION_MAP_CAPACITY];</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">        Class&lt;?&gt; k = ForkJoinTask<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        STATUS = U.objectFieldOffset</span><br><span class="line">            (k.getDeclaredField(<span class="string">"status"</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ExceptionNode"><a href="#ExceptionNode" class="headerlink" title="ExceptionNode"></a>ExceptionNode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ExceptionNode实现了一个弱引用</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionNode</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ForkJoinTask</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Throwable ex;</span><br><span class="line">    ExceptionNode next;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> thrower;  <span class="comment">// use id not ref to avoid weak cycles</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hashCode;  <span class="comment">// store task hashCode before weak ref disappears</span></span><br><span class="line">    ExceptionNode(ForkJoinTask&lt;?&gt; task, Throwable ex, ExceptionNode next) &#123;</span><br><span class="line">        <span class="comment">//指向弱引用的构造函数</span></span><br><span class="line">        <span class="comment">//保存引用为task</span></span><br><span class="line">        <span class="comment">//全局队列</span></span><br><span class="line">        <span class="keyword">super</span>(task, exceptionTableRefQueue);</span><br><span class="line">        <span class="comment">//抛出异常的引用</span></span><br><span class="line">        <span class="keyword">this</span>.ex = ex;</span><br><span class="line">        <span class="comment">//ExceptionNode以链表的方式存在</span></span><br><span class="line">        <span class="comment">//先入者为后入者的</span></span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">        <span class="comment">//保存抛出异常的线程ID</span></span><br><span class="line">        <span class="keyword">this</span>.thrower = Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//hash码保存关联的task的哈希值</span></span><br><span class="line">        <span class="keyword">this</span>.hashCode = System.identityHashCode(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="expungeStaleExceptions"><a href="#expungeStaleExceptions" class="headerlink" title="expungeStaleExceptions"></a>expungeStaleExceptions</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//清除异常表中的脏数据</span></span><br><span class="line"><span class="comment">//持有全局锁才可使用</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expungeStaleExceptions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//进入转换</span></span><br><span class="line">    <span class="comment">//exceptionTableRefQueue不为空，且</span></span><br><span class="line">    <span class="keyword">for</span> (Object x; (x = exceptionTableRefQueue.poll()) != <span class="keyword">null</span>;) &#123;</span><br><span class="line">        <span class="comment">//依次获取元素</span></span><br><span class="line">        <span class="keyword">if</span> (x <span class="keyword">instanceof</span> ExceptionNode) &#123;</span><br><span class="line">            <span class="comment">//计算在exceptionTable中的索引</span></span><br><span class="line">            <span class="keyword">int</span> hashCode = ((ExceptionNode)x).hashCode;</span><br><span class="line">            ExceptionNode[] t = exceptionTable;</span><br><span class="line">            <span class="keyword">int</span> i = hashCode &amp; (t.length - <span class="number">1</span>);</span><br><span class="line">            <span class="comment">//取出Node</span></span><br><span class="line">            ExceptionNode e = t[i];</span><br><span class="line">            ExceptionNode pred = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//进入循环、直到e为null就停止</span></span><br><span class="line">            <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ExceptionNode next = e.next;</span><br><span class="line">                <span class="comment">//x:队首出对的元素</span></span><br><span class="line">                <span class="keyword">if</span> (e == x) &#123;</span><br><span class="line">                    <span class="comment">//pred:没有前置元素，e排在链表的首位</span></span><br><span class="line">                    <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="comment">//没有前置元素、直接修改引用指向了next</span></span><br><span class="line">                        t[i] = next;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="comment">//存在了前置的元素、说明循环过N次、跳出循环</span></span><br><span class="line">                        pred.next = next;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//如果当前e不是x，准备开启下一轮循环、pred指向了e，进行下一个元素的比窘</span></span><br><span class="line">                pred = e;</span><br><span class="line">                e = next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="externalAwaitDone"><a href="#externalAwaitDone" class="headerlink" title="externalAwaitDone"></a>externalAwaitDone</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//等待未完成的非ForkJoinWorkerThread线程提交的任务</span></span><br><span class="line"><span class="comment">//返回任务执行的结果</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">externalAwaitDone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.如果是CountedCompleter任务、等待externalHelpComplete返回</span></span><br><span class="line">    <span class="comment">//2.否则ForkJoinPool.common.tryExternalUnpush(this)返回doExec结果</span></span><br><span class="line">    <span class="comment">//3.否则返回0</span></span><br><span class="line">    <span class="keyword">int</span> s = ((<span class="keyword">this</span> <span class="keyword">instanceof</span> CountedCompleter) ? <span class="comment">// try helping</span></span><br><span class="line">             ForkJoinPool.common.externalHelpComplete(</span><br><span class="line">                 <span class="comment">//辅助完成外部提交的externalHelpComplete任务</span></span><br><span class="line">                 (CountedCompleter&lt;?&gt;)<span class="keyword">this</span>, <span class="number">0</span>) :</span><br><span class="line">             <span class="comment">//辅助完成外部提交的非externalHelpComplete任务</span></span><br><span class="line">             ForkJoinPool.common.tryExternalUnpush(<span class="keyword">this</span>) ? doExec() : <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//任务还未执行完毕、阻塞等待</span></span><br><span class="line">    <span class="keyword">if</span> (s &gt;= <span class="number">0</span> &amp;&amp; (s = status) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">//标记有线程需要被唤醒</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, STATUS, s, s | SIGNAL)) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (status &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">//任务未执行完毕、陷入阻塞等待被唤醒</span></span><br><span class="line">                            wait(<span class="number">0L</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                            interrupted = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="comment">//任务执行完毕、唤醒所有陷入阻塞的线程</span></span><br><span class="line">                        notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> ((s = status) &gt;= <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (interrupted)</span><br><span class="line">            <span class="comment">//中断线程</span></span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取异步任务的执行结果</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">    <span class="comment">//如果是ForkJoinWorkerThread则执行doJoin否则externalInterruptibleAwaitDone</span></span><br><span class="line">    <span class="keyword">int</span> s = (Thread.currentThread() <span class="keyword">instanceof</span> ForkJoinWorkerThread) ?</span><br><span class="line">        doJoin() : externalInterruptibleAwaitDone();</span><br><span class="line">    Throwable ex;</span><br><span class="line">    <span class="keyword">if</span> ((s &amp;= DONE_MASK) == CANCELLED)</span><br><span class="line">        <span class="comment">//如果任务被取消抛出CancellationException</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CancellationException();</span><br><span class="line">    <span class="keyword">if</span> (s == EXCEPTIONAL &amp;&amp; (ex = getThrowableException()) != <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">//任务执行过程中出现异常则抛出对应的异常信息</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(ex);</span><br><span class="line">    <span class="keyword">return</span> getRawResult();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="externalInterruptibleAwaitDone"><a href="#externalInterruptibleAwaitDone" class="headerlink" title="externalInterruptibleAwaitDone"></a>externalInterruptibleAwaitDone</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//阻塞非ForkJoinWorkerThread线程</span></span><br><span class="line"><span class="comment">//等待任务执行完毕或中断线程</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">externalInterruptibleAwaitDone</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="keyword">if</span> ((s = status) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (s = ((<span class="keyword">this</span> <span class="keyword">instanceof</span> CountedCompleter) ?</span><br><span class="line">              ForkJoinPool.common.externalHelpComplete(</span><br><span class="line">                  (CountedCompleter&lt;?&gt;)<span class="keyword">this</span>, <span class="number">0</span>) :</span><br><span class="line">              ForkJoinPool.common.tryExternalUnpush(<span class="keyword">this</span>) ? doExec() :</span><br><span class="line">              <span class="number">0</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//任务需要阻塞陷入等待</span></span><br><span class="line">        <span class="keyword">while</span> ((s = status) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, STATUS, s, s | SIGNAL)) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (status &gt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="comment">//陷入阻塞等待</span></span><br><span class="line">                        wait(<span class="number">0L</span>);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="comment">//唤醒等待中的所有的线程</span></span><br><span class="line">                        notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="invoke"><a href="#invoke" class="headerlink" title="invoke"></a>invoke</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开始执行任务、等待执行并返回任务执行的结果</span></span><br><span class="line"><span class="comment">//出现异常、则抛出对应的未捕获的异常</span></span><br><span class="line"><span class="comment">//如果中断了线程并不会立即返回、而是等待任务执行有了结果才会对中断状态进行补偿</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line">    <span class="keyword">if</span> ((s = doInvoke() &amp; DONE_MASK) != NORMAL)</span><br><span class="line">        reportException(s);</span><br><span class="line">    <span class="keyword">return</span> getRawResult();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="doInvoke"><a href="#doInvoke" class="headerlink" title="doInvoke"></a>doInvoke</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doInvoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s; Thread t; ForkJoinWorkerThread wt;</span><br><span class="line">    <span class="comment">//执行任务、执行完毕返回status</span></span><br><span class="line">    <span class="keyword">return</span> (s = doExec()) &lt; <span class="number">0</span> ? s :</span><br><span class="line">    <span class="comment">//如果当前线程是ForkJoinWorkerThread根据不同的任务类型执行不同的等待</span></span><br><span class="line">        ((t = Thread.currentThread()) <span class="keyword">instanceof</span> ForkJoinWorkerThread) ?</span><br><span class="line">        (wt = (ForkJoinWorkerThread)t).pool.</span><br><span class="line">        awaitJoin(wt.workQueue, <span class="keyword">this</span>, <span class="number">0L</span>) :</span><br><span class="line">        externalAwaitDone();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="invokeAll"><a href="#invokeAll" class="headerlink" title="invokeAll"></a>invokeAll</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行两个任务</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeAll</span><span class="params">(ForkJoinTask&lt;?&gt; t1, ForkJoinTask&lt;?&gt; t2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s1, s2;</span><br><span class="line">    <span class="comment">//t2任务交给线程池进行调度</span></span><br><span class="line">    t2.fork();</span><br><span class="line">    <span class="comment">//t1通过当前的线程执行</span></span><br><span class="line">    <span class="keyword">if</span> ((s1 = t1.doInvoke() &amp; DONE_MASK) != NORMAL)</span><br><span class="line">        t1.reportException(s1);</span><br><span class="line">    <span class="comment">//等待t2任务执行完毕</span></span><br><span class="line">    <span class="keyword">if</span> ((s2 = t2.doJoin() &amp; DONE_MASK) != NORMAL)</span><br><span class="line">        t2.reportException(s2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行任务数组</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeAll</span><span class="params">(ForkJoinTask&lt;?&gt;... tasks)</span> </span>&#123;</span><br><span class="line">    Throwable ex = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> last = tasks.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = last; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">        ForkJoinTask&lt;?&gt; t = tasks[i];</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//都不能为null</span></span><br><span class="line">            <span class="keyword">if</span> (ex == <span class="keyword">null</span>)</span><br><span class="line">                ex = <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (i != <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//除了第一个任务都交给线程池进行调度</span></span><br><span class="line">            t.fork();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//第一个任务由当先线程进行执行</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (t.doInvoke() &lt; NORMAL &amp;&amp; ex == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//记录第一个任务执行的异常</span></span><br><span class="line">            ex = t.getException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= last; ++i) &#123;</span><br><span class="line">        ForkJoinTask&lt;?&gt; t = tasks[i];</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//第一个任务异常结束、取消其他的任务</span></span><br><span class="line">            <span class="keyword">if</span> (ex != <span class="keyword">null</span>)</span><br><span class="line">                t.cancel(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (t.doJoin() &lt; NORMAL)</span><br><span class="line">                <span class="comment">//由任务异常结束、记录异常信息</span></span><br><span class="line">                ex = t.getException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ex != <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">//如果由任务异常结束、抛出数组最前面那么异常结束任务的异常</span></span><br><span class="line">        rethrow(ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//批量执行任务</span></span><br><span class="line"><span class="comment">//返回每个任务对应的ForkJoinTask</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends ForkJoinTask&lt;?&gt;&gt; <span class="function">Collection&lt;T&gt; <span class="title">invokeAll</span><span class="params">(Collection&lt;T&gt; tasks)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(tasks <span class="keyword">instanceof</span> RandomAccess) || !(tasks <span class="keyword">instanceof</span> List&lt;?&gt;)) &#123;</span><br><span class="line">        <span class="comment">//将任务封装成ForkJoinTask</span></span><br><span class="line">        invokeAll(tasks.toArray(<span class="keyword">new</span> ForkJoinTask&lt;?&gt;[tasks.size()]));</span><br><span class="line">        <span class="keyword">return</span> tasks;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    List&lt;? extends ForkJoinTask&lt;?&gt;&gt; ts =</span><br><span class="line">        (List&lt;? extends ForkJoinTask&lt;?&gt;&gt;) tasks;</span><br><span class="line">    Throwable ex = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> last = ts.size() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = last; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">        ForkJoinTask&lt;?&gt; t = ts.get(i);</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ex == <span class="keyword">null</span>)</span><br><span class="line">                ex = <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (i != <span class="number">0</span>)</span><br><span class="line">            t.fork();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (t.doInvoke() &lt; NORMAL &amp;&amp; ex == <span class="keyword">null</span>)</span><br><span class="line">            ex = t.getException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= last; ++i) &#123;</span><br><span class="line">        ForkJoinTask&lt;?&gt; t = ts.get(i);</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ex != <span class="keyword">null</span>)</span><br><span class="line">                t.cancel(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (t.doJoin() &lt; NORMAL)</span><br><span class="line">                ex = t.getException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ex != <span class="keyword">null</span>)</span><br><span class="line">        rethrow(ex);</span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;批量执行任务其实都是排在前面的任务由当前的线程去执行，其余的都交给了线程池去调度执行，如果有多个任务抛出了异常，只会抛出排在最前面的那个任务的异常。</p><h4 id="quietlyInvoke"><a href="#quietlyInvoke" class="headerlink" title="quietlyInvoke"></a>quietlyInvoke</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不需要执行结果的invoke</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">quietlyInvoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    doInvoke();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="quietlyJoin"><a href="#quietlyJoin" class="headerlink" title="quietlyJoin"></a>quietlyJoin</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不需要执行结果的join</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">quietlyJoin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    doJoin();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="cancel"><a href="#cancel" class="headerlink" title="cancel"></a>cancel</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要通过setCompletion标记尚未执行完毕的任务状态为CANCELLED</span></span><br><span class="line"><span class="comment">//尝试唤醒通过join等待此任务的线程</span></span><br><span class="line"><span class="comment">//已经执行完毕的任务无法取消</span></span><br><span class="line"><span class="comment">//mayInterruptIfRunning并没有使用，ForkJoinTask并不支持在取消任务时中断已经开始执行的任务</span></span><br><span class="line"><span class="comment">//当然该子类可以重写进行实现</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (setCompletion(CANCELLED) &amp; DONE_MASK) == CANCELLED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tryUnfork"><a href="#tryUnfork" class="headerlink" title="tryUnfork"></a>tryUnfork</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//取消fork将任务从任务队列中移除</span></span><br><span class="line"><span class="comment">//如果此任务时当前线程最近才刚刚通过fork方法调度、并且尚未在另一个线程中去执行、通常情况下会成功</span></span><br><span class="line"><span class="comment">//不保证所有的都会成功</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryUnfork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread t;</span><br><span class="line">    <span class="keyword">return</span> (((t = Thread.currentThread()) <span class="keyword">instanceof</span> ForkJoinWorkerThread) ?</span><br><span class="line">            <span class="comment">//针对ForkJoinWorkerThread的取消逻辑</span></span><br><span class="line">            ((ForkJoinWorkerThread)t).workQueue.tryUnpush(<span class="keyword">this</span>) :</span><br><span class="line">            <span class="comment">//针对非ForkJoinWorkerThread的取消逻辑</span></span><br><span class="line">            ForkJoinPool.common.tryExternalUnpush(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="reinitialize"><a href="#reinitialize" class="headerlink" title="reinitialize"></a>reinitialize</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重新初始化该任务</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reinitialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((status &amp; DONE_MASK) == EXCEPTIONAL)</span><br><span class="line">        <span class="comment">//存在异常从哈希链表数组中移除当前任务的异常节点</span></span><br><span class="line">        clearExceptionalCompletion();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">//重置status==0</span></span><br><span class="line">        status = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="helpQuiesce"><a href="#helpQuiesce" class="headerlink" title="helpQuiesce"></a>helpQuiesce</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果有一批任务被安排进行执行，但是不知道什么时候结束、希望在这些任务都执行完毕后再安排一个任务</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">helpQuiesce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread t;</span><br><span class="line">    <span class="comment">//根据执行线程的类型执行不同的执行逻辑</span></span><br><span class="line">    <span class="keyword">if</span> ((t = Thread.currentThread()) <span class="keyword">instanceof</span> ForkJoinWorkerThread) &#123;</span><br><span class="line">        ForkJoinWorkerThread wt = (ForkJoinWorkerThread)t;</span><br><span class="line">        wt.pool.helpQuiescePool(wt.workQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ForkJoinPool.quiesceCommonPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="getSurplusQueuedTaskCount"><a href="#getSurplusQueuedTaskCount" class="headerlink" title="getSurplusQueuedTaskCount"></a>getSurplusQueuedTaskCount</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取当前工作线程持有的任务数比其他可能窃取其任务的其他线程持有的任务数的一个估计值</span></span><br><span class="line"><span class="comment">//如果当前线程不是ForkJoinPool中则返回0</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSurplusQueuedTaskCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ForkJoinPool.getSurplusQueuedTaskCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="子类实现"><a href="#子类实现" class="headerlink" title="子类实现"></a>子类实现</h3><h4 id="RecursiveTask-1"><a href="#RecursiveTask-1" class="headerlink" title="RecursiveTask"></a>RecursiveTask</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//带有返回结果的Task,定义了一个表示执行结果的result字段</span></span><br><span class="line"><span class="comment">//compute抽象方法用于当ForkJoinTask被调度执行exec方法时调用</span></span><br><span class="line"><span class="comment">//compute也是进行任务的拆分的逻辑</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RecursiveTask</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">ForkJoinTask</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5232453952276485270L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The result of the computation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    V result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The main computation performed by this task.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of the computation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> V <span class="title">compute</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getRawResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setRawResult</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">        result = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Implements execution conventions for RecursiveTask.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">exec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        result = compute();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="RecursiveAction-1"><a href="#RecursiveAction-1" class="headerlink" title="RecursiveAction"></a>RecursiveAction</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//没有返回值</span></span><br><span class="line"><span class="comment">//getRawResult永远为null</span></span><br><span class="line"><span class="comment">//setRawResult什么都不操作</span></span><br><span class="line"><span class="comment">//compute进行任务拆分</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RecursiveAction</span> <span class="keyword">extends</span> <span class="title">ForkJoinTask</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5232453952276485070L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The main computation performed by this task.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Always returns &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> null&#125; always</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Void <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Requires null completion value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setRawResult</span><span class="params">(Void mustBeNull)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Implements execution conventions for RecursiveActions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">exec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        compute();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="CountedCompleter"><a href="#CountedCompleter" class="headerlink" title="CountedCompleter"></a>CountedCompleter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JDK8新增的CountedCompleter、操作完成后可以触发钩子函数、它是一个特殊的ForkJoinTask</span></span><br><span class="line"><span class="comment">//在触发完成动作时：检查有没有挂起的action、若没有则执行一个完成的动作</span></span><br><span class="line"><span class="comment">//可以支持返回结果或不返回结果、对方法进行重写</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CountedCompleter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ForkJoinTask</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5232453752276485070L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//一个链表结构、完成的触发顺序则是先进后出的模式(任务的完成者)</span></span><br><span class="line">    <span class="keyword">final</span> CountedCompleter&lt;?&gt; completer;</span><br><span class="line">    <span class="comment">//完成前挂起等待的任务数量</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> pending;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">CountedCompleter</span><span class="params">(CountedCompleter&lt;?&gt; completer,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">int</span> initialPendingCount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.completer = completer;</span><br><span class="line">        <span class="keyword">this</span>.pending = initialPendingCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">CountedCompleter</span><span class="params">(CountedCompleter&lt;?&gt; completer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.completer = completer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">CountedCompleter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.completer = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拆分逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用了无条件complete或者调用tryComplet如果等待的任务数==0，触发该方法</span></span><br><span class="line">    <span class="comment">//默认不做任何操作</span></span><br><span class="line">    <span class="comment">//该实现主要取决于要实现的操作，比如并行流中的ops会处理一些结果集的reduce操作</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(CountedCompleter&lt;?&gt; caller)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用completeexcepttion或者compute抛出异常时执行的操作、任务尚未执行完毕</span></span><br><span class="line">    <span class="comment">//默认返回true</span></span><br><span class="line">    <span class="comment">//异常完成的钩子函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onExceptionalCompletion</span><span class="params">(Throwable ex, CountedCompleter&lt;?&gt; caller)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//提供了扩展性、表示异常应该传递给this的completer</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回此任务的构造函数中建立的实例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> CountedCompleter&lt;?&gt; getCompleter() &#123;</span><br><span class="line">        <span class="keyword">return</span> completer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回当前挂起等待的任务数量</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getPendingCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pending;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置挂起等待的任务数量</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setPendingCount</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        pending = count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//原子性的将给定的值添加到挂起的计数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addToPendingCount</span><span class="params">(<span class="keyword">int</span> delta)</span> </span>&#123;</span><br><span class="line">        U.getAndAddInt(<span class="keyword">this</span>, PENDING, delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在当前持有的给定期望值、原子的挂起的计数设置为给定的计数expected修改到count</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSetPendingCount</span><span class="params">(<span class="keyword">int</span> expected, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> U.compareAndSwapInt(<span class="keyword">this</span>, PENDING, expected, count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前任务的挂起的任务数量原子减为0</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">decrementPendingCountUnlessZero</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> c;</span><br><span class="line">        <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> ((c = pending) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                     !U.compareAndSwapInt(<span class="keyword">this</span>, PENDING, c, c - <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> CountedCompleter&lt;?&gt; getRoot() &#123;</span><br><span class="line">        CountedCompleter&lt;?&gt; a = <span class="keyword">this</span>, p;</span><br><span class="line">        <span class="keyword">while</span> ((p = a.completer) != <span class="keyword">null</span>)</span><br><span class="line">            a = p;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果挂起的计数不为0，则减少计数，否则调用onCompletion</span></span><br><span class="line">    <span class="comment">//类似的尝试此任务的completer，存在则将此任务标记完成</span></span><br><span class="line">    <span class="comment">//尝试完成根任务或减少栈链下游的某一个completer的挂起数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">tryComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CountedCompleter&lt;?&gt; a = <span class="keyword">this</span>, s = a;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> c;;) &#123;</span><br><span class="line">            <span class="comment">//a(this或this的completer链中的某一个)的的挂起任务数为0,代表它挂起的任务都完成了.</span></span><br><span class="line">            <span class="keyword">if</span> ((c = a.pending) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//a的钩子函数:</span></span><br><span class="line">                <span class="comment">//对this于参数是否相等进行判断，如并行流聚合可以根据这个条件进行结果集的合并</span></span><br><span class="line">                a.onCompletion(s);</span><br><span class="line">                <span class="keyword">if</span> ((a = (s = a).completer) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//原来a的completer不存在，a不再是root了，那么就不需要传递</span></span><br><span class="line">                    <span class="comment">//调用quietlyComplete</span></span><br><span class="line">                    <span class="comment">//此时说明整条链上的completer的挂起任务全部都是0</span></span><br><span class="line">                    s.quietlyComplete();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//对this的completer栈的某一次循环发现挂起任务数不为0</span></span><br><span class="line">            <span class="comment">//对该completer的挂起数-1</span></span><br><span class="line">            <span class="comment">//表示它挂起的任务完成了一个</span></span><br><span class="line">            <span class="comment">//如果产生了竞争状态，某个链上的任务抢先-1操作</span></span><br><span class="line">            <span class="comment">//那么进入下一次循环、进入到链上的下一个completer的传播逻辑</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(a, PENDING, c, c - <span class="number">1</span>))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//基本等效tryComplete</span></span><br><span class="line">    <span class="comment">//仅仅是不执行onCompletion</span></span><br><span class="line">    <span class="comment">//tryComplete会在判断链上的某个completer的挂起数是否为0</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">propagateCompletion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CountedCompleter&lt;?&gt; a = <span class="keyword">this</span>, s = a;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> c;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((c = a.pending) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((a = (s = a).completer) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    s.quietlyComplete();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(a, PENDING, c, c - <span class="number">1</span>))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当获得多个子任务的任何一个结果</span></span><br><span class="line">    <span class="comment">//适合findAny场景</span></span><br><span class="line">    <span class="comment">//它丝毫不考虑挂起数、直接执行当前task的几个完成的方法</span></span><br><span class="line">    <span class="comment">//并且尝试对completer进行tryComplete</span></span><br><span class="line">    <span class="comment">//不改变自身的挂起任务数、但会让completer对栈上的其他completer或者自身尝试减少挂起数或者完成root</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(T rawResult)</span> </span>&#123;</span><br><span class="line">        CountedCompleter&lt;?&gt; p;</span><br><span class="line">        <span class="comment">//使用参数设置当前任务的结果</span></span><br><span class="line">        setRawResult(rawResult);</span><br><span class="line">        <span class="comment">//直接调用钩子函数</span></span><br><span class="line">        onCompletion(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//将status设置为NORMAL</span></span><br><span class="line">        quietlyComplete();</span><br><span class="line">        <span class="keyword">if</span> ((p = completer) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//自己不改变自身的挂起数、也不尝试完成root</span></span><br><span class="line">           p.tryComplete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果此任何的挂起计数为0，返回此任何，否则递减其挂起计数并返回</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> CountedCompleter&lt;?&gt; firstComplete() &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> c;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((c = pending) == <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//当前task没有挂起的任务数则返回</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, PENDING, c, c - <span class="number">1</span>))</span><br><span class="line">                <span class="comment">//尝试坚守一个任务数并返回null</span></span><br><span class="line">                <span class="comment">//可能出现CAS失败</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//会针对当前任务判断是否又completer</span></span><br><span class="line">    <span class="comment">//有则对completer进行firstComplete</span></span><br><span class="line">    <span class="comment">//否则将当前任务安静的完成并且返回null</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> CountedCompleter&lt;?&gt; nextComplete() &#123;</span><br><span class="line">        CountedCompleter&lt;?&gt; p;</span><br><span class="line">        <span class="keyword">if</span> ((p = completer) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> p.firstComplete();</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            quietlyComplete();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//等效于getRoot.quietlyCompleteRoot</span></span><br><span class="line">    <span class="comment">//遍历到root的completer执行quietlyComplete</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">quietlyCompleteRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (CountedCompleter&lt;?&gt; a = <span class="keyword">this</span>, p;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((p = a.completer) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                a.quietlyComplete();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            a = p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果当前task尚未完成，尝试去运行指定数量的未运行的完成路径上的任务</span></span><br><span class="line">    <span class="comment">//当前任务处于他们的完成路径上、实现特殊的工作窃取</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">helpComplete</span><span class="params">(<span class="keyword">int</span> maxTasks)</span> </span>&#123;</span><br><span class="line">        Thread t; ForkJoinWorkerThread wt;</span><br><span class="line">        <span class="keyword">if</span> (maxTasks &gt; <span class="number">0</span> &amp;&amp; status &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//判断当前线程是否是ForkJoinWorkerThread</span></span><br><span class="line">            <span class="keyword">if</span> ((t = Thread.currentThread()) <span class="keyword">instanceof</span> ForkJoinWorkerThread)</span><br><span class="line">                (wt = (ForkJoinWorkerThread)t).pool.</span><br><span class="line">                <span class="comment">//尝试执行当前任务并尝试从线程的工作队列中尝试帮助前置任务执行</span></span><br><span class="line">                    helpComplete(wt.workQueue, <span class="keyword">this</span>, maxTasks);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">//使用common池的externalHelpComplete方法</span></span><br><span class="line">                ForkJoinPool.common.externalHelpComplete(<span class="keyword">this</span>, maxTasks);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//支持FJT的异常传播</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">internalPropagateException</span><span class="params">(Throwable ex)</span> </span>&#123;</span><br><span class="line">        CountedCompleter&lt;?&gt; a = <span class="keyword">this</span>, s = a;</span><br><span class="line">        <span class="comment">//循环判断每一个task是否需要传递异常给completer</span></span><br><span class="line">        <span class="comment">//无代码体的while循环、神迹</span></span><br><span class="line">        <span class="keyword">while</span> (a.onExceptionalCompletion(ex, s) &amp;&amp;</span><br><span class="line">               <span class="comment">//需要传递给completer并且具备completer并且completer还不是完成态</span></span><br><span class="line">               (a = (s = a).completer) != <span class="keyword">null</span> &amp;&amp; a.status &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">               <span class="comment">//使用completer去记录异常的完成、记录成功进入下轮的循环</span></span><br><span class="line">               a.recordExceptionalCompletion(ex) == EXCEPTIONAL)</span><br><span class="line">            ;</span><br><span class="line">        </span><br><span class="line">   <span class="comment">//因为onExceptionalCompletion固定返回true,若没有中间完成的任务</span></span><br><span class="line">        <span class="comment">//直到最后一个completer,也就是root,root不具备completer,将中断循环</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重写的exec</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">exec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//直接调用了compute方法并且返回false</span></span><br><span class="line">        <span class="comment">//在ForkJoinTask中的doExec方法调用了exce后得到true，将执行setCompletion操作</span></span><br><span class="line">        <span class="comment">//主要将在首次唤醒等待结果的线程</span></span><br><span class="line">        <span class="comment">//此处return false将不再执行上述的操作</span></span><br><span class="line">        compute();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setRawResult</span><span class="params">(T t)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe U;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> PENDING;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            PENDING = U.objectFieldOffset</span><br><span class="line">                (CountedCompleter.class.getDeclaredField("pending"));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.完成态/异常态之间的切换：<code>internalPropagateException</code>置空了实现，对于不同方式的实现、需要不同的传递行为。重写的<code>internalPropagateException</code>不断的判断当前任务是否要将异常信号传递给链上的下一个任务，让后让未完成的<code>completer</code>去记录同一个异常ex。</p><p>&emsp;&emsp;2.只要<code>completer</code>完成过，显然while循环中断，当前<code>completer</code>和后续的<code>completer</code>将不会被处理：</p><p>如果后续的<code>completer</code>已经出现过了异常，也会走一遍同样的逻辑，传递给后面的<code>completer</code>，如果它正常完成，也必然要有相应向后传递的行为。</p><p>&emsp;&emsp;3.如果传递异常的任务本身就是另一个或者几个任务的<code>completer</code>、它的异常信息显然不会进行反向传递：</p><p>&emsp;&emsp;&emsp;&emsp;(1)<code>tryComplete</code>方法会产生两个结果：<code>completer</code>链前方的某一个<code>completer</code>的挂起任务数-1，或者<code>completer</code>前方的某一个<code>completer(root)</code>的<code>quietlyComplete</code>被执行。</p><p>&emsp;&emsp;&emsp;&emsp;(2)<code>tryComplete</code>仅会对<code>root</code>执行<code>quietlyComplete</code>进而执行<code>setComplete</code>,而对于链上的其他任务，最多帮其挂起数-1，而不会将他们设置为完成状态。但是线程池在执行任务时，<code>invoke</code>,<code>doExce</code>,<code>get</code>操作都会将<code>setComplete</code>。</p><p>&emsp;&emsp;&emsp;&emsp;(3)每一个<code>CountedCompelet</code>都可能有自己的<code>completer</code>栈链，而每一个<code>CountedComplete</code>也可以位于其他的<code>CountedComplete</code>的栈链上且上游不唯一，下游唯一，任何一条栈链仅有一个<code>root</code>，且<code>root</code>的<code>completer</code>为null。</p><p>&emsp;&emsp;&emsp;&emsp;(4)<code>tryComplete</code>只能向前影响到链上的<code>completer</code>，所以随时可以将一些<code>completer</code>的数量设置为任意数，所以可能出现下一个<code>completer</code>的挂起数为0，但是下下一个<code>completer</code>只能安静的完成或者将其挂起数-1。</p><p>&emsp;&emsp;&emsp;&emsp;(5)<code>helpComplete</code>方法主要用于工作窃取，非<code>common</code>线程池窃取的时自己的任务。</p><p>&emsp;&emsp;我们可能会有各种各样的情景,<code>ForkJoin</code>框架无法阻止我们对<code>ForkJoinTask</code>的<code>exec</code>函数进行任意式的扩展,也无法阻止我们对<code>CountedCompleter</code>的<code>compute</code>任意扩展,那么如何在我们任意拓展的情景下保持效率和健壮?比如下面这个使用场景:</p><p>&emsp;&emsp;&emsp;a.建立一种<code>ForkJoinTask</code>,直接继承<code>CountedCompleter</code>并重写<code>compute</code>方法,则它可以运行在<code>ForkJoinPool</code>中.</p><p>&emsp;&emsp;&emsp;b.我们接下来在<code>compute</code>方法中多次根据计算结果集的大小进行拆分并递归fork子任务入池,父任务成为子任务的<code>completer</code>,同时<code>compute</code>方法自身也负责不可拆分的计算逻辑,并在自身这一块计算结束后,可能等待所有fork入池的子任务结束,也可能不等待子任务,直接结束父任务,让线程空出来做其他的事.</p><p>&emsp;&emsp;&emsp;c.所有子任务结束后,使用一个合并函数合并子任务的结果集和自身的结果,并作为最终的结果.然后<code>tryComplete</code>(如果b中使用了join,或者判断当前任务是root).</p><p>&emsp;&emsp;&emsp;显然,b中fork出的子任务,也同样要执行bc的逻辑.那么可能出现这样的情况:</p><p>不同的父任务子任务在<code>ForkJoinPool</code>最初始压入当前工作线程的队列中,但随时可能被其他工作线程甚至外部线程偷去执行.</p><p>&emsp;&emsp;&emsp;父任务抢先抢得运行资源,运行完自己计算的部分,而入池的子任务及子孙任务有大量未完成.</p><p>难道父任务的执行线程就这样干等?ForkJoin框架适宜多计算,轻io,轻阻塞的情况,且本身就是为了避免线程忙的忙死饿的饿死,因此每个任务等待子任务执行结束是不可取的,这或许也是为什么有了<code>ForkJoinTask</code>,却还要有<code>CountedCompleter</code>的原因之一吧.</p><p>&emsp;&emsp;&emsp;若我们在任何每一个任务中只是单纯地将该分出去的子任务fork入池并执行自己那一部分,并不让当前线程join子任务呢?(事实上不join子任务恰好可以将当前线程的资源腾出来做其他的事)</p><p>&emsp;&emsp;&emsp;所以,除了前面提到的若干种向前影响<code>completer</code>栈链的挂起数或root的完成态,还需要一个能向栈链后方有所影响的操作,比如帮助子任务的完成,毕竟子任务也是b中fork出来且由自己入队的.</p><p>&emsp;&emsp;&emsp;<code>helpComplete</code>方法就可以做到这一点,它在<code>ForkJoinPool</code>中,它仅应在当前任务未完成时使用,首先它会尝试将当前任务从出队列并执行(<code>ForkJoinPool::popCC</code>及成功后续doExec,LIFO),出队失败则表示正在被执行甚至被偷去执行.出队这一步之后,再尝试自己的线程工作队列中找出自己的子孙任务(FIFO)并进行执行(<code>ForkJoinPool::pollAndExecCC</code>).</p><p>&emsp;&emsp;&emsp;而若执行完某个父任务的工作线程必然会调用tryComplete等有关方法,将自身或栈链后方的某一个<code>completer</code>的挂起数减一,甚至因为一些不合理的api使用(如直接更改了后方某个任务的挂起数量)而直接终止了root,将root任务标记成完成态.(注意前面强调的”运行完自己计算的部分”,这就是否定本句话的关键了,前面也说明<code>helpComplete</code>仅在当前任务未完成时使用,显然,完成了自己负责的计算内容并不代表当前任务完成了,因为它的子任务还没有完成,因此它不会调用<code>tryComplete</code>,并且可以去帮助子任务)</p><p>&emsp;&emsp;&emsp;同时,执行完父任务负责的计算内容的任务线程也会去找它栈链后方的其他任务,按照b的逻辑,这将是它的子任务,帮助它们完成,每完成一个子任务(子任务无子任务,不再help的情况),会进行<code>tryComplete</code>传递一次.</p><h2 id="ForkJoinWorkerThread-1"><a href="#ForkJoinWorkerThread-1" class="headerlink" title="ForkJoinWorkerThread"></a>ForkJoinWorkerThread</h2><p>&emsp;&emsp;<code>ForkJoinTask</code>被声称是一个轻量于普通线程和Future的实体,而它在ForkJoinPool中的运行载体便是<code>ForkJoinWorkerThread</code>,这个轻量究竟体现在何处?</p><h3 id="类声明-1"><a href="#类声明-1" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinWorkerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span></span><br></pre></td></tr></table></figure><h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//每个ForkJoinWorkerThread都只能属于一个线程池,且保存该池的引用</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinPool pool; </span><br><span class="line"><span class="comment">//每个ForkJoinWorkerThread都有一个工作队列</span></span><br><span class="line"><span class="comment">//显然队列中的任务就是该线程干活的最小单位了</span></span><br><span class="line"><span class="comment">//它也是工作窃取机制的核心</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinPool.WorkQueue workQueue;</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//指定线程池</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">ForkJoinWorkerThread</span><span class="params">(ForkJoinPool pool)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 线程名称</span></span><br><span class="line">    <span class="keyword">super</span>(<span class="string">"aForkJoinWorkerThread"</span>);</span><br><span class="line">    <span class="keyword">this</span>.pool = pool;</span><br><span class="line">    <span class="comment">//将工作线程注册到ForkJoinPool后会返回一个工作队列</span></span><br><span class="line">    <span class="comment">//供当前线程使用和供其他线程偷取</span></span><br><span class="line">    <span class="keyword">this</span>.workQueue = pool.registerWorker(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定线程组</span></span><br><span class="line">ForkJoinWorkerThread(ForkJoinPool pool, ThreadGroup threadGroup,</span><br><span class="line">                     AccessControlContext acc) &#123;</span><br><span class="line">    <span class="keyword">super</span>(threadGroup, <span class="keyword">null</span>, <span class="string">"aForkJoinWorkerThread"</span>);</span><br><span class="line">    <span class="comment">//inheritedAccessControlContext是从Thread继承下来的</span></span><br><span class="line">    <span class="comment">//字面意思是继承的访问控制上下文,设置为acc.</span></span><br><span class="line">    U.putOrderedObject(<span class="keyword">this</span>, INHERITEDACCESSCONTROLCONTEXT, acc);</span><br><span class="line">    <span class="comment">//注册入池之前,清除掉本地化信息</span></span><br><span class="line">    eraseThreadLocals(); </span><br><span class="line">    <span class="keyword">this</span>.pool = pool;</span><br><span class="line">    <span class="keyword">this</span>.workQueue = pool.registerWorker(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="getPool"><a href="#getPool" class="headerlink" title="getPool"></a>getPool</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回注册的线程池</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ForkJoinPool <span class="title">getPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> pool;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="getPoolIndex"><a href="#getPoolIndex" class="headerlink" title="getPoolIndex"></a>getPoolIndex</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回当前线程工作队列在池中的索引</span></span><br><span class="line"><span class="comment">//每个队列都会维护一个在池中的索引.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPoolIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> workQueue.getPoolIndex();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="onStart"><a href="#onStart" class="headerlink" title="onStart"></a>onStart</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//空函数,可交给子类实现</span></span><br><span class="line"><span class="comment">//它的作用是在构造之后处理任务之前</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="onTermination"><a href="#onTermination" class="headerlink" title="onTermination"></a>onTermination</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//工作线程终止时的勾子方法</span></span><br><span class="line"><span class="comment">//负责执行一些有关的清理操作</span></span><br><span class="line"><span class="comment">//但是若要重写它,必须在方法的最后调用super.onTermination</span></span><br><span class="line"><span class="comment">//参数exception是造成该线程终止的异常</span></span><br><span class="line"><span class="comment">//若是正常结束,则它是null.</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onTermination</span><span class="params">(Throwable exception)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="run"><a href="#run" class="headerlink" title="run"></a>run</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ForkJoinPool中会有一个WorkQueue的数组</span></span><br><span class="line">    <span class="comment">//在取消线程的注册后本线程关联的WorkQueue会从该数组移除</span></span><br><span class="line">    <span class="comment">//但WorkQueue中的array不会置空.</span></span><br><span class="line">    <span class="keyword">if</span> (workQueue.array == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Throwable exception = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//前置操作函数</span></span><br><span class="line">            onStart();</span><br><span class="line">            <span class="comment">//用线程池的runWorker方法执行,传入队列</span></span><br><span class="line">            pool.runWorker(workQueue);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">//发生异常,中断前记录下来</span></span><br><span class="line">            exception = ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//将记录下来的异常调用勾子方法.</span></span><br><span class="line">                onTermination(exception);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (exception == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//执行勾子方法本身出现了异常,记录下来</span></span><br><span class="line">                    exception = ex;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//调用线程池的解除注册方法,会将本线程的WorkQueue从数组中移除,同时使用上述异常.</span></span><br><span class="line">                pool.deregisterWorker(<span class="keyword">this</span>, exception);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="eraseThreadLocals"><a href="#eraseThreadLocals" class="headerlink" title="eraseThreadLocals"></a>eraseThreadLocals</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//擦除本地变量</span></span><br><span class="line"><span class="comment">//把当前线程的两个ThreadLocalMap全部置空</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">eraseThreadLocals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    U.putObject(<span class="keyword">this</span>, THREADLOCALS, <span class="keyword">null</span>);</span><br><span class="line">    U.putObject(<span class="keyword">this</span>, INHERITABLETHREADLOCALS, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="afterTopLevelExec"><a href="#afterTopLevelExec" class="headerlink" title="afterTopLevelExec"></a>afterTopLevelExec</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//每正常运行完一次顶级task,就调用一次它</span></span><br><span class="line"><span class="comment">//这个顶级任务自带易误解天性</span></span><br><span class="line"><span class="comment">//其实可以理解为每一次从队列取出的任务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterTopLevelExec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="子类"><a href="#子类" class="headerlink" title="子类"></a>子类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不具备任何特殊权限</span></span><br><span class="line"><span class="comment">//也不是用户定义的任何线程组的成员,每次运行完一个顶级任务</span></span><br><span class="line"><span class="comment">//则擦除本地化变量</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InnocuousForkJoinWorkerThread</span> <span class="keyword">extends</span> <span class="title">ForkJoinWorkerThread</span> </span>&#123;</span><br><span class="line">   <span class="comment">//自已创建默认线程组.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadGroup innocuousThreadGroup =</span><br><span class="line">        createThreadGroup();</span><br><span class="line">    <span class="comment">//访问控制上下文支持权限.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AccessControlContext INNOCUOUS_ACC =</span><br><span class="line">        <span class="keyword">new</span> AccessControlContext(</span><br><span class="line">            <span class="keyword">new</span> ProtectionDomain[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ProtectionDomain(<span class="keyword">null</span>, <span class="keyword">null</span>)</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="comment">//构造函数.</span></span><br><span class="line">    InnocuousForkJoinWorkerThread(ForkJoinPool pool) &#123;</span><br><span class="line">        <span class="keyword">super</span>(pool, innocuousThreadGroup, INNOCUOUS_ACC);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterTopLevelExec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//在每一次从队列取出的"顶级"任务运行后即擦除本地化变量.</span></span><br><span class="line">        eraseThreadLocals();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getContextClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果获取线程上下文类加载器,永远直接返回系统类加载器.</span></span><br><span class="line">        <span class="keyword">return</span> ClassLoader.getSystemClassLoader();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//尝试对未捕获异常处理器的设置,忽略.</span></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUncaughtExceptionHandler</span><span class="params">(UncaughtExceptionHandler x)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//禁止直接设置线程的上下文类加载器.</span></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContextClassLoader</span><span class="params">(ClassLoader cl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"setContextClassLoader"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建一个以顶级线程组为父的线程组.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ThreadGroup <span class="title">createThreadGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sun.misc.Unsafe u = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">            Class&lt;?&gt; tk = Thread<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">            Class&lt;?&gt; gk = ThreadGroup<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">            <span class="keyword">long</span> tg = u.objectFieldOffset(tk.getDeclaredField(<span class="string">"group"</span>));</span><br><span class="line">            <span class="keyword">long</span> gp = u.objectFieldOffset(gk.getDeclaredField(<span class="string">"parent"</span>));</span><br><span class="line">            <span class="comment">//当前线程的所属组.</span></span><br><span class="line">            ThreadGroup group = (ThreadGroup)</span><br><span class="line">                u.getObject(Thread.currentThread(), tg);</span><br><span class="line">            <span class="comment">//循环条件,当前线程的所属组不是null</span></span><br><span class="line">            <span class="keyword">while</span> (group != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//不停地循环向上取parent</span></span><br><span class="line">                ThreadGroup parent = (ThreadGroup)u.getObject(group, gp);</span><br><span class="line">                <span class="keyword">if</span> (parent == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//发现无parent的线程组,说明是系统顶级线程组</span></span><br><span class="line">                    <span class="comment">//用它当parent创建一个"无害"线程组返回.</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ThreadGroup(group,</span><br><span class="line">                                           <span class="string">"InnocuousForkJoinWorkerThreadGroup"</span>);</span><br><span class="line">                <span class="comment">//有parent,把它赋给group开启下一轮循环.</span></span><br><span class="line">                group = parent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//有异常用Error包装抛出.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//不能return就抛出Error.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Cannot create ThreadGroup"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.内部维护了一个工作队列，实现任务调度以及工作窃取。</p><p>&emsp;&emsp;2.每次顶级任务运行结束、清理<code>ThreadLocal</code>,避免同线程的本地化数据被污染。</p><h3 id="并行可窃取的分治查找算法"><a href="#并行可窃取的分治查找算法" class="headerlink" title="并行可窃取的分治查找算法"></a>并行可窃取的分治查找算法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ForkJoinTest2().testDivideSearch();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDivideSearch</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Integer[] array = <span class="keyword">new</span> Integer[<span class="number">10000000</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.length; i++)&#123;</span><br><span class="line">            array[i] = i+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        AtomicReference&lt;Integer&gt; result = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line">        Integer find = <span class="keyword">new</span> Searcher&lt;&gt;(<span class="keyword">null</span>, array, result, <span class="number">0</span>,</span><br><span class="line">                array.length - <span class="number">1</span>,<span class="keyword">this</span>::match).invoke();</span><br><span class="line">        System.out.println((<span class="string">"查找结束,任务返回:"</span> + find + <span class="string">",result:&#123;"</span> + result.get()) + <span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Searcher</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">CountedCompleter</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> E[] array; <span class="keyword">final</span> AtomicReference&lt;E&gt; result; <span class="keyword">final</span> <span class="keyword">int</span> lo, hi;</span><br><span class="line">        <span class="keyword">final</span> Function&lt;E,Boolean&gt; matcher;</span><br><span class="line"></span><br><span class="line">        Searcher(CountedCompleter&lt;?&gt; p, E[] array, AtomicReference&lt;E&gt; result,</span><br><span class="line">                 <span class="keyword">int</span> lo, <span class="keyword">int</span> hi,Function&lt;E,Boolean&gt; matcher)&#123;</span><br><span class="line">            <span class="keyword">super</span>(p);</span><br><span class="line">            <span class="keyword">this</span>.array = array;</span><br><span class="line">            <span class="keyword">this</span>.result = result;</span><br><span class="line">            <span class="keyword">this</span>.lo = lo;</span><br><span class="line">            <span class="keyword">this</span>.hi = hi;</span><br><span class="line">            <span class="keyword">this</span>.matcher = matcher;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> l = <span class="keyword">this</span>.lo;<span class="keyword">int</span> h = <span class="keyword">this</span>.hi;</span><br><span class="line">            <span class="keyword">while</span>(result.get() == <span class="keyword">null</span> &amp;&amp; h &gt;= l)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(h - l &gt;=<span class="number">2</span>)&#123;</span><br><span class="line">                    <span class="keyword">int</span> mid = (l + h)&gt;&gt;&gt;<span class="number">1</span>;</span><br><span class="line">                    <span class="comment">//添加挂起任务数量,这样当出现tryComplete时可以触发root的结束(未查到)</span></span><br><span class="line">                    addToPendingCount(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">new</span> Searcher&lt;E&gt;(<span class="keyword">this</span>,array,result,mid,h,matcher).fork();</span><br><span class="line">                    h = mid;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    E x = array[l];</span><br><span class="line">                    <span class="keyword">if</span>(matcher.apply(x) &amp;&amp;  result.compareAndSet(<span class="keyword">null</span>,x))&#123;</span><br><span class="line">                        <span class="keyword">super</span>.quietlyCompleteRoot();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//当前未有任何一个线程查到结果,当前任务也完成了子集查找,减少一个挂起数量,若挂起数已减至0则终止.</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> == result.get())</span><br><span class="line">                tryComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(Integer x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x &gt; <span class="number">2000000</span> &amp;&amp;  x%<span class="number">2</span> ==<span class="number">0</span> &amp;&amp; x%<span class="number">3</span> == <span class="number">0</span> &amp;&amp; x%<span class="number">5</span> ==<span class="number">0</span> &amp;&amp; x %<span class="number">7</span> ==<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.对任务分治，拆分成为足够多的子任务，剩下的不需要再进行拆分的父任务由当前的线程去执行。</p><p>&emsp;&emsp;2.子任务压入工作队列，其他空闲的线程则会进行工作窃取并且完成该任务。</p><p>&emsp;&emsp;3.此时若是某个任务的子任务查找到期望数据以后会将它放入<code>result</code>，并且安静的完成根任务。</p><p>&emsp;&emsp;4.此刻的任务链处于了一个尴尬的情形：查找到期望数据的子任务将<code>root</code>设置完成态，而整个非<code>root</code>链上的任务都是属于未完成。但是由于不满足条件无法退出循环，但是此刻已经得到了自己所期望的数据，那么任务的<code>status</code>依旧为未完成，是否存在了重复执行的问题？</p><p>&emsp;&emsp;5.由于<code>ForkJoinTask</code>肯定是由<code>ForkJoinPool</code>进行统一的调度，在<code>common</code>池中，任务执行前必须出队，尽管<code>compute</code>方法没有将这些任务设置为完成态，但是任务不会重复执行。所以<code>compute</code>方法会因为中止循环而结束，此后的方法都不存在任何的外部引用而会被GC回收，即使存在，用它去获取子孙任务的执行情况或者<code>result</code>也是没有任何实际的意义的。</p><h3 id="跨节点（Map-Reduce）"><a href="#跨节点（Map-Reduce）" class="headerlink" title="跨节点（Map,Reduce）"></a>跨节点（Map,Reduce）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinTest3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ForkJoinTest3().testMapReduce();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMapReduce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Integer[] array = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">        <span class="comment">//方法一.</span></span><br><span class="line">        Integer result = <span class="keyword">new</span> MapRed&lt;&gt;(<span class="keyword">null</span>, array, (a)-&gt;a+<span class="number">2</span>, (a,b)-&gt;a+b,  <span class="number">0</span>,array.length).invoke();</span><br><span class="line">        System.out.println(<span class="string">"方法一result:&#123;"</span> + result + <span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第一种map reduce方式,很好理解.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;E&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MapRed</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">CountedCompleter</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> E[] array;</span><br><span class="line">        <span class="keyword">final</span> MyMapper&lt;E&gt; mapper;</span><br><span class="line">        <span class="keyword">final</span> MyReducer&lt;E&gt; reducer;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> lo, hi;</span><br><span class="line">        <span class="comment">//兄弟节点的引用</span></span><br><span class="line">        MapRed&lt;E&gt; sibling;</span><br><span class="line">        E result;</span><br><span class="line"></span><br><span class="line">        MapRed(CountedCompleter&lt;?&gt; p, E[] array, MyMapper&lt;E&gt; mapper,</span><br><span class="line">               MyReducer&lt;E&gt; reducer, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi) &#123;</span><br><span class="line">            <span class="keyword">super</span>(p);</span><br><span class="line">            <span class="keyword">this</span>.array = array;</span><br><span class="line">            <span class="keyword">this</span>.mapper = mapper;</span><br><span class="line">            <span class="keyword">this</span>.reducer = reducer;</span><br><span class="line">            <span class="keyword">this</span>.lo = lo;</span><br><span class="line">            <span class="keyword">this</span>.hi = hi;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (hi - lo &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> mid = (lo + hi) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">                MapRed&lt;E&gt; left = <span class="keyword">new</span> MapRed(<span class="keyword">this</span>, array, mapper, reducer, lo, mid);</span><br><span class="line">                MapRed&lt;E&gt; right = <span class="keyword">new</span> MapRed(<span class="keyword">this</span>, array, mapper, reducer, mid, hi);</span><br><span class="line">                left.sibling = right;</span><br><span class="line">                right.sibling = left;</span><br><span class="line">                <span class="comment">//只挂起右任务</span></span><br><span class="line">                setPendingCount(<span class="number">1</span>);</span><br><span class="line">                right.fork();</span><br><span class="line">                <span class="comment">//直接运算左任务.</span></span><br><span class="line">                left.compute();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (hi &gt; lo)</span><br><span class="line">                    result = mapper.apply(array[lo]);</span><br><span class="line">                <span class="comment">//它会依次调用onCompletion.并且是自己调自己或completer调子,</span></span><br><span class="line">                <span class="comment">//且只有左右两个子后完成的能调成功(父任务的挂起数达到0).</span></span><br><span class="line">                tryComplete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(CountedCompleter&lt;?&gt; caller)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//忽略自己调自己.</span></span><br><span class="line">            <span class="keyword">if</span> (caller != <span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="comment">//参数是子任务.</span></span><br><span class="line">                MapRed&lt;E&gt; child = (MapRed&lt;E&gt;) caller;</span><br><span class="line">                MapRed&lt;E&gt; sib = child.sibling;</span><br><span class="line">                <span class="comment">//设置父的result.</span></span><br><span class="line">                <span class="keyword">if</span> (sib == <span class="keyword">null</span> || sib.result == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    result = child.result;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result = reducer.apply(child.result, sib.result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> E <span class="title">getRawResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mapper和reducer简单的不能再简单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyMapper</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        <span class="function">E <span class="title">apply</span><span class="params">(E e)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyReducer</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">        <span class="function">E <span class="title">apply</span><span class="params">(E a, E b)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.第一步也是将任务进行分治拆解，将任务拆分成为左边和右边。</p><p>&emsp;&emsp;2.左边直接由父任务执行，也可能会再次拆分，右边则加入线程池，每个叶子任务执行完毕后调用<code>tryComplete</code>。</p><p>&emsp;&emsp;3.会触发一系列的<code>complete</code>栈元素的挂起数下降或者完成。</p><h2 id="WorkQueue"><a href="#WorkQueue" class="headerlink" title="WorkQueue"></a>WorkQueue</h2><h3 id="类声明-2"><a href="#类声明-2" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@sun</span>.misc.Contended</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkQueue</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数-1"><a href="#构造函数-1" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化线程池,owner</span></span><br><span class="line">WorkQueue(ForkJoinPool pool, ForkJoinWorkerThread owner) &#123;</span><br><span class="line">    <span class="keyword">this</span>.pool = pool;</span><br><span class="line">    <span class="keyword">this</span>.owner = owner;</span><br><span class="line">    <span class="comment">// Place indices in the center of array (that is not yet allocated)</span></span><br><span class="line">    base = top = INITIAL_QUEUE_CAPACITY &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="相关成员"><a href="#相关成员" class="headerlink" title="相关成员"></a>相关成员</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//队列内部数组的初始容量,默认是2的12次方,它必须是2的几次方,且不能小于4.</span></span><br><span class="line"><span class="comment">//但它应该设置一个较大的值来减少队列间的缓存行共享.</span></span><br><span class="line"><span class="comment">//在前面的java运行时和54篇java官方文档术语中曾提到,jvm通常会将</span></span><br><span class="line"><span class="comment">//数组放在能够共享gc标记(如卡片标记)的位置,这样每一次写都会造成严重内存竞态.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INITIAL_QUEUE_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//最大内部数组容量,默认64M,也必须是2的平方,但不大于1&lt;&lt;(31-数组元素项宽度),</span></span><br><span class="line"><span class="comment">//根据官方注释,这可以确保无需计算索引概括,但定义一个略小于此的值有助于用户在</span></span><br><span class="line"><span class="comment">//系统饱合前捕获失控的程序.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_QUEUE_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">26</span>; <span class="comment">// 64M</span></span><br><span class="line"><span class="comment">// unsafe机制有关的字段.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe U;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  ABASE;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  ASHIFT;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> QTOP;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> QLOCK;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> QCURRENTSTEAL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例字段</span></span><br><span class="line"><span class="comment">// 版本号,小于0代表不活跃,注释解释奇数代表正在扫描,但从代码语义上看正好相反</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> scanState;    </span><br><span class="line"><span class="comment">// 前一个池栈控制信号(ctl),它保有前一个栈顶记录</span></span><br><span class="line"><span class="keyword">int</span> stackPred;      </span><br><span class="line"><span class="comment">// 偷盗的任务数</span></span><br><span class="line"><span class="keyword">int</span> nsteals;               </span><br><span class="line"><span class="comment">// 一个随机数,用于决定偷取任务的索引</span></span><br><span class="line"><span class="keyword">int</span> hint;        </span><br><span class="line"><span class="comment">// 配置,表示池的索引和模式</span></span><br><span class="line"><span class="keyword">int</span> config;       </span><br><span class="line"><span class="comment">// 队列锁,1表示锁了,小于0表示终止,其他情况是0.</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> qlock;     </span><br><span class="line"><span class="comment">// 底,表示下一个poll操作的插槽索引</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> base;         </span><br><span class="line"><span class="comment">// 顶,表示下一个push操作的插槽索引</span></span><br><span class="line"><span class="keyword">int</span> top;                   </span><br><span class="line"><span class="comment">// 存放任务元素的数组,初始不分配,首扩容会分配</span></span><br><span class="line">ForkJoinTask&lt;?&gt;[] array;   </span><br><span class="line"><span class="comment">// 包含该队列的池,可能在某些时刻是null</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinPool pool;   </span><br><span class="line"><span class="comment">// 持有该队列的线程,如果队列是共享的,owner是null</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinWorkerThread owner;</span><br><span class="line"><span class="comment">// 在调用park阻塞的owner,非阻塞时为null</span></span><br><span class="line"><span class="keyword">volatile</span> Thread parker;    </span><br><span class="line"><span class="comment">// 被在awaitJoin中join的task</span></span><br><span class="line"><span class="keyword">volatile</span> ForkJoinTask&lt;?&gt; currentJoin;  </span><br><span class="line"><span class="comment">// 字面意思当前偷的任务,主要用来helpStealer方法使用</span></span><br><span class="line"><span class="keyword">volatile</span> ForkJoinTask&lt;?&gt; currentSteal;</span><br></pre></td></tr></table></figure><h3 id="静态函数"><a href="#静态函数" class="headerlink" title="静态函数"></a>静态函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">        Class&lt;?&gt; wk = WorkQueue<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        Class&lt;?&gt; ak = ForkJoinTask[]<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        <span class="comment">//top字段的句柄.</span></span><br><span class="line">        QTOP = U.objectFieldOffset</span><br><span class="line">            (wk.getDeclaredField(<span class="string">"top"</span>));</span><br><span class="line">        <span class="comment">//qlock字段的句柄.</span></span><br><span class="line">        QLOCK = U.objectFieldOffset</span><br><span class="line">            (wk.getDeclaredField(<span class="string">"qlock"</span>));</span><br><span class="line">        <span class="comment">//currentSteal的句柄</span></span><br><span class="line">        QCURRENTSTEAL = U.objectFieldOffset</span><br><span class="line">            (wk.getDeclaredField(<span class="string">"currentSteal"</span>));</span><br><span class="line">        <span class="comment">//ABASE是ForkJoinTask数组的首地址.</span></span><br><span class="line">        ABASE = U.arrayBaseOffset(ak);</span><br><span class="line">        <span class="comment">//scale代表数组元素的索引大小.它必须是2的平方.</span></span><br><span class="line">        <span class="keyword">int</span> scale = U.arrayIndexScale(ak);</span><br><span class="line">        <span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"data type scale not a power of two"</span>);</span><br><span class="line">        <span class="comment">//计算ASHIFT,它是31与scale的高位0位数量的差值.因为上一步约定了scale一定是一个正的2的几次方,</span></span><br><span class="line">        <span class="comment">//ASHIFT的结果一定会大于1.可以理解ASHIFT是数组索引大小的有效位数.</span></span><br><span class="line">        ASHIFT = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="方法-1"><a href="#方法-1" class="headerlink" title="方法"></a>方法</h3><h4 id="getPoolIndex-1"><a href="#getPoolIndex-1" class="headerlink" title="getPoolIndex"></a>getPoolIndex</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回本队列在池中的索引</span></span><br><span class="line"><span class="comment">//使用config的2至4位表示</span></span><br><span class="line"><span class="comment">//因为config的最后一位是奇偶位,忽略</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getPoolIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (config &amp; <span class="number">0xffff</span>) &gt;&gt;&gt; <span class="number">1</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="queueSize"><a href="#queueSize" class="headerlink" title="queueSize"></a>queueSize</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回队列中的任务数.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">queueSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//非owner的调用者必须先读base,用base-top,得到的结果小于0则取相反数,否则取0.</span></span><br><span class="line">    <span class="comment">//忽略即时的负数,它并不严格准确.</span></span><br><span class="line">    <span class="keyword">int</span> n = base - top;       </span><br><span class="line">    <span class="keyword">return</span> (n &gt;= <span class="number">0</span>) ? <span class="number">0</span> : -n; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="isEmpty"><a href="#isEmpty" class="headerlink" title="isEmpty"></a>isEmpty</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断队列是否为空队.本方法较为精确</span></span><br><span class="line"><span class="comment">//对于近空队列,要检查是否有至少一个未被占有的任务</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt;[] a; <span class="keyword">int</span> n, m, s;</span><br><span class="line">    <span class="comment">//base大于等于top,说明空了.</span></span><br><span class="line">    <span class="keyword">return</span> ((n = base - (s = top)) &gt;= <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">//有容量,且恰好计算为1,可能只有一个任务.</span></span><br><span class="line">            (n == -<span class="number">1</span> &amp;&amp; </span><br><span class="line">             <span class="comment">//计算为1,再验数组是不是空的.          </span></span><br><span class="line">             ((a = array) == <span class="keyword">null</span> || (m = a.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">              <span class="comment">//取该位置元素的值判空,空则说明isEmpty.</span></span><br><span class="line">              <span class="comment">//取值的方式是取ForkJoinTask.class首地址加上偏移量(数组长度减一(最后一个元素位置,经典案例32-1)与运算top减一左移ASHIFT(索引大小有效位数)位)的值.</span></span><br><span class="line">              U.getObject</span><br><span class="line">              (a, (<span class="keyword">long</span>)((m &amp; (s - <span class="number">1</span>)) &lt;&lt; ASHIFT) + ABASE) == <span class="keyword">null</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="push"><a href="#push" class="headerlink" title="push"></a>push</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将一个任务压入队列,前文提过的fork最终就会压队</span></span><br><span class="line"><span class="comment">//但此方法只能由非共享队列的持有者调用</span></span><br><span class="line"><span class="comment">//当使用线程池的"外部压入"externalPush方法时,压入共享队列.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(ForkJoinTask&lt;?&gt; task)</span> </span>&#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt;[] a; ForkJoinPool p;</span><br><span class="line">    <span class="comment">//保存当时的base top.</span></span><br><span class="line">    <span class="keyword">int</span> b = base, s = top, n;</span><br><span class="line">    <span class="comment">//如果数组被移除则忽略.</span></span><br><span class="line">    <span class="keyword">if</span> ((a = array) != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="comment">//数组最后一个下标</span></span><br><span class="line">        <span class="comment">//如长度32,则m取31这个质数.此时保存一个m,对于保存后其他push操作相当于打了屏障.</span></span><br><span class="line">        <span class="keyword">int</span> m = a.length - <span class="number">1</span>; </span><br><span class="line">        <span class="comment">//向数组中的指定位置压入该任务</span></span><br><span class="line">        <span class="comment">//位置包含上面的m和s进行与运算(数组中的位置)</span></span><br><span class="line">        <span class="comment">//结果左移索引有效长度位(索引长度),再加上数组首索引偏移量(起始地址).  </span></span><br><span class="line">        U.putOrderedObject(a, ((m &amp; s) &lt;&lt; ASHIFT) + ABASE, task);</span><br><span class="line">        <span class="comment">//将top加1.</span></span><br><span class="line">        U.putOrderedInt(<span class="keyword">this</span>, QTOP, s + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ((n = s - b) &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//计算旧的任务数量,发现不大于1个</span></span><br><span class="line">            <span class="comment">//说明原来很可能工作线程正在阻塞等待新的任务.需要唤醒它.</span></span><br><span class="line">            <span class="keyword">if</span> ((p = pool) != <span class="keyword">null</span>)</span><br><span class="line">                <span class="comment">//signalWork会根据情况,添加新的工作线程或唤醒等待任务的线程.</span></span><br><span class="line">                p.signalWork(p.workQueues, <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= m)<span class="comment">//2.</span></span><br><span class="line">            <span class="comment">//任务数量超出了,对数组扩容.</span></span><br><span class="line">            growArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="growArray"><a href="#growArray" class="headerlink" title="growArray"></a>growArray</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加任务过程主流程无锁,包括可能出现的growArray</span></span><br><span class="line"><span class="comment">//当原队列为空时,它会初始化一个数组,否则扩容一倍</span></span><br><span class="line"><span class="comment">//持有者调用时,不需要加锁</span></span><br><span class="line"><span class="comment">//但当其他线程调用时,需要持有锁.在resize过程中,base可以移动,但top不然</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinTask&lt;?&gt;[] growArray() &#123;</span><br><span class="line">    <span class="comment">//记录老数组.</span></span><br><span class="line">    ForkJoinTask&lt;?&gt;[] oldA = array;</span><br><span class="line">    <span class="comment">//根据老数组决定新容量,老数组空则INITIAL_QUEUE_CAPACITY否则国倍.</span></span><br><span class="line">    <span class="keyword">int</span> size = oldA != <span class="keyword">null</span> ? oldA.length &lt;&lt; <span class="number">1</span> : INITIAL_QUEUE_CAPACITY;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; MAXIMUM_QUEUE_CAPACITY)</span><br><span class="line">        <span class="comment">//新大小大于最大数组大小则拒绝.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">"Queue capacity exceeded"</span>);</span><br><span class="line">    <span class="keyword">int</span> oldMask, t, b;</span><br><span class="line">    <span class="comment">//直接将原来的数组引用替换成新的.</span></span><br><span class="line">    ForkJoinTask&lt;?&gt;[] a = array = <span class="keyword">new</span> ForkJoinTask&lt;?&gt;[size];</span><br><span class="line">    <span class="comment">//如果是初次分配,就此打住返回a,是扩容,且老数组非空则进入下面的循环拷贝.</span></span><br><span class="line">    <span class="keyword">if</span> (oldA != <span class="keyword">null</span> &amp;&amp; (oldMask = oldA.length - <span class="number">1</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (t = top) - (b = base) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//根据前面的运算,size一定是2的幂,减一用来哈希,这是经典处理办法.</span></span><br><span class="line">        <span class="keyword">int</span> mask = size - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123; </span><br><span class="line">            ForkJoinTask&lt;?&gt; x;</span><br><span class="line">            <span class="comment">//老数组base自增过若干次的得到b,它代表的元素对应的索引.</span></span><br><span class="line">            <span class="keyword">int</span> oldj = ((b &amp; oldMask) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">            <span class="comment">//用b在新数组中找出索引.</span></span><br><span class="line">            <span class="keyword">int</span> j    = ((b &amp;    mask) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">            <span class="comment">//老数组中用索引取出元素.</span></span><br><span class="line">            x = (ForkJoinTask&lt;?&gt;)U.getObjectVolatile(oldA, oldj);</span><br><span class="line">            <span class="keyword">if</span> (x != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                <span class="comment">//老数组置空,放入新数组.</span></span><br><span class="line">                U.compareAndSwapObject(oldA, oldj, x, <span class="keyword">null</span>))</span><br><span class="line">                U.putObjectVolatile(a, j, x);</span><br><span class="line">            <span class="comment">//每处理完一个task,就将base自增1,直到top为止.</span></span><br><span class="line">        &#125; <span class="keyword">while</span> (++b != t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回新数组.</span></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="pop"><a href="#pop" class="headerlink" title="pop"></a>pop</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存在下一个任务,弹出,顺序是后进先出.此方法仅限非共享队列的owner调用</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinTask&lt;?&gt; pop() &#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt;[] a; ForkJoinTask&lt;?&gt; t; <span class="keyword">int</span> m;</span><br><span class="line">    <span class="comment">//还有元素.</span></span><br><span class="line">    <span class="keyword">if</span> ((a = array) != <span class="keyword">null</span> &amp;&amp; (m = a.length - <span class="number">1</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//1.top至少比base大一.注意,每次循环都会读出新的top,它是volatile修饰的</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> s; (s = top - <span class="number">1</span>) - base &gt;= <span class="number">0</span>;) &#123;</span><br><span class="line">            <span class="comment">//top对应的索引.</span></span><br><span class="line">            <span class="keyword">long</span> j = ((m &amp; s) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">            <span class="comment">//2.该索引没有元素,break,返回null.而且就代表这个位置的确是null,与竞态无关</span></span><br><span class="line">            <span class="comment">//因为此方法仅owner线程使用,不会出现另一个线程计算了同样的j,且先执行了3的情况</span></span><br><span class="line">            <span class="comment">//出现这种情况,则是此位置的任务当先被执行并出栈,或者就从未设置过任务,后续分析这种极端情况</span></span><br><span class="line">            <span class="comment">//故如果出现某个任务在数组的中间</span></span><br><span class="line">            <span class="comment">//提前被执行并置空(非pop或poll方式),那么再对WorkQueue进行pop时将会中断</span></span><br><span class="line">            <span class="comment">//留下一部分null之后的任务不能出栈,所以可以允许任务非pop或poll方式查出并执行</span></span><br><span class="line">            <span class="comment">//但为了能pop出所有任务,不能中间置null.</span></span><br><span class="line">            <span class="keyword">if</span> ((t = (ForkJoinTask&lt;?&gt;)U.getObject(a, j)) == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//3.有元素,将该索引位置置null.若cas失败,说明元素被取出了</span></span><br><span class="line">            <span class="comment">//但下次循环即使在2处break并返回null,也不是因为竞态,因为每次循环到1都会读取新的top</span></span><br><span class="line">            <span class="comment">//也就有新的j</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapObject(a, j, t, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="comment">//数组位置置null的同时top减1.</span></span><br><span class="line">                U.putOrderedInt(<span class="keyword">this</span>, QTOP, s);</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//循环退出,说明top位置没有元素,也相当于说明数组为空</span></span><br><span class="line">    <span class="comment">//显然此方法的另一个作用是将队列压缩,空队列会将top先降到base+1</span></span><br><span class="line">    <span class="comment">//再循环最后一次将top降到base.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="pollAt"><a href="#pollAt" class="headerlink" title="pollAt"></a>pollAt</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果b是base,使用FIFO的次序尝试无竞态取底部的任务</span></span><br><span class="line"><span class="comment">//它会在ForkJoinPool的scan和helpStealer中使用.</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinTask&lt;?&gt; pollAt(<span class="keyword">int</span> b) &#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt; t; ForkJoinTask&lt;?&gt;[] a;</span><br><span class="line">    <span class="keyword">if</span> ((a = array) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//和前面一样的的方式计算b对应的索引j</span></span><br><span class="line">        <span class="keyword">int</span> j = (((a.length - <span class="number">1</span>) &amp; b) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">        <span class="keyword">if</span> ((t = (ForkJoinTask&lt;?&gt;)U.getObjectVolatile(a, j)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            <span class="comment">//j对应位置有task且当前base==b,尝试将task出队.</span></span><br><span class="line">            base == b &amp;&amp; U.compareAndSwapObject(a, j, t, <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">//出队成功base增1.不需要额外的同步,因为两个线程不可能同时在上面的cas成功.</span></span><br><span class="line">            <span class="comment">//当一切条件匹配(b就是base且j位置有元素),pollAt同一个b只会有一个返回非空的t.</span></span><br><span class="line">            <span class="comment">//如果多个线程传入的b不相等,在同一时刻只有一个会等于base.</span></span><br><span class="line">            base = b + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用FIFO的次序取下一个任务</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinTask&lt;?&gt; poll() &#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt;[] a; <span class="keyword">int</span> b; ForkJoinTask&lt;?&gt; t;</span><br><span class="line">    <span class="comment">//1.循环从base取任务,当base增长到top或其他操作重置array为null则终止循环</span></span><br><span class="line">    <span class="keyword">while</span> ((b = base) - top &lt; <span class="number">0</span> &amp;&amp; (a = array) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//前面已叙述过取索引的逻辑</span></span><br><span class="line">        <span class="comment">//使用一个top到base间的数与数组长度-1与运算并左移索引长度位再加上数组基准偏移量.后面不再缀述</span></span><br><span class="line">        <span class="keyword">int</span> j = (((a.length - <span class="number">1</span>) &amp; b) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">        <span class="comment">//取出task</span></span><br><span class="line">        t = (ForkJoinTask&lt;?&gt;)U.getObjectVolatile(a, j);</span><br><span class="line">        <span class="comment">//2.如果发生竞态,base已经不是b,直接开启下一轮循环把新的base读给b</span></span><br><span class="line">        <span class="keyword">if</span> (base == b) &#123;</span><br><span class="line">            <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//3.当前t是base任务,用cas置空,base+1,返回t.</span></span><br><span class="line">                <span class="comment">//如果此处发生竞态,则只有一个线程可以成功返回t并重置base(4).</span></span><br><span class="line">                <span class="comment">//不成功的线程会开启下一轮循环,此时成功线程可能未来的及执行4更新base,</span></span><br><span class="line">                <span class="comment">//也可能已经更新base,则导致先前失败的线程在2处通过</span></span><br><span class="line">                <span class="comment">//经5种或判队列空返回,或非空再次循环</span></span><br><span class="line">                <span class="comment">//而在当前成功线程执行4成功后,所有前面失败的线程可以在1处读到新的base</span></span><br><span class="line">                <span class="comment">//这些线程在下一次循环中依旧只会有一个成功弹出t并重置base,直到所有线程执行完毕</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapObject(a, j, t, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                    <span class="comment">//4重置加返回</span></span><br><span class="line">                    base = b + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">return</span> t;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//5.t取出的是空,发现此时临时变量b(其他成功线程在此轮循环前置的base)已增至top-1</span></span><br><span class="line">            <span class="comment">//且当前线程又没能成功的弹出t,说明一定会有一个线程</span></span><br><span class="line">            <span class="comment">//将t弹出并更新base到top的值,当前线程没必要再开下一个循环了,直接break并返回null</span></span><br><span class="line">            <span class="comment">//t取出的是空,但是没到top,说明只是被提前执行并置空了,那么继续读取新的base并循环</span></span><br><span class="line">            <span class="comment">//且若没有其他线程去更改base,array的长度,或者把top降到</span></span><br><span class="line">            <span class="comment">//base,则当前线程就永远死循环下去了,因为每次循环都是125且每个变量都不变.因此为避免循环,</span></span><br><span class="line">            <span class="comment">//个任务可以提前执行,但一定不能提前离队(置null).</span></span><br><span class="line">            <span class="comment">//也就是说:只能用poll或pop方式弹出任务,其他方式获得任务并执行是允许的</span></span><br><span class="line">            <span class="comment">//但不能在执行后置null,留待后续源码验证一下</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (b + <span class="number">1</span> == top) <span class="comment">// now empty</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从循环退出来有两种情况,可能是在5处满足退出条件,或者在2处发现b已经是脏数据</span></span><br><span class="line">    <span class="comment">//下轮循环不满足循环条件所致.两种都应该返回null.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="nextLocalTask"><a href="#nextLocalTask" class="headerlink" title="nextLocalTask"></a>nextLocalTask</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据mode来取下一个本队列元素.根据模式.</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinTask&lt;?&gt; nextLocalTask() &#123;</span><br><span class="line">    <span class="comment">//当前WorkQueue的配置了FIFO,则poll,否则pop</span></span><br><span class="line">    <span class="comment">//尽管还未看到注册worker的源码,在此提前透露下</span></span><br><span class="line">    <span class="comment">//ForkJoinPool也有一个config(前面讲构造函数提过)</span></span><br><span class="line">    <span class="comment">//该config保存了mode信息,并原样赋给了WorkQueue的mode.注意,相应的任务会出队</span></span><br><span class="line">    <span class="keyword">return</span> (config &amp; FIFO_QUEUE) == <span class="number">0</span> ? pop() : poll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="peek"><a href="#peek" class="headerlink" title="peek"></a>peek</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据模式取出下一个任务,但是不出队</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinTask&lt;?&gt; peek() &#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt;[] a = array; <span class="keyword">int</span> m;</span><br><span class="line">    <span class="comment">//空队,返回null.</span></span><br><span class="line">    <span class="keyword">if</span> (a == <span class="keyword">null</span> || (m = a.length - <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//根据mode定位要取的索引j</span></span><br><span class="line">    <span class="keyword">int</span> i = (config &amp; FIFO_QUEUE) == <span class="number">0</span> ? top - <span class="number">1</span> : base;</span><br><span class="line">    <span class="keyword">int</span> j = ((i &amp; m) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">    <span class="comment">//返回读出的值,不出队</span></span><br><span class="line">    <span class="keyword">return</span> (ForkJoinTask&lt;?&gt;)U.getObjectVolatile(a, j);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tryUnpush"><a href="#tryUnpush" class="headerlink" title="tryUnpush"></a>tryUnpush</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果参数t是当前队的top,则弹出</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryUnpush</span><span class="params">(ForkJoinTask&lt;?&gt; t)</span> </span>&#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt;[] a; <span class="keyword">int</span> s;</span><br><span class="line">    <span class="keyword">if</span> ((a = array) != <span class="keyword">null</span> &amp;&amp; (s = top) != base &amp;&amp;</span><br><span class="line">        <span class="comment">//1.满足非空条件.尝试用t去当当作计算出的索引位置的原任务的值并cas为null来出队</span></span><br><span class="line">        U.compareAndSwapObject</span><br><span class="line">        (a, (((a.length - <span class="number">1</span>) &amp; --s) &lt;&lt; ASHIFT) + ABASE, t, <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="comment">//cas成功,说明t确实是top,将top减一返回true</span></span><br><span class="line">        U.putOrderedInt(<span class="keyword">this</span>, QTOP, s);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.cas失败或不满足1的条件,返回false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="cancelAll"><a href="#cancelAll" class="headerlink" title="cancelAll"></a>cancelAll</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//移除并取消队列中所有已知的任务,忽略异常</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">cancelAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt; t;</span><br><span class="line">    <span class="keyword">if</span> ((t = currentJoin) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//有currentJoin,引用置空,取消并忽略异常</span></span><br><span class="line">        currentJoin = <span class="keyword">null</span>;</span><br><span class="line">        ForkJoinTask.cancelIgnoringExceptions(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((t = currentSteal) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//有currentSteal,引用置空,取消并忽略异常</span></span><br><span class="line">        currentSteal = <span class="keyword">null</span>;</span><br><span class="line">        ForkJoinTask.cancelIgnoringExceptions(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//除了上面两个,就只剩下数组中的任务了.按LILO的顺序弹出并依次取消,忽略所有异常</span></span><br><span class="line">    <span class="keyword">while</span> ((t = poll()) != <span class="keyword">null</span>)</span><br><span class="line">        ForkJoinTask.cancelIgnoringExceptions(t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="pollAndExecAll"><a href="#pollAndExecAll" class="headerlink" title="pollAndExecAll"></a>pollAndExecAll</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//按FIFO顺序从队首弹出任务并执行所有非空任务</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">pollAndExecAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ForkJoinTask&lt;?&gt; t; (t = poll()) != <span class="keyword">null</span>;)</span><br><span class="line">        <span class="comment">//很明显,如果未按严格顺序执行,先执行中间的一个任务</span></span><br><span class="line">        <span class="comment">//再调用本方法,则会半路中止</span></span><br><span class="line">        t.doExec();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="execLocalTasks"><a href="#execLocalTasks" class="headerlink" title="execLocalTasks"></a>execLocalTasks</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//移除并执行完所有本队列的任务,如果是先进先出,则执行前面的pollAndExecAll方法</span></span><br><span class="line"><span class="comment">//否则pop循环执行到空为止.按前面的分析,只要坚持只能pop或poll弹出,其他方式执行任务但不能置空的原则</span></span><br><span class="line"><span class="comment">//可以保证pop或poll出现空的情况只能是竞态发生的情况</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execLocalTasks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> b = base, m, s;</span><br><span class="line">    ForkJoinTask&lt;?&gt;[] a = array;</span><br><span class="line">    <span class="comment">//初始满足条件,top至少比base大1.队列非空</span></span><br><span class="line">    <span class="keyword">if</span> (b - (s = top - <span class="number">1</span>) &lt;= <span class="number">0</span> &amp;&amp; a != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        (m = a.length - <span class="number">1</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//不是FIFO模式.</span></span><br><span class="line">        <span class="keyword">if</span> ((config &amp; FIFO_QUEUE) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (ForkJoinTask&lt;?&gt; t;;) &#123;</span><br><span class="line">                <span class="comment">//原子getAndSet,查出并弹出原本的task</span></span><br><span class="line">                <span class="keyword">if</span> ((t = (ForkJoinTask&lt;?&gt;)U.getAndSetObject</span><br><span class="line">                     (a, ((m &amp; s) &lt;&lt; ASHIFT) + ABASE, <span class="keyword">null</span>)) == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//弹出的task是空,break.说明整个工作流程中,如果未保证严格有序</span></span><br><span class="line">                    <span class="comment">//如先从中间的某个任务开始执行并且出队了,再调用execLocalTasks,会导致中间停顿</span></span><br><span class="line">                    <span class="comment">//只执行不出队,则至少不会中断.出现t是null的情况只能是竞态或末尾</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//top减一,执行任务</span></span><br><span class="line">                U.putOrderedInt(<span class="keyword">this</span>, QTOP, s);</span><br><span class="line">                t.doExec();</span><br><span class="line">                <span class="comment">//如果base大于等于top,则中止</span></span><br><span class="line">                <span class="keyword">if</span> (base - (s = top - <span class="number">1</span>) &gt; <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//是FIFO模式,pollAndExecAll.</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pollAndExecAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="runTask"><a href="#runTask" class="headerlink" title="runTask"></a>runTask</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重点入口方法来了,前面留下诸多关于执行任务是否出队的讨论,下面来分析入口方法</span></span><br><span class="line"><span class="comment">//该方法的入口是每个工作线程的run方法,因此只有一个线程</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runTask</span><span class="params">(ForkJoinTask&lt;?&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//传入task是空直接不理会.</span></span><br><span class="line">    <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//标记成忙.scanState是WorkQueue的成员变量,每个WorkQueue只有一个值</span></span><br><span class="line">        <span class="comment">//前面说过,一般情况下,每个线程会有一个WorkQueue,所以某种情况来讲也可以标记为</span></span><br><span class="line">        <span class="comment">//当前ForkJoinWorkerThread繁忙.</span></span><br><span class="line">        <span class="comment">//SCANNING常量值是1,这个操作实质上就是将scanState变量的个位置0</span></span><br><span class="line">        <span class="comment">//也就是变成了偶数并标记它要忙了</span></span><br><span class="line">        <span class="comment">//显然偶数才表示忙碌,这也是为什么前面觉得官方注释scanState是奇数表示"正在扫描"很奇怪.</span></span><br><span class="line">        scanState &amp;= ~SCANNING; </span><br><span class="line">        <span class="comment">//将currentSteal设置为传入的任务,并运行该任务,若该任务内部进行了分叉,则进入相应的入队逻辑</span></span><br><span class="line">        (currentSteal = task).doExec();</span><br><span class="line">        <span class="comment">//执行完该任务后,将currentSteal置空.将该task释放掉,帮助gc</span></span><br><span class="line">        U.putOrderedObject(<span class="keyword">this</span>, QCURRENTSTEAL, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//调用前面提到的,根据mode选择依次pop或poll的方式将自己的工作队列内的任务出队并执行的方法</span></span><br><span class="line">        execLocalTasks();</span><br><span class="line">        <span class="comment">//到此,自己队列中的所有任务都已经完成.包含偷来的任务fork后又入队到自己队列的子任务</span></span><br><span class="line">        <span class="comment">//取出owner线程.处理偷取任务有关的一些信息</span></span><br><span class="line">        ForkJoinWorkerThread thread = owner;</span><br><span class="line">        <span class="keyword">if</span> (++nsteals &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//发现当前WorkQueue偷来的任务数即将溢出了,将它转到线程池    </span></span><br><span class="line">            transferStealCount(pool);</span><br><span class="line">        <span class="comment">//取消忙碌标记.</span></span><br><span class="line">        scanState |= SCANNING;</span><br><span class="line">        <span class="keyword">if</span> (thread != <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//执行afterTopLevelExec勾子方法,上一节中介绍ForkJoinWorkerThread时已介绍</span></span><br><span class="line">            thread.afterTopLevelExec();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//方法结束,注意,没有任何操作将task从所在的数组中移除,不论这个task是哪个WorkQueue中的元素</span></span><br><span class="line">    <span class="comment">//同时,此方法原则上讲可以多次调用(尽管事实上就一次调用)</span></span><br><span class="line">    <span class="comment">//入口处和出口处分别用忙碌标记来标记scanState,但重复标记显然不影响执行.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="transferStealCount"><a href="#transferStealCount" class="headerlink" title="transferStealCount"></a>transferStealCount</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果线程池中已经初始化了用于记录的stealCounter</span></span><br><span class="line"><span class="comment">//则用它加上当前WorkQueue的nsteals/或最大整数(发生溢出时)</span></span><br><span class="line"><span class="comment">//并初始化当前WorkQueue的nsteals</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transferStealCount</span><span class="params">(ForkJoinPool p)</span> </span>&#123;</span><br><span class="line">    AtomicLong sc;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; (sc = p.stealCounter) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//线程池中存放了stealCounter,它是一个原子整数</span></span><br><span class="line">        <span class="keyword">int</span> s = nsteals;</span><br><span class="line">        nsteals = <span class="number">0</span>; <span class="comment">//恢复0</span></span><br><span class="line">        <span class="comment">//若nsteals是负,增加最大整数,否则增加nsteal         </span></span><br><span class="line">        sc.getAndAdd((<span class="keyword">long</span>)(s &lt; <span class="number">0</span> ? Integer.MAX_VALUE : s));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tryRemoveAndExec"><a href="#tryRemoveAndExec" class="headerlink" title="tryRemoveAndExec"></a>tryRemoveAndExec</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//简单梳理一下tryRemoveAndExec的执行流程和生命周期.</span></span><br><span class="line"><span class="comment">//a.显然,一上来就判队列的空和参数的空,如果第一个if都进不去,按约定返回true</span></span><br><span class="line"><span class="comment">//b.经过1初始化一个内层循环,并初始化了n,它决定内循环最多跑n次</span></span><br><span class="line"><span class="comment">//如果内循环一直不break(9找到任务或12发现顶部任务是完成态),也假定一般碰不到14(发现目标任务完成了)</span></span><br><span class="line"><span class="comment">//也没有出现几种return(3查出null,14某轮内循环目标task发现被完成了)</span></span><br><span class="line"><span class="comment">//那么最终只会耗尽次数,遍历到底,在13处return false(确定此轮循环task不在队列)</span></span><br><span class="line"><span class="comment">//c.如果出现了几种break(9,12),9其实代表查到任务,12代表顶部任务已完成(官方说取消)</span></span><br><span class="line"><span class="comment">//那就会停止内循环,重新开启一轮外循环,初始化n,继续从新的top到base遍历(b).</span></span><br><span class="line"><span class="comment">//但此时,可能找不到task了(它已经在上一轮内循环出队或被替换成代理)</span></span><br><span class="line"><span class="comment">//但也可能实际上未出队(该task不是top,即4,base也发生了改变造成7未执行),那么可能在本轮循环</span></span><br><span class="line"><span class="comment">//找到任务,在b中进入相应的break,并且成功移除并会进入d,也可能没进入break而是再重复一次b</span></span><br><span class="line"><span class="comment">//d.如果某一次break成功删除了任务,那么外循环更新了n,base,top</span></span><br><span class="line"><span class="comment">//重启了一次内循环,但是所有找到task的分支不会再有了,如果接下来不再碰到被完成(取消)的顶部任务11-12</span></span><br><span class="line"><span class="comment">//同样也没发现目标task完成了(不进14),那么最终的结果就是n次内循环后n降低到0,直接return false.</span></span><br><span class="line"><span class="comment">//e.从b-d任何一次内循环在最后发现了task结束,立即返回false</span></span><br><span class="line"><span class="comment">//否则,它可能在某一次内循环中弹出并执行了该任务,却可能一直在等待它完成,因此这个机制可以让等待task完成前,</span></span><br><span class="line"><span class="comment">//帮助当前WorkQueue清理顶部无效任务等操作.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//如果task存在,则将它从队列中移除并执行,发现有位于顶部的取消任务,则移除之,只用于awaitJoin</span></span><br><span class="line"><span class="comment">//如果队列空并且任务不知道完成了,则返回true</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRemoveAndExec</span><span class="params">(ForkJoinTask&lt;?&gt; task)</span> </span>&#123;</span><br><span class="line">    ForkJoinTask&lt;?&gt;[] a; <span class="keyword">int</span> m, s, b, n;</span><br><span class="line">    <span class="comment">//进入if的条件,存在非空任务数组,参数task非空</span></span><br><span class="line">    <span class="keyword">if</span> ((a = array) != <span class="keyword">null</span> &amp;&amp; (m = a.length - <span class="number">1</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">        task != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//循环条件,队列非空.从s开始遍历到b,也就是从顶到底.后进先出</span></span><br><span class="line">        <span class="keyword">while</span> ((n = (s = top) - (b = base)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//1.内层循环.</span></span><br><span class="line">            <span class="keyword">for</span> (ForkJoinTask&lt;?&gt; t;;) &#123;</span><br><span class="line">                <span class="comment">//2.从顶开始的索引j,每次向下找一个.    </span></span><br><span class="line">                <span class="keyword">long</span> j = ((--s &amp; m) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">                <span class="keyword">if</span> ((t = (ForkJoinTask&lt;?&gt;)U.getObject(a, j)) == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//3.取出的是空,返回值取决于top是不是内层循环是第一次运行</span></span><br><span class="line">                    <span class="comment">//外循环每次会将s更新为新top,</span></span><br><span class="line">                    <span class="comment">//内循环则会每次将s减一.内循环只跑了一次的情况,显然会返回true</span></span><br><span class="line">                    <span class="comment">//显然这种情况下top也没有被其他线程更新</span></span><br><span class="line">                    <span class="comment">//内循环又是第一次跑,那么将足以说明当前队列为空,该为false</span></span><br><span class="line">                    <span class="comment">//true的情况,向下遍历了几个元素打到了底</span></span><br><span class="line">                    <span class="comment">//未进入46 10这三种要重开启一轮外循环的情况,也没找到task.</span></span><br><span class="line">                    <span class="comment">//不管怎样,发现空任务就返回</span></span><br><span class="line">                    <span class="keyword">return</span> s + <span class="number">1</span> == top;<span class="comment">// 比预期短,第一个或第n个出现了空值,但循环条件未false</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (t == task) &#123;</span><br><span class="line">                    <span class="comment">//找到的任务t不是空,且是目标任务</span></span><br><span class="line">                    <span class="keyword">boolean</span> removed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (s + <span class="number">1</span> == top) &#123;</span><br><span class="line">                        <span class="comment">//4.发现是首轮内循环,s+1==top成立,进行pop操作,将task弹出并将top减一</span></span><br><span class="line">                        <span class="comment">//显然,task是最顶任务,可以用pop方式,将它置空</span></span><br><span class="line">                        <span class="keyword">if</span> (U.compareAndSwapObject(a, j, task, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                            U.putOrderedInt(<span class="keyword">this</span>, QTOP, s);</span><br><span class="line">                            <span class="comment">//5.置removed为true.</span></span><br><span class="line">                            removed = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//6.不是首轮循环,而且base没有在处理期间发生改变</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (base == b) </span><br><span class="line">                        <span class="comment">//7.尝试将task替换成一个EmptyTask实例.成功则removed是true</span></span><br><span class="line">                        <span class="comment">//这样虽然该任务出了队,但在队上还有一个空的任务,而不会出现前面担心的中间null</span></span><br><span class="line">                        <span class="comment">//的情况,也不改变top或base的值</span></span><br><span class="line">                        removed = U.compareAndSwapObject(</span><br><span class="line">                        a, j, task, <span class="keyword">new</span> EmptyTask());</span><br><span class="line">                    <span class="keyword">if</span> (removed)</span><br><span class="line">                        <span class="comment">//8.只要任务成功出队(不论是4还是7,则执行</span></span><br><span class="line">                        task.doExec();</span><br><span class="line">                    <span class="comment">//9.只要找到任务,退出内循环,回到外循环重置相应的条件</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//10.本轮内循环没找到匹配task的任务.</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (t.status &lt; <span class="number">0</span> &amp;&amp; s + <span class="number">1</span> == top) &#123;<span class="comment">//官方注释是取消</span></span><br><span class="line">                    <span class="comment">//11.若t是完成的任务且是首轮内循环且top未变动,将该任务出队并令top减一</span></span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapObject(a, j, t, <span class="keyword">null</span>))</span><br><span class="line">                        U.putOrderedInt(<span class="keyword">this</span>, QTOP, s);</span><br><span class="line">                    <span class="comment">//12.只要进入此分支就退出内循环</span></span><br><span class="line">                    <span class="keyword">break</span>; </span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (--n == <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//13.内循环每执行到此一次,就说明有一次没找到目标任务</span></span><br><span class="line">                    <span class="comment">//减少n(开始时的base top差值).达0时返回false停止循环</span></span><br><span class="line">                    <span class="comment">//即每个内循环都只能执行n次,进入外循环时重置n</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//14.结束了任何一轮内循环时,发现目标task已经完成,则停止外循环返回false</span></span><br><span class="line">            <span class="keyword">if</span> (task.status &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//15.task参数传空,或者当前WorkQueue没有任务,直接返回true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="popCC"><a href="#popCC" class="headerlink" title="popCC"></a>popCC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//此方法适用于不论共享或者独有的模式,只在helpComplete时使用.</span></span><br><span class="line"><span class="comment">//它会弹出和task相同的CountedCompleter,在前一节讲解CountedCompleter时已介绍过此方法</span></span><br><span class="line"><span class="comment">//父Completer仅能在栈链上找到它的父和祖先completer并帮助减挂起任务数或完成root,但在此处</span></span><br><span class="line"><span class="comment">//它可以帮助栈链上的前置(子任务),前提是要popCC弹出.</span></span><br><span class="line"><span class="keyword">final</span> CountedCompleter&lt;?&gt; popCC(CountedCompleter&lt;?&gt; task, <span class="keyword">int</span> mode) &#123;</span><br><span class="line">    <span class="keyword">int</span> s; ForkJoinTask&lt;?&gt;[] a; Object o;</span><br><span class="line">    <span class="comment">//当前队列有元素.</span></span><br><span class="line">    <span class="keyword">if</span> (base - (s = top) &lt; <span class="number">0</span> &amp;&amp; (a = array) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//老逻辑从顶部确定j.</span></span><br><span class="line">        <span class="keyword">long</span> j = (((a.length - <span class="number">1</span>) &amp; (s - <span class="number">1</span>)) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">        <span class="keyword">if</span> ((o = U.getObjectVolatile(a, j)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            (o <span class="keyword">instanceof</span> CountedCompleter)) &#123;</span><br><span class="line">            <span class="comment">//当前队列中存在类型为CountedCompleter的元素.对该completer栈链开启一个循环</span></span><br><span class="line">            CountedCompleter&lt;?&gt; t = (CountedCompleter&lt;?&gt;)o;</span><br><span class="line">            <span class="keyword">for</span> (CountedCompleter&lt;?&gt; r = t;;) &#123;</span><br><span class="line">                <span class="comment">//对该CountedCompleter及它的completer栈元素进行遍历,每一个遍历到的临时存放r.</span></span><br><span class="line">                <span class="comment">//找到r==task,说明有一个completer位于task的执行路径.</span></span><br><span class="line">                <span class="keyword">if</span> (r == task) &#123;</span><br><span class="line">                    <span class="comment">//mode小于0,这个mode其实有误解性</span></span><br><span class="line">                    <span class="comment">//它的调用者其实是将一个WorkQueue的config传给了这个mode.</span></span><br><span class="line">                    <span class="comment">//而config只有两处初始化,一是将线程注册到池的时候,初始化WorkQueue</span></span><br><span class="line">                    <span class="comment">//二是外部提交的任务,使用externalSubmit时新建的WorkQueue</span></span><br><span class="line">                    <span class="comment">//config会是负值且没有owner</span></span><br><span class="line">                    <span class="comment">//它也说明是共享队列,需要有锁定机制</span></span><br><span class="line">                    <span class="keyword">if</span> (mode &lt; <span class="number">0</span>) &#123; </span><br><span class="line">                        <span class="comment">//另一个字段qlock派上了用场,将它置为1表示加锁</span></span><br><span class="line">                        <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, QLOCK, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                            <span class="comment">//加锁成功,在top和array这过程中未发生变动的情况下,尝试</span></span><br><span class="line">                            <span class="comment">//将t出队,此时t是栈顶上的元素,它的completer栈链前方有task</span></span><br><span class="line">                            <span class="keyword">if</span> (top == s &amp;&amp; array == a &amp;&amp;</span><br><span class="line">                                U.compareAndSwapObject(a, j, t, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                                U.putOrderedInt(<span class="keyword">this</span>, QTOP, s - <span class="number">1</span>);</span><br><span class="line">                                U.putOrderedInt(<span class="keyword">this</span>, QLOCK, <span class="number">0</span>);</span><br><span class="line">                                <span class="keyword">return</span> t;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//不论出队成功还是失败,解锁</span></span><br><span class="line">                            U.compareAndSwapInt(<span class="keyword">this</span>, QLOCK, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//非共享队列,直接将t出列</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapObject(a, j, t, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                        U.putOrderedInt(<span class="keyword">this</span>, QTOP, s - <span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">return</span> t;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//只要找到,哪怕两处cas出现不成功的情况,也是竞态失败,break终止循环</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//r不等于task,找出r的父并开始下轮循环,直到root或找到task为止</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((r = r.completer) == <span class="keyword">null</span>) <span class="comment">// try parent</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//空队列,顶部不是Completer或者不是task的子任务,返回null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="pollAndExecCC"><a href="#pollAndExecCC" class="headerlink" title="pollAndExecCC"></a>pollAndExecCC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试在无竞态下偷取此WorkQueue中与给定task处于同一个completer栈链上的任务并运行它</span></span><br><span class="line"><span class="comment">//若不成功,返回一个校验合/控制信号给调用它的helpComplete方法</span></span><br><span class="line"><span class="comment">//返回规则,成功偷取则返回1;返回2代表可重试(被其他小偷击败),如果队列非空但未找到匹配task,返回-1</span></span><br><span class="line"><span class="comment">//其他情况返回一个强制负的基准索引.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">pollAndExecCC</span><span class="params">(CountedCompleter&lt;?&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> b, h; ForkJoinTask&lt;?&gt;[] a; Object o;</span><br><span class="line">    <span class="keyword">if</span> ((b = base) - top &gt;= <span class="number">0</span> || (a = array) == <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">//空队列,与最小整数(负值)取或作为信号h</span></span><br><span class="line">        h = b | Integer.MIN_VALUE;  <span class="comment">// to sense movement on re-poll</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//从底部取索引j</span></span><br><span class="line">        <span class="keyword">long</span> j = (((a.length - <span class="number">1</span>) &amp; b) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">        <span class="comment">//用该索引取task取出null,说明被捷足先登了,信号置为可重试</span></span><br><span class="line">        <span class="keyword">if</span> ((o = U.getObjectVolatile(a, j)) == <span class="keyword">null</span>)</span><br><span class="line">            h = <span class="number">2</span>;                  <span class="comment">// retryable</span></span><br><span class="line">        <span class="comment">//取出的非空任务类型不是CountedCompleter.说明不匹配,信号-1</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> CountedCompleter))</span><br><span class="line">            h = -<span class="number">1</span>;                 <span class="comment">// unmatchable</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//是CountedCompleter类型</span></span><br><span class="line">            CountedCompleter&lt;?&gt; t = (CountedCompleter&lt;?&gt;)o;</span><br><span class="line">            <span class="keyword">for</span> (CountedCompleter&lt;?&gt; r = t;;) &#123;</span><br><span class="line">                <span class="comment">//基本同上个方法的逻辑,只是上个方法t取的是top,这里取base.</span></span><br><span class="line">                <span class="comment">//r从t开始找它的父,直到它本身或它的父等于task.将它从底端出队.</span></span><br><span class="line">                <span class="keyword">if</span> (r == task) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (base == b &amp;&amp;</span><br><span class="line">                        U.compareAndSwapObject(a, j, t, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                        <span class="comment">//出队成功,因为我们找的是base,且竞态成功,直接更新base即可</span></span><br><span class="line">                        base = b + <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">//出队后执行该出队的任务.返回1代表成功</span></span><br><span class="line">                        t.doExec();</span><br><span class="line">                        h = <span class="number">1</span>;      <span class="comment">// success</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//base被其他线程修改了,或者cas竞态失败.(其实是一个情况),信号2</span></span><br><span class="line">                    <span class="comment">//可以从新的base开始重试.</span></span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        h = <span class="number">2</span>;      <span class="comment">// lost CAS</span></span><br><span class="line">                    <span class="comment">//只要找到task的子任务就break,返回竞态成功或可重试的信号</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//迭代函数,当前r不是task,将r指向它的父,直到某一个r的父是task或者是null进入else if</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((r = r.completer) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//能够进来,说明r已经指向了root,却没有找到整条链上有这个task,返回信号为未匹配到</span></span><br><span class="line">                    h = -<span class="number">1</span>;         <span class="comment">// unmatched</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="isApparentlyUnblocked"><a href="#isApparentlyUnblocked" class="headerlink" title="isApparentlyUnblocked"></a>isApparentlyUnblocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果当前线程拥有此队列且明显未被锁定,返回true</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isApparentlyUnblocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread wt; Thread.State s;</span><br><span class="line">    <span class="comment">//前面提过的scanState会在一上来runTask时和1的反码取与运算,直到运行完任务才会反向运算</span></span><br><span class="line">    <span class="comment">//这个过程,scanState的最后一位会置0,但这与此判断条件关系不大</span></span><br><span class="line">    <span class="comment">//前面对scanState有所注释,小于0代表不活跃</span></span><br><span class="line">    <span class="keyword">return</span> (scanState &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">            <span class="comment">//队列处于活跃态且当前线程的状态不是阻塞,不是等待,不是定时等待,则返回true</span></span><br><span class="line">            (wt = owner) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            (s = wt.getState()) != Thread.State.BLOCKED &amp;&amp;</span><br><span class="line">            s != Thread.State.WAITING &amp;&amp;</span><br><span class="line">            s != Thread.State.TIMED_WAITING);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.规避了伪共享</p><p>&emsp;&emsp;2.使用<code>scanState</code>表示运行的状态，版本号。小于0表示：不活跃维护了忙碌标记。忙碌(偶数)，取消忙碌(奇数)。</p><p>&emsp;&emsp;3.维护了可变的数组，以及base-top,任务压入队列以后进行数组的容量检测，进行数组的容量扩容，并且保证扩容后元素的索引保持不变。</p><p>&emsp;&emsp;4.维护了任务窃取的记录和个数，在溢出等情况及时的累加给线程池。</p><p>&emsp;&emsp;5.维护了队列锁，在<code>popCC</code>且当前为共享队列的情形下使用。保证争抢的同步。</p><h2 id="ForkJoinPool详解"><a href="#ForkJoinPool详解" class="headerlink" title="ForkJoinPool详解"></a>ForkJoinPool详解</h2><p><img src="/image/hexo/image-20200719215142068.png" alt="image-20200719215142068"></p><h3 id="类声明-3"><a href="#类声明-3" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@sun</span>.misc.Contended</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinPool</span> <span class="keyword">extends</span> <span class="title">AbstractExecutorService</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数-2"><a href="#构造函数-2" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">ForkJoinPool f1 = <span class="keyword">new</span> ForkJoinPool();</span><br><span class="line">ForkJoinPool f2 = ForkJoinPool.commonPool();</span><br><span class="line"><span class="comment">//parallelism并行级别、默认为CPU核心数</span></span><br><span class="line">ForkJoinPool f3 = <span class="keyword">new</span> ForkJoinPool(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parallelism      并行级别, 默认为CPU核心数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> factory          工作线程工厂</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> handler          异常处理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mode        调度模式: true表示FIFO_QUEUE; false表示LIFO_QUEUE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> workerNamePrefix 工作线程的名称前缀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ForkJoinPool</span><span class="params">(<span class="keyword">int</span> parallelism, ForkJoinWorkerThreadFactory factory, UncaughtExceptionHandler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> mode, String workerNamePrefix)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.workerNamePrefix = workerNamePrefix;</span><br><span class="line">    <span class="keyword">this</span>.factory = factory;</span><br><span class="line">    <span class="keyword">this</span>.ueh = handler;</span><br><span class="line">    <span class="keyword">this</span>.config = (parallelism &amp; SMASK) | mode;</span><br><span class="line">    <span class="keyword">long</span> np = (<span class="keyword">long</span>) (-parallelism); <span class="comment">// offset ctl counts</span></span><br><span class="line">    <span class="keyword">this</span>.ctl = ((np &lt;&lt; AC_SHIFT) &amp; AC_MASK) | ((np &lt;&lt; TC_SHIFT) &amp; TC_MASK);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>parallelism</strong>：默认值为CPU核心数，ForkJoinPool里工作线程数量与该参数有关，但它不表示最大线程数；</li><li><strong>factory</strong>：工作线程工厂，默认是DefaultForkJoinWorkerThreadFactory，其实就是用来创建工作线程对象——ForkJoinWorkerThread；</li><li><strong>handler</strong>：异常处理器；</li><li><strong>config</strong>：保存parallelism和mode信息，供后续读取；</li><li><strong>ctl</strong>：线程池的核心控制字段</li></ul><p>这些入参目前不用关注，我们重点是<code>mode</code>这个字段，ForkJoinPool支持两种模式：</p><ol><li>同步模式（默认方式）：对于工作线程（Worker）自身队列中的任务，采用<strong>后进先出（LIFO）</strong>的方式执行</li><li>异步模式：对于工作线程（Worker）自身队列中的任务，采用<strong>先进先出（FIFO）</strong>的方式执行</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mode  &#x3D; asyncMode ? FIFO_QUEUE : LIFO_QUEUE</span><br></pre></td></tr></table></figure><h3 id="Executors构建"><a href="#Executors构建" class="headerlink" title="Executors构建"></a>Executors构建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Executors方法,显然ForkJoinPool被称作工作窃取线程池.参数指定了并行度.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newWorkStealingPool</span><span class="params">(<span class="keyword">int</span> parallelism)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ForkJoinPool</span><br><span class="line">        (parallelism,</span><br><span class="line">        <span class="comment">//默认线程工厂,前文中已提过默认的ForkJoinWorkerThread</span></span><br><span class="line">         ForkJoinPool.defaultForkJoinWorkerThreadFactory,</span><br><span class="line">         <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//不提供并行度.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newWorkStealingPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ForkJoinPool</span><br><span class="line">        <span class="comment">//使用所有可用的处理器</span></span><br><span class="line">        (Runtime.getRuntime().availableProcessors(),</span><br><span class="line">         ForkJoinPool.defaultForkJoinWorkerThreadFactory,</span><br><span class="line">         <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//对应的,ForkJoinPool的构造器们.</span></span><br><span class="line"><span class="comment">//不指定任何参数.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ForkJoinPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//并行度取MAX_CAP和可用处理器数的最小值.</span></span><br><span class="line">    <span class="keyword">this</span>(Math.min(MAX_CAP, Runtime.getRuntime().availableProcessors()),</span><br><span class="line">        <span class="comment">//默认的线程工厂.无异常处理器,非异步模式.</span></span><br><span class="line">         defaultForkJoinWorkerThreadFactory, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//同上,只是使用参数中的并行度.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ForkJoinPool</span><span class="params">(<span class="keyword">int</span> parallelism)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(parallelism, defaultForkJoinWorkerThreadFactory, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ForkJoinPool</span><span class="params">(<span class="keyword">int</span> parallelism,</span></span></span><br><span class="line"><span class="function"><span class="params">                    ForkJoinWorkerThreadFactory factory,</span></span></span><br><span class="line"><span class="function"><span class="params">                    UncaughtExceptionHandler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">boolean</span> asyncMode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//并行度需要校验</span></span><br><span class="line">    <span class="keyword">this</span>(checkParallelism(parallelism),</span><br><span class="line">        <span class="comment">//校验线程工厂</span></span><br><span class="line">         checkFactory(factory),</span><br><span class="line">        <span class="comment">//参数指定的未捕获异常处理器.</span></span><br><span class="line">         handler,</span><br><span class="line">        <span class="comment">//前面的几处代码asyncMode都是false,会选用LIFO队列,是true是会选用FIFO队列,后面详述.</span></span><br><span class="line">         asyncMode ? FIFO_QUEUE : LIFO_QUEUE,</span><br><span class="line">        <span class="comment">//线程名前缀</span></span><br><span class="line">         <span class="string">"ForkJoinPool-"</span> + nextPoolId() + <span class="string">"-worker-"</span>);</span><br><span class="line">    <span class="comment">//检查许可,不关心.</span></span><br><span class="line">    checkPermission();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查方法很简单.</span></span><br><span class="line"><span class="comment">//并行度不能大于MAX_CAP不能不大于0.</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">checkParallelism</span><span class="params">(<span class="keyword">int</span> parallelism)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parallelism &lt;= <span class="number">0</span> || parallelism &gt; MAX_CAP)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">return</span> parallelism;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//线程工厂非空即可.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ForkJoinWorkerThreadFactory checkFactory</span><br><span class="line">    (ForkJoinWorkerThreadFactory factory) &#123;</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//最终构造器,私有.待介绍完一些基础字段后再述.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ForkJoinPool</span><span class="params">(<span class="keyword">int</span> parallelism,</span></span></span><br><span class="line"><span class="function"><span class="params">                     ForkJoinWorkerThreadFactory factory,</span></span></span><br><span class="line"><span class="function"><span class="params">                     UncaughtExceptionHandler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> mode,</span></span></span><br><span class="line"><span class="function"><span class="params">                     String workerNamePrefix)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.workerNamePrefix = workerNamePrefix;</span><br><span class="line">    <span class="keyword">this</span>.factory = factory;</span><br><span class="line">    <span class="keyword">this</span>.ueh = handler;</span><br><span class="line">    <span class="comment">//config初始化值,用并行度与mode取或,显然mode是FIFO时,将有一个第17位的1.</span></span><br><span class="line">    <span class="keyword">this</span>.config = (parallelism &amp; SMASK) | mode;</span><br><span class="line">    <span class="comment">//np保存并行度(正数)的相反数(补码).</span></span><br></pre></td></tr></table></figure><h3 id="线程工厂"><a href="#线程工厂" class="headerlink" title="线程工厂"></a>线程工厂</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ForkJoinWorkerThread的线程工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">ForkJoinWorkerThreadFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建新线程要实现的方法.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ForkJoinWorkerThread <span class="title">newThread</span><span class="params">(ForkJoinPool pool)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//前面看到的默认线程工厂</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultForkJoinWorkerThreadFactory</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ForkJoinWorkerThreadFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ForkJoinWorkerThread <span class="title">newThread</span><span class="params">(ForkJoinPool pool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ForkJoinWorkerThread(pool);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//创建InnocuousForkJoinWorkerThread的线程工厂,上一文已经介绍过</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InnocuousForkJoinWorkerThreadFactory</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ForkJoinWorkerThreadFactory</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AccessControlContext innocuousAcc;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        Permissions innocuousPerms = <span class="keyword">new</span> Permissions();</span><br><span class="line">        innocuousPerms.add(modifyThreadPermission);</span><br><span class="line">        innocuousPerms.add(<span class="keyword">new</span> RuntimePermission(</span><br><span class="line">                               <span class="string">"enableContextClassLoaderOverride"</span>));</span><br><span class="line">        innocuousPerms.add(<span class="keyword">new</span> RuntimePermission(</span><br><span class="line">                               <span class="string">"modifyThreadGroup"</span>));</span><br><span class="line">        innocuousAcc = <span class="keyword">new</span> AccessControlContext(<span class="keyword">new</span> ProtectionDomain[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ProtectionDomain(<span class="keyword">null</span>, innocuousPerms)</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ForkJoinWorkerThread <span class="title">newThread</span><span class="params">(ForkJoinPool pool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (ForkJoinWorkerThread.InnocuousForkJoinWorkerThread)</span><br><span class="line">            java.security.AccessController.doPrivileged(</span><br><span class="line">                <span class="keyword">new</span> java.security.PrivilegedAction&lt;ForkJoinWorkerThread&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> ForkJoinWorkerThread <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ForkJoinWorkerThread.</span><br><span class="line">                        InnocuousForkJoinWorkerThread(pool);</span><br><span class="line">                &#125;&#125;, innocuousAcc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//空任务</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EmptyTask</span> <span class="keyword">extends</span> <span class="title">ForkJoinTask</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7721805057305804111L</span>;</span><br><span class="line">    EmptyTask() &#123; status = ForkJoinTask.NORMAL; &#125; <span class="comment">//状态直接是已正常完成.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Void <span class="title">getRawResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setRawResult</span><span class="params">(Void x)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">exec</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">true</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 与边界有关的常量</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SMASK        = <span class="number">0xffff</span>;        <span class="comment">// 后16位.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_CAP      = <span class="number">0x7fff</span>;        <span class="comment">// 前面在定并行度时参考的最大容量.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EVENMASK     = <span class="number">0xfffe</span>;        <span class="comment">// 后16位验偶数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SQMASK       = <span class="number">0x007e</span>;        <span class="comment">// 最大64个偶数槽,从第2位至7位共6位,2的6次方.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 与WorkQueue有关</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SCANNING     = <span class="number">1</span>;             <span class="comment">// 对WorkQueue正在运行任务的标记</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INACTIVE     = <span class="number">1</span> &lt;&lt; <span class="number">31</span>;       <span class="comment">// 标记负数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SS_SEQ       = <span class="number">1</span> &lt;&lt; <span class="number">16</span>;       <span class="comment">// 版本号使用,第17位1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ForkJoinPool和WorkQueue的config有关常量.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_MASK    = <span class="number">0xffff</span> &lt;&lt; <span class="number">16</span>;  <span class="comment">// 能滤取前16位.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LIFO_QUEUE   = <span class="number">0</span>;<span class="comment">//前面提到过的,非async模式(false),值取0.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIFO_QUEUE   = <span class="number">1</span> &lt;&lt; <span class="number">16</span>;<span class="comment">//async模式(true),值取1.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHARED_QUEUE = <span class="number">1</span> &lt;&lt; <span class="number">31</span>;       <span class="comment">// 共享队列标识,符号位表示负.</span></span><br></pre></td></tr></table></figure><h3 id="提交任务"><a href="#提交任务" class="headerlink" title="提交任务"></a>提交任务</h3><h4 id="invoke-1"><a href="#invoke-1" class="headerlink" title="invoke"></a>invoke</h4><p>&emsp;&emsp;同步方法：调用线程等待任务执行完毕才会返回。</p><h4 id="execute"><a href="#execute" class="headerlink" title="execute"></a>execute</h4><p>&emsp;&emsp;异步方法：调用线程立即返回且没有返回值。</p><h4 id="submit"><a href="#submit" class="headerlink" title="submit"></a>submit</h4><p>&emsp;&emsp;异步方法：调用线程立即返回且有返回值（<code>Future</code>）。</p><h3 id="方法-2"><a href="#方法-2" class="headerlink" title="方法"></a>方法</h3><h4 id="lockRunState"><a href="#lockRunState" class="headerlink" title="lockRunState"></a>lockRunState</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试对runState进行加锁操作</span></span><br><span class="line"><span class="comment">//runState：原值或者新值(竞态且成功)</span></span><br><span class="line"><span class="comment">//简单来说：锁住runState</span></span><br><span class="line"><span class="comment">//标志位设置为1：尝试lock的线程可以更改runState的信号位等</span></span><br><span class="line"><span class="comment">//lockRunState成功的线程则是去更改ctl控制信号、工作队列等</span></span><br><span class="line"><span class="comment">//runState也可以称为：运行状态锁</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">lockRunState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rs;</span><br><span class="line">    <span class="comment">//runState为奇数、表示已经上锁进入awaitRunStateLock</span></span><br><span class="line">    <span class="keyword">return</span> ((((rs = runState) &amp; RSLOCK) != <span class="number">0</span> ||</span><br><span class="line">             <span class="comment">//否则尝试进行CAS：rs+1更改为奇数</span></span><br><span class="line">             !U.compareAndSwapInt(<span class="keyword">this</span>, RUNSTATE, rs, rs |= RSLOCK)) ?</span><br><span class="line">            <span class="comment">//runState已经锁住或者CAS更新rs失败进入awaitRunStateLock等待加锁成功</span></span><br><span class="line">            <span class="comment">//否则返回rs</span></span><br><span class="line">            awaitRunStateLock() : rs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="awaitRunStateLock"><a href="#awaitRunStateLock" class="headerlink" title="awaitRunStateLock"></a>awaitRunStateLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要自旋或者进行阻塞等待runState锁可用</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">awaitRunStateLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object lock;</span><br><span class="line">    <span class="keyword">boolean</span> wasInterrupted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> spins = SPINS, r = <span class="number">0</span>, rs, ns;;) &#123;</span><br><span class="line">        <span class="comment">//进入循环再次重新读取rs</span></span><br><span class="line">        <span class="keyword">if</span> (((rs = runState) &amp; RSLOCK) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//rs依旧还是偶数、CAS尝试设置其为奇数、主要为了锁定runState</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, RUNSTATE, rs, ns = rs | RSLOCK)) &#123;</span><br><span class="line">                <span class="comment">//锁成功以后发现了扰动</span></span><br><span class="line">                <span class="comment">//打断当前线程</span></span><br><span class="line">                <span class="keyword">if</span> (wasInterrupted) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//返回一个新的runState、奇数</span></span><br><span class="line">                <span class="comment">//表示已经锁住唯一的出口、也说明了一定要拿到锁</span></span><br><span class="line">                <span class="keyword">return</span> ns;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//被锁住或者出现了CAS竞争失败</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (r == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//循环中仅此执行一次</span></span><br><span class="line">            <span class="comment">//nextSecondarySeed主要是生成一个伪随机码不会返回0</span></span><br><span class="line">            <span class="comment">//其中r的初始值为0</span></span><br><span class="line">            r = ThreadLocalRandom.nextSecondarySeed();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (spins &gt; <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">//将r的值进行一些转换并开启下轮循环.默认spins是0,不会有自旋次数</span></span><br><span class="line">            <span class="comment">//从源码来看,自旋的唯一作用就是改变r的值,使之可能重新进入</span></span><br><span class="line">            <span class="comment">//也会根据r的结果决定是否减少一次自旋.</span></span><br><span class="line">            <span class="comment">//r的算法,将当前r的后6位保留,用r的后26位与前26位异或被保存为r的前26位(a)</span></span><br><span class="line">            <span class="comment">//再将(a)的结果处理,r的前21位保持不变,后11位与前11位异或并保存为r的后11位(b)</span></span><br><span class="line">            <span class="comment">//再将(b)的结果处理,r的后7位保持不变,用前25位与后25位异或并保存为r的前25位(c)</span></span><br><span class="line">            <span class="comment">//个中数学原理,有兴趣的研究一下吧</span></span><br><span class="line">            <span class="comment">//显然,自旋次数并不是循环次数,它只能决定进入6中锁代码块前要运行至少几轮循环</span></span><br><span class="line">            r ^= r &lt;&lt; <span class="number">6</span>; r ^= r &gt;&gt;&gt; <span class="number">21</span>; r ^= r &lt;&lt; <span class="number">7</span>; <span class="comment">// xorshift</span></span><br><span class="line">            <span class="keyword">if</span> (r &gt;= <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//r依旧大于等于0则自旋次数-1</span></span><br><span class="line">                --spins;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//r不为0，</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((rs &amp; STARTED) == <span class="number">0</span> || (lock = stealCounter) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//线程的runState还没有开启或者说还没有初始化锁stealCounter</span></span><br><span class="line">            <span class="comment">//处于了初始化的竞态让出当前线程的执行去</span></span><br><span class="line">            <span class="comment">//再次获取到执行权、重新进入循环</span></span><br><span class="line">            Thread.yield();   <span class="comment">// initialization race</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, RUNSTATE, rs, rs | RSIGNAL)) &#123;</span><br><span class="line">        <span class="comment">//没能对runState加锁,也不是5中的初始化时竞态的情况,尝试加上信号位</span></span><br><span class="line">            <span class="comment">//以stealCounter进行加锁.</span></span><br><span class="line">            <span class="comment">//显然,这种加信号位的加法不会因为信号位而失败而会因为runState的其他字段比如锁标识位失败              //重新开始循环即可</span></span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="comment">//double check</span></span><br><span class="line">                <span class="keyword">if</span> ((runState &amp; RSIGNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//runState拥有信号位的值</span></span><br><span class="line">                    <span class="comment">//说明没有线程去释放信号位</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                      <span class="comment">//runState期间没有被除去信号位陷入等待</span></span><br><span class="line">                        lock.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                        <span class="comment">//等待中出现了异常情况、会中断线程</span></span><br><span class="line">                        <span class="keyword">if</span> (!(Thread.currentThread() <span class="keyword">instanceof</span></span><br><span class="line">                              ForkJoinWorkerThread))</span><br><span class="line">                            wasInterrupted = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">//当前的runState没有信号位的值</span></span><br><span class="line">                    <span class="comment">//说明已经被释放了、唤醒等待的同步块里面的线程</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    lock.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.主要针对<code>runState</code>操作，对该字段进行标识。严格意义上来讲，这是为了<code>ctl\工作队列</code>等运行时数据服务的。对运行时数据的修改权限加锁。</p><p>&emsp;&emsp;2.加锁的过程：自旋+阻塞的方式，如果线程池还处于初始话状态则让出执行权。</p><p>&emsp;&emsp;3.同时也设定了自旋的次数,使用随机数判断是否需要减少自旋次数，其降低为0之前不会阻塞。</p><p>&emsp;&emsp;4.加锁的流程主要是进行了一轮又一轮的循环，尝试去设置锁标志位，修改成功返回新的标识，否则去修改信号位（原子性操作）。唯一可能失败的主要是<code>runState</code>的其他位发生了改变，并且很可能是因为锁标识位被释放的缘故。</p><p>&emsp;&emsp;5.如果没有其他的线程竞争去修改<code>runState</code>,那么直接CAS可以成功，并且不需要唤醒其他的线程。否则CAS尝试失败，那么直接暴力重置了<code>newState</code>并且唤醒阻塞的线程。</p><h4 id="createWorker"><a href="#createWorker" class="headerlink" title="createWorker"></a>createWorker</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试工作线程的构建和开启</span></span><br><span class="line"><span class="comment">//它假定已经有别处维护了预留的增加总数</span></span><br><span class="line"><span class="comment">//创建和启动过程中出现任何异常,就执行工作线程的卸载</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">createWorker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//前面构造器传入的factory.</span></span><br><span class="line">    ForkJoinWorkerThreadFactory fac = factory;</span><br><span class="line">    Throwable ex = <span class="keyword">null</span>;</span><br><span class="line">    ForkJoinWorkerThread wt = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//创建线程成功</span></span><br><span class="line">        <span class="keyword">if</span> (fac != <span class="keyword">null</span> &amp;&amp; (wt = fac.newThread(<span class="keyword">this</span>)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//启动该线程.</span></span><br><span class="line">            wt.start();</span><br><span class="line">            <span class="comment">//启动也成功,返回true</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable rex) &#123;</span><br><span class="line">        <span class="comment">//出现异常,保存</span></span><br><span class="line">        ex = rex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//用前面的异常卸载</span></span><br><span class="line">    deregisterWorker(wt, ex);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tryAddWorker"><a href="#tryAddWorker" class="headerlink" title="tryAddWorker"></a>tryAddWorker</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试添加一个worker</span></span><br><span class="line"><span class="comment">//并在完成前增加ctl里面记录的数量(AC参数</span></span><br><span class="line"><span class="comment">//增加过程是否进行决定于createWorker返回的true还是false</span></span><br><span class="line"><span class="comment">//参数c是一个进入控制信号ctl</span></span><br><span class="line"><span class="comment">//它的总计数为负且没有空闲worker,cas(增加ctl)失败时,若ctl未改变,则可以刷新重试</span></span><br><span class="line"><span class="comment">//否则说明被添加了一个worker,那么它也就不需要再继续了</span></span><br><span class="line"><span class="comment">//从方法的实现上看,c似乎可以传任何值</span></span><br><span class="line"><span class="comment">//如果c传入的值不等于当前ctl,则会多一次循环重读ctl到c</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tryAddWorker</span><span class="params">(<span class="keyword">long</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//标记add成功与否</span></span><br><span class="line">    <span class="keyword">boolean</span> add = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//根据参数c生成一个新的ctrl/nc</span></span><br><span class="line">        <span class="comment">//c源自参数或者某一次循环读取的ctl.</span></span><br><span class="line">        <span class="comment">//nc的值计算结果:c加上一个活跃单位1&lt;&lt;48,并对结果保留前16位</span></span><br><span class="line">        <span class="comment">//c加上一个总数单位1&lt;&lt;32,并对结果保留第二个16位(33到48位)</span></span><br><span class="line">        <span class="comment">//nc等于上两步的结果和.显然,nc的后32位全部是0</span></span><br><span class="line">        <span class="keyword">long</span> nc = ((AC_MASK &amp; (c + AC_UNIT)) |</span><br><span class="line">                   (TC_MASK &amp; (c + TC_UNIT)));</span><br><span class="line">        <span class="comment">//ctl未改变</span></span><br><span class="line">        <span class="keyword">if</span> (ctl == c) &#123;</span><br><span class="line">            <span class="comment">//阻塞加锁并判断是否已在终止</span></span><br><span class="line">            <span class="keyword">int</span> rs, stop;                 <span class="comment">// check if terminating</span></span><br><span class="line">            <span class="keyword">if</span> ((stop = (rs = lockRunState()) &amp; STOP) == <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//加锁成功且未终止,尝试cas掉ctl.</span></span><br><span class="line">                add = U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, nc);</span><br><span class="line">            <span class="comment">//加锁成功,不论cas ctl是否成功,解锁</span></span><br><span class="line">            unlockRunState(rs, rs &amp; ~RSLOCK);</span><br><span class="line">            <span class="comment">//如果已stop,break退出添加worker的步骤</span></span><br><span class="line">            <span class="keyword">if</span> (stop != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (add) &#123;</span><br><span class="line">                <span class="comment">//加锁成功,cas也成功,线程池未进入终止流程,创建worker</span></span><br><span class="line">                createWorker();</span><br><span class="line">                <span class="comment">//创建成功立即break</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//这时为前32位发生了变化,只能在新一轮循环处理.注:ADD_WORKER位是第48位,前面已提到</span></span><br><span class="line">        <span class="comment">//它是TC_MASK能负责的最高位</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (((c = ctl) &amp; ADD_WORKER) != <span class="number">0L</span> &amp;&amp; (<span class="keyword">int</span>)c == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="registerWorker"><a href="#registerWorker" class="headerlink" title="registerWorker"></a>registerWorker</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将线程注册入池,同时返回一个WorkQueue,工作线程会在内部记录这个队列.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> WorkQueue <span class="title">registerWorker</span><span class="params">(ForkJoinWorkerThread wt)</span> </span>&#123;</span><br><span class="line">    UncaughtExceptionHandler handler;</span><br><span class="line">    <span class="comment">//设置成守护线程,这样保证用户线程都已释放的情况下关闭虚拟机</span></span><br><span class="line">    wt.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> ((handler = ueh) != <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">//构造器提供了异常处理器</span></span><br><span class="line">        wt.setUncaughtExceptionHandler(handler);</span><br><span class="line">    <span class="comment">//构建工作队列</span></span><br><span class="line">    WorkQueue w = <span class="keyword">new</span> WorkQueue(<span class="keyword">this</span>, wt);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>; </span><br><span class="line">    <span class="comment">//取出池config的17-32位保存为mode,</span></span><br><span class="line">    <span class="comment">//前面提过,config在构造时由并行度(后15位)和模式(第17位)表示,根据17位是否有值决定FIFO或LIFO</span></span><br><span class="line">    <span class="comment">//这个与运算进行后,相当于滤掉了并行度信息.                                 </span></span><br><span class="line">    <span class="keyword">int</span> mode = config &amp; MODE_MASK;</span><br><span class="line">    <span class="comment">//创建完队列之后要加锁,尤其后面涉及到可能的数组扩容拷贝,以及一些判断和重设随机数等</span></span><br><span class="line">    <span class="keyword">int</span> rs = lockRunState();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        WorkQueue[] ws; <span class="keyword">int</span> n;      </span><br><span class="line">        <span class="comment">//前面构造器我们看过,没有初始化workQueues,所以如果一个线程此时来注册是被忽略的</span></span><br><span class="line">        <span class="comment">//显然,使用它们的方法一定做了相应的保证.我们后续再看.              </span></span><br><span class="line">        <span class="keyword">if</span> ((ws = workQueues) != <span class="keyword">null</span> &amp;&amp; (n = ws.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//队列非空,递增种子.</span></span><br><span class="line">            <span class="comment">//indexSeed值是0,SEED_INCREMENT是每次相加的增量,它的值默认是0x9e3779b9(2654435769)</span></span><br><span class="line">            <span class="comment">//这是一个特殊的值,它的使用不仅此一处,后面稍微介绍.这样减少碰撞可能性</span></span><br><span class="line">            <span class="keyword">int</span> s = indexSeed += SEED_INCREMENT;  </span><br><span class="line">            <span class="keyword">int</span> m = n - <span class="number">1</span>;<span class="comment">//ws数组长度-1,数组长度一定是偶数(后面介绍)</span></span><br><span class="line">            i = ((s &lt;&lt; <span class="number">1</span>) | <span class="number">1</span>) &amp; m;<span class="comment">//奇数位i.</span></span><br><span class="line">            <span class="keyword">if</span> (ws[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//满足这个条件就是发生碰撞了,i已被占用.初始化probes为0</span></span><br><span class="line">                <span class="keyword">int</span> probes = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">//定义步长,数组长度不大于4,步长2,否则取n一半的第2至16位的结果(偶数)再加上2作为步长</span></span><br><span class="line">                <span class="keyword">int</span> step = (n &lt;= <span class="number">4</span>) ? <span class="number">2</span> : ((n &gt;&gt;&gt; <span class="number">1</span>) &amp; EVENMASK) + <span class="number">2</span>;</span><br><span class="line">                <span class="comment">//开启循环,每次对i加上步长并与m求与运算,直到无碰撞为止</span></span><br><span class="line">                <span class="keyword">while</span> (ws[i = (i + step) &amp; m] != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//每次循环增加probes,表示对同一个数组最多只循环n次,达到次数要进行扩容重试</span></span><br><span class="line">                    <span class="keyword">if</span> (++probes &gt;= n) &#123;</span><br><span class="line">                        <span class="comment">//当前数组已经尝试n次,还没有找到无碰撞点,扩容数组一倍,原位置拷贝</span></span><br><span class="line">                        <span class="comment">//此处没有任何加锁动作,与循环之外创建好队列之后的代码共享一个锁,也是lockRunState</span></span><br><span class="line">                        <span class="comment">//可见只有指派索引相关的动作才需要加锁.</span></span><br><span class="line">                        workQueues = ws = Arrays.copyOf(ws, n &lt;&lt;= <span class="number">1</span>);</span><br><span class="line">                        <span class="comment">//重置条件.</span></span><br><span class="line">                        m = n - <span class="number">1</span>;</span><br><span class="line">                        probes = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//s值保存给队列的hint作为随机数种子</span></span><br><span class="line">            <span class="comment">//可见,此处至少可说明每个注册线程时创建的队列都会有不同的hint,它也算是一个标识</span></span><br><span class="line">            w.hint = s;    </span><br><span class="line">            <span class="comment">//队列的配置,i与mode取或,mode只能是0或1&lt;&lt;16 </span></span><br><span class="line">            <span class="comment">//这个结果是将mode可能存放在队列config的17位,从而和池中的config在模式这一块保持一致.</span></span><br><span class="line">            <span class="comment">//i一定是一个不大于m(n-1)的奇数,而n一定不超过后16位(后面叙述),它和mode互不影响.  </span></span><br><span class="line">            <span class="comment">//故队列的config相当于同时保存了在池的workQueues数组的索引和所属池的FIFO或LIFO.                    </span></span><br><span class="line">            w.config = i | mode;</span><br><span class="line">            <span class="comment">//初始化scanState,以奇数i(索引)当值.相当于发布了初始屏障.</span></span><br><span class="line">            <span class="comment">//(不理解?参考runState方法,一上来就将它的末位置0成偶数)</span></span><br><span class="line">            w.scanState = i; </span><br><span class="line">            <span class="comment">//新建的队列置于i处.</span></span><br><span class="line">            ws[i] = w;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//解锁.</span></span><br><span class="line">        unlockRunState(rs, rs &amp; ~RSLOCK);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//线程名,这里看到一个有趣的事,无符号右移,i一定是个奇数,假定右移后的值是j,则2*j=i</span></span><br><span class="line">    wt.setName(workerNamePrefix.concat(Integer.toString(i &gt;&gt;&gt; <span class="number">1</span>)));</span><br><span class="line">    <span class="comment">//返回队列给线程</span></span><br><span class="line">    <span class="keyword">return</span> w;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="nextSecondarySeed"><a href="#nextSecondarySeed" class="headerlink" title="nextSecondarySeed"></a>nextSecondarySeed</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">nextSecondarySeed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    <span class="keyword">if</span> ((r = UNSAFE.getInt(t, SECONDARY)) != <span class="number">0</span>) &#123;</span><br><span class="line">        r ^= r &lt;&lt; <span class="number">13</span>;   <span class="comment">// xorshift</span></span><br><span class="line">        r ^= r &gt;&gt;&gt; <span class="number">17</span>;</span><br><span class="line">        r ^= r &lt;&lt; <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//原来secondary是0,localInit一个值.</span></span><br><span class="line">        localInit();</span><br><span class="line">        <span class="keyword">if</span> ((r = (<span class="keyword">int</span>)UNSAFE.getLong(t, SEED)) == <span class="number">0</span>)</span><br><span class="line">            r = <span class="number">1</span>; <span class="comment">// avoid zero</span></span><br><span class="line">    &#125;</span><br><span class="line">    UNSAFE.putInt(t, SECONDARY, r);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="localInit"><a href="#localInit" class="headerlink" title="localInit"></a>localInit</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//localInit</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">localInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//生成器是一个AtomicLong,从0开始,每次加入PROBE_INCREMENT.</span></span><br><span class="line">    <span class="keyword">int</span> p = probeGenerator.addAndGet(PROBE_INCREMENT);</span><br><span class="line">    <span class="keyword">int</span> probe = (p == <span class="number">0</span>) ? <span class="number">1</span> : p; <span class="comment">// skip 0</span></span><br><span class="line">    <span class="keyword">long</span> seed = mix64(seeder.getAndAdd(SEEDER_INCREMENT));</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    UNSAFE.putLong(t, SEED, seed);</span><br><span class="line">    UNSAFE.putInt(t, PROBE, probe);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//初值</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROBE_INCREMENT = <span class="number">0x9e3779b9</span></span><br></pre></td></tr></table></figure><h4 id="deregisterWorker"><a href="#deregisterWorker" class="headerlink" title="deregisterWorker"></a>deregisterWorker</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解除注册操作.它是一个要终止的工作线程的最终回调,或者创建失败时也会回调.在介绍ForkJoinWorkerThread和前面createWorker时提过.</span></span><br><span class="line"><span class="comment">//这会从数组中移除worker记录,调整数量.如果池已经处在关闭进行中,尝试帮助完成池的关闭.</span></span><br><span class="line"><span class="comment">//参数wt是工作线程,构建失败会是null,ex是造成失败的异常.它也可以是null.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">deregisterWorker</span><span class="params">(ForkJoinWorkerThread wt, Throwable ex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//处理队列从池的队列数组中的移除.</span></span><br><span class="line">    WorkQueue w = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (wt != <span class="keyword">null</span> &amp;&amp; (w = wt.workQueue) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//存在工作线程且该工作线程有队列的逻辑.</span></span><br><span class="line">        WorkQueue[] ws;            </span><br><span class="line">        <span class="comment">//前面说过,队列的config后16位表示索引,第17位表示mode.         </span></span><br><span class="line">        <span class="keyword">int</span> idx = w.config &amp; SMASK;</span><br><span class="line">        <span class="comment">//加运行时状态锁.</span></span><br><span class="line">        <span class="keyword">int</span> rs = lockRunState();</span><br><span class="line">        <span class="keyword">if</span> ((ws = workQueues) != <span class="keyword">null</span> &amp;&amp; ws.length &gt; idx &amp;&amp; ws[idx] == w)</span><br><span class="line">            <span class="comment">//简单的置空操作.</span></span><br><span class="line">            ws[idx] = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//解锁.</span></span><br><span class="line">        unlockRunState(rs, rs &amp; ~RSLOCK);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理控制信号中保存的数量.</span></span><br><span class="line">    <span class="keyword">long</span> c; </span><br><span class="line">    <span class="comment">//循环直到减数成功. 哪怕有别的线程在竞态减少,当前方法也要在新的ctl中减少数量                                    </span></span><br><span class="line">    <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (!U.compareAndSwapLong</span><br><span class="line">                 <span class="comment">//第49位减1.</span></span><br><span class="line">                 (<span class="keyword">this</span>, CTL, c = ctl, ((AC_MASK &amp; (c - AC_UNIT)) |</span><br><span class="line">                                       <span class="comment">//第33位减1.</span></span><br><span class="line">                                       (TC_MASK &amp; (c - TC_UNIT)) |</span><br><span class="line">                                       <span class="comment">//保留后32位.</span></span><br><span class="line">                                       (SP_MASK &amp; c))));</span><br><span class="line">    <span class="comment">//该工作线程有队列,且已经在1出了数组</span></span><br><span class="line">    <span class="keyword">if</span> (w != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//把队列锁设定负数.</span></span><br><span class="line">        w.qlock = -<span class="number">1</span>;                            </span><br><span class="line">        <span class="comment">//把队列中记录的偷取任务数加到池中.前面已论述过此方法</span></span><br><span class="line">        w.transferStealCount(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//取消队列中所有存活的任务.</span></span><br><span class="line">        w.cancelAll();                         </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//进入循环尝试帮助关闭池或释放阻塞线程,补偿线程等</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;                                   </span><br><span class="line">        WorkQueue[] ws; <span class="keyword">int</span> m, sp;</span><br><span class="line">        <span class="comment">// tryTerminate后面介绍,第一个参数true代表无条件立即结束,第二个参数true</span></span><br><span class="line">        <span class="comment">//代表下次tryTerminate将可以结束.</span></span><br><span class="line">        <span class="keyword">if</span> (tryTerminate(<span class="keyword">false</span>, <span class="keyword">false</span>) || w == <span class="keyword">null</span> || w.array == <span class="keyword">null</span> ||</span><br><span class="line">            (runState &amp; STOP) != <span class="number">0</span> || (ws = workQueues) == <span class="keyword">null</span> ||</span><br><span class="line">            (m = ws.length - <span class="number">1</span>) &lt; <span class="number">0</span>)              </span><br><span class="line">            <span class="comment">//进入if,说明正在结束或已结束,没什么可做的了.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//控制信号后32位有数值,进尝试释放逻辑.这不是第一次看到ctl的后32了.对于ctl的前32位,</span></span><br><span class="line">        <span class="comment">//我们已经通过构造函数和前面的代码说明,它初始化时与并行度有关,并在后面存放了添加worker数量</span></span><br><span class="line">        <span class="comment">//的值(但不能说存放了并行度,因为添加worker会改变相应的位),后32位的真相也开始浮出水面,</span></span><br><span class="line">        <span class="comment">//在前面的tryAddWorker中,第二轮及以后的循环条件要求后32位不能存在值.而且添加成功也会</span></span><br><span class="line">        <span class="comment">//将后32位置0,故tryAddWorker的第一轮循环会清空后32位,与此有所影响.</span></span><br><span class="line">        <span class="keyword">if</span> ((sp = (<span class="keyword">int</span>)(c = ctl)) != <span class="number">0</span>) &#123; </span><br><span class="line">            <span class="comment">//后32位有值,尝试release,tryRealease方法会将activeCount数量添加第三个参数的值</span></span><br><span class="line">            <span class="comment">//如果第二个参数代表的队列是空闲worker的栈顶,则释放其内的阻塞者</span></span><br><span class="line">            <span class="keyword">if</span> (tryRelease(c, ws[sp &amp; m], AC_UNIT))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//仅有此处释放失败的情况下,开启下一轮循环,其他分支均会退出循环.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ex != <span class="keyword">null</span> &amp;&amp; (c &amp; ADD_WORKER) != <span class="number">0L</span>) &#123;</span><br><span class="line">            <span class="comment">//此次解除注册是因为异常,且当前添加worker信号依旧满足,则添加一个worker代替原来并退出</span></span><br><span class="line">            tryAddWorker(c);                      </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="comment">// 不需要添加补偿worker,退出循环                             </span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ex == <span class="keyword">null</span>) </span><br><span class="line">        <span class="comment">//前面记录的异常不存在,帮助清理脏异常节点                             </span></span><br><span class="line">        ForkJoinTask.helpExpungeStaleExceptions();</span><br><span class="line">    <span class="keyword">else</span>   </span><br><span class="line">        <span class="comment">//存在异常,重抛.                                     </span></span><br><span class="line">        ForkJoinTask.rethrow(ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="signalWork"><a href="#signalWork" class="headerlink" title="signalWork"></a>signalWork</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果当前活跃线程数过少,尝试去创建或活化一个worker.</span></span><br><span class="line"><span class="comment">//参数ws是想要找到被唤醒者的队列数组(也就是任何一个ForkJoinPool的成员变量),</span></span><br><span class="line"><span class="comment">//参数q是个非空的队列,则方法只尝试一次,不会重试</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signalWork</span><span class="params">(WorkQueue[] ws, WorkQueue q)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> c; <span class="keyword">int</span> sp, i; WorkQueue v; Thread p;</span><br><span class="line">    <span class="keyword">while</span> ((c = ctl) &lt; <span class="number">0L</span>) &#123; </span><br><span class="line">        <span class="comment">//添加worker步骤                      </span></span><br><span class="line">        <span class="comment">//ctl小于0,表示active的太少.但似乎也只能最多加上并行度的数量</span></span><br><span class="line">        <span class="keyword">if</span> ((sp = (<span class="keyword">int</span>)c) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//取ctl的后32位,终于,终于看明白了,这里有一个注释,sp==0代表无闲置worker</span></span><br><span class="line">            <span class="comment">//但不代表后32位全部与闲置worker有关.</span></span><br><span class="line">            <span class="keyword">if</span> ((c &amp; ADD_WORKER) != <span class="number">0L</span>) </span><br><span class="line">                <span class="comment">//ADD_WORKER位有值,说明总worker数量未达到.</span></span><br><span class="line">                <span class="comment">//经过三重关,添加worker.          </span></span><br><span class="line">                tryAddWorker(c);</span><br><span class="line">            <span class="comment">//满足添加worker的第一个条件,无闲置worker,不论有没有成功创建新的worker</span></span><br><span class="line">            <span class="comment">//就都一定会退出循环</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//不存在空闲worker,验证不满足唤醒流程的情况.</span></span><br><span class="line">        <span class="keyword">if</span> (ws == <span class="keyword">null</span>)  </span><br><span class="line">            <span class="comment">//队列数组都还没初始化,显然池不满足条件.                          </span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (ws.length &lt;= (i = sp &amp; SMASK))<span class="comment">// </span></span><br><span class="line">            <span class="comment">//队列数组长度不大于ctl后16位.说明已进入终止态.退出(多像数组的length一定要大于索引)</span></span><br><span class="line">            <span class="comment">//又一次大揭密,ctl后16位似乎与队列数组的长度有关,而且存放的是一个索引. </span></span><br><span class="line">            <span class="comment">//此处隐含条件,ctl后32位不是0,将它的后16位取出来当索引i,要结合1处的条件.      </span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ((v = ws[i]) == <span class="keyword">null</span>) </span><br><span class="line">            <span class="comment">//队列数组长度正常, 使用索引(ctl的后15位)从ws中取不出队列.</span></span><br><span class="line">            <span class="comment">//说明正在终止,退出.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//满足了唤醒流程</span></span><br><span class="line">        <span class="comment">//计算数据,第一个为下一个scanState,在前面的addWorker流程,我们看到</span></span><br><span class="line">        <span class="comment">//scanState的第一个值是在队列数组中的索引.显然索引不能乱变.</span></span><br><span class="line">        <span class="comment">//新的scanState值计算,老ctl的整数位在17位加1(SS_SEQ)再取它的后31位.显然每次被唤醒都会走一次这个逻辑.</span></span><br><span class="line">        <span class="keyword">int</span> vs = (sp + SS_SEQ) &amp; ~INACTIVE; </span><br><span class="line">        <span class="keyword">int</span> d = sp - v.scanState; <span class="comment">//屏蔽不必要的cas.   </span></span><br><span class="line">        <span class="comment">//计算nc,它用老的ctl加一个活跃位(48位),然后只取出前32位</span></span><br><span class="line">        <span class="comment">//对后32位取出队列v在上次扫描时存放的值(也是当时ctl的后32位)</span></span><br><span class="line">        <span class="comment">//这里我们又见到一个熟人:stackPred,接下来会有重要的方法使用它.          </span></span><br><span class="line">        <span class="keyword">long</span> nc = (UC_MASK &amp; (c + AC_UNIT)) | (SP_MASK &amp; v.stackPred);</span><br><span class="line">        <span class="comment">//d是0说明ctl的后32位相对于原来v中存放的scanState没有变化,那么也就不需要cas</span></span><br><span class="line">        <span class="comment">//d不是0,需要cas,用nc替换掉c</span></span><br><span class="line">        <span class="keyword">if</span> (d == <span class="number">0</span> &amp;&amp; U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, nc)) &#123;</span><br><span class="line">            <span class="comment">//把v的scanDate置换成vs,激活了v</span></span><br><span class="line">            v.scanState = vs;                      </span><br><span class="line">            <span class="keyword">if</span> ((p = v.parker) != <span class="keyword">null</span>)</span><br><span class="line">                <span class="comment">//有线程阻塞,唤醒</span></span><br><span class="line">                U.unpark(p);</span><br><span class="line">            <span class="comment">//激活成功,退出循环.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.上述过程没有成功,看q是否提供,如果提供了不循环第二次</span></span><br><span class="line">        <span class="keyword">if</span> (q != <span class="keyword">null</span> &amp;&amp; q.base == q.top)        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tryRelease"><a href="#tryRelease" class="headerlink" title="tryRelease"></a>tryRelease</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//唤醒并释放worker v(队列),如果它处于空闲worker栈的顶部,此方法是当至少有一个空闲worker</span></span><br><span class="line"><span class="comment">//时的一个快速唤醒方式.</span></span><br><span class="line"><span class="comment">//它的参数,c应当传入此前读取的ctl,v是一个工作队列,如果不传空,应当传一个worker过来,inc代表活跃数的增加数</span></span><br><span class="line"><span class="comment">//如果成功释放,则返回true</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">long</span> c, WorkQueue v, <span class="keyword">long</span> inc)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//类似上面的signalWork方法的计算方式,sp保存ctl的后32位,vs为队列v的下一个scanState.</span></span><br><span class="line">    <span class="comment">//值依旧是sp在17位加1并只取结果的31位.</span></span><br><span class="line">    <span class="keyword">int</span> sp = (<span class="keyword">int</span>)c, vs = (sp + SS_SEQ) &amp; ~INACTIVE; Thread p;</span><br><span class="line">    <span class="comment">//判断是否满足条件,v存在且v的scanState是sp</span></span><br><span class="line">    <span class="comment">//(言外之意sp保存的是一个v的scanState,别急,我们离真相越来越近了,注释说此条件代表v是栈顶)</span></span><br><span class="line">    <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; v.scanState == sp) &#123;</span><br><span class="line">        <span class="comment">//满足了前述的条件,v是当前"栈顶",这个栈顶的含义有些奇怪,没有栈,何来栈顶?别急</span></span><br><span class="line">        <span class="comment">//计算新的ctl,算法同上,老ctl加上inc的结果的前32位给nc的前32位</span></span><br><span class="line">        <span class="comment">//v保存的stackPred作为nc的后32位</span></span><br><span class="line">        <span class="comment">//在前面deregisterWorker中,tryRelease方法传入的inc为一个AC_UNIT.相当于增加一个活跃数</span></span><br><span class="line">        <span class="keyword">long</span> nc = (UC_MASK &amp; (c + inc)) | (SP_MASK &amp; v.stackPred);</span><br><span class="line">        <span class="comment">//尝试用前面计算的结果更新为新值.</span></span><br><span class="line">        <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, nc)) &#123;</span><br><span class="line">            <span class="comment">//控制信号成功更新为nc,则将v的scanState保存为vs.</span></span><br><span class="line">            v.scanState = vs;</span><br><span class="line">            <span class="keyword">if</span> ((p = v.parker) != <span class="keyword">null</span>)</span><br><span class="line">                <span class="comment">//存在parker,唤醒.</span></span><br><span class="line">                U.unpark(p);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="runWorker"><a href="#runWorker" class="headerlink" title="runWorker"></a>runWorker</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//runWorker方法是线程运行的最顶层方法,它由ForkJoinWorkerThread在注册成功后调用,也是全部生命周期</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(WorkQueue w)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//一上来初始化数组,前面说过,WorkQueue内部的任务数组初始化是null</span></span><br><span class="line">    w.growArray();  </span><br><span class="line">    <span class="comment">//用seed保留构建时的hint随机数,在registerWorker方法中曾介绍过</span></span><br><span class="line">    <span class="comment">//会有一个随机数s是保证每个队列不同的,且其中有一个每次增加一个值的成份,该值是个数学中很奇异的数字</span></span><br><span class="line">    <span class="comment">//而hint的初值即这个s,它同时也被用于确定队列在ws中的索引,间接决定是否扩容      </span></span><br><span class="line">    <span class="keyword">int</span> seed = w.hint; </span><br><span class="line">    <span class="comment">//初始化r,并避免异或时出现0</span></span><br><span class="line">    <span class="keyword">int</span> r = (seed == <span class="number">0</span>) ? <span class="number">1</span> : seed;  </span><br><span class="line">    <span class="comment">//循环</span></span><br><span class="line">    <span class="keyword">for</span> (ForkJoinTask&lt;?&gt; t;;) &#123;</span><br><span class="line">        <span class="comment">//尝试"scan"(终于出现了有没有)队列w,使用随机数r</span></span><br><span class="line">        <span class="keyword">if</span> ((t = scan(w, r)) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//scan到了一个任务t,则运行它.这是进入一个任务处理的主流程</span></span><br><span class="line">            <span class="comment">//前面已介绍过WorkQueue的runTask方法</span></span><br><span class="line">            <span class="comment">//回忆一下,它会在过程中把scanState标记为忙碌</span></span><br><span class="line">            w.runTask(t);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!awaitWork(w, r))</span><br><span class="line">            <span class="comment">//scan不到,尝试等待任务,如果等待过一段时间还未等待,进入8重置r,继续下轮循环scan.若awaitWork返回false代表应break结束worker</span></span><br><span class="line">            <span class="comment">//关于awaitWork的返回我们后面详解</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//或许只能说just math</span></span><br><span class="line">        r ^= r &lt;&lt; <span class="number">13</span>; r ^= r &gt;&gt;&gt; <span class="number">17</span>; r ^= r &lt;&lt; <span class="number">5</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="scan"><a href="#scan" class="headerlink" title="scan"></a>scan</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试扫描队列,并偷取一个"顶级"的任务.扫描开始于一个随机位置(与r有关),如果在扫描过程中发生了</span></span><br><span class="line"><span class="comment">//竞态,则移动到一个随机的位置继续,否则线性地扫描,这个过程持续到在所有相同校验和</span></span><br><span class="line"><span class="comment">//(校验和的计算会采样每个队列的base索引,而base索引会在每次偷的时候移动)的队列上有两次</span></span><br><span class="line"><span class="comment">//连续的空传递,此时worker会尝试对队列进行灭活并重新扫描,如果能找到一个task,则尝试重新</span></span><br><span class="line"><span class="comment">//激活(重新激活可以由别的线程完成),如果找不到task,则返回null用于等待任务.扫描过程应当减少内</span></span><br><span class="line"><span class="comment">//存使用,以及与其他正在扫描的线程的冲突.</span></span><br><span class="line"><span class="comment">//参数w为目标队列,r是前面传递的种子,返回task或null.</span></span><br><span class="line"><span class="keyword">private</span> ForkJoinTask&lt;?&gt; scan(WorkQueue w, <span class="keyword">int</span> r) &#123;</span><br><span class="line">    WorkQueue[] ws; <span class="keyword">int</span> m;</span><br><span class="line">    <span class="comment">//当前工作线程必须是已经完成注册的,即存在工作队列,且r&amp;m能取得它的队列,否则直接返回null.</span></span><br><span class="line">    <span class="keyword">if</span> ((ws = workQueues) != <span class="keyword">null</span> &amp;&amp; (m = ws.length - <span class="number">1</span>) &gt; <span class="number">0</span> &amp;&amp; w != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//1.scan方法是在runWorker的循环中调用的,初次调用时,scanState的值是i(前面说过),是个非负值.</span></span><br><span class="line">        <span class="keyword">int</span> ss = w.scanState;  </span><br><span class="line">        <span class="comment">//scan方法内部开始循环. 用r&amp;m,即w的索引给origin和k,初始化oldSum和checkSum为0.                  </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> origin = r &amp; m, k = origin, oldSum = <span class="number">0</span>, checkSum = <span class="number">0</span>;;) &#123;</span><br><span class="line">            WorkQueue q; ForkJoinTask&lt;?&gt;[] a; ForkJoinTask&lt;?&gt; t;</span><br><span class="line">            <span class="keyword">int</span> b, n; <span class="keyword">long</span> c;</span><br><span class="line">            <span class="comment">//2.选择队列q存在的逻辑.</span></span><br><span class="line">            <span class="keyword">if</span> ((q = ws[k]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//2.1 目标队列q非空(本身base到top间至少存在1个,任务数组非空.</span></span><br><span class="line">                <span class="keyword">if</span> ((n = (b = q.base) - q.top) &lt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    (a = q.array) != <span class="keyword">null</span>) &#123; </span><br><span class="line">                    <span class="comment">//计算任务数组的base索引(参考WorkQueue源码).</span></span><br><span class="line">                    <span class="keyword">long</span> i = (((a.length - <span class="number">1</span>) &amp; b) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">                    <span class="comment">//2.2数组中取出base对应task存在,base未改变的逻辑.</span></span><br><span class="line">                    <span class="keyword">if</span> ((t = ((ForkJoinTask&lt;?&gt;)</span><br><span class="line">                              U.getObjectVolatile(a, i))) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        q.base == b) &#123;</span><br><span class="line">                        <span class="comment">//2.3 初始记录的scanState不小于0,代表存活的逻辑.</span></span><br><span class="line">                        <span class="keyword">if</span> (ss &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">//2.4尝试cas掉base处的任务,注意,一定只能从base开始,不会将任务数组中间的元素置空.</span></span><br><span class="line">                            <span class="keyword">if</span> (U.compareAndSwapObject(a, i, t, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                                <span class="comment">//cas成功,更新base.</span></span><br><span class="line">                                q.base = b + <span class="number">1</span>;</span><br><span class="line">                                <span class="keyword">if</span> (n &lt; -<span class="number">1</span>) </span><br><span class="line">                                    <span class="comment">//2.5发现队列q的base到top间不止一个任务元素,则唤醒它可能存在的parker.</span></span><br><span class="line">                                    <span class="comment">//重温一下signalWork的简要逻辑,ctl后32位0且满足加worker条件,tryAddWorker,</span></span><br><span class="line">                                    <span class="comment">//条件不满足(忽略终止等判断逻辑),则计算新的scanState(使用到原ctl的后32位)和ctl(使用原ctl的前32位和q的stackPred),</span></span><br><span class="line">                                    <span class="comment">//在cas为新的ctl成功的前提下,换掉新的scanState.</span></span><br><span class="line">                                    signalWork(ws, q);</span><br><span class="line">                                <span class="comment">//2.6 只要2.4成功,返回弹出的任务.</span></span><br><span class="line">                                <span class="keyword">return</span> t;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//2.7 从scanState看已经是inactive的情况.尝试活化.</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (oldSum == <span class="number">0</span> &amp;&amp;   </span><br><span class="line">                                 w.scanState &lt; <span class="number">0</span>)</span><br><span class="line">                            <span class="comment">//tryRelease前面已介绍过.尝试释放掉栈顶,显然ws[m&amp;(int)c]被视为栈顶,即ctl的后32位(严格来说似乎是后16位)代表栈顶的索引.</span></span><br><span class="line">                            <span class="comment">//释放时对ctl的增量是一个AC_UNIT.</span></span><br><span class="line">                            tryRelease(c = ctl, ws[m &amp; (<span class="keyword">int</span>)c], AC_UNIT);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//2.8 只要没有进入2.4-&gt;2.6,重置origin,k,r,校验和等参数并开启下轮,但整个2工作线用不到,进入3工作线才有用.</span></span><br><span class="line">                    <span class="keyword">if</span> (ss &lt; <span class="number">0</span>)                   <span class="comment">// refresh</span></span><br><span class="line">                        <span class="comment">//可能会有其他抢到同一个队列的worker在2.5/2.7处重活化了scanState,因此当它是inactive的情况,重刷新一次.</span></span><br><span class="line">                        ss = w.scanState;</span><br><span class="line">                    r ^= r &lt;&lt; <span class="number">1</span>; r ^= r &gt;&gt;&gt; <span class="number">3</span>; r ^= r &lt;&lt; <span class="number">10</span>;</span><br><span class="line">                    origin = k = r &amp; m;           <span class="comment">// move and rescan</span></span><br><span class="line">                    oldSum = checkSum = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//2.9校验和增加b</span></span><br><span class="line">                checkSum += b;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//3.持续迭代到稳定的逻辑.</span></span><br><span class="line">            <span class="comment">//这个表达式大概可以理解,线性的增加k,每次加1,直到发现已经从一个origin转满了一圈或n圈.</span></span><br><span class="line">            <span class="keyword">if</span> ((k = (k + <span class="number">1</span>) &amp; m) == origin) &#123;</span><br><span class="line">                <span class="comment">//条件:scanState表示活跃,或者满足当前线程工作队列w的ss未改变,oldSum依旧等于最新的checkSum(校验和未改变)</span></span><br><span class="line">                <span class="keyword">if</span> ((ss &gt;= <span class="number">0</span> || (ss == (ss = w.scanState))) &amp;&amp;</span><br><span class="line">                    oldSum == (oldSum = checkSum)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ss &lt; <span class="number">0</span> || w.qlock &lt; <span class="number">0</span>)    <span class="comment">// already inactive</span></span><br><span class="line">                    <span class="comment">//3.1满足前面注释的条件,且w已经inactive,终止循环,返回null.</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//3.2又是这一段计算和替换的逻辑,只不过ns(new scanState)要加上非active标记.</span></span><br><span class="line">                    <span class="keyword">int</span> ns = ss | INACTIVE;       <span class="comment">// try to inactivate</span></span><br><span class="line">                    <span class="comment">//3.3尝试计算用来替换的ctl,它的后32位为ss加上非活跃标记,前32位减去一个活跃数单元.(终于到这了,参考前面分析的ctl前32后32位,验证了)</span></span><br><span class="line">                    <span class="keyword">long</span> nc = ((SP_MASK &amp; ns) |</span><br><span class="line">                               (UC_MASK &amp; ((c = ctl) - AC_UNIT)));</span><br><span class="line">                    <span class="comment">//原来ctl的后32位存给队列的stackPred.</span></span><br><span class="line">                    <span class="comment">//注意,此时w.stackPred和新的ctl的后32位都有一个共性,那就是它们的后31位都可以用来运算并计算得w在ws的索引.</span></span><br><span class="line">                    w.stackPred = (<span class="keyword">int</span>)c;         <span class="comment">// hold prev stack top</span></span><br><span class="line">                    <span class="comment">//3.4先把w的scanState换成ns,再用cas换ctl为nc.</span></span><br><span class="line">                    U.putInt(w, QSCANSTATE, ns);</span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, nc))</span><br><span class="line">                        <span class="comment">//替换ctl成功,ss直接指向ns,省去一次volatile读.</span></span><br><span class="line">                        ss = ns;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="comment">//3.5替换失败,再把w的scanState设置回ss.</span></span><br><span class="line">                        w.scanState = ss;         <span class="comment">// back out</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//3.6每发现回了一轮,校验和置0.</span></span><br><span class="line">                checkSum = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="awaitWork"><a href="#awaitWork" class="headerlink" title="awaitWork"></a>awaitWork</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//字面意思,等待有工作可做.</span></span><br><span class="line"><span class="comment">//它其实可能会阻塞一个worker偷取任务的过程,如果worker应当关闭则直接返回false.</span></span><br><span class="line"><span class="comment">//如果worker已经处于非活睡在态,且引起了线程池的静寂,则检查线程池的终结态,只要当前worker</span></span><br><span class="line"><span class="comment">//不是唯一一个worker就等待一段时间.如果等待超时后ctl未改变(前32位的数量信息未变,后32位的栈信息也未变),</span></span><br><span class="line"><span class="comment">//则终止当前worker,它可能会唤醒另一个可能重复这个过程的worker</span></span><br><span class="line"><span class="comment">//参数w,调用者worker,r是一个自旋用的随机数种子,如果worker应当关闭,返回false.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">awaitWork</span><span class="params">(WorkQueue w, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (w == <span class="keyword">null</span> || w.qlock &lt; <span class="number">0</span>)                 <span class="comment">// w is terminating</span></span><br><span class="line">        <span class="comment">//一个线程从注册入池起就有队列,如果它为空或者qlock被置为负(-1),应当终结.</span></span><br><span class="line">        <span class="comment">//前面提过,在deregisterWorker或tryTerminate时会将qlock置-1.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//初始化相关值,保留队列中保存的前一个栈,取出队列的ss,赋值自旋数.SPINS在前面分析</span></span><br><span class="line">    <span class="comment">//运行状态加锁时介绍过,它的值当前就是0,参考awaitRunState方法,在等待runState锁的时候,也可以根据它先自旋.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> pred = w.stackPred, spins = SPINS, ss;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((ss = w.scanState) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//1.队列的scanState大于0,回忆一下,前面介绍tryRelease和signal中计算vs的方法,其中一步是与~INACTIVE,而INACTIVE是1&lt;&lt;31</span></span><br><span class="line">            <span class="comment">//在前面的scan方法中已经遍历一轮且未找到task又未出现竞态未更改校验和的情况,会将scanState加上INACTIVE.</span></span><br><span class="line">            <span class="comment">//因此此处scanState突然不小于0,说明是经历过类似tryRelease或signal的释放唤醒动作,退出循环等待.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (spins &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//2.当前未被活化,依旧处于INACTIVE态,则首先尝试自旋.使用r这个随机数来决定是否对自旋次数减1.</span></span><br><span class="line">            r ^= r &lt;&lt; <span class="number">6</span>; r ^= r &gt;&gt;&gt; <span class="number">21</span>; r ^= r &lt;&lt; <span class="number">7</span>;</span><br><span class="line">            <span class="keyword">if</span> (r &gt;= <span class="number">0</span> &amp;&amp; --spins == <span class="number">0</span>) &#123;         <span class="comment">// randomize spins</span></span><br><span class="line">                <span class="comment">//2.1自旋次数达到0时做了勾子操作.</span></span><br><span class="line">                WorkQueue v; WorkQueue[] ws; <span class="keyword">int</span> s, j; AtomicLong sc;</span><br><span class="line">                <span class="keyword">if</span> (pred != <span class="number">0</span> &amp;&amp; (ws = workQueues) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (j = pred &amp; SMASK) &lt; ws.length &amp;&amp;</span><br><span class="line">                    (v = ws[j]) != <span class="keyword">null</span> &amp;&amp;        <span class="comment">// see if pred parking</span></span><br><span class="line">                    (v.parker == <span class="keyword">null</span> || v.scanState &gt;= <span class="number">0</span>))</span><br><span class="line">                    <span class="comment">//2.2自旋次数降到0时,若满足几个条件:</span></span><br><span class="line">                    <span class="comment">//当前队列保存的栈下一个队列的索引(pred)存在,线程池队列非空,pred未溢出队列数组,</span></span><br><span class="line">                    <span class="comment">//取出pred对应的ws的队列(它其实是当前w在栈向栈底前进一个的元素,它存在说明当前w不是栈底.</span></span><br><span class="line">                    <span class="comment">//如果该元素存在,且它没有阻塞者或它还保持active,则重置自旋次数,继续自旋.</span></span><br><span class="line">                    spins = SPINS;                <span class="comment">// continue spinning</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (w.qlock &lt; <span class="number">0</span>)                     <span class="comment">// recheck after spins</span></span><br><span class="line">            <span class="comment">//3.自旋结束后,再次检查w的队列锁,看它是不是已经被终止了.(deregisterWorker或tryTerminate).</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!Thread.interrupted()) &#123;</span><br><span class="line">            <span class="comment">//4.如果当前线程还未被扰动.</span></span><br><span class="line">            <span class="comment">//目前我们只在一个地方看到过线程扰动的情况:awaitRunStateLock,即当一个线程尝试去修改池的运行时状态,它会去获取一个runState锁,</span></span><br><span class="line">            <span class="comment">//获取失败,发生竞态,也经过自旋等辅助策略无效的阶段,则会尝试使用stealCounter来当作锁加锁,unlock时也会在确认竞态的情况下去用它唤醒.</span></span><br><span class="line">            <span class="comment">//而在awaitRunStateLock中阻塞的线程如果正在进行stealCounter.wait时,wait操作被中断,则会扰动当前线程,这将去除进入此分支的可能.</span></span><br><span class="line">            <span class="comment">//此外,tryTerminate本身也有扰动其他工作线程的步骤.如果用户不在相应的实现代码(如ForkJoinTask的exec函数或CountedCompleter的compute函数)</span></span><br><span class="line">            <span class="comment">//中手动去扰动当前工作线程,可以理解awaitRunStateLock的扰动事件可能与tryTerminate有关.</span></span><br><span class="line">            <span class="keyword">long</span> c, prevctl, parkTime, deadline;</span><br><span class="line">            <span class="comment">//计算新的活跃数,它是原ctl的前16位(负)加上并行度.</span></span><br><span class="line">            <span class="keyword">int</span> ac = (<span class="keyword">int</span>)((c = ctl) &gt;&gt; AC_SHIFT) + (config &amp; SMASK);</span><br><span class="line">            <span class="keyword">if</span> ((ac &lt;= <span class="number">0</span> &amp;&amp; tryTerminate(<span class="keyword">false</span>, <span class="keyword">false</span>)) ||</span><br><span class="line">                (runState &amp; STOP) != <span class="number">0</span>)           <span class="comment">// pool terminating</span></span><br><span class="line">                <span class="comment">//5.发现活跃数已降至0,尝试调用tryTerminate,方法返回true表明已终止或正在终止;或发现runState已经进入终结程序.</span></span><br><span class="line">                <span class="comment">//这两种情况直接返回false,线程执行完毕终止.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (ac &lt;= <span class="number">0</span> &amp;&amp; ss == (<span class="keyword">int</span>)c) &#123;        <span class="comment">// is last waiter</span></span><br><span class="line">                <span class="comment">//6.前面分析scan方法时讨论过,栈顶元素的scanState体现在ctl的最新后32位,它的stackPred则是ctl之前的后32位值.</span></span><br><span class="line">                <span class="comment">//进入6,说明当前worker是栈顶,即最后一个等待者.</span></span><br><span class="line">                <span class="comment">//用pred计算出之前的ctl.</span></span><br><span class="line">                prevctl = (UC_MASK &amp; (c + AC_UNIT)) | (SP_MASK &amp; pred);</span><br><span class="line">                <span class="comment">//取ctl的17-32位,即worker总数.</span></span><br><span class="line">                <span class="keyword">int</span> t = (<span class="keyword">short</span>)(c &gt;&gt;&gt; TC_SHIFT);  <span class="comment">// shrink excess spares</span></span><br><span class="line">                <span class="keyword">if</span> (t &gt; <span class="number">2</span> &amp;&amp; U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, prevctl))</span><br><span class="line">                    <span class="comment">//6.1如果发现线程总数大于2,将ctl回滚,返回false让线程终止.</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;                 <span class="comment">// else use timed wait</span></span><br><span class="line">                <span class="comment">//6.2计算deadLine和parkTime,用于后续的定时等待,暂不终结当前线程,而是作为parker.</span></span><br><span class="line">                <span class="comment">//IDLE_TIMEOUT最开始说过,它就是起这个作用的一个时间单位,把gc时间也考虑在内,默认为2秒.</span></span><br><span class="line">                parkTime = IDLE_TIMEOUT * ((t &gt;= <span class="number">0</span>) ? <span class="number">1</span> : <span class="number">1</span> - t);</span><br><span class="line">                deadline = System.nanoTime() + parkTime - TIMEOUT_SLOP;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">//7.存在active的worker或当前w不是栈顶.</span></span><br><span class="line">                prevctl = parkTime = deadline = <span class="number">0L</span>;</span><br><span class="line">            <span class="comment">//8.做线程停段的工作.</span></span><br><span class="line">            Thread wt = Thread.currentThread();</span><br><span class="line">            <span class="comment">//把当前线程池作为parker设置给线程,当使用LockSupport.park时,它将被当作一个参数传递(参考Thread类注释,在java方法签名处看不出来).</span></span><br><span class="line">            U.putObject(wt, PARKBLOCKER, <span class="keyword">this</span>);   <span class="comment">// emulate LockSupport</span></span><br><span class="line">            <span class="comment">//设置parker.</span></span><br><span class="line">            w.parker = wt;</span><br><span class="line">            <span class="keyword">if</span> (w.scanState &lt; <span class="number">0</span> &amp;&amp; ctl == c)      <span class="comment">// recheck before park</span></span><br><span class="line">                <span class="comment">//8.1重新检查非active.合格则停顿.</span></span><br><span class="line">                U.park(<span class="keyword">false</span>, parkTime);</span><br><span class="line">            <span class="comment">//归置.</span></span><br><span class="line">            U.putOrderedObject(w, QPARKER, <span class="keyword">null</span>);</span><br><span class="line">            U.putObject(wt, PARKBLOCKER, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (w.scanState &gt;= <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//8.2停顿(或未停顿)重检查发现w被重新active,则退出循环返回true(非false代表不能终结当前线程).</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (parkTime != <span class="number">0L</span> &amp;&amp; ctl == c &amp;&amp;</span><br><span class="line">                deadline - System.nanoTime() &lt;= <span class="number">0L</span> &amp;&amp;</span><br><span class="line">                U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, prevctl))</span><br><span class="line">                <span class="comment">//8.3发现没有时间了,ctl也未在等待的时间发生变化,将ctl设置为w入栈前的结果,返回false让终结此线程(类似出栈).</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;                     <span class="comment">// shrink pool</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="helpComplete"><a href="#helpComplete" class="headerlink" title="helpComplete"></a>helpComplete</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//帮助完成,调用者可以是一个池中的工作线程,也可以是池外的.在JDK8版本中,有三处调用:</span></span><br><span class="line"><span class="comment">//1.CountedCompleter::helpComplete,该方法的调用由我们决定.</span></span><br><span class="line"><span class="comment">//2.ForkJoinPool::awaitJoin,等待结果的同时可以尝试帮助完成,只由池中线程调用,传入的队列是该线程的队列.该方法由ForkJoinTask的join/invoke/get调用.</span></span><br><span class="line"><span class="comment">//3.ForkJoinPool::externalHelpComplete,用于外部线程操作,前面在CountedCompleter的文章已粗略介绍,传入的w为ws中用一个随机数与n-1和0x007e取与运算</span></span><br><span class="line"><span class="comment">//的结果,很明显,即使w不是null,也只能是一个偶数位的元素,这意味着w不会是registerWoker时生成的带有工作线程的WorkQueue.也就是不能帮助池中线程完成自己的队列.</span></span><br><span class="line"><span class="comment">//本方法会尝试从当前的计算目标之内偷取一个任务,它使用顶层算法的变种,限制偷出来的任务必须是给定任务的后代,但是也有一些细节要注意.</span></span><br><span class="line"><span class="comment">//首先,它会尝试从自己的工作队列中找合格的任务(用前面讲过的WorkQueue::popCC),若不能找到则扫描其他队列,当发生竞态时随机移动指针,依照校验和机制决定是否放弃</span></span><br><span class="line"><span class="comment">//帮助执行(这取决于前面介绍的pollAndExecCC的返回码).参数maxTasks是对外部使用的支持参数,内部调用它会传入0,允许无界的次数(外部调用时,捕获非法的非正数).</span></span><br><span class="line"><span class="comment">//参数w,队列,在内部调用的情况下可以理解为当前线程的工作队列,参数maxTasks如果非0,指代最大的可运行的其他任务.退出时方法返回任务状态.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">helpComplete</span><span class="params">(WorkQueue w, CountedCompleter&lt;?&gt; task,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> maxTasks)</span> </span>&#123;</span><br><span class="line">    WorkQueue[] ws; <span class="keyword">int</span> s = <span class="number">0</span>, m;</span><br><span class="line">    <span class="comment">//变量初始化和验证,队列和参数w必须非空才能进入if.</span></span><br><span class="line">    <span class="keyword">if</span> ((ws = workQueues) != <span class="keyword">null</span> &amp;&amp; (m = ws.length - <span class="number">1</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">        task != <span class="keyword">null</span> &amp;&amp; w != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//介绍popCC时曾专门强调过这个mode其实是config.</span></span><br><span class="line">        <span class="keyword">int</span> mode = w.config;                 <span class="comment">// for popCC</span></span><br><span class="line">        <span class="keyword">int</span> r = w.hint ^ w.top;              <span class="comment">// arbitrary seed for origin</span></span><br><span class="line">        <span class="keyword">int</span> origin = r &amp; m;                  <span class="comment">// first queue to scan</span></span><br><span class="line">        <span class="comment">//初始时赋h为1,在每一轮循环中,它取1代表正在正常运行,大于1代表发生了竞态,小于0将增加到校验和,代表pollAndExecCC达到了根元素.</span></span><br><span class="line">        <span class="comment">//详细参考前面论述过的pollAndExecCC.</span></span><br><span class="line">        <span class="keyword">int</span> h = <span class="number">1</span>;                           <span class="comment">// 1:ran, &gt;1:contended, &lt;0:hash</span></span><br><span class="line">        <span class="comment">//初始化条件循环条件,记录origin的值,初始化oldSum和checkSum</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = origin, oldSum = <span class="number">0</span>, checkSum = <span class="number">0</span>;;) &#123;</span><br><span class="line">            CountedCompleter&lt;?&gt; p; WorkQueue q;</span><br><span class="line">            <span class="comment">//1.传入的任务已经是完成的,break返回s(负).</span></span><br><span class="line">            <span class="keyword">if</span> ((s = task.status) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//2.h未经过更改或经历过若干次更改,但在上一轮循环代表了pollAndExecCC成功执行task(h取1),则</span></span><br><span class="line">            <span class="comment">//在当轮循环尝试对w进行popCC,并根据mode决定从base还是top出队.</span></span><br><span class="line">            <span class="keyword">if</span> (h == <span class="number">1</span> &amp;&amp; (p = w.popCC(task, mode)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//2.1本队列有满足条件的任务,执行之.</span></span><br><span class="line">                p.doExec();                  <span class="comment">// run local task</span></span><br><span class="line">                <span class="keyword">if</span> (maxTasks != <span class="number">0</span> &amp;&amp; --maxTasks == <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//减少maxTask并在它降到0时break.(前提是传入了正数的maxTasks).</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//2.2没降到0,把origin和校验和参数重设为循环初始化的值.</span></span><br><span class="line">                origin = k;                  <span class="comment">// reset</span></span><br><span class="line">                oldSum = checkSum = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//3.某轮循环h代表出现竞态等问题或不能使用popCC方式从本地队列出任务执行.尝试从其他队列poll执行.</span></span><br><span class="line">            <span class="keyword">else</span> &#123;                           <span class="comment">// poll other queues</span></span><br><span class="line">                <span class="comment">//3.1 找不出任务,h置0,这将使它在随后的循环中不会再进入2</span></span><br><span class="line">                <span class="keyword">if</span> ((q = ws[k]) == <span class="keyword">null</span>)</span><br><span class="line">                    h = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">//3.2尝试从q的base处poll并执行task.返回-1代表不匹配,对校验和增加h(负数).</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((h = q.pollAndExecCC(task)) &lt; <span class="number">0</span>)</span><br><span class="line">                    checkSum += h;</span><br><span class="line">                <span class="comment">//3.3 h大于0,可能是等于1但popCC未成功的情况.也可能是pollAndExecCC成功了一次或cas失败.</span></span><br><span class="line">                <span class="keyword">if</span> (h &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (h == <span class="number">1</span> &amp;&amp; maxTasks != <span class="number">0</span> &amp;&amp; --maxTasks == <span class="number">0</span>)</span><br><span class="line">                        <span class="comment">//h是1减maxTask,当它达到0终止循环.(前提是没传了正数的maxTasks)</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//h不等于1,一般是poll时cas失败,重置r,origin,checkSum等,开下一轮循环.</span></span><br><span class="line">                    r ^= r &lt;&lt; <span class="number">13</span>; r ^= r &gt;&gt;&gt; <span class="number">17</span>; r ^= r &lt;&lt; <span class="number">5</span>; <span class="comment">// xorshift</span></span><br><span class="line">                    origin = k = r &amp; m;      <span class="comment">// move and restart</span></span><br><span class="line">                    oldSum = checkSum = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//3.4前面见过类似的代码,发现已经转完了一轮,校验和未改变过(任何一个队列都未进3.2/3.3,也就是查找任何一个下标ws[k]都是null),break.</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((k = (k + <span class="number">1</span>) &amp; m) == origin) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (oldSum == (oldSum = checkSum))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="comment">//发现校验和有变更,说明有一轮循环未进入3.1,再次循环.</span></span><br><span class="line">                    checkSum = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返架退出循环是task的status.</span></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="helpStealer"><a href="#helpStealer" class="headerlink" title="helpStealer"></a>helpStealer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//字面意思:尝试帮助一个"小偷".</span></span><br><span class="line"><span class="comment">//本方法会尝试定位到task的偷盗者,并尝试执行偷盗者(可能偷盗者的偷盗者)的任务.它会追踪currentSteal(前面runTask时提过,会将参数task置为currentSteal)-&gt;</span></span><br><span class="line"><span class="comment">//currentJoin(当前队列等待的任务,后面会介绍awaitJoin方法),这样追寻一个线程在给定的task的后续工作,它会使用非空队列偷回和执行任务.方法的第一次从等待join调用</span></span><br><span class="line"><span class="comment">//通常意味着scan搜索,因为joiner没有什么更适合做的,这种做法也是ok的.本方法会在worker中留下hint标识来加速后续的调用.</span></span><br><span class="line"><span class="comment">//参数w代表caller的队列,task是要join的任务.</span></span><br><span class="line"><span class="comment">//方法共分三层循环,最外层是一个do-while循环,其内是两个for循环.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">helpStealer</span><span class="params">(WorkQueue w, ForkJoinTask&lt;?&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//初始化和进入if的条件,没什么可说的.</span></span><br><span class="line">    WorkQueue[] ws = workQueues;</span><br><span class="line">    <span class="keyword">int</span> oldSum = <span class="number">0</span>, checkSum, m;</span><br><span class="line">    <span class="keyword">if</span> (ws != <span class="keyword">null</span> &amp;&amp; (m = ws.length - <span class="number">1</span>) &gt;= <span class="number">0</span> &amp;&amp; w != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        task != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//循环一:方法最外层的while循环.它的条件是task未完成且校验和未发生变化.</span></span><br><span class="line">        <span class="keyword">do</span> &#123;                                       <span class="comment">// restart point</span></span><br><span class="line">            <span class="comment">//每次循环一的起点,校验和重置为0.用j保存w.</span></span><br><span class="line">            checkSum = <span class="number">0</span>;                          <span class="comment">// for stability check</span></span><br><span class="line">            ForkJoinTask&lt;?&gt; subtask;</span><br><span class="line">            WorkQueue j = w, v;                    <span class="comment">// v is subtask stealer</span></span><br><span class="line">            <span class="comment">//循环二:外部for循环,subtask初始指向参数task,循环条件是subtask未完成.</span></span><br><span class="line">            <span class="comment">//在每次循环四中会校验当前小偷的队列是否空了,如果空了则换它的小偷继续偷(交给subtask指向).</span></span><br><span class="line">            descent: <span class="keyword">for</span> (subtask = task; subtask.status &gt;= <span class="number">0</span>; ) &#123;</span><br><span class="line">                <span class="comment">//循环三:内部第一个for循环,初始化变量h,用hint加上奇数位,保证从奇数索引取队列.k初始为0,每次循环结束加2.</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> h = j.hint | <span class="number">1</span>, k = <span class="number">0</span>, i; ; k += <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="comment">//1.循环三内的逻辑.</span></span><br><span class="line">                    <span class="comment">//1.1发现k已经递增到大于最大索引m了,直接终止循环二,若发现task还未完成,校验和也未更改,则进行上面的重置操作并重新开始循环二.</span></span><br><span class="line">                    <span class="keyword">if</span> (k &gt; m)                     <span class="comment">// can't find stealer</span></span><br><span class="line">                        <span class="keyword">break</span> descent;</span><br><span class="line">                    <span class="comment">//1.2i位置标记为h+k的结果与运算m,因为k每次增2,h又是奇数,故保证只取有线程主的队列.</span></span><br><span class="line">                    <span class="keyword">if</span> ((v = ws[i = (h + k) &amp; m]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (v.currentSteal == subtask) &#123;</span><br><span class="line">                            <span class="comment">//发现偷取currentSteal的worker v,将它的索引i交给j(初始为w,在2内会更改为"等待队列"的元素,在while循环中会重置为w)的hint,</span></span><br><span class="line">                            <span class="comment">//方便下一次再进入循环三时的查找.并终止循环三,进入循环四的判断入口.</span></span><br><span class="line">                            j.hint = i;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//1.3存在非空v,但是v未偷取subtask,将v的base加给校验和.这将影响到循环一的判真条件.显然从循环三退出循环二,或后续循环四退出循环二</span></span><br><span class="line">                        <span class="comment">//将导致循环一也一并因while条件不满而退出.</span></span><br><span class="line">                        checkSum += v.base;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//循环四:迭代subtask的循环,它必须经循环三中的1.2走出.</span></span><br><span class="line">                <span class="comment">//2.到达循环四,一定已经在循环三中找到了一个v,此处会尝试帮助v或者它的产生的"后裔".</span></span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;                         <span class="comment">// help v or descend</span></span><br><span class="line">                    ForkJoinTask&lt;?&gt;[] a; <span class="keyword">int</span> b;</span><br><span class="line">                    <span class="comment">//2.1类似1.3的逻辑,校验和增加v.base,初始化next,增加校验和意味着,只要从循环四退出了循环二,则最外的循环一的while条件将不满足.</span></span><br><span class="line">                    checkSum += (b = v.base);</span><br><span class="line">                    <span class="comment">//next取v的currentJoin.</span></span><br><span class="line">                    ForkJoinTask&lt;?&gt; next = v.currentJoin;</span><br><span class="line">                    <span class="keyword">if</span> (subtask.status &lt; <span class="number">0</span> || j.currentJoin != subtask ||</span><br><span class="line">                        v.currentSteal != subtask) <span class="comment">// stale</span></span><br><span class="line">                        <span class="comment">//2.2如果subtask已是完成态,或发现竞态等情况造成数据已脏,如发现本轮循环中j的当前join已不是当前subtask,</span></span><br><span class="line">                        <span class="comment">//或v的当前steal不是subtask,说明出现了脏数据,直接终止循环二,重新进入while循环重初始化jv.</span></span><br><span class="line">                        <span class="keyword">break</span> descent;</span><br><span class="line">                    <span class="comment">//2.3发现队列v已空的逻辑.</span></span><br><span class="line">                    <span class="keyword">if</span> (b - v.top &gt;= <span class="number">0</span> || (a = v.array) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ((subtask = next) == <span class="keyword">null</span>)</span><br><span class="line">                            <span class="comment">//2.3.1 v已空,且不存在next,即"等待队列"已空,退出循环二,重新while判定循环条件,重初始化jv.</span></span><br><span class="line">                            <span class="keyword">break</span> descent;</span><br><span class="line">                        <span class="comment">//2.3.2 还有next,将subtask指向next的同时,用v替换掉j.这是明显的迭代语句.</span></span><br><span class="line">                        <span class="comment">//在前面的代码中可以看出,循环一就是为subtask找出小偷v的,关系是v.currentSteal=subtask.同时j.currentJoin=subtask.</span></span><br><span class="line">                        <span class="comment">//因为next=v.currentJoin,将v赋给j后,仍旧满足j.currentJoin=next=subtask,此时break掉循环四,重新开启循环二的新一轮</span></span><br><span class="line">                        <span class="comment">//正好对v进行重新初始化,而找到v的条件又是v.currentSteal=subtask,也即等于j.currentJoin.</span></span><br><span class="line">                        <span class="comment">//此处break掉的循环四将导致循环二的下轮将在循环三处重新为新的j找到v(v.currentSteal==subtask).</span></span><br><span class="line">                        j = v;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//2.4未进入2.3.1/2.3.2的情况,显然进入这两者会break到循环一或二.</span></span><br><span class="line">                    <span class="comment">//取出base索引位置i和相应的任务元素.</span></span><br><span class="line">                    <span class="keyword">int</span> i = (((a.length - <span class="number">1</span>) &amp; b) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">                    ForkJoinTask&lt;?&gt; t = ((ForkJoinTask&lt;?&gt;)</span><br><span class="line">                                         U.getObjectVolatile(a, i));</span><br><span class="line">                    <span class="comment">//2.5,接2.4,判断竞态,v.base!=b说明已经被别的线程将base元素出队.这种情况下直接进入下一轮的循环二.</span></span><br><span class="line">                    <span class="keyword">if</span> (v.base == b) &#123;</span><br><span class="line">                        <span class="comment">//2.5.1 取出任务t,发现空为脏数据,从while循环重新初始化.</span></span><br><span class="line">                        <span class="keyword">if</span> (t == <span class="keyword">null</span>)             <span class="comment">// stale</span></span><br><span class="line">                            <span class="keyword">break</span> descent;</span><br><span class="line">                        <span class="comment">//2.5.2,将t出队并进行后续流程.</span></span><br><span class="line">                        <span class="keyword">if</span> (U.compareAndSwapObject(a, i, t, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                            <span class="comment">//2.5.3首先将v的base增1.</span></span><br><span class="line">                            v.base = b + <span class="number">1</span>;</span><br><span class="line">                            <span class="comment">//2.5.4取出w(方法参数,当前worker)的currentSteal保存到ps.</span></span><br><span class="line">                            ForkJoinTask&lt;?&gt; ps = w.currentSteal;</span><br><span class="line">                            <span class="keyword">int</span> top = w.top;</span><br><span class="line">                            <span class="keyword">do</span> &#123;</span><br><span class="line">                                <span class="comment">//2.5.5此循环不和循环一至四一块罗列,因为它本质上只是任务的出队与执行.</span></span><br><span class="line">                                <span class="comment">//首先会尝试将w队列的currentSteal置为刚刚从v的任务数组中出队的t</span></span><br><span class="line">                                U.putOrderedObject(w, QCURRENTSTEAL, t);</span><br><span class="line">                                <span class="comment">//执行t.执行后顺带循环处理自己刚压入队列w的任务.执行后,也跳出当前while循环的情况下会在下次重新判断2.3,</span></span><br><span class="line">                                <span class="comment">//非空继续找base(i),为空则迭代v为next(2.3.2).</span></span><br><span class="line">                                t.doExec();        <span class="comment">// clear local tasks too</span></span><br><span class="line">                            <span class="comment">//2.5.6循环条件,只要参数task还未完成,w新压入了任务,则依次尝试从w中pop元素,和前面的t一样按序执行(此处顺带执行自己的任务).</span></span><br><span class="line">                            &#125; <span class="keyword">while</span> (task.status &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                     w.top != top &amp;&amp;</span><br><span class="line">                                     (t = w.pop()) != <span class="keyword">null</span>);</span><br><span class="line">                            <span class="comment">//2.5.7偷了小偷v的base任务并执行成功,则恢复w的currentSteal.</span></span><br><span class="line">                            U.putOrderedObject(w, QCURRENTSTEAL, ps);</span><br><span class="line">                            <span class="keyword">if</span> (w.base != w.top)</span><br><span class="line">                                <span class="comment">//2.5.8偷完并执行完当前v的base任务或者某一轮的等待队列上的元素v的base任务后,发现自己的队列非空了,就不再帮助对方,方法return.</span></span><br><span class="line">                                <span class="comment">//可以参考awaitJoin方法,因为helpStealer只在awaitJoin中调用,调用的前提就是w.base==w.top.</span></span><br><span class="line">                                <span class="comment">//这显然与2.5.6有所纠结(尽管一个判断top,一个判断top和base的相等),只要到了2.5.8,队列非空将返回.</span></span><br><span class="line">                                <span class="keyword">return</span>;            <span class="comment">// can't further help</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//出队失败同2.5.1一样,竞态失败重新循环二,但在下一轮循环中会在2.5.1break回while循环.</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">//最外层的while循环条件,task未完成,校验和未发生更改.</span></span><br><span class="line">        &#125; <span class="keyword">while</span> (task.status &gt;= <span class="number">0</span> &amp;&amp; oldSum != (oldSum = checkSum));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tryCompensate"><a href="#tryCompensate" class="headerlink" title="tryCompensate"></a>tryCompensate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//字面意思:尝试补偿.</span></span><br><span class="line"><span class="comment">//方法会尝试减少活跃数(有时是隐式的)并可能会因阻塞释放或创建一个补偿worker.</span></span><br><span class="line"><span class="comment">//在出现竞态,发现脏数据,不稳定,终止的情况下返回false,并可重试.参数w代表调用者.</span></span><br><span class="line"><span class="comment">//方法实现比较简单,为简单的if else模式,只有一个分支可以执行.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">tryCompensate</span><span class="params">(WorkQueue w)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//canBlock为返回值.</span></span><br><span class="line">    <span class="keyword">boolean</span> canBlock;</span><br><span class="line">    WorkQueue[] ws; <span class="keyword">long</span> c; <span class="keyword">int</span> m, pc, sp;</span><br><span class="line">    <span class="comment">//1.发现调用者终止了,线程池队列数组为空,或者禁用了并行度,则返回false.</span></span><br><span class="line">    <span class="keyword">if</span> (w == <span class="keyword">null</span> || w.qlock &lt; <span class="number">0</span> ||           <span class="comment">// caller terminating</span></span><br><span class="line">        (ws = workQueues) == <span class="keyword">null</span> || (m = ws.length - <span class="number">1</span>) &lt;= <span class="number">0</span> ||</span><br><span class="line">        (pc = config &amp; SMASK) == <span class="number">0</span>)           <span class="comment">// parallelism disabled</span></span><br><span class="line">        canBlock = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//2.发现当前ctl表示有worker正等待任务(空闲,位于scan),则尝试释放它,让它回来工作.</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((sp = (<span class="keyword">int</span>)(c = ctl)) != <span class="number">0</span>)      <span class="comment">// release idle worker</span></span><br><span class="line">        canBlock = tryRelease(c, ws[sp &amp; m], <span class="number">0L</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//3.当前所有worker都在忙碌.</span></span><br><span class="line">        <span class="comment">//3.1计算活跃数,总数,计算方法前面已经论述多次.</span></span><br><span class="line">        <span class="keyword">int</span> ac = (<span class="keyword">int</span>)(c &gt;&gt; AC_SHIFT) + pc;</span><br><span class="line">        <span class="keyword">int</span> tc = (<span class="keyword">short</span>)(c &gt;&gt; TC_SHIFT) + pc;</span><br><span class="line">        <span class="comment">//记录nbusy,注释表示用于验证饱合度.</span></span><br><span class="line">        <span class="keyword">int</span> nbusy = <span class="number">0</span>;                        <span class="comment">// validate saturation</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= m; ++i) &#123;        <span class="comment">// two passes of odd indices</span></span><br><span class="line">            WorkQueue v;</span><br><span class="line">            <span class="comment">//3.2nbusy的计算方法,遍历线程池的队列数组(每次增1),验证则以1-3-5这个顺序开始,发现有处于SCANNING态的,就停掉循环,否则加1.</span></span><br><span class="line">            <span class="keyword">if</span> ((v = ws[((i &lt;&lt; <span class="number">1</span>) | <span class="number">1</span>) &amp; m]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((v.scanState &amp; SCANNING) != <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                ++nbusy;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.3如果非稳态(饱合度不是tc的2倍),或者ctl脏读,则返回false.</span></span><br><span class="line">        <span class="keyword">if</span> (nbusy != (tc &lt;&lt; <span class="number">1</span>) || ctl != c)</span><br><span class="line">            canBlock = <span class="keyword">false</span>;                 <span class="comment">// unstable or stale</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tc &gt;= pc &amp;&amp; ac &gt; <span class="number">1</span> &amp;&amp; w.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">//3.4处于稳态且ctl还有效,总worker数大于并行度且活跃数大于1而且当前w又是空的.尝试将ctl减去一个活跃位.</span></span><br><span class="line">            <span class="keyword">long</span> nc = ((AC_MASK &amp; (c - AC_UNIT)) |</span><br><span class="line">                       (~AC_MASK &amp; c));       <span class="comment">// uncompensated 反补偿,初看莫名其妙,调用者会在之后增加ac.</span></span><br><span class="line">            <span class="comment">//返回值为cas是否成功.</span></span><br><span class="line">            canBlock = U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, nc);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tc &gt;= MAX_CAP ||</span><br><span class="line">                 (<span class="keyword">this</span> == common &amp;&amp; tc &gt;= pc + commonMaxSpares))</span><br><span class="line">            <span class="comment">//3.5普通ForkJoinPool,总worker数达到MAX_CAP,或common池,总worker数量达到并行度+commonMaxSpares(默认256),抛出拒绝异常.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(</span><br><span class="line">                <span class="string">"Thread limit exceeded replacing blocked worker"</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;                                <span class="comment">// similar to tryAddWorker</span></span><br><span class="line">            <span class="keyword">boolean</span> add = <span class="keyword">false</span>; <span class="keyword">int</span> rs;      <span class="comment">// CAS within lock</span></span><br><span class="line">            <span class="comment">//3.6.计算新的ctl,增加一个总worker数.</span></span><br><span class="line">            <span class="keyword">long</span> nc = ((AC_MASK &amp; c) |</span><br><span class="line">                       (TC_MASK &amp; (c + TC_UNIT)));</span><br><span class="line">            <span class="comment">//加运行状态锁,池未进入终止态的情况下,进行cas,随后解锁.</span></span><br><span class="line">            <span class="keyword">if</span> (((rs = lockRunState()) &amp; STOP) == <span class="number">0</span>)</span><br><span class="line">                add = U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, nc);</span><br><span class="line">            unlockRunState(rs, rs &amp; ~RSLOCK);</span><br><span class="line">            <span class="comment">//cas成功,则创建worker</span></span><br><span class="line">            canBlock = add &amp;&amp; createWorker(); <span class="comment">// throws on exception</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> canBlock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="awaitJoin"><a href="#awaitJoin" class="headerlink" title="awaitJoin"></a>awaitJoin</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//前面提过它很多次了,awaitJoin方法会在指定任务完成或者超时前尝试帮助或阻塞自身.</span></span><br><span class="line"><span class="comment">//参数w代表调用者,task为目标任务,参数deadline是超时目标(非0).它会返回退出时的任务状态.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">awaitJoin</span><span class="params">(WorkQueue w, ForkJoinTask&lt;?&gt; task, <span class="keyword">long</span> deadline)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//返回值.</span></span><br><span class="line">    <span class="keyword">int</span> s = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (task != <span class="keyword">null</span> &amp;&amp; w != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//1.若未进入if必然返回0,进入条件是提供了task和w.</span></span><br><span class="line">        <span class="comment">//保存currentJoin</span></span><br><span class="line">        ForkJoinTask&lt;?&gt; prevJoin = w.currentJoin;</span><br><span class="line">        <span class="comment">//将w的currentJoin暂时设置为task.</span></span><br><span class="line">        U.putOrderedObject(w, QCURRENTJOIN, task);</span><br><span class="line">        <span class="comment">//如果task是CountedCompleter类型,转化并存放到cc.</span></span><br><span class="line">        CountedCompleter&lt;?&gt; cc = (task <span class="keyword">instanceof</span> CountedCompleter) ?</span><br><span class="line">            (CountedCompleter&lt;?&gt;)task : <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//2.循环.</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((s = task.status) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//2.1目标task已完成,返回task的status.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (cc != <span class="keyword">null</span>)</span><br><span class="line">                <span class="comment">//2.2目标task是CountedCompleter,调用前面介绍过的helpComplete方法,maxTasks不限(0).</span></span><br><span class="line">                helpComplete(w, cc, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//2.3否则发现队列w已空,或者非空,则尝试从w中移除并执行task,若出现队列w是空且任务不知道是否完成的情况(t.doExec只是执行,不等结果),</span></span><br><span class="line">            <span class="comment">//此处也会拿到一个true,则调用前面介绍过的helpStealer去帮助小偷.</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (w.base == w.top || w.tryRemoveAndExec(task))</span><br><span class="line">                helpStealer(w, task);</span><br><span class="line">            <span class="comment">//2.4.帮助需要时间,double check,同2.1.</span></span><br><span class="line">            <span class="keyword">if</span> ((s = task.status) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//2.5计算deadline有关的停顿时间ms.</span></span><br><span class="line">            <span class="keyword">long</span> ms, ns;</span><br><span class="line">            <span class="keyword">if</span> (deadline == <span class="number">0L</span>)</span><br><span class="line">                ms = <span class="number">0L</span>;<span class="comment">//未指定deadline,ms为0</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((ns = deadline - System.nanoTime()) &lt;= <span class="number">0L</span>)</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">//要指定的deadline已经早于当前时间了,break返回上面的status</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((ms = TimeUnit.NANOSECONDS.toMillis(ns)) &lt;= <span class="number">0L</span>)</span><br><span class="line">                ms = <span class="number">1L</span>;<span class="comment">//用上面的ns计算ms发现负数,重置ms为1</span></span><br><span class="line">            <span class="comment">//2.6,调用上面提到过的tryCompensate方法,传入当前worker,如果得到true的返回值,等待超时,</span></span><br><span class="line">            <span class="comment">//超时结束增加一个活跃位(前面提到tryCompensate方法最后加增加tc并创建worker,不增加ac,或者莫名其妙地减去了一个ac).</span></span><br><span class="line">            <span class="keyword">if</span> (tryCompensate(w)) &#123;</span><br><span class="line">                task.internalWait(ms);</span><br><span class="line">                U.getAndAddLong(<span class="keyword">this</span>, CTL, AC_UNIT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.最后恢复原来的currentJoin.</span></span><br><span class="line">        U.putOrderedObject(w, QCURRENTJOIN, prevJoin);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="findNonEmptyStealQueue"><a href="#findNonEmptyStealQueue" class="headerlink" title="findNonEmptyStealQueue"></a>findNonEmptyStealQueue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//简单的方法,尝试找一个非空的偷盗队列.使用类似简化的scan的方式查取,可能返回null.</span></span><br><span class="line"><span class="comment">//如果调用者想要尝试使用队列,必须在得到空后多次尝试.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> WorkQueue <span class="title">findNonEmptyStealQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    WorkQueue[] ws; <span class="keyword">int</span> m;  </span><br><span class="line">    <span class="comment">//随机数r</span></span><br><span class="line">    <span class="keyword">int</span> r = ThreadLocalRandom.nextSecondarySeed();</span><br><span class="line">    <span class="comment">//线程池不具备队列,直接返回null.</span></span><br><span class="line">    <span class="keyword">if</span> ((ws = workQueues) != <span class="keyword">null</span> &amp;&amp; (m = ws.length - <span class="number">1</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//循环开始.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> origin = r &amp; m, k = origin, oldSum = <span class="number">0</span>, checkSum = <span class="number">0</span>;;) &#123;</span><br><span class="line">            WorkQueue q; <span class="keyword">int</span> b;</span><br><span class="line">            <span class="keyword">if</span> ((q = ws[k]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((b = q.base) - q.top &lt; <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//查到q这个WorkQueue,并且q非空,则将q返回.</span></span><br><span class="line">                    <span class="keyword">return</span> q;</span><br><span class="line">                <span class="comment">//查到了空队列q,则校验和加上q的base.</span></span><br><span class="line">                checkSum += b;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//前面多次见过的判断进入第二轮的办法.发现ws从头到尾都是null则break返回null,否则出现非null的空队列则将校验和置0继续循环.</span></span><br><span class="line">            <span class="keyword">if</span> ((k = (k + <span class="number">1</span>) &amp; m) == origin) &#123;</span><br><span class="line">                <span class="keyword">if</span> (oldSum == (oldSum = checkSum))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                checkSum = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="helpQuiescePool"><a href="#helpQuiescePool" class="headerlink" title="helpQuiescePool"></a>helpQuiescePool</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//运行任务,直到isQuiescent,本方法顺带维护ctl中的活跃数,但是全过程不会在任务不能找到的情况下</span></span><br><span class="line"><span class="comment">//进行阻塞,而是进行重新扫描,直到所有其他worker的队列中都不能找出任务为止.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">helpQuiescePool</span><span class="params">(WorkQueue w)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//保存当前偷取的任务.</span></span><br><span class="line">    ForkJoinTask&lt;?&gt; ps = w.currentSteal; <span class="comment">// save context</span></span><br><span class="line">    <span class="comment">//循环开始,active置true.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">boolean</span> active = <span class="keyword">true</span>;;) &#123;</span><br><span class="line">        <span class="keyword">long</span> c; WorkQueue q; ForkJoinTask&lt;?&gt; t; <span class="keyword">int</span> b;</span><br><span class="line">        <span class="comment">//1.先把本地任务执行完毕(每次循环扫描).</span></span><br><span class="line">        w.execLocalTasks();   </span><br><span class="line">        <span class="comment">//2.查找到非空队列的情况,除了2以外的34在cas成功的情况下都会终止循环.</span></span><br><span class="line">        <span class="keyword">if</span> ((q = findNonEmptyStealQueue()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//2.1经过3中成功减少了活跃数的情况,下一次循环又扫描到了新的非空队列,需要重激活.</span></span><br><span class="line">            <span class="keyword">if</span> (!active) &#123;      </span><br><span class="line">                active = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//活跃数重新加1.</span></span><br><span class="line">                U.getAndAddLong(<span class="keyword">this</span>, CTL, AC_UNIT);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//2.2再次判断队列非空,并从队列内部数组的base起取出task</span></span><br><span class="line">            <span class="keyword">if</span> ((b = q.base) - q.top &lt; <span class="number">0</span> &amp;&amp; (t = q.pollAt(b)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//将task置于currentSteal</span></span><br><span class="line">                U.putOrderedObject(w, QCURRENTSTEAL, t);</span><br><span class="line">                <span class="comment">//执行task</span></span><br><span class="line">                t.doExec();</span><br><span class="line">                <span class="comment">//如果w的偷取任务数溢出,转到池中.</span></span><br><span class="line">                <span class="keyword">if</span> (++w.nsteals &lt; <span class="number">0</span>)</span><br><span class="line">                    w.transferStealCount(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.仍旧保持active的情况.</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (active) &#123; </span><br><span class="line">            <span class="comment">//3.1能进到这里,肯定本轮循环未能进入2,说明未能发现非空队列,计算新的ctl即nc,它是原ctl减去一个活跃单位.  </span></span><br><span class="line">            <span class="keyword">long</span> nc = (AC_MASK &amp; ((c = ctl) - AC_UNIT)) | (~AC_MASK &amp; c);</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">int</span>)(nc &gt;&gt; AC_SHIFT) + (config &amp; SMASK) &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//3.2新的活跃数加上并行度还不大于0,即不能溢出,说明没有活跃数,不进行cas了,直接break.</span></span><br><span class="line">                <span class="comment">//很明显,上面计算nc的方法,首先ctl正常本身是负,若上面表达式为正,唯一的解释是线程池有活跃线程(前面讲过,活跃一个加一个活跃单元,直到并行度为止)</span></span><br><span class="line">                <span class="comment">//因为两个表达式分别是前16位(在前面再补上16个1)和后16位求和.</span></span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">            <span class="comment">//3.3未能从3.2退出,说明nc表示当前有活跃数存在,进行cas,成功后active置false,不退出循环.</span></span><br><span class="line">            <span class="comment">//若下轮循环发现新的非空队列,会在2.1处增加回来.若未能发现,会在4处加回来.       </span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, nc))</span><br><span class="line">                active = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.前一轮循环进了3.3,当前循环未能进入2.1的情况,判断当前ctl活跃数加上并行度是非正,说明再创建并行度个数的worker也不能溢出.则再加回一个活跃数.</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">int</span>)((c = ctl) &gt;&gt; AC_SHIFT) + (config &amp; SMASK) &lt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                 U.compareAndSwapLong(<span class="keyword">this</span>, CTL, c, c + AC_UNIT))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5.重新恢复currentSteal</span></span><br><span class="line">    U.putOrderedObject(w, QCURRENTSTEAL, ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="nextTaskFor"><a href="#nextTaskFor" class="headerlink" title="nextTaskFor"></a>nextTaskFor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取并移除一个本地或偷来的任务.</span></span><br><span class="line"><span class="keyword">final</span> ForkJoinTask&lt;?&gt; nextTaskFor(WorkQueue w) &#123;</span><br><span class="line">    <span class="keyword">for</span> (ForkJoinTask&lt;?&gt; t;;) &#123;</span><br><span class="line">        WorkQueue q; <span class="keyword">int</span> b;</span><br><span class="line">        <span class="comment">//首先尝试nextLocalTask本地任务.</span></span><br><span class="line">        <span class="keyword">if</span> ((t = w.nextLocalTask()) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        <span class="comment">//获取不到本地任务,尝试从其他队列获取非空队列,获取不到非空队列,返回null.</span></span><br><span class="line">        <span class="keyword">if</span> ((q = findNonEmptyStealQueue()) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//获取到了非空队列,从base处取任务,非空则返回,为空则重复循环.</span></span><br><span class="line">        <span class="keyword">if</span> ((b = q.base) - q.top &lt; <span class="number">0</span> &amp;&amp; (t = q.pollAt(b)) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tryTerminate"><a href="#tryTerminate" class="headerlink" title="tryTerminate"></a>tryTerminate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//前面不止一次提到过tryTerminate,说过它会尝试终止或完成终止.</span></span><br><span class="line"><span class="comment">//参数now如果设置为true,则表示在runState进入SHUTDOWN关闭态(负)时无条件终止,否则需要在进入SHUTDOWN同时没有work也没有活跃worker的情况下终止.</span></span><br><span class="line"><span class="comment">//如果设置enable为true,则下次调用时runState为负,可直接进入关闭流程(如果有now为true,则立即关).</span></span><br><span class="line"><span class="comment">//如果当前线程池进入终止流程或已终止,返回true.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">tryTerminate</span><span class="params">(<span class="keyword">boolean</span> now, <span class="keyword">boolean</span> enable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rs;</span><br><span class="line">    <span class="comment">//common池不可关.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == common)                       <span class="comment">// cannot shut down</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//1.runState拦截和处理.</span></span><br><span class="line">    <span class="keyword">if</span> ((rs = runState) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!enable)</span><br><span class="line">            <span class="comment">//1.1对于当前runState非负的情况,如果没有指定enable,返回false.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//1.2如果指定了enable,将加运行状态锁并更新runState的首位为1,即runState下次进入时为负.不再进入1的拦截处理流程.</span></span><br><span class="line">        rs = lockRunState();                 </span><br><span class="line">        unlockRunState(rs, (rs &amp; ~RSLOCK) | SHUTDOWN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.终止的处理流程.</span></span><br><span class="line">    <span class="keyword">if</span> ((rs &amp; STOP) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//2.1.没有指定即刻关闭,检查是否线程池已进入静寂态.</span></span><br><span class="line">        <span class="keyword">if</span> (!now) &#123; </span><br><span class="line">            <span class="comment">//循环重复直到稳态.初始化校验和机制.                          </span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">long</span> oldSum = <span class="number">0L</span>;;) &#123;        </span><br><span class="line">                WorkQueue[] ws; WorkQueue w; <span class="keyword">int</span> m, b; <span class="keyword">long</span> c;</span><br><span class="line">                <span class="keyword">long</span> checkSum = ctl;<span class="comment">//校验和取ctl</span></span><br><span class="line">                <span class="keyword">if</span> ((<span class="keyword">int</span>)(checkSum &gt;&gt; AC_SHIFT) + (config &amp; SMASK) &gt; <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//2.1.1当前线程池还有活跃的worker(前面解释过).此时应返回false</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;            </span><br><span class="line">                <span class="keyword">if</span> ((ws = workQueues) == <span class="keyword">null</span> || (m = ws.length - <span class="number">1</span>) &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">//2.1.2线程池已经没有队列,直接break进入后续流程.</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//2.1.3从0开始遍历到ws的最后一个队列. </span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= m; ++i) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((w = ws[i]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ((b = w.base) != w.top || w.scanState &gt;= <span class="number">0</span> ||</span><br><span class="line">                            w.currentSteal != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">//只要发现任何一个队列非空,或队列未进入非活跃态(负)或队列仍有偷来的任务未完成.</span></span><br><span class="line">                            <span class="comment">//尝试释放栈顶worker并增加一个活跃数.并返回false,可以据此重新检查.</span></span><br><span class="line">                            tryRelease(c = ctl, ws[m &amp; (<span class="keyword">int</span>)c], AC_UNIT);</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">false</span>;   </span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//队列非null但是空队列,给校验和增加base.</span></span><br><span class="line">                        checkSum += b;</span><br><span class="line">                        <span class="keyword">if</span> ((i &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">                            <span class="comment">//发现非worker的队列,直接让外部禁用.</span></span><br><span class="line">                            w.qlock = -<span class="number">1</span>;    </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//2.1.4校验和一轮不变,break掉进入后置流程.即2.1.3中每一次取ws[i]都是null.</span></span><br><span class="line">                <span class="keyword">if</span> (oldSum == (oldSum = checkSum))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.2.到这一步,已经保证了所有的关闭条件.若还没有给运行状态锁加上stop标记,</span></span><br><span class="line">        <span class="comment">//则给它加上标记.此时再有其他线程去尝试关闭,会进不来2这个分支.</span></span><br><span class="line">        <span class="keyword">if</span> ((runState &amp; STOP) == <span class="number">0</span>) &#123;</span><br><span class="line">            rs = lockRunState();              <span class="comment">// enter STOP phase</span></span><br><span class="line">            unlockRunState(rs, (rs &amp; ~RSLOCK) | STOP);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.经过前面的阶段,已完成预处理或now检查,可进入后置流程.</span></span><br><span class="line">    <span class="keyword">int</span> pass = <span class="number">0</span>;                             <span class="comment">// 3 passes to help terminate</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> oldSum = <span class="number">0L</span>;;) &#123;                <span class="comment">// or until done or stable</span></span><br><span class="line">        WorkQueue[] ws; WorkQueue w; ForkJoinWorkerThread wt; <span class="keyword">int</span> m;</span><br><span class="line">        <span class="keyword">long</span> checkSum = ctl;</span><br><span class="line">        <span class="comment">//3.1前面解释过这个状态表示当前无活跃worker.</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">short</span>)(checkSum &gt;&gt;&gt; TC_SHIFT) + (config &amp; SMASK) &lt;= <span class="number">0</span> ||</span><br><span class="line">            (ws = workQueues) == <span class="keyword">null</span> || (m = ws.length - <span class="number">1</span>) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((runState &amp; TERMINATED) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//在确保无worker活跃的情况,直接将线程池置为TERMINATED.并唤醒所有等待终结的线程.</span></span><br><span class="line">                rs = lockRunState();       </span><br><span class="line">                unlockRunState(rs, (rs &amp; ~RSLOCK) | TERMINATED);</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123; notifyAll(); &#125; </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//到此一定是终结态了,退出循环,结束方法返回true.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.2内循环处理存在活跃worker的情况.从第一个队列开始遍历.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= m; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((w = ws[i]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//3.2.1对每个非null队列,增加一次校验和并禁用队列.</span></span><br><span class="line">                checkSum += w.base;</span><br><span class="line">                w.qlock = -<span class="number">1</span>;               </span><br><span class="line">                <span class="keyword">if</span> (pass &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//3.2.2内循环初次pass为0不能进入.</span></span><br><span class="line">                    <span class="comment">//pass大于0,取消队列上的所有任务,清理队列.</span></span><br><span class="line">                    w.cancelAll();  </span><br><span class="line">                    <span class="keyword">if</span> (pass &gt; <span class="number">1</span> &amp;&amp; (wt = w.owner) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//3.2.3 pass大于1并且队列当前存在owner,扰动它.</span></span><br><span class="line">                        <span class="keyword">if</span> (!wt.isInterrupted()) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;           </span><br><span class="line">                                wt.interrupt();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (w.scanState &lt; <span class="number">0</span>)</span><br><span class="line">                            <span class="comment">//3.2.4如果w代表的worker正在等待任务,让它取消停顿,进入结束流程.</span></span><br><span class="line">                            U.unpark(wt); </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.3如果校验和在几轮(最大为3或m的最大值)循环中改变过,说明并未进入稳态.将oldSum赋值为新的checkSum并重置pass为0.</span></span><br><span class="line">        <span class="keyword">if</span> (checkSum != oldSum) &#123;   </span><br><span class="line">            oldSum = checkSum;</span><br><span class="line">            pass = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.4pass从未被归置为0,稳态增加到大于3且大于m的情况,不能再帮助了,退出循环返回true.</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pass &gt; <span class="number">3</span> &amp;&amp; pass &gt; m) </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//3.5pass未到临界值,加1.</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (++pass &gt; <span class="number">1</span>) &#123; </span><br><span class="line">            <span class="keyword">long</span> c; <span class="keyword">int</span> j = <span class="number">0</span>, sp;</span><br><span class="line">            <span class="comment">//每一次进入3.5都会执行一次循环.如果ctl表示有worker正在scan,最多m次尝试release掉栈顶worker.</span></span><br><span class="line">            <span class="comment">//因为最多只有m个worker在栈中阻塞.因此3.4是合理的.</span></span><br><span class="line">            <span class="keyword">while</span> (j++ &lt;= m &amp;&amp; (sp = (<span class="keyword">int</span>)(c = ctl)) != <span class="number">0</span>)</span><br><span class="line">                tryRelease(c, ws[sp &amp; m], AC_UNIT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="externalSubmit"><a href="#externalSubmit" class="headerlink" title="externalSubmit"></a>externalSubmit</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//字面意思,从外面提交一任务入池.有前面的基础后,此方法很容易理解.</span></span><br><span class="line"><span class="comment">//此方法会处理一些不常见的case,比如辅助进行池的一些初始化过程(首次提交任务),</span></span><br><span class="line"><span class="comment">//如果发现是首次外部线程提交任务,在ws的目标索引位置为空或者出现竞态,它会尝试创建新的共享队列.</span></span><br><span class="line"><span class="comment">//参数task是目标任务,调用者必须保证非空.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">externalSubmit</span><span class="params">(ForkJoinTask&lt;?&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r; </span><br><span class="line">    <span class="comment">//初始化一个用于定位的随机数r,前面曾简单介绍过它和localInit,许多公司的分布式id也是有它的成份.     </span></span><br><span class="line">    <span class="comment">//而这个随机数与线程相当于绑定在了一起,因此,可以使用它表示一个线程特有的东西.                             </span></span><br><span class="line">    <span class="keyword">if</span> ((r = ThreadLocalRandom.getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        ThreadLocalRandom.localInit();</span><br><span class="line">        r = ThreadLocalRandom.getProbe();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//循环尝试压入任务.</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        WorkQueue[] ws; WorkQueue q; <span class="keyword">int</span> rs, m, k;</span><br><span class="line">        <span class="keyword">boolean</span> move = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> ((rs = runState) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//1.发现此时线程池的运行状态已经进入SHUTDOWN,帮助终止线程池,并抛出拒绝异常.</span></span><br><span class="line">            tryTerminate(<span class="keyword">false</span>, <span class="keyword">false</span>);     <span class="comment">// help terminate</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.发现线程池还未初始化,辅助初始化.STARTED为第三位.</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((rs &amp; STARTED) == <span class="number">0</span> ||     <span class="comment">// initialize</span></span><br><span class="line">                 ((ws = workQueues) == <span class="keyword">null</span> || (m = ws.length - <span class="number">1</span>) &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">int</span> ns = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//加锁.</span></span><br><span class="line">            rs = lockRunState();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//double check并尝试初台化stealCounter.它在awaitRunStateLock(尝试加锁)的时候会用来wait,</span></span><br><span class="line">                <span class="comment">//同时也处理了初始化阶段的竞态,还记得在awaitRunStateLock方法中发现stealCounter为null时的注释(初始化竞态)吗?</span></span><br><span class="line">                <span class="keyword">if</span> ((rs &amp; STARTED) == <span class="number">0</span>) &#123;</span><br><span class="line">                    U.compareAndSwapObject(<span class="keyword">this</span>, STEALCOUNTER, <span class="keyword">null</span>,</span><br><span class="line">                                           <span class="keyword">new</span> AtomicLong());</span><br><span class="line">                    <span class="comment">//创建workQueues数组,大小是2的幂.并保证至少有两个插槽(语义理解,如果是4个的话,两个share两个独有).</span></span><br><span class="line">                    <span class="keyword">int</span> p = config &amp; SMASK;</span><br><span class="line">                    <span class="comment">//下面这个比较好理解,总之,最小的情况下,n也会是(1+1)&lt;&lt;1=4,这样保证有两个位置给SHARE两个位置给工作线程.</span></span><br><span class="line">                    <span class="comment">//n的初始值取决于并行度.</span></span><br><span class="line">                    <span class="keyword">int</span> n = (p &gt; <span class="number">1</span>) ? p - <span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line">                    n |= n &gt;&gt;&gt; <span class="number">1</span>; n |= n &gt;&gt;&gt; <span class="number">2</span>;  n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">                    n |= n &gt;&gt;&gt; <span class="number">8</span>; n |= n &gt;&gt;&gt; <span class="number">16</span>; n = (n + <span class="number">1</span>) &lt;&lt; <span class="number">1</span>;</span><br><span class="line">                    workQueues = <span class="keyword">new</span> WorkQueue[n];</span><br><span class="line">                    <span class="comment">//新的运行状态.</span></span><br><span class="line">                    ns = STARTED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//完成了辅助初始化,则解锁,并置runState加上STARTED标识.</span></span><br><span class="line">                unlockRunState(rs, (rs &amp; ~RSLOCK) | ns);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.某轮循环发现早已完成初始化,使用本线程的随机数r计算索引,发现ws[k]存在.说明已被别的线程在此初始化了一个队列.</span></span><br><span class="line">        <span class="comment">//注意索引k的值的计算,它与m进行与运算,保证不大于m,同时与SQMASK,即share-queue mask,它的值是0X007e,前面说过,</span></span><br><span class="line">        <span class="comment">//很明显,它是整数的2至7位,保证了共享队列只能放在ws的偶数位.</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((q = ws[k = r &amp; m &amp; SQMASK]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//3.1对队列加锁.</span></span><br><span class="line">            <span class="keyword">if</span> (q.qlock == <span class="number">0</span> &amp;&amp; U.compareAndSwapInt(q, QLOCK, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">//取队列的数组和top</span></span><br><span class="line">                ForkJoinTask&lt;?&gt;[] a = q.array;</span><br><span class="line">                <span class="keyword">int</span> s = q.top;</span><br><span class="line">                <span class="comment">//初始化提交或者扩容.</span></span><br><span class="line">                <span class="keyword">boolean</span> submitted = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;                      <span class="comment">// locked version of push</span></span><br><span class="line">                    <span class="comment">//||左边的语句指符合添加元素的条件,右边表示如果不符合添加条件,则进行扩容.</span></span><br><span class="line">                    <span class="keyword">if</span> ((a != <span class="keyword">null</span> &amp;&amp; a.length &gt; s + <span class="number">1</span> - q.base) ||</span><br><span class="line">                        (a = q.growArray()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//符合添加条件或扩容成功,取top对应的索引j.</span></span><br><span class="line">                        <span class="keyword">int</span> j = (((a.length - <span class="number">1</span>) &amp; s) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">                        <span class="comment">//向top放入task.</span></span><br><span class="line">                        U.putOrderedObject(a, j, task);</span><br><span class="line">                        <span class="comment">//给top加1.</span></span><br><span class="line">                        U.putOrderedInt(q, QTOP, s + <span class="number">1</span>);</span><br><span class="line">                        <span class="comment">//标记为已提交.</span></span><br><span class="line">                        submitted = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//释放qlock.</span></span><br><span class="line">                    U.compareAndSwapInt(q, QLOCK, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (submitted) &#123;</span><br><span class="line">                    <span class="comment">//如果提交成功,则尝试唤醒top或创建一个worker(如果太少).并返回.</span></span><br><span class="line">                    signalWork(ws, q);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//竞态失败,标记move</span></span><br><span class="line">            move = <span class="keyword">true</span>;                   <span class="comment">// move on failure</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.2计算出的位置没有queue,且runState未锁,创建一个新的.</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (((rs = runState) &amp; RSLOCK) == <span class="number">0</span>) &#123; <span class="comment">// create new queue</span></span><br><span class="line">            <span class="comment">//共享队列没有owner.</span></span><br><span class="line">            q = <span class="keyword">new</span> WorkQueue(<span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//随机数就用线程的随机数r.</span></span><br><span class="line">            q.hint = r;</span><br><span class="line">            <span class="comment">//config的第32位置1表示共享队列</span></span><br><span class="line">            q.config = k | SHARED_QUEUE;</span><br><span class="line">            <span class="comment">//队列的scanState直接置为INACTIVE,很明显,参考前面的描述,</span></span><br><span class="line">            <span class="comment">//它没有工作线程,也不会参与活化和scan阻塞的过程,也不会将自己的scanState压入ctl后32位做栈元素.</span></span><br><span class="line">            q.scanState = INACTIVE;</span><br><span class="line">            <span class="comment">//加锁.</span></span><br><span class="line">            rs = lockRunState();         </span><br><span class="line">            <span class="keyword">if</span> (rs &gt; <span class="number">0</span> &amp;&amp;  (ws = workQueues) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                k &lt; ws.length &amp;&amp; ws[k] == <span class="keyword">null</span>)</span><br><span class="line">                <span class="comment">//仍旧符合添加条件,池未终结,将q赋给ws[k],否则的话,可能在下一轮循环进入1帮助终止,</span></span><br><span class="line">                <span class="comment">//也可能进入2用现成的队列内的任务数组添加元素到top.也可能在4处发现竞态,并最终导致5处重初始化r并重新循环找索引.</span></span><br><span class="line">                ws[k] = q;                 <span class="comment">// else terminated</span></span><br><span class="line">            unlockRunState(rs, rs &amp; ~RSLOCK);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.标记繁忙.</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            move = <span class="keyword">true</span>;                   <span class="comment">// move if busy</span></span><br><span class="line">        <span class="comment">//5.本轮循环经历2的竞态失败或4的繁忙,重新初始化一个r供下轮循环使用.</span></span><br><span class="line">        <span class="keyword">if</span> (move)</span><br><span class="line">            r = ThreadLocalRandom.advanceProbe(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="externalPush"><a href="#externalPush" class="headerlink" title="externalPush"></a>externalPush</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试将给定的task添加到一个提交者当前的队列中,如果还需要额外的初始化操作等,使用上面的externalSubmit.</span></span><br><span class="line"><span class="comment">//我们知道,绝大多数的情况下,不需要初始化线程池的任务数组(整个线程池就一次),不需要初始化一个工作队列(每个ws一个位置只一次).</span></span><br><span class="line"><span class="comment">//因此它相当于先尝试用最简单直接的办法将任务压入队列,如果ws存在而队列需要初始化,或者池本身就没有完成初始化,再使用externalSubmit.</span></span><br><span class="line"><span class="comment">//参数task是要提交的任务,调用者本身必须保证它非空.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">externalPush</span><span class="params">(ForkJoinTask&lt;?&gt; task)</span> </span>&#123;</span><br><span class="line">    WorkQueue[] ws; WorkQueue q; <span class="keyword">int</span> m;</span><br><span class="line">    <span class="comment">//老办法,初始的随机数.运行状态.</span></span><br><span class="line">    <span class="keyword">int</span> r = ThreadLocalRandom.getProbe();</span><br><span class="line">    <span class="keyword">int</span> rs = runState;</span><br><span class="line">    <span class="comment">//快速压入的代码分支,条件是队列数组ws已分配,非空,且根据r计算出来索引位取出的队列</span></span><br><span class="line">    <span class="comment">//存在且已完成初始化,线程池未进入SHUTDOWN,并且能够对队列进行加锁.</span></span><br><span class="line">    <span class="keyword">if</span> ((ws = workQueues) != <span class="keyword">null</span> &amp;&amp; (m = (ws.length - <span class="number">1</span>)) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (q = ws[m &amp; r &amp; SQMASK]) != <span class="keyword">null</span> &amp;&amp; r != <span class="number">0</span> &amp;&amp; rs &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        U.compareAndSwapInt(q, QLOCK, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="comment">//快速入队.</span></span><br><span class="line">        ForkJoinTask&lt;?&gt;[] a; <span class="keyword">int</span> am, n, s;</span><br><span class="line">        <span class="keyword">if</span> ((a = q.array) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            <span class="comment">//第二个条件是没有到扩容条件.</span></span><br><span class="line">            (am = a.length - <span class="number">1</span>) &gt; (n = (s = q.top) - q.base)) &#123;</span><br><span class="line">            <span class="comment">//计算出top的索引j,并将当前任务放入,将top加1</span></span><br><span class="line">            <span class="keyword">int</span> j = ((am &amp; s) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">            U.putOrderedObject(a, j, task);</span><br><span class="line">            U.putOrderedInt(q, QTOP, s + <span class="number">1</span>);</span><br><span class="line">            U.putIntVolatile(q, QLOCK, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (n &lt;= <span class="number">1</span>)</span><br><span class="line">                <span class="comment">//发现原来的队列长度很短,有可能有worker正在scan,尝试唤醒一个worker或添加一个worker</span></span><br><span class="line">                signalWork(ws, q);</span><br><span class="line">            <span class="comment">//只要成功压入,返回.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//最后解锁.</span></span><br><span class="line">        U.compareAndSwapInt(q, QLOCK, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//未能成功压栈,原因可能是线程池未初始化,工作队列未初始化,队列达到扩容阈值等.使用externalSubmit进行.</span></span><br><span class="line">    externalSubmit(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="tryExternalUnpush"><a href="#tryExternalUnpush" class="headerlink" title="tryExternalUnpush"></a>tryExternalUnpush</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//尝试弹出外部提交者的任务,找到队列,非空时加锁,最后调整top,每次进行都会检查失败,尽管很少失败.</span></span><br><span class="line"><span class="comment">//在前面ForkJoinTask和CountedCompleter等文章中曾引用过相关方法,此方法可以令等待任务的线程</span></span><br><span class="line"><span class="comment">//自行将任务出队并执行,而不是在池内线程还忙碌的情况下干等.但是该队列可能被其他外部线程放置了新的栈顶</span></span><br><span class="line"><span class="comment">//且看内部方法实现,当且仅当task是栈顶才有用.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryExternalUnpush</span><span class="params">(ForkJoinTask&lt;?&gt; task)</span> </span>&#123;</span><br><span class="line">    WorkQueue[] ws; WorkQueue w; ForkJoinTask&lt;?&gt;[] a; <span class="keyword">int</span> m, s;</span><br><span class="line">    <span class="comment">//当前线程生成随机数r.</span></span><br><span class="line">    <span class="keyword">int</span> r = ThreadLocalRandom.getProbe();</span><br><span class="line">    <span class="keyword">if</span> ((ws = workQueues) != <span class="keyword">null</span> &amp;&amp; (m = ws.length - <span class="number">1</span>) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (w = ws[m &amp; r &amp; SQMASK]) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        (a = w.array) != <span class="keyword">null</span> &amp;&amp; (s = w.top) != w.base) &#123;</span><br><span class="line">        <span class="comment">//进入if的条件.线程池已初始化,ws存在,w存在且w非空队列.注意,仍旧取的偶数索引.</span></span><br><span class="line">        <span class="comment">//计算当前最顶部元素的索引j</span></span><br><span class="line">        <span class="keyword">long</span> j = (((a.length - <span class="number">1</span>) &amp; (s - <span class="number">1</span>)) &lt;&lt; ASHIFT) + ABASE;</span><br><span class="line">        <span class="comment">//尝试加锁qlock,加锁成功进入.</span></span><br><span class="line">        <span class="keyword">if</span> (U.compareAndSwapInt(w, QLOCK, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">//进一步check队列w的top和w的array未变.</span></span><br><span class="line">            <span class="keyword">if</span> (w.top == s &amp;&amp; w.array == a &amp;&amp;</span><br><span class="line">                <span class="comment">//队列w的顶部元素就是参数task</span></span><br><span class="line">                U.getObject(a, j) == task &amp;&amp;</span><br><span class="line">                <span class="comment">//成功将task出队</span></span><br><span class="line">                U.compareAndSwapObject(a, j, task, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="comment">//将top减1并释放锁,返回true.</span></span><br><span class="line">                U.putOrderedInt(w, QTOP, s - <span class="number">1</span>);</span><br><span class="line">                U.putOrderedInt(w, QLOCK, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//加锁前已有更改或者task本身就不是顶部任务,直接解锁.返回false.</span></span><br><span class="line">            U.compareAndSwapInt(w, QLOCK, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//默认返回fasle</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="externalHelpComplete"><a href="#externalHelpComplete" class="headerlink" title="externalHelpComplete"></a>externalHelpComplete</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//外部提交者helpComplete.介绍CountedCompleter提过此方法.</span></span><br><span class="line"><span class="comment">//当目标任务task是CountedCompleter类型时可以手动调用CountedCompleter::helpComplete,它会调用此处,ForkJoinTask::get也有调用.</span></span><br><span class="line"><span class="comment">//此方法可以令外部线程在等待task时帮助completer栈链上它的子孙任务完成,从而加速task的完成.</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">externalHelpComplete</span><span class="params">(CountedCompleter&lt;?&gt; task, <span class="keyword">int</span> maxTasks)</span> </span>&#123;</span><br><span class="line">    WorkQueue[] ws; <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">int</span> r = ThreadLocalRandom.getProbe();</span><br><span class="line">    <span class="keyword">return</span> ((ws = workQueues) == <span class="keyword">null</span> || (n = ws.length) == <span class="number">0</span>) ? <span class="number">0</span> :</span><br><span class="line">        <span class="comment">//ws未初始化,返回0,否则返回helpComplete的结果,取w的方式不变.</span></span><br><span class="line">        helpComplete(ws[(n - <span class="number">1</span>) &amp; r &amp; SQMASK], task, maxTasks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="invoke-2"><a href="#invoke-2" class="headerlink" title="invoke"></a>invoke</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//invoke方法会尝试将task压入池,但也会立即join等待,压入池的方法即前面介绍过的externalPush,同样join方法也可能会</span></span><br><span class="line"><span class="comment">//导致当前线程自身完成了任务(池中工作线程忙碌而当前线程立即从队列中获取了该任务).</span></span><br><span class="line"><span class="comment">//执行结束后返回该任务的执行结果,当出现异常时,直接重新抛出.但也可能抛出拒绝异常(拒绝入队).</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">invoke</span><span class="params">(ForkJoinTask&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    externalPush(task);</span><br><span class="line">    <span class="keyword">return</span> task.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="execute-1"><a href="#execute-1" class="headerlink" title="execute"></a>execute</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//安排给定任务的执行,异步进行.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ForkJoinTask&lt;?&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    externalPush(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="execute-2"><a href="#execute-2" class="headerlink" title="execute"></a>execute</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//继承自AbstractExecutorService的方法列表</span></span><br><span class="line"><span class="comment">//execute方法,传入runnable,使用前面文章介绍的ForkJoinTask.RunnableExecuteAction适配器.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    ForkJoinTask&lt;?&gt; job;</span><br><span class="line">    <span class="keyword">if</span> (task <span class="keyword">instanceof</span> ForkJoinTask&lt;?&gt;) <span class="comment">// avoid re-wrap</span></span><br><span class="line">        job = (ForkJoinTask&lt;?&gt;) task;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        job = <span class="keyword">new</span> ForkJoinTask.RunnableExecuteAction(task);</span><br><span class="line">    externalPush(job);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="submit-1"><a href="#submit-1" class="headerlink" title="submit"></a>submit</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对callable的适配,前面也提过.</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">ForkJoinTask&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">    ForkJoinTask&lt;T&gt; job = <span class="keyword">new</span> ForkJoinTask.AdaptedCallable&lt;T&gt;(task);</span><br><span class="line">    externalPush(job);</span><br><span class="line">    <span class="keyword">return</span> job;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对task和result的适配.</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">ForkJoinTask&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span> </span>&#123;</span><br><span class="line">    ForkJoinTask&lt;T&gt; job = <span class="keyword">new</span> ForkJoinTask.AdaptedRunnable&lt;T&gt;(task, result);</span><br><span class="line">    externalPush(job);</span><br><span class="line">    <span class="keyword">return</span> job;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对submit一个Runnable的适配.避免重复包装.因为ForkJoinTask也可以实现runnable.</span></span><br><span class="line"><span class="comment">//典型的场景,先submit一个runnable,得到返回的job,再将job给submit进去.</span></span><br><span class="line"><span class="keyword">public</span> ForkJoinTask&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    ForkJoinTask&lt;?&gt; job;</span><br><span class="line">    <span class="keyword">if</span> (task <span class="keyword">instanceof</span> ForkJoinTask&lt;?&gt;) <span class="comment">// avoid re-wrap</span></span><br><span class="line">        job = (ForkJoinTask&lt;?&gt;) task;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        job = <span class="keyword">new</span> ForkJoinTask.AdaptedRunnableAction(task);</span><br><span class="line">    externalPush(job);</span><br><span class="line">    <span class="keyword">return</span> job;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="invokeAll-1"><a href="#invokeAll-1" class="headerlink" title="invokeAll"></a>invokeAll</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行所有任务.一样先入队再执行,可能出现本外部线程又偷回来执行的情况.</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) &#123;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;Future&lt;T&gt;&gt; futures = <span class="keyword">new</span> ArrayList&lt;&gt;(tasks.size());</span><br><span class="line">    <span class="comment">//标记是否有异常.</span></span><br><span class="line">    <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Callable&lt;T&gt; t : tasks) &#123;</span><br><span class="line">            ForkJoinTask&lt;T&gt; f = <span class="keyword">new</span> ForkJoinTask.AdaptedCallable&lt;T&gt;(t);</span><br><span class="line">            <span class="comment">//把所有任务包成适配器并加入futures列表.</span></span><br><span class="line">            futures.add(f);</span><br><span class="line">            <span class="comment">//压入池.</span></span><br><span class="line">            externalPush(f);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = futures.size(); i &lt; size; i++)</span><br><span class="line">            <span class="comment">//对每一个任务进行静默等待.</span></span><br><span class="line">            ((ForkJoinTask&lt;?&gt;)futures.get(i)).quietlyJoin();</span><br><span class="line">        <span class="comment">//上面的循环成功退出,置true返回.</span></span><br><span class="line">        done = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> futures;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!done)</span><br><span class="line">            <span class="comment">//发现是异常退出,则依次取消任务.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = futures.size(); i &lt; size; i++)</span><br><span class="line">                futures.get(i).cancel(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="getRunningThreadCount"><a href="#getRunningThreadCount" class="headerlink" title="getRunningThreadCount"></a>getRunningThreadCount</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//估计当前线程池中正在运行(偷任务或运行任务)的线程,也就是未阻塞等待任务的线程.它会过度估计正在运行的线程数.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRunningThreadCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">    WorkQueue[] ws; WorkQueue w;</span><br><span class="line">    <span class="keyword">if</span> ((ws = workQueues) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; ws.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((w = ws[i]) != <span class="keyword">null</span> &amp;&amp; w.isApparentlyUnblocked())</span><br><span class="line">                <span class="comment">//只取ws奇数索引的worker,只要它isApparentlyUnblocked,即未进入waiting,blocking,wating_timed.</span></span><br><span class="line">                ++rc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="getActiveThreadCount"><a href="#getActiveThreadCount" class="headerlink" title="getActiveThreadCount"></a>getActiveThreadCount</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//估计当前正在进行偷取或执行任务的线程(未阻塞等待任务),此方法也会过度估计.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getActiveThreadCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//很明显,根据前面我们研究了好久的逻辑,每release/signal的worker都会增加一个活跃数单元,</span></span><br><span class="line">    <span class="comment">//初始添加的worker也会增加一个活跃数单元和总数,显然只要有active的,那么r必然是一个溢出的正数.</span></span><br><span class="line">    <span class="keyword">int</span> r = (config &amp; SMASK) + (<span class="keyword">int</span>)(ctl &gt;&gt; AC_SHIFT);</span><br><span class="line">    <span class="keyword">return</span> (r &lt;= <span class="number">0</span>) ? <span class="number">0</span> : r; <span class="comment">//忽略负值.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="isQuiescent"><a href="#isQuiescent" class="headerlink" title="isQuiescent"></a>isQuiescent</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断线程池此刻是否已经进入静寂态,所谓的静寂态是指当前线程池中所有worker都已经阻塞在等待任务了,</span></span><br><span class="line"><span class="comment">//因为没有任何任务可供他们偷取或执行,也没有任何挂起的提交入池的任务.此方法相对保守,并不是所有线程都空闲的情况下</span></span><br><span class="line"><span class="comment">//立即会返回true,只有在他们减少了活跃数之后.(也就是保持空闲一段时间)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isQuiescent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//前面分析过,显然这个表达式不大于0即为不溢出的情况,回忆前面关于scan时,终止时等的降低活跃数.</span></span><br><span class="line">    <span class="keyword">return</span> (config &amp; SMASK) + (<span class="keyword">int</span>)(ctl &gt;&gt; AC_SHIFT) &lt;= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown"></a>shutdown</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//此方法的执行参数,注意,now传false,enable传true.</span></span><br><span class="line"><span class="comment">//它的执行结果很简单(可以参考前面的tryTerminate).</span></span><br><span class="line"><span class="comment">//1.此前已经调用过tryTerminate并enable,或者调过shutdown,那会导致一次终结.</span></span><br><span class="line"><span class="comment">//2.初次调用,前面提交过的任务继续执行,但不会接受新的任务(因为runState首位置1了).</span></span><br><span class="line"><span class="comment">//3.commonPool不许关.</span></span><br><span class="line"><span class="comment">//4.已关的,调用了也没什么效果.但第二次调用时,已经在过程中的任务可能受此影响取消.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    checkPermission();</span><br><span class="line">    tryTerminate(<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="shutdownNow"><a href="#shutdownNow" class="headerlink" title="shutdownNow"></a>shutdownNow</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//它会尝试立即取消和停止所有的任务,拒绝后续提交的任务.如果是common池则无效果.</span></span><br><span class="line"><span class="comment">//如果已经关闭,再调用无影响.正在被提交入池或正在执行的任务(在调用此方法执行时)可能会被取消,也可能不会(取决于时机,可能早于取消过程而完成执行).</span></span><br><span class="line"><span class="comment">//它会取消掉已存在的任务或未执行的任务.方法总会返回一个空的list.(与其他executor不同)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    checkPermission();</span><br><span class="line">    tryTerminate(<span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="isTerminated"><a href="#isTerminated" class="headerlink" title="isTerminated"></a>isTerminated</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//很好理解,runState的31位是1,而仅有在shutdown方法中所有worker都已闲置或ws为空才会加上此位.显然此时所有任务都已完成.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTerminated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (runState &amp; TERMINATED) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="isTerminating"><a href="#isTerminating" class="headerlink" title="isTerminating"></a>isTerminating</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTerminating</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rs = runState;</span><br><span class="line">    <span class="keyword">return</span> (rs &amp; STOP) != <span class="number">0</span> &amp;&amp; (rs &amp; TERMINATED) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="isShutdown"><a href="#isShutdown" class="headerlink" title="isShutdown"></a>isShutdown</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//已SHUTDOWN,首位标记,显然只要shutdown方法调用并传enable为true一定会有此结果.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isShutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (runState &amp; SHUTDOWN) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="awaitTermination"><a href="#awaitTermination" class="headerlink" title="awaitTermination"></a>awaitTermination</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//等待一个shutdown请求后所有的任务完成或者发生超时,或者当前线程被扰动(第一优先级).</span></span><br><span class="line"><span class="comment">//因为common池永远不会随程序调用shutdown而终止,因此使用commonPool调用此方法时,</span></span><br><span class="line"><span class="comment">//会直接等效于awaitQuiescence,而且永远会返回false.</span></span><br><span class="line"><span class="comment">//返回true,代表当前线程池终止了,false代表超时了.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="comment">//1.当前线程中断,抛出异常.</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == common) &#123;</span><br><span class="line">        <span class="comment">//2.common池等效于awaitQuiescence并返回false.</span></span><br><span class="line">        awaitQuiescence(timeout, unit);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">    <span class="keyword">if</span> (isTerminated())</span><br><span class="line">        <span class="comment">//3.发现所有任务已完成返回true.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>)</span><br><span class="line">        <span class="comment">//4.已超时返回false.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//5.计算deadline并进入循环等待逻辑.</span></span><br><span class="line">    <span class="keyword">long</span> deadline = System.nanoTime() + nanos;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isTerminated())</span><br><span class="line">                <span class="comment">//5.1循环中发现已达到完成态,返回true.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>)</span><br><span class="line">                <span class="comment">//5.2循环时发现超时,false.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//5.3循环时减少时间并等待.</span></span><br><span class="line">            <span class="keyword">long</span> millis = TimeUnit.NANOSECONDS.toMillis(nanos);</span><br><span class="line">            wait(millis &gt; <span class="number">0L</span> ? millis : <span class="number">1L</span>);</span><br><span class="line">            nanos = deadline - System.nanoTime();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="awaitQuiescence"><a href="#awaitQuiescence" class="headerlink" title="awaitQuiescence"></a>awaitQuiescence</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//等待静寂.如果当前线程是池内线程,等效于ForkJoinTask::helpQuiesce方法,否则只是等待.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">awaitQuiescence</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">    ForkJoinWorkerThread wt;</span><br><span class="line">    Thread thread = Thread.currentThread();</span><br><span class="line">    <span class="keyword">if</span> ((thread <span class="keyword">instanceof</span> ForkJoinWorkerThread) &amp;&amp;</span><br><span class="line">        (wt = (ForkJoinWorkerThread)thread).pool == <span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//1.线程是ForkJoinWorkerThread,帮助静寂.返回true.</span></span><br><span class="line">        helpQuiescePool(wt.workQueue);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.不是池内线程,准备计时,初始化若干变量.</span></span><br><span class="line">    <span class="keyword">long</span> startTime = System.nanoTime();</span><br><span class="line">    WorkQueue[] ws;</span><br><span class="line">    <span class="keyword">int</span> r = <span class="number">0</span>, m;</span><br><span class="line">    <span class="keyword">boolean</span> found = <span class="keyword">true</span>;<span class="comment">//代表发现任务.</span></span><br><span class="line">    <span class="comment">//3.循环等待静寂或超时.</span></span><br><span class="line">    <span class="keyword">while</span> (!isQuiescent() &amp;&amp; (ws = workQueues) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">           (m = ws.length - <span class="number">1</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//3.1有趣的地方,只有本轮没找到任务才会进行超时判断.</span></span><br><span class="line">        <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">            <span class="comment">//3.1.1判断超时了,返回false.</span></span><br><span class="line">            <span class="keyword">if</span> ((System.nanoTime() - startTime) &gt; nanos)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//3.1.2没超时,放弃执行权一段时间,不能阻塞在此.</span></span><br><span class="line">            Thread.yield(); <span class="comment">// cannot block</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//改为false.</span></span><br><span class="line">        found = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//4.内循环从数组中间开始,一直递减到0.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = (m + <span class="number">1</span>) &lt;&lt; <span class="number">2</span>; j &gt;= <span class="number">0</span>; --j) &#123;</span><br><span class="line">            ForkJoinTask&lt;?&gt; t; WorkQueue q; <span class="keyword">int</span> b, k;</span><br><span class="line">            <span class="comment">//4.1取队列从0开始,只要取出了ws的非空队列成员,进入逻辑.</span></span><br><span class="line">            <span class="keyword">if</span> ((k = r++ &amp; m) &lt;= m &amp;&amp; k &gt;= <span class="number">0</span> &amp;&amp; (q = ws[k]) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (b = q.base) - q.top &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//4.2 found标记true</span></span><br><span class="line">                found = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> ((t = q.pollAt(b)) != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//4.3尝试从底部取出任务并执行.相当于帮助静寂</span></span><br><span class="line">                    t.doExec();</span><br><span class="line">                <span class="comment">//进入4.1,即break掉内循环,可能凑巧,执行完一个任务就静寂了.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//能从while循环break出来或者循环条件为假退出,说明达到静寂.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ManagedBlocker"><a href="#ManagedBlocker" class="headerlink" title="ManagedBlocker"></a>ManagedBlocker</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MangedBlocker接口.它是一个为运行在ForkJoinPool中的任务维护并行度的接口</span></span><br><span class="line"><span class="comment">//我们可以通过拓展它来实现在ForkJoinPool中运行的任务的并行度管理.它只有两个方法.</span></span><br><span class="line"><span class="comment">//isReleasable方法会在没有必要阻塞时一定返回true,block方法会在必要时阻塞当前线程,</span></span><br><span class="line"><span class="comment">//它内部可以调用isReleasable.而这个调度需要使用ForkJoinPool#managedBlock(ManagedBlocker)</span></span><br><span class="line"><span class="comment">//它会尝试去调度,避免长期的阻塞,它允许更灵活的内部处理.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">ManagedBlocker</span> </span>&#123;</span><br><span class="line">    <span class="comment">//可能会阻塞一个线程,比如等待监视器,当返回true时表示认为当前没有必要继续block.</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">block</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回true表示认为没有必要block.</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isReleasable</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//运行给定的阻塞任务,当在ForkJoinPool运行ForkJoinTask时,此方法在当前线程阻塞的情况下(调用blocker.block),</span></span><br><span class="line"><span class="comment">//认为需要保持必要并行度时安排一个备用线程,方法内重复调用blocker.isReleasable和blocker.block.且前者必在后者前,</span></span><br><span class="line"><span class="comment">//它返回false时才会有后者.如果没运行在ForkJoinPool内,那么方法的行为等效于下面这段代码:</span></span><br><span class="line"><span class="comment">//while(!blocker.isReleasable())&#123;if(blocker.block() break;&#125;</span></span><br><span class="line"><span class="comment">//参数blocker是上面的接口的实现类,在前面的文章CompletableFuture和响应式编程中曾见到一个实现类.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">managedBlock</span><span class="params">(ManagedBlocker blocker)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ForkJoinPool p;</span><br><span class="line">    ForkJoinWorkerThread wt;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    <span class="comment">//1.当前是ForkJoinPool池内线程时的逻辑.</span></span><br><span class="line">    <span class="keyword">if</span> ((t <span class="keyword">instanceof</span> ForkJoinWorkerThread) &amp;&amp;</span><br><span class="line">        (p = (wt = (ForkJoinWorkerThread)t).pool) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        WorkQueue w = wt.workQueue;</span><br><span class="line">        <span class="comment">//1.1取出工作队列,进行循环,blocker.isReleasable判断当前并非没有必要加锁时进入.</span></span><br><span class="line">        <span class="keyword">while</span> (!blocker.isReleasable()) &#123;</span><br><span class="line">            <span class="comment">//1.2要加锁,尝试补偿,它会在此时唤醒一个空闲的线程或创建一个新的线程来补偿当前线程的阻塞.</span></span><br><span class="line">            <span class="keyword">if</span> (p.tryCompensate(w)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//1.3当前线程阻塞等待.</span></span><br><span class="line">                    <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (!blocker.isReleasable() &amp;&amp;</span><br><span class="line">                                 !blocker.block());</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    U.getAndAddLong(p, CTL, AC_UNIT);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.非池内线程的逻辑.同上面的阻塞逻辑.</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (!blocker.isReleasable() &amp;&amp;</span><br><span class="line">                     !blocker.block());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-51-StampedLock详解</title>
      <link href="/2020/07/18/50320/hub/"/>
      <url>/2020/07/18/50320/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200718131809394.png" alt="image-20200718131809394"></p><h2 id="StampedLock相关API"><a href="#StampedLock相关API" class="headerlink" title="StampedLock相关API"></a>StampedLock相关API</h2><p>&emsp;&emsp;<strong>StampedLock</strong>是在JDK8新增的，主要针对<code>读写锁</code>进行了一些增强，并且支持读写锁之间的转换，更细粒度的控制并发，它的内部也不是基于<code>AQS</code>实现的。支持三种模式：<code>写模式</code>、<code>读模式</code>、<code>乐观读模式</code>（适合读多写少的业务场景）。</p><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StampedLock</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">StampedLock stampedLock = <span class="keyword">new</span> StampedLock();</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="writeLock"><a href="#writeLock" class="headerlink" title="writeLock"></a>writeLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//writeLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取写入锁</span></span><br><span class="line"><span class="comment"> * 2.获取失败则回阻塞当前线程、直到成功获取锁</span></span><br><span class="line"><span class="comment"> * 3.返回值：可以用来解锁或转换模式的戳记</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.writeLock();</span><br></pre></td></tr></table></figure><h4 id="tryWriteLock"><a href="#tryWriteLock" class="headerlink" title="tryWriteLock"></a>tryWriteLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tryWriteLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.没有锁存在的情况下获取写入锁</span></span><br><span class="line"><span class="comment"> * 2.否则返回0</span></span><br><span class="line"><span class="comment"> * 3.可以设置等待超时时间</span></span><br><span class="line"><span class="comment"> * 4.返回值：可以用来解锁或转换模式的戳记</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.tryWriteLock();</span><br><span class="line">stampedLock.tryWriteLock(<span class="number">1</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><h4 id="writeLockInterruptibly"><a href="#writeLockInterruptibly" class="headerlink" title="writeLockInterruptibly"></a>writeLockInterruptibly</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//writeLockInterruptibly</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取写锁</span></span><br><span class="line"><span class="comment"> * 2.成功返回状态值，失败返回0，或抛出InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.writeLockInterruptibly();</span><br></pre></td></tr></table></figure><h4 id="readLock"><a href="#readLock" class="headerlink" title="readLock"></a>readLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//readLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取读取锁（悲观、非独占）</span></span><br><span class="line"><span class="comment"> * 2.获取不到则会陷入阻塞直到成功获取到读取锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.readLock();</span><br></pre></td></tr></table></figure><h4 id="tryReadLock"><a href="#tryReadLock" class="headerlink" title="tryReadLock"></a>tryReadLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tryReadLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.立即获得读取锁</span></span><br><span class="line"><span class="comment"> * 2.否则返回0</span></span><br><span class="line"><span class="comment"> * 3.可以设置等待超时时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.tryReadLock();</span><br><span class="line">stampedLock.tryReadLock(<span class="number">1</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><h4 id="tryOptimisticRead"><a href="#tryOptimisticRead" class="headerlink" title="tryOptimisticRead"></a>tryOptimisticRead</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tryOptimisticRead</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取乐观读取锁</span></span><br><span class="line"><span class="comment"> * 2.返回邮戳stamp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.tryOptimisticRead();</span><br></pre></td></tr></table></figure><h4 id="validate"><a href="#validate" class="headerlink" title="validate"></a>validate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//validate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.验证邮戳（tryOptimisticRead方法调用前后）有没有写锁占用锁资源</span></span><br><span class="line"><span class="comment"> * 2.占用：返回false</span></span><br><span class="line"><span class="comment"> * 3.未占用：返回true</span></span><br><span class="line"><span class="comment"> * 4.stamp == 0:返回false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.validate(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="unlockWrite"><a href="#unlockWrite" class="headerlink" title="unlockWrite"></a>unlockWrite</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unlockWrite</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.state和stamp匹配释放写入锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.unlockWrite(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="unlockRead"><a href="#unlockRead" class="headerlink" title="unlockRead"></a>unlockRead</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unlockRead</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.state和stamp匹配释放读取锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.unlockRead(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="unlock"><a href="#unlock" class="headerlink" title="unlock"></a>unlock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unlock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.state匹配stamp时,释放一个读锁或写锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.unlock(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="tryConvertToWriteLock"><a href="#tryConvertToWriteLock" class="headerlink" title="tryConvertToWriteLock"></a>tryConvertToWriteLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tryConvertToWriteLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.进行state匹配stamp</span></span><br><span class="line"><span class="comment"> * 2.stamp如果已经持有写锁，直接返回</span></span><br><span class="line"><span class="comment"> * 3.读模式，但是没有更多的读取者，并返回一个写锁stamp</span></span><br><span class="line"><span class="comment"> * 4.有一个乐观读锁，只在即时可用的前提下返回一个写锁stamp</span></span><br><span class="line"><span class="comment"> * 5.其他情况都返回0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.tryConvertToWriteLock(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="tryConvertToReadLock"><a href="#tryConvertToReadLock" class="headerlink" title="tryConvertToReadLock"></a>tryConvertToReadLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tryConvertToReadLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.进行state匹配stamp</span></span><br><span class="line"><span class="comment"> * 2.stamp如果持有写锁，释放写锁，并持有读锁</span></span><br><span class="line"><span class="comment"> * 3.stamp如果表示持有读锁 ，返回该读锁</span></span><br><span class="line"><span class="comment"> * 4.有一个乐观读锁，只在即时可用的前提下返回一个读锁stamp</span></span><br><span class="line"><span class="comment"> * 5.其他情况都返回0，表示失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.tryConvertToReadLock(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="tryConvertToOptimisticRead"><a href="#tryConvertToOptimisticRead" class="headerlink" title="tryConvertToOptimisticRead"></a>tryConvertToOptimisticRead</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tryConvertToOptimisticRead</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.将其他锁转换为乐观锁</span></span><br><span class="line"><span class="comment"> * 2.stamp如果持有读或写锁，则直接释放读写锁</span></span><br><span class="line"><span class="comment"> * 3.stamp如果持有乐观锁，若乐观锁stamp有效，则返回观察者stamp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.tryConvertToOptimisticRead(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="tryUnlockWrite"><a href="#tryUnlockWrite" class="headerlink" title="tryUnlockWrite"></a>tryUnlockWrite</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tryUnlockWrite</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.如果持有写锁，释放写锁</span></span><br><span class="line"><span class="comment"> * 2.可以用于发生错误后的恢复</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.tryUnlockWrite();</span><br></pre></td></tr></table></figure><h4 id="tryUnlockRead"><a href="#tryUnlockRead" class="headerlink" title="tryUnlockRead"></a>tryUnlockRead</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tryUnlockRead</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.如果持有读锁，释放读锁</span></span><br><span class="line"><span class="comment"> * 2.可以用于发生错误后的恢复</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.tryUnlockRead();</span><br></pre></td></tr></table></figure><h4 id="isWriteLocked"><a href="#isWriteLocked" class="headerlink" title="isWriteLocked"></a>isWriteLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isWriteLocked</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.持有写锁返回true</span></span><br><span class="line"><span class="comment"> * 2.不持有返回false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(stampedLock.isWriteLocked());</span><br></pre></td></tr></table></figure><h4 id="isReadLocked"><a href="#isReadLocked" class="headerlink" title="isReadLocked"></a>isReadLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isReadLocked</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.持有读锁返回true</span></span><br><span class="line"><span class="comment"> * 2.不持有返回false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(stampedLock.isReadLocked());</span><br></pre></td></tr></table></figure><h4 id="getReadLockCount"><a href="#getReadLockCount" class="headerlink" title="getReadLockCount"></a>getReadLockCount</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getReadLockCount</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回持有读锁的线程数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(stampedLock.getReadLockCount());</span><br></pre></td></tr></table></figure><h4 id="asWriteLock"><a href="#asWriteLock" class="headerlink" title="asWriteLock"></a>asWriteLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//asWriteLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回一个WriteLock视图</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.asWriteLock();</span><br></pre></td></tr></table></figure><h4 id="asReadLock"><a href="#asReadLock" class="headerlink" title="asReadLock"></a>asReadLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//asReadLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回一个ReadLock视图</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.asReadLock();</span><br></pre></td></tr></table></figure><h4 id="asReadWriteLock"><a href="#asReadWriteLock" class="headerlink" title="asReadWriteLock"></a>asReadWriteLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//asReadWriteLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回一个ReadWriteLock视图</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stampedLock.asReadWriteLock();</span><br></pre></td></tr></table></figure><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="悲观读取"><a href="#悲观读取" class="headerlink" title="悲观读取"></a>悲观读取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StampedLockTest1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> StampedLock stampedLock = <span class="keyword">new</span> StampedLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;Long&gt; DATA = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ExecutorService executor = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        Runnable read = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;read();&#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Runnable write = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;write();&#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        executor.submit(read);</span><br><span class="line">        executor.submit(read);</span><br><span class="line">        executor.submit(read);</span><br><span class="line">        executor.submit(read);</span><br><span class="line">        executor.submit(read);</span><br><span class="line">        executor.submit(read);</span><br><span class="line">        executor.submit(read);</span><br><span class="line">        executor.submit(read);</span><br><span class="line">        executor.submit(read);</span><br><span class="line"></span><br><span class="line">        executor.submit(write);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamped = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamped = stampedLock.writeLock();</span><br><span class="line">            <span class="keyword">long</span> value = System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">"The Thread:"</span> + Thread.currentThread().getName() + <span class="string">" write value:"</span> + value);</span><br><span class="line">            DATA.add(value);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlockWrite(stamped);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamped = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            stamped = stampedLock.readLock();</span><br><span class="line">            Optional.of(DATA.stream()</span><br><span class="line">                    .map(String::valueOf)</span><br><span class="line">                    .collect(Collectors.joining(<span class="string">"#"</span>, <span class="string">"R-"</span>, <span class="string">""</span>)))</span><br><span class="line">                    .ifPresent(System.out::println);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlockRead(stamped);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="乐观读取"><a href="#乐观读取" class="headerlink" title="乐观读取"></a>乐观读取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StampedLockTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> StampedLock stampedLock = <span class="keyword">new</span> StampedLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;Long&gt; DATA = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Runnable read = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                read();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Runnable write = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                write();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">1</span>).boxed().forEach(i -&gt; <span class="keyword">new</span> Thread(write).start());</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">200</span>).boxed().forEach(i -&gt; <span class="keyword">new</span> Thread(read).start());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamped = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamped = stampedLock.writeLock();</span><br><span class="line">            <span class="keyword">long</span> value = System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">"The Thread:"</span> + Thread.currentThread().getName() + <span class="string">" write value:"</span> + value);</span><br><span class="line">            DATA.add(value);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlockWrite(stamped);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamp = stampedLock.tryOptimisticRead();</span><br><span class="line">        <span class="keyword">if</span> (stampedLock.validate(stamp)) &#123;</span><br><span class="line">            <span class="keyword">long</span> stamped = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                stamped = stampedLock.readLock();</span><br><span class="line">                System.out.println(<span class="string">"stamped："</span> + stamped);</span><br><span class="line">                Optional.of(DATA.stream()</span><br><span class="line">                        .map(String::valueOf)</span><br><span class="line">                        .collect(Collectors.joining(<span class="string">"#"</span>, <span class="string">"R-"</span>, <span class="string">""</span>)))</span><br><span class="line">                        .ifPresent(System.out::println);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                stampedLock.unlock(stamped);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取服务器CPU核数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NCPU = Runtime.getRuntime().availableProcessors();</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程入队列前自旋次数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SPINS = (NCPU &gt; <span class="number">1</span>) ? <span class="number">1</span> &lt;&lt; <span class="number">6</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//队列头结点自旋获取锁最大失败次数后再次进入队列</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HEAD_SPINS = (NCPU &gt; <span class="number">1</span>) ? <span class="number">1</span> &lt;&lt; <span class="number">10</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Maximum number of retries before re-blocking */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_HEAD_SPINS = (NCPU &gt; <span class="number">1</span>) ? <span class="number">1</span> &lt;&lt; <span class="number">16</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The period for yielding when waiting for overflow spinlock */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OVERFLOW_YIELD_RATE = <span class="number">7</span>; <span class="comment">// must be power 2 - 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** The number of bits to use for reader count before overflowing */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LG_READERS = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Values for lock state and stamp operations</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> RUNIT = <span class="number">1L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WBIT  = <span class="number">1L</span> &lt;&lt; LG_READERS;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> RBITS = WBIT - <span class="number">1L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> RFULL = RBITS - <span class="number">1L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> ABITS = RBITS | WBIT;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SBITS = ~RBITS; <span class="comment">// note overlap with ABITS</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//锁state初始值，第9位为1，避免算术时和0冲突</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> ORIGIN = WBIT &lt;&lt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Special value from cancelled acquire methods so caller can throw IE</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> INTERRUPTED = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Values for node status; order matters</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WAITING   = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Modes for nodes (int not boolean to allow arithmetic)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RMODE = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WMODE = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//标识状态的含义</span></span><br><span class="line">RUNIT: == <span class="number">1</span>，更新读锁状态会用到的常量，<span class="string">"next = s + RUNIT"</span>一个新线程获取获取到了读锁那么state将增加<span class="number">1</span>.</span><br><span class="line"></span><br><span class="line">ABITS:== <span class="number">255</span>，计算写锁状态时会用到的常量，位运算<span class="string">"((s = state) &amp; ABITS)"</span>来取state的低<span class="number">8</span>位。</span><br><span class="line"></span><br><span class="line">WBIT:== <span class="number">123</span>，更新写锁状态会用到的常量，<span class="string">"next = s + WBIT"</span>一个线程获取到写锁就将state属性加<span class="number">128</span>。</span><br><span class="line"></span><br><span class="line">RBITS:== <span class="number">127</span>，计算读锁状态会到的常量，<span class="string">"s &amp; RBITS"</span>用来取state的低<span class="number">7</span>位。</span><br><span class="line"></span><br><span class="line">RFULL:== <span class="number">126</span>，获取到读锁的最大线程数，<span class="string">"(readers = s &amp; RBITS) &gt;= RFULL"</span>。</span><br><span class="line"></span><br><span class="line">SBITS:计算写锁变化量会用到的常量，<span class="string">"(s &amp; SBITS)"</span>将s的低<span class="number">7</span>位全部置<span class="number">0</span>，只关注s的高<span class="number">25</span>位。</span><br><span class="line"></span><br><span class="line">ORIGIN:state的初始值，二进制形式只有第<span class="number">9</span>位为<span class="number">1</span>，其他位全为<span class="number">0</span>。主要是不让statet等于<span class="number">0</span>，只有尝试获取锁失败时，state才能为<span class="number">0</span>.</span><br><span class="line">state:<span class="number">1</span>表示持有写锁，<span class="number">0</span>表示没持有写锁</span><br></pre></td></tr></table></figure><h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//等待队列头节点</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> WNode whead; </span><br><span class="line"><span class="comment">//等待队列尾节点</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> WNode wtail; </span><br><span class="line"></span><br><span class="line"><span class="comment">//读锁视图</span></span><br><span class="line"><span class="keyword">transient</span> ReadLockView readLockView; </span><br><span class="line"><span class="comment">//写锁视图</span></span><br><span class="line"><span class="keyword">transient</span> WriteLockView writeLockView;</span><br><span class="line"><span class="comment">//读写锁视图</span></span><br><span class="line"><span class="keyword">transient</span> ReadWriteLockView readWriteLockView;</span><br><span class="line"></span><br><span class="line"><span class="comment">//锁状态</span></span><br><span class="line"><span class="comment">//高24位存储版本号、低7位存储读锁被获取的次数、第8位存储写锁被获取的次数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> state; </span><br><span class="line"><span class="comment">//读锁线程数超过RFULL时，额外记录超出的的线程数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> readerOverflow;</span><br></pre></td></tr></table></figure><h3 id="writeLock-1"><a href="#writeLock-1" class="headerlink" title="writeLock"></a>writeLock</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取写入锁、失败会陷入阻塞、直到获取锁成功</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">writeLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> s, next;</span><br><span class="line">    <span class="comment">// ABITS = 255 = 1111 1111</span></span><br><span class="line">    <span class="comment">// WBITS = 128 = 1000 0000</span></span><br><span class="line">    <span class="comment">//如果stat和ABITS==0，进行cas更新state=state+WBIT</span></span><br><span class="line">    <span class="comment">//更新成功则返回更新后的值</span></span><br><span class="line">    <span class="comment">//更新失败进入acquireWrite</span></span><br><span class="line">    <span class="keyword">return</span> ((((s = state) &amp; ABITS) == <span class="number">0L</span> &amp;&amp;</span><br><span class="line">             U.compareAndSwapLong(<span class="keyword">this</span>, STATE, s, next = s + WBIT)) ?</span><br><span class="line">            next : acquireWrite(<span class="keyword">false</span>, <span class="number">0L</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">acquireWrite</span><span class="params">(<span class="keyword">boolean</span> interruptible, <span class="keyword">long</span> deadline)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//node新增节点、p尾节点</span></span><br><span class="line">    WNode node = <span class="keyword">null</span>, p;</span><br><span class="line">    <span class="comment">//开始进行第一次自旋</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> spins = -<span class="number">1</span>;;) </span><br><span class="line">        <span class="keyword">long</span> m, s, ns;</span><br><span class="line">    <span class="comment">//尝试获取锁</span></span><br><span class="line">        <span class="keyword">if</span> ((m = (s = state) &amp; ABITS) == <span class="number">0L</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, STATE, s, ns = s + WBIT))</span><br><span class="line">                <span class="keyword">return</span> ns;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (spins &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//1.自旋次数&lt;0 计算自旋次数</span></span><br><span class="line">            <span class="comment">//2.有写锁并且队列中没有元素，那么代表快轮到自己了，接着自旋</span></span><br><span class="line">            <span class="comment">//3.自旋完了还没轮到则入队操作</span></span><br><span class="line">            <span class="comment">//4.自旋次数尾SPINS常量、否则为0</span></span><br><span class="line">            spins = (m == WBIT &amp;&amp; wtail == whead) ? SPINS : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (spins &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//若是自旋次数&gt;0，当前自旋次数-1</span></span><br><span class="line">            <span class="keyword">if</span> (LockSupport.nextSecondarySeed() &gt;= <span class="number">0</span>)</span><br><span class="line">                --spins;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((p = wtail) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//如果队列未进行初始化操作</span></span><br><span class="line">            <span class="comment">//新建一个Node节点</span></span><br><span class="line">            WNode hd = <span class="keyword">new</span> WNode(WMODE, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//初始化头部和尾部节点</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, WHEAD, <span class="keyword">null</span>, hd))</span><br><span class="line">                wtail = hd;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//如果新增节点没有初始化、构建一个新增节点并且它的前置节点是尾节点</span></span><br><span class="line">            node = <span class="keyword">new</span> WNode(WMODE, p);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node.prev != p)</span><br><span class="line">            <span class="comment">//如果尾节点发生变化、则需要更新新增节点的前置节点尾新的尾节点</span></span><br><span class="line">            node.prev = p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, WTAIL, p, node)) &#123;</span><br><span class="line">            <span class="comment">//CAS尝试更新新的尾节点、并且退出循环</span></span><br><span class="line">            p.next = node;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进入第二次自旋操作</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> spins = -<span class="number">1</span>;;) &#123;</span><br><span class="line">        <span class="comment">//h:头部节点</span></span><br><span class="line">        <span class="comment">//np:新增节点的前置节点</span></span><br><span class="line">        <span class="comment">//pp:前前置节点</span></span><br><span class="line">        <span class="comment">//ps:前置节点的状态</span></span><br><span class="line">        WNode h, np, pp; <span class="keyword">int</span> ps;</span><br><span class="line">        <span class="comment">//如果头部节点 == 前置节点（快轮到自己了）</span></span><br><span class="line">        <span class="keyword">if</span> ((h = whead) == p) &#123;</span><br><span class="line">            <span class="keyword">if</span> (spins &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//自旋次数&lt;0，初始化自旋次数</span></span><br><span class="line">                spins = HEAD_SPINS;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (spins &lt; MAX_HEAD_SPINS)</span><br><span class="line">                <span class="comment">//增加自旋次数（自旋次数&lt;最大自旋次数）</span></span><br><span class="line">                spins &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//开始第三次自旋、不断尝试获取锁</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = spins;;) &#123;</span><br><span class="line">                <span class="keyword">long</span> s, ns;</span><br><span class="line">                <span class="keyword">if</span> (((s = state) &amp; ABITS) == <span class="number">0L</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, STATE, s,</span><br><span class="line">                                             ns = s + WBIT)) &#123;</span><br><span class="line">                        <span class="comment">//获取锁成功，设置node为新头部节点</span></span><br><span class="line">                        whead = node;</span><br><span class="line">                        <span class="comment">//清除前置节点gc</span></span><br><span class="line">                        node.prev = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">return</span> ns;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//随机立减自旋次数、如果自旋次数减为0跳出循环再次重试</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (LockSupport.nextSecondarySeed() &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         --k &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (h != <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="comment">//一般情况很少会触发该逻辑</span></span><br><span class="line">            <span class="comment">//主要用于协助唤醒读节点</span></span><br><span class="line">            WNode c; Thread w;</span><br><span class="line">            <span class="comment">//如果头节点的cowait不为空、则唤醒里面的所有节点</span></span><br><span class="line">            <span class="keyword">while</span> ((c = h.cowait) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapObject(h, WCOWAIT, c, c.cowait) &amp;&amp;</span><br><span class="line">                    (w = c.thread) != <span class="keyword">null</span>)</span><br><span class="line">                    U.unpark(w);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果头部节点没有发生变化</span></span><br><span class="line">        <span class="keyword">if</span> (whead == h) &#123;</span><br><span class="line">            <span class="comment">//尾部节点发生变化、进行更新操作</span></span><br><span class="line">            <span class="keyword">if</span> ((np = node.prev) != p) &#123;</span><br><span class="line">                <span class="keyword">if</span> (np != <span class="keyword">null</span>)</span><br><span class="line">                    (p = np).next = node;   <span class="comment">// stale</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((ps = p.status) == <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//如果尾部节点的状态为0，更新为WAITING</span></span><br><span class="line">                U.compareAndSwapInt(p, WSTATUS, <span class="number">0</span>, WAITING);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ps == CANCELLED) &#123;</span><br><span class="line">                <span class="comment">//如果尾部节点的状态为CANCELLED，则从链表中删除</span></span><br><span class="line">                <span class="keyword">if</span> ((pp = p.prev) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    node.prev = pp;</span><br><span class="line">                    pp.next = node;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//超时时间处理</span></span><br><span class="line">                <span class="keyword">long</span> time; </span><br><span class="line">                <span class="keyword">if</span> (deadline == <span class="number">0L</span>)</span><br><span class="line">                    time = <span class="number">0L</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((time = deadline - System.nanoTime()) &lt;= <span class="number">0L</span>)</span><br><span class="line">                    <span class="comment">//超时、剔除当前节点</span></span><br><span class="line">                    <span class="keyword">return</span> cancelWaiter(node, node, <span class="keyword">false</span>);</span><br><span class="line">                <span class="comment">//获取当前线程</span></span><br><span class="line">                Thread wt = Thread.currentThread();</span><br><span class="line">                U.putObject(wt, PARKBLOCKER, <span class="keyword">this</span>);</span><br><span class="line">                <span class="comment">//将node的线程指向了当前的线程</span></span><br><span class="line">                node.thread = wt;</span><br><span class="line">                <span class="keyword">if</span> (p.status &lt; <span class="number">0</span> &amp;&amp; (p != h || (state &amp; ABITS) != <span class="number">0L</span>) &amp;&amp;</span><br><span class="line">                    whead == h &amp;&amp; node.prev == p)</span><br><span class="line">                    <span class="comment">//阻塞当前线程</span></span><br><span class="line">                    U.park(<span class="keyword">false</span>, time);  <span class="comment">// emulate LockSupport.park</span></span><br><span class="line">                <span class="comment">//节点唤醒后、清除线程</span></span><br><span class="line">                node.thread = <span class="keyword">null</span>;</span><br><span class="line">                U.putObject(wt, PARKBLOCKER, <span class="keyword">null</span>);</span><br><span class="line">                <span class="comment">//如果线程被中断、则取消当前节点</span></span><br><span class="line">                <span class="keyword">if</span> (interruptible &amp;&amp; Thread.interrupted())</span><br><span class="line">                    <span class="keyword">return</span> cancelWaiter(node, node, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.第一次自旋操作：(入队操作)</p><p>&emsp;&emsp;&emsp;&emsp;(1)头节点 == 尾节点，说明此时没有其他的线程进行排队，那么进行自旋、尝试性的获取锁。</p><p>&emsp;&emsp;&emsp;&emsp;(2)否则：自旋次数 == 0，直接进行入队操作。</p><p>&emsp;&emsp;2.第二、三次自旋操作：（阻塞并且等待被唤醒、第三次自旋目的在于不断尝试获取锁）</p><p>&emsp;&emsp;&emsp;&emsp;(1)头节点 == 前置节点，进入第三次自旋（处于第二次自旋的内部），尝试获取锁。</p><p>&emsp;&emsp;&emsp;&emsp;(2)否则：尝试唤醒头节点中等待的读线程</p><p>&emsp;&emsp;&emsp;&emsp;(3)如果线程一直不能获取到锁、则阻塞当前线程。</p><h3 id="unlockWrite-1"><a href="#unlockWrite-1" class="headerlink" title="unlockWrite"></a>unlockWrite</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlockWrite</span><span class="params">(<span class="keyword">long</span> stamp)</span> </span>&#123;</span><br><span class="line">    WNode h;</span><br><span class="line">    <span class="comment">//检测版本号</span></span><br><span class="line">    <span class="keyword">if</span> (state != stamp || (stamp &amp; WBIT) == <span class="number">0L</span>)</span><br><span class="line">        <span class="comment">//抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="comment">//1.更新版本号</span></span><br><span class="line">    <span class="comment">//2.释放写入锁</span></span><br><span class="line">    state = (stamp += WBIT) == <span class="number">0L</span> ? ORIGIN : stamp;</span><br><span class="line">    <span class="comment">//如果头节点不为空并且状态不为0、release唤醒下一个节点</span></span><br><span class="line">    <span class="keyword">if</span> ((h = whead) != <span class="keyword">null</span> &amp;&amp; h.status != <span class="number">0</span>)</span><br><span class="line">        release(h);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(WNode h)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (h != <span class="keyword">null</span>) &#123;</span><br><span class="line">        WNode q; Thread w;</span><br><span class="line">        <span class="comment">//设置状态为0</span></span><br><span class="line">        U.compareAndSwapInt(h, WSTATUS, WAITING, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//如果头节点的下一个节点为空或其状态为CANCELLED</span></span><br><span class="line">        <span class="keyword">if</span> ((q = h.next) == <span class="keyword">null</span> || q.status == CANCELLED) &#123;</span><br><span class="line">            <span class="comment">//从尾部往前进行遍历寻找一个可用的节点</span></span><br><span class="line">            <span class="keyword">for</span> (WNode t = wtail; t != <span class="keyword">null</span> &amp;&amp; t != h; t = t.prev)</span><br><span class="line">                <span class="keyword">if</span> (t.status &lt;= <span class="number">0</span>)</span><br><span class="line">                    q = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//唤醒q处节点的线程</span></span><br><span class="line">        <span class="keyword">if</span> (q != <span class="keyword">null</span> &amp;&amp; (w = q.thread) != <span class="keyword">null</span>)</span><br><span class="line">            U.unpark(w);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.更新<code>state</code>的值、释放写入锁</p><p>&emsp;&emsp;2.版本号+1</p><p>&emsp;&emsp;3.唤醒下一个等待的节点</p><h3 id="readLock-1"><a href="#readLock-1" class="headerlink" title="readLock"></a>readLock</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">readLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> s = state, next;</span><br><span class="line">    <span class="comment">//1.如果写入锁被占用、并且读取所得获取次数并没有达到最大值</span></span><br><span class="line">    <span class="comment">//2.cas尝试更新读取锁被获取的次数+1</span></span><br><span class="line">    <span class="comment">//3.如果更新成功则返回、否则进入acquireRead方法</span></span><br><span class="line">    <span class="keyword">return</span> ((whead == wtail &amp;&amp; (s &amp; ABITS) &lt; RFULL &amp;&amp;</span><br><span class="line">             U.compareAndSwapLong(<span class="keyword">this</span>, STATE, s, next = s + RUNIT)) ?</span><br><span class="line">            next : acquireRead(<span class="keyword">false</span>, <span class="number">0L</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">acquireRead</span><span class="params">(<span class="keyword">boolean</span> interruptible, <span class="keyword">long</span> deadline)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//node:为新增节点</span></span><br><span class="line">    <span class="comment">//p:尾节点</span></span><br><span class="line">    WNode node = <span class="keyword">null</span>, p;</span><br><span class="line">    <span class="comment">//第一次自旋</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> spins = -<span class="number">1</span>;;) &#123;</span><br><span class="line">        <span class="comment">//头节点</span></span><br><span class="line">        WNode h;</span><br><span class="line">        <span class="comment">//如果头节点 == 尾节点、没有排队的线程、尝试自旋获取锁</span></span><br><span class="line">        <span class="keyword">if</span> ((h = whead) == (p = wtail)) &#123;</span><br><span class="line">            <span class="comment">//第二次自旋操作</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">long</span> m, s, ns;;) &#123;</span><br><span class="line">                <span class="comment">//尝试获取锁、成功则返回版本号ns</span></span><br><span class="line">                <span class="keyword">if</span> ((m = (s = state) &amp; ABITS) &lt; RFULL ?</span><br><span class="line">                    U.compareAndSwapLong(<span class="keyword">this</span>, STATE, s, ns = s + RUNIT) :</span><br><span class="line">                    (m &lt; WBIT &amp;&amp; (ns = tryIncReaderOverflow(s)) != <span class="number">0L</span>))</span><br><span class="line">                    <span class="comment">//如果读线程个数达到了最大值、会造成溢出返回0</span></span><br><span class="line">                    <span class="keyword">return</span> ns;</span><br><span class="line">                <span class="comment">//表示有其他的线程先行一步获取到了写入锁</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m &gt;= WBIT) &#123;</span><br><span class="line">                    <span class="comment">//自旋数&gt;0则进行自旋数-1</span></span><br><span class="line">                    <span class="keyword">if</span> (spins &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (LockSupport.nextSecondarySeed() &gt;= <span class="number">0</span>)</span><br><span class="line">                            --spins;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//如果自旋数 == 0 、检验是否退出循环</span></span><br><span class="line">                        <span class="keyword">if</span> (spins == <span class="number">0</span>) &#123;</span><br><span class="line">                            WNode nh = whead, np = wtail;</span><br><span class="line">                            <span class="keyword">if</span> ((nh == h &amp;&amp; np == p) || (h = nh) != (p = np))</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//更新自旋数</span></span><br><span class="line">                        spins = SPINS;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果尾节点为空、进行初始化头部和尾部节点操作</span></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123; <span class="comment">// initialize queue</span></span><br><span class="line">            WNode hd = <span class="keyword">new</span> WNode(WMODE, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, WHEAD, <span class="keyword">null</span>, hd))</span><br><span class="line">                wtail = hd;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//如果新增新增节点为空、进行初始化操作</span></span><br><span class="line">            node = <span class="keyword">new</span> WNode(RMODE, p);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (h == p || p.mode != RMODE) &#123;</span><br><span class="line">            <span class="comment">//如果头节点 == 尾节点 或者 尾节点不是读取模式</span></span><br><span class="line">            <span class="comment">//当前节点入队</span></span><br><span class="line">            <span class="keyword">if</span> (node.prev != p)</span><br><span class="line">                node.prev = p;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, WTAIL, p, node)) &#123;</span><br><span class="line">                p.next = node;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!U.compareAndSwapObject(p, WCOWAIT,</span><br><span class="line">                                         node.cowait = p.cowait, node))</span><br><span class="line">            <span class="comment">//尾节点尾读模式当前节点加入尾节点的cowait</span></span><br><span class="line">            node.cowait = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//开始第三段自旋</span></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                WNode pp, c; Thread w;</span><br><span class="line">                <span class="comment">//头节点不为空并且cowait不为空、唤醒其中等待的读线程</span></span><br><span class="line">                <span class="keyword">if</span> ((h = whead) != <span class="keyword">null</span> &amp;&amp; (c = h.cowait) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    U.compareAndSwapObject(h, WCOWAIT, c, c.cowait) &amp;&amp;</span><br><span class="line">                    (w = c.thread) != <span class="keyword">null</span>) <span class="comment">// help release</span></span><br><span class="line">                    U.unpark(w);</span><br><span class="line">                <span class="comment">//头部节点的前置节点或者前置节点或者前置节点为空</span></span><br><span class="line">                <span class="keyword">if</span> (h == (pp = p.prev) || h == p || pp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">long</span> m, s, ns;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="comment">//开启第四段自旋</span></span><br><span class="line">                        <span class="keyword">if</span> ((m = (s = state) &amp; ABITS) &lt; RFULL ?</span><br><span class="line">                            U.compareAndSwapLong(<span class="keyword">this</span>, STATE, s,</span><br><span class="line">                                                 ns = s + RUNIT) :</span><br><span class="line">                            (m &lt; WBIT &amp;&amp;</span><br><span class="line">                             (ns = tryIncReaderOverflow(s)) != <span class="number">0L</span>))</span><br><span class="line">                            <span class="keyword">return</span> ns;</span><br><span class="line">                        <span class="comment">//只有当前时刻没有其他线程占有写入锁就不断尝试</span></span><br><span class="line">                    &#125; <span class="keyword">while</span> (m &lt; WBIT);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//如果头部节点未曾改变且前前置节点为没发生改变、阻塞当前线程</span></span><br><span class="line">                <span class="keyword">if</span> (whead == h &amp;&amp; p.prev == pp) &#123;</span><br><span class="line">                    <span class="keyword">long</span> time;</span><br><span class="line">                    <span class="comment">//如果前前置节点为空、或者头节点 == 前置节点、或者前置节点已经取消</span></span><br><span class="line">                    <span class="comment">//进入第一个for开始重试</span></span><br><span class="line">                    <span class="keyword">if</span> (pp == <span class="keyword">null</span> || h == p || p.status &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        node = <span class="keyword">null</span>; <span class="comment">// throw away</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//超时检测机制</span></span><br><span class="line">                    <span class="keyword">if</span> (deadline == <span class="number">0L</span>)</span><br><span class="line">                        time = <span class="number">0L</span>;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ((time = deadline - System.nanoTime()) &lt;= <span class="number">0L</span>)</span><br><span class="line">                        <span class="comment">//超时：取消当前节点</span></span><br><span class="line">                        <span class="keyword">return</span> cancelWaiter(node, p, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="comment">//获取当前节点</span></span><br><span class="line">                    Thread wt = Thread.currentThread();</span><br><span class="line">                    U.putObject(wt, PARKBLOCKER, <span class="keyword">this</span>);</span><br><span class="line">                    <span class="comment">//将nede的线程指向当前线程</span></span><br><span class="line">                    node.thread = wt;</span><br><span class="line">                    <span class="comment">//检测之前的条件没有发生改变</span></span><br><span class="line">                    <span class="keyword">if</span> ((h != pp || (state &amp; ABITS) == WBIT) &amp;&amp;</span><br><span class="line">                        whead == h &amp;&amp; p.prev == pp)</span><br><span class="line">                        <span class="comment">//阻塞当前线程</span></span><br><span class="line">                        U.park(<span class="keyword">false</span>, time);</span><br><span class="line">                    <span class="comment">//唤醒线程并清除线程</span></span><br><span class="line">                    node.thread = <span class="keyword">null</span>;</span><br><span class="line">        U.putObject(wt, PARKBLOCKER, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">//线程中断取消当前节点</span></span><br><span class="line">                    <span class="keyword">if</span> (interruptible &amp;&amp; Thread.interrupted())</span><br><span class="line">                        <span class="keyword">return</span> cancelWaiter(node, p, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启第五次自旋（只有第一个读线程才会走到这里）单独有一个自旋针对第一个读的线程</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> spins = -<span class="number">1</span>;;) &#123;</span><br><span class="line">        WNode h, np, pp; <span class="keyword">int</span> ps;</span><br><span class="line">        <span class="comment">//如果头节点 == 尾节点（快轮到自己了）</span></span><br><span class="line">        <span class="keyword">if</span> ((h = whead) == p) &#123;</span><br><span class="line">            <span class="keyword">if</span> (spins &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//自旋次数&lt;0,设置自旋次数</span></span><br><span class="line">                spins = HEAD_SPINS;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (spins &lt; MAX_HEAD_SPINS)</span><br><span class="line">                <span class="comment">//自旋次数初始化完成后-1</span></span><br><span class="line">                spins &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//开始第六次自旋</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> k = spins;;) &#123; <span class="comment">// spin at head</span></span><br><span class="line">                <span class="keyword">long</span> m, s, ns;</span><br><span class="line">                <span class="comment">//不断的尝试获取锁</span></span><br><span class="line">                <span class="keyword">if</span> ((m = (s = state) &amp; ABITS) &lt; RFULL ?</span><br><span class="line">                    U.compareAndSwapLong(<span class="keyword">this</span>, STATE, s, ns = s + RUNIT) :</span><br><span class="line">                    (m &lt; WBIT &amp;&amp; (ns = tryIncReaderOverflow(s)) != <span class="number">0L</span>)) &#123;</span><br><span class="line">                    <span class="comment">//获取到了读取锁</span></span><br><span class="line">                    WNode c; Thread w;</span><br><span class="line">                    whead = node;</span><br><span class="line">                    node.prev = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">//唤醒当前节点中所有的等待的读线程</span></span><br><span class="line">                    <span class="comment">//当前节点是第一个读的节点、其他的读节点都是挂在当前节点的cowait中</span></span><br><span class="line">                    <span class="keyword">while</span> ((c = node.cowait) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (U.compareAndSwapObject(node, WCOWAIT,</span><br><span class="line">                                                   c, c.cowait) &amp;&amp;</span><br><span class="line">                            (w = c.thread) != <span class="keyword">null</span>)</span><br><span class="line">                            U.unpark(w);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//返回版本号</span></span><br><span class="line">                    <span class="keyword">return</span> ns;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//如果当前有其他线程占有了写入锁、并且没有自旋次数、跳出循环</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m &gt;= WBIT &amp;&amp;</span><br><span class="line">                         LockSupport.nextSecondarySeed() &gt;= <span class="number">0</span> &amp;&amp; --k &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (h != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">//如果头节点不等于尾部节点不为空并且其为读取模式、唤醒里面的读线程</span></span><br><span class="line">            WNode c; Thread w;</span><br><span class="line">            <span class="keyword">while</span> ((c = h.cowait) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapObject(h, WCOWAIT, c, c.cowait) &amp;&amp;</span><br><span class="line">                    (w = c.thread) != <span class="keyword">null</span>)</span><br><span class="line">                    U.unpark(w);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//头节点没有发生变化</span></span><br><span class="line">        <span class="keyword">if</span> (whead == h) &#123;</span><br><span class="line">            <span class="comment">//更新前置节点以及状态</span></span><br><span class="line">            <span class="keyword">if</span> ((np = node.prev) != p) &#123;</span><br><span class="line">                <span class="keyword">if</span> (np != <span class="keyword">null</span>)</span><br><span class="line">                    (p = np).next = node;   <span class="comment">// stale</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((ps = p.status) == <span class="number">0</span>)</span><br><span class="line">                U.compareAndSwapInt(p, WSTATUS, <span class="number">0</span>, WAITING);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ps == CANCELLED) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((pp = p.prev) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    node.prev = pp;</span><br><span class="line">                    pp.next = node;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//第一个节点即将开始进入阻塞</span></span><br><span class="line">                <span class="keyword">long</span> time;</span><br><span class="line">                <span class="comment">//设置超时</span></span><br><span class="line">                <span class="keyword">if</span> (deadline == <span class="number">0L</span>)</span><br><span class="line">                    time = <span class="number">0L</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((time = deadline - System.nanoTime()) &lt;= <span class="number">0L</span>)</span><br><span class="line">                    <span class="comment">//超时则取消当前节点</span></span><br><span class="line">                    <span class="keyword">return</span> cancelWaiter(node, node, <span class="keyword">false</span>);</span><br><span class="line">                Thread wt = Thread.currentThread();</span><br><span class="line">                U.putObject(wt, PARKBLOCKER, <span class="keyword">this</span>);</span><br><span class="line">                node.thread = wt;</span><br><span class="line">                <span class="keyword">if</span> (p.status &lt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    (p != h || (state &amp; ABITS) == WBIT) &amp;&amp;</span><br><span class="line">                    whead == h &amp;&amp; node.prev == p)</span><br><span class="line">                    <span class="comment">//阻塞第一个线程并等待被唤醒</span></span><br><span class="line">                    U.park(<span class="keyword">false</span>, time);</span><br><span class="line">                node.thread = <span class="keyword">null</span>;</span><br><span class="line">                U.putObject(wt, PARKBLOCKER, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (interruptible &amp;&amp; Thread.interrupted())</span><br><span class="line">                    <span class="keyword">return</span> cancelWaiter(node, node, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.头节点 == 尾节点，表示已经快轮到自己了、尝试获取锁、成功则返回</p><p>&emsp;&emsp;2.头节点 != 尾节点，当前节点入队</p><p>&emsp;&emsp;3.首个读节点入队：排队到整个队尾的尾部、跳出第一次自旋、进入第五次自旋</p><p>&emsp;&emsp;4.非首个读节点入队：进入首个读节点的cowait栈中</p><p>&emsp;&emsp;5.检测头节点是否等于尾节点：相等则会不断的尝试获取锁，不相等：当前线程进入阻塞等待被唤醒</p><p>&emsp;&emsp;6.首个读节点表示连续的读线程中的首个、若是两个读线程之间存在了一个写人线程，那么也会进行排队</p><h3 id="unlockRead-1"><a href="#unlockRead-1" class="headerlink" title="unlockRead"></a>unlockRead</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlockRead</span><span class="params">(<span class="keyword">long</span> stamp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> s, m; WNode h;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//检测版本号</span></span><br><span class="line">        <span class="keyword">if</span> (((s = state) &amp; SBITS) != (stamp &amp; SBITS) ||</span><br><span class="line">            (stamp &amp; ABITS) == <span class="number">0L</span> || (m = s &amp; ABITS) == <span class="number">0L</span> || m == WBIT)</span><br><span class="line">            <span class="comment">//抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        <span class="comment">//判断读线程的个数</span></span><br><span class="line">        <span class="keyword">if</span> (m &lt; RFULL) &#123;</span><br><span class="line">            <span class="comment">//释放一次读取锁</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapLong(<span class="keyword">this</span>, STATE, s, s - RUNIT)) &#123;</span><br><span class="line">                <span class="comment">//如果线程全部已经被释放了、头节点不为空并且状态不为0、release方法唤醒下一个节点</span></span><br><span class="line">                <span class="keyword">if</span> (m == RUNIT &amp;&amp; (h = whead) != <span class="keyword">null</span> &amp;&amp; h.status != <span class="number">0</span>)</span><br><span class="line">                    release(h);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tryDecReaderOverflow(s) != <span class="number">0L</span>)</span><br><span class="line">            <span class="comment">//读取线程个数溢出</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(WNode h)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (h != <span class="keyword">null</span>) &#123;</span><br><span class="line">        WNode q; Thread w;</span><br><span class="line">        <span class="comment">//设置状态为0</span></span><br><span class="line">        U.compareAndSwapInt(h, WSTATUS, WAITING, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//如果头节点的下一个节点为空或其状态为CANCELLED</span></span><br><span class="line">        <span class="keyword">if</span> ((q = h.next) == <span class="keyword">null</span> || q.status == CANCELLED) &#123;</span><br><span class="line">            <span class="comment">//从尾部往前进行遍历寻找一个可用的节点</span></span><br><span class="line">            <span class="keyword">for</span> (WNode t = wtail; t != <span class="keyword">null</span> &amp;&amp; t != h; t = t.prev)</span><br><span class="line">                <span class="keyword">if</span> (t.status &lt;= <span class="number">0</span>)</span><br><span class="line">                    q = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//唤醒q处节点的线程</span></span><br><span class="line">        <span class="keyword">if</span> (q != <span class="keyword">null</span> &amp;&amp; (w = q.thread) != <span class="keyword">null</span>)</span><br><span class="line">            U.unpark(w);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="tryOptimisticRead-1"><a href="#tryOptimisticRead-1" class="headerlink" title="tryOptimisticRead"></a>tryOptimisticRead</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果没有写锁，就返回state的高25位</span></span><br><span class="line"><span class="comment">//写所在位置一起返回,为了后面检测数据有没有被写过</span></span><br><span class="line"><span class="comment">//乐观读</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">tryOptimisticRead</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> s;</span><br><span class="line">    <span class="keyword">return</span> (((s = state) &amp; WBIT) == <span class="number">0L</span>) ? (s &amp; SBITS) : <span class="number">0L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="validate-1"><a href="#validate-1" class="headerlink" title="validate"></a>validate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//检测乐观读版本号是否变化</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validate</span><span class="params">(<span class="keyword">long</span> stamp)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 强制加入内存屏障，刷新数据</span></span><br><span class="line">    U.loadFence();</span><br><span class="line">    <span class="keyword">return</span> (stamp &amp; SBITS) == (state &amp; SBITS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="变异的CLH队列"><a href="#变异的CLH队列" class="headerlink" title="变异的CLH队列"></a>变异的CLH队列</h3><p><img src="/image/hexo/image-20200718204935119.png" alt="image-20200718204935119"></p><h2 id="运行示例分析"><a href="#运行示例分析" class="headerlink" title="运行示例分析"></a>运行示例分析</h2><p><a href="https://segmentfault.com/a/1190000015808032" target="_blank" rel="noopener">来源</a></p><blockquote><p><code>//Thread_A 获取写锁</code><br><code>//Thread_B 获取读锁</code><br><code>//Thread_C 获取读锁</code><br><code>//Thread_D 获取写锁</code><br><code>//Thread_E 获取读锁</code></p></blockquote><h3 id="Thread-A-writeLock"><a href="#Thread-A-writeLock" class="headerlink" title="Thread_A(writeLock)"></a>Thread_A(writeLock)</h3><p><img src="/image/hexo/image-20200718205455857.png" alt="image-20200718205455857"></p><p>StampedLock中大量运用了位运算，这里<code>(s = state) &amp; ABITS == 0L</code> 表示读锁和写锁都未被使用，这里写锁可以立即获取成功，然后CAS操作更新同步状态值State。</p><p>操作完成后，等待队列的结构如下：</p><p><img src="/image/hexo/image-20200718205419032.png" alt="image-20200718205419032"></p><blockquote><p>注意：StampedLock中，等待队列的结点要比AQS中简单些，仅仅三种状态。<br>0：初始状态<br>-1：等待中<br>1：取消</p></blockquote><p>另外，结点的定义中有个<code>cowait</code>字段，该字段指向一个栈，用于保存读线程。</p><h3 id="Thread-B-readLock"><a href="#Thread-B-readLock" class="headerlink" title="Thread_B(readLock)"></a>Thread_B(readLock)</h3><p><img src="/image/hexo/image-20200718205552104.png" alt="image-20200718205552104"></p><p>由于<code>Thread_A</code>线程持有了写锁、那么此时获取锁失败，进入<code>acquireRead</code>方法。</p><p><img src="/image/hexo/image-20200718205703751.png" alt="image-20200718205703751"></p><p><img src="/image/hexo/image-20200718205724877.png" alt="image-20200718205724877"></p><p><img src="/image/hexo/image-20200718205731522.png" alt="image-20200718205731522"></p><h3 id="Thread-C-readLock"><a href="#Thread-C-readLock" class="headerlink" title="Thread_C(readLock)"></a>Thread_C(readLock)</h3><p>这个过程和<code>Thread_B</code>获取读锁一样，区别在于<code>Thread_C</code>被包装成结点加入等待队列后，是链接到<code>Thread_B</code>结点的栈指针中的。调用完下面这段代码后，<code>Thread_C</code>会链接到以<code>Thread_B</code>为栈顶指针的栈中：</p><p><img src="/image/hexo/image-20200718205839240.png" alt="image-20200718205839240"></p><p><img src="/image/hexo/image-20200718205856220.png" alt="image-20200718205856220"></p><p>可以看到，此时<code>Thread_C</code>结点并没有把它的前驱的等待状态置为-1，因为<code>Thread_C</code>是链接到栈中的，当写锁释放的时候，会从栈底元素开始，唤醒栈中所有读结点。</p><h3 id="Thread-D-writeLock"><a href="#Thread-D-writeLock" class="headerlink" title="Thread_D(writeLock)"></a>Thread_D(writeLock)</h3><p><code>Thread_D</code>调用<strong>writeLock</strong>方法获取写锁失败后（<code>Thread_A</code>依然占用着写锁），会调用<strong>acquireWrite</strong>方法，该方法整体逻辑和<strong>acquireRead</strong>差不多，首先自旋的尝试获取写锁，获取成功后，就直接返回；否则，会将当前线程包装成一个写结点，插入到等待队列。</p><p><img src="/image/hexo/image-20200718205934160.png" alt="image-20200718205934160"></p><p><img src="/image/hexo/image-20200718210007566.png" alt="image-20200718210007566"></p><p><img src="/image/hexo/image-20200718210018123.png" alt="image-20200718210018123"></p><h3 id="Thead-E-readLock"><a href="#Thead-E-readLock" class="headerlink" title="Thead_E(readLock)"></a>Thead_E(readLock)</h3><p>同样，由于写锁被<code>Thread_A</code>占用着，所以最终会调用<strong>acquireRead</strong>方法，在该方法的第一个自旋中，会将<code>Thread_E</code>加入等待队列:</p><p><img src="/image/hexo/image-20200718210103657.png" alt="image-20200718210103657"></p><p><img src="/image/hexo/image-20200718210116706.png" alt="image-20200718210116706"></p><h3 id="Thread-A-unlockWrite"><a href="#Thread-A-unlockWrite" class="headerlink" title="Thread_A(unlockWrite)"></a>Thread_A(unlockWrite)</h3><p>通过CAS操作，修改State成功后，会调用<strong>release</strong>方法唤醒等待队列的队首结点：</p><p><img src="/image/hexo/image-20200718210206473.png" alt="image-20200718210206473"></p><p><strong>release</strong>方法非常简单，先将头结点的等待状态置为0，表示即将唤醒后继结点，然后立即唤醒队首结点：</p><p><img src="/image/hexo/image-20200718210221536.png" alt="image-20200718210221536"></p><p><img src="/image/hexo/image-20200718210229864.png" alt="image-20200718210229864"></p><h3 id="Thread-B-unlockRead-gt-next"><a href="#Thread-B-unlockRead-gt-next" class="headerlink" title="Thread_B(unlockRead-&gt;next)"></a>Thread_B(unlockRead-&gt;next)</h3><p><img src="/image/hexo/image-20200718210309090.png" alt="image-20200718210309090"></p><p>第二次自旋时，<code>Thread_B</code>发现写锁未被占用，则成功获取到读锁，然后从栈顶（<code>Thread_B</code>的cowait指针指向的结点）开始唤醒栈中所有线程，<br>最后返回：</p><p><img src="/image/hexo/image-20200718210321715.png" alt="image-20200718210321715"></p><p><img src="/image/hexo/image-20200718210328781.png" alt="image-20200718210328781"></p><h3 id="Thread-C-unlockRead-gt-next"><a href="#Thread-C-unlockRead-gt-next" class="headerlink" title="Thread_C(unlockRead-&gt;next)"></a>Thread_C(unlockRead-&gt;next)</h3><p><code>Thread_C</code>被唤醒后，继续执行，并进入下一次自旋，下一次自旋时，会成功获取到读锁。</p><p><img src="/image/hexo/69274006-5b5de694a90ad_articlex.png" alt="69274006-5b5de694a90ad_articlex"></p><p>注意，此时<code>Thread_B</code>和<code>Thread_C</code>已经拿到了读锁，<code>Thread_D</code>（写线程）和<code>Thread_E</code>（读线程）依然阻塞中，原来<code>Thread_C</code>对应的结点是个孤立结点，会被GC回收。</p><p><img src="/image/hexo/image-20200718210625568.png" alt="image-20200718210625568"></p><h3 id="Thread-B和Thread-C释放读锁"><a href="#Thread-B和Thread-C释放读锁" class="headerlink" title="Thread_B和Thread_C释放读锁"></a>Thread_B和Thread_C释放读锁</h3><p><code>Thread_B</code>和<code>Thread_C</code>调用<strong>unlockRead</strong>方法释放读锁，CAS操作State将读锁数量减1：</p><p><img src="/image/hexo/image-20200718210714617.png" alt="image-20200718210714617"></p><p>注意，当读锁的数量变为0时才会调用<strong>release</strong>方法，唤醒队首结点：</p><p><img src="/image/hexo/image-20200718210728941.png" alt="image-20200718210728941"></p><p><img src="/image/hexo/image-20200718210735960.png" alt="image-20200718210735960"></p><h3 id="Thread-D被唤醒后继续向下执行"><a href="#Thread-D被唤醒后继续向下执行" class="headerlink" title="Thread_D被唤醒后继续向下执行"></a>Thread_D被唤醒后继续向下执行</h3><p><code>Thread_D</code>会从原阻塞处继续向下执行，并在下一次自旋中获取到写锁，然后返回:</p><p><img src="/image/hexo/4207167806-5b5de717b34bc_articlex.png" alt="4207167806-5b5de717b34bc_articlex"></p><p><img src="/image/hexo/image-20200718210843887.png" alt="image-20200718210843887"></p><h3 id="Thread-D调用unlockWrite释放写锁"><a href="#Thread-D调用unlockWrite释放写锁" class="headerlink" title="Thread_D调用unlockWrite释放写锁"></a>Thread_D调用unlockWrite释放写锁</h3><p><code>Thread_D</code>释放写锁，会调用<strong>unlockWrite</strong>唤醒队首结点（<code>Thread_E</code>）。</p><p><img src="/image/hexo/image-20200718210935053.png" alt="image-20200718210935053"></p><p><code>Thread_E</code>被唤醒后会从原阻塞处继续向下执行，但由于<code>Thread_E</code>是个读结点，所以同时会唤醒cowait栈中的所有读结点。最终，等待队列的结构如下：</p><p><img src="/image/hexo/image-20200718211018901.png" alt="image-20200718211018901"></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>StampedLock</strong>的等待队列与<strong>RRW</strong>的<strong>CLH</strong>队列相比，有以下特点：</p><ol><li>当入队一个线程时，如果队尾是读结点，不会直接链接到队尾，而是链接到该读结点的cowait链中，cowait链本质是一个栈；</li><li>当入队一个线程时，如果队尾是写结点，则直接链接到队尾；</li><li>唤醒线程的规则和<strong>AQS</strong>类似，都是首先唤醒队首结点。区别是<strong>StampedLock</strong>中，当唤醒的结点是读结点时，会唤醒该读结点的cowait链中的所有读结点（顺序和入栈顺序相反，也就是后进先出）。</li></ol><p>另外，<strong>StampedLock</strong>使用时要特别小心，避免锁重入的操作，在使用乐观读锁时也需要遵循相应的调用模板，防止出现数据不一致的问题。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-50-Condition详解</title>
      <link href="/2020/07/17/39136/hub/"/>
      <url>/2020/07/17/39136/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200717222649206.png" alt="image-20200717222649206"></p><h2 id="Condition相关API"><a href="#Condition相关API" class="headerlink" title="Condition相关API"></a>Condition相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Condition</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ReentrantLock.newCondition</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Condition <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.newCondition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p><img src="/image/hexo/image-20200717203303414.png" alt="image-20200717203303414"></p><h4 id="await"><a href="#await" class="headerlink" title="await"></a>await</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//await</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.当前线程进入等待状态</span></span><br><span class="line"><span class="comment"> * 2.线程中断或者signal</span></span><br><span class="line"><span class="comment"> * 3.支持设置超时时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">condition.await();</span><br><span class="line">condition.await(<span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><h4 id="awaitNanos"><a href="#awaitNanos" class="headerlink" title="awaitNanos"></a>awaitNanos</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//awaitNanos</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.当前线程进入等待状态</span></span><br><span class="line"><span class="comment"> * 2.线程中断或者signal</span></span><br><span class="line"><span class="comment"> * 3.超时</span></span><br><span class="line"><span class="comment"> * 4.返回值表示剩余超时时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">condition.awaitNanos(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="awaitUninterruptibly"><a href="#awaitUninterruptibly" class="headerlink" title="awaitUninterruptibly"></a>awaitUninterruptibly</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//awaitUninterruptibly</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.当前线程进入等待状态</span></span><br><span class="line"><span class="comment"> * 2.只能等待通知</span></span><br><span class="line"><span class="comment"> * 3.不响应中断</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">condition.awaitUninterruptibly();</span><br></pre></td></tr></table></figure><h4 id="awaitUntil"><a href="#awaitUntil" class="headerlink" title="awaitUntil"></a>awaitUntil</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//awaitUntil</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.当前线程进入等待状态</span></span><br><span class="line"><span class="comment"> * 2.通知、线程中断、执行操作退出</span></span><br><span class="line"><span class="comment"> * 3.若是在时间范围内被通知返回true,否则false</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">condition.awaitUntil(<span class="keyword">new</span> Date());</span><br></pre></td></tr></table></figure><h4 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//signal</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 1.唤醒一个在Condition等待的线程</span></span><br><span class="line"><span class="comment"> * 2.必须获得Condition相关联的锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">condition.signal();</span><br></pre></td></tr></table></figure><h4 id="signalAll"><a href="#signalAll" class="headerlink" title="signalAll"></a>signalAll</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//signalAll</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.唤醒所有在Condition等待的线程</span></span><br><span class="line"><span class="comment"> * 2.必须获得Condition相关联的锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">condition.signalAll();</span><br></pre></td></tr></table></figure><h2 id="案例（Condition构建多生产者与消费者）"><a href="#案例（Condition构建多生产者与消费者）" class="headerlink" title="案例（Condition构建多生产者与消费者）"></a>案例（Condition构建多生产者与消费者）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionTest1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Condition PRODUCE = lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消费者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Condition CONSUMER = lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> LinkedList&lt;Integer&gt; QUEUE = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Integer MAX_QUEUE_SIZE = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">6</span>).boxed().forEach(ConditionTest1::startProduce);</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">10</span>).boxed().forEach(ConditionTest1::startConsumer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startProduce</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">           <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">               produce();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;, <span class="string">"P-"</span> + i).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startConsumer</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">                consumer();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"C-"</span> + i).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 生产</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>  sanmengccc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>   2020/7/17 20:48</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">while</span> (QUEUE.size() &gt; MAX_QUEUE_SIZE) &#123;</span><br><span class="line">                PRODUCE.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> value = random.nextInt(<span class="number">1000</span>);</span><br><span class="line">            System.out.println(<span class="string">"The "</span> + Thread.currentThread().getName() + <span class="string">" produce:"</span> + value);</span><br><span class="line">            QUEUE.addLast(value);</span><br><span class="line">            CONSUMER.signalAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 消费</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>   2020/7/17 20:49</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">while</span> (QUEUE.isEmpty()) &#123;</span><br><span class="line">                CONSUMER.await();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"The "</span> + Thread.currentThread().getName() + <span class="string">" consumer:"</span> + QUEUE.removeFirst());</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            PRODUCE.signalAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200717212332776.png" alt="image-20200717212332776"></p><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="ConditionObject"><a href="#ConditionObject" class="headerlink" title="ConditionObject"></a>ConditionObject</h3><p>&emsp;&emsp;<strong>Condition</strong>只是一个接口，而真正的实现还是<code>AQS</code>内部的<strong>ConditionObject</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Condition <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.newCondition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ConditionObject <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ConditionObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>ConditionObject</strong>主要维护了一个等待队列（<code>FIFO</code>）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//条件队首节点指针</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line"><span class="comment">//条件队尾节点指针</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200717212729676.png" alt="image-20200717212729676"></p><h3 id="await-1"><a href="#await-1" class="headerlink" title="await"></a>await</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用该方法必须获取到锁资源（同步队列中的首节点）</span></span><br><span class="line"><span class="comment">//将当前线程加入等待队列、并且释放同步状态、唤醒同步队列中的后继节点</span></span><br><span class="line"><span class="comment">//当前线程进入等待状态</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="comment">//线程中断抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">//包装当前线程、加入条件队列</span></span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">    <span class="comment">//释放锁、返回同步状态（调用此方法前此线程占有锁）</span></span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//判断当前节点是否在等待队列中</span></span><br><span class="line">    <span class="comment">//不在：表示没有竞争锁的资格、继续等待，直到加入队列（singal）</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//唤醒后重新竞争锁资源、失败则继续沉睡、再次等待唤醒开始下一次竞争</span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//加入等待队列</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//队尾节点</span></span><br><span class="line">    Node t = lastWaiter;</span><br><span class="line">    <span class="comment">//尾节点不是CONDITION状态则表示该节点不处于等待状态，清理该节点</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将当前线程进行包装成Node,状态为CONDITION</span></span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    <span class="comment">//加入队尾节点</span></span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">        firstWaiter = node;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t.nextWaiter = node;</span><br><span class="line">    lastWaiter = node;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//释放同步状态</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullyRelease</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//获取同步状态</span></span><br><span class="line">        <span class="keyword">int</span> savedState = getState();</span><br><span class="line">        <span class="comment">//释放锁</span></span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">            failed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            node.waitStatus = Node.CANCELLED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自省检查节点是否还存在于同步队列</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isOnSyncQueue</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//判断节点状态：CONDITION或者前驱动节点为null则返回false</span></span><br><span class="line">    <span class="keyword">if</span> (node.waitStatus == Node.CONDITION || node.prev == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//后继节点不为null、那么当前线程处理同步队列</span></span><br><span class="line">    <span class="keyword">if</span> (node.next != <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> findNodeFromTail(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//清理节点</span></span><br><span class="line"><span class="comment">//1.节点不处于同步队列：挂起当前线程</span></span><br><span class="line"><span class="comment">//2.节点处于同步队列（获取了同步状态）：unlinkCancelledWaiters去清理节点</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unlinkCancelledWaiters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node t = firstWaiter;</span><br><span class="line">    Node trail = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Node next = t.nextWaiter;</span><br><span class="line">        <span class="keyword">if</span> (t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            t.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (trail == <span class="keyword">null</span>)</span><br><span class="line">                firstWaiter = next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                trail.nextWaiter = next;</span><br><span class="line">            <span class="keyword">if</span> (next == <span class="keyword">null</span>)</span><br><span class="line">                lastWaiter = trail;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            trail = t;</span><br><span class="line">        t = next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="signal-1"><a href="#signal-1" class="headerlink" title="signal"></a>signal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//判断当前线程是否获取到了锁资源</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="comment">//抛出Monitor异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="comment">//唤醒等待队列中的首节点</span></span><br><span class="line">    Node first = firstWaiter;</span><br><span class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//移除等待队列的首节点</span></span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</span><br><span class="line">            lastWaiter = <span class="keyword">null</span>;</span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</span><br><span class="line">             (first = firstWaiter) != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要操作：节点移动（移动到同步队列）</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//尝试将该节点状态从CONDITION修改为0、CAS操作</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将当前节点加入同步队尾、并且返回该节点的前驱节点</span></span><br><span class="line">    Node p = enq(node);</span><br><span class="line">    <span class="keyword">int</span> ws = p.waitStatus;</span><br><span class="line">    <span class="comment">//如果前驱节点的状态为：CANCEL或者CAS修改waitStatus失败，则唤醒当前线程</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;成功唤醒的线程，则退出<code>await</code>中的循环，通过<code>acquireQueued</code>再次进行锁资源的竞争。成功获取锁后，唤醒的线程从<code>await</code>方法中返回。</p><p>&emsp;&emsp;<code>signalAll</code>方法主要是对等待队列中的每一个节点去执行了一次<code>signal</code>将等待队列中的所有节点全部移动到了同步队列中。</p><p><img src="/image/hexo/image-20200717212745900.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-49-ReadWriteLock-ReentrantReadWriteLock详解</title>
      <link href="/2020/07/13/4168/hub/"/>
      <url>/2020/07/13/4168/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200713202103876.png" alt="image-20200713202103876"></p><p>&emsp;&emsp;<strong>ReentrantReadWriteLock</strong>主要是针对<strong>ReentrantLock</strong>进行了再一次的封装，是一种<strong>读写锁</strong>的实现。也实现了<strong>独占锁</strong>、<strong>共享锁</strong>的特性，其实它的内部也是基于<strong>AQS</strong>去实现核心功能。</p><p>&emsp;&emsp;1.读锁：没有其他线程进入写锁,没有写入请求或者调用线程和持有锁的线程是同一个。</p><p>&emsp;&emsp;2.写锁：没有其他线程的读写锁。</p><p>&emsp;&emsp;3.基于<strong>ReentrantLock</strong>也支持了公平策略，默认非公平策略。</p><p>&emsp;&emsp;4.读写锁均支持重入。</p><p>&emsp;&emsp;5.支持锁降级操作：遵循获取写锁、读锁、释放写锁的顺序，写锁能够降级为读锁。</p><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="不加锁"><a href="#不加锁" class="headerlink" title="不加锁"></a>不加锁</h3><h4 id="定义共享数据DataRecourseFree"><a href="#定义共享数据DataRecourseFree" class="headerlink" title="定义共享数据DataRecourseFree"></a>定义共享数据DataRecourseFree</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataRecourseFree</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Map&lt;String ,String&gt; dataMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" 正在执行写入操作.......["</span>+key+<span class="string">":"</span>+value+<span class="string">"]"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        dataMap.put(key, value);</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" 正在执行写入操作执行完毕......."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" 正在执行读取操作......."</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" 正在执行读取操作执行完毕.......:["</span>+key+<span class="string">":"</span>+dataMap.get(key)+<span class="string">"]"</span>);</span><br><span class="line">        <span class="keyword">return</span> dataMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DataRecourseFree dataRecourseFree = <span class="keyword">new</span> DataRecourseFree();</span><br><span class="line">        IntStream.range(<span class="number">0</span>,<span class="number">10</span>)</span><br><span class="line">                .forEach(i-&gt;&#123;</span><br><span class="line">                    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                        dataRecourseFree.put(String.valueOf(i), String.valueOf(i));</span><br><span class="line">                    &#125;, String.valueOf(i)).start();</span><br><span class="line">                &#125;);</span><br><span class="line">        IntStream.range(<span class="number">0</span>,<span class="number">10</span>)</span><br><span class="line">                .forEach(i-&gt;&#123;</span><br><span class="line">                    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                        dataRecourseFree.get(String.valueOf(i));</span><br><span class="line"></span><br><span class="line">                    &#125;, String.valueOf(i)).start();</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200713210916750.png" alt="image-20200713210916750"></p><p><img src="/image/hexo/image-20200713210932415.png" alt="image-20200713210932415"></p><p>&emsp;&emsp;毫无疑问线程安全问题无法避免。那么下面采用加锁的方式来解决线程不安全的问题。</p><h3 id="加锁"><a href="#加锁" class="headerlink" title="加锁"></a>加锁</h3><h4 id="重新定义DataRecource"><a href="#重新定义DataRecource" class="headerlink" title="重新定义DataRecource"></a>重新定义DataRecource</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataRecourse</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    ReentrantReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Map&lt;String ,String&gt; dataMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.writeLock().lock();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" 正在执行写入操作.......["</span>+key+<span class="string">":"</span>+value+<span class="string">"]"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            dataMap.put(key, value);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" 正在执行写入操作执行完毕......."</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.readLock().lock();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" 正在执行读取操作......."</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" 正在执行读取操作执行完毕.......:["</span>+key+<span class="string">":"</span>+dataMap.get(key)+<span class="string">"]"</span>);</span><br><span class="line">            <span class="keyword">return</span> dataMap.get(key);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试运行-1"><a href="#测试运行-1" class="headerlink" title="测试运行"></a>测试运行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DataRecourse dataRecourseFree = <span class="keyword">new</span> DataRecourse();</span><br><span class="line">        IntStream.range(<span class="number">0</span>,<span class="number">10</span>)</span><br><span class="line">                .forEach(i-&gt;&#123;</span><br><span class="line">                    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                        dataRecourseFree.put(String.valueOf(i), String.valueOf(i));</span><br><span class="line">                    &#125;, String.valueOf(i)).start();</span><br><span class="line">                &#125;);</span><br><span class="line">        IntStream.range(<span class="number">0</span>,<span class="number">10</span>)</span><br><span class="line">                .forEach(i-&gt;&#123;</span><br><span class="line">                    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                        dataRecourseFree.get(String.valueOf(i));</span><br><span class="line"></span><br><span class="line">                    &#125;, String.valueOf(i)).start();</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200713211447063.png" alt="image-20200713211447063"></p><p>&emsp;&emsp;使用读写锁自然是能够解决上面的线程不安全的问题。</p><h2 id="ReentranReadWriteLock相关API"><a href="#ReentranReadWriteLock相关API" class="headerlink" title="ReentranReadWriteLock相关API"></a>ReentranReadWriteLock相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantReadWriteLock</span> <span class="keyword">implements</span> <span class="title">ReadWriteLock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">ReentrantReadWriteLock r1 = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"><span class="comment">//可以通过构造函数指定公平策略</span></span><br><span class="line">ReentrantReadWriteLock r2 = <span class="keyword">new</span> ReentrantReadWriteLock(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="getQueueLength"><a href="#getQueueLength" class="headerlink" title="getQueueLength"></a>getQueueLength</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ReentrantReadWriteLock reentrantLock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">//getQueueLength</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回等待获取读取或写入锁定的线程数的估计</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.getQueueLength());</span><br></pre></td></tr></table></figure><h4 id="getReadHoldCount"><a href="#getReadHoldCount" class="headerlink" title="getReadHoldCount"></a>getReadHoldCount</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getReadHoldCount</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询当前线程对此锁的可重入读取保留数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.getReadHoldCount());</span><br></pre></td></tr></table></figure><h4 id="getReadLockCount"><a href="#getReadLockCount" class="headerlink" title="getReadLockCount"></a>getReadLockCount</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getReadLockCount</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询为此锁持有的读取锁的数量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.getReadLockCount());</span><br></pre></td></tr></table></figure><h4 id="getWaitQueueLength"><a href="#getWaitQueueLength" class="headerlink" title="getWaitQueueLength"></a>getWaitQueueLength</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getWaitQueueLength</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回与写入锁相关联的给定条件等待的线程数的估计</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.getWaitQueueLength(<span class="keyword">null</span>));</span><br></pre></td></tr></table></figure><h4 id="getWriteHoldCount"><a href="#getWriteHoldCount" class="headerlink" title="getWriteHoldCount"></a>getWriteHoldCount</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getWriteHoldCount</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询当前线程对此锁的可重入写入数量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.getWriteHoldCount());</span><br></pre></td></tr></table></figure><h4 id="hasQueuedThread"><a href="#hasQueuedThread" class="headerlink" title="hasQueuedThread"></a>hasQueuedThread</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hasQueuedThread</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询给定线程是否等待获取读取或写入锁定</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.hasQueuedThread(Thread.currentThread()));</span><br></pre></td></tr></table></figure><h4 id="hasQueuedThreads"><a href="#hasQueuedThreads" class="headerlink" title="hasQueuedThreads"></a>hasQueuedThreads</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hasQueuedThreads</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询是否有任何线程正在等待获取读取或写入锁定</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.hasQueuedThreads());</span><br></pre></td></tr></table></figure><h4 id="hasWaiters"><a href="#hasWaiters" class="headerlink" title="hasWaiters"></a>hasWaiters</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hasWaiters</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询任何线程是否等待与写锁相关联的给定条件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.hasWaiters(<span class="keyword">null</span>));</span><br></pre></td></tr></table></figure><h4 id="isFair"><a href="#isFair" class="headerlink" title="isFair"></a>isFair</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isFair</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.如果此锁的公平设置为true，则返回 true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.isFair());</span><br></pre></td></tr></table></figure><h4 id="isWriteLocked"><a href="#isWriteLocked" class="headerlink" title="isWriteLocked"></a>isWriteLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isWriteLocked</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询写锁是否由任何线程持有</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.isWriteLocked());</span><br></pre></td></tr></table></figure><h4 id="isWriteLockedByCurrentThread"><a href="#isWriteLockedByCurrentThread" class="headerlink" title="isWriteLockedByCurrentThread"></a>isWriteLockedByCurrentThread</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isWriteLockedByCurrentThread</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询写锁是否由当前线程持有</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.isWriteLockedByCurrentThread());</span><br></pre></td></tr></table></figure><h4 id="readLock"><a href="#readLock" class="headerlink" title="readLock"></a>readLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//readLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回用于阅读的锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.readLock());</span><br></pre></td></tr></table></figure><h4 id="writeLock"><a href="#writeLock" class="headerlink" title="writeLock"></a>writeLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//writeLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回用于写入的锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.writeLock());</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><p><img src="/image/hexo/image-20200713213045415.png" alt="image-20200713213045415"></p><h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//读取锁</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;</span><br><span class="line"><span class="comment">//写入</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Sync sync;</span><br></pre></td></tr></table></figure><h3 id="WriteLock-lock"><a href="#WriteLock-lock" class="headerlink" title="WriteLock#lock"></a>WriteLock#lock</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以发现从这时开始以及是基于<strong>ReentrantLock</strong>的范畴了。所以针对<strong>ReentrantReadWriteLock</strong>就不在重复的再去分析了。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-48-ReentrantLock详解</title>
      <link href="/2020/07/12/29479/hub/"/>
      <url>/2020/07/12/29479/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200712140726035.png" alt="image-20200712140726035"></p><p>&emsp;&emsp;<strong>ReentrantLock</strong>是一种<strong>可重入</strong>的<strong>独占锁</strong>，实现了<strong>Lock</strong>接口。</p><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="案例一（常规争夺锁）"><a href="#案例一（常规争夺锁）" class="headerlink" title="案例一（常规争夺锁）"></a>案例一（常规争夺锁）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                reentrantLock.lock();</span><br><span class="line">                System.out.println(<span class="string">"A get lock."</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                reentrantLock.unlock();</span><br><span class="line">                System.out.println(<span class="string">"A unlock."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">"A"</span>).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                reentrantLock.lock();</span><br><span class="line">                System.out.println(<span class="string">"B get lock."</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                reentrantLock.unlock();</span><br><span class="line">                System.out.println(<span class="string">"B unlock."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">"B"</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="案例二（争抢锁打断线程）"><a href="#案例二（争抢锁打断线程）" class="headerlink" title="案例二（争抢锁打断线程）"></a>案例二（争抢锁打断线程）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                reentrantLock.lock();</span><br><span class="line">                System.out.println(<span class="string">"A get lock."</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                reentrantLock.unlock();</span><br><span class="line">                System.out.println(<span class="string">"A unlock."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">"A"</span>).start();</span><br><span class="line"></span><br><span class="line">    Thread threadB = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                reentrantLock.lockInterruptibly();</span><br><span class="line">                System.out.println(<span class="string">"B get lock."</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                reentrantLock.unlock();</span><br><span class="line">                System.out.println(<span class="string">"B unlock."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">"B"</span>);</span><br><span class="line">    threadB.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    threadB.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ReentrantLock相关API"><a href="#ReentrantLock相关API" class="headerlink" title="ReentrantLock相关API"></a>ReentrantLock相关API</h3><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">ReentrantLock reentrant1 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="comment">//可以设置公平策略</span></span><br><span class="line">ReentrantLock reentrant2 = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="getHoldCount"><a href="#getHoldCount" class="headerlink" title="getHoldCount"></a>getHoldCount</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getHoldCount</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询当前线程保持此锁定的个数(调用lock()方法的次数)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">reentrantLock.getHoldCount();</span><br></pre></td></tr></table></figure><h4 id="getQueueLength"><a href="#getQueueLength" class="headerlink" title="getQueueLength"></a>getQueueLength</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getQueueLength</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取正等待获取此锁定的线程数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.getQueueLength());</span><br></pre></td></tr></table></figure><h4 id="hasQueuedThread"><a href="#hasQueuedThread" class="headerlink" title="hasQueuedThread"></a>hasQueuedThread</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hasQueuedThread</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.判断线程是否处于等待队列之中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.hasQueuedThread(Thread.currentThread()));</span><br></pre></td></tr></table></figure><h4 id="hasQueuedThreads"><a href="#hasQueuedThreads" class="headerlink" title="hasQueuedThreads"></a>hasQueuedThreads</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hasQueuedThreads</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.判断是否有线程处于等待队列之中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.hasQueuedThreads());</span><br></pre></td></tr></table></figure><h4 id="hasWaiters"><a href="#hasWaiters" class="headerlink" title="hasWaiters"></a>hasWaiters</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hasWaiters</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询是否有线程正在等待与此锁定有关的Condition条件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.hasWaiters(<span class="keyword">null</span>));</span><br></pre></td></tr></table></figure><h4 id="isFair"><a href="#isFair" class="headerlink" title="isFair"></a>isFair</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isFair</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.判断锁策略公平锁还是非公平锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.isFair());</span><br></pre></td></tr></table></figure><h4 id="isHeldByCurrentThread"><a href="#isHeldByCurrentThread" class="headerlink" title="isHeldByCurrentThread"></a>isHeldByCurrentThread</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isHeldByCurrentThread</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询当前线程是否保持此锁定</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.isHeldByCurrentThread());</span><br></pre></td></tr></table></figure><h4 id="isLocked"><a href="#isLocked" class="headerlink" title="isLocked"></a>isLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isLocked</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询此锁定是否由任意线程保持</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.isLocked());</span><br></pre></td></tr></table></figure><h4 id="lock-amp-unlock"><a href="#lock-amp-unlock" class="headerlink" title="lock &amp; unlock"></a>lock &amp; unlock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lock &amp; unlock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取锁</span></span><br><span class="line"><span class="comment"> * 2.释放锁</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    reentrantLock.lock();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">    reentrantLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="lockInterruptibly"><a href="#lockInterruptibly" class="headerlink" title="lockInterruptibly"></a>lockInterruptibly</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lockInterruptibly</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.线程在请求lock并被阻塞时，如果被interrupt，则此线程会被唤醒并被要求处理InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    reentrantLock.lockInterruptibly();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="newCondition"><a href="#newCondition" class="headerlink" title="newCondition"></a>newCondition</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//newCondition</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.创建一个新的Condition实例。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.newCondition());</span><br></pre></td></tr></table></figure><h4 id="tryLock"><a href="#tryLock" class="headerlink" title="tryLock"></a>tryLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tryLock</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.尝试获取锁，如果获取成功，则返回true，如果获取失败（即锁已被其他线程获取），则返回false</span></span><br><span class="line"><span class="comment"> * 2。支持设置超时时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reentrantLock.tryLock());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    System.out.println(reentrantLock.tryLock(<span class="number">10</span>, TimeUnit.MILLISECONDS));</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="执行策略"><a href="#执行策略" class="headerlink" title="执行策略"></a>执行策略</h3><p>&emsp;&emsp;1.公平策略:多线程争抢锁的情况下，公平策略更加的倾向于等待时间最长的显示，先来后到的原则。</p><p>&emsp;&emsp;2.非公平策略:多线程争抢锁的情况下，线程获取锁资源是随机的。</p><h2 id="AbstractQueuedSynchronizer相关"><a href="#AbstractQueuedSynchronizer相关" class="headerlink" title="AbstractQueuedSynchronizer相关"></a>AbstractQueuedSynchronizer相关</h2><h3 id="同步等待队列"><a href="#同步等待队列" class="headerlink" title="同步等待队列"></a>同步等待队列</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//指向队列首元素的头指针</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line"></span><br><span class="line"><span class="comment">//指向队列尾元素的尾指针</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//指向前一个结点的指针</span></span><br><span class="line"><span class="keyword">volatile</span> Node prev; </span><br><span class="line"><span class="comment">//指向后一个结点的指针</span></span><br><span class="line"><span class="keyword">volatile</span> Node next; </span><br><span class="line"><span class="comment">//当前结点代表的线程</span></span><br><span class="line"><span class="comment">//因为同步队列中的节点封装了之前的竞争锁失败的线程，所有内部必定存在一个对应的实例对象</span></span><br><span class="line"><span class="keyword">volatile</span> Thread thread; </span><br><span class="line"><span class="comment">//等待状态</span></span><br><span class="line"><span class="comment">//0:初始化状态 </span></span><br><span class="line"><span class="comment">//-1:当前节点表示的线程在释放锁后需要唤醒后续节点的线程</span></span><br><span class="line"><span class="comment">//1:在同步队列中等待的线程等待超时或者被中断、取消继续等待</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200712201348426.png" alt="image-20200712201348426"></p><p>&emsp;&emsp;1.同步队列是一个先进先出（FIFO）队列。</p><p>&emsp;&emsp;2.获取锁失败的线程：构造节点并且加入队列尾部，阻塞自己。</p><p>&emsp;&emsp;3.队列首节点可以用来表示当前正在获取的线程。</p><p>&emsp;&emsp;4.当前线程释放锁后：尝试唤醒后续节点处于阻塞状态的线程。</p><h3 id="同步状态变量"><a href="#同步状态变量" class="headerlink" title="同步状态变量"></a>同步状态变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The synchronization state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.它的作用类似计数器，在<strong>ReentrantLock</strong>中主要表示该锁被线程重入的次数。</p><p>&emsp;&emsp;2.<strong>state:0</strong>：表示该锁不被任何线程持有。</p><p>&emsp;&emsp;3.<strong>state:&gt;=1</strong>：表示该锁被线程重入<strong>state</strong>次。</p><p>&emsp;&emsp;4.由于多线程高并发的原因，为了保证数据的可见性这里采用<strong>volatile</strong>去实现。 </p><h3 id="持有同步线程的标记"><a href="#持有同步线程的标记" class="headerlink" title="持有同步线程的标记"></a>持有同步线程的标记</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The current owner of exclusive mode synchronization.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Thread exclusiveOwnerThread;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.在独占同步模式下标记持有的同步状态线程。</p><p>&emsp;&emsp;2.在<strong>ReentrantLock</strong>锁中，主要用于标记锁被具体哪一个线程所持有。</p><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="lock-非公平"><a href="#lock-非公平" class="headerlink" title="lock(非公平)"></a>lock(非公平)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.lock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//尝试将state从0更新为1（CAS操作）</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        <span class="comment">//获取锁成功后将当前线程标记为持有锁的线程</span></span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">//获取锁失败</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//当前线程企图获取所资源</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; </span><br><span class="line">        <span class="comment">//锁争夺失败进入该逻辑</span></span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="tryAcquire"><a href="#tryAcquire" class="headerlink" title="tryAcquire"></a>tryAcquire</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取当前线程</span></span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">//获取state变量</span></span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">//如果state==0、表示当前锁没有被任何的线程持有</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//CAS方式尝试获取锁资源</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            <span class="comment">//标记当前线程为持有锁的线程</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="comment">//非重入获取锁资源</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断当前线程是否已经持有了该锁、表示该锁已经开始重入</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">//计算state的更新值</span></span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="comment">//判断是否越界</span></span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">        <span class="comment">//设置新的值（非同步）</span></span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取锁失败</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="addWaiter"><a href="#addWaiter" class="headerlink" title="addWaiter"></a>addWaiter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建一个新的节点Node，设置当前线程实例在内部</span></span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//入队逻辑</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//当前t指向队列的最后一个节点</span></span><br><span class="line">        Node t = tail;</span><br><span class="line">        <span class="comment">//如果为null</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="comment">//构造一个新的节点，CAS方式去设置队列首元素</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                <span class="comment">//队尾指针指向了首节点</span></span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//队列不为null的情况</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="comment">//CAS将队尾指针指向当前节点</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                <span class="comment">//原队尾节点的next指针指向当前节点</span></span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200712214119877.png" alt="image-20200712214119877"></p><p><img src="/image/hexo/image-20200712214136785.png" alt="image-20200712214136785"></p><p><img src="/image/hexo/image-20200712214334164.png" alt="image-20200712214334164"></p><h3 id="unlock-非公平"><a href="#unlock-非公平" class="headerlink" title="unlock(非公平)"></a>unlock(非公平)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//释放锁,对应state-1</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="comment">//当前队列不为空并且头部节点状态不是初始化状态</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//唤醒同步队列中被阻塞的线程</span></span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//计算所需要更新的state的数值</span></span><br><span class="line">    <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">    <span class="comment">//判断当前线程是否获取到了锁</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="comment">//没有拥有该锁则会抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//如果c == 0,那么持有该锁的线程没有重入</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//清除锁持有线程的标记</span></span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新state</span></span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//唤醒同步队列中阻塞的线程</span></span><br><span class="line"><span class="comment">//一般只需要唤醒后继节点即可</span></span><br><span class="line"><span class="comment">//但是后续节点可能已经取消了等待,那么从队列尾部往前回溯尝试唤醒阻塞的线程</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If status is negative (i.e., possibly needing signal) try</span></span><br><span class="line"><span class="comment">     * to clear in anticipation of signalling.  It is OK if this</span></span><br><span class="line"><span class="comment">     * fails or if status is changed by waiting thread.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Thread to unpark is held in successor, which is normally</span></span><br><span class="line"><span class="comment">     * just the next node.  But if cancelled or apparently null,</span></span><br><span class="line"><span class="comment">     * traverse backwards from tail to find the actual</span></span><br><span class="line"><span class="comment">     * non-cancelled successor.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200712215100773.png" alt="image-20200712215100773"></p><h3 id="lock-公平"><a href="#lock-公平" class="headerlink" title="lock(公平)"></a>lock(公平)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.lock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//在执行CAS前新增了hasQueuedPredecessors判断</span></span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要用于判断队列之中是否还存在优先级更高的等待线程</span></span><br><span class="line"><span class="comment">//需要注意的是头部的线程表示当前线程，那么第二个节点表示整个队列中优先级最高的线程</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedPredecessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The correctness of this depends on head being initialized</span></span><br><span class="line">    <span class="comment">// before tail and on head.next being accurate if the current</span></span><br><span class="line">    <span class="comment">// thread is first in queue.</span></span><br><span class="line">    Node t = tail; <span class="comment">// Read fields in reverse initialization order</span></span><br><span class="line">    Node h = head;</span><br><span class="line">    Node s;</span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">        ((s = h.next) == <span class="keyword">null</span> || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.第二个节点已经完全插入，但是为知该节点是否为当前节点，那么可以通过<strong>s.thread != Thread.currentThread()</strong>判断，<code>true</code>表示该节点代表的是其他线程。</p><p>&emsp;&emsp;2.第二个节点没有完全的插入。（1.待插入的节点pre指针指向队尾。2.CAS更新队尾指针。3.原队尾节点的next指针指向新插入节点。）<strong>(s = h.next) == null</strong>主要用于处理<strong>2-&gt;3</strong>这种阶段的情况。</p><h3 id="acquireQueued"><a href="#acquireQueued" class="headerlink" title="acquireQueued"></a>acquireQueued</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//死循环,正常情况下线程只有获得锁才能跳出循环</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//获得当前线程所在结点的前驱结点</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">//第一个if分句</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123; </span><br><span class="line">                <span class="comment">//将当前结点设置为队列头结点</span></span><br><span class="line">                setHead(node); </span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">//正常情况下死循环唯一的出口</span></span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//判断是否要阻塞当前线程</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;  </span><br><span class="line">                <span class="comment">//阻塞当前线程</span></span><br><span class="line">                parkAndCheckInterrupt())      </span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="几点疑问"><a href="#几点疑问" class="headerlink" title="几点疑问"></a>几点疑问</h2><h3 id="FIFO同步队列怎么实现非公平锁"><a href="#FIFO同步队列怎么实现非公平锁" class="headerlink" title="FIFO同步队列怎么实现非公平锁"></a>FIFO同步队列怎么实现非公平锁</h3><p>&emsp;&emsp;1.FIFO特性：先加入同步队列等待的线程更加靠近队列头部，也就能够更早的获取到锁。先进先出的顺序在这个意义上来讲保证了公平性。</p><p>&emsp;&emsp;2.实际上并非只有加入线程等待队列才有机会获得锁，尽管线程同步队列已经有线程处于等待状态，这也是非公平模式的意义所在。在线程进入线程同步队列之前有两次抢占锁的机会。</p><p>&emsp;&emsp;3.第一次：非重入获取锁资源，只有当前锁没有被任何线程持有（包含自身）。</p><p>&emsp;&emsp;4.第二次：在进入线程等待队列前，包含了所有情况获取锁的方式。</p><p>&emsp;&emsp;5.如果两次获取锁失败，线程就会进行构造新的节点加入线程等待队列之中。释放锁的时候先修改<strong>state</strong>再唤醒其后继节点中处于等待的线程。</p><p>&emsp;&emsp;6.在<code>5</code>中也会有以下情况发生：若是线程A已经释放了锁，但是还没有来得及唤醒后继节点中的线程C，那么此刻线程B刚好尝试获取锁，并且锁由于线程A的释放导致它不被任何线程持有，那么线程C则会继续陷入等待中，这也是非公平的一个体现。</p><h3 id="非公平锁的性能体现"><a href="#非公平锁的性能体现" class="headerlink" title="非公平锁的性能体现"></a>非公平锁的性能体现</h3><p>&emsp;&emsp;1.非公平模式的极具抢占性，线程在入队之前拥有两次机会去尝试获取锁，极大的提高了获取锁的机率。</p><p>&emsp;&emsp;2.由于在未入队之前可以有机会抢占锁，那么在一定程度上减少了构造队列节点等繁琐的操作，也减少了唤醒后继节点等待线程的所带来的性能开销（主要涉及线程上下文的切换和操作系统的调用，是非常耗费资源的）。</p><p>&emsp;&emsp;3.由于入队时会产生<strong>CAS</strong>竞争，如果在入队才能获取锁，此处的<strong>CAS</strong>竞争将会异常的激烈，由于<strong>CAS</strong>带来的不断重试也会带来一定的性能开销。并且获取锁时将非重入的情况提前处理，还有在入队操作的时候，针对队列为空的情况进行了提前处理。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-47-Semaphore详解</title>
      <link href="/2020/07/12/40954/hub/"/>
      <url>/2020/07/12/40954/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200712084643728.png" alt="image-20200712084643728"></p><p>&emsp;&emsp;<strong>Semaphore</strong>(信号量),它的作用类似于“许可证”，它维护了一个许可集。当有线程想要去访问共享资源的时候，就必须要获取到一个“许可”证明，若是“许可”证明已经发放完毕，那么该线程就将陷入等待，直到“许可”证明可用才会继续访问，当一个线程访问结束后，可以归还这个“许可”凭证，再次提供给其他线程使用。</p><p>&emsp;&emsp;<strong>Semaphore</strong>也时支持公平/非公平的策略。</p><h2 id="定义一个显示锁"><a href="#定义一个显示锁" class="headerlink" title="定义一个显示锁"></a>定义一个显示锁</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SemaphoreLock lock = <span class="keyword">new</span> SemaphoreLock();</span><br><span class="line">    IntStream.range(<span class="number">0</span>,<span class="number">2</span>).forEach(i-&gt;&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" is Running."</span>);</span><br><span class="line">                lock.lock();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" get Lock."</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" unlock."</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个显示锁</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreLock</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//整个锁完全时依赖于semaphore许可证的数量</span></span><br><span class="line">    <span class="keyword">private</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        semaphore.acquire();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        semaphore.release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Semaphore相关API"><a href="#Semaphore相关API" class="headerlink" title="Semaphore相关API"></a>Semaphore相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Semaphore</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//公平策略</span></span><br><span class="line"><span class="keyword">private</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>,<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="acquire"><a href="#acquire" class="headerlink" title="acquire"></a>acquire</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//acquire</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取许可证</span></span><br><span class="line"><span class="comment"> * 2.获取指定数量的许可证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">semaphore.acquire();</span><br><span class="line">semaphore.acquire(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="release"><a href="#release" class="headerlink" title="release"></a>release</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//release</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.释放许可证</span></span><br><span class="line"><span class="comment"> * 2.释放前必须先获得</span></span><br><span class="line"><span class="comment"> * 3.释放指定数量的许可证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">semaphore.release();</span><br><span class="line">semaphore.release(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="tryAcquire"><a href="#tryAcquire" class="headerlink" title="tryAcquire"></a>tryAcquire</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//tryAcquire</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.尝试获取一个许可证</span></span><br><span class="line"><span class="comment"> * 2.成功返回：true,失败返回：false</span></span><br><span class="line"><span class="comment"> * 3.尝试获取多个许可证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">boolean</span> tryAcquire = semaphore.tryAcquire();</span><br><span class="line">semaphore.tryAcquire(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//尝试获取多个并且具有超时时间</span></span><br><span class="line">semaphore.tryAcquire(<span class="number">10</span>, <span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"><span class="comment">//尝试获取一个并且具有超时时间</span></span><br><span class="line">semaphore.tryAcquire(<span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><h4 id="acquireUninterruptibly"><a href="#acquireUninterruptibly" class="headerlink" title="acquireUninterruptibly"></a>acquireUninterruptibly</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//acquireUninterruptibly</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.从此信号量中获取许可，在有可用的许可前将其阻塞</span></span><br><span class="line"><span class="comment"> * 2.从此信号量获取给定数目的许可，在提供这些许可前一直将线程阻塞</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">semaphore.acquireUninterruptibly();</span><br><span class="line">semaphore.acquireUninterruptibly(<span class="number">10</span>);</span><br></pre></td></tr></table></figure><h4 id="availablePermits"><a href="#availablePermits" class="headerlink" title="availablePermits"></a>availablePermits</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//availablePermits</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回此信号量中当前可用的许可数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(semaphore.availablePermits());</span><br></pre></td></tr></table></figure><h4 id="drainPermits"><a href="#drainPermits" class="headerlink" title="drainPermits"></a>drainPermits</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//drainPermits</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取并返回立即可用的所有许可。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(semaphore.drainPermits());</span><br></pre></td></tr></table></figure><h4 id="getQueueLength"><a href="#getQueueLength" class="headerlink" title="getQueueLength"></a>getQueueLength</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getQueueLength</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回正在等待获取的线程的估计数目</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(semaphore.getQueueLength());</span><br></pre></td></tr></table></figure><h4 id="hasQueuedThreads"><a href="#hasQueuedThreads" class="headerlink" title="hasQueuedThreads"></a>hasQueuedThreads</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hasQueuedThreads</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.查询是否有线程正在等待获取</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(semaphore.hasQueuedThreads());</span><br></pre></td></tr></table></figure><h4 id="isFair"><a href="#isFair" class="headerlink" title="isFair"></a>isFair</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isFair</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.如果此信号量的公平设置为 true，则返回 true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(semaphore.isFair());</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="内部类Sync"><a href="#内部类Sync" class="headerlink" title="内部类Sync"></a>内部类Sync</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1192457210091910933L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置许可证总数</span></span><br><span class="line">    Sync(<span class="keyword">int</span> permits) &#123;</span><br><span class="line">        setState(permits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取剩余的许可证总数</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getPermits</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getState();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主要用于：自旋 CAS非公平获取</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">nonfairTryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//进入自旋</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//获取剩余的许可证数量</span></span><br><span class="line">            <span class="keyword">int</span> available = getState();</span><br><span class="line">            <span class="comment">//获取本次获取后、还剩余的许可证数量</span></span><br><span class="line">            <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">            <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">               <span class="comment">//如果可操作的&gt;=0,那么进行CAS更新许可数量</span></span><br><span class="line">                <span class="comment">//否则许可证获取失败</span></span><br><span class="line">                compareAndSetState(available, remaining))</span><br><span class="line">                <span class="keyword">return</span> remaining;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主要用于CAS释放许可证</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//进入自旋</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//获取当前可用的许可证数量</span></span><br><span class="line">            <span class="keyword">int</span> current = getState();</span><br><span class="line">            <span class="comment">//获取当前释放许可证数量更新的数值</span></span><br><span class="line">            <span class="keyword">int</span> next = current + releases;</span><br><span class="line">            <span class="comment">//如果更新值为负数则抛出异常</span></span><br><span class="line">            <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum permit count exceeded"</span>);</span><br><span class="line">            <span class="comment">//进入CAS更新许可证数量</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主要用于减少许可证数量</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">reducePermits</span><span class="params">(<span class="keyword">int</span> reductions)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//进入自旋</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//获取当前剩余的许可证数量</span></span><br><span class="line">            <span class="keyword">int</span> current = getState();</span><br><span class="line">            <span class="comment">//计算需要更新的许可证数量</span></span><br><span class="line">            <span class="keyword">int</span> next = current - reductions;</span><br><span class="line">            <span class="comment">//主要判断reductions是否为负，为负则抛出异常信息</span></span><br><span class="line">            <span class="keyword">if</span> (next &gt; current) <span class="comment">// underflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Permit count underflow"</span>);</span><br><span class="line">            <span class="comment">//进行CAS更新许可证数量</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主要用于丢弃所有的许可证</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">drainPermits</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">int</span> current = getState();</span><br><span class="line">            <span class="keyword">if</span> (current == <span class="number">0</span> || compareAndSetState(current, <span class="number">0</span>))</span><br><span class="line">                <span class="keyword">return</span> current;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="非公平模式NonfairSync"><a href="#非公平模式NonfairSync" class="headerlink" title="非公平模式NonfairSync"></a>非公平模式NonfairSync</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2694183684443567898L</span>;</span><br><span class="line"></span><br><span class="line">    NonfairSync(<span class="keyword">int</span> permits) &#123;</span><br><span class="line">        <span class="keyword">super</span>(permits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquireShared(acquires);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="公平模式FairSync"><a href="#公平模式FairSync" class="headerlink" title="公平模式FairSync"></a>公平模式FairSync</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2014338818796000944L</span>;</span><br><span class="line"></span><br><span class="line">    FairSync(<span class="keyword">int</span> permits) &#123;</span><br><span class="line">        <span class="keyword">super</span>(permits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//公平的获取许可证</span></span><br><span class="line">    <span class="comment">//需要判断同步队列中是否有线程在等待，如果有那么获取失败进入阻塞状态</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//进入自旋</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//如果存在线程在等待那么立即返回</span></span><br><span class="line">            <span class="keyword">if</span> (hasQueuedPredecessors())</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="comment">//以CAS的方式去获取许可证</span></span><br><span class="line">            <span class="keyword">int</span> available = getState();</span><br><span class="line">            <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">            <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">                compareAndSetState(available, remaining))</span><br><span class="line">                <span class="keyword">return</span> remaining;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="acquire-1"><a href="#acquire-1" class="headerlink" title="acquire"></a>acquire</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">//企图获取许可证，若&lt;0则进入阻塞，否则获取成功</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquireShared(acquires);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 剩余许可数量。非负数，获取许可成功，负数，获取许可失败</span></span><br><span class="line"><span class="comment"> * 以CAS+自旋的方式获取</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">nonfairTryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> available = getState();</span><br><span class="line">        <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">        <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            <span class="keyword">return</span> remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取许可失败，线程进入阻塞状态</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">//主要创建同步队列节点，并且加入队列</span></span><br><span class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.SHARED);</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//如果当前节点是第二个节点，那么尝试获取锁</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="keyword">int</span> r = tryAcquireShared(arg);</span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//阻塞线程</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="release-1"><a href="#release-1" class="headerlink" title="release"></a>release</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//归还许可</span></span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//释放许可，但是未对释放数量做限制，那么可以通过releases动态的增加许可数量</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//CAS+自旋修改许可数量</span></span><br><span class="line">        <span class="keyword">int</span> current = getState();</span><br><span class="line">        <span class="keyword">int</span> next = current + releases;</span><br><span class="line">        <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum permit count exceeded"</span>);</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReleaseShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//进入自旋</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="keyword">int</span> ws = h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;            <span class="comment">// loop to recheck cases</span></span><br><span class="line">                <span class="comment">//唤醒第一个线程</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                     !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;                <span class="comment">// loop on failed CAS</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h == head)                   <span class="comment">// loop if head changed</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-46-Exchanger详解</title>
      <link href="/2020/07/11/34522/hub/"/>
      <url>/2020/07/11/34522/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200711235656352.png" alt="image-20200711235656352"></p><p><img src="/image/hexo/image-20200712065745894.png" alt="image-20200712065745894"></p><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="String数据交换"><a href="#String数据交换" class="headerlink" title="String数据交换"></a>String数据交换</h3><p>&emsp;&emsp;<strong>Exchanger</strong>中的线程总是成对出现，一个线程总是在成它所成对的线程执行结束，进行数据交换。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" start."</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String result = exchanger.exchange(<span class="string">"I am come from A"</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Get value:"</span> + result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" Thread stop."</span>);</span><br><span class="line">    &#125;,<span class="string">"A"</span>).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" start."</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String result = exchanger.exchange(<span class="string">"I am come from B"</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" Get value:"</span> + result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" Thread stop."</span>);</span><br><span class="line">    &#125;,<span class="string">"B"</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="对象数据交换线程安全"><a href="#对象数据交换线程安全" class="headerlink" title="对象数据交换线程安全"></a>对象数据交换线程安全</h3><p>&emsp;&emsp;可以发现<strong>Exchanger</strong>交换的数据对象是同一个，那么必然也会存在线程安全问题，使用上也需要注意这一点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Exchanger&lt;Object&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        Object aobj = <span class="keyword">new</span> Object();</span><br><span class="line">        System.out.println(<span class="string">"A will be send object:"</span> + aobj);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object exchange = exchanger.exchange(aobj);</span><br><span class="line">            System.out.println(<span class="string">"A get result object:"</span> + exchange);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;, <span class="string">"A"</span>).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        Object aobj = <span class="keyword">new</span> Object();</span><br><span class="line">        System.out.println(<span class="string">"B will be send object:"</span> + aobj);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object exchange = exchanger.exchange(aobj);</span><br><span class="line">            System.out.println(<span class="string">"B get result object:"</span> + exchange);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;, <span class="string">"B"</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="复用并且多次交换数据"><a href="#复用并且多次交换数据" class="headerlink" title="复用并且多次交换数据"></a>复用并且多次交换数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test03</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Exchanger&lt;Integer&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        AtomicInteger integer = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Integer exchange = exchanger.exchange(integer.get());</span><br><span class="line">                System.out.println(<span class="string">"A send value:"</span> + integer.get());</span><br><span class="line">                integer.set(exchange);</span><br><span class="line">                System.out.println(<span class="string">"A get value:"</span> + integer.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">"A"</span>).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        AtomicInteger integer = <span class="keyword">new</span> AtomicInteger(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Integer exchange = exchanger.exchange(integer.get());</span><br><span class="line">                System.out.println(<span class="string">"B send value:"</span> + integer.get());</span><br><span class="line">                integer.set(exchange);</span><br><span class="line">                System.out.println(<span class="string">"B get value:"</span> + integer.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">"B"</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Exchanger相关API"><a href="#Exchanger相关API" class="headerlink" title="Exchanger相关API"></a>Exchanger相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exchanger</span>&lt;<span class="title">V</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="exchange"><a href="#exchange" class="headerlink" title="exchange"></a>exchange</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//成对的线程间进行数据交换</span></span><br><span class="line">exchanger.exchange(<span class="string">"I am come from A"</span>);</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><p><img src="/image/hexo/image-20200712081523157.png!%5Bimage-20200712081542341%5D(/image/hexo/image-20200712081542341.png" alt="image-20200712081523157"></p><h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ThreadLocal变量，每个线程都有自己的一个副本</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Participant participant;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//高并发下使用的，保存待匹配的Node实例</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Node[] arena;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//低并发下，arena未初始化时使用的保存待匹配的Node实例</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Node slot;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始值为0，当创建arena后会被赋值成SEQ，用来记录arena数组的可用最大索引，会随着并发的增大而增大直到等于最大值FULL，会随着并行的线程逐一匹配成功而减少恢复成初始值</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> bound;</span><br></pre></td></tr></table></figure><h3 id="静态常量"><a href="#静态常量" class="headerlink" title="静态常量"></a>静态常量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化arena时使用，1 &lt;&lt; ASHIFT是一个缓存行的大小，避免不同的Node落入到同一个高速缓存行</span></span><br><span class="line"><span class="comment">// 这里实际是把数组容量扩大了8倍，原来索引相邻的两个元素，扩容后中间隔了7个元素，从元素的起始地址上看就隔了8个元素，中间的7个都是空的，为了避免原来相邻的两个元素落到同一个缓存行中</span></span><br><span class="line"><span class="comment">//因为arena是对象数组，一个元素占8字节，8个就是64字节</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ASHIFT = <span class="number">7</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//arena数组元素的索引最大值即255</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MMASK = <span class="number">0xff</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//arena数组的最大长度即256</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SEQ = MMASK + <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//获取CPU核数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NCPU = Runtime.getRuntime().availableProcessors();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//实际的数组长度，因为是线程两两配对的，所以最大长度是核数除以2</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FULL = (NCPU &gt;= (MMASK &lt;&lt; <span class="number">1</span>)) ? MMASK : NCPU &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//自旋等待的次数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SPINS = <span class="number">1</span> &lt;&lt; <span class="number">10</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//如果交换的对象是null，则返回此对象</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object NULL_ITEM = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果等待超时导致交换失败，则返回此对象</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object TIMED_OUT = <span class="keyword">new</span> Object();</span><br></pre></td></tr></table></figure><h3 id="exchange-1"><a href="#exchange-1" class="headerlink" title="exchange"></a>exchange</h3><p>&emsp;&emsp;1.低并发下：<code>arena</code>未初始化的时候使用<strong>slotExchange</strong>进行了数据交换。<code>arena</code>初始化后或者<strong>slotExchange</strong>因为并发原因导致数据交互失败，那么采用<strong>arenaExchange</strong>进行数据交换。</p><p>&emsp;&emsp;2.针对传入的对象若是==null，那么针对入参与出参都会将其转换<strong>NULL_ITEM</strong>,主要为了区分交换失败。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">exchange</span><span class="params">(V x)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Object v;</span><br><span class="line">    Object item = (x == <span class="keyword">null</span>) ? NULL_ITEM : x; <span class="comment">// translate null args</span></span><br><span class="line">    <span class="keyword">if</span> ((arena != <span class="keyword">null</span> ||</span><br><span class="line">         <span class="comment">//arena为null的情形下执行slotExchange</span></span><br><span class="line">         (v = slotExchange(item, <span class="keyword">false</span>, <span class="number">0L</span>)) == <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">        <span class="comment">//若线程被打断则抛出异常</span></span><br><span class="line">        ((Thread.interrupted() || <span class="comment">// disambiguates null return</span></span><br><span class="line">          <span class="comment">//arenaExchange失败、因为没有设置超时时间，那么肯定线程已经被中断抛出异常</span></span><br><span class="line">          (v = arenaExchange(item, <span class="keyword">false</span>, <span class="number">0L</span>)) == <span class="keyword">null</span>)))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="keyword">return</span> (v == NULL_ITEM) ? <span class="keyword">null</span> : (V)v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//增加了等待的超时时间</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">exchange</span><span class="params">(V x, <span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException, TimeoutException </span>&#123;</span><br><span class="line">    Object v;</span><br><span class="line">    Object item = (x == <span class="keyword">null</span>) ? NULL_ITEM : x;</span><br><span class="line">    <span class="keyword">long</span> ns = unit.toNanos(timeout);</span><br><span class="line">    <span class="keyword">if</span> ((arena != <span class="keyword">null</span> ||</span><br><span class="line">         (v = slotExchange(item, <span class="keyword">true</span>, ns)) == <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">        ((Thread.interrupted() ||</span><br><span class="line">          (v = arenaExchange(item, <span class="keyword">true</span>, ns)) == <span class="keyword">null</span>)))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">//如果超时，那么抛出超时异常</span></span><br><span class="line">    <span class="keyword">if</span> (v == TIMED_OUT)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">    <span class="keyword">return</span> (v == NULL_ITEM) ? <span class="keyword">null</span> : (V)v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.<strong>slotExchange</strong>主要是使用<code>slot</code>去进行数据交换的</p><p>&emsp;&emsp;2.<code>slot</code>若是为null，当前线程则将<code>slot</code>修改为当前线程的<code>Node</code>，修改失败则进入下一次循环，进 入<code>slot</code>不为null。修改成功则进入自旋，达到一定的自旋次数后使当前线程休眠（超时特性也在这里进行了指定）。当线程被唤醒的时候都会去检测<code>Node</code>的<code>match</code>属性，不为null的时候表示数据交互成功，否则返回<strong>TIMED_OUT</strong>或者<strong>NULL</strong>，然后清除数据并且保存自旋的<strong>hash</strong>值。</p><p>&emsp;&emsp;3.<code>slot</code>若是不为null,当前线程企图将其修改为null。<strong>cas</strong>修改成功，表示当前线程的<code>slot</code>的属性匹配当前线程成功，保存数据，处理休眠状态的线程，交互流程结束。<strong>cas</strong>修改失败，说明有其他线程也在抢占<code>slot</code>，导致进入下一次循环，如果<code>arena</code>不为null，则进入<strong>arenaExchange</strong>执行数据交互。</p><p><img src="/image/hexo/image-20200712081638127.png" alt="image-20200712081638127"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *1.如果arena为null，则执行本方法</span></span><br><span class="line"><span class="comment"> *2.返回值为null则表示数据交换失败</span></span><br><span class="line"><span class="comment"> *3.item是交换的对象，timed：false表示不设置超时</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> Object <span class="title">slotExchange</span><span class="params">(Object item, <span class="keyword">boolean</span> timed, <span class="keyword">long</span> ns)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取当前线程所对应的Node</span></span><br><span class="line">    Node p = participant.get();</span><br><span class="line">    <span class="comment">//获取当前线程</span></span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    <span class="comment">//如果线程已经被打断了那么此次数据交换失败</span></span><br><span class="line">    <span class="keyword">if</span> (t.isInterrupted()) <span class="comment">// preserve interrupt status so caller can recheck</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">for</span> (Node q;;) &#123;</span><br><span class="line">        <span class="comment">//slot不为null</span></span><br><span class="line">        <span class="keyword">if</span> ((q = slot) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//slot设置为null，slot对应的线程与当前线程匹配成功</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, SLOT, q, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                Object v = q.item;</span><br><span class="line">                <span class="comment">//保存item数据、标识数据交互完成</span></span><br><span class="line">                q.match = item;</span><br><span class="line">                <span class="comment">//唤醒q对应的处于等待的线程</span></span><br><span class="line">                Thread w = q.parked;</span><br><span class="line">                <span class="keyword">if</span> (w != <span class="keyword">null</span>)</span><br><span class="line">                    U.unpark(w);</span><br><span class="line">                <span class="keyword">return</span> v;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//slot修改失败</span></span><br><span class="line">            <span class="comment">//多个线程同时调用了exchange方法</span></span><br><span class="line">            <span class="comment">//bound == 0表示为初始化，目的：避免重复进行初始化操作</span></span><br><span class="line">            <span class="keyword">if</span> (NCPU &gt; <span class="number">1</span> &amp;&amp; bound == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                <span class="comment">//BOUND修改成SEQ</span></span><br><span class="line">                U.compareAndSwapInt(<span class="keyword">this</span>, BOUND, <span class="number">0</span>, SEQ))</span><br><span class="line">                <span class="comment">//初始化：创建数组</span></span><br><span class="line">                <span class="comment">//下一次for循环就因为arena不为null，返回null了</span></span><br><span class="line">                arena = <span class="keyword">new</span> Node[(FULL + <span class="number">2</span>) &lt;&lt; ASHIFT];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (arena != <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//arena不为null，使用arenaExchange交换数据</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//slot、arena同时为null</span></span><br><span class="line">            p.item = item;</span><br><span class="line">            <span class="comment">//修改slot为p，修改成功则终止循环</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, SLOT, <span class="keyword">null</span>, p))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//修改失败则继续进行循环，将item恢复为null</span></span><br><span class="line">            p.item = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改slot为p成功后执行下面的逻辑,hash初始为0</span></span><br><span class="line">    <span class="keyword">int</span> h = p.hash;</span><br><span class="line">    <span class="keyword">long</span> end = timed ? System.nanoTime() + ns : <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">int</span> spins = (NCPU &gt; <span class="number">1</span>) ? SPINS : <span class="number">1</span>;</span><br><span class="line">    Object v;</span><br><span class="line">    <span class="comment">//match保存这同其他线程交换的对象，如果不为null,则表示数据交互成功</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//进入自旋</span></span><br><span class="line">    <span class="keyword">while</span> ((v = p.match) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (spins &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            h ^= h &lt;&lt; <span class="number">1</span>; h ^= h &gt;&gt;&gt; <span class="number">3</span>; h ^= h &lt;&lt; <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">if</span> (h == <span class="number">0</span>)</span><br><span class="line">                <span class="comment">//初始化h</span></span><br><span class="line">                h = SPINS | (<span class="keyword">int</span>)t.getId(); </span><br><span class="line">            <span class="comment">//只有h小于0才会减少spins</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (h &lt; <span class="number">0</span> &amp;&amp; (--spins &amp; ((SPINS &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>)) == <span class="number">0</span>)</span><br><span class="line">                Thread.yield();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果slot已经匹配到了其他线程（被修改），重新自旋，</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (slot != p)</span><br><span class="line">            spins = SPINS;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; arena == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                 <span class="comment">//线程没有被中断且arena为null</span></span><br><span class="line">                 <span class="comment">//需要等待</span></span><br><span class="line">                 (!timed || (ns = end - System.nanoTime()) &gt; <span class="number">0L</span>)) &#123;</span><br><span class="line">            U.putObject(t, BLOCKER, <span class="keyword">this</span>);</span><br><span class="line">            p.parked = t;</span><br><span class="line">            <span class="keyword">if</span> (slot == p)</span><br><span class="line">                U.park(<span class="keyword">false</span>, ns);</span><br><span class="line">            <span class="comment">//唤醒线程、执行下一次循环</span></span><br><span class="line">            </span><br><span class="line">            p.parked = <span class="keyword">null</span>;</span><br><span class="line">            U.putObject(t, BLOCKER, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//由于等待超时而被环境</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapObject(<span class="keyword">this</span>, SLOT, p, <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">//timed: false，无限等待，由于线程中断而返回null</span></span><br><span class="line">            <span class="comment">//timed: true,  超时被唤醒，返回TIMED_OUT,或者由于线程中断返回null</span></span><br><span class="line">            v = timed &amp;&amp; ns &lt;= <span class="number">0L</span> &amp;&amp; !t.isInterrupted() ? TIMED_OUT : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    U.putOrderedObject(p, MATCH, <span class="keyword">null</span>);</span><br><span class="line">    p.item = <span class="keyword">null</span>;</span><br><span class="line">    p.hash = h;</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.<strong>slotExchange</strong>主要采用<code>arena</code>去完成整个的数据交互的。</p><p>&emsp;&emsp;2.<code>m</code>与<code>index</code>的初始值为0，两者都是&gt;=0，并且i不能大于m。若是多个线程企图抢占<code>index</code>对应的数组元素<code>Node</code>均失败的情形下将<code>m</code>进行加1操作,抢占<code>m+1</code>对应的数组元素，将其修改为当前线程所关联的<code>Node</code>，进入自旋。</p><p>&emsp;&emsp;3.自旋结束匹配到线程，那么将<code>m+1</code>对应的数组元素重置为null,然后将<code>m-1</code>，再次进入循环继续抢占元素。若是达到极端情况，<code>m</code>会一直递增达到最大值<strong>FULL</strong>，然后随着并发的减少，<code>m</code>会随之减少到0，通过这种方式动态的去调整<code>m</code>去避免过多的线程基于<strong>CAS</strong>修改同一个元素而导致<strong>CAS</strong>失败，提高了匹配的效率。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//争夺slot失败</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> Object <span class="title">arenaExchange</span><span class="params">(Object item, <span class="keyword">boolean</span> timed, <span class="keyword">long</span> ns)</span> </span>&#123;</span><br><span class="line">    Node[] a = arena;</span><br><span class="line">    Node p = participant.get();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = p.index;;) &#123; <span class="comment">//index初始值为0</span></span><br><span class="line">        <span class="keyword">int</span> b, m, c; <span class="keyword">long</span> j;   </span><br><span class="line"><span class="comment">//创建arena</span></span><br><span class="line">        <span class="comment">//将本来的数组容量 &lt;&lt; ASHIFT，为了避免数组元素落到了同一个高速缓存行，这里获取真实的数组元素索引时也需要 &lt;&lt; ASHIFT</span></span><br><span class="line">        Node q = (Node)U.getObjectVolatile(a, j = (i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">        <span class="comment">////如果q不为null，则将对应的数组元素置为null，表示当前线程和该元素对应的线程匹配了</span></span><br><span class="line">        <span class="keyword">if</span> (q != <span class="keyword">null</span> &amp;&amp; U.compareAndSwapObject(a, j, q, <span class="keyword">null</span>)) &#123;</span><br><span class="line">            Object v = q.item;</span><br><span class="line">            <span class="comment">//保存item</span></span><br><span class="line">            q.match = item;</span><br><span class="line">            <span class="comment">//唤醒等待的线程</span></span><br><span class="line">            Thread w = q.parked;</span><br><span class="line">            <span class="keyword">if</span> (w != <span class="keyword">null</span>)</span><br><span class="line">                U.unpark(w);</span><br><span class="line">            <span class="comment">//数据交互完成</span></span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//q==null || cas失败</span></span><br><span class="line">        <span class="comment">//bound初始化时是SEQ，SEQ &amp; MMASK就是0，即m的初始值就是0，m为0时，i肯定为0</span></span><br><span class="line">        <span class="comment">//q为null，该数组元素未被占用,注意上面的cas会将数组元素置为null，下一次for循环q变成nul</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (i &lt;= (m = (b = bound) &amp; MMASK) &amp;&amp; q == <span class="keyword">null</span>) &#123;</span><br><span class="line">            p.item = item;     </span><br><span class="line">            <span class="comment">//对应的数组元素修改为p</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapObject(a, j, <span class="keyword">null</span>, p)) &#123;</span><br><span class="line">                <span class="comment">//如果timed为true且m等于0的情形下才会等待指定的时间，否则是无期限等待</span></span><br><span class="line">                <span class="keyword">long</span> end = (timed &amp;&amp; m == <span class="number">0</span>) ? System.nanoTime() + ns : <span class="number">0L</span>;</span><br><span class="line">                Thread t = Thread.currentThread(); <span class="comment">// wait</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> h = p.hash, spins = SPINS;;) &#123;</span><br><span class="line">                    Object v = p.match;</span><br><span class="line">                    <span class="comment">//已经跟某个线程交换成功</span></span><br><span class="line">                    <span class="keyword">if</span> (v != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//MATCH、item置为null，方便下次使用</span></span><br><span class="line">                        U.putOrderedObject(p, MATCH, <span class="keyword">null</span>);</span><br><span class="line">                        p.item = <span class="keyword">null</span>;             <span class="comment">// clear for next use</span></span><br><span class="line">                        <span class="comment">//保存hash、便于下次自旋操作</span></span><br><span class="line">                        p.hash = h;</span><br><span class="line">                        <span class="keyword">return</span> v;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (spins &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//进入自旋</span></span><br><span class="line">                        h ^= h &lt;&lt; <span class="number">1</span>; h ^= h &gt;&gt;&gt; <span class="number">3</span>; h ^= h &lt;&lt; <span class="number">10</span>; <span class="comment">// xorshift</span></span><br><span class="line">                        <span class="keyword">if</span> (h == <span class="number">0</span>)                <span class="comment">// initialize hash</span></span><br><span class="line">                            h = SPINS | (<span class="keyword">int</span>)t.getId();</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (h &lt; <span class="number">0</span> &amp;&amp;          <span class="comment">// approx 50% true</span></span><br><span class="line">                                 (--spins &amp; ((SPINS &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>)) == <span class="number">0</span>)</span><br><span class="line">                            Thread.yield();        <span class="comment">// two yields per wait</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//索引j处的数组元素发生变更</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (U.getObjectVolatile(a, j) != p)</span><br><span class="line">                        spins = SPINS;       <span class="comment">// releaser hasn't set match yet</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; m == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                             <span class="comment">//只有m等于0才会进入此分支让线程阻塞</span></span><br><span class="line">                             (!timed ||</span><br><span class="line">                              <span class="comment">//超时时间限制陷入等待</span></span><br><span class="line">                              (ns = end - System.nanoTime()) &gt; <span class="number">0L</span>)) &#123;</span><br><span class="line">                        U.putObject(t, BLOCKER, <span class="keyword">this</span>); <span class="comment">// emulate LockSupport</span></span><br><span class="line">                        p.parked = t;              <span class="comment">// minimize window</span></span><br><span class="line">                        <span class="comment">//再校验一遍，j处的数组元素未发生变更</span></span><br><span class="line">                        <span class="keyword">if</span> (U.getObjectVolatile(a, j) == p)</span><br><span class="line">                            <span class="comment">//线程休眠指定时间</span></span><br><span class="line">                            U.park(<span class="keyword">false</span>, ns);</span><br><span class="line">                        <span class="comment">//线程唤醒：中断或者超时</span></span><br><span class="line">                        p.parked = <span class="keyword">null</span>;</span><br><span class="line">                        U.putObject(t, BLOCKER, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//线程被中断或者等待超时或者m!=0</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (U.getObjectVolatile(a, j) == p &amp;&amp;</span><br><span class="line">                             <span class="comment">//j索引位置的元素没有发生改变将其设置为null</span></span><br><span class="line">                             U.compareAndSwapObject(a, j, p, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (m != <span class="number">0</span>)                <span class="comment">// try to shrink</span></span><br><span class="line">                            <span class="comment">//修改BOUND,下一次跟MMASK求且的结果会减1，此时可能导致i大于m</span></span><br><span class="line">                            U.compareAndSwapInt(<span class="keyword">this</span>, BOUND, b, b + SEQ - <span class="number">1</span>);</span><br><span class="line">                        p.item = <span class="keyword">null</span>;</span><br><span class="line">                        p.hash = h;</span><br><span class="line">                        <span class="comment">//索引右移一位</span></span><br><span class="line">                        i = p.index &gt;&gt;&gt;= <span class="number">1</span>;        <span class="comment">// descend</span></span><br><span class="line">                        <span class="comment">//线程若是中断则返回null</span></span><br><span class="line">                        <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">if</span> (timed &amp;&amp; m == <span class="number">0</span> &amp;&amp; ns &lt;= <span class="number">0L</span>)</span><br><span class="line">                            <span class="keyword">return</span> TIMED_OUT;</span><br><span class="line">                        <span class="comment">//m！=0,继续自旋</span></span><br><span class="line">                        <span class="keyword">break</span>;                     <span class="comment">// expired; restart</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">//数组元素修改失败，继续重试</span></span><br><span class="line">                <span class="comment">//q不为null，与该元素对应的线程匹配成功</span></span><br><span class="line">                p.item = <span class="keyword">null</span>;                     <span class="comment">// clear offer</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//i&gt;m 或者q不为null，cas抢占q失败了 会进入此分支 </span></span><br><span class="line">            <span class="comment">//bound的初始值也是0</span></span><br><span class="line">            <span class="keyword">if</span> (p.bound != b) &#123;                    </span><br><span class="line">                <span class="comment">//重置bound、collides</span></span><br><span class="line">                p.bound = b; </span><br><span class="line">                p.collides = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">//如果i等于m且m不等于0，则i=m-1,否则i=m</span></span><br><span class="line">                i = (i != m || m == <span class="number">0</span>) ? m : m - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//BOUND修改为b</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((c = p.collides) &lt; m || m == FULL ||</span><br><span class="line">                     !U.compareAndSwapInt(<span class="keyword">this</span>, BOUND, b, b + SEQ + <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">//如果m小于FULL，会尝试最多m次，即进入下面的逻辑最多m次，如果还失败则增加m，然后继续尝试直到m等于FUll为止 </span></span><br><span class="line">                <span class="comment">//计数器+1</span></span><br><span class="line">                p.collides = c + <span class="number">1</span>;</span><br><span class="line">                <span class="comment">//i不等于0的时候，i等于i减1，等于0则i等于m，即循环的从m往后遍历arena数组的元素了</span></span><br><span class="line">                i = (i == <span class="number">0</span>) ? m : i - <span class="number">1</span>;          <span class="comment">// cyclically traverse</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//上一个else if三个条件都为false，即p.collides &gt;m 且m不等于FULL且cas 修改bound成功</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">//修改bound成功会导致下一次计算m时，m加1，此处i等于m+1，下一次for循环i等于m，会抢占m+1对应的rena数组的元素</span></span><br><span class="line">                i = m + <span class="number">1</span>;    </span><br><span class="line">            <span class="comment">//重置索引</span></span><br><span class="line">            p.index = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-45-CyclicBarrier详解</title>
      <link href="/2020/07/11/27417/hub/"/>
      <url>/2020/07/11/27417/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200711202301272.png" alt="image-20200711202301272"></p><h2 id="CyclicBarrier相关API"><a href="#CyclicBarrier相关API" class="headerlink" title="CyclicBarrier相关API"></a>CyclicBarrier相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrier</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.任务数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.任务数</span></span><br><span class="line"><span class="comment"> * 2.任务所有执行完毕的一个回调函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CyclicBarrier cyclicBarrier2 = <span class="keyword">new</span> CyclicBarrier(<span class="number">2</span>,()-&gt;&#123;</span><br><span class="line">    System.out.println(<span class="string">"我是一个执行完毕的回调函数！"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="await"><a href="#await" class="headerlink" title="await"></a>await</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//await</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.等待所有任务执行结束</span></span><br><span class="line"><span class="comment"> * 2.线程到达之后，会在条件上等待，直到最后一个线程到达，最后一个线程到达时会执行command</span></span><br><span class="line"><span class="comment"> * 3.可以使用携带超时时间的await</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">cyclicBarrier.await();</span><br><span class="line">cyclicBarrier.await(<span class="number">1</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><h4 id="getNumberWaiting"><a href="#getNumberWaiting" class="headerlink" title="getNumberWaiting"></a>getNumberWaiting</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getNumberWaiting</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取已到达等待线程数量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(cyclicBarrier.getNumberWaiting());</span><br></pre></td></tr></table></figure><h4 id="getParties"><a href="#getParties" class="headerlink" title="getParties"></a>getParties</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getParties</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取需要等待的线程数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(cyclicBarrier.getParties());</span><br></pre></td></tr></table></figure><h4 id="isBroken"><a href="#isBroken" class="headerlink" title="isBroken"></a>isBroken</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isBroken</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.栅栏是否已被破解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(cyclicBarrier.isBroken());</span><br></pre></td></tr></table></figure><h4 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//reset</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.重置栅栏数据和状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">cyclicBarrier.reset();</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="await-1"><a href="#await-1" class="headerlink" title="await"></a>await</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//等待所有任务执行结束</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dowait(<span class="keyword">false</span>, <span class="number">0L</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TimeoutException toe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(toe); <span class="comment">// cannot happen</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//等待所有任务执行结束、具有超时特性</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException,</span></span><br><span class="line"><span class="function">           BrokenBarrierException,</span></span><br><span class="line"><span class="function">           TimeoutException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dowait(<span class="keyword">true</span>, unit.toNanos(timeout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">dowait</span><span class="params">(<span class="keyword">boolean</span> timed, <span class="keyword">long</span> nanos)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException, BrokenBarrierException,</span></span><br><span class="line"><span class="function">           TimeoutException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Generation g = generation;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断当前栅栏是否被打破、抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (g.broken)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BrokenBarrierException();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//线程被打断、抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="comment">//破坏栅栏</span></span><br><span class="line">            breakBarrier();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//计算当前线程达到后、剩余的线程数</span></span><br><span class="line">        <span class="keyword">int</span> index = --count;</span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;  <span class="comment">// tripped</span></span><br><span class="line">            <span class="keyword">boolean</span> ranAction = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//如果是最后一个线程进入，那么执行command操作</span></span><br><span class="line">                <span class="keyword">final</span> Runnable command = barrierCommand;</span><br><span class="line">                <span class="keyword">if</span> (command != <span class="keyword">null</span>)</span><br><span class="line">                    command.run();</span><br><span class="line">                ranAction = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">//产生新的一代、唤醒等待的线程</span></span><br><span class="line">                <span class="comment">//重置count、parties</span></span><br><span class="line">                nextGeneration();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//command执行失败、打破栅栏</span></span><br><span class="line">                <span class="keyword">if</span> (!ranAction)</span><br><span class="line">                    breakBarrier();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//进入自旋状态</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//判断线程是否超时、中断</span></span><br><span class="line">                <span class="keyword">if</span> (!timed)</span><br><span class="line">                    trip.await();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; <span class="number">0L</span>)</span><br><span class="line">                    nanos = trip.awaitNanos(nanos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                <span class="keyword">if</span> (g == generation &amp;&amp; ! g.broken) &#123;</span><br><span class="line">                    breakBarrier();</span><br><span class="line">                    <span class="keyword">throw</span> ie;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// We're about to finish waiting even if we had not</span></span><br><span class="line">                    <span class="comment">// been interrupted, so this interrupt is deemed to</span></span><br><span class="line">                    <span class="comment">// "belong" to subsequent execution.</span></span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//打破栅栏、抛出异常</span></span><br><span class="line">            <span class="keyword">if</span> (g.broken)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BrokenBarrierException();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (g != generation)</span><br><span class="line">                <span class="keyword">return</span> index;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//线程超时、打破栅栏、抛出异常</span></span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                breakBarrier();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *1.生成新的一代</span></span><br><span class="line"><span class="comment"> *2.唤醒所有等待的线程</span></span><br><span class="line"><span class="comment"> *3.重置count、parties</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">nextGeneration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// signal completion of last generation</span></span><br><span class="line">    trip.signalAll();</span><br><span class="line">    <span class="comment">// set up next generation</span></span><br><span class="line">    count = parties;</span><br><span class="line">    generation = <span class="keyword">new</span> Generation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 打破栅栏</span></span><br><span class="line"><span class="comment"> * 1、generation.broker = true标识栅栏已经被打破</span></span><br><span class="line"><span class="comment"> * 2、重置count到parties</span></span><br><span class="line"><span class="comment"> * 3、唤醒所有等待的线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">breakBarrier</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    generation.broken = <span class="keyword">true</span>;</span><br><span class="line">    count = parties;</span><br><span class="line">    trip.signalAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="reset-1"><a href="#reset-1" class="headerlink" title="reset"></a>reset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *1.重置count、parties</span></span><br><span class="line"><span class="comment"> *2.打破栅栏</span></span><br><span class="line"><span class="comment"> *3.生成新的一代</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        breakBarrier();   <span class="comment">// break the current generation</span></span><br><span class="line">        nextGeneration(); <span class="comment">// start a new generation</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="成员属性"><a href="#成员属性" class="headerlink" title="成员属性"></a>成员属性</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//锁</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="comment">// 当有线程到达时，如果count不能减到1，线程将会在该条件上等待</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition trip = lock.newCondition();</span><br><span class="line"><span class="comment">// 总共需要等待的线程数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> parties;</span><br><span class="line"><span class="comment">// 所有等待线程都到达时执行该命令</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable barrierCommand;</span><br><span class="line"><span class="comment">/** The current generation */</span></span><br><span class="line"><span class="keyword">private</span> Generation generation = <span class="keyword">new</span> Generation();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 还需要等待的线程。初始值为总共需要等待的线程，当新产生一代或者栅栏被打破，count重置为parties</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> count;</span><br></pre></td></tr></table></figure><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            System.out.println(<span class="string">"T1 work finish."</span>);</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">"T1"</span>).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">15000</span>);</span><br><span class="line">            System.out.println(<span class="string">"T2 work finish."</span>);</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">"T2"</span>).start();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span> <span class="keyword">throws</span> BrokenBarrierException, InterruptedException </span>&#123;</span><br><span class="line">    CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            System.out.println(<span class="string">"T1 work finish."</span>);</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">"T1"</span>).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">15000</span>);</span><br><span class="line">            System.out.println(<span class="string">"T2 work finish."</span>);</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">"T2"</span>).start();</span><br><span class="line"></span><br><span class="line">    cyclicBarrier.await();</span><br><span class="line">    System.out.println(<span class="string">"All work finish."</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CyclicBarrier-amp-CountDownLatch"><a href="#CyclicBarrier-amp-CountDownLatch" class="headerlink" title="CyclicBarrier &amp; CountDownLatch"></a>CyclicBarrier &amp; CountDownLatch</h2><p>&emsp;&emsp;1.<strong>CountDownLatch</strong>基于<strong>AQS</strong>,CyclicBarrier基于<strong>ReentrantLock</strong>。</p><p>&emsp;&emsp;2.<strong>CyclicBarrier</strong>支持复用(<strong>reset</strong>)和<code>barrierCommand</code>，但是<strong>CountDownLatch</strong>不支持。</p><p>&emsp;&emsp;3.<strong>CyclicBarrier</strong>会阻塞线程，在最后一个线程执行完毕之前其余的线程都必须陷入等待(工作线程之间互不影响，等到达到同一个点才会去执行某个特定的操作)，而<strong>CountDownLatch</strong>在<strong>countDown</strong>不会阻塞线程。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-44-CountDownLatch详解</title>
      <link href="/2020/07/10/56426/hub/"/>
      <url>/2020/07/10/56426/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200710200228636.png" alt="image-20200710200228636"></p><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="案例一（任务完全并行化）"><a href="#案例一（任务完全并行化）" class="headerlink" title="案例一（任务完全并行化）"></a>案例一（任务完全并行化）</h3><p>&emsp;&emsp;使用<strong>CountDownLatch</strong>去执行任务，等待所有任务执行完毕然后释放资源。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        test01();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ExecutorService executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//1.获取数据</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] data = query();</span><br><span class="line">        <span class="comment">//2.执行任务</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">            executor.execute(<span class="keyword">new</span> SimpleRunnable(data, i, latch));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.等待任务结束</span></span><br><span class="line">        latch.await();</span><br><span class="line">        System.out.println(<span class="string">"all of finish down."</span>);</span><br><span class="line">        <span class="comment">//4.关闭线程池</span></span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="comment">//数据data</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>[] data;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//访问的数据索引位置</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//countDown</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch countDownLatch;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SimpleRunnable</span><span class="params">(<span class="keyword">int</span>[] data, <span class="keyword">int</span> index, CountDownLatch countDownLatch)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.data = data;</span><br><span class="line">            <span class="keyword">this</span>.index = index;</span><br><span class="line">            <span class="keyword">this</span>.countDownLatch = countDownLatch;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(random.nextInt(<span class="number">2000</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//任务执行单元</span></span><br><span class="line">            <span class="keyword">int</span> value = data[index];</span><br><span class="line">            <span class="keyword">if</span> (value % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                data[index] = value * <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                data[index] = value * <span class="number">10</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//latch关闭</span></span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" finish down."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据查询</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span>[] query() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="案例二（多任务半并行化）"><a href="#案例二（多任务半并行化）" class="headerlink" title="案例二（多任务半并行化）"></a>案例二（多任务半并行化）</h3><p>&emsp;&emsp;在多个线程串行化的时候，发现前半部分逻辑可以并行化去实现，但是某线程可能后半部分需要串行化处理。那么也可以采用<strong>CountDownLatch</strong>去实现，例如一个完整的任务串行化的时间是3分钟，而前半部分采用了并行化，它整体所需的时间缩减了一分钟，那么在大量任务执行的情况下，这一分钟的时间也是不可忽略的，在一定程度上提升执行效率。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启一个线程执行某些前置操作</span></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//前置操作</span></span><br><span class="line">                System.out.println(<span class="string">"Do some initial working."</span>);</span><br><span class="line">                <span class="comment">//执行完毕发现提交不满足需要其他条件那么此时进入等待</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    countDownLatch.await();</span><br><span class="line">                    <span class="comment">//等待结束继续执行</span></span><br><span class="line">                    System.out.println(<span class="string">"Do other working..."</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//另一个线程也可以并行的执行前置操作但是上面一个线程需要当前线程的一些条件</span></span><br><span class="line">        <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//执行前置条件</span></span><br><span class="line">                System.out.println(<span class="string">"asyn prepare for some data."</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//最终条件满足，使得另一个等待的线程再次唤醒执行任务</span></span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">        </span><br><span class="line">        Thread.currentThread().join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;尝试开启多个<strong>wait</strong>任务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启一个线程执行某些前置操作</span></span><br><span class="line"><span class="keyword">new</span> Thread() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//前置操作</span></span><br><span class="line">        System.out.println(<span class="string">"Do some initial working."</span>);</span><br><span class="line">        <span class="comment">//执行完毕发现提交不满足需要其他条件那么此时进入等待</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">            <span class="comment">//等待结束继续执行</span></span><br><span class="line">            System.out.println(<span class="string">"Do other working..."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//开启一个线程执行某些前置操作</span></span><br><span class="line"><span class="keyword">new</span> Thread() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//前置操作</span></span><br><span class="line">        System.out.println(<span class="string">"Do some initial working."</span>);</span><br><span class="line">        <span class="comment">//执行完毕发现提交不满足需要其他条件那么此时进入等待</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">            <span class="comment">//等待结束继续执行</span></span><br><span class="line">            System.out.println(<span class="string">"Do other working..."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.start();</span><br></pre></td></tr></table></figure><h3 id="案例三（离散平行任务逻辑化）"><a href="#案例三（离散平行任务逻辑化）" class="headerlink" title="案例三（离散平行任务逻辑化）"></a>案例三（离散平行任务逻辑化）</h3><p>&emsp;&emsp;针对大量的离散任务，并且需要并行化处理也可以使用<strong>CountDownLatch</strong>去完成。</p><h4 id="初始版本"><a href="#初始版本" class="headerlink" title="初始版本"></a>初始版本</h4><h5 id="定义Event"><a href="#定义Event" class="headerlink" title="定义Event"></a>定义Event</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="定义数据Table"><a href="#定义数据Table" class="headerlink" title="定义数据Table"></a>定义数据Table</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Table</span></span>&#123;</span><br><span class="line">    String tableName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> sourceRecordCount = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> targetCount;</span><br><span class="line"></span><br><span class="line">    String sourceColumnSchema = <span class="string">"&lt;table name='a'&gt;&lt;column name='coll' type='varchar2'&gt;&lt;/column&gt;&lt;/table&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    String targetColumnSchema = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Table</span><span class="params">(String tableName, <span class="keyword">long</span> sourceRecordCount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.tableName = tableName;</span><br><span class="line">        <span class="keyword">this</span>.sourceRecordCount = sourceRecordCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Event换取Table数据"><a href="#Event换取Table数据" class="headerlink" title="Event换取Table数据"></a>Event换取Table数据</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Table&gt; <span class="title">capture</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">    List&lt;Table&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        list.add(<span class="keyword">new</span> Table(<span class="string">"T-"</span> + event.id + <span class="string">"-"</span> + i, i * <span class="number">1000</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="定义任务Runnable"><a href="#定义任务Runnable" class="headerlink" title="定义任务Runnable"></a>定义任务Runnable</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TrustSourceRecordCount</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Table table;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrustSourceRecordCount</span><span class="params">(Table table)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.table = table;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        table.sourceRecordCount = table.sourceRecordCount;</span><br><span class="line">        System.out.println(<span class="string">"The Table :"</span> + table.tableName + <span class="string">" target record capture down."</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TrustSourceColumnCount</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Table table;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrustSourceColumnCount</span><span class="params">(Table table)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.table = table;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        table.targetCount = table.targetCount;</span><br><span class="line">        System.out.println(<span class="string">"The Table :"</span> + table.tableName + <span class="string">" target columns capture down."</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    List&lt;Event&gt; events = Arrays.asList(<span class="keyword">new</span> Event(<span class="number">1</span>), <span class="keyword">new</span> Event(<span class="number">2</span>));</span><br><span class="line">    events.forEach(e-&gt;&#123;</span><br><span class="line">        List&lt;Table&gt; tables = capture(e);</span><br><span class="line">        tables.forEach(table-&gt;&#123;</span><br><span class="line">            TrustSourceRecordCount trustSourceRecordCount = <span class="keyword">new</span> TrustSourceRecordCount(table);</span><br><span class="line">            TrustSourceColumnCount trustSourceColumnCount = <span class="keyword">new</span> TrustSourceColumnCount(table);</span><br><span class="line">            executorService.execute(trustSourceRecordCount);</span><br><span class="line">            executorService.execute(trustSourceColumnCount);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;不过上述程序表现的很零散，其实并不知道一个<strong>Table</strong>的执行情况。</p><h4 id="Table优化演进"><a href="#Table优化演进" class="headerlink" title="Table优化演进"></a>Table优化演进</h4><h5 id="Watcher接口定义"><a href="#Watcher接口定义" class="headerlink" title="Watcher接口定义"></a>Watcher接口定义</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">down</span><span class="params">(Table table)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="TaskBatch任务实现"><a href="#TaskBatch任务实现" class="headerlink" title="TaskBatch任务实现"></a>TaskBatch任务实现</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskBatch</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CountDownLatch latch;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TaskBatch</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.latch = <span class="keyword">new</span> CountDownLatch(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">down</span><span class="params">(Table table)</span> </span>&#123;</span><br><span class="line">        latch.countDown();</span><br><span class="line">        <span class="keyword">if</span> (latch.getCount() == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"The table :"</span> + table.tableName + <span class="string">" finish down. table:"</span> + table);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="改造任务"><a href="#改造任务" class="headerlink" title="改造任务"></a>改造任务</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TrustSourceRecordCount</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Table table;</span><br><span class="line">    <span class="keyword">private</span> TaskBatch taskBatch;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrustSourceRecordCount</span><span class="params">(Table table,TaskBatch taskBatch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.table = table;</span><br><span class="line">        <span class="keyword">this</span>.taskBatch = taskBatch;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        table.sourceRecordCount = table.sourceRecordCount;</span><br><span class="line">        taskBatch.down(table);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TrustSourceColumnCount</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Table table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TaskBatch taskBatch;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrustSourceColumnCount</span><span class="params">(Table table,TaskBatch taskBatch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.table = table;</span><br><span class="line">        <span class="keyword">this</span>.taskBatch = taskBatch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        table.targetCount = table.targetCount;</span><br><span class="line">        taskBatch.down(table);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="修改任务封装"><a href="#修改任务封装" class="headerlink" title="修改任务封装"></a>修改任务封装</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    List&lt;Event&gt; events = Arrays.asList(<span class="keyword">new</span> Event(<span class="number">1</span>), <span class="keyword">new</span> Event(<span class="number">2</span>));</span><br><span class="line">    events.forEach(e-&gt;&#123;</span><br><span class="line">        List&lt;Table&gt; tables = capture(e);</span><br><span class="line">        tables.forEach(table-&gt;&#123;</span><br><span class="line">            TaskBatch taskBatch = <span class="keyword">new</span> TaskBatch(<span class="number">2</span>);</span><br><span class="line">            TrustSourceRecordCount trustSourceRecordCount = <span class="keyword">new</span> TrustSourceRecordCount(table,taskBatch);</span><br><span class="line">            TrustSourceColumnCount trustSourceColumnCount = <span class="keyword">new</span> TrustSourceColumnCount(table, taskBatch);</span><br><span class="line">            executorService.execute(trustSourceRecordCount);</span><br><span class="line">            executorService.execute(trustSourceColumnCount);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;通过改造可以发现<strong>Table</strong>的任务更加具有逻辑，但是针对<strong>Event</strong>来说，多个<strong>Table</strong>的执行还是未知的，那么<strong>Event</strong>也可以通过类似的改造来实现。</p><h4 id="Event优化演进"><a href="#Event优化演进" class="headerlink" title="Event优化演进"></a>Event优化演进</h4><h5 id="增加TaskGroup"><a href="#增加TaskGroup" class="headerlink" title="增加TaskGroup"></a>增加TaskGroup</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskGroup</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CountDownLatch latch;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Event event;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TaskGroup</span><span class="params">(<span class="keyword">int</span> size,Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.event = event;</span><br><span class="line">        <span class="keyword">this</span>.latch = <span class="keyword">new</span> CountDownLatch(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">down</span><span class="params">(Table table)</span> </span>&#123;</span><br><span class="line">        latch.countDown();</span><br><span class="line">        <span class="keyword">if</span> (latch.getCount() == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"The event :"</span> + event.id + <span class="string">" finish down."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="改造TaskBatch"><a href="#改造TaskBatch" class="headerlink" title="改造TaskBatch"></a>改造TaskBatch</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskBatch</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CountDownLatch latch;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TaskGroup taskGroup;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TaskBatch</span><span class="params">(<span class="keyword">int</span> size,TaskGroup taskGroup)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.taskGroup = taskGroup;</span><br><span class="line">        <span class="keyword">this</span>.latch = <span class="keyword">new</span> CountDownLatch(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">down</span><span class="params">(Table table)</span> </span>&#123;</span><br><span class="line">        latch.countDown();</span><br><span class="line">        <span class="keyword">if</span> (latch.getCount() == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">// System.out.println("The table :" + table.tableName + " finish down. table:" + table);</span></span><br><span class="line">            taskGroup.down(table);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="再次运行"><a href="#再次运行" class="headerlink" title="再次运行"></a>再次运行</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    List&lt;Event&gt; events = Arrays.asList(<span class="keyword">new</span> Event(<span class="number">1</span>), <span class="keyword">new</span> Event(<span class="number">2</span>));</span><br><span class="line">    events.forEach(e-&gt;&#123;</span><br><span class="line">        List&lt;Table&gt; tables = capture(e);</span><br><span class="line">        TaskGroup taskGroup = <span class="keyword">new</span> TaskGroup(tables.size(), e);</span><br><span class="line">        tables.forEach(table-&gt;&#123;</span><br><span class="line">            TaskBatch taskBatch = <span class="keyword">new</span> TaskBatch(<span class="number">2</span>,taskGroup);</span><br><span class="line">            TrustSourceRecordCount trustSourceRecordCount = <span class="keyword">new</span> TrustSourceRecordCount(table,taskBatch);</span><br><span class="line">            TrustSourceColumnCount trustSourceColumnCount = <span class="keyword">new</span> TrustSourceColumnCount(table, taskBatch);</span><br><span class="line">            executorService.execute(trustSourceRecordCount);</span><br><span class="line">            executorService.execute(trustSourceColumnCount);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;通过对<strong>Event</strong>的封装，我们可以将一条零散分布的业务进行逻辑化处理，有效的利用了<strong>CountDownLatch</strong>。</p><h2 id="CountDownLatch相关API"><a href="#CountDownLatch相关API" class="headerlink" title="CountDownLatch相关API"></a>CountDownLatch相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatch</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CountDownLatch</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"count &lt; 0"</span>);</span><br><span class="line">    <span class="keyword">this</span>.sync = <span class="keyword">new</span> Sync(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h3 id="await"><a href="#await" class="headerlink" title="await"></a>await</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//await</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.陷入等待</span></span><br><span class="line"><span class="comment"> * 2.new CountDownLatch(1) 中的count==0才会释放</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">latch.await();</span><br><span class="line"></span><br><span class="line"><span class="comment">//await</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.陷入等待、并且设置等待超时时间</span></span><br><span class="line"><span class="comment"> * 2.new CountDownLatch(1) 中的count==0才会释放</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">latch.await(<span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><h3 id="countDown"><a href="#countDown" class="headerlink" title="countDown"></a>countDown</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//countDown</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.释放count</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">latch.countDown();</span><br></pre></td></tr></table></figure><h3 id="count"><a href="#count" class="headerlink" title="count"></a>count</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//count</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取当前还存在的count</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">latch.getCount();</span><br></pre></td></tr></table></figure><h2 id="CountDownLatch部分源码解析"><a href="#CountDownLatch部分源码解析" class="headerlink" title="CountDownLatch部分源码解析"></a>CountDownLatch部分源码解析</h2><h3 id="countDown-1"><a href="#countDown-1" class="headerlink" title="countDown"></a>countDown</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4982264981922014374L</span>;</span><br><span class="line"></span><br><span class="line">  Sync(<span class="keyword">int</span> count) &#123;</span><br><span class="line">    setState(count);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (getState() == <span class="number">0</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//对state进行原子性的减一操作  </span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="keyword">int</span> c = getState();   <span class="comment">// 获取当前state属性的值</span></span><br><span class="line">      <span class="keyword">if</span> (c == <span class="number">0</span>)   <span class="comment">// 如果state为0，则说明当前计数器已经计数完成，直接返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">int</span> nextc = c-<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (compareAndSetState(c, nextc)) <span class="comment">// 使用CAS算法对state进行设置</span></span><br><span class="line">        <span class="keyword">return</span> nextc == <span class="number">0</span>;  <span class="comment">// 设置成功后返回当前是否为最后一个设置state的线程</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;<span class="comment">//主要使用最快失败进行了CAS操作</span></span><br><span class="line">    doReleaseShared();<span class="comment">//唤醒多个await的线程</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReleaseShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    Node h = head;  <span class="comment">// 记录等待队列中的头结点的线程</span></span><br><span class="line">    <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h != tail) &#123;   <span class="comment">// 头结点不为空，且头结点不等于尾节点</span></span><br><span class="line">      <span class="keyword">int</span> ws = h.waitStatus;</span><br><span class="line">      <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;  <span class="comment">// SIGNAL状态表示当前节点正在等待被唤醒</span></span><br><span class="line">        <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))    <span class="comment">// 清除当前节点的等待状态</span></span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        unparkSuccessor(h); <span class="comment">// 唤醒当前节点的下一个节点</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp; !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (h == head)  <span class="comment">// 如果h还是指向头结点，说明前面这段代码执行过程中没有其他线程对头结点进行过处理</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">  <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">    compareAndSetWaitStatus(node, ws, <span class="number">0</span>);   <span class="comment">// 清除当前节点的等待状态</span></span><br><span class="line"></span><br><span class="line">  Node s = node.next;</span><br><span class="line">  <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;  <span class="comment">// s的等待状态大于0说明该节点中的线程已经被外部取消等待了</span></span><br><span class="line">    s = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 从队列尾部往前遍历，找到最后一个处于等待状态的节点，用s记录下来</span></span><br><span class="line">    <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">      <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">        s = t;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">    LockSupport.unpark(s.thread);   <span class="comment">// 唤醒离传入节点最近的处于等待状态的节点线程</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="await-1"><a href="#await-1" class="headerlink" title="await"></a>await</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.tryAcquireSharedNanos(<span class="number">1</span>, unit.toNanos(timeout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">  <span class="comment">//判断当前线程是否需要以共享状态去获取执行权，</span></span><br><span class="line">  <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">     <span class="comment">//其主要是判断state是否为零，如果为零则返回1，表示当前线程不需要进行权限获取，可直接执行后续代码，返回-1则表示当前线程需要进行共享权限</span></span><br><span class="line">    doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Node node = addWaiter(Node.SHARED); <span class="comment">// 使用当前线程创建一个共享模式的节点</span></span><br><span class="line">  <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="keyword">final</span> Node p = node.predecessor();    <span class="comment">// 获取当前节点的前一个节点</span></span><br><span class="line">      <span class="keyword">if</span> (p == head) &#123;  <span class="comment">// 判断前一个节点是否为头结点</span></span><br><span class="line">        <span class="keyword">int</span> r = tryAcquireShared(arg);  <span class="comment">// 查看当前线程是否获取到了执行权限</span></span><br><span class="line">        <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;   <span class="comment">// 大于0表示获取了执行权限</span></span><br><span class="line">          setHeadAndPropagate(node, r); <span class="comment">// 将当前节点设置为头结点，并且唤醒后面处于等待状态的节点</span></span><br><span class="line">          p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">          failed = <span class="keyword">false</span>;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">     </span><br><span class="line">      <span class="comment">// 走到这一步说明没有获取到执行权限，就使当前线程进入“搁置”状态</span></span><br><span class="line">      <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">          parkAndCheckInterrupt())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (failed)</span><br><span class="line">      cancelAcquire(node);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setHeadAndPropagate</span><span class="params">(Node node, <span class="keyword">int</span> propagate)</span> </span>&#123;</span><br><span class="line">  Node h = head;</span><br><span class="line">  setHead(node);    <span class="comment">// 将当前节点设置为头节点</span></span><br><span class="line">  <span class="comment">// 检查唤醒过程是否需要往下传递，并且检查头结点的等待状态</span></span><br><span class="line">  <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">      (h = head) == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.isShared())  <span class="comment">// 如果下一个节点是尝试以共享状态获取获取执行权限的节点，则将其唤醒</span></span><br><span class="line">      doReleaseShared();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>state</strong>并不是原子的，而state是int类型的变量，正好32位，因而对state变量的读取和赋值操作都是原子的。<br>在JDK源码里大量用到了这两个特性，组合之后就会有一个CAS算法，主要还是通过<strong>Unsafe</strong>的一系列<strong>compareAndSet()</strong>方法去实现的原子性。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-43-Unsafe详解</title>
      <link href="/2020/07/08/45501/hub/"/>
      <url>/2020/07/08/45501/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200708164035247.png" alt="image-20200708164035247"></p><h2 id="Unsafe相关API"><a href="#Unsafe相关API" class="headerlink" title="Unsafe相关API"></a>Unsafe相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Unsafe</span></span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Unsafe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title">getUnsafe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Class var0 = Reflection.getCallerClass();</span><br><span class="line">    <span class="keyword">if</span> (!VM.isSystemDomainLoader(var0.getClassLoader())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Unsafe"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> theUnsafe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//由于JDK8的缘故只允许JDK自己调用他的构造函数</span></span><br><span class="line"><span class="comment">//使用反射进行实例化</span></span><br><span class="line">Field f = Unsafe.class.getDeclaredField("theUnsafe");</span><br><span class="line">f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Unsafe unsafe = (Unsafe) f.get(<span class="keyword">null</span>);</span><br><span class="line">System.out.println(unsafe);</span><br></pre></td></tr></table></figure><h2 id="对象相关"><a href="#对象相关" class="headerlink" title="对象相关"></a>对象相关</h2><h3 id="allocateInstance"><a href="#allocateInstance" class="headerlink" title="allocateInstance"></a>allocateInstance</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例化对象，但是不进行初始化，类初始化和实例初始化都不调用</span></span><br><span class="line"><span class="function">Object <span class="title">allocateInstance</span><span class="params">(Class&lt;?&gt; cls)</span></span></span><br></pre></td></tr></table></figure><h3 id="objectFieldOffset"><a href="#objectFieldOffset" class="headerlink" title="objectFieldOffset"></a>objectFieldOffset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//字段在内存中的地址相对于实例对象内存地址的偏移量</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">objectFieldOffset</span><span class="params">(Field f)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">objectFieldOffset</span><span class="params">(Class&lt;?&gt; c, String name)</span></span></span><br></pre></td></tr></table></figure><h3 id="staticFieldOffset"><a href="#staticFieldOffset" class="headerlink" title="staticFieldOffset"></a>staticFieldOffset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//静态字段在类对象中的偏移</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">staticFieldOffset</span><span class="params">(Field f)</span></span></span><br></pre></td></tr></table></figure><h3 id="staticFieldBase"><a href="#staticFieldBase" class="headerlink" title="staticFieldBase"></a>staticFieldBase</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获得静态字段所对应类对象，等同于f.getDeclaringClass()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">staticFieldBase</span><span class="params">(Field f)</span></span></span><br></pre></td></tr></table></figure><h3 id="getInt"><a href="#getInt" class="headerlink" title="getInt"></a>getInt</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//读取对象上指定偏移位置的值，其他基本数据类型</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(Object o, <span class="keyword">long</span> offset)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="putInt"><a href="#putInt" class="headerlink" title="putInt"></a>putInt</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改对象上指定偏移位置的值，其他基本数据类型</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putInt</span><span class="params">(Object o, <span class="keyword">long</span> offset, <span class="keyword">int</span> x)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="getObject"><a href="#getObject" class="headerlink" title="getObject"></a>getObject</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获得给定对象偏移量上的引用类型的值</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title">getObject</span><span class="params">(Object o, <span class="keyword">long</span> offset)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="putObject"><a href="#putObject" class="headerlink" title="putObject"></a>putObject</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置给定对象偏移量上的引用类型的值</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putObject</span><span class="params">(Object o, <span class="keyword">long</span> offset, Object x)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="getAddress"><a href="#getAddress" class="headerlink" title="getAddress"></a>getAddress</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取本地指针的值，等同于获取int或者是long类型的数据</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getAddress</span><span class="params">(Object o, <span class="keyword">long</span> offset)</span></span></span><br></pre></td></tr></table></figure><h3 id="getAddress-1"><a href="#getAddress-1" class="headerlink" title="getAddress"></a>getAddress</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设定本地指针的值，等同于设定int或者是long类型的数据</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">putAddress</span><span class="params">(Object o, <span class="keyword">long</span> offset)</span></span></span><br></pre></td></tr></table></figure><h2 id="Arrays相关"><a href="#Arrays相关" class="headerlink" title="Arrays相关"></a>Arrays相关</h2><p>&emsp;&emsp;数组头部还存储有数组的长度信息，索引访问数组元素时需要知道第一个元素与起始位置的偏移地址，Unsafe类包含所有的基本数据类型和Object类型的偏移的常量值，名称为<code>ARRAY_***_BASE_OFFSET</code></p><p>同时访问数组第i个元素，对应偏移的确定需要乘以一个比例值，即数组中单个元素的长度，Unsafe中对应的常量为<code>ARRAY_***_INDEX_SCALE</code></p><h3 id="初始偏移"><a href="#初始偏移" class="headerlink" title="初始偏移"></a>初始偏移</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">arrayBaseOffset</span><span class="params">(Class&lt;?&gt; arrayClass)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ARRAY_BOOLEAN_BASE_OFFSET  </span>= theUnsafe.arrayBaseOffset(<span class="keyword">boolean</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ARRAY_OBJECT_BASE_OFFSET   = theUnsafe.arrayBaseOffset(Object[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure><h3 id="比例值"><a href="#比例值" class="headerlink" title="比例值"></a>比例值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">arrayIndexScale</span><span class="params">(Class&lt;?&gt; arrayClass)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ARRAY_BOOLEAN_INDEX_SCALE</span></span><br><span class="line"><span class="function">        </span>= theUnsafe.arrayIndexScale(<span class="keyword">boolean</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ARRAY_OBJECT_INDEX_SCALE</span><br><span class="line">        = theUnsafe.arrayIndexScale(Object[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure><h3 id="读写操作"><a href="#读写操作" class="headerlink" title="读写操作"></a>读写操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ConcurrentHashMap</span></span><br><span class="line">Class&lt;?&gt; ak = Node[]<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">ABASE = U.arrayBaseOffset(ak);</span><br><span class="line"><span class="keyword">int</span> scale = U.arrayIndexScale(ak);</span><br><span class="line">ASHIFT = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line"></span><br><span class="line"><span class="comment">//，i代表索引</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CAS操作"><a href="#CAS操作" class="headerlink" title="CAS操作"></a>CAS操作</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapObject</span><span class="params">(Object o, <span class="keyword">long</span> offset, Object expected, Object x)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapInt</span><span class="params">(Object o, <span class="keyword">long</span> offset, <span class="keyword">int</span> expected, <span class="keyword">int</span> x)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">compareAndSwapLong</span><span class="params">(Object o, <span class="keyword">long</span> offset, <span class="keyword">long</span> expected, <span class="keyword">long</span> x)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@HotSpotIntrinsicCandidate</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndAddInt</span><span class="params">(Object o, <span class="keyword">long</span> offset, <span class="keyword">int</span> delta)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> v;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        v = getIntVolatile(o, offset);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!weakCompareAndSetInt(o, offset, v, v + delta));</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@HotSpotIntrinsicCandidate</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndSetInt</span><span class="params">(Object o, <span class="keyword">long</span> offset, <span class="keyword">int</span> newValue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> v;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        v = getIntVolatile(o, offset);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!weakCompareAndSetInt(o, offset, v, newValue));</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><h3 id="可见性的保障"><a href="#可见性的保障" class="headerlink" title="可见性的保障"></a>可见性的保障</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置给定对象的int值，使用volatile语义，即设置后立马更新到内存对其他线程可见</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span>  <span class="title">putIntVolatile</span><span class="params">(Object o, <span class="keyword">long</span> offset, <span class="keyword">int</span> x)</span></span>;</span><br><span class="line"><span class="comment">//获得给定对象的指定偏移量offset的int值，使用volatile语义，总能获取到最新的int值。</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">getIntVolatile</span><span class="params">(Object o, <span class="keyword">long</span> offset)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//惰性设定值的方式</span></span><br><span class="line">putOrderedObject(Object o, <span class="keyword">long</span> offset, Object x)</span><br><span class="line">putOrderedInt(Object o, <span class="keyword">long</span> offset, <span class="keyword">int</span> x)</span><br><span class="line">putOrderedLong(Object o, <span class="keyword">long</span> offset, <span class="keyword">long</span> x)</span><br></pre></td></tr></table></figure><h2 id="挂起"><a href="#挂起" class="headerlink" title="挂起"></a>挂起</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 阻塞线程</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">park</span><span class="params">(<span class="keyword">boolean</span> isAbsolute, <span class="keyword">long</span> time)</span></span>;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 解除阻塞或者让下一次阻塞调用失效</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">unpark</span><span class="params">(Object thread)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="内存屏障"><a href="#内存屏障" class="headerlink" title="内存屏障"></a>内存屏障</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在屏障之前的读操作，不会和之后的读写操作重排序，相当于LoadLoad 加上 LoadStore 屏障</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">loadFence</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//在屏障之前的读写操作，不会和之后的写操作重排序，相当于StoreStore 加上 LoadStore 屏障</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">storeFence</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//在该方法之前的所有读写操作，不会和之后的读写操作重排序，功能上相当于上面两个的功能和，加上StoreLoad屏障</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">fullFence</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//分配指定大小的内存,内存没有被初始化</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">allocateMemory</span><span class="params">(<span class="keyword">long</span> bytes)</span></span></span><br><span class="line"><span class="function"><span class="comment">//根据给定的内存地址address调整内存大小</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">reallocateMemory</span><span class="params">(<span class="keyword">long</span> address, <span class="keyword">long</span> bytes)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">//将内存块中的所有字节设置为固定值，类似于C中的memoryset函数</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMemory</span><span class="params">(Object o, <span class="keyword">long</span> offset, <span class="keyword">long</span> bytes, <span class="keyword">byte</span> value)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMemory</span><span class="params">(<span class="keyword">long</span> address, <span class="keyword">long</span> bytes, <span class="keyword">byte</span> value)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">//内存复制，支持两种地址模式</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copyMemory</span><span class="params">(Object srcBase, <span class="keyword">long</span> srcOffset,</span></span></span><br><span class="line"><span class="function"><span class="params">                        Object destBase, <span class="keyword">long</span> destOffset,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">long</span> bytes)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copyMemory</span><span class="params">(<span class="keyword">long</span> srcAddress, <span class="keyword">long</span> destAddress, <span class="keyword">long</span> bytes)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">//释放allocateMemory和reallocateMemory申请的内存</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">freeMemory</span><span class="params">(<span class="keyword">long</span> l)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 本地指针的大小 native pointer,4 或者 8</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addressSize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// 内存页面大小，通常为4KB，即4096</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">pageSize</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure><h2 id="一半是天使一半是魔鬼"><a href="#一半是天使一半是魔鬼" class="headerlink" title="一半是天使一半是魔鬼"></a>一半是天使一半是魔鬼</h2><p>&emsp;&emsp;<strong>Unsafe</strong>在JDK8版本中针对整个并发有着举足轻重的地位，在JDK9之前也有提出过删除，但是这样会引起一大批框架的动荡，例如<strong>netty</strong>，因此在JDK9的版本中也仅仅对此进行了一些改进以及优化操作而已。</p><p>&emsp;&emsp;1.由于<strong>Unsafe</strong>大部分源码都是<strong>native</strong>方法，直接去操作了内存，那么整个执行效率也会得到极大的提升，特别是在高并发的情形下，能够更好的提供强有力的支撑。</p><p>&emsp;&emsp;2.由于<strong>Unsafe</strong>使得<strong>Java</strong>拥有了和C语言一样直接去操作内存的能力，那么随之也会带来一系列的问题。比如：不再受制于JVM控制，并且无法GC、由于很多内存地址、偏移量都需要自行计算也可能更加容易导致出现JVM级别的异常，从而导致整个JVM进程崩溃。所以官方也不提供并且不推荐开发者使用。</p><h2 id="Unsafe测试"><a href="#Unsafe测试" class="headerlink" title="Unsafe测试"></a>Unsafe测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 反射获取unsafe</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/10 1:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title">getUnsafe</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">    Field f = Unsafe.class.getDeclaredField("theUnsafe");</span><br><span class="line">    f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span>  (Unsafe) f.get(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="对象初始化操作"><a href="#对象初始化操作" class="headerlink" title="对象初始化操作"></a>对象初始化操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Simple</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Simple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        i = <span class="number">1</span>;</span><br><span class="line">        System.out.println(<span class="string">"simple init."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setI</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.i = i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 测试unsafe对象实例化</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/10 1:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testSimple</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, InstantiationException </span>&#123;</span><br><span class="line">    Unsafe unsafe = getUnsafe();</span><br><span class="line">    <span class="comment">//通过Unsafe创建对象</span></span><br><span class="line">    Simple simple = (Simple) unsafe.allocateInstance(Simple<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    System.out.println(<span class="string">"simple i = "</span> + simple.getI());</span><br><span class="line">    System.out.println(<span class="string">"------------------------------------------"</span>);</span><br><span class="line">    <span class="comment">//直接创建对象</span></span><br><span class="line">    System.out.println(<span class="string">"simple i = "</span> + <span class="keyword">new</span> Simple().getI());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200710015317017.png" alt="image-20200710015317017"></p><p>&emsp;&emsp;可以发现通过<strong>Unsafe</strong>加载对象他不会调用构造方法，直接进行了实例化操作。</p><h3 id="工作权限案例"><a href="#工作权限案例" class="headerlink" title="工作权限案例"></a>工作权限案例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Guard</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ACCESS_ALLOWED = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//简单的权限校验</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">allow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">42</span> == ACCESS_ALLOWED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//满足条件进行工作</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (allow()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"I am do working."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 工作权限测试</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/10 2:00</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testGuard</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">    Guard guard = <span class="keyword">new</span> Guard();</span><br><span class="line">    <span class="comment">//肯定是无法工作的</span></span><br><span class="line">    guard.work();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用Unsafe</span></span><br><span class="line">    Field field = guard.getClass().getDeclaredField(<span class="string">"ACCESS_ALLOWED"</span>);</span><br><span class="line">    Unsafe unsafe = getUnsafe();</span><br><span class="line">    unsafe.putInt(guard, unsafe.objectFieldOffset(field), <span class="number">42</span>);</span><br><span class="line">    <span class="comment">//企图工作</span></span><br><span class="line">    guard.work();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200710020103029.png" alt="image-20200710020103029"></p><p>&emsp;&emsp;可以发现通过<strong>Unsafe</strong>操作可以绕开权限判断，使得正常工作。其实主要还是通过<strong>Unsafe</strong>直接操作了内存导致的。</p><h3 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UnsafeClass的class文件需要拷贝到指定位置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UnsafeClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.i = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 通过Unsafe加载类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/10 2:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testUnsafeClassLoad</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    File classFile = <span class="keyword">new</span> File(<span class="string">"D:\\UnsafeClass.class"</span>);</span><br><span class="line">    FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(classFile);</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>) classFile.length()];</span><br><span class="line">    inputStream.read(bytes);</span><br><span class="line">    inputStream.close();</span><br><span class="line">    <span class="comment">//通过Unsafe加载</span></span><br><span class="line">    Unsafe unsafe = getUnsafe();</span><br><span class="line">    Class defineClass = unsafe.defineClass(<span class="keyword">null</span>, bytes, <span class="number">0</span>, bytes.length, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    Method classMethod = defineClass.getMethod(<span class="string">"getI"</span>);</span><br><span class="line">    Object invoke = classMethod.invoke(defineClass.newInstance(), <span class="keyword">null</span>);</span><br><span class="line">    System.out.println(invoke);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取字段的偏移量"><a href="#获取字段的偏移量" class="headerlink" title="获取字段的偏移量"></a>获取字段的偏移量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> unsafe获取字段偏移量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/10 2:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sizeOf</span><span class="params">(Object object)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">    Unsafe unsafe = getUnsafe();</span><br><span class="line">    Set&lt;Field&gt; fieldSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    Class&lt;?&gt; aClass = object.getClass();</span><br><span class="line">    <span class="keyword">while</span> (aClass != Object<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">        Field[] declaredFields = aClass.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((field.getModifiers() &amp; Modifier.STATIC )== <span class="number">0</span>) &#123;</span><br><span class="line">                fieldSet.add(field);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        aClass = aClass.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> maxOffSet = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Field field : fieldSet) &#123;</span><br><span class="line">        <span class="keyword">long</span> offset = unsafe.objectFieldOffset(field);</span><br><span class="line">        <span class="keyword">if</span> (offset &gt; maxOffSet) &#123;</span><br><span class="line">            maxOffSet = offset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(((maxOffSet / <span class="number">8</span>) + <span class="number">1</span>) * <span class="number">8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-42-LongAdder详解</title>
      <link href="/2020/07/07/8158/hub/"/>
      <url>/2020/07/07/8158/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200707221203318.png" alt="image-20200707221203318"></p><h2 id="LongAdder相关API"><a href="#LongAdder相关API" class="headerlink" title="LongAdder相关API"></a>LongAdder相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extends Striped64 implements Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">LongAdder longAdder = <span class="keyword">new</span> LongAdder();</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="add"><a href="#add" class="headerlink" title="add"></a>add</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//add</span></span><br><span class="line">longAdder.add(<span class="number">10</span>);</span><br><span class="line">System.out.println(longAdder.intValue());</span><br></pre></td></tr></table></figure><h4 id="decrement"><a href="#decrement" class="headerlink" title="decrement"></a>decrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//decrement</span></span><br><span class="line">longAdder.decrement();</span><br><span class="line">System.out.println(longAdder.doubleValue());</span><br></pre></td></tr></table></figure><h4 id="doubleValue"><a href="#doubleValue" class="headerlink" title="doubleValue"></a>doubleValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//doubleValue</span></span><br><span class="line">System.out.println(longAdder.doubleValue());</span><br></pre></td></tr></table></figure><h4 id="floatValue"><a href="#floatValue" class="headerlink" title="floatValue"></a>floatValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//floatValue</span></span><br><span class="line">System.out.println(longAdder.floatValue());</span><br></pre></td></tr></table></figure><h4 id="increment"><a href="#increment" class="headerlink" title="increment"></a>increment</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//increment</span></span><br><span class="line">longAdder.increment();</span><br><span class="line">System.out.println(longAdder.floatValue());</span><br></pre></td></tr></table></figure><h4 id="intValue"><a href="#intValue" class="headerlink" title="intValue"></a>intValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//intValue</span></span><br><span class="line">System.out.println(longAdder.intValue());</span><br></pre></td></tr></table></figure><h4 id="longValue"><a href="#longValue" class="headerlink" title="longValue"></a>longValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//longValue</span></span><br><span class="line">System.out.println(longAdder.longValue());</span><br></pre></td></tr></table></figure><h4 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//reset</span></span><br><span class="line">longAdder.reset();</span><br><span class="line">System.out.println(longAdder.longValue());</span><br></pre></td></tr></table></figure><h4 id="sum"><a href="#sum" class="headerlink" title="sum"></a>sum</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sum</span></span><br><span class="line">System.out.println(longAdder.sum());</span><br></pre></td></tr></table></figure><h4 id="sumThenReset"><a href="#sumThenReset" class="headerlink" title="sumThenReset"></a>sumThenReset</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sumThenReset</span></span><br><span class="line">System.out.println(longAdder.sumThenReset());</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="sum-1"><a href="#sum-1" class="headerlink" title="sum"></a>sum</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="keyword">long</span> sum = base;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//对Cell求和</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="reset-1"><a href="#reset-1" class="headerlink" title="reset"></a>reset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="comment">//base值set为0</span></span><br><span class="line">    base = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                <span class="comment">//元素set为0</span></span><br><span class="line">                a.value = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sumThenReset-1"><a href="#sumThenReset-1" class="headerlink" title="sumThenReset"></a>sumThenReset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//线程安全问题</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sumThenReset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="keyword">long</span> sum = base;</span><br><span class="line">    <span class="comment">//base值set为0</span></span><br><span class="line">    base = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//累加元素</span></span><br><span class="line">                sum += a.value;</span><br><span class="line">                <span class="comment">//累加以后的元素set为0</span></span><br><span class="line">                a.value = <span class="number">0L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="add-1"><a href="#add-1" class="headerlink" title="add"></a>add</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">long</span> x)</span> </span>&#123;</span><br><span class="line">    Cell[] as; <span class="keyword">long</span> b, v; <span class="keyword">int</span> m; Cell a;</span><br><span class="line">    <span class="comment">//第一次cells为空则进行casBase操作</span></span><br><span class="line">    <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> || !casBase(b = base, b + x)) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> || </span><br><span class="line">            <span class="comment">//如果Cells数组长度!=0那么计算cells位置</span></span><br><span class="line">            (a = as[getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">            <span class="comment">//如果cells所处位置不为空那么执行cas操作</span></span><br><span class="line">            !(uncontended = a.cas(v = a.value, v + x)))</span><br><span class="line">            <span class="comment">//否则进行初始化cells操作</span></span><br><span class="line">            longAccumulate(x, <span class="keyword">null</span>, uncontended);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-41-LongAccumulator详解</title>
      <link href="/2020/07/07/11754/hub/"/>
      <url>/2020/07/07/11754/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200707220618058.png" alt="image-20200707220618058"></p><h2 id="LongAccumulator相关API"><a href="#LongAccumulator相关API" class="headerlink" title="LongAccumulator相关API"></a>LongAccumulator相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extends Striped64 implements Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">LongAccumulator longAccumulator = <span class="keyword">new</span> LongAccumulator((x, y) -&gt; x * y, <span class="number">10</span>);</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="accumulate"><a href="#accumulate" class="headerlink" title="accumulate"></a>accumulate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//accumulate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.传入数值</span></span><br><span class="line"><span class="comment"> * 2.执行LongBinaryOperator操作函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">longAccumulator.accumulate(<span class="number">10</span>);</span><br><span class="line">System.out.println(longAccumulator.doubleValue());</span><br></pre></td></tr></table></figure><h4 id="doubleValue"><a href="#doubleValue" class="headerlink" title="doubleValue"></a>doubleValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//doubleValue</span></span><br><span class="line">System.out.println(longAccumulator.doubleValue());</span><br></pre></td></tr></table></figure><h4 id="floatValue"><a href="#floatValue" class="headerlink" title="floatValue"></a>floatValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//floatValue</span></span><br><span class="line">System.out.println(longAccumulator.floatValue());</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line">System.out.println(longAccumulator.get());</span><br></pre></td></tr></table></figure><h4 id="getThenReset"><a href="#getThenReset" class="headerlink" title="getThenReset"></a>getThenReset</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getThenReset</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.还原数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(longAccumulator.getThenReset());</span><br></pre></td></tr></table></figure><h4 id="intValue"><a href="#intValue" class="headerlink" title="intValue"></a>intValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//intValue</span></span><br><span class="line">System.out.println(longAccumulator.intValue());</span><br></pre></td></tr></table></figure><h4 id="longValue"><a href="#longValue" class="headerlink" title="longValue"></a>longValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//longValue</span></span><br><span class="line">System.out.println(longAccumulator.longValue());</span><br></pre></td></tr></table></figure><h4 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//reset</span></span><br><span class="line">longAccumulator.reset();</span><br><span class="line">System.out.println(longAccumulator.get());</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="accumulate-1"><a href="#accumulate-1" class="headerlink" title="accumulate"></a>accumulate</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accumulate</span><span class="params">(<span class="keyword">long</span> x)</span> </span>&#123;</span><br><span class="line">    Cell[] as; <span class="keyword">long</span> b, v, r; <span class="keyword">int</span> m; Cell a;</span><br><span class="line">    <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> ||</span><br><span class="line">        <span class="comment">//如果cells不为空并且function不为空则执行function </span></span><br><span class="line">        (r = function.applyAsLong(b = base, x)) != b &amp;&amp; !casBase(b, r)) &#123;</span><br><span class="line">        <span class="comment">//cells为空或者cas失败出现冲突</span></span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">//如果cells没有初始化完成</span></span><br><span class="line">            (a = as[getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">            <span class="comment">//计算索引位置如果为空则执行function</span></span><br><span class="line">            !(uncontended =</span><br><span class="line">              (r = function.applyAsLong(v = a.value, x)) == v ||</span><br><span class="line">              a.cas(v, r)))</span><br><span class="line">            <span class="comment">//否则进行初始化cells操作</span></span><br><span class="line">            longAccumulate(x, function, uncontended);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getThenReset-1"><a href="#getThenReset-1" class="headerlink" title="getThenReset"></a>getThenReset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getThenReset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="keyword">long</span> result = base;</span><br><span class="line">    <span class="comment">//base值还原成初始值</span></span><br><span class="line">    base = identity;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> v = a.value;</span><br><span class="line">                <span class="comment">//索引处的值进行还原</span></span><br><span class="line">                a.value = identity;</span><br><span class="line">                <span class="comment">//将值执行function</span></span><br><span class="line">                result = function.applyAsLong(result, v);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="reset-1"><a href="#reset-1" class="headerlink" title="reset"></a>reset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="comment">//base还原成初始值</span></span><br><span class="line">    base = identity;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                <span class="comment">//将cells表的数据进还原</span></span><br><span class="line">                a.value = identity;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-40-DoubleAdder详解</title>
      <link href="/2020/07/07/60688/hub/"/>
      <url>/2020/07/07/60688/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200707215504630.png" alt="image-20200707215504630"></p><h2 id="DoubleAdder相关API"><a href="#DoubleAdder相关API" class="headerlink" title="DoubleAdder相关API"></a>DoubleAdder相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extends Striped64 implements Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">DoubleAdder doubleAdder = <span class="keyword">new</span> DoubleAdder();</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="add"><a href="#add" class="headerlink" title="add"></a>add</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//add</span></span><br><span class="line">doubleAdder.add(<span class="number">10</span>);</span><br><span class="line">System.out.println(doubleAdder.doubleValue());</span><br></pre></td></tr></table></figure><h4 id="doubleValue"><a href="#doubleValue" class="headerlink" title="doubleValue"></a>doubleValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//doubleValue</span></span><br><span class="line">System.out.println(doubleAdder.doubleValue());</span><br></pre></td></tr></table></figure><h4 id="floatValue"><a href="#floatValue" class="headerlink" title="floatValue"></a>floatValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//floatValue</span></span><br><span class="line">System.out.println(doubleAdder.floatValue());</span><br></pre></td></tr></table></figure><h4 id="intValue"><a href="#intValue" class="headerlink" title="intValue"></a>intValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//intValue</span></span><br><span class="line">System.out.println(doubleAdder.intValue());</span><br></pre></td></tr></table></figure><h4 id="longValue"><a href="#longValue" class="headerlink" title="longValue"></a>longValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//longValue</span></span><br><span class="line">System.out.println(doubleAdder.longValue());</span><br></pre></td></tr></table></figure><h4 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//reset</span></span><br><span class="line">doubleAdder.reset();</span><br><span class="line">System.out.println(doubleAdder.intValue());</span><br></pre></td></tr></table></figure><h4 id="sum"><a href="#sum" class="headerlink" title="sum"></a>sum</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sum</span></span><br><span class="line">System.out.println(doubleAdder.sum());</span><br></pre></td></tr></table></figure><h4 id="sumThenReset"><a href="#sumThenReset" class="headerlink" title="sumThenReset"></a>sumThenReset</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sumThenReset</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先sum</span></span><br><span class="line"><span class="comment"> * 2.再还原</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(doubleAdder.sumThenReset());</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-39-DoubleAccumulator详解</title>
      <link href="/2020/07/07/65415/hub/"/>
      <url>/2020/07/07/65415/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200707210603622.png" alt="image-20200707210603622"></p><p>&emsp;&emsp;<strong>DoubleAccumulator</strong>，<strong>LongAccumulator</strong>,<strong>LongAdder</strong>,<strong>DoubleAdder</strong>是在JDK1.8新增的，主要对原来的原子包进行了增强。它们都继承自<strong>Striped64</strong>。</p><p>&emsp;&emsp;它们的主要思想就是<strong>热点分离</strong>，其实就是将<strong>value</strong>分离成了一个数组，在多线程的情况下访问，通过计算hash值映射到其中一个数值进行计数，而最终的结果就是这些数组进行求和累加，从而减小锁的粒度。</p><p><img src="/image/hexo/image-20200707224526442.png" alt="image-20200707224526442"></p><h2 id="DoubleAccumulator相关API"><a href="#DoubleAccumulator相关API" class="headerlink" title="DoubleAccumulator相关API"></a>DoubleAccumulator相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extends Striped64 implements Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">DoubleAccumulator doubleAccumulator = <span class="keyword">new</span> DoubleAccumulator((x, y) -&gt; x + y, <span class="number">10</span>);</span><br><span class="line">System.out.println(doubleAccumulator.doubleValue());</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="accumulate"><a href="#accumulate" class="headerlink" title="accumulate"></a>accumulate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//accumulate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.传入值</span></span><br><span class="line"><span class="comment"> * 2.执行构造函数中的accumulatorFunction函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">doubleAccumulator.accumulate(<span class="number">10</span>);</span><br><span class="line">System.out.println(doubleAccumulator.doubleValue());</span><br></pre></td></tr></table></figure><h4 id="doubleValue"><a href="#doubleValue" class="headerlink" title="doubleValue"></a>doubleValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//doubleValue</span></span><br><span class="line">System.out.println(doubleAccumulator.doubleValue());</span><br></pre></td></tr></table></figure><h4 id="floatValue"><a href="#floatValue" class="headerlink" title="floatValue"></a>floatValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//floatValue</span></span><br><span class="line">System.out.println(doubleAccumulator.floatValue());</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line">System.out.println(doubleAccumulator.get());</span><br></pre></td></tr></table></figure><h4 id="getThenReset"><a href="#getThenReset" class="headerlink" title="getThenReset"></a>getThenReset</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getThenReset</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再还原程初始值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(doubleAccumulator.getThenReset());</span><br><span class="line">System.out.println(doubleAccumulator.get());</span><br></pre></td></tr></table></figure><h4 id="intValue"><a href="#intValue" class="headerlink" title="intValue"></a>intValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//intValue</span></span><br><span class="line">System.out.println(doubleAccumulator.intValue());</span><br></pre></td></tr></table></figure><h4 id="longValue"><a href="#longValue" class="headerlink" title="longValue"></a>longValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//longValue</span></span><br><span class="line">System.out.println(doubleAccumulator.longValue());</span><br></pre></td></tr></table></figure><h4 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//reset</span></span><br><span class="line">doubleAccumulator.reset();</span><br><span class="line">System.out.println(doubleAccumulator.get());</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-38-Striped64详解</title>
      <link href="/2020/07/06/33795/hub/"/>
      <url>/2020/07/06/33795/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706221438696.png" alt="image-20200706221438696"></p><p>&emsp;&emsp;直到现在<strong>atomic</strong>只剩下了<strong>DoubleAccumulator</strong>、<strong>DoubleAdder</strong>、<strong>LongAccumulator **、</strong>LongAdder<strong>但是它们都是继承自</strong>Striped64**。</p><p>&emsp;&emsp;<strong>Striped64</strong>主要再JDK1.8中开始引入，对前面的<strong>Atomic</strong>系列进行了增强。用来支持累加器的并发组件，在多线程的环境下进行安全的累加计数操作。</p><h2 id="Striped64源码解析"><a href="#Striped64源码解析" class="headerlink" title="Striped64源码解析"></a>Striped64源码解析</h2><h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * cell数组，不为null的情况下，大小为2^n</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基础值，执行更新操作的时候基于CAS实现原子性更新</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> base;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CAS锁（自旋锁），主要用于保护创建或者扩展Cell表</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br></pre></td></tr></table></figure><h3 id="casBase"><a href="#casBase" class="headerlink" title="casBase"></a>casBase</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更新base值</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">casBase</span><span class="params">(<span class="keyword">long</span> cmp, <span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, BASE, cmp, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="casCellsBusy"><a href="#casCellsBusy" class="headerlink" title="casCellsBusy"></a>casCellsBusy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过CAS操作修改cellsBusy字段，从0修改为1， 表示获得锁</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">casCellsBusy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UNSAFE.compareAndSwapInt(<span class="keyword">this</span>, CELLSBUSY, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getProbe"><a href="#getProbe" class="headerlink" title="getProbe"></a>getProbe</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回当前线程的标示,由于包限制，这段代码是从ThreadLocalRandom拷贝过来的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getProbe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UNSAFE.getInt(Thread.currentThread(), PROBE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="advanceProbe"><a href="#advanceProbe" class="headerlink" title="advanceProbe"></a>advanceProbe</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 利用伪随机算法加强标识后，将为当前线程记录这个标识。</span></span><br><span class="line"><span class="comment"> * 由于包限制，这段代码是从ThreadLocalRandom拷贝过来的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">advanceProbe</span><span class="params">(<span class="keyword">int</span> probe)</span> </span>&#123;</span><br><span class="line">    probe ^= probe &lt;&lt; <span class="number">13</span>;   <span class="comment">// xorshift</span></span><br><span class="line">    probe ^= probe &gt;&gt;&gt; <span class="number">17</span>;</span><br><span class="line">    probe ^= probe &lt;&lt; <span class="number">5</span>;</span><br><span class="line">    UNSAFE.putInt(Thread.currentThread(), PROBE, probe);</span><br><span class="line">    <span class="keyword">return</span> probe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> BASE;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> CELLSBUSY;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> PROBE;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">        Class&lt;?&gt; sk = Striped64<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        BASE = UNSAFE.objectFieldOffset</span><br><span class="line">            (sk.getDeclaredField(<span class="string">"base"</span>));</span><br><span class="line">        CELLSBUSY = UNSAFE.objectFieldOffset</span><br><span class="line">            (sk.getDeclaredField(<span class="string">"cellsBusy"</span>));</span><br><span class="line">        Class&lt;?&gt; tk = Thread<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        PROBE = UNSAFE.objectFieldOffset</span><br><span class="line">            (tk.getDeclaredField(<span class="string">"threadLocalRandomProbe"</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="longAccumulate【核心】"><a href="#longAccumulate【核心】" class="headerlink" title="longAccumulate【核心】"></a>longAccumulate【核心】</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *1.初始化</span></span><br><span class="line"><span class="comment"> *2.容量调整</span></span><br><span class="line"><span class="comment"> *3.Cell争夺与创建</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">longAccumulate</span><span class="params">(<span class="keyword">long</span> x, LongBinaryOperator fn,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//x:元素</span></span><br><span class="line">    <span class="comment">//fn:操作函数</span></span><br><span class="line">    <span class="comment">//wasUncontended:CAS之前失败，则该值为false</span></span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="comment">//获取当前线程的probe值</span></span><br><span class="line">    <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//h = 0 初始化当前线程的probe</span></span><br><span class="line">        ThreadLocalRandom.current(); <span class="comment">// 强制初始化</span></span><br><span class="line">        h = getProbe();</span><br><span class="line">        <span class="comment">//设置为true</span></span><br><span class="line">        wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//碰撞标记，slot不为空设置为true</span></span><br><span class="line">    <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//进入死循环</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Cell[] as; Cell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">        <span class="comment">//cells不为空进入下一步操作(cells已经初始化完成)</span></span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//计算位置：hashCode &amp; (lenth-1) 计算得出为当前位置null就需要进行初始化操作</span></span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//试图获取cellsBusy锁</span></span><br><span class="line">                <span class="keyword">if</span> (cellsBusy锁 == <span class="number">0</span>) &#123;    </span><br><span class="line">                    <span class="comment">//给定一个cell,并且将元素放进去</span></span><br><span class="line">                    Cell r = <span class="keyword">new</span> Cell(x);  </span><br><span class="line">                    <span class="comment">//再次判断状态并且尝试获取锁</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                        <span class="comment">//开始执行create操作</span></span><br><span class="line">                        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123; </span><br><span class="line">                            Cell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                            <span class="keyword">if</span> ((rs = cells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">//cell存入cells</span></span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                <span class="comment">//标识x元素加入cells成功</span></span><br><span class="line">                                created = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            <span class="comment">//释放锁</span></span><br><span class="line">                            cellsBusy = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//创建成功则直接跳出终止循环</span></span><br><span class="line">                        <span class="keyword">if</span> (created)</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">//否则进入下一次循环</span></span><br><span class="line">                        <span class="keyword">continue</span>;         </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">               </span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)   </span><br><span class="line">                <span class="comment">//CAS失败，开始出现竞争</span></span><br><span class="line">                wasUncontended = <span class="keyword">true</span>;   </span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="keyword">null</span>) ? v + x :</span><br><span class="line">                                         fn.applyAsLong(v, x))))</span><br><span class="line">                <span class="comment">//尝试修改a(cell)上的计数，执行fn函数直接终止当前循环</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)</span><br><span class="line">                <span class="comment">//cells最大为CPU的数量</span></span><br><span class="line">                <span class="comment">//cells != as 那么cells已经被更新</span></span><br><span class="line">                <span class="comment">//标记最大</span></span><br><span class="line">                collide = <span class="keyword">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                collide = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                <span class="comment">//尝试进行扩容cells</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cells == as) &#123;      <span class="comment">// Expand table unless stale</span></span><br><span class="line">                        <span class="comment">//扩容为原来的2倍</span></span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> Cell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];</span><br><span class="line">                        cells = rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//处理hash冲突</span></span><br><span class="line">            h = advanceProbe(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">            <span class="comment">//cells为空进行初始化操作 尝试获取锁</span></span><br><span class="line">            <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;                           <span class="comment">// Initialize table</span></span><br><span class="line">                <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                    Cell[] rs = <span class="keyword">new</span> Cell[<span class="number">2</span>];</span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> Cell(x);</span><br><span class="line">                    cells = rs;</span><br><span class="line">                    init = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                cellsBusy = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (init)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="keyword">null</span>) ? v + x :</span><br><span class="line">                                    fn.applyAsLong(v, x))))</span><br><span class="line">            <span class="comment">//cells为空并且获取锁失败那么直接在base进行了CAS</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">longAccumulate</span><span class="params">(<span class="keyword">long</span> x, LongBinaryOperator fn,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//进入死循环</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Cell[] as; Cell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">        <span class="comment">//cells不为空进入下一步操作(cells已经初始化完成)</span></span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//cells为空试图去争夺锁然后进行初始化cells</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//cells为空并且获取锁失败那么直接在base进行了CAS</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="keyword">null</span>) ? v + x :</span><br><span class="line">                                    fn.applyAsLong(v, x))))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="doubleAccumulate【核心】"><a href="#doubleAccumulate【核心】" class="headerlink" title="doubleAccumulate【核心】"></a>doubleAccumulate【核心】</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//与longAccumulate类似，只是数据类型不同而已</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doubleAccumulate</span><span class="params">(<span class="keyword">double</span> x, DoubleBinaryOperator fn,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        ThreadLocalRandom.current(); <span class="comment">// force initialization</span></span><br><span class="line">        h = getProbe();</span><br><span class="line">        wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;                <span class="comment">// True if last slot nonempty</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Cell[] as; Cell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;       <span class="comment">// Try to attach new Cell</span></span><br><span class="line">                    Cell r = <span class="keyword">new</span> Cell(Double.doubleToRawLongBits(x));</span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;               <span class="comment">// Recheck under lock</span></span><br><span class="line">                            Cell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                            <span class="keyword">if</span> ((rs = cells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (created)</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)       <span class="comment">// CAS already known to fail</span></span><br><span class="line">                wasUncontended = <span class="keyword">true</span>;      <span class="comment">// Continue after rehash</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value,</span><br><span class="line">                           ((fn == <span class="keyword">null</span>) ?</span><br><span class="line">                            Double.doubleToRawLongBits</span><br><span class="line">                            (Double.longBitsToDouble(v) + x) :</span><br><span class="line">                            Double.doubleToRawLongBits</span><br><span class="line">                            (fn.applyAsDouble</span><br><span class="line">                             (Double.longBitsToDouble(v), x)))))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)</span><br><span class="line">                collide = <span class="keyword">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                collide = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cells == as) &#123;      <span class="comment">// Expand table unless stale</span></span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> Cell[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];</span><br><span class="line">                        cells = rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">            &#125;</span><br><span class="line">            h = advanceProbe(h);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> init = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;                           <span class="comment">// Initialize table</span></span><br><span class="line">                <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                    Cell[] rs = <span class="keyword">new</span> Cell[<span class="number">2</span>];</span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> Cell(Double.doubleToRawLongBits(x));</span><br><span class="line">                    cells = rs;</span><br><span class="line">                    init = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                cellsBusy = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (init)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base,</span><br><span class="line">                         ((fn == <span class="keyword">null</span>) ?</span><br><span class="line">                          Double.doubleToRawLongBits</span><br><span class="line">                          (Double.longBitsToDouble(v) + x) :</span><br><span class="line">                          Double.doubleToRawLongBits</span><br><span class="line">                          (fn.applyAsDouble</span><br><span class="line">                           (Double.longBitsToDouble(v), x)))))</span><br><span class="line">            <span class="keyword">break</span>;                          <span class="comment">// Fall back on using base</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-37-AtomicMarkableReference详解</title>
      <link href="/2020/07/06/55120/hub/"/>
      <url>/2020/07/06/55120/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706195730184.png" alt="image-20200706195730184"></p><p>&emsp;&emsp;<strong>AtomicMarkableReference</strong>主要封装了一个对象引用和一个<strong>mark</strong>,主要用于原子性的对比。</p><h2 id="AtomicMarkableReference相关API"><a href="#AtomicMarkableReference相关API" class="headerlink" title="AtomicMarkableReference相关API"></a>AtomicMarkableReference相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicMarkableReference</span>&lt;<span class="title">V</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;构造函数</span><br><span class="line">AtomicMarkableReference markableReference &#x3D; new AtomicMarkableReference(&quot;A&quot;, true);</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="attemptMark"><a href="#attemptMark" class="headerlink" title="attemptMark"></a>attemptMark</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//attemptMark</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.以原子方式设置标记值为新的值</span></span><br><span class="line"><span class="comment"> * 2.当期望的引用值与当前引用值相同时，操作成功，返回true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">markableReference.attemptMark(<span class="string">"A"</span>, <span class="keyword">false</span>);</span><br><span class="line">System.out.println(markableReference.getReference());</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.期望引用值 == 期望标记值</span></span><br><span class="line"><span class="comment"> * 2.新的引用值和新的标记值不同时等于当前值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">markableReference.compareAndSet(<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.将mark写入arr</span></span><br><span class="line"><span class="comment"> * 2.返回对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">boolean</span>[] arr = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">1</span>];</span><br><span class="line">System.out.println(markableReference.get(arr));</span><br></pre></td></tr></table></figure><h4 id="getReference"><a href="#getReference" class="headerlink" title="getReference"></a>getReference</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getReference</span></span><br><span class="line">System.out.println(markableReference.getReference());</span><br></pre></td></tr></table></figure><h4 id="isMarked"><a href="#isMarked" class="headerlink" title="isMarked"></a>isMarked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isMarked</span></span><br><span class="line">System.out.println(markableReference.isMarked());</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.对象引用不同</span></span><br><span class="line"><span class="comment"> * 2.mark不同</span></span><br><span class="line"><span class="comment"> * 3.执行更新操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">markableReference.set(<span class="string">"B"</span>, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line">markableReference.weakCompareAndSet(<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//对象引用</span></span><br><span class="line">    <span class="keyword">final</span> T reference;</span><br><span class="line">    <span class="comment">//mark标识</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mark;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Pair</span><span class="params">(T reference, <span class="keyword">boolean</span> mark)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.reference = reference;</span><br><span class="line">        <span class="keyword">this</span>.mark = mark;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//静态构造函数</span></span><br><span class="line">    <span class="keyword">static</span> &lt;T&gt; <span class="function">Pair&lt;T&gt; <span class="title">of</span><span class="params">(T reference, <span class="keyword">boolean</span> mark)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Pair&lt;T&gt;(reference, mark);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//volatile保证当前pari可见性</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Pair&lt;V&gt; pair;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// unsafe原子性操作基础</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE = Unsafe.getUnsafe();</span><br><span class="line"><span class="comment">// 成员变量value的内存偏移值</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> pairOffset = objectFieldOffset(UNSAFE, <span class="string">"pair"</span>, AtomicMarkableReference<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure><h3 id="构造函数-1"><a href="#构造函数-1" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用Pair静态域去产生一个新的pair对象</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AtomicMarkableReference</span><span class="params">(V initialRef, <span class="keyword">int</span> initialMark)</span> </span>&#123;</span><br><span class="line">      pair = Pair.of(initialRef, initialMark);</span><br><span class="line">      <span class="comment">//volatile修饰，保证了可见性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(<span class="keyword">boolean</span>[] markHolder)</span> </span>&#123;</span><br><span class="line">    Pair&lt;V&gt; pair = <span class="keyword">this</span>.pair;</span><br><span class="line">    <span class="comment">//markHolder长度需要大于1，引用传递当前的mark出去</span></span><br><span class="line">    markHolder[<span class="number">0</span>] = pair.mark;</span><br><span class="line">    <span class="comment">//返回当前的对象reference</span></span><br><span class="line">    <span class="keyword">return</span> pair.reference;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="set-1"><a href="#set-1" class="headerlink" title="set"></a>set</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(V newReference, <span class="keyword">boolean</span> newMark)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取当前值</span></span><br><span class="line">    Pair&lt;V&gt; current = pair;</span><br><span class="line">    <span class="comment">//引用不同或者mark不同就更新当前的数据并且产生的是一个新的对象</span></span><br><span class="line">    <span class="keyword">if</span> (newReference != current.reference || newMark != current.mark)</span><br><span class="line">        <span class="keyword">this</span>.pair = Pair.of(newReference, newMark);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="compareAndSet-1"><a href="#compareAndSet-1" class="headerlink" title="compareAndSet"></a>compareAndSet</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(V       expectedReference,</span></span></span><br><span class="line"><span class="function"><span class="params">                             V       newReference,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">boolean</span> expectedMark,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">boolean</span> newMark)</span> </span>&#123;</span><br><span class="line">    Pair&lt;V&gt; current = pair;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">        <span class="comment">//期望值引用 == 当前值引用</span></span><br><span class="line">        expectedReference == current.reference &amp;&amp;</span><br><span class="line">        <span class="comment">//期望mark == 当前mark</span></span><br><span class="line">        expectedMark == current.mark &amp;&amp;</span><br><span class="line">        <span class="comment">//如果引用和mark相同则return</span></span><br><span class="line">        ((newReference == current.reference &amp;&amp;</span><br><span class="line">          newMark == current.mark) ||</span><br><span class="line">         <span class="comment">//否则进入cas操作，更新当前pair</span></span><br><span class="line">         casPair(current, Pair.of(newReference, newMark)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="attemptMark-1"><a href="#attemptMark-1" class="headerlink" title="attemptMark"></a>attemptMark</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">attemptMark</span><span class="params">(V expectedReference, <span class="keyword">boolean</span> newMark)</span> </span>&#123;</span><br><span class="line">    Pair&lt;V&gt; current = pair;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">       <span class="comment">//期望值引用 == 当前值引用</span></span><br><span class="line">        expectedReference == current.reference &amp;&amp;</span><br><span class="line">        <span class="comment">//如果mark相同则return</span></span><br><span class="line">        (newMark == current.mark ||</span><br><span class="line">         <span class="comment">//否则进入cas操作，更新当前pair</span></span><br><span class="line">         casPair(current, Pair.of(expectedReference, newMark)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-36-AtomicReferenceFieldUpdater详解</title>
      <link href="/2020/07/06/4166/hub/"/>
      <url>/2020/07/06/4166/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706215649994.png" alt="image-20200706215649994"></p><h2 id="AtomicReferenceFieldUpdater相关API"><a href="#AtomicReferenceFieldUpdater相关API" class="headerlink" title="AtomicReferenceFieldUpdater相关API"></a>AtomicReferenceFieldUpdater相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicReferenceFieldUpdater</span>&lt;<span class="title">T</span>,<span class="title">V</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">AtomicReferenceFieldUpdater&lt;Person, String&gt; updater = AtomicReferenceFieldUpdater.newUpdater(Person.class, String.class, "name");</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="accumulateAndGet"><a href="#accumulateAndGet" class="headerlink" title="accumulateAndGet"></a>accumulateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Person person = <span class="keyword">new</span> Person(<span class="number">1001</span>, <span class="string">"p1"</span>);</span><br><span class="line"><span class="comment">//accumulateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行BinaryOperator函数</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.accumulateAndGet(person, <span class="string">"p1"</span>, (x, y) -&gt; x + y));</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先对比</span></span><br><span class="line"><span class="comment"> * 2.成功则更新指定数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.compareAndSet(person, <span class="string">"p1p1"</span>, <span class="string">"p2"</span>));</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line">System.out.println(updater.get(person));</span><br></pre></td></tr></table></figure><h4 id="getAndAccumulate"><a href="#getAndAccumulate" class="headerlink" title="getAndAccumulate"></a>getAndAccumulate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAccumulate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再执行BinaryOperator函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndAccumulate(person, <span class="string">"p3"</span>, (x, y) -&gt; x + y));</span><br></pre></td></tr></table></figure><h4 id="getAndSet"><a href="#getAndSet" class="headerlink" title="getAndSet"></a>getAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再set指定数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndSet(person,<span class="string">"p4"</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndUpdate"><a href="#getAndUpdate" class="headerlink" title="getAndUpdate"></a>getAndUpdate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndUpdate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get </span></span><br><span class="line"><span class="comment"> * 2.再执行UnaryOperator操作函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndUpdate(person, x -&gt; x + <span class="string">"p5"</span>));</span><br></pre></td></tr></table></figure><h4 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lazySet</span></span><br><span class="line">updater.lazySet(person, <span class="string">"p6"</span>);</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">updater.set(person, <span class="string">"p7"</span>);</span><br></pre></td></tr></table></figure><h4 id="updateAndGet"><a href="#updateAndGet" class="headerlink" title="updateAndGet"></a>updateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//updateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行UnaryOperator操作函数</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.updateAndGet(person, x -&gt; x + <span class="string">"p8"</span>));</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line">System.out.println(updater.weakCompareAndSet(person, <span class="string">"p8"</span>, <span class="string">"p9"</span>));</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-35-AtomicLongFieldUpdater详解</title>
      <link href="/2020/07/06/56990/hub/"/>
      <url>/2020/07/06/56990/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706191044266.png" alt="image-20200706191044266"></p><p>&emsp;&emsp;这里简单的描述一下方法即可，与<strong>AtomicIntegerFieldUpdater</strong>类似。</p><h2 id="AtomicLongFieldUpdater相关API"><a href="#AtomicLongFieldUpdater相关API" class="headerlink" title="AtomicLongFieldUpdater相关API"></a>AtomicLongFieldUpdater相关API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LongBalance</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">long</span> balance = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerFieldUpdater</span>&lt;<span class="title">T</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回了一个内部实现类AtomicIntegerFieldUpdaterImpl</span></span><br><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; <span class="function">AtomicIntegerFieldUpdater&lt;U&gt; <span class="title">newUpdater</span><span class="params">(Class&lt;U&gt; tclass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                          String fieldName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AtomicIntegerFieldUpdaterImpl&lt;U&gt;</span><br><span class="line">        (tclass, fieldName, Reflection.getCallerClass());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AtomicIntegerFieldUpdater&lt;LongBalance&gt; updater = AtomicIntegerFieldUpdater.newUpdater(LongBalance.class, "balance");</span><br></pre></td></tr></table></figure><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><h4 id="addAndGet"><a href="#addAndGet" class="headerlink" title="addAndGet"></a>addAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//addAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先add指定数值</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.addAndGet(balance, <span class="number">2</span>));</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先对比数值</span></span><br><span class="line"><span class="comment"> * 2.匹配则进行更新</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.compareAndSet(balance, <span class="number">1002</span>, <span class="number">10003</span>));</span><br></pre></td></tr></table></figure><h4 id="decrementAndGet"><a href="#decrementAndGet" class="headerlink" title="decrementAndGet"></a>decrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//decrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行自减1</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.decrementAndGet(balance));</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line">System.out.println(updater.get(balance));</span><br></pre></td></tr></table></figure><h4 id="getAndAdd"><a href="#getAndAdd" class="headerlink" title="getAndAdd"></a>getAndAdd</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAdd</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再add指定数值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndAdd(balance, <span class="number">10</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndDecrement"><a href="#getAndDecrement" class="headerlink" title="getAndDecrement"></a>getAndDecrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndDecrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再进行自减1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndDecrement(balance));</span><br></pre></td></tr></table></figure><h4 id="getAndIncrement"><a href="#getAndIncrement" class="headerlink" title="getAndIncrement"></a>getAndIncrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndIncrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再进行自增1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndIncrement(balance));</span><br></pre></td></tr></table></figure><h4 id="getAndSet"><a href="#getAndSet" class="headerlink" title="getAndSet"></a>getAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再set指定数值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndSet(balance, <span class="number">30</span>));</span><br></pre></td></tr></table></figure><h4 id="incrementAndGet"><a href="#incrementAndGet" class="headerlink" title="incrementAndGet"></a>incrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//incrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先进行自增1</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.incrementAndGet(balance));</span><br></pre></td></tr></table></figure><h4 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;lazySet</span><br><span class="line">updater.lazySet(balance, 1);</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">updater.set(balance, <span class="number">12</span>);</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line">updater.weakCompareAndSet(balance, <span class="number">20</span>,<span class="number">21</span>);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-34-AtomicIntegerFieldUpdater详解</title>
      <link href="/2020/07/06/5002/hub/"/>
      <url>/2020/07/06/5002/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706175905031.png" alt="image-20200706175905031"></p><p>&emsp;&emsp;<strong>FieldUpdater</strong>主要是<strong>使用一种线程安全的方式去操作非线程安全对象的某些字段</strong>。</p><p>&emsp;&emsp;字段不能<strong>private</strong>修饰，并且需要<strong>volatile</strong>,具体可以看源码解析。</p><h2 id="非线程安全操作引入"><a href="#非线程安全操作引入" class="headerlink" title="非线程安全操作引入"></a>非线程安全操作引入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FieldUpdaterTest</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Balance balance = <span class="keyword">new</span> Balance();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                IntStream.range(<span class="number">0</span>,<span class="number">500</span>)</span><br><span class="line">                        .forEach(j-&gt;&#123;</span><br><span class="line">                            balance.decrement();</span><br><span class="line">                            System.out.println(balance.toString());</span><br><span class="line">                        &#125;);</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Balance</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> balance = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.balance--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Balance</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">int</span> balance = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//AtomicIntegerFieldUpdater</span></span><br><span class="line">    AtomicIntegerFieldUpdater&lt;Balance&gt; updater = AtomicIntegerFieldUpdater.newUpdater(Balance.class, "balance");</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        updater.decrementAndGet(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;上述代码肯定时存在线程安全的，常见的操作就是<strong>decrement</strong>方法加锁，那么<strong>FieldUpdater</strong>也就应运而生。</p><p>&emsp;&emsp;并且使用<strong>FieldUpdater</strong>也符合开闭原则，不影响调用方，只需要<strong>Balance</strong>本身即可。使用CAS+自旋的方式也是<strong>atomic</strong>包的核心设计理念。</p><h2 id="AtomicIntegerFieldUpdater相关API"><a href="#AtomicIntegerFieldUpdater相关API" class="headerlink" title="AtomicIntegerFieldUpdater相关API"></a>AtomicIntegerFieldUpdater相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicIntegerFieldUpdater</span>&lt;<span class="title">T</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回了一个内部实现类AtomicIntegerFieldUpdaterImpl</span></span><br><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; <span class="function">AtomicIntegerFieldUpdater&lt;U&gt; <span class="title">newUpdater</span><span class="params">(Class&lt;U&gt; tclass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                          String fieldName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AtomicIntegerFieldUpdaterImpl&lt;U&gt;</span><br><span class="line">        (tclass, fieldName, Reflection.getCallerClass());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AtomicIntegerFieldUpdater&lt;Balance&gt; updater = AtomicIntegerFieldUpdater.newUpdater(Balance.class, "balance");</span><br></pre></td></tr></table></figure><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><h4 id="addAndGet"><a href="#addAndGet" class="headerlink" title="addAndGet"></a>addAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//addAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先add指定数值</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.addAndGet(balance, <span class="number">2</span>));</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先对比数值</span></span><br><span class="line"><span class="comment"> * 2.匹配则进行更新</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.compareAndSet(balance, <span class="number">1002</span>, <span class="number">10003</span>));</span><br></pre></td></tr></table></figure><h4 id="decrementAndGet"><a href="#decrementAndGet" class="headerlink" title="decrementAndGet"></a>decrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//decrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行自减1</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.decrementAndGet(balance));</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line">System.out.println(updater.get(balance));</span><br></pre></td></tr></table></figure><h4 id="getAndAdd"><a href="#getAndAdd" class="headerlink" title="getAndAdd"></a>getAndAdd</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAdd</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再add指定数值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndAdd(balance, <span class="number">10</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndDecrement"><a href="#getAndDecrement" class="headerlink" title="getAndDecrement"></a>getAndDecrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndDecrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再进行自减1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndDecrement(balance));</span><br></pre></td></tr></table></figure><h4 id="getAndIncrement"><a href="#getAndIncrement" class="headerlink" title="getAndIncrement"></a>getAndIncrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndIncrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再进行自增1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndIncrement(balance));</span><br></pre></td></tr></table></figure><h4 id="getAndSet"><a href="#getAndSet" class="headerlink" title="getAndSet"></a>getAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.再set指定数值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.getAndSet(balance, <span class="number">30</span>));</span><br></pre></td></tr></table></figure><h4 id="incrementAndGet"><a href="#incrementAndGet" class="headerlink" title="incrementAndGet"></a>incrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//incrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先进行自增1</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(updater.incrementAndGet(balance));</span><br></pre></td></tr></table></figure><h4 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;lazySet</span><br><span class="line">updater.lazySet(balance, 1);</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">updater.set(balance, <span class="number">12</span>);</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line">updater.weakCompareAndSet(balance, <span class="number">20</span>,<span class="number">21</span>);</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="对象的创建"><a href="#对象的创建" class="headerlink" title="对象的创建"></a>对象的创建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; <span class="function">AtomicIntegerFieldUpdater&lt;U&gt; <span class="title">newUpdater</span><span class="params">(Class&lt;U&gt; tclass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                          String fieldName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//都由AtomicIntegerFieldUpdaterImpl去实现</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AtomicIntegerFieldUpdaterImpl&lt;U&gt;</span><br><span class="line">        (tclass, fieldName, Reflection.getCallerClass());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Unsafe实例</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe U = sun.misc.Unsafe.getUnsafe();</span><br><span class="line"><span class="comment">//偏移量计数器</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> offset;</span><br><span class="line"><span class="comment">//如果字段受保护，子类构造这个更新器，否则和tclass一样</span></span><br><span class="line"><span class="comment">//cclass记录的是子类类名</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; cclass;</span><br><span class="line"><span class="comment">//含有目标字段的类的类类型</span></span><br><span class="line"><span class="comment">//cclass tclass两个字段主要用于校验是否能够进行更新</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; tclass;</span><br></pre></td></tr></table></figure><h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">AtomicIntegerFieldUpdaterImpl(<span class="keyword">final</span> Class&lt;T&gt; tclass,</span><br><span class="line">                              <span class="keyword">final</span> String fieldName,</span><br><span class="line">                              <span class="keyword">final</span> Class&lt;?&gt; caller) &#123;</span><br><span class="line">    <span class="comment">//指定的字段</span></span><br><span class="line">    <span class="keyword">final</span> Field field;</span><br><span class="line">    <span class="comment">//字段修饰符</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> modifiers;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//安全检查获取field</span></span><br><span class="line">        field = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> PrivilegedExceptionAction&lt;Field&gt;() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> Field <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> tclass.getDeclaredField(fieldName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="comment">//获取字段修饰符</span></span><br><span class="line">        modifiers = field.getModifiers();</span><br><span class="line">        <span class="comment">//权限校验，参数校验，修饰符校验等</span></span><br><span class="line">        sun.reflect.misc.ReflectUtil.ensureMemberAccess(</span><br><span class="line">            caller, tclass, <span class="keyword">null</span>, modifiers);</span><br><span class="line">        <span class="comment">//目标类记载器</span></span><br><span class="line">        ClassLoader cl = tclass.getClassLoader();</span><br><span class="line">        <span class="comment">//调用类加载器</span></span><br><span class="line">        ClassLoader ccl = caller.getClassLoader();</span><br><span class="line">        <span class="comment">//目标类和调用类不能是同一个加载器</span></span><br><span class="line">        <span class="comment">//调用类不能是根加载器</span></span><br><span class="line">        <span class="keyword">if</span> ((ccl != <span class="keyword">null</span>) &amp;&amp; (ccl != cl) &amp;&amp;</span><br><span class="line">            <span class="comment">//没有委托链关系</span></span><br><span class="line">            ((cl == <span class="keyword">null</span>) || !isAncestor(cl, ccl))) &#123;</span><br><span class="line">            <span class="comment">//目标类包权限检验</span></span><br><span class="line">            sun.reflect.misc.ReflectUtil.checkPackageAccess(tclass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PrivilegedActionException pae) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(pae.getException());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//字段类型校验</span></span><br><span class="line">    <span class="keyword">if</span> (field.getType() != <span class="keyword">int</span><span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">        throw new IllegalArgumentException("Must be integer type");</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否具有volatile</span></span><br><span class="line">    <span class="keyword">if</span> (!Modifier.isVolatile(modifiers))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Must be volatile type"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Access to protected field members is restricted to receivers only</span></span><br><span class="line">    <span class="comment">// of the accessing class, or one of its subclasses, and the</span></span><br><span class="line">    <span class="comment">// accessing class must in turn be a subclass (or package sibling)</span></span><br><span class="line">    <span class="comment">// of the protected member's defining class.</span></span><br><span class="line">    <span class="comment">// If the updater refers to a protected field of a declaring class</span></span><br><span class="line">    <span class="comment">// outside the current package, the receiver argument will be</span></span><br><span class="line">    <span class="comment">// narrowed to the type of the accessing class.</span></span><br><span class="line">    <span class="keyword">this</span>.cclass = (Modifier.isProtected(modifiers) &amp;&amp;</span><br><span class="line">                   tclass.isAssignableFrom(caller) &amp;&amp;</span><br><span class="line">                   !isSamePackage(tclass, caller))</span><br><span class="line">        ? caller : tclass;</span><br><span class="line">    <span class="keyword">this</span>.tclass = tclass;</span><br><span class="line">    <span class="keyword">this</span>.offset = U.objectFieldOffset(field);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="isAncestor"><a href="#isAncestor" class="headerlink" title="isAncestor"></a>isAncestor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查找类加载器委托链</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAncestor</span><span class="params">(ClassLoader first, ClassLoader second)</span> </span>&#123;</span><br><span class="line">    ClassLoader acl = first;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        acl = acl.getParent();</span><br><span class="line">        <span class="keyword">if</span> (second == acl) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (acl != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="isSamePackage"><a href="#isSamePackage" class="headerlink" title="isSamePackage"></a>isSamePackage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断是否具有相同的类加载和包限定符</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSamePackage</span><span class="params">(Class&lt;?&gt; class1, Class&lt;?&gt; class2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> class1.getClassLoader() == class2.getClassLoader()</span><br><span class="line">        &amp;&amp; Objects.equals(getPackageName(class1), getPackageName(class2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getPackageName"><a href="#getPackageName" class="headerlink" title="getPackageName"></a>getPackageName</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取类全名</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getPackageName</span><span class="params">(Class&lt;?&gt; cls)</span> </span>&#123;</span><br><span class="line">    String cn = cls.getName();</span><br><span class="line">    <span class="keyword">int</span> dot = cn.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">    <span class="keyword">return</span> (dot != -<span class="number">1</span>) ? cn.substring(<span class="number">0</span>, dot) : <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    PUBLIC: 1</span></span><br><span class="line"><span class="comment">//    PRIVATE: 2</span></span><br><span class="line"><span class="comment">//    PROTECTED: 4</span></span><br><span class="line"><span class="comment">//    STATIC: 8</span></span><br><span class="line"><span class="comment">//    FINAL: 16</span></span><br><span class="line"><span class="comment">//    SYNCHRONIZED: 32</span></span><br><span class="line"><span class="comment">//    VOLATILE: 64</span></span><br><span class="line"><span class="comment">//    TRANSIENT: 128</span></span><br><span class="line"><span class="comment">//    NATIVE: 256</span></span><br><span class="line"><span class="comment">//    INTERFACE: 512</span></span><br><span class="line"><span class="comment">//    ABSTRACT: 1024</span></span><br><span class="line"><span class="comment">//    STRICT: 2048</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-33-AtomicReferenceArray详解</title>
      <link href="/2020/07/06/13912/hub/"/>
      <url>/2020/07/06/13912/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706175515033.png" alt="image-20200706175515033"></p><h2 id="AtomicReferenceArray相关API"><a href="#AtomicReferenceArray相关API" class="headerlink" title="AtomicReferenceArray相关API"></a>AtomicReferenceArray相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implements java.io.Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line"><span class="comment">//初始化AtomicReferenceArray数组长度</span></span><br><span class="line">AtomicReferenceArray&lt;String&gt; a1 = <span class="keyword">new</span> AtomicReferenceArray(<span class="number">1</span>);</span><br><span class="line">String[] arra2 = &#123;<span class="string">"a1"</span>, <span class="string">"a2"</span>&#125;;</span><br><span class="line">AtomicReferenceArray&lt;String&gt; a2 = <span class="keyword">new</span> AtomicReferenceArray(arra2);</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="accumulateAndGet"><a href="#accumulateAndGet" class="headerlink" title="accumulateAndGet"></a>accumulateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//accumulateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先指定索引处的数据执行BinaryOperator函数操作</span></span><br><span class="line"><span class="comment"> * 2.在获取操作后的数据</span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line">AtomicReferenceArray&lt;String&gt; array = <span class="keyword">new</span> AtomicReferenceArray(array1);</span><br><span class="line">array.accumulateAndGet(<span class="number">0</span>, <span class="string">"x"</span>, (x, y) -&gt; x + y);</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先使用索引处对应的数据对比预期值</span></span><br><span class="line"><span class="comment"> * 2.匹配成功则执行更改数据操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.compareAndSet(<span class="number">0</span>, <span class="string">"a1x"</span>, <span class="string">"a1y"</span>));</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取指定索引处的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndAccumulate"><a href="#getAndAccumulate" class="headerlink" title="getAndAccumulate"></a>getAndAccumulate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAccumulate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get指定索引处的数据</span></span><br><span class="line"><span class="comment"> * 2.再执行BinaryOperator函数操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndAccumulate(<span class="number">0</span>, <span class="string">"x"</span>, (x, y) -&gt; x + y));</span><br></pre></td></tr></table></figure><h4 id="getAndSet"><a href="#getAndSet" class="headerlink" title="getAndSet"></a>getAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get指定索引处的数据</span></span><br><span class="line"><span class="comment"> * 2.再set指定数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndSet(<span class="number">0</span>, <span class="string">"a3"</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndUpdate"><a href="#getAndUpdate" class="headerlink" title="getAndUpdate"></a>getAndUpdate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndUpdate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get指定索引处的数据</span></span><br><span class="line"><span class="comment"> * 2.再执行UnaryOperator函数操作数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndUpdate(<span class="number">0</span>, x -&gt; x.toLowerCase()));</span><br></pre></td></tr></table></figure><h4 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lazySet</span></span><br><span class="line">array.lazySet(<span class="number">0</span>, <span class="string">"sanmengcc"</span>);</span><br></pre></td></tr></table></figure><h4 id="length"><a href="#length" class="headerlink" title="length"></a>length</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//length</span></span><br><span class="line">System.out.println(array.length());</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">array.set(<span class="number">0</span>,<span class="string">"sanmengcc-1"</span>);</span><br></pre></td></tr></table></figure><h4 id="updateAndGet"><a href="#updateAndGet" class="headerlink" title="updateAndGet"></a>updateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//updateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.使用索引处的数据执行UnaryOperator函数</span></span><br><span class="line"><span class="comment"> * 2.再获取操作后的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.updateAndGet(<span class="number">0</span>, x -&gt; x + <span class="string">"_sanmengcc"</span>));</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line">System.out.println(array.weakCompareAndSet(<span class="number">0</span>,<span class="string">"sanmengcc"</span>,<span class="string">"sanmegcc-2"</span>));</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;其实<strong>AtomicReferenceArray</strong>和数字类型操作都是类似的，包括索引和偏移量的计算，所以这里仅仅给出方法的使用demo。具体的源码可以自行下去分析，不过这几种Array类型都是大同小异的。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-32-AtomicLongArray详解</title>
      <link href="/2020/07/06/7979/hub/"/>
      <url>/2020/07/06/7979/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706175601440.png" alt="image-20200706175601440"></p><p>&emsp;&emsp;由于<strong>AtomicIntegerArray</strong>和<strong>AtomicLongArray</strong>基本类似只是数组类型不同而已，所以这里也不详细说明了。会使用<strong>AtomicIntegerArray</strong>就会使用<strong>AtomicLongArray</strong>。</p><h2 id="AtomicLongArray相关API"><a href="#AtomicLongArray相关API" class="headerlink" title="AtomicLongArray相关API"></a>AtomicLongArray相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implements java.io.Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">AtomicLongArray a1 = <span class="keyword">new</span> AtomicLongArray(<span class="number">1</span>);</span><br><span class="line">System.out.println(a1.get(<span class="number">0</span>));</span><br><span class="line"><span class="keyword">long</span>[] a3 = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">AtomicLongArray a2 = <span class="keyword">new</span> AtomicLongArray(a3);</span><br><span class="line">System.out.println(a2.get(<span class="number">0</span>));</span><br><span class="line">System.out.println(a2.get(<span class="number">1</span>));</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="accumulateAndGet"><a href="#accumulateAndGet" class="headerlink" title="accumulateAndGet"></a>accumulateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//accumulateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.第一个参数为array对应的索引</span></span><br><span class="line"><span class="comment"> * 2.第二个参数为传入的操作值</span></span><br><span class="line"><span class="comment"> * 3.第三个参数为IntBinaryOperator操作函数</span></span><br><span class="line"><span class="comment"> * 4.使用索引i位置上的数据进行IntBinaryOperator函数操作</span></span><br><span class="line"><span class="comment"> * 5.再执行get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">AtomicLongArray array = <span class="keyword">new</span> AtomicLongArray(<span class="number">1</span>);</span><br><span class="line">array.accumulateAndGet(<span class="number">0</span>, <span class="number">2</span>, (x, y) -&gt; x + y);</span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="addAndGet"><a href="#addAndGet" class="headerlink" title="addAndGet"></a>addAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//addAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.第一个参数为array对应的索引</span></span><br><span class="line"><span class="comment"> * 2.索引对应的值进行add操作</span></span><br><span class="line"><span class="comment"> * 5.再执行get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.addAndGet(<span class="number">0</span>, <span class="number">10</span>));</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.第一个参数为array对应的索引</span></span><br><span class="line"><span class="comment"> * 2.索引对应的值进行对比</span></span><br><span class="line"><span class="comment"> * 5.如果对比成功再执行update操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.compareAndSet(<span class="number">0</span>, <span class="number">12</span>, <span class="number">20</span>));</span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="decrementAndGet"><a href="#decrementAndGet" class="headerlink" title="decrementAndGet"></a>decrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//decrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.针对索引处的值进行自减1操作</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.decrementAndGet(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 获取指定索引上的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndAccumulate"><a href="#getAndAccumulate" class="headerlink" title="getAndAccumulate"></a>getAndAccumulate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAccumulate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先获取指定索引上的值</span></span><br><span class="line"><span class="comment"> * 2.执行IntBinaryOperator函数操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndAccumulate(<span class="number">0</span>, <span class="number">10</span>, (x, y) -&gt; x - y));</span><br></pre></td></tr></table></figure><h4 id="getAndAdd"><a href="#getAndAdd" class="headerlink" title="getAndAdd"></a>getAndAdd</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAdd</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get然后add指定数值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndAdd(<span class="number">0</span>, <span class="number">10</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndDecrement"><a href="#getAndDecrement" class="headerlink" title="getAndDecrement"></a>getAndDecrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndDecrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get指定索引处的数值然后进行自减1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndDecrement(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndIncrement"><a href="#getAndIncrement" class="headerlink" title="getAndIncrement"></a>getAndIncrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndIncrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get指定索引处的数值然后进行自增1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndIncrement(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndSet"><a href="#getAndSet" class="headerlink" title="getAndSet"></a>getAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get执行索引处的值人，然后set一个指定的数值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndSet(<span class="number">0</span>, <span class="number">20</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndUpdate"><a href="#getAndUpdate" class="headerlink" title="getAndUpdate"></a>getAndUpdate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndUpdate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get指定索引处的值</span></span><br><span class="line"><span class="comment"> * 2.再执行IntUnaryOperator函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndUpdate(<span class="number">0</span>, x -&gt; x - <span class="number">20</span>));</span><br></pre></td></tr></table></figure><h4 id="incrementAndGet"><a href="#incrementAndGet" class="headerlink" title="incrementAndGet"></a>incrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//incrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先对指定索引处的值自增1</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.incrementAndGet(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lazySet</span></span><br><span class="line">array.lazySet(<span class="number">0</span>, <span class="number">1000</span>);</span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="length"><a href="#length" class="headerlink" title="length"></a>length</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//length</span></span><br><span class="line">System.out.println(array.length());</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">array.set(<span class="number">0</span>, <span class="number">200</span>);</span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="updateAndGet"><a href="#updateAndGet" class="headerlink" title="updateAndGet"></a>updateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//updateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先将指定索引处的值执行IntUnaryOperator函数</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.updateAndGet(<span class="number">0</span>, x -&gt; x + <span class="number">100</span>));</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line">System.out.println(array.weakCompareAndSet(<span class="number">0</span>, <span class="number">10</span>, <span class="number">20</span>));</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-31-AtomicIntegerArray详解</title>
      <link href="/2020/07/06/40153/hub/"/>
      <url>/2020/07/06/40153/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706175629312.png" alt="image-20200706175629312"></p><h2 id="AtomicIntegerArray相关API"><a href="#AtomicIntegerArray相关API" class="headerlink" title="AtomicIntegerArray相关API"></a>AtomicIntegerArray相关API</h2><h3 id="类声明s"><a href="#类声明s" class="headerlink" title="类声明ß"></a>类声明ß</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implements java.io.Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">AtomicIntegerArray a1 = <span class="keyword">new</span> AtomicIntegerArray(<span class="number">1</span>);</span><br><span class="line">System.out.println(a1.get(<span class="number">0</span>));</span><br><span class="line"><span class="keyword">int</span>[] a3 = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">AtomicIntegerArray a2 = <span class="keyword">new</span> AtomicIntegerArray(a3);</span><br><span class="line">System.out.println(a2.get(<span class="number">0</span>));</span><br><span class="line">System.out.println(a2.get(<span class="number">1</span>));</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="accumulateAndGet"><a href="#accumulateAndGet" class="headerlink" title="accumulateAndGet"></a>accumulateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//accumulateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.第一个参数为array对应的索引</span></span><br><span class="line"><span class="comment"> * 2.第二个参数为传入的操作值</span></span><br><span class="line"><span class="comment"> * 3.第三个参数为IntBinaryOperator操作函数</span></span><br><span class="line"><span class="comment"> * 4.使用索引i位置上的数据进行IntBinaryOperator函数操作</span></span><br><span class="line"><span class="comment"> * 5.再执行get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">AtomicIntegerArray array = <span class="keyword">new</span> AtomicIntegerArray(<span class="number">1</span>);</span><br><span class="line">array.accumulateAndGet(<span class="number">0</span>, <span class="number">2</span>, (x, y) -&gt; x + y);</span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="addAndGet"><a href="#addAndGet" class="headerlink" title="addAndGet"></a>addAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//addAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.第一个参数为array对应的索引</span></span><br><span class="line"><span class="comment"> * 2.索引对应的值进行add操作</span></span><br><span class="line"><span class="comment"> * 5.再执行get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.addAndGet(<span class="number">0</span>, <span class="number">10</span>));</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.第一个参数为array对应的索引</span></span><br><span class="line"><span class="comment"> * 2.索引对应的值进行对比</span></span><br><span class="line"><span class="comment"> * 5.如果对比成功再执行update操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.compareAndSet(<span class="number">0</span>, <span class="number">12</span>, <span class="number">20</span>));</span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="decrementAndGet"><a href="#decrementAndGet" class="headerlink" title="decrementAndGet"></a>decrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//decrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.针对索引处的值进行自减1操作</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.decrementAndGet(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 获取指定索引上的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndAccumulate"><a href="#getAndAccumulate" class="headerlink" title="getAndAccumulate"></a>getAndAccumulate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAccumulate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先获取指定索引上的值</span></span><br><span class="line"><span class="comment"> * 2.执行IntBinaryOperator函数操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndAccumulate(<span class="number">0</span>, <span class="number">10</span>, (x, y) -&gt; x - y));</span><br></pre></td></tr></table></figure><h4 id="getAndAdd"><a href="#getAndAdd" class="headerlink" title="getAndAdd"></a>getAndAdd</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAdd</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get然后add指定数值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndAdd(<span class="number">0</span>, <span class="number">10</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndDecrement"><a href="#getAndDecrement" class="headerlink" title="getAndDecrement"></a>getAndDecrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndDecrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get指定索引处的数值然后进行自减1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndDecrement(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndIncrement"><a href="#getAndIncrement" class="headerlink" title="getAndIncrement"></a>getAndIncrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndIncrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get指定索引处的数值然后进行自增1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndIncrement(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndSet"><a href="#getAndSet" class="headerlink" title="getAndSet"></a>getAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get执行索引处的值人，然后set一个指定的数值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndSet(<span class="number">0</span>, <span class="number">20</span>));</span><br></pre></td></tr></table></figure><h4 id="getAndUpdate"><a href="#getAndUpdate" class="headerlink" title="getAndUpdate"></a>getAndUpdate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndUpdate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get指定索引处的值</span></span><br><span class="line"><span class="comment"> * 2.再执行IntUnaryOperator函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.getAndUpdate(<span class="number">0</span>, x -&gt; x - <span class="number">20</span>));</span><br></pre></td></tr></table></figure><h4 id="incrementAndGet"><a href="#incrementAndGet" class="headerlink" title="incrementAndGet"></a>incrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//incrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先对指定索引处的值自增1</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.incrementAndGet(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lazySet</span></span><br><span class="line">array.lazySet(<span class="number">0</span>, <span class="number">1000</span>);</span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="length"><a href="#length" class="headerlink" title="length"></a>length</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//length</span></span><br><span class="line">System.out.println(array.length());</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">array.set(<span class="number">0</span>, <span class="number">200</span>);</span><br><span class="line">System.out.println(array.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h4 id="updateAndGet"><a href="#updateAndGet" class="headerlink" title="updateAndGet"></a>updateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//updateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先将指定索引处的值执行IntUnaryOperator函数</span></span><br><span class="line"><span class="comment"> * 2.再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(array.updateAndGet(<span class="number">0</span>, x -&gt; x + <span class="number">100</span>));</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line">System.out.println(array.weakCompareAndSet(<span class="number">0</span>, <span class="number">10</span>, <span class="number">20</span>));</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//数组中相邻元素的地址偏移量的位移表示形式(若shift=x，那么相邻元素的偏移量就是"1&lt;&lt;shift")</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> shift;</span><br><span class="line"><span class="comment">//存放数据的数组</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>[] array;</span><br><span class="line"><span class="comment">//返回指定类型数组的第一个元素地址相对于数组起始地址的偏移值</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> base = unsafe.arrayBaseOffset(<span class="keyword">int</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure><h3 id="静态域"><a href="#静态域" class="headerlink" title="静态域"></a>静态域</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">//返回指定类型数组的元素所占用的字节数。比如int[]数组中的每个int元素占用4个字节，就返回4</span></span><br><span class="line">    <span class="keyword">int</span> scale = unsafe.arrayIndexScale(<span class="keyword">int</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"data type scale not a power of two"</span>);</span><br><span class="line">    <span class="comment">//shift = 31 - Integer.numberOfLeadingZeros(4) = 31 - 29 =2</span></span><br><span class="line">    shift = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="checkedByteOffset"><a href="#checkedByteOffset" class="headerlink" title="checkedByteOffset"></a>checkedByteOffset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//下标检查，并计算数组对象起始位置至此下标元素的偏移量</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">checkedByteOffset</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= array.length)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">"index "</span> + i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> byteOffset(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="byteOffset"><a href="#byteOffset" class="headerlink" title="byteOffset"></a>byteOffset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算偏移量</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">byteOffset</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//i*2^shift +base 即，"i*元素间距+对象头长度"</span></span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">long</span>) i &lt;&lt; shift) + base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getRaw"><a href="#getRaw" class="headerlink" title="getRaw"></a>getRaw</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//利用unsafe方法求出指定偏移位置的int值</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getRaw</span><span class="params">(<span class="keyword">long</span> offset)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> unsafe.getIntVolatile(array, offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;其实和AtomicInteger都是差不多的，仅仅是多了一个索引和偏移量的计算。通过<strong>Unsafe</strong>直接操作数组的内存地址，从而达到操作数组元素的目的。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-30-AtomicStampReference详解</title>
      <link href="/2020/07/06/50648/hub/"/>
      <url>/2020/07/06/50648/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706175842082.png" alt="image-20200706175842082"></p><h2 id="AtomicStampReference相关API"><a href="#AtomicStampReference相关API" class="headerlink" title="AtomicStampReference相关API"></a>AtomicStampReference相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicStampedReference</span>&lt;<span class="title">V</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建AtomicStampedReference对象，持有Good对象的引用，初始为null，版本为0</span></span><br><span class="line">AtomicStampedReference&lt;Good&gt; asr = <span class="keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">System.out.println(asr.getReference());</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="attemptStamp"><a href="#attemptStamp" class="headerlink" title="attemptStamp"></a>attemptStamp</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//attemptStamp</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.expectedReference期望值 == 实际值则更新版本信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">AtomicStampedReference&lt;String&gt; reference = <span class="keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="string">"a1"</span>, <span class="number">0</span>);</span><br><span class="line">reference.attemptStamp(<span class="string">"a1"</span>, <span class="number">1</span>);</span><br><span class="line">System.out.println(reference.getReference());</span><br><span class="line">System.out.println(reference.getStamp());</span><br><span class="line">reference.attemptStamp(<span class="string">"a1"</span>, reference.getStamp() + <span class="number">1</span>);</span><br><span class="line">System.out.println(reference.getReference());</span><br><span class="line">System.out.println(reference.getStamp());</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.expectedReference期望值 == 实际值则更新版本信息</span></span><br><span class="line"><span class="comment"> * 2.expectedStamp期望版本号 == 实际版本号</span></span><br><span class="line"><span class="comment"> * 3.均满足则执行set新值操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">reference.compareAndSet(<span class="string">"a1"</span>, <span class="string">"a2"</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">System.out.println(reference.getReference());</span><br><span class="line">System.out.println(reference.getStamp());</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get 返回该引用和该标志的当前值</span></span><br><span class="line">reference.compareAndSet(<span class="string">"a2"</span>, <span class="string">"a4"</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">int</span>[] stampHolder = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">System.out.println(reference.get(stampHolder));</span><br><span class="line">System.out.println(stampHolder[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure><h4 id="getReference"><a href="#getReference" class="headerlink" title="getReference"></a>getReference</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getReference 获取当前引用的值</span></span><br><span class="line">System.out.println(reference.getReference());</span><br></pre></td></tr></table></figure><h4 id="getStamp"><a href="#getStamp" class="headerlink" title="getStamp"></a>getStamp</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getStamp 获取当前的版本号</span></span><br><span class="line">System.out.println(reference.getStamp());</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">reference.set(<span class="string">"a5"</span>, <span class="number">5</span>);</span><br><span class="line">System.out.println(reference.getReference());</span><br><span class="line">System.out.println(reference.getStamp());</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line">System.out.println(reference.weakCompareAndSet(<span class="string">"a5"</span>, <span class="string">"a6"</span>, <span class="number">5</span>, <span class="number">6</span>));</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="Pair"><a href="#Pair" class="headerlink" title="Pair"></a>Pair</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//记录对象引用和时间戳信息</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *1.没有办法去修改Pair对象，只能重新构造</span></span><br><span class="line"><span class="comment"> *2.静态域需要依赖AtomicStampedReference对象存在</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//对象引用</span></span><br><span class="line">    <span class="keyword">final</span> T reference;</span><br><span class="line">    <span class="comment">//时间戳版本号</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> stamp;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Pair</span><span class="params">(T reference, <span class="keyword">int</span> stamp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.reference = reference;</span><br><span class="line">        <span class="keyword">this</span>.stamp = stamp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//静态构造函数</span></span><br><span class="line">    <span class="keyword">static</span> &lt;T&gt; <span class="function">Pair&lt;T&gt; <span class="title">of</span><span class="params">(T reference, <span class="keyword">int</span> stamp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Pair&lt;T&gt;(reference, stamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//volatile保证成员的可见性</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Pair&lt;V&gt; pair;</span><br></pre></td></tr></table></figure><h3 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//复合操作也并不具备原子性</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(<span class="keyword">int</span>[] stampHolder)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//volatile修改</span></span><br><span class="line">    Pair&lt;V&gt; pair = <span class="keyword">this</span>.pair;</span><br><span class="line">    <span class="comment">//stampHolder 使用引用传递版本号，所以只需要stampHolder长度大于1即可</span></span><br><span class="line">    stampHolder[<span class="number">0</span>] = pair.stamp;</span><br><span class="line">    <span class="keyword">return</span> pair.reference;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="compareAndSet-1"><a href="#compareAndSet-1" class="headerlink" title="compareAndSet"></a>compareAndSet</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(V   expectedReference,</span></span></span><br><span class="line"><span class="function"><span class="params">                             V   newReference,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> expectedStamp,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> newStamp)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//当前的Pair对象</span></span><br><span class="line">    Pair&lt;V&gt; current = pair;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">        <span class="comment">//对比对象引用</span></span><br><span class="line">        expectedReference == current.reference &amp;&amp;</span><br><span class="line">        <span class="comment">//对比版本号</span></span><br><span class="line">        expectedStamp == current.stamp &amp;&amp;</span><br><span class="line">        <span class="comment">//若新的引用和当前引用相同则放弃操作</span></span><br><span class="line">        <span class="comment">//否则执行casPair操作替换</span></span><br><span class="line">        ((newReference == current.reference &amp;&amp;</span><br><span class="line">          newStamp == current.stamp) ||</span><br><span class="line">         <span class="comment">//Pair.of 每次都会生成一个新的对象</span></span><br><span class="line">         <span class="comment">//如果线程切换就会导致current局部变量就和pair成员变量不匹配cas失败</span></span><br><span class="line">         casPair(current, Pair.of(newReference, newStamp)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="attemptStamp-1"><a href="#attemptStamp-1" class="headerlink" title="attemptStamp"></a>attemptStamp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">attemptStamp</span><span class="params">(V expectedReference, <span class="keyword">int</span> newStamp)</span> </span>&#123;</span><br><span class="line">    Pair&lt;V&gt; current = pair;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">        <span class="comment">//比对引用</span></span><br><span class="line">        expectedReference == current.reference &amp;&amp;</span><br><span class="line">        <span class="comment">//修改版本号</span></span><br><span class="line">        (newStamp == current.stamp ||</span><br><span class="line">         <span class="comment">//局部变量和成员变量一致时更新版本号</span></span><br><span class="line">         casPair(current, Pair.of(expectedReference, newStamp)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="casPair"><a href="#casPair" class="headerlink" title="casPair"></a>casPair</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//私有方法</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">casPair</span><span class="params">(Pair&lt;V&gt; cmp, Pair&lt;V&gt; val)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//compareAndSwapObject方法CAS更新引用</span></span><br><span class="line">    <span class="keyword">return</span> UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, pairOffset, cmp, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="解决ABA问题"><a href="#解决ABA问题" class="headerlink" title="解决ABA问题"></a>解决ABA问题</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testStamp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    AtomicStampedReference&lt;Integer&gt; atomicStampedReference = <span class="keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">int</span>[] stampHolder = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span> value = atomicStampedReference.get(stampHolder);</span><br><span class="line">        <span class="keyword">int</span> stamp = stampHolder[<span class="number">0</span>];</span><br><span class="line">        System.out.println(<span class="string">"AtomicThread-1 get value: "</span> + value + <span class="string">", stamp: "</span> + stamp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阻塞1s</span></span><br><span class="line">        LockSupport.parkNanos(<span class="number">1000000000L</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行更新操作</span></span><br><span class="line">        <span class="comment">//预期操作 reference: 1-&gt;3 stamp: 1-&gt;2</span></span><br><span class="line">        <span class="keyword">if</span> (atomicStampedReference.compareAndSet(value, <span class="number">3</span>, stamp, stamp + <span class="number">1</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"AtomicThread-1 set from "</span> + value + <span class="string">" to 3"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"AtomicThread-1 set fail!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">"AtomicThread-1"</span>).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">int</span>[] stampHolder = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">int</span> value = atomicStampedReference.get(stampHolder);</span><br><span class="line">        <span class="keyword">int</span> stamp = stampHolder[<span class="number">0</span>];</span><br><span class="line">        System.out.println(<span class="string">"AtomicThread-1 read value: "</span> + value + <span class="string">", stamp: "</span> + stamp);</span><br><span class="line">        <span class="keyword">if</span> (atomicStampedReference.compareAndSet(value, <span class="number">2</span>, stamp, stamp + <span class="number">1</span>)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"AtomicThread-1 set from "</span> + value + <span class="string">" to 2"</span>);</span><br><span class="line"></span><br><span class="line">            value = atomicStampedReference.get(stampHolder);</span><br><span class="line">            stamp = stampHolder[<span class="number">0</span>];</span><br><span class="line">            System.out.println(<span class="string">"AtomicThread-1 get value: "</span> + value + <span class="string">", stamp: "</span> + stamp);</span><br><span class="line">            <span class="comment">//预期操作 reference: 3-&gt;1 stamp: 2-&gt;3</span></span><br><span class="line">            <span class="keyword">if</span> (atomicStampedReference.compareAndSet(value, <span class="number">1</span>, stamp, stamp + <span class="number">1</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">"AtomicThread-1 set from "</span> + value + <span class="string">" to 1"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">"AtomicThread-2"</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-29-AtomicReference详解</title>
      <link href="/2020/07/05/38835/hub/"/>
      <url>/2020/07/05/38835/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706175754808.png" alt="image-20200706175754808"></p><h2 id="AtomicReference相关API"><a href="#AtomicReference相关API" class="headerlink" title="AtomicReference相关API"></a>AtomicReference相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implements java.io.Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">AtomicReference a1 = <span class="keyword">new</span> AtomicReference();</span><br><span class="line">AtomicReference&lt;String&gt; a2 = <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="string">"x"</span>);</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="accumulateAndGet"><a href="#accumulateAndGet" class="headerlink" title="accumulateAndGet"></a>accumulateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//accumulateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行BinaryOperator函数</span></span><br><span class="line"><span class="comment"> * 2.get操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Student s1 = <span class="keyword">new</span> Student(<span class="string">"s1"</span>, <span class="number">1</span>);</span><br><span class="line">Student s2 = <span class="keyword">new</span> Student(<span class="string">"s2"</span>, <span class="number">2</span>);</span><br><span class="line"><span class="comment">//accumulateAndGet</span></span><br><span class="line">AtomicReference&lt;Student&gt; reference = <span class="keyword">new</span> AtomicReference&lt;&gt;(s1);</span><br><span class="line">Student student = reference.accumulateAndGet(s2, (x, y) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (x.getAge() &gt; y.getAge()) <span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> y;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(student);</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.如果当前值 == 预期值，则以原子方式将该值设置为给定的更新值</span></span><br><span class="line"><span class="comment"> * 2.对于String变量来说,必须是对象相同才视为相同,而不是字符串的内容相同就可以相同</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">boolean</span> compareAndSet = reference.compareAndSet(s1, s2);</span><br><span class="line">System.out.println(compareAndSet);</span><br><span class="line">System.out.println(reference.get());</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line">System.out.println(reference.get());</span><br></pre></td></tr></table></figure><h4 id="getAndAccumulate"><a href="#getAndAccumulate" class="headerlink" title="getAndAccumulate"></a>getAndAccumulate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAccumulate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行get操作</span></span><br><span class="line"><span class="comment"> * 2.然后再执行BinaryOperator函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reference.getAndAccumulate(s1,(x,y)-&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span> (x.getAge() &lt; y.getAge()) <span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> y;</span><br><span class="line">&#125;));</span><br><span class="line">System.out.println(reference.get());</span><br></pre></td></tr></table></figure><h4 id="getAndSet"><a href="#getAndSet" class="headerlink" title="getAndSet"></a>getAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行get然后set一个新的对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">reference.set(s2);</span><br><span class="line">System.out.println(reference.get());</span><br></pre></td></tr></table></figure><h4 id="getAndUpdate"><a href="#getAndUpdate" class="headerlink" title="getAndUpdate"></a>getAndUpdate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndUpdate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行get</span></span><br><span class="line"><span class="comment"> * 2.再执行UnaryOperator函数操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reference.getAndUpdate((x) -&gt; &#123;</span><br><span class="line">    x.setAge(<span class="number">50</span>);</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;));</span><br><span class="line">System.out.println(reference.get());</span><br></pre></td></tr></table></figure><h4 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lazySet</span></span><br><span class="line">reference.lazySet(<span class="keyword">new</span> Student(<span class="string">"s3"</span>, <span class="number">20</span>));</span><br><span class="line">System.out.println(reference);</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">reference.set(<span class="keyword">new</span> Student(<span class="string">"s4"</span>, <span class="number">21</span>));</span><br><span class="line">System.out.println(reference.get());</span><br></pre></td></tr></table></figure><h4 id="updateAndGet"><a href="#updateAndGet" class="headerlink" title="updateAndGet"></a>updateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//updateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行UnaryOperator函数操作</span></span><br><span class="line"><span class="comment"> * 2.再执行get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(reference.updateAndGet((x) -&gt; &#123;</span><br><span class="line">    x.setAge(<span class="number">22</span>);</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line">reference.weakCompareAndSet(s1, s2);</span><br></pre></td></tr></table></figure><h2 id="并发更新多个字段"><a href="#并发更新多个字段" class="headerlink" title="并发更新多个字段"></a>并发更新多个字段</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AtomicReferenceDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AtomicReferenceDemo demo = <span class="keyword">new</span> AtomicReferenceDemo(<span class="keyword">new</span> Reference(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">long</span> millis = System.currentTimeMillis();</span><br><span class="line">                demo.atomic(<span class="keyword">new</span> Reference(millis, millis));</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Reference reference;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AtomicReference&lt;Reference&gt; atomicReference;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建器中初始化AtomicReference</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reference</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AtomicReferenceDemo</span><span class="params">(Reference reference)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.reference = reference;</span><br><span class="line">        <span class="keyword">this</span>.atomicReference = <span class="keyword">new</span> AtomicReference&lt;&gt;(reference);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">atomic</span><span class="params">(Reference reference)</span> </span>&#123;</span><br><span class="line">        Reference referenceOld;</span><br><span class="line">        Reference referenceNew;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> sequence;</span><br><span class="line">        <span class="keyword">long</span> timestamp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            referenceOld = <span class="keyword">this</span>.atomicReference.get();</span><br><span class="line">            sequence = referenceOld.getSequence();</span><br><span class="line">            sequence++;</span><br><span class="line">            timestamp = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            referenceNew = <span class="keyword">new</span> Reference(sequence, timestamp);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 比较交换</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.atomicReference.compareAndSet(referenceOld, referenceNew)) &#123;</span><br><span class="line">                reference.setSequence(sequence);</span><br><span class="line">                reference.setTimestamp(timestamp);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.reference = reference;</span><br><span class="line">        System.out.println(<span class="string">"reference = "</span> + <span class="keyword">this</span>.reference);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reference</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sequence;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> timestamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-28-AtomicLong详解</title>
      <link href="/2020/07/05/51967/hub/"/>
      <url>/2020/07/05/51967/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706175658410.png" alt="image-20200706175658410"></p><h2 id="AtomicLong相关API"><a href="#AtomicLong相关API" class="headerlink" title="AtomicLong相关API"></a>AtomicLong相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extends Number implements java.io.Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">AtomicLong a1 = <span class="keyword">new</span> AtomicLong();</span><br><span class="line">AtomicLong a2 = <span class="keyword">new</span> AtomicLong(<span class="number">1L</span>);</span><br><span class="line">System.out.println(a1);</span><br><span class="line">System.out.println(a2);</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="accumulateAndGet"><a href="#accumulateAndGet" class="headerlink" title="accumulateAndGet"></a>accumulateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//accumulateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先操作LongBinaryOperator函数</span></span><br><span class="line"><span class="comment"> * 2.后返回操作后的数据 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">LongBinaryOperator longBinaryOperator = (x, y) -&gt; x + y;</span><br><span class="line">atomicLong.accumulateAndGet(<span class="number">10L</span>, longBinaryOperator);</span><br><span class="line">System.out.println(atomicLong.get());</span><br></pre></td></tr></table></figure><h4 id="addAndGet"><a href="#addAndGet" class="headerlink" title="addAndGet"></a>addAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//addAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先进行add操作</span></span><br><span class="line"><span class="comment"> * 2.后返回操作后的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.addAndGet(<span class="number">10L</span>));</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.判断预期值 == 实际值，相等则更新</span></span><br><span class="line"><span class="comment"> * 2.返回值代表是否修改成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.compareAndSet(<span class="number">30L</span>, <span class="number">40L</span>));</span><br><span class="line">System.out.println(atomicLong.get());</span><br></pre></td></tr></table></figure><h4 id="decrementAndGet"><a href="#decrementAndGet" class="headerlink" title="decrementAndGet"></a>decrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//decrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先进行自减1操作</span></span><br><span class="line"><span class="comment"> * 2.返回自减后的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.decrementAndGet());</span><br></pre></td></tr></table></figure><h4 id="doubleValue"><a href="#doubleValue" class="headerlink" title="doubleValue"></a>doubleValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//doubleValue</span></span><br><span class="line">System.out.println(atomicLong.doubleValue());</span><br></pre></td></tr></table></figure><h4 id="floatValue"><a href="#floatValue" class="headerlink" title="floatValue"></a>floatValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//floatValue</span></span><br><span class="line">System.out.println(atomicLong.floatValue());</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line">System.out.println(atomicLong.get());</span><br></pre></td></tr></table></figure><h4 id="getAndAccumulate"><a href="#getAndAccumulate" class="headerlink" title="getAndAccumulate"></a>getAndAccumulate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAccumulate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.返回操作后的数据</span></span><br><span class="line"><span class="comment"> * 2.操作LongBinaryOperator函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.getAndAccumulate(<span class="number">20L</span>, (x, y) -&gt; x - y));</span><br><span class="line">System.out.println(atomicLong.get());</span><br></pre></td></tr></table></figure><h4 id="getAndAdd"><a href="#getAndAdd" class="headerlink" title="getAndAdd"></a>getAndAdd</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAdd</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.然后再执行add操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.getAndAdd(<span class="number">10L</span>));</span><br><span class="line">System.out.println(atomicLong.get());</span><br></pre></td></tr></table></figure><h4 id="getAndDecrement"><a href="#getAndDecrement" class="headerlink" title="getAndDecrement"></a>getAndDecrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndDecrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.然后再执行自减1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.getAndDecrement());</span><br><span class="line">System.out.println(atomicLong.get());</span><br></pre></td></tr></table></figure><h4 id="getAndIncrement"><a href="#getAndIncrement" class="headerlink" title="getAndIncrement"></a>getAndIncrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndIncrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.然后再执行自增1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.getAndIncrement());</span><br><span class="line">System.out.println(atomicLong.get());</span><br></pre></td></tr></table></figure><h4 id="getAndSet"><a href="#getAndSet" class="headerlink" title="getAndSet"></a>getAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.然后再执行set操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.getAndSet(<span class="number">200L</span>));</span><br><span class="line">System.out.println(atomicLong.get());</span><br></pre></td></tr></table></figure><h4 id="getAndUpdate"><a href="#getAndUpdate" class="headerlink" title="getAndUpdate"></a>getAndUpdate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndUpdate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get</span></span><br><span class="line"><span class="comment"> * 2.然后再执行LongUnaryOperator操作函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.getAndUpdate((x) -&gt; x - <span class="number">100</span>));</span><br><span class="line">System.out.println(atomicLong.get());</span><br></pre></td></tr></table></figure><h4 id="incrementAndGet"><a href="#incrementAndGet" class="headerlink" title="incrementAndGet"></a>incrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//incrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先自增1</span></span><br><span class="line"><span class="comment"> * 2.再获取</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.incrementAndGet());</span><br></pre></td></tr></table></figure><h4 id="intValue"><a href="#intValue" class="headerlink" title="intValue"></a>intValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//intValue</span></span><br><span class="line">System.out.println(atomicLong.intValue());</span><br></pre></td></tr></table></figure><h4 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lazySet</span></span><br><span class="line">atomicLong.lazySet(<span class="number">2000L</span>);</span><br></pre></td></tr></table></figure><h4 id="longValue"><a href="#longValue" class="headerlink" title="longValue"></a>longValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//longValue</span></span><br><span class="line">System.out.println(atomicLong.longValue());</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">atomicLong.set(<span class="number">300L</span>);</span><br></pre></td></tr></table></figure><h4 id="updateAndGet"><a href="#updateAndGet" class="headerlink" title="updateAndGet"></a>updateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//updateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行LongUnaryOperator操作函数</span></span><br><span class="line"><span class="comment"> * 2.然后再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicLong.updateAndGet((x) -&gt; x - <span class="number">200</span>));</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line">System.out.println(atomicLong.weakCompareAndSet(<span class="number">100L</span>, <span class="number">200L</span>));</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><p>&emsp;&emsp;其实AtomicLong和AtomicInteger是差不多的，并且也很简单，所以这些不进行一些分析了。不过可以说一下<strong>VMSupportsCS8</strong>。</p><h3 id="VMSupportsCS8"><a href="#VMSupportsCS8" class="headerlink" title="VMSupportsCS8"></a>VMSupportsCS8</h3><p>&emsp;&emsp;1.Long类型由数据总线等进行传输的时候，区分高位，低位传输。</p><p>&emsp;&emsp;2.在分高低位传输的时候，就不能保证原子性，这方法主要由JVM调用用来判断CPU等支持不支持<strong>lockless</strong>，然后根据不同的操作系统或者CPU进行不同的调整。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-27-AtomicBoolean详解</title>
      <link href="/2020/07/05/52828/hub/"/>
      <url>/2020/07/05/52828/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706175723523.png" alt="image-20200706175723523"></p><h2 id="AtomicBoolean相关API"><a href="#AtomicBoolean相关API" class="headerlink" title="AtomicBoolean相关API"></a>AtomicBoolean相关API</h2><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implements java.io.Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造函数</span></span><br><span class="line">AtomicBoolean a1 = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line">AtomicBoolean a2 = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">true</span>);</span><br><span class="line">AtomicBoolean a3 = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">System.out.println(a1);</span><br><span class="line">System.out.println(a2);</span><br><span class="line">System.out.println(a3);</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.如果当前值 == 预期值，则以原子方式将该值设置为给定的更新值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">AtomicBoolean atomicBoolean = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line">atomicBoolean.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">System.out.println(<span class="string">"compareAndSet="</span> + atomicBoolean.get());</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get</span></span><br><span class="line">System.out.println(atomicBoolean.get());</span><br></pre></td></tr></table></figure><h4 id="getAndSet"><a href="#getAndSet" class="headerlink" title="getAndSet"></a>getAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.获取值以后set一个新的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicBoolean.getAndSet(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure><h4 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lazySet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.加入内存屏障，避免发生写操作重排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">atomicBoolean.lazySet(<span class="keyword">true</span>);</span><br><span class="line">System.out.println(atomicBoolean.get());</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line">atomicBoolean.set(<span class="keyword">false</span>);</span><br><span class="line">System.out.println(atomicBoolean.get());</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.如果当前值 == 预期值，则以原子方式将该值设置为给定的更新值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(atomicBoolean.weakCompareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>));</span><br></pre></td></tr></table></figure><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="compareAndSet-1"><a href="#compareAndSet-1" class="headerlink" title="compareAndSet"></a>compareAndSet</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  只有当期待的值为expect的时候才会更新相关值</span></span><br><span class="line"><span class="comment"> *  1. 期待的值等于现在值，则成功赋值，返回true</span></span><br><span class="line"><span class="comment"> *  2. 期待的值不等于现在的值，则赋值失败，则返回false </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">compareAndSet</span><span class="params">(<span class="keyword">boolean</span> expect, <span class="keyword">boolean</span> update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> e = expect ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> u = update ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, valueOffset, e, u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getAndSet-1"><a href="#getAndSet-1" class="headerlink" title="getAndSet"></a>getAndSet</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *1.获取当前值</span></span><br><span class="line"><span class="comment"> *2.不断进行compareAndSet CAS操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">getAndSet</span><span class="params">(<span class="keyword">boolean</span> newValue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> prev;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        prev = get();</span><br><span class="line">    &#125; <span class="keyword">while</span> (!compareAndSet(prev, newValue));</span><br><span class="line">    <span class="keyword">return</span> prev;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 源码深入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信开发-小程序-常用API-04-二维码系列</title>
      <link href="/2020/07/03/21590/hub/"/>
      <url>/2020/07/03/21590/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200630214111532.png" alt="image-20200630214111532"></p><h2 id="File工具类"><a href="#File工具类" class="headerlink" title="File工具类"></a>File工具类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">byte2File</span><span class="params">(<span class="keyword">byte</span>[] bytes,String paths)</span></span>&#123;</span><br><span class="line">    Path path = Paths.get(paths);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Files.write(path, bytes);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="限量简单获取二维码"><a href="#限量简单获取二维码" class="headerlink" title="限量简单获取二维码"></a>限量简单获取二维码</h2><p><img src="/image/hexo/image-20200703092919591.png" alt="image-20200703092919591"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getWxMiniQr1();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 创建小程序二维码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/3 9:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getWxMiniQr1() &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"https://api.weixin.qq.com/cgi-bin/wxaapp/createwxaqrcode?access_token="</span> + accessToken);</span><br><span class="line">        HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();</span><br><span class="line">        httpURLConnection.setRequestMethod(<span class="string">"POST"</span>);</span><br><span class="line">        httpURLConnection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">        httpURLConnection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">        PrintWriter printWriter = <span class="keyword">new</span> PrintWriter(httpURLConnection.getOutputStream());</span><br><span class="line">        JSONObject paramJson = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        paramJson.put(<span class="string">"path"</span>, <span class="string">"pages/welcome/welcome?page=1"</span>);</span><br><span class="line">        paramJson.put(<span class="string">"width"</span>, <span class="string">"430"</span>);</span><br><span class="line"></span><br><span class="line">        printWriter.write(paramJson.toString());</span><br><span class="line">        printWriter.flush();</span><br><span class="line">        InputStream inputStream = httpURLConnection.getInputStream();</span><br><span class="line">        <span class="comment">//不要使用input来读取数组</span></span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> ((len = inputStream.read(data)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            out.write(data, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(inputStream!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = out.toByteArray();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(bytes, <span class="string">"UTF-8"</span>));</span><br><span class="line">        FileUtil.byte2File(bytes, <span class="string">"sanmengcc002.png"</span>);</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="限量复杂获取二维码"><a href="#限量复杂获取二维码" class="headerlink" title="限量复杂获取二维码"></a>限量复杂获取二维码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getWxMiniQr2();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 创建小程序二维码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/3 9:33</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getWxMiniQr2() &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"https://api.weixin.qq.com/wxa/getwxacode?access_token="</span> + accessToken);</span><br><span class="line">        HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();</span><br><span class="line">        httpURLConnection.setRequestMethod(<span class="string">"POST"</span>);</span><br><span class="line">        httpURLConnection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">        httpURLConnection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">        PrintWriter printWriter = <span class="keyword">new</span> PrintWriter(httpURLConnection.getOutputStream());</span><br><span class="line">        JSONObject paramJson = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        paramJson.put(<span class="string">"path"</span>, <span class="string">"pages/welcome/welcome?page=1"</span>);</span><br><span class="line">        paramJson.put(<span class="string">"width"</span>, <span class="string">"430"</span>);</span><br><span class="line">        paramJson.put(<span class="string">"auto_color"</span>, <span class="keyword">true</span>);</span><br><span class="line">        paramJson.put(<span class="string">"is_hyaline"</span>, <span class="keyword">true</span>);</span><br><span class="line">        paramJson.put(<span class="string">"line_color"</span>, <span class="keyword">new</span> JSONObject()&#123;&#123;</span><br><span class="line">            put(<span class="string">"r"</span>, <span class="string">"0"</span>);</span><br><span class="line">            put(<span class="string">"g"</span>, <span class="string">"0"</span>);</span><br><span class="line">            put(<span class="string">"b"</span>, <span class="string">"0"</span>);</span><br><span class="line">        &#125;&#125;);</span><br><span class="line">        printWriter.write(paramJson.toString());</span><br><span class="line">        printWriter.flush();</span><br><span class="line">        InputStream inputStream = httpURLConnection.getInputStream();</span><br><span class="line">        <span class="comment">//不要使用input来读取数组</span></span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> ((len = inputStream.read(data)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            out.write(data, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(inputStream!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = out.toByteArray();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(bytes, <span class="string">"UTF-8"</span>));</span><br><span class="line">        FileUtil.byte2File(bytes, <span class="string">"sanmengcc002.png"</span>);</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="无限数量获取二维码"><a href="#无限数量获取二维码" class="headerlink" title="无限数量获取二维码"></a>无限数量获取二维码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getWxMiniQr3();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 创建小程序二维码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Date</span>   2020/7/3 9:33</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getWxMiniQr3() &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token="</span> + accessToken);</span><br><span class="line">        HttpURLConnection httpURLConnection = (HttpURLConnection) url.openConnection();</span><br><span class="line">        httpURLConnection.setRequestMethod(<span class="string">"POST"</span>);</span><br><span class="line">        httpURLConnection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">        httpURLConnection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">        PrintWriter printWriter = <span class="keyword">new</span> PrintWriter(httpURLConnection.getOutputStream());</span><br><span class="line">        JSONObject paramJson = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        paramJson.put(<span class="string">"path"</span>, <span class="string">"pages/welcome/welcome?page=1"</span>);</span><br><span class="line">        paramJson.put(<span class="string">"width"</span>, <span class="string">"430"</span>);</span><br><span class="line">        paramJson.put(<span class="string">"scene"</span>, <span class="string">"WX00001"</span>);</span><br><span class="line">        paramJson.put(<span class="string">"auto_color"</span>, <span class="keyword">true</span>);</span><br><span class="line">        paramJson.put(<span class="string">"is_hyaline"</span>, <span class="keyword">true</span>);</span><br><span class="line">        paramJson.put(<span class="string">"line_color"</span>, <span class="keyword">new</span> JSONObject()&#123;&#123;</span><br><span class="line">            put(<span class="string">"r"</span>, <span class="string">"0"</span>);</span><br><span class="line">            put(<span class="string">"g"</span>, <span class="string">"0"</span>);</span><br><span class="line">            put(<span class="string">"b"</span>, <span class="string">"0"</span>);</span><br><span class="line">        &#125;&#125;);</span><br><span class="line">        printWriter.write(paramJson.toString());</span><br><span class="line">        printWriter.flush();</span><br><span class="line">        InputStream inputStream = httpURLConnection.getInputStream();</span><br><span class="line">        <span class="comment">//不要使用input来读取数组</span></span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> ((len = inputStream.read(data)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            out.write(data, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(inputStream!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = out.toByteArray();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(bytes, <span class="string">"UTF-8"</span>));</span><br><span class="line">        FileUtil.byte2File(bytes, <span class="string">"sanmengcc002.png"</span>);</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.小程序提供了三种获取二维码的方式，大多数情况都是需要无限数量的二维码，那么上面两种我就忽略掉了。</p><p>&emsp;&emsp;2.无限数量二维码接口的弊端：有时候我们想在二维码放置大量的参数，那么一个用户ID就其实已经超出了<strong>scene</strong>字段的长度了，【最大32个可见字符，只支持数字，大小写英文以及部分特殊字符】。因为本身字段限制的原因那么很多业务将无法实现。</p><p>&emsp;&emsp;3.不管怎么样也只能从<strong>scene</strong>字段入口了，那么只能该字段作为一个编码，后台提供业务支撑。小程序使用该编码从后台提供的接口获取所需要的业务参数，那么这样业务字段就可以由后台去控制，理论是可以做到无限了，目前我也是采用这种方式实现的。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 微信 </category>
          
          <category> 小程序 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 微信 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringDataJpa-对象属性变化追踪</title>
      <link href="/2020/07/02/42708/hub/"/>
      <url>/2020/07/02/42708/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200702215532021.png" alt="image-20200702215532021"></p><h2 id="EntityListeners注解"><a href="#EntityListeners注解" class="headerlink" title="EntityListeners注解"></a>EntityListeners注解</h2><p>&emsp;&emsp;主要提供了对象变化的一个拦截器的作用。一般用于数据库操作对象层（PO）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"t_sy_user"</span>)</span><br><span class="line"><span class="meta">@EntityListeners</span>(JpaInterceptor<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SyUserPo</span> <span class="keyword">extends</span> <span class="title">BaseValue</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** 版本号 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4600316154275234235L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 主键ID */</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 关联客户全局唯一标识Id */</span></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"cust_global_id"</span>, nullable = <span class="keyword">true</span>, length = <span class="number">50</span>)</span><br><span class="line">    <span class="keyword">private</span> String custGlobalId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>JpaInterceptor</strong>是我们自定义的一个对象。</p><h2 id="JpaInterceptor"><a href="#JpaInterceptor" class="headerlink" title="JpaInterceptor"></a>JpaInterceptor</h2><p>&emsp;&emsp;可以在里面进行拦截器一样的操作，例如：操作痕迹、日志记录等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PrePersist</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PrePersist</span><span class="params">(Object entity)</span></span>&#123;</span><br><span class="line">        String className = entity.getClass().getName();</span><br><span class="line">        System.out.println(<span class="string">"className="</span> + className);</span><br><span class="line">        System.out.println(<span class="string">"开始保存--"</span>+entity.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostPersist</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PostPersist</span><span class="params">(Object entity)</span></span>&#123;</span><br><span class="line">        String className = entity.getClass().getName();</span><br><span class="line">        System.out.println(<span class="string">"className="</span> + className);</span><br><span class="line">        System.out.println(<span class="string">"结束保存--"</span>+entity.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreUpdate</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PreUpdate</span><span class="params">(Object entity)</span></span>&#123;</span><br><span class="line">        String className = entity.getClass().getName();</span><br><span class="line">        System.out.println(<span class="string">"className="</span> + className);</span><br><span class="line">        System.out.println(<span class="string">"开始更新--"</span>+entity.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostUpdate</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">PostUpdate</span><span class="params">(Object entity)</span></span>&#123;</span><br><span class="line">        String className = entity.getClass().getName();</span><br><span class="line">        System.out.println(<span class="string">"className="</span> + className);</span><br><span class="line">        System.out.println(<span class="string">"结束更新--"</span>+entity.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreRemove</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preRemove</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">        String className = entity.getClass().getName();</span><br><span class="line">        System.out.println(<span class="string">"className="</span> + className);</span><br><span class="line">        System.out.println(<span class="string">"del之前的操作"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostRemove</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postRemove</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">        String className = entity.getClass().getName();</span><br><span class="line">        System.out.println(<span class="string">"className="</span> + className);</span><br><span class="line">        System.out.println(<span class="string">"del之后的操作"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="EnableJpaAuditing注解开启"><a href="#EnableJpaAuditing注解开启" class="headerlink" title="EnableJpaAuditing注解开启"></a>EnableJpaAuditing注解开启</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableJpaAuditing</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;完成以上的步骤就可以开启对象追踪之旅了。值得注意的是如果保存的时候和数据库数据一致那么就不会进入<strong>JpaInterceptor</strong>。更多的使用方法值得你慢慢去探索。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> SpringBoot </category>
          
          <category> SpringDataJpa </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 工具 </tag>
            
            <tag> SpringDataJpa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java工具-Druid SQL解析器抽取</title>
      <link href="/2020/07/02/64031/hub/"/>
      <url>/2020/07/02/64031/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200702213205428.png" alt="image-20200702213205428"></p><h2 id="抽取背景"><a href="#抽取背景" class="headerlink" title="抽取背景"></a>抽取背景</h2><p>&emsp;&emsp;最近在项目中需要记录SQL影响的痕迹，考虑到很多会引起业务的入侵，所以考虑从SQL层面去解决这个问题，那么使用<strong>mybatis</strong>框架的就会涉及到SQL的解析问题，最终选择了阿里巴巴开源的<strong>Druid</strong>，但是由于目前项目并不是采用的<strong>Druid</strong>，仅仅只是需要它的SQL解析器部分，所以才有了从中拆分出SQL解析器模块的想法。</p><p>&emsp;&emsp;至于<strong>SpringDataJpa</strong>框架，可以采用对象监听的方式去实现，相比较于<strong>Mybatis</strong>更加的简单。将在另外的文章中去简单介绍。</p><h2 id="Druid源码"><a href="#Druid源码" class="headerlink" title="Druid源码"></a>Druid源码</h2><h3 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h3><p><a href="https://github.com/alibaba/druid.git" target="_blank" rel="noopener">Github</a></p><h3 id="源码结构"><a href="#源码结构" class="headerlink" title="源码结构"></a>源码结构</h3><p><img src="/image/hexo/image-20200702214520176.png" alt="image-20200702214520176"></p><h2 id="暴力删减源码"><a href="#暴力删减源码" class="headerlink" title="暴力删减源码"></a>暴力删减源码</h2><h3 id="删减后源码结构"><a href="#删减后源码结构" class="headerlink" title="删减后源码结构"></a>删减后源码结构</h3><p><img src="/image/hexo/image-20200702214616226.png" alt="image-20200702214616226"></p><p>&emsp;&emsp;暴力删减源码也没什么可说的，主要的核心在<strong>sql</strong>包内，其实目前我只是赶时间并没有处理的很细致，只能说使用起来勉勉强强的。但是应该也满足基本的使用的，不过我测试发现其实对特殊字符的支持不是很友好，开源之路，路途遥远。</p><p>&emsp;&emsp;我删减后的Druid源码地址：<a href="git@github.com:sanmengcc/druid-sql.git">Github</a></p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Druid </tag>
            
            <tag> JAVA </tag>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信开发-小程序-常用API-03-消息推送系列</title>
      <link href="/2020/07/01/7214/hub/"/>
      <url>/2020/07/01/7214/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200630214111532.png" alt="image-20200630214111532"></p><h2 id="客服消息"><a href="#客服消息" class="headerlink" title="客服消息"></a>客服消息</h2><h3 id="把媒体文件上传到微信服务器"><a href="#把媒体文件上传到微信服务器" class="headerlink" title="把媒体文件上传到微信服务器"></a>把媒体文件上传到微信服务器</h3><p>&emsp;&emsp;目前仅支持图片。用于发送客服消息或被动回复用户消息。媒体文件上传后，获取标识，<strong>3天内有效</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//getAccessToken();</span></span><br><span class="line">    uploadMedia();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 客服消息上传图片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">uploadMedia</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    uploadFile(<span class="string">"https://api.weixin.qq.com/cgi-bin/media/upload?access_token="</span> + accessToken + <span class="string">"&amp;type=image"</span>,</span><br><span class="line">               <span class="string">"image"</span>, FileUtil.getMultipartEntity(<span class="keyword">new</span> File(<span class="string">"D:\\123.png"</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String BOUNDARY_STR = <span class="string">"------------7da2e536604c8"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 文件上传</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> String <span class="title">uploadFile</span><span class="params">(String requestUrl, String type, MultipartEntityBuilder meb)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    HttpPost post = <span class="keyword">new</span> HttpPost(requestUrl);</span><br><span class="line">    CloseableHttpClient httpclient = HttpClients.createDefault();</span><br><span class="line">    post.addHeader(<span class="string">"Connection"</span>, <span class="string">"keep-alive"</span>);</span><br><span class="line">    post.addHeader(<span class="string">"Accept"</span>, <span class="string">"*/*"</span>);</span><br><span class="line">    post.addHeader(<span class="string">"Content-Type"</span>, <span class="string">"multipart/form-data;boundary="</span> + BOUNDARY_STR);</span><br><span class="line">    post.addHeader(<span class="string">"User-Agent"</span>, <span class="string">"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0) "</span>);</span><br><span class="line">    meb.addTextBody(<span class="string">"type"</span>, type);</span><br><span class="line">    post.setEntity(meb.build());</span><br><span class="line">    HttpResponse response = httpclient.execute(post);</span><br><span class="line">    HttpEntity entity = response.getEntity();</span><br><span class="line">    String result = EntityUtils.toString(entity, <span class="string">"utf-8"</span>);</span><br><span class="line">    System.out.println(<span class="string">"result="</span> + result);</span><br><span class="line">    EntityUtils.consume(entity);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取客服消息内的临时素材"><a href="#获取客服消息内的临时素材" class="headerlink" title="获取客服消息内的临时素材"></a>获取客服消息内的临时素材</h3><p>&emsp;&emsp;小程序目前仅支持图片。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getMedia(<span class="string">"VYAvYM9V6w82QQ5zzkgCSG-H8uOWAuN0jJBc9l8uPuPokNoi-ZrUtIBoKc6iMEmZ"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取客服消息图片(只能返回buffer)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getMedia</span><span class="params">(String media_id)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    URL url =<span class="keyword">new</span> URL(<span class="string">"https://api.weixin.qq.com/cgi-bin/media/get?access_token="</span> + accessToken + <span class="string">"&amp;media_id="</span> + media_id);</span><br><span class="line">    InputStream is = url.openStream();</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"D:\\sanmeng001.png"</span>);</span><br><span class="line">    <span class="comment">//不存在,创建必要的(多层)目录</span></span><br><span class="line">    File parentDir = file.getParentFile();</span><br><span class="line">    <span class="keyword">if</span> (!parentDir.exists()) &#123;</span><br><span class="line">        parentDir.mkdirs();</span><br><span class="line">    &#125;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">while</span> ((len = is.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        fos.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fos != <span class="keyword">null</span>) &#123;</span><br><span class="line">        fos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">        is.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="设置客服输入状态"><a href="#设置客服输入状态" class="headerlink" title="设置客服输入状态"></a>设置客服输入状态</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    setTyping();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 设置客服回复消息状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTyping</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"touser"</span>, <span class="string">"xxxxxxxxxxxxxx"</span>);</span><br><span class="line">    <span class="comment">//Typing对用户下发"正在输入"状态 CancelTyping取消对用户的"正在输入"状态</span></span><br><span class="line">    param.put(<span class="string">"command"</span>, <span class="string">"Typing"</span>);</span><br><span class="line">    HttpUtil.post(<span class="string">"https://api.weixin.qq.com/cgi-bin/message/custom/typing?access_token="</span> + accessToken, param.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="发送客服消息"><a href="#发送客服消息" class="headerlink" title="发送客服消息"></a>发送客服消息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    sendServiceMessage();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 发送客服消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:46</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendServiceMessage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//文字消息</span></span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"touser"</span>, <span class="string">"xxxxxxxxxxxxxx"</span>);</span><br><span class="line">    param.put(<span class="string">"msgtype"</span>, <span class="string">"text"</span>);</span><br><span class="line">    JSONObject text = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    text.put(<span class="string">"content"</span>, <span class="string">"文字消息"</span>);</span><br><span class="line">    param.put(<span class="string">"text"</span>, text);</span><br><span class="line">    sendServiceMessage(param);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//图片信息</span></span><br><span class="line">    param.put(<span class="string">"msgtype"</span>, <span class="string">"image"</span>);</span><br><span class="line">    JSONObject image = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    image.put(<span class="string">"media_id"</span>, <span class="string">"VYAvYM9V6w82QQ5zzkgCSG-H8uOWAuN0jJBc9l8uPuPokNoi-ZrUtIBoKc6iMEmZ"</span>);</span><br><span class="line">    param.put(<span class="string">"image"</span>, image);</span><br><span class="line">    param.remove(<span class="string">"text"</span>);</span><br><span class="line">    sendServiceMessage(param);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//图文链接</span></span><br><span class="line">    param.put(<span class="string">"msgtype"</span>, <span class="string">"link"</span>);</span><br><span class="line">    JSONObject link = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    link.put(<span class="string">"title"</span>, <span class="string">"标题"</span>);</span><br><span class="line">    link.put(<span class="string">"description"</span>, <span class="string">"描述"</span>);</span><br><span class="line">    link.put(<span class="string">"url"</span>, <span class="string">"图文链接消息被点击后跳转的链接"</span>);</span><br><span class="line">    link.put(<span class="string">"thumb_url"</span>, <span class="string">"图文链接消息的图片链接，支持 JPG、PNG 格式，较好的效果为大图 640 X 320，小图 80 X 80"</span>);</span><br><span class="line">    param.put(<span class="string">"link"</span>, link);</span><br><span class="line">    param.remove(<span class="string">"image"</span>);</span><br><span class="line">    sendServiceMessage(param);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//小程序卡片</span></span><br><span class="line">    param.put(<span class="string">"msgtype"</span>, <span class="string">"miniprogrampage"</span>);</span><br><span class="line">    JSONObject miniprogrampage  = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    miniprogrampage.put(<span class="string">"title"</span>, <span class="string">"标题"</span>);</span><br><span class="line">    miniprogrampage.put(<span class="string">"pagepath"</span>, <span class="string">"小程序的页面路径，跟app.json对齐，支持参数，比如pages/index/index?foo=bar"</span>);</span><br><span class="line">    miniprogrampage.put(<span class="string">"thumbMediaId"</span>, <span class="string">"小程序消息卡片的封面， image 类型的 media_id，通过 新增素材接口 上传图片文件获得，建议大小为 520*416"</span>);</span><br><span class="line">    param.put(<span class="string">"miniprogrampage"</span>, miniprogrampage);</span><br><span class="line">    param.remove(<span class="string">"link"</span>);</span><br><span class="line">    sendServiceMessage(param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 发送客服消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/7/2 8:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendServiceMessage</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    HttpUtil.post(<span class="string">"https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token="</span> + accessToken, param.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;值得注意的是<strong>miniprogrampage</strong>需要前期规划好整个小程序的页面跳转，最好采用中间页面统一跳转，根据业务区分。前后端约定好规则，因为整个跳转卡片使用的范围比较广。</p><h3 id="小程序接口方式添加客服人员"><a href="#小程序接口方式添加客服人员" class="headerlink" title="小程序接口方式添加客服人员"></a>小程序接口方式添加客服人员</h3><p>&emsp;&emsp;该方式仅适合临时使用、后期官方可能会限制该方式。此流程调用不需要用户同意直接可以将微信用户设置为小程序客服人员。调用涉及到的接口为<code>公众号</code>接口，<code>accessToken</code>为小程序的<code>accessToken</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取小程序客服列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/23 8:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getkflist</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/customservice/getkflist?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.get(url);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"kf_list"</span>: [</span><br><span class="line">    &#123; <span class="string">"kf_account"</span>: <span class="string">"test1@test"</span>, <span class="string">"kf_nick"</span>: <span class="string">"ntest1"</span>, <span class="string">"kf_id"</span>: <span class="string">"1001"</span>,<span class="string">"kf_headimgurl"</span>: <span class="string">" http://mmbiz.qpic.cn/mmbiz/4whpV1VZl2iccsvYbHvnphkyGtnvjfUS8Ym0GSaLic0FD3vN0V8PILcibEGb2fPfEOmw/0"</span></span><br><span class="line">    &#125;]</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 添加小程序的客服人员</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/23 8:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addkfaccount</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/customservice/kfaccount/inviteworker?access_token="</span> + getAccessToken();</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    <span class="comment">//ps：kf_account:需要从getkflist获取@后半部分的小程序的微信号</span></span><br><span class="line">    <span class="comment">//invite_wx:用户的微信号</span></span><br><span class="line">    param.put(<span class="string">"kf_account"</span>, <span class="string">"xxx@xxx"</span>);</span><br><span class="line">    param.put(<span class="string">"invite_wx"</span>, <span class="string">"xxxx"</span>);</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="订阅消息"><a href="#订阅消息" class="headerlink" title="订阅消息"></a>订阅消息</h2><p>&emsp;&emsp;目前订阅消息只能用户订阅了一次才能推送指定用户所订阅的模板进行消息推送，当然也有永久订阅，具体参考微信官方的申请条件。</p><h3 id="获取消息模板"><a href="#获取消息模板" class="headerlink" title="获取消息模板"></a>获取消息模板</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getSubscriptionTemplate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取订阅消息模版列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getSubscriptionTemplate</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    HttpUtil.get(<span class="string">"https://api.weixin.qq.com/wxaapi/newtmpl/gettemplate?access_token="</span> + accessToken);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取小程序账号的类目"><a href="#获取小程序账号的类目" class="headerlink" title="获取小程序账号的类目"></a>获取小程序账号的类目</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getcategory();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取订阅消息小程序账号的类目</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getcategory</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    HttpUtil.get(<span class="string">"https://api.weixin.qq.com/wxaapi/newtmpl/getcategory?access_token="</span> + accessToken);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取帐号所属类目下的公共模板标题"><a href="#获取帐号所属类目下的公共模板标题" class="headerlink" title="获取帐号所属类目下的公共模板标题"></a>获取帐号所属类目下的公共模板标题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getpubtemplatetitles();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取帐号所属类目下的公共模板标题</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getpubtemplatetitles</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    HttpUtil.get(<span class="string">"https://api.weixin.qq.com/wxaapi/newtmpl/getpubtemplatetitles?access_token="</span></span><br><span class="line">                 + accessToken</span><br><span class="line">                 + <span class="string">"&amp;ids=1,2,3&amp;start=0&amp;limit=30"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取模板标题下的关键词列表"><a href="#获取模板标题下的关键词列表" class="headerlink" title="获取模板标题下的关键词列表"></a>获取模板标题下的关键词列表</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getpubtemplatekeywords();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取模板标题下的关键词列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getpubtemplatekeywords</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    HttpUtil.get(<span class="string">"https://api.weixin.qq.com/wxaapi/newtmpl/getpubtemplatekeywords?access_token="</span></span><br><span class="line">                 + accessToken</span><br><span class="line">                 + <span class="string">"&amp;tid=xxxxxxxxxxxxxx"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="添加订阅消息模板"><a href="#添加订阅消息模板" class="headerlink" title="添加订阅消息模板"></a>添加订阅消息模板</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    addtemplate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 增加订阅消息模板</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addtemplate</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"tid"</span>, <span class="string">"xxxxxxxxxx"</span>);</span><br><span class="line">    param.put(<span class="string">"kidList"</span>, Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line">    param.put(<span class="string">"sceneDesc"</span>, <span class="string">"描述"</span>);</span><br><span class="line">    HttpUtil.post(<span class="string">"https://api.weixin.qq.com/wxaapi/newtmpl/addtemplate?access_token="</span> + accessToken, param.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除订阅消息模板"><a href="#删除订阅消息模板" class="headerlink" title="删除订阅消息模板"></a>删除订阅消息模板</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    deltemplate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 删除订阅消息模板</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 8:54</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deltemplate</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"priTmplId"</span>, <span class="string">"xxxxxxxxxx"</span>);</span><br><span class="line">    HttpUtil.post(<span class="string">"https://api.weixin.qq.com/wxaapi/newtmpl/deltemplate?access_token="</span> + accessToken, param.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="发送订阅消息"><a href="#发送订阅消息" class="headerlink" title="发送订阅消息"></a>发送订阅消息</h3><h4 id="自定义模板"><a href="#自定义模板" class="headerlink" title="自定义模板"></a>自定义模板</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"touser"</span>:<span class="string">"$&#123;touser&#125;"</span>,</span><br><span class="line"> <span class="string">"data"</span>:$&#123;data&#125;,</span><br><span class="line"> <span class="string">"template_id"</span>:<span class="string">"$&#123;template_id&#125;"</span>,</span><br><span class="line"> <span class="string">"page"</span>:<span class="string">"$&#123;page&#125;"</span>,</span><br><span class="line"> <span class="string">"lang"</span>:<span class="string">"$&#123;lang&#125;"</span>,</span><br><span class="line"> <span class="string">"miniprogram_state"</span>:</span><br><span class="line"> <span class="string">"$&#123;miniprogram_state&#125;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="自定义结构体"><a href="#自定义结构体" class="headerlink" title="自定义结构体"></a>自定义结构体</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxAppletTemplateData</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String value = <span class="string">""</span>;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMiniPushMsg</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对应小程序页面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String page;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模板ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String template_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 小程序用户openid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String touser;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进入小程序查看”的语言类型，支持zh_CN(简体中文)、en_US(英文)、zh_HK(繁体中文)、zh_TW(繁体中文)，默认为zh_CN</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Builder</span>.Default</span><br><span class="line">    <span class="keyword">private</span> String lang = <span class="string">"zh_CN"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跳转小程序类型：developer为开发版；trial为体验版；formal为正式版；默认为正式版</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Builder</span>.Default</span><br><span class="line">    <span class="keyword">private</span> String miniprogram_state = <span class="string">"formal"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信推送消息内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TreeMap&lt;String, WxAppletTemplateData&gt; data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取推送JSON</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPushJson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        jsonObject.put(<span class="string">"page"</span>, <span class="keyword">this</span>.page);</span><br><span class="line">        jsonObject.put(<span class="string">"template_id"</span>, <span class="keyword">this</span>.template_id);</span><br><span class="line">        jsonObject.put(<span class="string">"touser"</span>, <span class="keyword">this</span>.touser);</span><br><span class="line">        jsonObject.put(<span class="string">"lang"</span>, <span class="keyword">this</span>.lang);</span><br><span class="line">        jsonObject.put(<span class="string">"miniprogram_state"</span>, <span class="keyword">this</span>.miniprogram_state);</span><br><span class="line">        jsonObject.put(<span class="string">"data"</span>, JSONObject.toJSONString(<span class="keyword">this</span>.data));</span><br><span class="line">        <span class="keyword">return</span> jsonObject.toJSONString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="参数构建"><a href="#参数构建" class="headerlink" title="参数构建"></a>参数构建</h4><p>&emsp;&emsp;由于小程序的参数和格式是基与公众号复制的所以这个地方可能根据自己需要进行调整。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 订阅消息参数转换</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> sanmengc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/7/2 9:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">wxTemplateConversion</span><span class="params">(String content, WxMiniPushMsg wxPushMsg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//替换模板参数(暂时保留格式与公众号一致)</span></span><br><span class="line">    String postStr = content;</span><br><span class="line">    <span class="comment">//模板ID</span></span><br><span class="line">    postStr = postStr.replace(<span class="string">"$&#123;template_id&#125;"</span>, wxPushMsg.getTemplate_id());</span><br><span class="line">    <span class="comment">//微信公众号用户openid</span></span><br><span class="line">    postStr = postStr.replace(<span class="string">"$&#123;touser&#125;"</span>, wxPushMsg.getTouser());</span><br><span class="line">    <span class="comment">//微信小程序内部地址</span></span><br><span class="line">    postStr = postStr.replace(<span class="string">"$&#123;page&#125;"</span>, wxPushMsg.getPage());</span><br><span class="line">    <span class="comment">//进入小程序查看”的语言类型，支持zh_CN(简体中文)、en_US(英文)、zh_HK(繁体中文)、zh_TW(繁体中文)，默认为zh_CN</span></span><br><span class="line">    postStr = postStr.replace(<span class="string">"$&#123;lang&#125;"</span>, wxPushMsg.getLang());</span><br><span class="line">    <span class="comment">//跳转小程序类型：developer为开发版；trial为体验版；formal为正式版；默认为正式版</span></span><br><span class="line">    postStr = postStr.replace(<span class="string">"$&#123;miniprogram_state&#125;"</span>, wxPushMsg.getMiniprogram_state());</span><br><span class="line">    <span class="comment">//推送参数</span></span><br><span class="line">    postStr = postStr.replace(<span class="string">"$&#123;data&#125;"</span>, JSONObject.toJSONString(wxPushMsg.getData()));</span><br><span class="line">    System.out.println(<span class="string">"postStr = "</span> + postStr);</span><br><span class="line">    <span class="keyword">return</span> postStr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="发送订阅消息-1"><a href="#发送订阅消息-1" class="headerlink" title="发送订阅消息"></a>发送订阅消息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    sendMessage();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 发送订阅消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/2 9:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token="</span> + accessToken;</span><br><span class="line">    String content = <span class="string">"&#123;\"touser\":\"$&#123;touser&#125;\",\"data\":$&#123;data&#125;,\"template_id\":\"$&#123;template_id&#125;\",\"page\":\"$&#123;page&#125;\",\"lang\":\"$&#123;lang&#125;\",\"miniprogram_state\":\"$&#123;miniprogram_state&#125;\"&#125;"</span>;</span><br><span class="line">    TreeMap&lt;String, WxAppletTemplateData&gt; data = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">    data.put(<span class="string">"thing1"</span>, <span class="keyword">new</span> WxAppletTemplateData(<span class="string">"实名认证通过"</span>));</span><br><span class="line">    data.put(<span class="string">"date2"</span>, <span class="keyword">new</span> WxAppletTemplateData(<span class="string">"2020-07-02"</span>));</span><br><span class="line">    HttpUtil.post(url, wxTemplateConversion(content, WxMiniPushMsg.builder()</span><br><span class="line">                                            .data(data)</span><br><span class="line">                                            .page(<span class="string">"/page/index"</span>)</span><br><span class="line">                                            .touser(<span class="string">"sanmengcc"</span>)</span><br><span class="line">                                            .template_id(<span class="string">"xxxxxxxxxxxx"</span>)</span><br><span class="line">                                            .build()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="统一服务消息"><a href="#统一服务消息" class="headerlink" title="统一服务消息"></a>统一服务消息</h2><p>&emsp;&emsp;由于没有接入该业务所以只是演示接口调用，不进行具体的封装。值得注意的是小程序结构体中的FormId，在订阅消息中已经取消了，但是依旧是可以用于统一服务消息的。</p><p><img src="/image/hexo/image-20200703083615419.png" alt="image-20200703083615419"></p><p><img src="/image/hexo/image-20200703083631406.png" alt="image-20200703083631406"></p><p><img src="/image/hexo/image-20200703083645783.png" alt="image-20200703083645783"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    uniform_send();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 下发小程序和公众号统一的服务消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/3 8:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">uniform_send</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/wxopen/template/uniform_send?access_token="</span> + accessToken;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"touser"</span>, <span class="string">"sanmengccc"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//小程序结构体</span></span><br><span class="line">    JSONObject weapp_template_msg = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    weapp_template_msg.put(<span class="string">"template_id"</span>, <span class="string">"sanmengctid"</span>);</span><br><span class="line">    weapp_template_msg.put(<span class="string">"page"</span>, <span class="string">"page/page/index"</span>);</span><br><span class="line">    weapp_template_msg.put(<span class="string">"form_id"</span>, <span class="string">"SHIHASIDHASIDHIOAS"</span>);</span><br><span class="line"></span><br><span class="line">    JSONObject weapp_template_msg_data = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    weapp_template_msg_data.put(<span class="string">"keyword1"</span>, <span class="keyword">new</span> JSONObject()&#123;&#123;</span><br><span class="line">        put(<span class="string">"value"</span>, <span class="string">"339208499"</span>);&#125;&#125;);</span><br><span class="line">    weapp_template_msg.put(<span class="string">"data"</span>, weapp_template_msg_data);</span><br><span class="line">    weapp_template_msg.put(<span class="string">"emphasis_keyword"</span>, <span class="string">"sanmengccc"</span>);</span><br><span class="line">    param.put(<span class="string">"weapp_template_msg"</span>, weapp_template_msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//公众号结构体</span></span><br><span class="line">    JSONObject mp_template_msg = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    mp_template_msg.put(<span class="string">"appid"</span>, <span class="string">"sanmengcc"</span>);</span><br><span class="line">    mp_template_msg.put(<span class="string">"url"</span>, <span class="string">"https://www.baidu.com"</span>);</span><br><span class="line">    mp_template_msg.put(<span class="string">"template_id"</span>, <span class="string">"SHIHASIDHASIDHIOAS"</span>);</span><br><span class="line">    JSONObject miniprogram = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    miniprogram.put(<span class="string">"appid"</span>, <span class="string">"sanmengcc"</span>);</span><br><span class="line">    miniprogram.put(<span class="string">"pagepath"</span>, <span class="string">"/page/index"</span>);</span><br><span class="line">    mp_template_msg.put(<span class="string">"miniprogram"</span>, miniprogram);</span><br><span class="line"></span><br><span class="line">    JSONObject mp_template_msg_data = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    mp_template_msg_data.put(<span class="string">"first"</span>, <span class="keyword">new</span> JSONObject() &#123;&#123;</span><br><span class="line">        put(<span class="string">"value"</span>, <span class="string">"恭喜你购买成功"</span>);</span><br><span class="line">        put(<span class="string">"color"</span>, <span class="string">"#173177"</span>);</span><br><span class="line">    &#125;&#125;);</span><br><span class="line">    mp_template_msg.put(<span class="string">"data"</span>, mp_template_msg_data);</span><br><span class="line"></span><br><span class="line">    HttpUtil.post(url, param.toJSONString());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="动态消息"><a href="#动态消息" class="headerlink" title="动态消息"></a>动态消息</h2><h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><p><img src="/image/hexo/image-20200703085512662.png" alt="image-20200703085512662"></p><h3 id="创建动态消息"><a href="#创建动态消息" class="headerlink" title="创建动态消息"></a>创建动态消息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    createActivityForm();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 创建动态消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/3 8:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createActivityForm</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/wxopen/activityid/create?access_token="</span> + accessToken;</span><br><span class="line">    HttpUtil.get(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="修改动态消息"><a href="#修改动态消息" class="headerlink" title="修改动态消息"></a>修改动态消息</h3><p><img src="/image/hexo/image-20200703085316646.png" alt="image-20200703085316646"></p><p><img src="/image/hexo/image-20200703085331127.png" alt="image-20200703085331127"></p><p><img src="/image/hexo/image-20200703085342660.png" alt="image-20200703085342660"></p><p><img src="/image/hexo/image-20200703085356274.png" alt="image-20200703085356274"></p><p><img src="/image/hexo/image-20200703085410894.png" alt="image-20200703085410894"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    updateActivityForm();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 修改动态消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/3 8:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateActivityForm</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/wxopen/updatablemsg/send?access_token="</span> + accessToken;</span><br><span class="line"></span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"activity_id"</span>, <span class="string">"sanmengcc"</span>);</span><br><span class="line">    param.put(<span class="string">"target_state"</span>, <span class="string">"0"</span>);</span><br><span class="line"></span><br><span class="line">    JSONObject template_info = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    List&lt;JSONObject&gt; parameter_list = Arrays.asList(<span class="keyword">new</span> JSONObject() &#123;&#123;</span><br><span class="line">        put(<span class="string">"name"</span>, <span class="string">"sanmenggc"</span>);<span class="comment">//注意一下参数的格式String 还是Number</span></span><br><span class="line">        put(<span class="string">"value"</span>, <span class="string">"sanmenggc"</span>);</span><br><span class="line">    &#125;&#125;);</span><br><span class="line">    template_info.put(<span class="string">"parameter_list"</span>, parameter_list);</span><br><span class="line"></span><br><span class="line">    HttpUtil.get(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 微信 </category>
          
          <category> 小程序 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 微信 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信开发-小程序-常用API-02-数据分析系列</title>
      <link href="/2020/07/01/51805/hub/"/>
      <url>/2020/07/01/51805/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200630214111532.png" alt="image-20200630214111532"></p><h2 id="访问留存"><a href="#访问留存" class="headerlink" title="访问留存"></a>访问留存</h2><h3 id="获取用户访问小程序日留存"><a href="#获取用户访问小程序日留存" class="headerlink" title="获取用户访问小程序日留存"></a>获取用户访问小程序日留存</h3><p>&emsp;&emsp;可以自行获取往日的数据，时间跨度限定一天。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getweanalysisappiddailyretaininfo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取用户访问小程序日留存 时间跨度限定一天</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getweanalysisappiddailyretaininfo</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getweanalysisappiddailyretaininfo?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取用户访问小程序月留存"><a href="#获取用户访问小程序月留存" class="headerlink" title="获取用户访问小程序月留存"></a>获取用户访问小程序月留存</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getweanalysisappidmonthlyretaininfo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取用户访问小程序月留存 时间跨度限定一月</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getweanalysisappidmonthlyretaininfo</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"20200601"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getweanalysisappidmonthlyretaininfo?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取用户访问小程序周留存"><a href="#获取用户访问小程序周留存" class="headerlink" title="获取用户访问小程序周留存"></a>获取用户访问小程序周留存</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getweanalysisappidweeklyretaininfo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取用户访问小程序周留存 时间跨度限定一周</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getweanalysisappidweeklyretaininfo</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"20200622"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"20200628"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getweanalysisappidmonthlyretaininfo?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="访问小程序数据概况"><a href="#访问小程序数据概况" class="headerlink" title="访问小程序数据概况"></a>访问小程序数据概况</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getweanalysisappiddailysummarytrend();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 访问小程序数据概况 时间跨度限定一天</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getweanalysisappiddailysummarytrend</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getweanalysisappiddailysummarytrend?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="访问趋势"><a href="#访问趋势" class="headerlink" title="访问趋势"></a>访问趋势</h2><h3 id="获取用户访问小程序数据日趋势"><a href="#获取用户访问小程序数据日趋势" class="headerlink" title="获取用户访问小程序数据日趋势"></a>获取用户访问小程序数据日趋势</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getweanalysisappiddailyvisittrend();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取用户访问小程序数据日趋势 时间跨度限定一天</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getweanalysisappiddailyvisittrend</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getweanalysisappiddailyvisittrend?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取用户访问小程序数据周趋势"><a href="#获取用户访问小程序数据周趋势" class="headerlink" title="获取用户访问小程序数据周趋势"></a>获取用户访问小程序数据周趋势</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getweanalysisappidmonthlyvisittrend();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取用户访问小程序数据周趋势 时间跨度限定一周</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getweanalysisappidweeklyvisittrendaccess_token</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"20200622"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"20200628"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getweanalysisappidweeklyvisittrend?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取用户访问小程序数据月趋势"><a href="#获取用户访问小程序数据月趋势" class="headerlink" title="获取用户访问小程序数据月趋势"></a>获取用户访问小程序数据月趋势</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getweanalysisappidmonthlyvisittrend();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取用户访问小程序数据月趋势 时间跨度限定一月</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getweanalysisappidmonthlyvisittrend</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"20200601"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getweanalysisappidmonthlyvisittrend?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取小程序新增或活跃用户的画像分布数据"><a href="#获取小程序新增或活跃用户的画像分布数据" class="headerlink" title="获取小程序新增或活跃用户的画像分布数据"></a>获取小程序新增或活跃用户的画像分布数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getweanalysisappiduserportrait();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取小程序新增或活跃用户的画像分布数据 时间跨度限定最大一月 从昨日开始</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getweanalysisappiduserportrait</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"20200601"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getweanalysisappiduserportrait?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取用户小程序访问分布数据"><a href="#获取用户小程序访问分布数据" class="headerlink" title="获取用户小程序访问分布数据"></a>获取用户小程序访问分布数据</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getweanalysisappidvisitdistribution();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取用户小程序访问分布数据 时间跨度限定最大一天</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getweanalysisappidvisitdistribution</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getweanalysisappidvisitdistribution?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取访问页面"><a href="#获取访问页面" class="headerlink" title="获取访问页面"></a>获取访问页面</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getweanalysisappidvisitpage();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 访问页面。目前只提供按 page_visit_pv 排序的 top200。 时间跨度一天</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getweanalysisappidvisitpage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"20200630"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getweanalysisappidvisitpage?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.post(url, param.toJSONString());</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;统计数据需要开发者自行采用定时任务去每天获取最新的数据，而历史数据需要开发者自行处理数据初始化程序。 </p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 微信 </category>
          
          <category> 小程序 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
            <tag> 微信 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信开发-公众号-常用API-06-消息推送系列</title>
      <link href="/2020/06/30/57508/hub/"/>
      <url>/2020/06/30/57508/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200630214320785.png" alt="image-20200630214320785"></p><h2 id="模板相关"><a href="#模板相关" class="headerlink" title="模板相关"></a>模板相关</h2><h3 id="设置所属行业"><a href="#设置所属行业" class="headerlink" title="设置所属行业"></a>设置所属行业</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    setIndustry();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 设置所属行业</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setIndustry</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"industry_id1"</span>, <span class="string">"1"</span>);</span><br><span class="line">    param.put(<span class="string">"industry_id2"</span>, <span class="string">"4"</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/template/api_set_industry?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取所属行业信息"><a href="#获取所属行业信息" class="headerlink" title="获取所属行业信息"></a>获取所属行业信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getIndustry();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取设置的行业信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getIndustry</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/template/get_industry?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取模版ID"><a href="#获取模版ID" class="headerlink" title="获取模版ID"></a>获取模版ID</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getTemplateId();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取模版ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getTemplateId</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"template_id_short"</span>,<span class="string">"TM00015"</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/template/api_add_template?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取模板列表"><a href="#获取模板列表" class="headerlink" title="获取模板列表"></a>获取模板列表</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getTemplateList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取模版列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getTemplateList</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"template_id_short"</span>,<span class="string">"TM00015"</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/template/get_all_private_template?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除模板"><a href="#删除模板" class="headerlink" title="删除模板"></a>删除模板</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    delTemplate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 删除模版</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delTemplate</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"template_id"</span>,<span class="string">"TM00015"</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/template/del_private_template?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="发送模版消息"><a href="#发送模版消息" class="headerlink" title="发送模版消息"></a>发送模版消息</h2><h3 id="消息推送模板"><a href="#消息推送模板" class="headerlink" title="消息推送模板"></a>消息推送模板</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;first.DATA&#125;&#125;</span><br><span class="line">审核状态：&#123;&#123;keyword1.DATA&#125;&#125;</span><br><span class="line">操作时间：&#123;&#123;keyword2.DATA&#125;&#125;</span><br><span class="line">&#123;&#123;remark.DATA&#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义消息模板"><a href="#自定义消息模板" class="headerlink" title="自定义消息模板"></a>自定义消息模板</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"touser"</span>:<span class="string">"$&#123;touser&#125;"</span>,</span><br><span class="line">"data":$&#123;data&#125;,</span><br><span class="line">"template_id":"$&#123;template_id&#125;",</span><br><span class="line">"miniprogram":&#123;"pagepath":"$&#123;pagepath&#125;","appid":"$&#123;appid&#125;"&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="构建模板实体"><a href="#构建模板实体" class="headerlink" title="构建模板实体"></a>构建模板实体</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxTemplateData</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String value = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String color = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxPushVo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跳转小程序地址 （跳转小程序必填）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String pagepath = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跳转小程序的appid (跳转小程序必填）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String appid = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 推送对象（需要为微信公众号用户openid）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; openidList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信推送消息内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TreeMap&lt;String, WxTemplateData&gt; data;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="推送参数构建"><a href="#推送参数构建" class="headerlink" title="推送参数构建"></a>推送参数构建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 参数转换</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Optional&lt;List&lt;String&gt;&gt; wxTemplateConversion(String content,List&lt;String&gt; openIdList,String templateId, WxPushVo wxPushMsg)&#123;</span><br><span class="line">    <span class="keyword">return</span> Optional.ofNullable(openIdList)</span><br><span class="line">        .map(idList -&gt;</span><br><span class="line">             idList.stream()</span><br><span class="line">             .map(openid -&gt; &#123;</span><br><span class="line">                 <span class="comment">//替换模板参数</span></span><br><span class="line">                 String postStr = content;</span><br><span class="line">                 <span class="comment">//模板ID</span></span><br><span class="line">                 postStr = postStr.replace(<span class="string">"$&#123;template_id&#125;"</span>, templateId);</span><br><span class="line">                 <span class="comment">//微信小程序appid</span></span><br><span class="line">                 postStr = postStr.replace(<span class="string">"$&#123;appid&#125;"</span>, wxPushMsg.getAppid());</span><br><span class="line">                 <span class="comment">//微信公众号用户openid</span></span><br><span class="line">                 postStr = postStr.replace(<span class="string">"$&#123;touser&#125;"</span>, openid);</span><br><span class="line">                 <span class="comment">//微信小程序内部地址</span></span><br><span class="line">                 postStr = postStr.replace(<span class="string">"$&#123;pagepath&#125;"</span>, wxPushMsg.getPagepath());</span><br><span class="line">                 <span class="comment">//推送参数</span></span><br><span class="line">                 postStr = postStr.replace(<span class="string">"$&#123;data&#125;"</span>, JSONObject.toJSONString(wxPushMsg.getData()));</span><br><span class="line">                 <span class="keyword">return</span> postStr;</span><br><span class="line">             &#125;).collect(Collectors.toList())</span><br><span class="line">            );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="发送订阅模版消息"><a href="#发送订阅模版消息" class="headerlink" title="发送订阅模版消息"></a>发送订阅模版消息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 发送订阅消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pushTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String content = <span class="string">"&#123;\n"</span> +</span><br><span class="line">        <span class="string">"\"touser\":\"$&#123;touser&#125;\",\n"</span> +</span><br><span class="line">        <span class="string">"\"data\":$&#123;data&#125;,\n"</span> +</span><br><span class="line">        <span class="string">"\"template_id\":\"$&#123;template_id&#125;\",\n"</span> +</span><br><span class="line">        <span class="string">"\"miniprogram\":&#123;\"pagepath\":\"$&#123;pagepath&#125;\",\"appid\":\"$&#123;appid&#125;\"&#125;\n"</span> +</span><br><span class="line">        <span class="string">"&#125;"</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; openidList = Arrays.asList(<span class="string">"1"</span>);</span><br><span class="line">    WxPushVo wxPushMsg = <span class="keyword">new</span> WxPushVo();</span><br><span class="line">    wxPushMsg.setAppid(<span class="string">"wx5a1772c5bbd052d6"</span>);</span><br><span class="line">    <span class="comment">//wxPushMsg.setPagepath(""); 跳转小程序地址 （跳转小程序必填）</span></span><br><span class="line">    TreeMap&lt;String, WxTemplateData&gt; data = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">    data.put(<span class="string">"first"</span>, <span class="keyword">new</span> WxTemplateData(<span class="string">"恭喜你购买成功!"</span>, <span class="string">"#173177"</span>));</span><br><span class="line">    data.put(<span class="string">"keyword1"</span>, <span class="keyword">new</span> WxTemplateData(<span class="string">"巧克力"</span>, <span class="string">"#173177"</span>));</span><br><span class="line">    wxPushMsg.setData(data);</span><br><span class="line"></span><br><span class="line">    Optional&lt;List&lt;String&gt;&gt; listOptional = wxTemplateConversion(content, openidList, <span class="string">"xxxxxxx"</span>, wxPushMsg);</span><br><span class="line">    <span class="keyword">if</span> (listOptional.isPresent()) &#123;</span><br><span class="line">        String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token="</span> + accessToken;</span><br><span class="line">        OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        listOptional.get()</span><br><span class="line">            .forEach(json-&gt;&#123;</span><br><span class="line">                System.out.println(content);</span><br><span class="line">                RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">                Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">                Response response = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    response = client.newCall(request).execute();</span><br><span class="line">                    String result = response.body().string();</span><br><span class="line">                    System.out.println(result);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;订阅消息如果有小程序业务那么可以进行业务合并，考虑好总体的设计。</p><h2 id="一次性订阅消息"><a href="#一次性订阅消息" class="headerlink" title="一次性订阅消息"></a>一次性订阅消息</h2><h3 id="引导用户"><a href="#引导用户" class="headerlink" title="引导用户"></a>引导用户</h3><p>&emsp;&emsp;<strong>需要用户同意授权，获取一次给用户推送一条订阅模板消息的机会</strong></p><p>在确保微信公众帐号拥有订阅消息授权的权限的前提下（已认证的公众号即有权限，可登录公众平台在接口权限列表处查看），引导用户在微信客户端打开如下链接：</p><blockquote><p><a href="https://mp.weixin.qq.com/mp/subscribemsg?action=get_confirm&amp;appid=wxaba38c7f163da69b&amp;scene=1000&amp;template_id=1uDxHNXwYQfBmXOfPJcjAS3FynHArD8aWMEFNRGSbCc&amp;redirect_url=http%3a%2f%2fsupport.qq.com&amp;reserved=test#wechat_redirect" target="_blank" rel="noopener">https://mp.weixin.qq.com/mp/subscribemsg?action=get_confirm&amp;appid=wxaba38c7f163da69b&amp;scene=1000&amp;template_id=1uDxHNXwYQfBmXOfPJcjAS3FynHArD8aWMEFNRGSbCc&amp;redirect_url=http%3a%2f%2fsupport.qq.com&amp;reserved=test#wechat_redirect</a></p></blockquote><p><img src="/image/hexo/image-20200630223529149.png" alt="image-20200630223529149"></p><p><strong>用户同意或取消授权后会返回相关信息</strong></p><p>如果用户点击同意或取消授权，页面将跳转至：</p><blockquote><p>redirect_url/?openid=OPENID&amp;template_id=TEMPLATE_ID&amp;action=ACTION&amp;scene=SCENE</p></blockquote><p>&emsp;&emsp;可以在回调url中处理用户的相关业务。</p><h3 id="发送一次性订阅消息"><a href="#发送一次性订阅消息" class="headerlink" title="发送一次性订阅消息"></a>发送一次性订阅消息</h3><p>&emsp;&emsp;可以参考<strong>发送模板消息</strong>对微信系列的模板类推送进行统一封装处理，这里仅仅只是调试接口，不再进行封装处理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    pushOnce();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 一次性推送</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pushOnce</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"touser"</span>,<span class="string">"xxxxxxxxxxxxxxd"</span>);</span><br><span class="line">    param.put(<span class="string">"template_id"</span>,<span class="string">"xxxxxxxxxxxxxxd"</span>);</span><br><span class="line">    JSONObject miniprogram = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    miniprogram.put(<span class="string">"appid"</span>, <span class="string">"xxxxxxxxxx"</span>);</span><br><span class="line">    miniprogram.put(<span class="string">"pagepath"</span>, <span class="string">"index?foo=bar"</span>);</span><br><span class="line">    param.put(<span class="string">"miniprogram"</span>, miniprogram);</span><br><span class="line">    param.put(<span class="string">"scene"</span>,<span class="string">"SCENE"</span>);</span><br><span class="line">    param.put(<span class="string">"title"</span>,<span class="string">"title"</span>);</span><br><span class="line">    JSONObject content = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    content.put(<span class="string">"value"</span>, <span class="string">"xxx"</span>);</span><br><span class="line">    content.put(<span class="string">"color"</span>, <span class="string">"color"</span>);</span><br><span class="line">    JSONObject data = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    data.put(<span class="string">"content"</span>, content);</span><br><span class="line">    param.put(<span class="string">"data"</span>,data);</span><br><span class="line"></span><br><span class="line">    String contentStr = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/template/subscribe?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, contentStr);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="客户消息"><a href="#客户消息" class="headerlink" title="客户消息"></a>客户消息</h2><p>&emsp;&emsp;注意在公众号后台开放客户模块，否则没有权限调用接口。</p><h3 id="添加客服帐号"><a href="#添加客服帐号" class="headerlink" title="添加客服帐号"></a>添加客服帐号</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    addCustomerService();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 添加客服</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addCustomerService</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"kf_account"</span>,<span class="string">"sanmeng"</span>);</span><br><span class="line">    param.put(<span class="string">"nickname"</span>,<span class="string">"sanmeng"</span>);</span><br><span class="line">    param.put(<span class="string">"password"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    String contentStr = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/customservice/kfaccount/add?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, contentStr);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="修改客服帐号"><a href="#修改客服帐号" class="headerlink" title="修改客服帐号"></a>修改客服帐号</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    modifyCustomerService();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 修改客服</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">modifyCustomerService</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"kf_account"</span>,<span class="string">"sanmeng"</span>);</span><br><span class="line">    param.put(<span class="string">"nickname"</span>,<span class="string">"sanmeng"</span>);</span><br><span class="line">    param.put(<span class="string">"password"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    String contentStr = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/customservice/kfaccount/update?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, contentStr);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除客服账号"><a href="#删除客服账号" class="headerlink" title="删除客服账号"></a>删除客服账号</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    delCustomerService();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 修改客服</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delCustomerService</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"kf_account"</span>,<span class="string">"sanmeng"</span>);</span><br><span class="line">    param.put(<span class="string">"nickname"</span>,<span class="string">"sanmeng"</span>);</span><br><span class="line">    param.put(<span class="string">"password"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    String contentStr = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/customservice/kfaccount/del?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, contentStr);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取客服列表"><a href="#获取客服列表" class="headerlink" title="获取客服列表"></a>获取客服列表</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getCustomerServiceList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取客服列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getCustomerServiceList</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/customservice/getkflist?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="客服输入状态"><a href="#客服输入状态" class="headerlink" title="客服输入状态"></a>客服输入状态</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    sendServiceStatus(<span class="string">"Typing"</span>);</span><br><span class="line">    sendServiceStatus(<span class="string">"CancelTyping"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 设置客服输入状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/6/30 23:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendServiceStatus</span><span class="params">(String typing)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//"Typing"：对用户下发“正在输入"状态 "CancelTyping"：取消对用户的”正在输入"状态</span></span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"touser"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    param.put(<span class="string">"command"</span>, <span class="string">"typing"</span>);</span><br><span class="line">    String contentStr = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/custom/typing?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, contentStr);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="发送客服消息"><a href="#发送客服消息" class="headerlink" title="发送客服消息"></a>发送客服消息</h2><h3 id="常规客服消息发送"><a href="#常规客服消息发送" class="headerlink" title="常规客服消息发送"></a>常规客服消息发送</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    sendService();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendService</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//发送文本消息</span></span><br><span class="line">    JSONObject text = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    text.put(<span class="string">"touser"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    text.put(<span class="string">"msgtype"</span>, <span class="string">"text"</span>);</span><br><span class="line">    text.put(<span class="string">"content"</span>, <span class="string">"Hello World"</span>);</span><br><span class="line">    sendService(text);</span><br><span class="line">    <span class="comment">//发送图片信息</span></span><br><span class="line">    JSONObject image = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    image.put(<span class="string">"touser"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    image.put(<span class="string">"msgtype"</span>, <span class="string">"image"</span>);</span><br><span class="line">    JSONObject images = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    images.put(<span class="string">"media_id"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    image.put(<span class="string">"image"</span>, images);</span><br><span class="line">    sendService(image);</span><br><span class="line">    <span class="comment">//发送视频信息</span></span><br><span class="line">    JSONObject video = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    video.put(<span class="string">"touser"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    video.put(<span class="string">"msgtype"</span>, <span class="string">"video"</span>);</span><br><span class="line">    JSONObject videos = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    videos.put(<span class="string">"media_id"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    videos.put(<span class="string">"title"</span>, <span class="string">"视频"</span>);</span><br><span class="line">    video.put(<span class="string">"description"</span>, <span class="string">"描述"</span>);</span><br><span class="line">    sendService(video);</span><br><span class="line">    <span class="comment">//发送音频信息</span></span><br><span class="line">    JSONObject voice = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    voice.put(<span class="string">"touser"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    voice.put(<span class="string">"msgtype"</span>, <span class="string">"voice"</span>);</span><br><span class="line">    JSONObject voices = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    voices.put(<span class="string">"media_id"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    voice.put(<span class="string">"voice"</span>, voices);</span><br><span class="line">    sendService(voice);</span><br><span class="line">    <span class="comment">//发送音乐</span></span><br><span class="line">    JSONObject music = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    music.put(<span class="string">"touser"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    music.put(<span class="string">"msgtype"</span>, <span class="string">"music"</span>);</span><br><span class="line">    JSONObject musics = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    musics.put(<span class="string">"title"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    musics.put(<span class="string">"description"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    musics.put(<span class="string">"musicurl"</span>, <span class="string">"123456"</span>);<span class="comment">//音乐链接</span></span><br><span class="line">    musics.put(<span class="string">"hqmusicurl"</span>, <span class="string">"123456"</span>);<span class="comment">//高品质音乐链接，wifi环境优先使用该链接播放音乐</span></span><br><span class="line">    musics.put(<span class="string">"thumb_media_id"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    music.put(<span class="string">"music"</span>, musics);</span><br><span class="line">    sendService(voice);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 发送客服消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendService</span><span class="params">(JSONObject param)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String contentStr = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, contentStr);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="跳转类客服消息发送"><a href="#跳转类客服消息发送" class="headerlink" title="跳转类客服消息发送"></a>跳转类客服消息发送</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    sendSuperService();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 跳转类客服消息发送</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 23:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendSuperService</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//发送图文消息（跳转外链）</span></span><br><span class="line">    JSONObject news = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    news.put(<span class="string">"touser"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    news.put(<span class="string">"msgtype"</span>, <span class="string">"news"</span>);</span><br><span class="line">    JSONObject articles = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    articles.put(<span class="string">"title"</span>, <span class="string">"标题"</span>);</span><br><span class="line">    articles.put(<span class="string">"description"</span>, <span class="string">"描述"</span>);</span><br><span class="line">    articles.put(<span class="string">"url"</span>, <span class="string">"url"</span>);</span><br><span class="line">    articles.put(<span class="string">"picurl"</span>, <span class="string">"picurl"</span>);</span><br><span class="line">    news.put(<span class="string">"articles"</span>, articles);</span><br><span class="line">    sendService(news);</span><br><span class="line">    <span class="comment">//发送图文消息（跳转内部图文信息）</span></span><br><span class="line">    JSONObject mpnews = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    mpnews.put(<span class="string">"touser"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    mpnews.put(<span class="string">"msgtype"</span>, <span class="string">"mpnews"</span>);</span><br><span class="line">    JSONObject mpnewss = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    mpnewss.put(<span class="string">"media_id"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    mpnews.put(<span class="string">"mpnews"</span>, mpnewss);</span><br><span class="line">    sendService(mpnews);</span><br><span class="line">    <span class="comment">//发送菜单信息 当用户点击后，微信会发送一条XML消息到开发者服务器</span></span><br><span class="line">    JSONObject menu = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    menu.put(<span class="string">"touser"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    menu.put(<span class="string">"msgtype"</span>, <span class="string">"msgmenu"</span>);</span><br><span class="line">    JSONObject msgmenu = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    msgmenu.put(<span class="string">"head_content"</span>, <span class="string">"您对本次服务是否满意呢"</span>);</span><br><span class="line">    List&lt;JSONObject&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="keyword">new</span> JSONObject() &#123;&#123;</span><br><span class="line">        put(<span class="string">"id"</span>, <span class="string">"101"</span>);</span><br><span class="line">        put(<span class="string">"content"</span>, <span class="string">"满意"</span>);</span><br><span class="line">    &#125;&#125;);</span><br><span class="line">    list.add(<span class="keyword">new</span> JSONObject() &#123;&#123;</span><br><span class="line">        put(<span class="string">"id"</span>, <span class="string">"102"</span>);</span><br><span class="line">        put(<span class="string">"content"</span>, <span class="string">"不满意"</span>);</span><br><span class="line">    &#125;&#125;);</span><br><span class="line">    msgmenu.put(<span class="string">"list"</span>, list);</span><br><span class="line">    msgmenu.put(<span class="string">"tail_content"</span>, <span class="string">"欢迎再次光临"</span>);</span><br><span class="line">    menu.put(<span class="string">"msgmenu"</span>, mpnewss);</span><br><span class="line">    sendService(menu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="发送小程序卡片"><a href="#发送小程序卡片" class="headerlink" title="发送小程序卡片"></a>发送小程序卡片</h3><p>&emsp;&emsp;公众号和小程序需绑定。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    sendMiniService();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 发送小程序卡片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 23:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendMiniService</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//发送图文消息（跳转外链）</span></span><br><span class="line">    JSONObject miniprogram = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    miniprogram.put(<span class="string">"touser"</span>, <span class="string">"sanmeng"</span>);</span><br><span class="line">    miniprogram.put(<span class="string">"msgtype"</span>, <span class="string">"miniprogrampage"</span>);</span><br><span class="line">    JSONObject miniprogrampage = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    miniprogrampage.put(<span class="string">"appid"</span>, <span class="string">"xxxxx"</span>);</span><br><span class="line">    miniprogrampage.put(<span class="string">"pagepath"</span>, <span class="string">"xxxx"</span>);</span><br><span class="line">    miniprogrampage.put(<span class="string">"thumb_media_id"</span>, <span class="string">"xxxx"</span>);</span><br><span class="line">    miniprogram.put(<span class="string">"miniprogrampage"</span>, miniprogrampage);</span><br><span class="line">    sendService(miniprogrampage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 微信 </category>
          
          <category> 公众号 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 微信 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信开发-小程序-常用API-01-TOKEN与用户系列</title>
      <link href="/2020/06/30/27248/hub/"/>
      <url>/2020/06/30/27248/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200630214111532.png" alt="image-20200630214111532"></p><h2 id="抽取Http工具类"><a href="#抽取Http工具类" class="headerlink" title="抽取Http工具类"></a>抽取Http工具类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType JSON = MediaType.parse(<span class="string">"application/json; charset=utf-8"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url, String postStr)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        System.out.println(<span class="string">"com.sanmengcc.example.util.HttpUtil : "</span> + postStr);</span><br><span class="line">        RequestBody body = RequestBody.create(JSON, postStr);</span><br><span class="line">        Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">        Response response = client.newCall(request).execute();</span><br><span class="line">        String result = response.body().string();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        System.out.println(<span class="string">"com.sanmengcc.example.util.HttpUtil : "</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String url)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        Request request = (<span class="keyword">new</span> Request.Builder()).url(url).build();</span><br><span class="line">        Response response = client.newCall(request).execute();</span><br><span class="line">        String result = response.body().string();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        System.out.println(<span class="string">"com.sanmengcc.example.util.HttpUtil : "</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Token获取"><a href="#Token获取" class="headerlink" title="Token获取"></a>Token获取</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getAccessToken();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取小程序accessToken</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 9:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getAccessToken</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String tokenUrl = <span class="string">"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid="</span> + appid + <span class="string">"&amp;secret="</span> + secret;</span><br><span class="line">    String result = HttpUtil.get(tokenUrl);</span><br><span class="line">    Map resultMap = JSONObject.parseObject(result, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    String access_token = (String) resultMap.get(<span class="string">"access_token"</span>);</span><br><span class="line">    System.out.println(<span class="string">"accessToken = "</span> + access_token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.需要注意的是token调用每天是限制2000次，超过以后不能重置，只能等零点微信重置。</p><p>&emsp;&emsp;2.token需要区分环境（开发、测试、预生产、生产）各个环境间的token交互，保证统一的调度token。</p><h2 id="用户登录"><a href="#用户登录" class="headerlink" title="用户登录"></a>用户登录</h2><p>&emsp;&emsp;1.前端提供用户授权的<strong>code</strong>,该参数只能使用一次，前端也可以使用，注意有效性。</p><p>&emsp;&emsp;2.后端通过<strong>code</strong>参数获取用户的相关信息（手机号、openid、unionid）与后台用户体系进行绑定。</p><h3 id="获取openid、unionid"><a href="#获取openid、unionid" class="headerlink" title="获取openid、unionid"></a>获取openid、unionid</h3><p>&emsp;&emsp;这个接口主要用于用户自动登录，通过openid去开发者服务中匹配用户体系完成用户登录，这种方式是静默的不需要用户授权。</p><p><img src="/image/hexo/image-20200701095554484.png" alt="image-20200701095554484"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    getUserInfo(<span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxx"</span>,<span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxx"</span>,<span class="string">"xxxxxxxxxx"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 获取openid unionid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 9:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getUserInfo</span><span class="params">(String appid,String secret,String jscode)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/sns/jscode2session?appid="</span> + appid + <span class="string">"&amp;secret="</span> + secret + <span class="string">"&amp;js_code="</span> + jscode + <span class="string">"&amp;grant_type=authorization_code"</span>;</span><br><span class="line">    String result = HttpUtil.get(url);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解密手机号码"><a href="#解密手机号码" class="headerlink" title="解密手机号码"></a>解密手机号码</h3><h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compile (<span class="string">'org.bouncycastle:bcprov-jdk15on:1.56'</span>) &#123;</span><br><span class="line">    exclude(<span class="keyword">module</span>: <span class="string">'slf4j-log4j12'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;该接口主要用于注册，或者进行重新绑定用户体系，该接口调用所需的参数需要小程序进行弹窗由用户进行授权操作才可以获取，多次弹窗影响用户体验性，这方面需要考虑好整个用户体系的设计。</p><p><img src="/image/hexo/image-20200701100149750.png" alt="image-20200701100149750"></p><h4 id="解密工具类"><a href="#解密工具类" class="headerlink" title="解密工具类"></a>解密工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 小程序工具包</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMiniUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String AES = <span class="string">"AES"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String AES_CBC_PADDING = <span class="string">"AES/CBC/PKCS7Padding"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * * 微信 数据解密&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * * 对称解密使用的算法为 AES-128-CBC，数据采用PKCS#7填充&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * * 对称解密的目标密文:encrypted=Base64_Decode(encryptData)&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * * 对称解密秘钥:key = Base64_Decode(session_key),aeskey是16字节&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * * 对称解密算法初始向量:iv = Base64_Decode(iv),同样是16字节&lt;br/&gt;</span></span><br><span class="line"><span class="comment">     * * <span class="doctag">@param</span> encrypted 目标密文</span></span><br><span class="line"><span class="comment">     * * <span class="doctag">@param</span> session_key 会话ID</span></span><br><span class="line"><span class="comment">     * * <span class="doctag">@param</span> iv 加密算法的初始向量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">wxDecrypt</span><span class="params">(String encrypted, String session_key, String iv)</span> </span>&#123;</span><br><span class="line">        String result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] encrypted64 = Base64.decodeBase64(encrypted);</span><br><span class="line">        <span class="keyword">byte</span>[] key64 = Base64.decodeBase64(session_key);</span><br><span class="line">        <span class="keyword">byte</span>[] iv64 = Base64.decodeBase64(iv);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            init();</span><br><span class="line">            result = <span class="keyword">new</span> String(decrypt(encrypted64, key64, generateIV(iv64)));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * * 初始化密钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Security.addProvider(<span class="keyword">new</span> org.bouncycastle.jce.provider.BouncyCastleProvider());</span><br><span class="line">        KeyGenerator.getInstance(<span class="string">"AES"</span>).init(<span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * * 生成iv</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AlgorithmParameters <span class="title">generateIV</span><span class="params">(<span class="keyword">byte</span>[] iv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        AlgorithmParameters params = AlgorithmParameters.getInstance(AES);</span><br><span class="line">        params.init(<span class="keyword">new</span> IvParameterSpec(iv));</span><br><span class="line">        <span class="keyword">return</span> params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * * 生成解密</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] encryptedData, <span class="keyword">byte</span>[] keyBytes, AlgorithmParameters iv)</span><br><span class="line">        <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Key key = <span class="keyword">new</span> SecretKeySpec(keyBytes, AES);</span><br><span class="line">        Cipher cipher = Cipher.getInstance(AES_CBC_PADDING);</span><br><span class="line">        <span class="comment">// 设置为解密模式</span></span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, key, iv);</span><br><span class="line">        <span class="keyword">return</span> cipher.doFinal(encryptedData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h4><p>&emsp;&emsp;值得注意的是<strong>session_key</strong>参数是由后端通过<strong>jsCode</strong>接口获取的，而不是前端传递。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//session_key通过getUserInfo获取</span></span><br><span class="line">    getUserPhone(<span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 解密手机号码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getUserPhone</span><span class="params">(String encryptedData, String session_key, String iv)</span> </span>&#123;</span><br><span class="line">    String result = WxMiniUtil.wxDecrypt(encryptedData, session_key, iv);</span><br><span class="line">    JSONObject json = JSONObject.parseObject(result);</span><br><span class="line">    System.out.println(<span class="string">"获取微信用户授权数据 phone："</span> + json.get(<span class="string">"phoneNumber"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取unionid"><a href="#获取unionid" class="headerlink" title="获取unionid"></a>获取unionid</h2><p><img src="/image/hexo/image-20200701101916567.png" alt="image-20200701101916567"></p><p>&emsp;&emsp;1.第一点<strong>用户登陆-&gt;获取openid、unionid</strong>中已经演示，但是该方法有弊端：首先小程序关联公众号或者APP，需要有主体进行关联，其次用户必须使用小程序也同时使用主体下其他相关联的应用才会生成unionid。也就是说大部分用户是无法获取到unionid的。</p><p>&emsp;&emsp;2.第二点、第三点和第一点并没有什么实际性的区别，也是需要关联主体。</p><p>&emsp;&emsp;3.第四点，进行支付后可以通过openid获取unionid。</p><p>&emsp;&emsp;4.Java服务端暂时忽略云函数调用。</p><h3 id="完成支付后获取用户的unionid"><a href="#完成支付后获取用户的unionid" class="headerlink" title="完成支付后获取用户的unionid"></a>完成支付后获取用户的unionid</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    payAfterGetUnionid(<span class="string">"xxxxxxxxxxx"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 支付操作完成后进行获取unionid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/7/1 10:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">payAfterGetUnionid</span><span class="params">(String openid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/wxa/getpaidunionid?access_token="</span> + accessToken + <span class="string">"&amp;openid="</span> + openid;</span><br><span class="line">    String result = HttpUtil.get(url);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="unionid完善"><a href="#unionid完善" class="headerlink" title="unionid完善"></a>unionid完善</h3><p>&emsp;&emsp;1.主要来说获取unionid有两种方式：公众号小程序关联、完成支付。</p><p>&emsp;&emsp;2.需要完善公众号引流，然后对公众号的用户进行管理，对三种ID进行管理：小程序openid、公众号openid、用户unionid。</p><p>&emsp;&emsp;3.在登陆的时候通过unionid进行用户三种id的管理（需要将公众号的用户进行管理，定期获取：详见公众号相关用户文章）。</p><p>&emsp;&emsp;4.尽可能在能够获取unionid的地方都去尝试获取，更多的是引导小程序用户去关联公众号。当小程序公众号的等各种业务串联起来的时候就会凸显出unionid的重要性。</p><p>2021-03-30补充：</p><p>&emsp;1.小程序针对unionid机制放开，可以参考小程序官方文档。</p><p><img src="/image/hexo/image-20210330134332498.png" alt="image-20210330134332498"></p><p>&emsp;2.针对小程序和公众号的三方关联那么可以更加的方便。仅需将用户在公众号关注的时候即使的保存用户的关系即可。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 微信 </category>
          
          <category> 小程序 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 微信 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zerotier异地组网与远程桌面</title>
      <link href="/2020/06/29/51167/hub/"/>
      <url>/2020/06/29/51167/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20210811110623486.png" alt="image-20210811110623486"></p><h2 id="内网穿透、DDNS、虚拟组网的简单说明"><a href="#内网穿透、DDNS、虚拟组网的简单说明" class="headerlink" title="内网穿透、DDNS、虚拟组网的简单说明"></a>内网穿透、DDNS、虚拟组网的简单说明</h2><h4 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h4><p>&emsp;&emsp;需要公网IP(中转服务器),这是一个大的前提。那么带宽的限制以及性能的限制全部集中到了中转服务器上,这与我们实现内外网访问的初衷有所违背（主要还是买不起高额的带宽）。</p><h4 id="DDNS"><a href="#DDNS" class="headerlink" title="DDNS"></a>DDNS</h4><p>&emsp;&emsp;需要公网IP(三大运营商的宽带)，但是现在运营商对公网IP的限制都比较死,并且还不是固定IP。一般只有企业宽带才能申请开通公网IP的权限。这样的话针对个人、家庭的话DDNS这一条路实际上也很难走通了。</p><h4 id="虚拟组网"><a href="#虚拟组网" class="headerlink" title="虚拟组网"></a>虚拟组网</h4><p>&emsp;&emsp;P2P技术连接，不需要公网IP。但是也需要一个中转服务器，工作的时候为每一台虚拟局域网设备做认证，并不提供转发作用。如果有一台虚拟局域网内的主机打算访问另一台虚拟局域网内的主机的话，其会访问Zerotier的服务器，服务器获取两台主机的信息，并为他们做好自动的打洞，让主机双方可以拿到一个临时的公网IP，然后Zerotier服务器不再干涉后续的数据传输，两台主机实际上是P2P传输，可以达到很高的带宽，不受中转服务器的速度限制，也不吃中转服务器的带宽。</p><p>&emsp;&emsp;但是三大运营商针对此方式都有了一定的限制，但是我在刚才的测试中，暂时发现带宽的使用率还是比较高效的，基本可以拉满整个带宽。Zerotier提供了中转服务，但是他由于在国外，可能存在延迟高等一系列问题，当然我们也可以自行的搭建中转服务。</p><h2 id="内网穿透、DDNS、虚拟组网对比"><a href="#内网穿透、DDNS、虚拟组网对比" class="headerlink" title="内网穿透、DDNS、虚拟组网对比"></a>内网穿透、DDNS、虚拟组网对比</h2><table><thead><tr><th>名称</th><th>公网IP</th><th>带宽限制</th></tr></thead><tbody><tr><td>内网穿透</td><td>需要</td><td>有限制</td></tr><tr><td>DDNS</td><td>需要</td><td>有限制</td></tr><tr><td>虚拟组网</td><td>不需要</td><td>无限制</td></tr></tbody></table><h2 id="虚拟组网的流程"><a href="#虚拟组网的流程" class="headerlink" title="虚拟组网的流程"></a>虚拟组网的流程</h2><h2 id="虚拟组网的搭建"><a href="#虚拟组网的搭建" class="headerlink" title="虚拟组网的搭建"></a>虚拟组网的搭建</h2><h2 id="虚拟组网的正常访问"><a href="#虚拟组网的正常访问" class="headerlink" title="虚拟组网的正常访问"></a>虚拟组网的正常访问</h2><h2 id="虚拟组网的远程桌面访问"><a href="#虚拟组网的远程桌面访问" class="headerlink" title="虚拟组网的远程桌面访问"></a>虚拟组网的远程桌面访问</h2><h2 id="虚拟组网的后续优化"><a href="#虚拟组网的后续优化" class="headerlink" title="虚拟组网的后续优化"></a>虚拟组网的后续优化</h2><h2 id="虚拟组网的自动化"><a href="#虚拟组网的自动化" class="headerlink" title="虚拟组网的自动化"></a>虚拟组网的自动化</h2>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
          <category> 操作系统 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
            <tag> 操作系统 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信开发-公众号-常用API-05-数据分析系列</title>
      <link href="/2020/06/28/54446/hub/"/>
      <url>/2020/06/28/54446/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200619082908319.png" alt="image-20200619082908319"></p><h2 id="用户分析"><a href="#用户分析" class="headerlink" title="用户分析"></a>用户分析</h2><p>&emsp;&emsp;接口时间跨度不能超过7天，如果需要历史数据，则需要开发者自行处理业务来获取历史数据。</p><h3 id="获取用户增减数据"><a href="#获取用户增减数据" class="headerlink" title="获取用户增减数据"></a>获取用户增减数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getusersummary();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户增减数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getusersummary</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getusersummary?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"2020-06-22"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"2020-06-27"</span>);</span><br><span class="line"></span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取累计用户数据"><a href="#获取累计用户数据" class="headerlink" title="获取累计用户数据"></a>获取累计用户数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getusercumulate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取累计用户数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getusercumulate</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/datacube/getusercumulate?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"2020-06-22"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"2020-06-27"</span>);</span><br><span class="line"></span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="图文分析"><a href="#图文分析" class="headerlink" title="图文分析"></a>图文分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    newsAnalyze();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  图文分析</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">newsAnalyze</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//获取图文群发每日数据 时间最大跨度 1</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getarticlesummary?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取图文群发总数据 时间最大跨度 1</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getarticletotal?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取图文统计数据 时间最大跨度 3</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getuserread?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取图文统计分时数据 时间最大跨度 1</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getuserreadhour?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取图文分享转发数据 时间最大跨度 7</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getusershare?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取图文分享转发分时数据 时间最大跨度 1</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getusersharehour?access_token="</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  数据分析</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAnalyze</span><span class="params">(String reqUrl)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = reqUrl + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"2020-06-27"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"2020-06-27"</span>);</span><br><span class="line"></span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="消息分析"><a href="#消息分析" class="headerlink" title="消息分析"></a>消息分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    messageAnalyze();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息分析</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">messageAnalyze</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//获取消息发送概况数据 时间最大跨度 7</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getupstreammsg?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取消息分送分时数据 时间最大跨度 1</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getupstreammsghour?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取消息发送周数据 时间最大跨度 30</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getupstreammsgweek?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取消息发送月数据 时间最大跨度 30</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getupstreammsgmonth?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取消息发送分布数据 时间最大跨度 15</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getupstreammsgdist?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取消息发送分布周数据 时间最大跨度 30</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getupstreammsgdistweek?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取消息发送分布月数据 时间最大跨度 30</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getupstreammsgdistmonth?access_token="</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  数据分析</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAnalyze</span><span class="params">(String reqUrl)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = reqUrl + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"2020-06-27"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"2020-06-27"</span>);</span><br><span class="line"></span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="广告分析"><a href="#广告分析" class="headerlink" title="广告分析"></a>广告分析</h2><p><img src="/image/hexo/image-20200628223214778.png" alt="image-20200628223214778"></p><p>&emsp;&emsp;注意<strong>ad_slot</strong>参数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    advertisingAnalyze();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">advertisingAnalyze</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"page"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"page_size"</span>, <span class="number">90</span>);</span><br><span class="line">    param.put(<span class="string">"start_date"</span>, <span class="number">2020</span>-<span class="number">06</span>-<span class="number">27</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="number">2020</span>-<span class="number">06</span>-<span class="number">27</span>);</span><br><span class="line">    param.put(<span class="string">"ad_slot"</span>, <span class="string">"SLOT_ID_WEAPP_BOX"</span>);<span class="comment">//如果不传递广告位类型名称，将默认返回全部类型广告位（除返佣商品广告）的数据。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取公众号分广告位数据 时间跨度 90</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/publisher/stat?action=publisher_adpos_general&amp;access_token="</span>, param.toJSONString());</span><br><span class="line">    <span class="comment">//获取公众号返佣商品数据 时间跨度 60</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/publisher/stat?action=publisher_cps_general&amp;access_token="</span>, param.toJSONString());</span><br><span class="line">    <span class="comment">//获取公众号结算收入数据及结算主体信息 时间跨度 无</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/publisher/stat?action=publisher_settlement&amp;access_token="</span>, param.toJSONString());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  数据分析</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAnalyze</span><span class="params">(String reqUrl,String json)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = reqUrl + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, json);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="接口分析"><a href="#接口分析" class="headerlink" title="接口分析"></a>接口分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    interfaceAnalyze();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">interfaceAnalyze</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//获取接口分析数据 时间跨度 30</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getinterfacesummary?access_token="</span>);</span><br><span class="line">    <span class="comment">//获取接口分析分时数据 时间跨度 1</span></span><br><span class="line">    getAnalyze(<span class="string">"https://api.weixin.qq.com/datacube/getinterfacesummaryhour?access_token="</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  数据分析</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAnalyze</span><span class="params">(String reqUrl)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = reqUrl + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"begin_date"</span>, <span class="string">"2020-06-27"</span>);</span><br><span class="line">    param.put(<span class="string">"end_date"</span>, <span class="string">"2020-06-27"</span>);</span><br><span class="line"></span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 微信 </category>
          
          <category> 公众号 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 微信 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信开发-公众号-常用API-04-账号系列</title>
      <link href="/2020/06/28/32830/hub/"/>
      <url>/2020/06/28/32830/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200619082908319.png" alt="image-20200619082908319"></p><h2 id="二维码相关"><a href="#二维码相关" class="headerlink" title="二维码相关"></a>二维码相关</h2><p>&emsp;&emsp;临时二维码，是有过期时间的，最长可以设置为在二维码生成后的30天（即2592000秒）后过期，但能够生成较多数量。临时二维码主要用于帐号绑定等不要求二维码永久保存的业务场景 2、永久二维码，是无过期时间的，但数量较少（目前为最多10万个）。永久二维码主要用于适用于帐号绑定、用户来源统计等场景。</p><p>用户扫描带场景值二维码时，可能推送以下两种事件：</p><p>如果用户还未关注公众号，则用户可以关注公众号，关注后微信会将带场景值关注事件推送给开发者。</p><p>如果用户已经关注公众号，在用户扫描后会自动进入会话，微信也会将带场景值扫描事件推送给开发者。</p><p>获取带参数的二维码的过程包括两步，首先创建二维码ticket，然后凭借ticket到指定URL换取二维码。</p><h3 id="临时二维码-场景ID模式"><a href="#临时二维码-场景ID模式" class="headerlink" title="临时二维码(场景ID模式)"></a>临时二维码(场景ID模式)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    createScentIdTemp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取临时二维码(id)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createScentIdTemp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"expire_seconds"</span>, <span class="number">604800</span>);</span><br><span class="line">    param.put(<span class="string">"action_name"</span>, <span class="string">"QR_SCENE"</span>);</span><br><span class="line">    JSONObject scene = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    scene.put(<span class="string">"scene_id"</span>, <span class="number">1</span>);</span><br><span class="line">    JSONObject sceneInfo = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    sceneInfo.put(<span class="string">"scene"</span>, scene);</span><br><span class="line">    param.put(<span class="string">"action_info"</span>, sceneInfo);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="临时二维码（场景字符串模式）"><a href="#临时二维码（场景字符串模式）" class="headerlink" title="临时二维码（场景字符串模式）"></a>临时二维码（场景字符串模式）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    createScentStrTemp();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取临时二维码(Str)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createScentStrTemp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"expire_seconds"</span>, <span class="number">604800</span>);</span><br><span class="line">    param.put(<span class="string">"action_name"</span>, <span class="string">"QR_STR_SCENE"</span>);</span><br><span class="line">    JSONObject scene = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    scene.put(<span class="string">"scene_id"</span>, <span class="string">"XXXX"</span>);</span><br><span class="line">    JSONObject sceneInfo = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    sceneInfo.put(<span class="string">"scene"</span>, scene);</span><br><span class="line">    param.put(<span class="string">"action_info"</span>, sceneInfo);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="永久二维码（场景ID模式）"><a href="#永久二维码（场景ID模式）" class="headerlink" title="永久二维码（场景ID模式）"></a>永久二维码（场景ID模式）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    createScentIdForever();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取永久二维码(id)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createScentIdForever</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"action_name"</span>, <span class="string">"QR_LIMIT_SCENE"</span>);</span><br><span class="line">    JSONObject scene = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    scene.put(<span class="string">"scene_id"</span>, <span class="number">123</span>);</span><br><span class="line">    JSONObject sceneInfo = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    sceneInfo.put(<span class="string">"scene"</span>, scene);</span><br><span class="line">    param.put(<span class="string">"action_info"</span>, sceneInfo);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="永久二维码（场景字符串模式）"><a href="#永久二维码（场景字符串模式）" class="headerlink" title="永久二维码（场景字符串模式）"></a>永久二维码（场景字符串模式）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    createScentStrForever();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取永久二维码(STR)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createScentStrForever</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"action_name"</span>, <span class="string">"QR_LIMIT_STR_SCENE"</span>);</span><br><span class="line">    JSONObject scene = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    scene.put(<span class="string">"scene_str"</span>, <span class="string">"xxxxxxxxxxxxxx"</span>);</span><br><span class="line">    JSONObject sceneInfo = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    sceneInfo.put(<span class="string">"scene"</span>, scene);</span><br><span class="line">    param.put(<span class="string">"action_info"</span>, sceneInfo);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="通过ticket换取二维码"><a href="#通过ticket换取二维码" class="headerlink" title="通过ticket换取二维码"></a>通过ticket换取二维码</h3><p>&emsp;&emsp;值得注意的是该接口返回的图片文件信息，需要开发者自行转存。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    ticketExchangeQr();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过ticket换取二维码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">ticketExchangeQr</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=gQEX8TwAAAAAAAAAAS5odHRwOi8vd2VpeGluLnFxLmNvbS9xLzAyQ1RPMmNrSG5lNGkxMDAwME0wN2sAAgRtofheAwQAAAAA"</span>;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    InputStream is = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        is = response.body().byteStream();</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"D:\\"</span> + System.currentTimeMillis() + <span class="string">".png"</span>);</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">        <span class="keyword">while</span> ((len = is.read(buf)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            fos.write(buf, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        fos.flush();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>)</span><br><span class="line">                is.close();</span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="keyword">null</span>)</span><br><span class="line">                fos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"result"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二维码业务"><a href="#二维码业务" class="headerlink" title="二维码业务"></a>二维码业务</h3><p>&emsp;&emsp;1.针对scene的字符串或者ID都是有长度限制的，这一点微信官方预计不会增加长度，需要开发者自行处理。</p><p>&emsp;&emsp;2.可以使用一张中间表，scene的场景值关联中间表的业务，这样可以横向扩展二维码的相关业务能力。</p><h2 id="长链接转成短链接"><a href="#长链接转成短链接" class="headerlink" title="长链接转成短链接"></a>长链接转成短链接</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    urlCoverShort();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 长链接转成短链接</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">urlCoverShort</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/shorturl?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"action"</span>, <span class="string">"long2short"</span>);</span><br><span class="line">    param.put(<span class="string">"long_url"</span>, <span class="string">"https://www.baidu.com"</span>);</span><br><span class="line"></span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 微信 </category>
          
          <category> 公众号 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 微信 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信开发-公众号-常用API-03-用户系列</title>
      <link href="/2020/06/28/28851/hub/"/>
      <url>/2020/06/28/28851/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200619082908319.png" alt="image-20200619082908319"></p><h2 id="用户标签"><a href="#用户标签" class="headerlink" title="用户标签"></a>用户标签</h2><h3 id="创建标签"><a href="#创建标签" class="headerlink" title="创建标签"></a>创建标签</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    createTag();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建用户标签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createTag</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    JSONObject tag = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    tag.put(<span class="string">"name"</span>, <span class="string">"USER"</span>);</span><br><span class="line">    param.put(<span class="string">"tag"</span>, tag);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/tags/create?access_token="</span> + ApplicationMediaUploadAndDown.accessToken+<span class="string">"&amp;name=USER"</span>;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取所有标签"><a href="#获取所有标签" class="headerlink" title="获取所有标签"></a>获取所有标签</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getAllTag();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取所有标签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAllTag</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/tags/get?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, <span class="keyword">new</span> JSONObject().toJSONString());</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="编辑标签"><a href="#编辑标签" class="headerlink" title="编辑标签"></a>编辑标签</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    updateTag();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 编辑标签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">updateTag</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    JSONObject tag = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    tag.put(<span class="string">"name"</span>, <span class="string">"USERxxx"</span>);</span><br><span class="line">    tag.put(<span class="string">"id"</span>, <span class="number">101</span>);</span><br><span class="line">    param.put(<span class="string">"tag"</span>, tag);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/tags/update?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除标签"><a href="#删除标签" class="headerlink" title="删除标签"></a>删除标签</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    delTag();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除标签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">delTag</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    JSONObject tag = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    tag.put(<span class="string">"id"</span>, <span class="number">101</span>);</span><br><span class="line">    param.put(<span class="string">"tag"</span>, tag);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/tags/delete?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取标签下的用户粉丝"><a href="#获取标签下的用户粉丝" class="headerlink" title="获取标签下的用户粉丝"></a>获取标签下的用户粉丝</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getTagUser();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取标签下的用户粉丝</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getTagUser</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"tagid"</span>, <span class="number">102</span>);</span><br><span class="line">    param.put(<span class="string">"next_openid"</span>, <span class="string">""</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/user/tag/get?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="用户绑定标签"><a href="#用户绑定标签" class="headerlink" title="用户绑定标签"></a>用户绑定标签</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    bindTag();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户绑定标签，标签功能目前支持公众号为用户打上最多20个标签。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bindTag</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"openid_list"</span>, Arrays.asList(<span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>,<span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>));</span><br><span class="line">    param.put(<span class="string">"tagid"</span>, <span class="number">102</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/tags/members/batchtagging?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="用户解绑标签"><a href="#用户解绑标签" class="headerlink" title="用户解绑标签"></a>用户解绑标签</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    unBindTag();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户解绑标签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">unBindTag</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"openid_list"</span>, Arrays.asList(<span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>,<span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>));</span><br><span class="line">    param.put(<span class="string">"tagid"</span>, <span class="number">102</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/tags/members/batchuntagging?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取用户身上的标签列表"><a href="#获取用户身上的标签列表" class="headerlink" title="获取用户身上的标签列表"></a><strong>获取用户身上的标签列表</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getUserTag();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户的标签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUserTag</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"openid"</span>, <span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>);</span><br><span class="line">    String url = <span class="string">" https://api.weixin.qq.com/cgi-bin/tags/getidlist?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="用户相关"><a href="#用户相关" class="headerlink" title="用户相关"></a>用户相关</h2><p>&emsp;&emsp;可能大多数开发者更关心的是三方的id关联。由于很多情况获取不到<strong>unionid</strong>那么可以采取强制性操作，让用户关注公众号后可以推送到服务端，可以获得用户openid然后与用户体系相关联。</p><h3 id="设置备注"><a href="#设置备注" class="headerlink" title="设置备注"></a>设置备注</h3><p>&emsp;&emsp;仅认证后的公众号可以调用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    setUserRemark();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户的标签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">setUserRemark</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"openid"</span>, <span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>);</span><br><span class="line">    param.put(<span class="string">"remark"</span>, <span class="string">"sanmengcc"</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info/updateremark?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取用户列表"><a href="#获取用户列表" class="headerlink" title="获取用户列表"></a>获取用户列表</h3><p>&emsp;&emsp;<strong>next_openid</strong>进行分段获取用户，每次获取后尽量保证数据与微信接口获取的数据顺序一致，比如每天定时获取新的用户，就需要将最后一个<strong>next_openid</strong>传入，获取从这一个openid开始往后的用户数据。该顺序由开发者自行维护。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getUserList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUserList</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/user/get?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken</span><br><span class="line">        + <span class="string">"&amp;next_openid="</span>;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取用户详细信息"><a href="#获取用户详细信息" class="headerlink" title="获取用户详细信息"></a>获取用户详细信息</h3><p>&emsp;&emsp;unionid只有在用户将公众号绑定到微信开放平台帐号后，才会出现该字段。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getUserInfo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户的详细信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUserInfo</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken</span><br><span class="line">        + <span class="string">"&amp;openid=o6xeE0iTc9vfeOpnUxAgDPG7WPIQ&amp;lang=zh_CN"</span>;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="批量获取用户详细信息"><a href="#批量获取用户详细信息" class="headerlink" title="批量获取用户详细信息"></a>批量获取用户详细信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    batchGetUserInfo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批量获取用户的详细信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">batchGetUserInfo</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info/batchget?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    JSONObject user = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    user.put(<span class="string">"openid"</span>, <span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>);</span><br><span class="line">    user.put(<span class="string">"lang"</span>, <span class="string">"zh_CN"</span>);</span><br><span class="line">    param.put(<span class="string">"user_list"</span>, user);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="黑名单相关"><a href="#黑名单相关" class="headerlink" title="黑名单相关"></a>黑名单相关</h2><h3 id="获取黑名单列表"><a href="#获取黑名单列表" class="headerlink" title="获取黑名单列表"></a>获取黑名单列表</h3><p>&emsp;&emsp;<strong>next_openid</strong>和用户列表一样的使用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getBlacklist();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取黑名单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getBlacklist</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/tags/members/getblacklist?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"begin_openid"</span>, <span class="string">""</span>);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取黑名单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getBlacklistNext</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/tags/members/getblacklist?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"next_openid"</span>, <span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="设置黑名单"><a href="#设置黑名单" class="headerlink" title="设置黑名单"></a>设置黑名单</h3><p>&emsp;&emsp;公众号可通过该接口来拉黑一批用户，黑名单列表由一串 OpenID （加密后的微信号，每个用户对每个公众号的OpenID是唯一的）组成。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    setBlacklist();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置黑名单用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">setBlacklist</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/tags/members/batchblacklist?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"openid_list"</span>, Arrays.asList(<span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>));</span><br><span class="line"></span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解除用户黑名单"><a href="#解除用户黑名单" class="headerlink" title="解除用户黑名单"></a>解除用户黑名单</h3><p>&emsp;&emsp;公众号可通过该接口来取消拉黑一批用户，黑名单列表由一串OpenID（加密后的微信号，每个用户对每个公众号的OpenID是唯一的）组成。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    unSetBlacklist();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取消用户黑名单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">unSetBlacklist</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/tags/members/batchunblacklist?access_token="</span></span><br><span class="line">        + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    param.put(<span class="string">"openid_list"</span>, Arrays.asList(<span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>));</span><br><span class="line"></span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 微信 </category>
          
          <category> 公众号 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 微信 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程高阶-26-AtomicInteger详解</title>
      <link href="/2020/06/21/52943/hub/"/>
      <url>/2020/06/21/52943/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200706175818038.png" alt="image-20200706175818038"></p><h2 id="AtomicInteger相关API"><a href="#AtomicInteger相关API" class="headerlink" title="AtomicInteger相关API"></a>AtomicInteger相关API</h2><p>&emsp;&emsp;<strong>基于JDK1.8</strong></p><h3 id="类声明"><a href="#类声明" class="headerlink" title="类声明"></a>类声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extends Number implements java.io.Serializable</span><br></pre></td></tr></table></figure><h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//create</span></span><br><span class="line">AtomicInteger i = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">System.out.println(i.get());</span><br><span class="line"></span><br><span class="line">i = <span class="keyword">new</span> AtomicInteger(<span class="number">10</span>);</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="accumulateAndGet"><a href="#accumulateAndGet" class="headerlink" title="accumulateAndGet"></a>accumulateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//accumulateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.该函数返回当前对象的更新值</span></span><br><span class="line"><span class="comment"> * 2.IntBinaryOperator 作为一个操作函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">IntBinaryOperator accumulatorFunction = (x, y) -&gt; (x * y);</span><br><span class="line">System.out.println(i.accumulateAndGet(<span class="number">20</span>, accumulatorFunction));</span><br></pre></td></tr></table></figure><h4 id="addAndGet"><a href="#addAndGet" class="headerlink" title="addAndGet"></a>addAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//addAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.指定添加的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(i.addAndGet(<span class="number">1</span>));</span><br></pre></td></tr></table></figure><h4 id="compareAndSet"><a href="#compareAndSet" class="headerlink" title="compareAndSet"></a>compareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.判断预期值 == 实际值，相等则更新</span></span><br><span class="line"><span class="comment"> * 2.返回值代表是否修改成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">i.compareAndSet(<span class="number">103</span>, <span class="number">104</span>);</span><br><span class="line">System.out.println(i.get());</span><br><span class="line">i.compareAndSet(<span class="number">102</span>, <span class="number">104</span>);</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h4 id="decrementAndGet"><a href="#decrementAndGet" class="headerlink" title="decrementAndGet"></a>decrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//decrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.自减1操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(i.decrementAndGet());</span><br></pre></td></tr></table></figure><h4 id="doubleValue"><a href="#doubleValue" class="headerlink" title="doubleValue"></a>doubleValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//doubleValue 返回double类型</span></span><br><span class="line">System.out.println(i.doubleValue());</span><br></pre></td></tr></table></figure><h4 id="floatValue"><a href="#floatValue" class="headerlink" title="floatValue"></a>floatValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//floatValue 返回float类型</span></span><br><span class="line">System.out.println(i.floatValue());</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get 获取当前值</span></span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h4 id="getAndAccumulate"><a href="#getAndAccumulate" class="headerlink" title="getAndAccumulate"></a>getAndAccumulate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAccumulate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get然后执行函数操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">IntBinaryOperator op = (x, y) -&gt; (x - y);</span><br><span class="line">System.out.println(i.getAndAccumulate(<span class="number">2000</span>, op));</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h4 id="getAndAdd"><a href="#getAndAdd" class="headerlink" title="getAndAdd"></a>getAndAdd</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndAdd</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get然后再Add指定的数字</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(i.getAndAdd(<span class="number">10</span>));</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h4 id="getAndDecrement"><a href="#getAndDecrement" class="headerlink" title="getAndDecrement"></a>getAndDecrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndDecrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get然后再自减1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(i.getAndDecrement());</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h4 id="getAndIncrement"><a href="#getAndIncrement" class="headerlink" title="getAndIncrement"></a>getAndIncrement</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndIncrement</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get然后再自增1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(i.getAndIncrement());</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h4 id="getAndSet"><a href="#getAndSet" class="headerlink" title="getAndSet"></a>getAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndSet 原子操作获取旧值设置新值</span></span><br><span class="line">System.out.println(i.getAndSet(<span class="number">102</span>));</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h4 id="getAndUpdate"><a href="#getAndUpdate" class="headerlink" title="getAndUpdate"></a>getAndUpdate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getAndUpdate</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先get然后再执行一个Function</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(i.getAndUpdate((x) -&gt; x - <span class="number">20</span>));</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h4 id="incrementAndGet"><a href="#incrementAndGet" class="headerlink" title="incrementAndGet"></a>incrementAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//incrementAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先自增1再get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(i.incrementAndGet());</span><br></pre></td></tr></table></figure><h4 id="intValue"><a href="#intValue" class="headerlink" title="intValue"></a>intValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//intValue</span></span><br><span class="line">System.out.println(i.intValue());</span><br></pre></td></tr></table></figure><h4 id="lazySet"><a href="#lazySet" class="headerlink" title="lazySet"></a>lazySet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lazySet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.只会在用的时候才去设置</span></span><br><span class="line"><span class="comment"> * 2.那么A线程使用lazySet，B线程可能在很长一段时间内也是可以获取的旧值的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">i.lazySet(<span class="number">101</span>);</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h4 id="longValue"><a href="#longValue" class="headerlink" title="longValue"></a>longValue</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//longValue</span></span><br><span class="line">System.out.println(i.longValue());</span><br></pre></td></tr></table></figure><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.set方法在安全方面并没有做什么处理，更多的是初始化操作</span></span><br><span class="line"><span class="comment"> * 2.如果A线程在get的时候，B线程set了数据那么A线程毫无疑问的拿到的是B线程set的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">i.set(<span class="number">100</span>);</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><h4 id="updateAndGet"><a href="#updateAndGet" class="headerlink" title="updateAndGet"></a>updateAndGet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//updateAndGet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.先执行Function并且get</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">System.out.println(i.updateAndGet((x) -&gt; x + <span class="number">100</span>));</span><br></pre></td></tr></table></figure><h4 id="weakCompareAndSet"><a href="#weakCompareAndSet" class="headerlink" title="weakCompareAndSet"></a>weakCompareAndSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//weakCompareAndSet</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 1.和compareAndSet作用差不多</span></span><br><span class="line"><span class="comment"> * 2.可能意外失败并且不提供排序保证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">i.weakCompareAndSet(<span class="number">103</span>, <span class="number">104</span>);</span><br><span class="line">System.out.println(i.get());</span><br><span class="line">i.weakCompareAndSet(<span class="number">102</span>, <span class="number">104</span>);</span><br><span class="line">System.out.println(i.get());</span><br></pre></td></tr></table></figure><p><a href="https://download.oracle.com/technetwork/java/javase/6/docs/zh/api/java/util/concurrent/atomic/package-summary.html#Spurious" target="_blank" rel="noopener">意外失败</a></p><h2 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>&emsp;&emsp;1.CAS(compare-and-swap)，提供了原子性的读写能力。lock-free机制的基础。</p><p>&emsp;&emsp;2.当前内存值V，旧的预期值A，即将更新的值B。当且仅当预期值A和内存知V相同时，则修改内存值为B并且返回true,否则什么都不处理，并且返回false。</p><p>&emsp;&emsp;3.CAS的实现主要还是通过C++库去完成的，C++去调用CPU指令集，当然在不同的体系的结构中，CPU指令也会存在明显的不同。</p><h3 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h3><h4 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h4><p>&emsp;&emsp;某线程在CAS操作的时候，内存值V和预期值都是A。那么此刻，也可能有其他线程发生了A-&gt;B-&gt;A的操作，那么可能会导致不合理的操作出现。因此Java也引出了*<em>AtomicStampedReference *</em>来解决问题，主要是通过类型版本号(stamp)的机制来保证CAS。</p><h4 id="开销问题"><a href="#开销问题" class="headerlink" title="开销问题"></a>开销问题</h4><p>&emsp;&emsp;CAS主要使用失败重试的机制，大多数情况下重试基本一次就会成功。但是难免有例外，那么自旋的次数也会一定程序上打来CPU的开销。 </p><h2 id="部分源码解析"><a href="#部分源码解析" class="headerlink" title="部分源码解析"></a>部分源码解析</h2><h3 id="getAndIncrement-1"><a href="#getAndIncrement-1" class="headerlink" title="getAndIncrement"></a>getAndIncrement</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndIncrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getAndAddInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">int</span> var4)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> var5;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        var5 = <span class="keyword">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">    &#125; <span class="keyword">while</span>(!<span class="keyword">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.以<strong>getAndIncrement</strong>方法为例简单分析一下执行流程，其他方法基本类似，就不再去分析它的执行流程了。</p><p>&emsp;&emsp;2.假设同时有两个线程A,B通过<strong>getIntVolatile</strong>获取到了值都是<strong>1</strong>，线程A此刻挂起等待执行，此刻内存值和预期值都是<strong>1</strong>，线程B通过<strong>compareAndSwapInt</strong>正常通过CAS,将内存值刷新为<strong>2</strong>，退出执行流程。</p><p>&emsp;&emsp;3.此时线程A继续往下执行，但是内存值已经刷新为<strong>2</strong>，而线程A的期望值是<strong>1</strong>，此刻CAS失败，什么都不做。进入下一次循环，重新从<strong>getIntVolatile</strong>获取到值为<strong>2</strong>，再次进入CAS,正常操作将内存值刷新为<strong>3</strong>。</p><h3 id="lazySet-1"><a href="#lazySet-1" class="headerlink" title="lazySet"></a>lazySet</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lazySet</span><span class="params">(<span class="keyword">int</span> newValue)</span> </span>&#123;</span><br><span class="line">    unsafe.putOrderedInt(<span class="keyword">this</span>, valueOffset, newValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putOrderedInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">int</span> var4)</span></span>;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.简单雷说<strong>lazySet</strong>是<strong>set</strong>方法的一个不可见版本。它主要是在通过<strong>putOrderedInt</strong>修改了值以后对其他线程在短期内不可见，并且对当前线程也有一丁点的延迟效果。主要还是一种低端的优化策略。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> AtomicInteger i = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">// i.set(1);</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;2.上述代码中可以看见，<strong>lock.lock()</strong>和<strong>volatile</strong>关键字操作是一样的，都会强制是CPU的缓存失效。而<strong>lock.unlock()</strong>也类似，也会强制刷新CPU缓存，从而达到可见性，那么此刻，<strong>i.set(1)</strong>就可以采用<strong>lazySet</strong>来进行替换，进而减少不必要的内存屏障。那么采用锁来保证数据的可见性，以普通变量的形式去修改共享变量。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//set方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> newValue)</span> </span>&#123;</span><br><span class="line">    value = newValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;3.再次回顾<strong>set</strong>方法，可以发现他是直接操作的<strong>volatile</strong>关键字修饰的<strong>value</strong>,而<strong>lazySet</strong>则是通过<strong>unsafe.putOrderedInt</strong>通过初始化<strong>value</strong>的时候的偏移量找到字段地址，使用了本地方法去操作的。</p><table><thead><tr><th>屏障</th><th>set</th><th>lazySet</th></tr></thead><tbody><tr><td>写操作前</td><td>StoreStore</td><td>StoreStore</td></tr><tr><td>写操作后</td><td>StoreLoad</td><td>无</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-25-Event Driver模式</title>
      <link href="/2020/06/20/19907/hub/"/>
      <url>/2020/06/20/19907/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200621195732989.png" alt="image-20200621195732989"></p><p>&emsp;&emsp;EDA主要为了实现组件之间的解耦。</p><p>&emsp;&emsp;1.Events:需要被处理的数据</p><p>&emsp;&emsp;2.Event Handlers:处理Events的方法</p><p>&emsp;&emsp;3.Event Loop:维护Events和Event Handlers之间的交互流程</p><h2 id="初识EDA"><a href="#初识EDA" class="headerlink" title="初识EDA"></a>初识EDA</h2><h3 id="Event定义"><a href="#Event定义" class="headerlink" title="Event定义"></a>Event定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 业务类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 具体数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">(String type, String data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EvenrHandler定义"><a href="#EvenrHandler定义" class="headerlink" title="EvenrHandler定义"></a>EvenrHandler定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handlerA</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"handlerA print :"</span> + message.toLowerCase());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handlerB</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"handlerB print :"</span> + message.toUpperCase());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EventLoop实现"><a href="#EventLoop实现" class="headerlink" title="EventLoop实现"></a>EventLoop实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventLoop</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Event event;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LinkedList&lt;Event&gt; events = <span class="keyword">new</span> LinkedList&lt;Event&gt;();</span><br><span class="line">        events.addLast(<span class="keyword">new</span> Event(<span class="string">"A"</span>, <span class="string">"ABCDEFG"</span>));</span><br><span class="line">        events.addLast(<span class="keyword">new</span> Event(<span class="string">"B"</span>, <span class="string">"abcdefg"</span>));</span><br><span class="line">        <span class="keyword">while</span> (!events.isEmpty()) &#123;</span><br><span class="line">            event = events.removeLast();</span><br><span class="line">            <span class="keyword">switch</span> (event.getType()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"A"</span>:</span><br><span class="line">                    EventHandler.handlerA(event.getData());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"B"</span>:</span><br><span class="line">                    EventHandler.handlerB(event.getData());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="深入EDA"><a href="#深入EDA" class="headerlink" title="深入EDA"></a>深入EDA</h2><h3 id="同步化"><a href="#同步化" class="headerlink" title="同步化"></a>同步化</h3><h4 id="抽象执行Message"><a href="#抽象执行Message" class="headerlink" title="抽象执行Message"></a>抽象执行Message</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//每一个Message都有一个Type于Handler关联</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回Message类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? extends Message&gt; getType();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Channel处理管道"><a href="#Channel处理管道" class="headerlink" title="Channel处理管道"></a>Channel处理管道</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Channel</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">Message</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调度message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(E message)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="MessageMatchException异常处理"><a href="#MessageMatchException异常处理" class="headerlink" title="MessageMatchException异常处理"></a>MessageMatchException异常处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageMatchException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageMatchException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="路由处理DynamicRouter"><a href="#路由处理DynamicRouter" class="headerlink" title="路由处理DynamicRouter"></a>路由处理DynamicRouter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DynamicRouter</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">Message</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对类型注册channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerChannel</span><span class="params">(Class&lt;? extends E&gt; messageType, Channel&lt;? extends E&gt; channel)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分配message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(E message)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="路由实现EventDispatcher"><a href="#路由实现EventDispatcher" class="headerlink" title="路由实现EventDispatcher"></a>路由实现EventDispatcher</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventDispatcher</span> <span class="keyword">implements</span> <span class="title">DynamicRouter</span>&lt;<span class="title">Message</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;? extends Message&gt;, Channel&gt; routerTable;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventDispatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.routerTable = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerChannel</span><span class="params">(Class&lt;? extends Message&gt; messageType, Channel&lt;? extends Message&gt; channel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.routerTable.put(messageType, channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.routerTable.containsKey(message.getType())) &#123;</span><br><span class="line">            <span class="keyword">this</span>.routerTable.get(message.getType()).dispatch(message);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MessageMatchException(<span class="string">"The messageType :"</span> + message + <span class="string">" not find match channel."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="定义测试Event和Handler"><a href="#定义测试Event和Handler" class="headerlink" title="定义测试Event和Handler"></a>定义测试Event和Handler</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InputEvent</span> <span class="keyword">extends</span> <span class="title">Event</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> y;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InputEvent</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getX</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getY</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultEvent</span> <span class="keyword">extends</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> reuslt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResultEvent</span><span class="params">(<span class="keyword">int</span> reuslt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.reuslt = reuslt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getReuslt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> reuslt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultEventHandler</span> <span class="keyword">implements</span> <span class="title">Channel</span>&lt;<span class="title">ResultEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(ResultEvent message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"The message is : "</span> + message.getReuslt());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InputEventHandler</span> <span class="keyword">implements</span> <span class="title">Channel</span>&lt;<span class="title">InputEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventDispatcher dispatcher;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InputEventHandler</span><span class="params">(EventDispatcher dispatcher)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dispatcher = dispatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(InputEvent message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"x:"</span>+message.getX()+<span class="string">" y:"</span>+message.getY());</span><br><span class="line">        <span class="keyword">int</span> result = message.getX() + message.getY();</span><br><span class="line">        dispatcher.dispatch(<span class="keyword">new</span> ResultEvent(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    EventDispatcher dispatcher = <span class="keyword">new</span> EventDispatcher();</span><br><span class="line">    <span class="comment">//绑定InputEvent 和 执行 InputEventHandler</span></span><br><span class="line">    dispatcher.registerChannel(InputEvent<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">InputEventHandler</span>(<span class="title">dispatcher</span>))</span>;</span><br><span class="line">    <span class="comment">//ResultEvent 和 执行 ResultEventHandler</span></span><br><span class="line">    dispatcher.registerChannel(ResultEvent<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">ResultEventHandler</span>())</span>;</span><br><span class="line">    <span class="comment">//InputEvent会去寻找对应的InputEventHandler，而InputEventHandler又将结果交给了ResultEvent</span></span><br><span class="line">    <span class="comment">//ResultEvent又会去匹配ResultEventHandler最终输出结果</span></span><br><span class="line">    dispatcher.dispatch(<span class="keyword">new</span> InputEvent(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;值得注意的是EventDispatcher并不是线程安全的，所以当前只能在单线程环境下保证结果。</p><h3 id="异步化"><a href="#异步化" class="headerlink" title="异步化"></a>异步化</h3><h4 id="定义AsyncChannel"><a href="#定义AsyncChannel" class="headerlink" title="定义AsyncChannel"></a>定义AsyncChannel</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用线程池，它提供了任务队列</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncChannel</span> <span class="keyword">implements</span> <span class="title">Channel</span>&lt;<span class="title">Event</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 采用线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executorService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncChannel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(Executors.newFixedThreadPool(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncChannel</span><span class="params">(ExecutorService executorService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.executorService = executorService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Event message)</span> </span>&#123;</span><br><span class="line">        executorService.execute(() -&gt; <span class="keyword">this</span>.handler(message));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">handler</span><span class="params">(Event message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != executorService &amp;&amp; !executorService.isShutdown()) &#123;</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="路由实现AsyncEventDispatcher"><a href="#路由实现AsyncEventDispatcher" class="headerlink" title="路由实现AsyncEventDispatcher"></a>路由实现AsyncEventDispatcher</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//换用之前线程不安全的HashMap</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncEventDispatcher</span> <span class="keyword">implements</span> <span class="title">DynamicRouter</span>&lt;<span class="title">Event</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用线程安全的ConcurrentHashMap</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;? extends Event&gt;, AsyncChannel&gt; routerTable;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncEventDispatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.routerTable = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerChannel</span><span class="params">(Class&lt;? extends Event&gt; messageType, Channel&lt;? extends Event&gt; channel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(channel <span class="keyword">instanceof</span> AsyncChannel)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The channel must be AsyncChannle."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.routerTable.put(messageType, (AsyncChannel)channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Event message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!routerTable.containsKey(message.getType())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MessageMatchException(<span class="string">"The messageType :"</span> + message + <span class="string">" not find match channel."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.routerTable.get(message.getType()).dispatch(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.routerTable.values().forEach(AsyncChannel::stop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="重写异步Event"><a href="#重写异步Event" class="headerlink" title="重写异步Event"></a>重写异步Event</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncInputHandler</span> <span class="keyword">extends</span> <span class="title">AsyncChannel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AsyncEventDispatcher dispatch;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncInputHandler</span><span class="params">(AsyncEventDispatcher dispatch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dispatch = dispatch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handler</span><span class="params">(Event message)</span> </span>&#123;</span><br><span class="line">        EventDispatcher.InputEvent inputEvent = (EventDispatcher.InputEvent) message;</span><br><span class="line">        System.out.println(<span class="string">"x:"</span> + inputEvent.getX() + <span class="string">" y:"</span> + inputEvent.getY());</span><br><span class="line">        <span class="keyword">int</span> result = inputEvent.getX() + inputEvent.getY();</span><br><span class="line">        dispatch.dispatch(<span class="keyword">new</span> EventDispatcher.ResultEvent(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncResultEventHandler</span> <span class="keyword">extends</span> <span class="title">AsyncChannel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handler</span><span class="params">(Event message)</span> </span>&#123;</span><br><span class="line">        EventDispatcher.ResultEvent resultEvent = (EventDispatcher.ResultEvent) message;</span><br><span class="line">        System.out.println(<span class="string">"print result is:"</span> + resultEvent.getReuslt());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试运行-1"><a href="#测试运行-1" class="headerlink" title="测试运行"></a>测试运行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    AsyncEventDispatcher dispatcher = <span class="keyword">new</span> AsyncEventDispatcher();</span><br><span class="line">    dispatcher.registerChannel(EventDispatcher.InputEvent<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">AsyncInputHandler</span>(<span class="title">dispatcher</span>))</span>;</span><br><span class="line">    dispatcher.registerChannel(EventDispatcher.ResultEvent<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">AsyncResultEventHandler</span>())</span>;</span><br><span class="line">    dispatcher.dispatch(<span class="keyword">new</span> EventDispatcher.InputEvent(<span class="number">1</span>, <span class="number">3</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-24-Event Bus模式</title>
      <link href="/2020/06/20/14228/hub/"/>
      <url>/2020/06/20/14228/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200620142554487.png" alt="image-20200620142554487"></p><p>&emsp;&emsp;消息队列主要是为了服务间解耦，异步处理机制。可以使用消息队列的思想设计来实现一个Java进程内部的消息中间件。</p><p><img src="/image/hexo/image-20200620163105047.png" alt="image-20200620163105047"></p><h2 id="Event-Bus设计"><a href="#Event-Bus设计" class="headerlink" title="Event Bus设计"></a>Event Bus设计</h2><h3 id="Bus基础接口"><a href="#Bus基础接口" class="headerlink" title="Bus基础接口"></a>Bus基础接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义核心方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Bus</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册Subscriber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscriber</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消注册</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscriber</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交Event 默认topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交Event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event, String topic)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭Bus</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取bus名称标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getBusName</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Subscribe标记注解"><a href="#Subscribe标记注解" class="headerlink" title="Subscribe标记注解"></a>Subscribe标记注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用于方法上，可以指定topic</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Subscribe &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function">String <span class="title">topic</span><span class="params">()</span> <span class="keyword">default</span> "<span class="keyword">default</span>-topic"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Subscriber执行对象方法"><a href="#Subscriber执行对象方法" class="headerlink" title="Subscriber执行对象方法"></a>Subscriber执行对象方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subscriber</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object subscribeObject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标记方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Method subscribeMethod;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> disable = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Subscriber</span><span class="params">(Object subscribeObject, Method subscribeMethod)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subscribeObject = subscribeObject;</span><br><span class="line">        <span class="keyword">this</span>.subscribeMethod = subscribeMethod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getSubscribeObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> subscribeObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Method <span class="title">getSubscribeMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> subscribeMethod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDisable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> disable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDisable</span><span class="params">(<span class="keyword">boolean</span> disable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.disable = disable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EventContext接口定义"><a href="#EventContext接口定义" class="headerlink" title="EventContext接口定义"></a>EventContext接口定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要给异常回调接口使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EventContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取消息源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getSource</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取subscriber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Object <span class="title">getSubscriber</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取执行方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Method <span class="title">getSubscribe</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Object <span class="title">getEvent</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EventExceptionHandler异常回调接口"><a href="#EventExceptionHandler异常回调接口" class="headerlink" title="EventExceptionHandler异常回调接口"></a>EventExceptionHandler异常回调接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EventExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(Throwable cause, EventContext eventContext)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Registry注册表"><a href="#Registry注册表" class="headerlink" title="Registry注册表"></a>Registry注册表</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Registry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * topic 和 subscribe</span></span><br><span class="line"><span class="comment">     * 一个topic下可以有多个Subscriber</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, ConcurrentLinkedQueue&lt;Subscriber&gt;&gt; subscriberContainer = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscriber</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">        List&lt;Method&gt; subscriberMethods = getSubscribeMethods(subscriber);</span><br><span class="line">        subscriberMethods.forEach(s -&gt; tierSubscriber(subscriber, s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">        subscriberContainer.forEach((key,queue)-&gt;&#123;</span><br><span class="line">            queue.forEach(s-&gt;&#123;</span><br><span class="line">                <span class="keyword">if</span> (s.getSubscribeObject() == subscriber) &#123;</span><br><span class="line">                    <span class="comment">//仅仅设置失效操作</span></span><br><span class="line">                    s.setDisable(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * tier</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscriber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tierSubscriber</span><span class="params">(Object subscriber, Method method)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Subscribe注解</span></span><br><span class="line">        <span class="keyword">final</span> Subscribe subscribe = method.getDeclaredAnnotation(Subscribe<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        String topic = subscribe.topic();</span><br><span class="line">        <span class="comment">//key不存在则创建</span></span><br><span class="line">        subscriberContainer.computeIfAbsent(topic, key -&gt; <span class="keyword">new</span> ConcurrentLinkedQueue&lt;&gt;());</span><br><span class="line">        <span class="comment">//加入subscriber列表</span></span><br><span class="line">        subscriberContainer.get(topic).add(<span class="keyword">new</span> Subscriber(subscriber, method));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取subscriber的所有满足条件的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscriber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Method&gt; <span class="title">getSubscribeMethods</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;Method&gt; methods = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Class&lt;?&gt; temp = subscriber.getClass();</span><br><span class="line">        <span class="keyword">while</span> (temp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//获取所有的方法</span></span><br><span class="line">            Method[] declaredMethods = temp.getDeclaredMethods();</span><br><span class="line">            <span class="comment">//过滤条件</span></span><br><span class="line">            <span class="comment">//1.public修饰的方法</span></span><br><span class="line">            <span class="comment">//2.有一个入参</span></span><br><span class="line">            <span class="comment">//3.被Subscribe标记</span></span><br><span class="line">            Arrays.stream(declaredMethods)</span><br><span class="line">                    .filter(m -&gt; m.isAnnotationPresent(Subscribe<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                            &amp;&amp; <span class="title">m</span>.<span class="title">getParameterCount</span>() </span>== <span class="number">1</span></span><br><span class="line">                            &amp;&amp; m.getModifiers() == Modifier.PUBLIC)</span><br><span class="line">                    .forEach(methods::add);</span><br><span class="line">            <span class="comment">//获取父类</span></span><br><span class="line">            temp = temp.getSuperclass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methods;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取topic下的Subscriber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcurrentLinkedQueue&lt;Subscriber&gt; <span class="title">scanSubscriber</span><span class="params">(<span class="keyword">final</span> String topic)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> subscriberContainer.get(topic);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Dispatcher核心调用执行"><a href="#Dispatcher核心调用执行" class="headerlink" title="Dispatcher核心调用执行"></a>Dispatcher核心调用执行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.主要通过反射调用方法</span></span><br><span class="line"><span class="comment">//2.外部提供线程池</span></span><br><span class="line"><span class="comment">//3.自带默认提供依次顺序执行的方法（单线程）</span></span><br><span class="line"><span class="comment">//4.自带默认提供一个线程负责执行一个的方法（多线程）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Executor executorService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常handle</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventExceptionHandler eventExceptionHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 顺序执行的线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor SEQ_EXECUTOR_SERVICE = SeqExecutorService.INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每个线程负责一次推送</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor PRE_EXECUTOR_SERVICE = PreExecutorService.INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dispatcher</span><span class="params">(Executor executorService, EventExceptionHandler eventExceptionHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.executorService = executorService;</span><br><span class="line">        <span class="keyword">this</span>.eventExceptionHandler = eventExceptionHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SeqExecutorService</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> SeqExecutorService INSTANCE = <span class="keyword">new</span> SeqExecutorService();</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">            command.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PreExecutorService</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> PreExecutorService INSTANCE = <span class="keyword">new</span> PreExecutorService();</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(command).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEventContext</span> <span class="keyword">implements</span> <span class="title">EventContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * event名称</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String eventBusName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 执行实例对象</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Subscriber subscriber;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 所属event</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Object event;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BaseEventContext</span><span class="params">(String eventBusName, Subscriber subscriber, Object event)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.eventBusName = eventBusName;</span><br><span class="line">            <span class="keyword">this</span>.subscriber = subscriber;</span><br><span class="line">            <span class="keyword">this</span>.event = event;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.eventBusName;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getSubscriber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.subscriber != <span class="keyword">null</span> ? subscriber.getSubscribeObject() : <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Method <span class="title">getSubscribe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> subscriber != <span class="keyword">null</span> ? subscriber.getSubscribeMethod() : <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.event;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Bus bus, Registry registry, Object event, String topic)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取topic下的Subscriber</span></span><br><span class="line">        ConcurrentLinkedQueue&lt;Subscriber&gt; subscribers = registry.scanSubscriber(topic);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == subscribers) &#123;</span><br><span class="line">            <span class="keyword">if</span> (eventExceptionHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">                eventExceptionHandler.handle(<span class="keyword">new</span> IllegalArgumentException(<span class="string">"The topic "</span> + topic + <span class="string">" not bind yet."</span>), <span class="keyword">new</span> BaseEventContext(bus.getBusName(), <span class="keyword">null</span>, event));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        subscribers.stream()</span><br><span class="line">                .filter(subscriber -&gt; !subscriber.isDisable())</span><br><span class="line">                .filter(subscriber -&gt; &#123;</span><br><span class="line">                    Method subscribeMethod = subscriber.getSubscribeMethod();</span><br><span class="line">                    Class&lt;?&gt; classzz = subscribeMethod.getParameterTypes()[<span class="number">0</span>];</span><br><span class="line">                    <span class="comment">//isAssignableFrom()方法是判断是否为某个类的父类</span></span><br><span class="line">                    <span class="keyword">return</span> classzz.isAssignableFrom(event.getClass());</span><br><span class="line">                &#125;).forEach(subscriber -&gt; realInvokeSubscribe(subscriber, event, bus));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subscriber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bus</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">realInvokeSubscribe</span><span class="params">(Subscriber subscriber, Object event, Bus bus)</span> </span>&#123;</span><br><span class="line">        Method subscribeMethod = subscriber.getSubscribeMethod();</span><br><span class="line">        Object subscribeObject = subscriber.getSubscribeObject();</span><br><span class="line">        executorService.execute(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//反射开始调用Method</span></span><br><span class="line">                subscribeMethod.invoke(subscribeObject, event);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != eventExceptionHandler) &#123;</span><br><span class="line">                    eventExceptionHandler.handle(e, <span class="keyword">new</span> BaseEventContext(bus.getBusName(), subscriber, event));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (executorService <span class="keyword">instanceof</span> ExecutorService) &#123;</span><br><span class="line">            ((ExecutorService) executorService).shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Dispatcher <span class="title">newDispatcher</span><span class="params">(EventExceptionHandler eventExceptionHandler, Executor executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Dispatcher(executor, eventExceptionHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Dispatcher <span class="title">seqDispatcher</span><span class="params">(EventExceptionHandler eventExceptionHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Dispatcher(SEQ_EXECUTOR_SERVICE, eventExceptionHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Dispatcher <span class="title">preDispatcher</span><span class="params">(EventExceptionHandler eventExceptionHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Dispatcher(PRE_EXECUTOR_SERVICE, eventExceptionHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="同步EventBus"><a href="#同步EventBus" class="headerlink" title="同步EventBus"></a>同步EventBus</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventBus</span> <span class="keyword">implements</span> <span class="title">Bus</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Registry registry = <span class="keyword">new</span> Registry();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String busName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_NAME = <span class="string">"default_bus_name"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_TOPIC_NAME = <span class="string">"default_bus_topic"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Dispatcher dispatcher;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventBus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_NAME, <span class="keyword">null</span>, Dispatcher.SEQ_EXECUTOR_SERVICE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventBus</span><span class="params">(String busName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(busName, <span class="keyword">null</span>, Dispatcher.SEQ_EXECUTOR_SERVICE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventBus</span><span class="params">(EventExceptionHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_NAME, handler, Dispatcher.SEQ_EXECUTOR_SERVICE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventBus</span><span class="params">(String busName, EventExceptionHandler handler, Executor executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.busName = busName;</span><br><span class="line">        <span class="keyword">this</span>.dispatcher = Dispatcher.newDispatcher(handler, executor);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">        registry.bind(subscriber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">        registry.unbind(subscriber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.post(event,DEFAULT_TOPIC_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event, String topic)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dispatcher.dispatch(<span class="keyword">this</span>, registry, event, topic);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dispatcher.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBusName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.busName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="异步AsyncEventBus"><a href="#异步AsyncEventBus" class="headerlink" title="异步AsyncEventBus"></a>异步AsyncEventBus</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncEventBus</span> <span class="keyword">extends</span> <span class="title">EventBus</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_NAME = <span class="string">"default_async_bus_name"</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    AsyncEventBus(String busName, EventExceptionHandler handler, ThreadPoolExecutor executor) &#123;</span><br><span class="line">        <span class="keyword">super</span>(busName, handler, executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncEventBus</span><span class="params">(String busName, ThreadPoolExecutor executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(busName, <span class="keyword">null</span>, executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncEventBus</span><span class="params">(ThreadPoolExecutor executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(DEFAULT_NAME, <span class="keyword">null</span>, executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncEventBus</span><span class="params">(EventExceptionHandler handler,ThreadPoolExecutor executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(DEFAULT_NAME, handler, executor);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventBusTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//同步</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Bus bus = <span class="keyword">new</span> EventBus(<span class="string">"Test_Bus"</span>);</span><br><span class="line">        bus.register(<span class="keyword">new</span> SimpleSubscriber1());</span><br><span class="line">        bus.register(<span class="keyword">new</span> SimpleSubscriber2());</span><br><span class="line">        bus.post(<span class="string">"11111"</span>,<span class="string">"SimpleSubscriber1"</span>);</span><br><span class="line">        System.out.println(<span class="string">"------------------------------"</span>);</span><br><span class="line">        bus.post(<span class="string">"22222"</span>,<span class="string">"SimpleSubscriber2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleSubscriber1</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe</span>(topic = <span class="string">"SimpleSubscriber1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"SimpleSubscriber1 name is :"</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleSubscriber2</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe</span>(topic = <span class="string">"SimpleSubscriber2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"SimpleSubscriber2 name is :"</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventBusTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//异步</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Bus bus = <span class="keyword">new</span> AsyncEventBus(<span class="string">"Test_Async"</span>, (ThreadPoolExecutor) Executors.newFixedThreadPool(<span class="number">10</span>));</span><br><span class="line">        bus.register(<span class="keyword">new</span> SimpleSubscriber1());</span><br><span class="line">        bus.register(<span class="keyword">new</span> SimpleSubscriber2());</span><br><span class="line">        bus.post(<span class="string">"11111"</span>,<span class="string">"SimpleSubscriber1"</span>);</span><br><span class="line">        System.out.println(<span class="string">"------------------------------"</span>);</span><br><span class="line">        bus.post(<span class="string">"22222"</span>,<span class="string">"SimpleSubscriber2"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Event-Bus监控磁盘目录变化"><a href="#Event-Bus监控磁盘目录变化" class="headerlink" title="Event Bus监控磁盘目录变化"></a>Event Bus监控磁盘目录变化</h2><p>&emsp;&emsp;利用WatchService去监控文件或者目录的变化情况。</p><h3 id="DirectoryTargetMonitor"><a href="#DirectoryTargetMonitor" class="headerlink" title="DirectoryTargetMonitor"></a>DirectoryTargetMonitor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectoryTargetMonitor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> WatchService watchService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Bus bus;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Path path;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> start = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DirectoryTargetMonitor</span><span class="params">(<span class="keyword">final</span> Bus bus, <span class="keyword">final</span> String target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(bus, target, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DirectoryTargetMonitor</span><span class="params">(Bus bus, String target, <span class="keyword">final</span> String... morePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bus = bus;</span><br><span class="line">        <span class="keyword">this</span>.path = Paths.get(target, morePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startMonitor</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.watchService = FileSystems.getDefault().newWatchService();</span><br><span class="line">        <span class="keyword">this</span>.path.register(watchService, StandardWatchEventKinds.ENTRY_MODIFY,</span><br><span class="line">                StandardWatchEventKinds.ENTRY_DELETE,</span><br><span class="line">                StandardWatchEventKinds.ENTRY_CREATE);</span><br><span class="line">        System.out.printf(<span class="string">"The directory [%s] is monitoring ... \n"</span>,path);</span><br><span class="line">        <span class="keyword">this</span>.start = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (start) &#123;</span><br><span class="line">            WatchKey watchKey = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                watchKey = watchService.take();</span><br><span class="line">                watchKey.pollEvents().forEach(event-&gt;&#123;</span><br><span class="line">                    WatchEvent.Kind&lt;?&gt; kind = event.kind();</span><br><span class="line">                    Path path = (Path)event.context();</span><br><span class="line">                    Path child = DirectoryTargetMonitor.<span class="keyword">this</span>.path.resolve(path);</span><br><span class="line">                    bus.post(<span class="keyword">new</span> FileChangeEvent(child, kind));</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">this</span>.start = <span class="keyword">false</span>;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (watchKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    watchKey.reset();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">"The directory [%s] is monitor will be shutdown ... \n"</span>,path);</span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">        <span class="keyword">this</span>.start = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.watchService.close();</span><br><span class="line">        System.out.printf(<span class="string">"The directory [%s] is monitor shutdown successful... \n"</span>,path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FileChangeEvent"><a href="#FileChangeEvent" class="headerlink" title="FileChangeEvent"></a>FileChangeEvent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileChangeEvent</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Path path;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WatchEvent.Kind&lt;?&gt; kind;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileChangeEvent</span><span class="params">(Path path, WatchEvent.Kind&lt;?&gt; kind)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.path = path;</span><br><span class="line">        <span class="keyword">this</span>.kind = kind;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Path <span class="title">getPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> WatchEvent.Kind&lt;?&gt; getKind() &#123;</span><br><span class="line">        <span class="keyword">return</span> kind;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试运行-1"><a href="#测试运行-1" class="headerlink" title="测试运行"></a>测试运行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectoryTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ThreadPoolExecutor executor = (ThreadPoolExecutor) Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">final</span> EventBus eventBus = <span class="keyword">new</span> AsyncEventBus(executor);</span><br><span class="line">        eventBus.register(<span class="keyword">new</span> FileChangeListener());</span><br><span class="line">        DirectoryTargetMonitor monitor = <span class="keyword">new</span> DirectoryTargetMonitor(eventBus, <span class="string">"D:\\"</span>);</span><br><span class="line">        monitor.startMonitor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileChangeListener</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subscribe</span>(topic = <span class="string">"default_bus_topic"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(FileChangeEvent event)</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">"%S-%s\n"</span>, event.getPath(), event.getKind());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-23-Active Objects模式</title>
      <link href="/2020/06/19/59842/hub/"/>
      <url>/2020/06/19/59842/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200619181039487.png" alt="image-20200619181039487"></p><p>&emsp;&emsp;接受异步消息的主动对象，主要是通过代理将执行方法转换变为向阻塞队列中添加了一个请求，由以恶搞线程取出执行实际的业务逻辑方法，最后将执行结果设置到Future。</p><p><img src="/image/hexo/image-20200619200546183.png" alt="image-20200619200546183"></p><h2 id="常规方法处理"><a href="#常规方法处理" class="headerlink" title="常规方法处理"></a>常规方法处理</h2><h3 id="Future相关"><a href="#Future相关" class="headerlink" title="Future相关"></a>Future相关</h3><h4 id="定义Future"><a href="#定义Future" class="headerlink" title="定义Future"></a>定义Future</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取执行结果，如果没有执行完毕调用则会使线程陷入阻塞</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">T <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断任务是否执行完毕</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">done</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="定义Task"><a href="#定义Task" class="headerlink" title="定义Task"></a>定义Task</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Task</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算返回的执行结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">R <span class="title">get</span><span class="params">(T t)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="定义FutureService"><a href="#定义FutureService" class="headerlink" title="定义FutureService"></a>定义FutureService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FutureService</span>&lt;<span class="title">T</span>,<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交任务无需返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> runnable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Future&lt;?&gt; submit(Runnable runnable);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交任务返回最终结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Future&lt;R&gt; <span class="title">submit</span><span class="params">(Task&lt;T, R&gt; task, T t)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &lt;T,R&gt; <span class="function">FutureService&lt;T,R&gt; <span class="title">newService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FutureServiceImpl&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现FutureServiceImple"><a href="#实现FutureServiceImple" class="headerlink" title="实现FutureServiceImple"></a>实现FutureServiceImple</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureServiceImpl</span>&lt;<span class="title">T</span>,<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">FutureService</span>&lt;<span class="title">T</span>,<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String FUTURE_THREAD_PREFIX = <span class="string">"FUTURE_"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger nextCounter = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNextName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FUTURE_THREAD_PREFIX + nextCounter.getAndIncrement();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Future&lt;?&gt; submit(Runnable runnable) &#123;</span><br><span class="line">        <span class="keyword">final</span> FutureTask&lt;Void&gt; future = <span class="keyword">new</span> FutureTask&lt;&gt;();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            runnable.run();</span><br><span class="line">            <span class="comment">//逻辑单元执行完毕通知finish</span></span><br><span class="line">            future.finish(<span class="keyword">null</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">return</span> future;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future&lt;R&gt; <span class="title">submit</span><span class="params">(Task&lt;T, R&gt; task, T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> FutureTask&lt;R&gt; future = <span class="keyword">new</span> FutureTask&lt;&gt;();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            R result = task.get(t);</span><br><span class="line">            <span class="comment">//逻辑单元执行完毕通知finish</span></span><br><span class="line">            future.finish(result);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">return</span> future;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="定义ActiveFuture"><a href="#定义ActiveFuture" class="headerlink" title="定义ActiveFuture"></a>定义ActiveFuture</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//任务队列使用ActiveFuture</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveFuture</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">FutureTask</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(T result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.finish(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Order相关"><a href="#Order相关" class="headerlink" title="Order相关"></a>Order相关</h3><h4 id="定义OrderService"><a href="#定义OrderService" class="headerlink" title="定义OrderService"></a>定义OrderService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Future&lt;String&gt; <span class="title">findOrderInfo</span><span class="params">(<span class="keyword">long</span> orderId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> account</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">order</span><span class="params">(String account, <span class="keyword">long</span> orderId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="定义OrderServiceImpl"><a href="#定义OrderServiceImpl" class="headerlink" title="定义OrderServiceImpl"></a>定义OrderServiceImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">findOrderInfo</span><span class="params">(<span class="keyword">long</span> orderId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FutureService.&lt;Long,String&gt;newService().submit(input-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"The orderId Info."</span>;</span><br><span class="line">        &#125;,orderId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">order</span><span class="params">(String account, <span class="keyword">long</span> orderId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            System.out.println(<span class="string">"process the order for account "</span> + account + <span class="string">" orderId :"</span> + orderId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="定义OrderServerProxy"><a href="#定义OrderServerProxy" class="headerlink" title="定义OrderServerProxy"></a>定义OrderServerProxy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServerProxy</span> <span class="keyword">implements</span> <span class="title">OrderService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActiveMessageQueue activeMessageQueue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderServerProxy</span><span class="params">(OrderService orderService, ActiveMessageQueue activeMessageQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderService = orderService;</span><br><span class="line">        <span class="keyword">this</span>.activeMessageQueue = activeMessageQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">findOrderInfo</span><span class="params">(<span class="keyword">long</span> orderId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对于带有返回值的 activeFuture 是实际执行的和等待的Future</span></span><br><span class="line">        <span class="keyword">final</span> ActiveFuture&lt;String&gt; activeFuture = <span class="keyword">new</span> ActiveFuture&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//收集方法入参</span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">"orderId"</span>, orderId);</span><br><span class="line">        <span class="comment">//任务Future 随着方法的执行跟随业务流动绑定在message中，当message执行完毕通知Future</span></span><br><span class="line">        params.put(<span class="string">"activeFuture"</span>, activeFuture);</span><br><span class="line">        <span class="comment">//封装Message</span></span><br><span class="line">        MethodMessage message = <span class="keyword">new</span> FindOrderDetailsMessage(params, orderService);</span><br><span class="line">        <span class="comment">//将执行方法压入队列</span></span><br><span class="line">        activeMessageQueue.offer(message);</span><br><span class="line">        <span class="keyword">return</span> activeFuture;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">order</span><span class="params">(String account, <span class="keyword">long</span> orderId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//收集方法入参</span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">"orderId"</span>, orderId);</span><br><span class="line">        params.put(<span class="string">"account"</span>, account);</span><br><span class="line">        MethodMessage message = <span class="keyword">new</span> OrderMessage(params, orderService);</span><br><span class="line">        <span class="comment">//将执行方法压入队列</span></span><br><span class="line">        activeMessageQueue.offer(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Message相关"><a href="#Message相关" class="headerlink" title="Message相关"></a>Message相关</h3><h4 id="定义MethodMessage"><a href="#定义MethodMessage" class="headerlink" title="定义MethodMessage"></a>定义MethodMessage</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//抽象方法message</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, Object&gt; params;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodMessage</span><span class="params">(Map&lt;String, Object&gt; params, OrderService orderService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.params = params;</span><br><span class="line">        <span class="keyword">this</span>.orderService = orderService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现FindOrderDetailsMessage"><a href="#实现FindOrderDetailsMessage" class="headerlink" title="实现FindOrderDetailsMessage"></a>实现FindOrderDetailsMessage</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FindOrderDetailsMessage</span> <span class="keyword">extends</span> <span class="title">MethodMessage</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FindOrderDetailsMessage</span><span class="params">(Map&lt;String, Object&gt; params, OrderService orderService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(params, orderService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//真正开始执行业务的Future</span></span><br><span class="line">        Future&lt;String&gt; realFuture = orderService.findOrderInfo((Long) params.get(<span class="string">"orderId"</span>));</span><br><span class="line">        <span class="comment">//实际执行时返回的Future</span></span><br><span class="line">        ActiveFuture&lt;String&gt; activeFuture = (ActiveFuture&lt;String&gt;) params.get(<span class="string">"activeFuture"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String result = realFuture.get();</span><br><span class="line">            activeFuture.finish(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            activeFuture.finish(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现OrderMessage"><a href="#实现OrderMessage" class="headerlink" title="实现OrderMessage"></a>实现OrderMessage</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderMessage</span> <span class="keyword">extends</span> <span class="title">MethodMessage</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderMessage</span><span class="params">(Map&lt;String, Object&gt; params, OrderService orderService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(params, orderService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String account = (String) params.get(<span class="string">"account"</span>);</span><br><span class="line">        Long orderId = (Long) params.get(<span class="string">"orderId"</span>);</span><br><span class="line">        orderService.order(account, orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="任务执行队列相关"><a href="#任务执行队列相关" class="headerlink" title="任务执行队列相关"></a>任务执行队列相关</h3><h4 id="ActiveMessageQueue实现"><a href="#ActiveMessageQueue实现" class="headerlink" title="ActiveMessageQueue实现"></a>ActiveMessageQueue实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveMessageQueue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行方法队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;MethodMessage&gt; methodMessages = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActiveMessageQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//开启线程</span></span><br><span class="line">        <span class="keyword">new</span> ActiveMessageThread(<span class="keyword">this</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 压入执行方法进入队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> methodMessage</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span><span class="params">(MethodMessage methodMessage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            methodMessages.addLast(methodMessage);</span><br><span class="line">            <span class="keyword">this</span>.notify();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 弹出执行方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodMessage <span class="title">take</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (methodMessages.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> methodMessages.removeFirst();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="方法执行消费线程ActiveMessageThread"><a href="#方法执行消费线程ActiveMessageThread" class="headerlink" title="方法执行消费线程ActiveMessageThread"></a>方法执行消费线程ActiveMessageThread</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveMessageThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActiveMessageQueue queue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActiveMessageThread</span><span class="params">(ActiveMessageQueue queue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"ActiveMessageThread"</span>);</span><br><span class="line">        <span class="keyword">this</span>.queue = queue;</span><br><span class="line">        setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//实际上开始执行的地方</span></span><br><span class="line">            MethodMessage message = <span class="keyword">this</span>.queue.take();</span><br><span class="line">            message.execute();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动消费线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ActiveMessageQueue queue = <span class="keyword">new</span> ActiveMessageQueue();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">OrderServiceFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> OrderService <span class="title">toActiveObject</span><span class="params">(OrderService orderService)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//返回的OrderService是OrderServerProxy代理，而不会实际的去执行OrderServerImpl</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OrderServerProxy(orderService, queue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        OrderService orderService = OrderServiceFactory.toActiveObject(<span class="keyword">new</span> OrderServiceImpl());</span><br><span class="line">        <span class="comment">//orderService实际是代理对象将下面的方法压入了队列</span></span><br><span class="line">        orderService.order(<span class="string">"hello"</span>, <span class="number">123456</span>);</span><br><span class="line">        Future&lt;String&gt; future = orderService.findOrderInfo(<span class="number">123456</span>);</span><br><span class="line">        String result = future.get();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        Thread.currentThread().join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200619210737527.png" alt="image-20200619210737527"></p><p>&emsp;&emsp;整个借助Future，核心将message和Future绑定，跟随业务带走，任务压入队列会立即返回一个Future，但是可能此刻任务队列还没执行message，那么此刻线程会进入等待状态，这个Future就是跟随message绑定的Future，当message执行完毕通知Future完成操作那么此刻线程恢复正常状态。</p><h2 id="更加通用的Active-Object设计"><a href="#更加通用的Active-Object设计" class="headerlink" title="更加通用的Active Object设计"></a>更加通用的Active Object设计</h2><h3 id="方法标记注解ActiveMethod"><a href="#方法标记注解ActiveMethod" class="headerlink" title="方法标记注解ActiveMethod"></a>方法标记注解ActiveMethod</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ActiveMethod &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ActiveMessage消息构建"><a href="#ActiveMessage消息构建" class="headerlink" title="ActiveMessage消息构建"></a>ActiveMessage消息构建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActiveMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接口方法参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] objects;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接口方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Method method;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 具有返回值类型的方法返回一个Future</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActiveFuture&lt;Object&gt; future;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行方法的接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ActiveMessage(Builder builder) &#123;</span><br><span class="line">        <span class="keyword">this</span>.future = builder.future;</span><br><span class="line">        <span class="keyword">this</span>.method = builder.method;</span><br><span class="line">        <span class="keyword">this</span>.service = builder.service;</span><br><span class="line">        <span class="keyword">this</span>.objects = builder.objects;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//result执行结果</span></span><br><span class="line">            Object result = method.invoke(service, objects);</span><br><span class="line">            <span class="keyword">if</span> (future != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//通知Future</span></span><br><span class="line">                Future&lt;?&gt; realFuture = (Future&lt;?&gt;) result;</span><br><span class="line">                <span class="comment">//真正的执行结果</span></span><br><span class="line">                Object realResult = realFuture.get();</span><br><span class="line">                future.finish(realResult);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            future.finish(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * builder构建器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Object[] objects;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Method method;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> ActiveFuture&lt;Object&gt; future;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Object service;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">userMethod</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.method = method;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">returnFuture</span><span class="params">(ActiveFuture&lt;Object&gt; future)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.future = future;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">withObjects</span><span class="params">(Object[] objects)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.objects = objects;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">forService</span><span class="params">(Object service)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.service = service;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ActiveMessage <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ActiveMessage(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实现类增加ActiveMethod注解"><a href="#实现类增加ActiveMethod注解" class="headerlink" title="实现类增加ActiveMethod注解"></a>实现类增加ActiveMethod注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActiveMethod</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">findOrderInfo</span><span class="params">(<span class="keyword">long</span> orderId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FutureService.&lt;Long,String&gt;newService().submit(input-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"The orderId Info."</span>;</span><br><span class="line">        &#125;,orderId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ActiveMethod</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">order</span><span class="params">(String account, <span class="keyword">long</span> orderId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            System.out.println(<span class="string">"process the order for account "</span> + account + <span class="string">" orderId :"</span> + orderId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="替换Factory（ActiveServiceFactory）"><a href="#替换Factory（ActiveServiceFactory）" class="headerlink" title="替换Factory（ActiveServiceFactory）"></a>替换Factory（ActiveServiceFactory）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveServiceFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法任务执行队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ActiveMessageQueue queue = <span class="keyword">new</span> ActiveMessageQueue();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">active</span><span class="params">(T instance)</span> </span>&#123;</span><br><span class="line">        Object proxy = Proxy.newProxyInstance(instance.getClass().getClassLoader(),</span><br><span class="line">                instance.getClass().getInterfaces(), <span class="keyword">new</span> ActiveInvocationHandler&lt;&gt;(instance));</span><br><span class="line">        <span class="keyword">return</span> (T)proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveInvocationHandler</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> T instance;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ActiveInvocationHandler</span><span class="params">(T instance)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.instance = instance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (findAnnotationFromProxy(ActiveMethod<span class="class">.<span class="keyword">class</span>, <span class="title">instance</span>, <span class="title">method</span>)) </span>&#123;</span><br><span class="line">                <span class="comment">//方法检测</span></span><br><span class="line">                <span class="keyword">this</span>.checkMethod(method);</span><br><span class="line">                ActiveMessage.Builder builder = <span class="keyword">new</span> ActiveMessage.Builder();</span><br><span class="line">                <span class="comment">//方法队列构建</span></span><br><span class="line">                builder.userMethod(method)</span><br><span class="line">                        .withObjects(args)</span><br><span class="line">                        .forService(instance);</span><br><span class="line">                Object result = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.isReturnFutureType(method)) &#123;</span><br><span class="line">                    result = <span class="keyword">new</span> ActiveFuture&lt;&gt;();</span><br><span class="line">                    builder.returnFuture((ActiveFuture) result);</span><br><span class="line">                &#125;</span><br><span class="line">                queue.offer(builder.build());</span><br><span class="line">                System.out.println(<span class="string">"通过方法检验 method name is: "</span> + method.getName());</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> method.invoke(instance, args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这个需要留意，JDK代理获取实现类的方法注解</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">findAnnotationFromProxy</span><span class="params">(Class&lt;?&gt; cusAnnotation, Object target, Method method)</span> <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line">            Annotation[] annotations = target.getClass().getMethod(method.getName(), method.getParameterTypes()).getAnnotations();</span><br><span class="line">            <span class="keyword">boolean</span> hasAnnotation = Arrays.stream(annotations).filter(annotation -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> annotation.annotationType().isAssignableFrom(cusAnnotation);</span><br><span class="line">            &#125;).count() &gt; <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> hasAnnotation;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 执行方法检验</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> method</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> IllegalActiveMethod</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkMethod</span><span class="params">(Method method)</span> <span class="keyword">throws</span> IllegalActiveMethod </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!isReturnVoidType(method) &amp;&amp; !isReturnFutureType(method)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalActiveMethod(<span class="string">"The method ["</span> + method.getName() + <span class="string">"] return type must be void/Future"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReturnFutureType</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> method.getReturnType().isAssignableFrom(Future<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReturnVoidType</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> method.getReturnType().equals(Void.TYPE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="修改执行方法队列ActiveMessageQueue"><a href="#修改执行方法队列ActiveMessageQueue" class="headerlink" title="修改执行方法队列ActiveMessageQueue"></a>修改执行方法队列ActiveMessageQueue</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveMessageQueue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行方法队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;ActiveMessage&gt; methodMessages = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActiveMessageQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//开启线程</span></span><br><span class="line">        <span class="keyword">new</span> ActiveMessageThread(<span class="keyword">this</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 压入执行方法进入队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> methodMessage</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span><span class="params">(ActiveMessage methodMessage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"压入message = "</span> + methodMessage);</span><br><span class="line">            methodMessages.addLast(methodMessage);</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 弹出执行方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActiveMessage <span class="title">take</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"methodMessages -&gt; "</span>+methodMessages.size());</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (methodMessages.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> methodMessages.removeFirst();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试运行-1"><a href="#测试运行-1" class="headerlink" title="测试运行"></a>测试运行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    OrderService orderService = ActiveServiceFactory.active(<span class="keyword">new</span> OrderServiceImpl());</span><br><span class="line">    orderService.order(<span class="string">"hello"</span>, <span class="number">123456</span>);</span><br><span class="line">    Future&lt;String&gt; future = orderService.findOrderInfo(<span class="number">123456</span>);</span><br><span class="line">    String result = future.get();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    Thread.currentThread().join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200620141726817.png" alt="image-20200620141726817"></p><p>&emsp;&emsp;在做海康威视门禁服务的时候，当时采用了线程池来实现。具体业务是云端的门禁服务发送MQ消息进入到小区物业的本地门禁服务中，然后操作设备进行磁卡操作，人脸识别，一件开门等操作。MQ消息收到进入到了一个任务队列，然后不断的弹出消息进行消费，可以采用这种message方式或者worker模式，但是都有一个弊端，那就是MQ下发后不断的压入message队列，那么本地队列在压入的时候就会失效，那么此时主动关闭进程或者异常关闭进程，已经在message队列中的方法是不会执行的，也就是缺少一个持久化的机制，这个根据业务需要锁决定，我是根据目前所接手的一个项目进行了一个分析。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信开发-公众号-常用API-02-高级群发系列</title>
      <link href="/2020/06/19/5931/hub/"/>
      <url>/2020/06/19/5931/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200619082908319.png" alt="image-20200619082908319"></p><p>&emsp;&emsp;高级群发接口基本都是需要认证，测试账号和普通公众号调用接口可能会提示无权限。</p><p>&emsp;&emsp;<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Batch_Sends_and_Originality_Checks.html" target="_blank" rel="noopener">官方文档</a></p><h2 id="群发接口"><a href="#群发接口" class="headerlink" title="群发接口"></a>群发接口</h2><p>&emsp;&emsp;<strong>测试和个人公众号无法调起该接口，需要认证公众号。</strong></p><p>&emsp;&emsp;<strong>以下群发以图文信息为demo进行调试，其余类型的数据都是通用的，可以自行进行调试。</strong></p><h3 id="全部用户进行群发"><a href="#全部用户进行群发" class="headerlink" title="全部用户进行群发"></a>全部用户进行群发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    bulkNews();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 群发图文推文信息</span></span><br><span class="line"><span class="comment"> * 测试号不允许发送没有权限</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bulkNews</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    JSONObject filter = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    filter.put(<span class="string">"is_to_all"</span>,<span class="keyword">true</span>);</span><br><span class="line">    JSONObject mpnews = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    mpnews.put(<span class="string">"media_id"</span>,<span class="string">"0yXThHza9feOGzsZjoEvcsJXWbJci_8KuaBugxgxEg4"</span>);</span><br><span class="line">    param.put(<span class="string">"filter"</span>, filter);</span><br><span class="line">    param.put(<span class="string">"mpnews"</span>, mpnews);</span><br><span class="line">    param.put(<span class="string">"msgtype"</span>,<span class="string">"mpnews"</span>);</span><br><span class="line">    param.put(<span class="string">"send_ignore_reprint"</span>, <span class="number">0</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/mass/sendall?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="标签用户群发"><a href="#标签用户群发" class="headerlink" title="标签用户群发"></a>标签用户群发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    bulkNewsTag();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 群发图文推文信息(标签)</span></span><br><span class="line"><span class="comment"> * 测试号不允许发送没有权限</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bulkNewsTag</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    JSONObject filter = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    filter.put(<span class="string">"is_to_all"</span>,<span class="keyword">false</span>);</span><br><span class="line">    filter.put(<span class="string">"tag_id"</span>, <span class="number">2</span>);</span><br><span class="line">    JSONObject mpnews = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    mpnews.put(<span class="string">"media_id"</span>,<span class="string">"0yXThHza9feOGzsZjoEvcsJXWbJci_8KuaBugxgxEg4"</span>);</span><br><span class="line">    param.put(<span class="string">"filter"</span>, filter);</span><br><span class="line">    param.put(<span class="string">"mpnews"</span>, mpnews);</span><br><span class="line">    param.put(<span class="string">"msgtype"</span>,<span class="string">"mpnews"</span>);</span><br><span class="line">    param.put(<span class="string">"send_ignore_reprint"</span>, <span class="number">0</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/mass/sendall?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="openID群发"><a href="#openID群发" class="headerlink" title="openID群发"></a>openID群发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    bulkNewsOpenid();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 群发图文推文信息(openid)</span></span><br><span class="line"><span class="comment"> * 测试号不允许发送没有权限</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bulkNewsOpenid</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    JSONObject mpnews = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    mpnews.put(<span class="string">"media_id"</span>,<span class="string">"0yXThHza9feOGzsZjoEvcsJXWbJci_8KuaBugxgxEg4"</span>);</span><br><span class="line">    param.put(<span class="string">"touser"</span>, Arrays.asList(<span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>, <span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>, <span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>));</span><br><span class="line">    param.put(<span class="string">"mpnews"</span>, mpnews);</span><br><span class="line">    param.put(<span class="string">"msgtype"</span>,<span class="string">"mpnews"</span>);https:</span><br><span class="line">    param.put(<span class="string">"send_ignore_reprint"</span>, <span class="number">0</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/mass/send?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除群发"><a href="#删除群发" class="headerlink" title="删除群发"></a>删除群发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    delBulk();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除群发</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">delBulk</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"msg_id"</span>, <span class="number">30214</span>);</span><br><span class="line">    param.put(<span class="string">"article_idx"</span>, <span class="number">2</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/mass/delete?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>只有已经发送成功的消息才能删除</li><li>删除消息是将消息的图文详情页失效，已经收到的用户，还是能在其本地看到消息卡片。</li><li>删除群发消息只能删除图文消息和视频消息，其他类型的消息一经发送，无法删除。</li><li>如果多次群发发送的是一个图文消息，那么删除其中一次群发，就会删除掉这个图文消息也，导致所有群发都失效</li></ol><h2 id="预览接口"><a href="#预览接口" class="headerlink" title="预览接口"></a>预览接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = ApplicationMediaUploadAndDown.getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    preview();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据预览</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">preview</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"touser"</span>, <span class="string">"o6xeE0iTc9vfeOpnUxAgDPG7WPIQ"</span>);</span><br><span class="line">    param.put(<span class="string">"msgtype"</span>, <span class="string">"mpnews"</span>);</span><br><span class="line">    JSONObject mpnews = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    mpnews.put(<span class="string">"media_id"</span>,<span class="string">"0yXThHza9feOGzsZjoEvcsJXWbJci_8KuaBugxgxEg4"</span>);</span><br><span class="line">    param.put(<span class="string">"mpnews"</span>, mpnews);</span><br><span class="line">    param.put(<span class="string">"msg_id"</span>, <span class="number">30214</span>);</span><br><span class="line">    param.put(<span class="string">"article_idx"</span>, <span class="number">2</span>);</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/message/mass/preview?access_token="</span> + ApplicationMediaUploadAndDown.accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    System.out.println(content);</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200628204244866.png" alt="image-20200628204244866"></p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 微信 </category>
          
          <category> 公众号 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 微信 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微信开发-公众号-常用API-01-素材管理系列</title>
      <link href="/2020/06/17/43990/hub/"/>
      <url>/2020/06/17/43990/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200619082758339.png" alt="image-20200619082758339"></p><p>&emsp;&emsp;一些appid使用的是测试账号，可以去<a href="https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&amp;t=sandbox/index申请进行测试。最后会给出所有的依赖，所有代码基于gradle进行构建。" target="_blank" rel="noopener">https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&amp;t=sandbox/index申请进行测试。最后会给出所有的依赖，所有代码基于gradle进行构建。</a></p><p>&emsp;&emsp;官方文档：<a href="https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html" target="_blank" rel="noopener">https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html</a></p><p>&emsp;&emsp;针对中文编码、URL转义等问题可自行处理，此demo仅保证接口的可用性。</p><h2 id="获取AccessToken"><a href="#获取AccessToken" class="headerlink" title="获取AccessToken"></a>获取AccessToken</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAccessToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="string">"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid="</span>);</span><br><span class="line">    sb.append(appid).append(<span class="string">"&amp;secret="</span> + secret);</span><br><span class="line">    <span class="keyword">return</span> HttpUtil.get(sb.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String appid = <span class="string">"wx5a1772c5bbd052d6"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String secret = <span class="string">"fb55b339ed6490d2202ad81092efdb1f"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="上传永久素材（图片类）"><a href="#上传永久素材（图片类）" class="headerlink" title="上传永久素材（图片类）"></a>上传永久素材（图片类）</h2><p>&emsp;&emsp;多种形式的上传仅在图片类型中进行演示，其余类型仅保证接口调用成功，可以自行拓展。</p><h3 id="工具包"><a href="#工具包" class="headerlink" title="工具包"></a>工具包</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUtil</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String BOUNDARY_STR = <span class="string">"------------7da2e536604c8"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MultipartEntityBuilder <span class="title">getMultipartEntity</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        MultipartEntityBuilder meb = MultipartEntityBuilder.create();</span><br><span class="line">        meb.setBoundary(BOUNDARY_STR).setCharset(Charset.forName(<span class="string">"utf-8"</span>)).setMode(HttpMultipartMode.BROWSER_COMPATIBLE);</span><br><span class="line">        meb.addBinaryBody(<span class="string">"media"</span>, file, ContentType.APPLICATION_OCTET_STREAM, file.getName());</span><br><span class="line">        <span class="keyword">return</span> meb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MultipartEntityBuilder <span class="title">getMultipartEntity</span><span class="params">(<span class="keyword">byte</span>[] data,String fileName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        MultipartEntityBuilder meb = MultipartEntityBuilder.create();</span><br><span class="line">        meb.setBoundary(BOUNDARY_STR).setCharset(Charset.forName(<span class="string">"utf-8"</span>)).setMode(HttpMultipartMode.BROWSER_COMPATIBLE);</span><br><span class="line">        meb.addBinaryBody(<span class="string">"media"</span>, data, ContentType.APPLICATION_OCTET_STREAM, fileName);</span><br><span class="line">        <span class="keyword">return</span> meb;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="最终执行上传逻辑"><a href="#最终执行上传逻辑" class="headerlink" title="最终执行上传逻辑"></a>最终执行上传逻辑</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> String <span class="title">uploadFile</span><span class="params">(String requestUrl, String type, MultipartEntityBuilder meb)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    HttpPost post = <span class="keyword">new</span> HttpPost(requestUrl);</span><br><span class="line">    CloseableHttpClient httpclient = HttpClients.createDefault();</span><br><span class="line">    post.addHeader(<span class="string">"Connection"</span>, <span class="string">"keep-alive"</span>);</span><br><span class="line">    post.addHeader(<span class="string">"Accept"</span>, <span class="string">"*/*"</span>);</span><br><span class="line">    post.addHeader(<span class="string">"Content-Type"</span>, <span class="string">"multipart/form-data;boundary="</span> + BOUNDARY_STR);</span><br><span class="line">    post.addHeader(<span class="string">"User-Agent"</span>, <span class="string">"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0) "</span>);</span><br><span class="line">    meb.addTextBody(<span class="string">"type"</span>, type);</span><br><span class="line">    post.setEntity(meb.build());</span><br><span class="line">    HttpResponse response = httpclient.execute(post);</span><br><span class="line">    HttpEntity entity = response.getEntity();</span><br><span class="line">    String result = EntityUtils.toString(entity, <span class="string">"utf-8"</span>);</span><br><span class="line">    EntityUtils.consume(entity);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="File形式"><a href="#File形式" class="headerlink" title="File形式"></a>File形式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">uploadFile</span><span class="params">(File file, String type)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> uploadFile(<span class="string">"http://api.weixin.qq.com/cgi-bin/material/add_material?access_token="</span> + accessToken, type, FileUtil.getMultipartEntity(file));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testUploadFile</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"D:\\123456.png"</span>);</span><br><span class="line">    String response = uploadFile(file, <span class="string">"image"</span>);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String accessToken = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    Application.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    testUploadFile();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="字节数组形式"><a href="#字节数组形式" class="headerlink" title="字节数组形式"></a>字节数组形式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testUploadFileByte</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"D:\\123456.png"</span>);</span><br><span class="line">    FileInputStream fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">    <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>) file.length()];</span><br><span class="line">    fis.read(data);</span><br><span class="line">    fis.close();</span><br><span class="line">    String response = uploadFile(data, <span class="string">"image"</span>,<span class="string">"123456.png"</span>);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">uploadFile</span><span class="params">(<span class="keyword">byte</span>[] data, String type, String fileName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> uploadFile(<span class="string">"http://api.weixin.qq.com/cgi-bin/material/add_material?access_token="</span> + accessToken, type, FileUtil.getMultipartEntity(data,fileName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    Application.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    testUploadFileByte();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="InputStream流形式"><a href="#InputStream流形式" class="headerlink" title="InputStream流形式"></a>InputStream流形式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testUploadFileStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    InputStream fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">"D:\\123456.png"</span>));</span><br><span class="line">    <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[fis.available()];</span><br><span class="line">    fis.read(data);</span><br><span class="line">    fis.close();</span><br><span class="line">    String response = uploadFile(data, <span class="string">"image"</span>,<span class="string">"123456.png"</span>);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    Application.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    testUploadFileStream();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;MultipartEntityBuilder使用InputStream构建请求接口没有响应数据，所以将流转成字节数组上传。</p><h3 id="外网URL地址形式"><a href="#外网URL地址形式" class="headerlink" title="外网URL地址形式"></a>外网URL地址形式</h3><p>&emsp;&emsp;也是通过字节数组的形式进行上传。</p><h4 id="工具包-1"><a href="#工具包-1" class="headerlink" title="工具包"></a>工具包</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getImageStreamByte(String urlAddr) &#123;</span><br><span class="line">    InputStream in = <span class="keyword">null</span>;</span><br><span class="line">    ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(urlAddr);</span><br><span class="line">        URLConnection connection = url.openConnection();</span><br><span class="line">        in = connection.getInputStream();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> ((len = in.read(data)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            out.write(data, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MalformedURLException me) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                out.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    Application.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    testUploadFileUrl();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 使用URL进行文件上传转化为字节数组</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testUploadFileUrl</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] data = FileUtil.getImageStreamByte(<span class="string">"https://upload-images.jianshu.io/upload_images/10118469-2f291937eb7ed362.png?imageMogr2/auto-orient/strip|imageView2/1/w/300/h/240"</span>);</span><br><span class="line">    String response = uploadFile(data, <span class="string">"image"</span>,<span class="string">"123456.png"</span>);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="上传永久素材（音频类）"><a href="#上传永久素材（音频类）" class="headerlink" title="上传永久素材（音频类）"></a>上传永久素材（音频类）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//仅演示File类型，其余形式参考图片类进行上传</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    Application.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    testUploadVoice();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 上传voice</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testUploadVoice</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"D:\\123456.mp3"</span>);</span><br><span class="line">    String response = uploadFile(file, <span class="string">"voice"</span>);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="上传永久素材（Thumb）"><a href="#上传永久素材（Thumb）" class="headerlink" title="上传永久素材（Thumb）"></a>上传永久素材（Thumb）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    Application.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    testUploadThumb();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Thumb 图片上传</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testUploadThumb</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"D:\\1.png"</span>);</span><br><span class="line">    String response = uploadFile(file, <span class="string">"thumb"</span>);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="上传永久素材（视频类）"><a href="#上传永久素材（视频类）" class="headerlink" title="上传永久素材（视频类）"></a>上传永久素材（视频类）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    Application.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    testUploadVideo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Thumb 图片上传</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testUploadVideo</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"D:\\123.mp4"</span>);</span><br><span class="line">    String response = uploadFileVideo(file, <span class="string">"video"</span>);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传视频</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">uploadFileVideo</span><span class="params">(File file, String type)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> uploadFileVideo(<span class="string">"http://api.weixin.qq.com/cgi-bin/material/add_material?access_token="</span> + accessToken, type, FileUtil.getMultipartEntity(file));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;对上传方法需要扩展，增加<strong>description</strong>字段。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件执行上传操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> requestUrl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> meb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> String <span class="title">uploadFileVideo</span><span class="params">(String requestUrl, String type, MultipartEntityBuilder meb)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    HttpPost post = <span class="keyword">new</span> HttpPost(requestUrl);</span><br><span class="line">    CloseableHttpClient httpclient = HttpClients.createDefault();</span><br><span class="line">    post.addHeader(<span class="string">"Connection"</span>, <span class="string">"keep-alive"</span>);</span><br><span class="line">    post.addHeader(<span class="string">"Accept"</span>, <span class="string">"*/*"</span>);</span><br><span class="line">    post.addHeader(<span class="string">"Content-Type"</span>, <span class="string">"multipart/form-data;boundary="</span> + BOUNDARY_STR);</span><br><span class="line">    post.addHeader(<span class="string">"User-Agent"</span>, <span class="string">"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0) "</span>);</span><br><span class="line">    meb.addTextBody(<span class="string">"type"</span>, type);</span><br><span class="line">    <span class="comment">//新增字段 中文需注意编码问题有关编码问题可以自行测试</span></span><br><span class="line">    meb.addTextBody(<span class="string">"description"</span>, <span class="string">"&#123;\"title\":\"标题\",\"introduction\":\\\"是的\"&#125;"</span>);</span><br><span class="line">    post.setEntity(meb.build());</span><br><span class="line">    HttpResponse response = httpclient.execute(post);</span><br><span class="line">    HttpEntity entity = response.getEntity();</span><br><span class="line">    String result = EntityUtils.toString(entity, <span class="string">"utf-8"</span>);</span><br><span class="line">    EntityUtils.consume(entity);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="上传永久素材（图文类）"><a href="#上传永久素材（图文类）" class="headerlink" title="上传永久素材（图文类）"></a>上传永久素材（图文类）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    sendMediaTest();<span class="comment">//0yXThHza9feOGzsZjoEvcsJXWbJci_8KuaBugxgxEg4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试发送图文信息（推文）</span></span><br><span class="line"><span class="comment"> * List&lt;Map&gt; 多个发送的是宫格图文信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendMediaTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Map&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    WxPublicSendMediaVo vo = <span class="keyword">new</span> WxPublicSendMediaVo();</span><br><span class="line">    vo.setAuthor(<span class="string">"sanmengcc"</span>);</span><br><span class="line">    vo.setContent(<span class="string">"pppppppppppppppppppppppppppppp-&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span>);</span><br><span class="line">    vo.setDigest(<span class="string">"digest--------------------------------&gt;"</span>);</span><br><span class="line">    vo.setNeed_open_comment(<span class="number">1</span>);</span><br><span class="line">    vo.setOnly_fans_can_comment(<span class="number">1</span>);</span><br><span class="line">    vo.setTitle(<span class="string">"title-----------------------------------&gt;"</span>);</span><br><span class="line">    vo.setShow_cover_pic(<span class="number">1</span>);</span><br><span class="line">    vo.setThumb_media_id(<span class="string">"0yXThHza9feOGzsZjoEvch2bpoSmI02LmN0NCNRI92M"</span>);</span><br><span class="line">    list.add(JSONObject.parseObject(JSONObject.toJSONString(vo), Map<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">    sendMedia(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送图文信息（推文）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> list</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">sendMedia</span><span class="params">(List&lt;Map&gt; list)</span> </span>&#123;</span><br><span class="line">    String sendRequestParam = <span class="string">"&#123;\"articles\":"</span> + JSONObject.toJSONString(list) + <span class="string">"&#125;"</span>;</span><br><span class="line">    String postResult = HttpUtil.post(<span class="string">"https://api.weixin.qq.com/cgi-bin/material/add_news?access_token="</span> + accessToken, sendRequestParam);</span><br><span class="line">    System.out.println(<span class="string">"postResult = "</span> + postResult);</span><br><span class="line">    <span class="keyword">return</span> postResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="上传永久素材（图文中的图片）"><a href="#上传永久素材（图文中的图片）" class="headerlink" title="上传永久素材（图文中的图片）"></a>上传永久素材（图文中的图片）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主要用于富文本</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    Application.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    uploadFileNewsPic();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 测试上传图文素材中的图片（不限制数量）</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">uploadFileNewsPic</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"D:\\123456.png"</span>);</span><br><span class="line">    String response = uploadFileNewsPic(file, <span class="string">"image"</span>);</span><br><span class="line">    System.out.println(response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传图文素材中的图片（不限制数量）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">uploadFileNewsPic</span><span class="params">(File file, String type)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> uploadFile(<span class="string">"http://api.weixin.qq.com/cgi-bin/media/uploadimg?access_token="</span> + accessToken, type, FileUtil.getMultipartEntity(file));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;该接口主要用于图文素材富文本中的图片，不会加入永久素材的数量限制中。</p><p>&emsp;&emsp;针对资源文件的获取，主要获取视频与音频，因为图片会直接返回URL，自行存储即可。视频会返回URL，但是音频不会而是返回的File文件。</p><h2 id="获取视频素材信息"><a href="#获取视频素材信息" class="headerlink" title="获取视频素材信息"></a>获取视频素材信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取资源URL或者数据</span></span><br><span class="line"><span class="comment"> * 返回URL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMediaVideo</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/material/get_material?access_token="</span> + accessToken;</span><br><span class="line">    String mediaId = <span class="string">"tdFSwgVLM0DRhV7A930HrX8i2-HjQ5Ni8PoW8_6Itkw"</span>;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"media_id"</span>, mediaId);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, param.toJSONString());</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(<span class="keyword">new</span> String(result.getBytes(), <span class="string">"UTF-8"</span>));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    Application.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getMediaVideo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取音频素材信息"><a href="#获取音频素材信息" class="headerlink" title="获取音频素材信息"></a>获取音频素材信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    Application.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getMediaVoice(<span class="string">"0yXThHza9feOGzsZjoEvco467AHbbqFZHpEXxGmH"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType JSON = MediaType.parse(<span class="string">"application/json; charset=utf-8"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取资源文件（永久素材 仅限音频类）视频与图片微信提供了URL，针对音频只能自己转存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mediaId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMediaVoice</span><span class="params">(String mediaId)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/material/get_material?access_token="</span> + accessToken;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"media_id"</span>, mediaId);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, param.toJSONString());</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    InputStream is = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        is = response.body().byteStream();</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"D:\\voice.mp3"</span>);</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">        <span class="keyword">while</span> ((len = is.read(buf)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            fos.write(buf, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        fos.flush();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>)</span><br><span class="line">                is.close();</span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="keyword">null</span>)</span><br><span class="line">                fos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"result"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取图文素材信息"><a href="#获取图文素材信息" class="headerlink" title="获取图文素材信息"></a>获取图文素材信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getMediaNews();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * getMediaNews 和获取图片的代码是一样的</span></span><br><span class="line"><span class="comment"> * 不过图文返回了具体的文本信息视频是URL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMediaNews</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/material/get_material?access_token="</span> + accessToken;</span><br><span class="line">    String mediaId = <span class="string">"0yXThHza9feOGzsZjoEvcsJXWbJci_8KuaBugxgxEg4"</span>;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"media_id"</span>, mediaId);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, param.toJSONString());</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(<span class="keyword">new</span> String(result.getBytes(), <span class="string">"UTF-8"</span>));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取素材分类总数"><a href="#获取素材分类总数" class="headerlink" title="获取素材分类总数"></a>获取素材分类总数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    getMediaAllCount();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取公众号的素材分类总数</span></span><br><span class="line"><span class="comment"> * demo:&#123;"voice_count":8,"video_count":0,"image_count":9,"news_count":2&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMediaAllCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/material/get_materialcount?access_token="</span> + accessToken;</span><br><span class="line">    String result = HttpUtil.get(url);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取列表素材信息"><a href="#获取列表素材信息" class="headerlink" title="获取列表素材信息"></a>获取列表素材信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    testUploadVideo();</span><br><span class="line">    getMediaListByType(<span class="string">"news"</span>);</span><br><span class="line">    getMediaListByType(<span class="string">"image"</span>);</span><br><span class="line">    getMediaListByType(<span class="string">"video"</span>);</span><br><span class="line">    getMediaListByType(<span class="string">"voice"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据类型获取素材类型</span></span><br><span class="line"><span class="comment"> * 图文：返回文章信息</span></span><br><span class="line"><span class="comment"> * 图片：返回URL</span></span><br><span class="line"><span class="comment"> * 视频：返回media_id</span></span><br><span class="line"><span class="comment"> * 音频：返回media_id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMediaListByType</span><span class="params">(String type)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/material/batchget_material?access_token="</span> + accessToken;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"type"</span>, type);</span><br><span class="line">    param.put(<span class="string">"offset"</span>, <span class="number">0</span>);</span><br><span class="line">    param.put(<span class="string">"count"</span>, <span class="number">10</span>);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, param.toJSONString());</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="响应数据demo"><a href="#响应数据demo" class="headerlink" title="响应数据demo"></a>响应数据demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"item"</span>:[&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcjP9RZg32qdrz2e5XjnG22A"</span>,<span class="string">"content"</span>:&#123;<span class="string">"news_item"</span>:[&#123;<span class="string">"title"</span>:<span class="string">"title-----------------------------------&gt;"</span>,<span class="string">"author"</span>:<span class="string">"sanmengcc"</span>,<span class="string">"digest"</span>:<span class="string">"digest--------------------------------&gt;"</span>,<span class="string">"content"</span>:<span class="string">"pppppppppppppppppppppppppppppp-&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;"</span>,<span class="string">"content_source_url"</span>:<span class="string">""</span>,<span class="string">"thumb_media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvch2bpoSmI02LmN0NCNRI92M"</span>,<span class="string">"show_cover_pic"</span>:<span class="number">1</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mp.weixin.qq.com\/s?__biz=MzUzMTg3MjIzNQ==&amp;mid=100000019&amp;idx=1&amp;sn=8ba33d66e58f60cb334c9113aab0f9a4&amp;chksm=7abaa1974dcd28819835b1e040a1a766cef02b9d32f0416bd5b4e7806760c161ae33256d7a5d#rd"</span>,<span class="string">"thumb_url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_jpg\/oINLPCrx4CHzDUyQb5aOGA21TSOM3t2UfjsPYnOT3RBkEN45lhricsS070BrtgJmlme3bNncfJLCRoGdeFtSM2Q\/0?wx_fmt=jpeg"</span>,<span class="string">"need_open_comment"</span>:<span class="number">1</span>,<span class="string">"only_fans_can_comment"</span>:<span class="number">1</span>&#125;],<span class="string">"create_time"</span>:<span class="number">1592494965</span>,<span class="string">"update_time"</span>:<span class="number">1592494965</span>&#125;,<span class="string">"update_time"</span>:<span class="number">1592494965</span>&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcsJXWbJci_8KuaBugxgxEg4"</span>,<span class="string">"content"</span>:&#123;<span class="string">"news_item"</span>:[&#123;<span class="string">"title"</span>:<span class="string">"title-----------------------------------&gt;"</span>,<span class="string">"author"</span>:<span class="string">"sanmengcc"</span>,<span class="string">"digest"</span>:<span class="string">"digest--------------------------------&gt;"</span>,<span class="string">"content"</span>:<span class="string">"pppppppppppppppppppppppppppppp-&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;"</span>,<span class="string">"content_source_url"</span>:<span class="string">""</span>,<span class="string">"thumb_media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvch2bpoSmI02LmN0NCNRI92M"</span>,<span class="string">"show_cover_pic"</span>:<span class="number">1</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mp.weixin.qq.com\/s?__biz=MzUzMTg3MjIzNQ==&amp;mid=100000018&amp;idx=1&amp;sn=e4e8778d58282d24aada5f9cff38c664&amp;chksm=7abaa1964dcd28801b3d557fbb889830af125bb64c069403c630884b88fc5d45396c0af362cf#rd"</span>,<span class="string">"thumb_url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_jpg\/oINLPCrx4CHzDUyQb5aOGA21TSOM3t2UfjsPYnOT3RBkEN45lhricsS070BrtgJmlme3bNncfJLCRoGdeFtSM2Q\/0?wx_fmt=jpeg"</span>,<span class="string">"need_open_comment"</span>:<span class="number">1</span>,<span class="string">"only_fans_can_comment"</span>:<span class="number">1</span>&#125;],<span class="string">"create_time"</span>:<span class="number">1592494844</span>,<span class="string">"update_time"</span>:<span class="number">1592494844</span>&#125;,<span class="string">"update_time"</span>:<span class="number">1592494844</span>&#125;],<span class="string">"total_count"</span>:<span class="number">2</span>,<span class="string">"item_count"</span>:<span class="number">2</span>&#125;</span><br><span class="line">&#123;<span class="string">"item"</span>:[&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvch2bpoSmI02LmN0NCNRI92M"</span>,<span class="string">"name"</span>:<span class="string">"1.png"</span>,<span class="string">"update_time"</span>:<span class="number">1592494819</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_jpg\/oINLPCrx4CHzDUyQb5aOGA21TSOM3t2UfjsPYnOT3RBkEN45lhricsS070BrtgJmlme3bNncfJLCRoGdeFtSM2Q\/0?wx_fmt=jpeg"</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcmpNIcBG-wNe9T_LpT42Sa4"</span>,<span class="string">"name"</span>:<span class="string">"1.png"</span>,<span class="string">"update_time"</span>:<span class="number">1592488482</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_jpg\/oINLPCrx4CHzDUyQb5aOGA21TSOM3t2UfjsPYnOT3RBkEN45lhricsS070BrtgJmlme3bNncfJLCRoGdeFtSM2Q\/0?wx_fmt=jpeg"</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcuhuxQGNHuvdhowC4ffwqWE"</span>,<span class="string">"name"</span>:<span class="string">"1.png"</span>,<span class="string">"update_time"</span>:<span class="number">1592404142</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_jpg\/oINLPCrx4CFEDLialtzhhzED1l9LYc1eAr3xmUozBOHYybZ5b22QK5ULoqQEDdwzd51m8ZtQBpwHrIyNdEcEjjQ\/0?wx_fmt=jpeg"</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcsBmxTe5Up6g-1Qpyn6h3pM"</span>,<span class="string">"name"</span>:<span class="string">"123456.png"</span>,<span class="string">"update_time"</span>:<span class="number">1592402770</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_png\/oINLPCrx4CFEDLialtzhhzED1l9LYc1eA1UjJ4xs5TJIhkpCs8cL59iaoGj0cqzZicEHoPibIkKVBwNZNWDjaNVWVg\/0?wx_fmt=png"</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcjW8a2Qbk56YaPYgWoG_BEU"</span>,<span class="string">"name"</span>:<span class="string">"123456.png"</span>,<span class="string">"update_time"</span>:<span class="number">1592402345</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_png\/oINLPCrx4CFEDLialtzhhzED1l9LYc1eANTKbKGqOz9SwubYEIRgkg1dUfjc4BrH61GdianIeLpsLY2pN5jd6y8A\/0?wx_fmt=png"</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcoUEwOPj3rlEy7LC9H6qNrI"</span>,<span class="string">"name"</span>:<span class="string">"123456.png"</span>,<span class="string">"update_time"</span>:<span class="number">1592401555</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_png\/oINLPCrx4CFEDLialtzhhzED1l9LYc1eANTKbKGqOz9SwubYEIRgkg1dUfjc4BrH61GdianIeLpsLY2pN5jd6y8A\/0?wx_fmt=png"</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcmJert-F-CIsvCh-YkZgZ3s"</span>,<span class="string">"name"</span>:<span class="string">"123.png"</span>,<span class="string">"update_time"</span>:<span class="number">1592401286</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_png\/oINLPCrx4CFEDLialtzhhzED1l9LYc1eANTKbKGqOz9SwubYEIRgkg1dUfjc4BrH61GdianIeLpsLY2pN5jd6y8A\/0?wx_fmt=png"</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcpjVB5BgVoS6JZSD8RMuaEg"</span>,<span class="string">"name"</span>:<span class="string">"123456.png"</span>,<span class="string">"update_time"</span>:<span class="number">1592400717</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_png\/oINLPCrx4CFEDLialtzhhzED1l9LYc1eANTKbKGqOz9SwubYEIRgkg1dUfjc4BrH61GdianIeLpsLY2pN5jd6y8A\/0?wx_fmt=png"</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcgNKTK2OaBrpDbdBjKNoYgc"</span>,<span class="string">"name"</span>:<span class="string">"123456.png"</span>,<span class="string">"update_time"</span>:<span class="number">1592400702</span>,<span class="string">"url"</span>:<span class="string">"http:\/\/mmbiz.qpic.cn\/mmbiz_png\/oINLPCrx4CFEDLialtzhhzED1l9LYc1eANTKbKGqOz9SwubYEIRgkg1dUfjc4BrH61GdianIeLpsLY2pN5jd6y8A\/0?wx_fmt=png"</span>,<span class="string">"tags"</span>:[]&#125;],<span class="string">"total_count"</span>:<span class="number">9</span>,<span class="string">"item_count"</span>:<span class="number">9</span>&#125;</span><br><span class="line">&#123;<span class="string">"item"</span>:[&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcvVEO-_RLzJmoMnx4HY-nVo"</span>,<span class="string">"name"</span>:<span class="string">"??"</span>,<span class="string">"update_time"</span>:<span class="number">1592495527</span>,<span class="string">"description"</span>:<span class="string">""</span>,<span class="string">"tags"</span>:[]&#125;],<span class="string">"total_count"</span>:<span class="number">1</span>,<span class="string">"item_count"</span>:<span class="number">1</span>&#125;</span><br><span class="line">&#123;<span class="string">"item"</span>:[&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcgnNZ3iFyyQtKsLg4EUkxrc"</span>,<span class="string">"name"</span>:<span class="string">"123456.mp3"</span>,<span class="string">"update_time"</span>:<span class="number">1592493587</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvco467AHbbqFZHpEXxGmH-x0"</span>,<span class="string">"name"</span>:<span class="string">"123456.mp3"</span>,<span class="string">"update_time"</span>:<span class="number">1592493565</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvciNBk-HVlx7hOZwlCqwoxks"</span>,<span class="string">"name"</span>:<span class="string">"123456.mp3"</span>,<span class="string">"update_time"</span>:<span class="number">1592491600</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcpkv9YyYjyRfZ56e2N9LGu0"</span>,<span class="string">"name"</span>:<span class="string">"123456.mp3"</span>,<span class="string">"update_time"</span>:<span class="number">1592491190</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvciJ_BpMcL_uxZl-YniqW8Eg"</span>,<span class="string">"name"</span>:<span class="string">"123456.mp3"</span>,<span class="string">"update_time"</span>:<span class="number">1592490353</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvckBUnX4CI_UYlw3Bo7jnLBo"</span>,<span class="string">"name"</span>:<span class="string">"123456.mp3"</span>,<span class="string">"update_time"</span>:<span class="number">1592489300</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvcszBVVNM2Mk2vWVuuOzBq6E"</span>,<span class="string">"name"</span>:<span class="string">"123456.mp3"</span>,<span class="string">"update_time"</span>:<span class="number">1592489270</span>,<span class="string">"tags"</span>:[]&#125;,&#123;<span class="string">"media_id"</span>:<span class="string">"0yXThHza9feOGzsZjoEvckBUBt0Cdr-_WZ5aqSCsohs"</span>,<span class="string">"name"</span>:<span class="string">"123456.mp3"</span>,<span class="string">"update_time"</span>:<span class="number">1592403564</span>,<span class="string">"tags"</span>:[]&#125;],<span class="string">"total_count"</span>:<span class="number">8</span>,<span class="string">"item_count"</span>:<span class="number">8</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="更改图文素材信息"><a href="#更改图文素材信息" class="headerlink" title="更改图文素材信息"></a>更改图文素材信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试发送图文信息（推文）</span></span><br><span class="line"><span class="comment"> * 多个发送的是宫格图文信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateMediaNews</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    jsonObject.put(<span class="string">"media_id"</span>, <span class="string">"0yXThHza9feOGzsZjoEvcsJXWbJci_8KuaBugxgxEg4"</span>);</span><br><span class="line">    <span class="comment">// 对于宫格消息这个很重要 : index是要更新的文章在图文消息中的位置（多图文消息时，此字段才有意义），第一篇为0</span></span><br><span class="line">    jsonObject.put(<span class="string">"index"</span>, <span class="number">0</span>);</span><br><span class="line">    WxPublicSendMediaVo vo = <span class="keyword">new</span> WxPublicSendMediaVo();</span><br><span class="line">    vo.setAuthor(<span class="string">"setAuthor——update"</span>);</span><br><span class="line">    vo.setContent(<span class="string">"setContent-&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;update"</span>);</span><br><span class="line">    vo.setDigest(<span class="string">"setDigest--------------------------------&gt;update"</span>);</span><br><span class="line">    vo.setNeed_open_comment(<span class="number">1</span>);</span><br><span class="line">    vo.setOnly_fans_can_comment(<span class="number">1</span>);</span><br><span class="line">    vo.setTitle(<span class="string">"setTitle-----------------------------------&gt;update"</span>);</span><br><span class="line">    vo.setShow_cover_pic(<span class="number">1</span>);</span><br><span class="line">    vo.setThumb_media_id(<span class="string">"0yXThHza9feOGzsZjoEvch2bpoSmI02LmN0NCNRI92M"</span>);</span><br><span class="line">    jsonObject.put(<span class="string">"articles"</span>, vo);</span><br><span class="line">    System.out.println(JSONObject.toJSONString(jsonObject));</span><br><span class="line">    updateMedia(jsonObject);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更改图文信息（推文）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> jsonObject</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">updateMedia</span><span class="params">(JSONObject jsonObject)</span> </span>&#123;</span><br><span class="line">    String postResult = HttpUtil.post(<span class="string">"https://api.weixin.qq.com/cgi-bin/material/update_news?access_token="</span> + accessToken, jsonObject.toJSONString());</span><br><span class="line">    System.out.println(<span class="string">"postResult = "</span>+postResult);</span><br><span class="line">    <span class="keyword">return</span> postResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    updateMediaNews();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="删除永久素材"><a href="#删除永久素材" class="headerlink" title="删除永久素材"></a>删除永久素材</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    delMedia(<span class="string">"0yXThHza9feOGzsZjoEvcjP9RZg32qdrz2e5XjnG22A"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除永久素材</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mediaId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">delMedia</span><span class="params">(String mediaId)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/material/del_material?access_token="</span> + accessToken;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"media_id"</span>, mediaId);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, param.toJSONString());</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="上传临时素材（图片、音频、thumb、视频）"><a href="#上传临时素材（图片、音频、thumb、视频）" class="headerlink" title="上传临时素材（图片、音频、thumb、视频）"></a>上传临时素材（图片、音频、thumb、视频）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    testUploadFileTemp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 临时文件</span></span><br><span class="line"><span class="comment"> * 测试图片，音频，thumb上传</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testUploadFileTemp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    System.out.println(uploadFileTemp(<span class="keyword">new</span> File(<span class="string">"D:\\123456.png"</span>), <span class="string">"image"</span>));</span><br><span class="line">    System.out.println(uploadFileTemp(<span class="keyword">new</span> File(<span class="string">"D:\\646370.mp3"</span>), <span class="string">"voice"</span>));</span><br><span class="line">    System.out.println(uploadFileTemp(<span class="keyword">new</span> File(<span class="string">"D:\\123456.png"</span>), <span class="string">"thumb"</span>));</span><br><span class="line">    System.out.println(uploadFileTemp(<span class="keyword">new</span> File(<span class="string">"D:\\123.MP4"</span>), <span class="string">"video"</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 上传临时文件素材</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">uploadFileTemp</span><span class="params">(File file, String type)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> uploadFile(<span class="string">"https://api.weixin.qq.com/cgi-bin/media/upload?access_token="</span> + accessToken, type, FileUtil.getMultipartEntity(file));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200619074814168.png" alt="image-20200619074814168"></p><h2 id="获取临时素材"><a href="#获取临时素材" class="headerlink" title="获取临时素材"></a>获取临时素材</h2><p>&emsp;&emsp;需要注意的是，视频类才会返回URL,其余类型只能自己转存文件File。暂不涉及高清语音素材获取接口。</p><p><img src="/image/hexo/image-20200619075914652.png" alt="image-20200619075914652"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String accessToken = getAccessToken();</span><br><span class="line">    ApplicationMediaUploadAndDown.accessToken = accessToken;</span><br><span class="line">    System.out.println(accessToken);</span><br><span class="line">    testGetMediaTemp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testGetMediaTemp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//image</span></span><br><span class="line">    getMediaTempFile(<span class="string">"LrMcsaGN9grzzFPzEktW1F6ZpWAQeFf3dl5HRHKHyxzf6rnt76LKCkb85v9t6rRk"</span>,<span class="string">"png"</span>);</span><br><span class="line">    <span class="comment">//voice</span></span><br><span class="line">    getMediaTempFile(<span class="string">"mgjVrOvaIjc8-A8PkLZZIYlTA7nMOUmVOMVDhtFT5XpkThl0kxMhotHw3MqUi3MQ"</span>, <span class="string">"mp3"</span>);</span><br><span class="line">    <span class="comment">//thumb</span></span><br><span class="line">    getMediaTempFile(<span class="string">"3Gh2zJQdWV0jvO9r4JlzDY5veOBhraOJJDsxMczHXHQqKlr7ZqlLQ9jtOoK7hLz4"</span>,<span class="string">"png"</span>);</span><br><span class="line">    <span class="comment">//video</span></span><br><span class="line">    getVideoMediaTemp(<span class="string">"YNtDLtQPWw-pZWcyNYDG1m-HzEsSQJpj42UGtRHXus0epkv9CgK5gAqwzoVORY2N"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取图片,thumb,音频文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mediaId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> suffix</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMediaTempFile</span><span class="params">(String mediaId,String suffix)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/media/get?access_token="</span> + accessToken + <span class="string">"&amp;media_id="</span> + mediaId;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"media_id"</span>, mediaId);</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).get().build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    InputStream is = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        is = response.body().byteStream();</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"D:\\"</span> + System.currentTimeMillis() + <span class="string">"."</span> + suffix);</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">        <span class="keyword">while</span> ((len = is.read(buf)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            fos.write(buf, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        fos.flush();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>)</span><br><span class="line">                is.close();</span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="keyword">null</span>)</span><br><span class="line">                fos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"result"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取视频URL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> media_id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getVideoMediaTemp</span><span class="params">(String media_id)</span> </span>&#123;</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/media/get?access_token="</span> + accessToken;</span><br><span class="line">    Map param = <span class="keyword">new</span> HashMap();</span><br><span class="line">    param.put(<span class="string">"media_id"</span>, media_id);</span><br><span class="line">    String result = HttpUtil.get(url, param);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="留言评论管理"><a href="#留言评论管理" class="headerlink" title="留言评论管理"></a>留言评论管理</h2><h3 id="打开已群发文章评论"><a href="#打开已群发文章评论" class="headerlink" title="打开已群发文章评论"></a>打开已群发文章评论</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    commentOpen();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 打开已群发文章评论</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">commentOpen</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"msg_data_id"</span>, <span class="string">"1"</span>);</span><br><span class="line">    param.put(<span class="string">"index"</span>, <span class="string">"4"</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/comment/open?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="关闭已群发文章评论"><a href="#关闭已群发文章评论" class="headerlink" title="关闭已群发文章评论"></a>关闭已群发文章评论</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    commentClose();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 关闭已群发文章评论</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">commentClose</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"msg_data_id"</span>, <span class="string">"1"</span>);</span><br><span class="line">    param.put(<span class="string">"index"</span>, <span class="string">"4"</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/comment/close?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查看指定文章的评论数据"><a href="#查看指定文章的评论数据" class="headerlink" title="查看指定文章的评论数据"></a>查看指定文章的评论数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    commentAnalyze();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 查看指定文章的评论数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">commentAnalyze</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"msg_data_id"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"index"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"begin"</span>, <span class="number">0</span>);</span><br><span class="line">    param.put(<span class="string">"count"</span>, <span class="number">30</span>);</span><br><span class="line">    param.put(<span class="string">"type"</span>, <span class="number">1</span>);<span class="comment">//type=0 普通评论&amp;精选评论 type=1 普通评论 type=2 精选评论</span></span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/comment/list?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="标记评论精选"><a href="#标记评论精选" class="headerlink" title="标记评论精选"></a>标记评论精选</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    commentStar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 将评论标记精选</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">commentStar</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"msg_data_id"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"index"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"user_comment_id"</span>, <span class="number">0</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/comment/markelect?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="将评论取消精选"><a href="#将评论取消精选" class="headerlink" title="将评论取消精选"></a>将评论取消精选</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    commentUnStar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 将评论取消标记精选</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">commentUnStar</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"msg_data_id"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"index"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"user_comment_id"</span>, <span class="number">0</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/comment/unmarkelect?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除评论"><a href="#删除评论" class="headerlink" title="删除评论"></a><strong>删除评论</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    commentDelUser();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 删除评论</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">commentDelUser</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"msg_data_id"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"index"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"user_comment_id"</span>, <span class="number">0</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/comment/delete?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="回复评论"><a href="#回复评论" class="headerlink" title="回复评论"></a>回复评论</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    commentReply();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 回复评论</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">commentReply</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"msg_data_id"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"index"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"user_comment_id"</span>, <span class="number">0</span>);</span><br><span class="line">    param.put(<span class="string">"content"</span>, <span class="string">"回复"</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/comment/reply/add?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除回复"><a href="#删除回复" class="headerlink" title="删除回复"></a>删除回复</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    commentDelReply();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 删除回复</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>  sanmengcc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>   2020/6/30 22:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">commentDelReply</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JSONObject param = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    param.put(<span class="string">"msg_data_id"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"index"</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">"user_comment_id"</span>, <span class="number">0</span>);</span><br><span class="line">    String content = param.toJSONString();</span><br><span class="line">    String url = <span class="string">"https://api.weixin.qq.com/cgi-bin/comment/reply/delete?access_token="</span> + accessToken;</span><br><span class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">    RequestBody body = RequestBody.create(JSON, content);</span><br><span class="line">    Request request = (<span class="keyword">new</span> Request.Builder()).url(url).post(body).build();</span><br><span class="line">    Response response = client.newCall(request).execute();</span><br><span class="line">    String result = response.body().string();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="所用到的完整的gradle"><a href="#所用到的完整的gradle" class="headerlink" title="所用到的完整的gradle"></a>所用到的完整的gradle</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compile(<span class="string">"org.apache.httpcomponents:httpclient"</span>)</span><br><span class="line">    compile(<span class="string">'org.apache.httpcomponents:httpmime:4.5.4'</span>)</span><br><span class="line">    compile(<span class="string">'com.squareup.okhttp3:okhttp:3.7.0'</span>)</span><br><span class="line">    compile(<span class="string">'com.alibaba:fastjson:1.2.68'</span>)</span><br><span class="line">    compile <span class="string">'cn.hutool:hutool-all:5.3.1'</span></span><br><span class="line">    testCompile group: <span class="string">'junit'</span>, name: <span class="string">'junit'</span>, version: <span class="string">'4.12'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 微信 </category>
          
          <category> 公众号 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 微信 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-22-Worker-Thread模式</title>
      <link href="/2020/06/14/16670/hub/"/>
      <url>/2020/06/14/16670/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200614225427176.png" alt="image-20200614225427176"></p><p>&emsp;&emsp;Worker模式类似于Thread-Pre-Message，不过后者是为每一个请求开辟一个线程去处理逻辑，而Worker则是预先创建了一个线程池。可以说它是一个线程池也没错，同时它和生产消费者模式也很类似。</p><p><img src="/image/hexo/image-20200614225830025.png" alt="image-20200614225830025"></p><p>&emsp;&emsp;Worker模式当不断的往queue推入数据的时候，在channel被启动的时候就会创建若干个Worker线程，那么Worker和Channel并不是简单的依赖关系，而是聚合关系。</p><p><img src="/image/hexo/image-20200614230104603.png" alt="image-20200614230104603"></p><p>&emsp;&emsp;Producer-Consumer模式生产者和消费者对queue都是依赖关系，queue不用关心producer和consumer。而生产者和消费者只需要不断的推入数据和消费数据。queue的消费并不依赖本身的方法。</p><h2 id="流水线示例"><a href="#流水线示例" class="headerlink" title="流水线示例"></a>流水线示例</h2><h3 id="产品"><a href="#产品" class="headerlink" title="产品"></a>产品</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//产品说明书模板</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">InstructionBook</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">firstProcess</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">secondProcess</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.firstProcess(); </span><br><span class="line">        <span class="keyword">this</span>.secondProcess();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生产产品</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Production</span> <span class="keyword">extends</span> <span class="title">InstructionBook</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> prodId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Production</span><span class="params">(<span class="keyword">int</span> prodId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.prodId = prodId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">firstProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"execute the:"</span> + prodId + <span class="string">" firstProcess."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">secondProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"execute the:"</span> + prodId + <span class="string">" secondProcess."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="工作人员"><a href="#工作人员" class="headerlink" title="工作人员"></a>工作人员</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProductionChannel channel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Worker</span><span class="params">(ProductionChannel channel,String workerName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(workerName);</span><br><span class="line">        <span class="keyword">this</span>.channel = channel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Production production = channel.take();</span><br><span class="line">        System.out.println(getName() + <span class="string">" process the "</span> + production);</span><br><span class="line">        production.create();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="流水线传送带"><a href="#流水线传送带" class="headerlink" title="流水线传送带"></a>流水线传送带</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductionChannel</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 传送带最多放置的产品数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_PROD = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 传送带</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Production[] productions;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tail;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> head;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> total;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工作人员</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Worker[] workers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProductionChannel</span><span class="params">(<span class="keyword">int</span> workerSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.workers = <span class="keyword">new</span> Worker[workerSize];</span><br><span class="line">        <span class="keyword">this</span>.productions = <span class="keyword">new</span> Production[MAX_PROD];</span><br><span class="line">        System.out.println(<span class="string">"ProductionChannel init"</span>);</span><br><span class="line"></span><br><span class="line">        IntStream.range(<span class="number">1</span>, workerSize)</span><br><span class="line">                .forEach(i -&gt; &#123;</span><br><span class="line">                    workers[i] = <span class="keyword">new</span> Worker(<span class="keyword">this</span>, <span class="string">"Worker-"</span> + i);</span><br><span class="line">                    workers[i].start();</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"ProductionChannel init successful."</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span><span class="params">(Production production)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (total &gt;= productions.length) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            productions[tail] = production;</span><br><span class="line">            tail = (tail + <span class="number">1</span>) % productions.length;</span><br><span class="line">            total++;</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Production <span class="title">take</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"take total:"</span> + total);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (total &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Production production = productions[head];</span><br><span class="line">            total--;</span><br><span class="line">            head = (head + <span class="number">1</span>) % productions.length;</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">            <span class="keyword">return</span> production;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ProductionChannel channel = <span class="keyword">new</span> ProductionChannel(<span class="number">20</span>);</span><br><span class="line">        AtomicInteger productionNo = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            channel.offer(<span class="keyword">new</span> Production(productionNo.getAndIncrement()));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">200</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-21-Two-Phase-Termination模式</title>
      <link href="/2020/06/14/33486/hub/"/>
      <url>/2020/06/14/33486/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="H:%5Chexo%5Csource%5Cimage%5Chexo%5Cimage-20200614212737208.png" alt="image-20200614212737208"></p><p>&emsp;&emsp;当一个线程正常结束或者被打断以及发生异常而导致其生命周期结束，某些场景下需要释放一些资源，比如文件句柄，sokect连接等。当线程正在运行的时候，我们发出终止线程的指令，此时线程依旧还是在运行并不会立刻终止，而可能去处理了一些释放资源的操作，这个终止处理又被成为线程结束的第二个阶段，而接受终止的要求成为线程结束的第一阶段。</p><p>&emsp;&emsp;1.第二阶段的终止保证安全性（安全性）。</p><p>&emsp;&emsp;2.百分百的确保线程结束（生命性）。</p><p>&emsp;&emsp;3.对资源的释放要控制在一个可控的范围内（响应性）。</p><h2 id="线程停止的示例"><a href="#线程停止的示例" class="headerlink" title="线程停止的示例"></a>线程停止的示例</h2><p>&emsp;&emsp;比较常用的就是在最终代码块进行资源释放等操作。或者二次封装Thread写进行一个释放资源的操作。在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TwoPhaseTerminationTest</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TwoPhaseTerminationTest thread = <span class="keyword">new</span> TwoPhaseTerminationTest();</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sendSocket();</span><br><span class="line">            write();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"release......."</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10_000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"release successful......."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSocket</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"send socket."</span>);</span><br><span class="line">        System.out.println(<span class="string">"close socket."</span>);</span><br><span class="line">        Thread.sleep(<span class="number">2_000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"writing."</span>);</span><br><span class="line">        System.out.println(<span class="string">"close write."</span>);</span><br><span class="line">        Thread.sleep(<span class="number">2_000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="进程关闭的示例"><a href="#进程关闭的示例" class="headerlink" title="进程关闭的示例"></a>进程关闭的示例</h2><p>&emsp;&emsp;如果是程序没有正常执行完毕，而是进程关闭导致的那么可以采用注入hook线程的方式来处理。但是强制关闭的进程hook程序也是无法执行的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//注入hook</span></span><br><span class="line">    Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">"执行释放资源操作............."</span>);</span><br><span class="line">    &#125;));</span><br><span class="line">    TwoPhaseTerminationTest thread = <span class="keyword">new</span> TwoPhaseTerminationTest();</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果遇到某些资源的释放是极大程度依赖操作系统的，例如IO，Socket等可能在释放资源的过程中发生异常，那么可以考虑使用PhantomReference提高资源释放的概率。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-20-Thread-Pre-Message模式</title>
      <link href="/2020/06/13/30649/hub/"/>
      <url>/2020/06/13/30649/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200613210741489.png" alt="image-20200613210741489"></p><p>&emsp;&emsp;Thread-Pre-Message主要是为每一个消息开辟一个线程使得消息能够以并发的方式处理，进而去提高系统的吞吐能力。</p><h2 id="简单的案例Request"><a href="#简单的案例Request" class="headerlink" title="简单的案例Request"></a>简单的案例Request</h2><h3 id="Helper"><a href="#Helper" class="headerlink" title="Helper"></a>Helper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Helper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Integer iterateCount, String content)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"--- handle begin ----"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; iterateCount; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">"print param ["</span> + i + <span class="string">"] value ["</span> + content + <span class="string">"]."</span>);</span><br><span class="line">            slowly();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"--- handle end ----"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">slowly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Host</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 迭代次数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer iterateCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Host</span><span class="params">(Integer iterateCount, String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iterateCount = iterateCount;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Helper helper = <span class="keyword">new</span> Helper();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"--- request begin ----"</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; helper.handle(iterateCount, content)).start();</span><br><span class="line">        System.out.println(<span class="string">"--- request end ----"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Host(<span class="number">1</span>, <span class="string">"A"</span>).request();</span><br><span class="line">        <span class="keyword">new</span> Host(<span class="number">2</span>, <span class="string">"B"</span>).request();</span><br><span class="line">        <span class="keyword">new</span> Host(<span class="number">3</span>, <span class="string">"C"</span>).request();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以发现我们每次都new了一个Thread对象，那么这样肯定是存在问题的，因为JVM实际开辟的线程是有限制的，而且每个线程的开辟与销毁都是非常耗费资源的，可能由于JVM无法创建线程导致栈内存溢出。当然可以使用线程池复用线程来解决问题。</p><h2 id="多用户通讯Socket"><a href="#多用户通讯Socket" class="headerlink" title="多用户通讯Socket"></a>多用户通讯Socket</h2><h3 id="ChatServer"><a href="#ChatServer" class="headerlink" title="ChatServer"></a>ChatServer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 端口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池（可以自行实现）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPool threadPool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * socket</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ServerSocket serverSocket;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatServer</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启服务端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startServer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//初始化线程2 最大线程6 最小线程2 核心线程4</span></span><br><span class="line">        <span class="keyword">this</span>.threadPool = <span class="keyword">new</span> BasicThreadPool(<span class="number">2</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">this</span>.serverSocket = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">        <span class="keyword">this</span>.serverSocket.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">        System.out.println(<span class="string">"Char server is started and listen at port:"</span> + port);</span><br><span class="line">        <span class="keyword">this</span>.listen();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Socket socket = serverSocket.accept();</span><br><span class="line">            <span class="keyword">this</span>.threadPool.execute(<span class="keyword">new</span> ClientHandler(socket));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ClientHandler"><a href="#ClientHandler" class="headerlink" title="ClientHandler"></a>ClientHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端identity</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String clientIdentify;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClientHandler</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.socket = socket;</span><br><span class="line">        <span class="keyword">this</span>.clientIdentify = socket.getInetAddress().getHostAddress() + <span class="string">":"</span> + socket.getPort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.chat();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">chat</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        BufferedReader bufferedReader = wrap2Reader(<span class="keyword">this</span>.socket.getInputStream());</span><br><span class="line">        PrintStream printStream = wrap2Print(<span class="keyword">this</span>.socket.getOutputStream());</span><br><span class="line">        String received;</span><br><span class="line">        <span class="keyword">while</span> ((received = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.printf(<span class="string">"client:%s-message:%s\n"</span>, clientIdentify, received);</span><br><span class="line">            <span class="keyword">if</span> (received.equals(<span class="string">"quit"</span>)) &#123;</span><br><span class="line">                write2Client(printStream, <span class="string">"client will close."</span>);</span><br><span class="line">                <span class="keyword">this</span>.socket.close();</span><br><span class="line">            &#125;</span><br><span class="line">            write2Client(printStream, <span class="string">"Server:"</span> + received);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字节流转换缓冲流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> BufferedReader <span class="title">wrap2Reader</span><span class="params">(InputStream inputStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字节流转换成PrintStream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputStream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PrintStream <span class="title">wrap2Print</span><span class="params">(OutputStream outputStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PrintStream(outputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * message发送到客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> printStream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">write2Client</span><span class="params">(PrintStream printStream, String message)</span> </span>&#123;</span><br><span class="line">        printStream.println(message);</span><br><span class="line">        printStream.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试使用"><a href="#测试使用" class="headerlink" title="测试使用"></a>测试使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatServerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> ChatServer(<span class="number">1000</span>).startServer();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以使用telnet来连接socket，启动多个客户端进行测试。</p><p><img src="/image/hexo/image-20200613220805640.png" alt="image-20200613220805640"></p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-19-Latch模式</title>
      <link href="/2020/06/13/43700/hub/"/>
      <url>/2020/06/13/43700/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200613182259559.png" alt="image-20200613182259559"></p><p>&emsp;&emsp;主要用于多个业务需要开启了多线程进行业务处理，最后合并数据的时候，多个任务线程不知道结束的先后顺序，或者所有任务都执行完毕的时机，那么Latch模式就孕育而生。主要是一个阀门的作用，它设置了一个屏障，只有所有的条件满足时，阀门才会打开。</p><h2 id="无限等待的CountDownLatch"><a href="#无限等待的CountDownLatch" class="headerlink" title="无限等待的CountDownLatch"></a>无限等待的CountDownLatch</h2><h3 id="Latch定义"><a href="#Latch定义" class="headerlink" title="Latch定义"></a>Latch定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Latch</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 控制因子</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> limit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Latch</span><span class="params">(<span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.limit = limit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使线程陷入阻塞，直到所有任务执行完毕</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程任务数-1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取未完成的任务数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getUnarrived</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatch</span> <span class="keyword">extends</span> <span class="title">Latch</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CountDownLatch</span><span class="params">(<span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(limit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (limit &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.wait();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (limit &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"all of task already arrived."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//自减操作</span></span><br><span class="line">            limit--;</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUnarrived</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> limit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ProgrammerTravel"><a href="#ProgrammerTravel" class="headerlink" title="ProgrammerTravel"></a>ProgrammerTravel</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProgrammerTravel</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 控制阀门</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Latch latch;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交通工具</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String transprotation;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProgrammerTravel</span><span class="params">(Latch latch, String userName, String transprotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.latch = latch;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">        <span class="keyword">this</span>.transprotation = transprotation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(userName + <span class="string">" start take the transportation ["</span> + transprotation + <span class="string">"]."</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(ThreadLocalRandom.current().nextInt(<span class="number">5000</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        latch.countDown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试使用"><a href="#测试使用" class="headerlink" title="测试使用"></a>测试使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Latch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"A"</span>,<span class="string">"Bus"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"B"</span>,<span class="string">"Walking"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"C"</span>,<span class="string">"Subway"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"D"</span>,<span class="string">"Bicycle"</span>).start();</span><br><span class="line">        <span class="comment">//等待</span></span><br><span class="line">        latch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="具有超时功能的CountDownLatch"><a href="#具有超时功能的CountDownLatch" class="headerlink" title="具有超时功能的CountDownLatch"></a>具有超时功能的CountDownLatch</h2><h3 id="Latch"><a href="#Latch" class="headerlink" title="Latch"></a>Latch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 携带超时机制</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeUnit 时间单位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> time 时间数量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">(TimeUnit timeUnit, <span class="keyword">long</span> time)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br></pre></td></tr></table></figure><h3 id="CountDownLatch-1"><a href="#CountDownLatch-1" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">(TimeUnit timeUnit, <span class="keyword">long</span> time)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (time &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The time is invalid."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> nanos = timeUnit.toNanos(time);</span><br><span class="line">    <span class="comment">//任务最终等待结束时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> endNanos = System.nanoTime() + nanos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (limit &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TimeUnit.NANOSECONDS.toMillis(nanos) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"The wait time over specify time."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.wait(TimeUnit.NANOSECONDS.toMillis(nanos));</span><br><span class="line">            nanos = endNanos - System.nanoTime();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试使用-1"><a href="#测试使用-1" class="headerlink" title="测试使用"></a>测试使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Latch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"A"</span>,<span class="string">"Bus"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"B"</span>,<span class="string">"Walking"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"C"</span>,<span class="string">"Subway"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"D"</span>,<span class="string">"Bicycle"</span>).start();</span><br><span class="line">        <span class="comment">//等待</span></span><br><span class="line">        latch.await(TimeUnit.SECONDS, <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="具有回调函数功能的CountDownLatch"><a href="#具有回调函数功能的CountDownLatch" class="headerlink" title="具有回调函数功能的CountDownLatch"></a>具有回调函数功能的CountDownLatch</h2><h3 id="Latch-1"><a href="#Latch-1" class="headerlink" title="Latch"></a>Latch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 回调函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Runnable runnable;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Latch</span><span class="params">(<span class="keyword">int</span> limit,Runnable runnable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.limit = limit;</span><br><span class="line">    <span class="keyword">this</span>.runnable = runnable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CountDownLatch-2"><a href="#CountDownLatch-2" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatch</span> <span class="keyword">extends</span> <span class="title">Latch</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CountDownLatch</span><span class="params">(<span class="keyword">int</span> limit,Runnable runnable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(limit,runnable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">(TimeUnit timeUnit, <span class="keyword">long</span> time)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (time &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The time is invalid."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> nanos = timeUnit.toNanos(time);</span><br><span class="line">        <span class="comment">//任务最终等待结束时间</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> endNanos = System.nanoTime() + nanos;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (limit &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (TimeUnit.NANOSECONDS.toMillis(nanos) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"The wait time over specify time."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.wait(TimeUnit.NANOSECONDS.toMillis(nanos));</span><br><span class="line">                nanos = endNanos - System.nanoTime();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != runnable)&#123;</span><br><span class="line">            runnable.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试使用-2"><a href="#测试使用-2" class="headerlink" title="测试使用"></a>测试使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Latch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">4</span>,()-&gt;&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" call back successful."</span>);&#125;);</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"A"</span>,<span class="string">"Bus"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"B"</span>,<span class="string">"Walking"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"C"</span>,<span class="string">"Subway"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> ProgrammerTravel(latch,<span class="string">"D"</span>,<span class="string">"Bicycle"</span>).start();</span><br><span class="line">        <span class="comment">//等待</span></span><br><span class="line">        latch.await(TimeUnit.SECONDS, <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-18-Balking模式</title>
      <link href="/2020/06/13/36048/hub/"/>
      <url>/2020/06/13/36048/hub/</url>
      
        <content type="html"><![CDATA[<p>&emsp;&emsp;Balking和Guarded Suspension Pattern类似，不过Balking是等待警戒条件不满足时则中断操作，而Guaeded Suspension是等到满足警戒条件采取执行业务操作。比如用于系统资源加载或者数据初始化操作。</p><p><img src="/image/hexo/image-20200613181843041.png" alt="image-20200613181843041"></p><h2 id="文档案例"><a href="#文档案例" class="headerlink" title="文档案例"></a>文档案例</h2><h3 id="AutoSaveThread"><a href="#AutoSaveThread" class="headerlink" title="AutoSaveThread"></a>AutoSaveThread</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoSaveThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Document document;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AutoSaveThread</span><span class="params">(Document document)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"save execute save run."</span>);</span><br><span class="line">        <span class="keyword">this</span>.document = document;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                document.save();</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | IOException e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="DocumentEditThread"><a href="#DocumentEditThread" class="headerlink" title="DocumentEditThread"></a>DocumentEditThread</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DocumentEditThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String documentName;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String documentPath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DocumentEditThread</span><span class="params">(String documentName, String documentPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"DocumentEditThread"</span>);</span><br><span class="line">        <span class="keyword">this</span>.documentName = documentName;</span><br><span class="line">        <span class="keyword">this</span>.documentPath = documentPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> times = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Document document = Document.create(documentPath, documentName);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                String text = scanner.next();</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"quit"</span>.equals(text)) &#123;</span><br><span class="line">                    document.close();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                document.edit(text);</span><br><span class="line">                <span class="keyword">if</span> (times == <span class="number">5</span>) &#123;</span><br><span class="line">                    document.save();</span><br><span class="line">                    times = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                times++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Document</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文档修改标志</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行一次保存操作的缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; content = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FileWriter fileWriter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行保存的线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AutoSaveThread autoSaveThread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> documentPath 文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> documentName 文件名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Document</span><span class="params">(String documentPath, String documentName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fileWriter = <span class="keyword">new</span> FileWriter(<span class="keyword">new</span> File(documentPath,documentName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建文档并开启自动保存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> documentPath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> documentName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Document <span class="title">create</span><span class="params">(String documentPath, String documentName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Document document = <span class="keyword">new</span> Document(documentPath, documentName);</span><br><span class="line">        autoSaveThread = <span class="keyword">new</span> AutoSaveThread(document);</span><br><span class="line">        autoSaveThread.start();</span><br><span class="line">        <span class="keyword">return</span> document;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">edit</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.content.add(content);</span><br><span class="line">            <span class="keyword">this</span>.changed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        autoSaveThread.interrupt();</span><br><span class="line">        fileWriter.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行保存操作</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!changed) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" execute the save action."</span>);</span><br><span class="line">            <span class="keyword">for</span> (String contentLine : content) &#123;</span><br><span class="line">                <span class="keyword">this</span>.fileWriter.write(contentLine);</span><br><span class="line">                <span class="keyword">this</span>.fileWriter.write(<span class="string">"\r\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.fileWriter.flush();</span><br><span class="line">            <span class="keyword">this</span>.changed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.content.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> DocumentEditThread(<span class="string">"balking.txt"</span>,<span class="string">"D:\\"</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-17-线程上下文模式</title>
      <link href="/2020/06/08/45741/hub/"/>
      <url>/2020/06/08/45741/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200608211442420.png" alt="image-20200608211442420"></p><p>&emsp;&emsp;上下文经常可以在struts2等框架中看见，比如ActionContext,Spring中的ApplicationContext。上下文它贯穿了整个系统或者阶段生命周期的对象。</p><h2 id="上下文示例与演变"><a href="#上下文示例与演变" class="headerlink" title="上下文示例与演变"></a>上下文示例与演变</h2><h3 id="定义上下文Context"><a href="#定义上下文Context" class="headerlink" title="定义上下文Context"></a>定义上下文Context</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String idCard;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIdCard</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> idCard;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIdCard</span><span class="params">(String idCard)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.idCard = idCard;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="定义查询接口"><a href="#定义查询接口" class="headerlink" title="定义查询接口"></a>定义查询接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryFormDBAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            String name = <span class="string">"sanmeng"</span>;</span><br><span class="line">            context.setName(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryFormHttpAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        String name = context.getName();</span><br><span class="line">        String idCard = <span class="keyword">this</span>.getIdCard(name);</span><br><span class="line">        context.setIdCard(idCard);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIdCard</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"00001"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试查询"><a href="#测试查询" class="headerlink" title="测试查询"></a>测试查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecuteTask</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> QueryFormDBAction queryFormDBAction = <span class="keyword">new</span> QueryFormDBAction();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> QueryFormHttpAction queryFormHttpAction = <span class="keyword">new</span> QueryFormHttpAction();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Context context = <span class="keyword">new</span> Context();</span><br><span class="line">        queryFormDBAction.execute(context);</span><br><span class="line">        queryFormHttpAction.execute(context);</span><br><span class="line">        System.out.println(<span class="string">"The name is "</span> + context.getName() + <span class="string">" and idCard is "</span> + context.getIdCard() + <span class="string">" ."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ExecuteTask().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以发现context是从头传到尾的，在演示的代码中涉及到的流程不是很多，如果是大量的调用导致参数的大量传递那么导致代码非常的繁琐。那么我们可以采用线程上下文的方式来简化这种操作。</p><h3 id="演变简化"><a href="#演变简化" class="headerlink" title="演变简化"></a>演变简化</h3><h4 id="定义上下文"><a href="#定义上下文" class="headerlink" title="定义上下文"></a>定义上下文</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Context&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;Context&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Context <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Context();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextHolder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ApplicationContext application = <span class="keyword">new</span> ApplicationContext();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApplicationContext <span class="title">getApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ContextHolder.application;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> threadLocal.get();</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修改查询方式"><a href="#修改查询方式" class="headerlink" title="修改查询方式"></a>修改查询方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryFormDBAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Context context = ApplicationContext.getApplication().getContext();</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            String name = <span class="string">"sanmeng"</span>;</span><br><span class="line">            context.setName(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryFormHttpAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Context context = ApplicationContext.getApplication().getContext();</span><br><span class="line">        String name = context.getName();</span><br><span class="line">        String idCard = <span class="keyword">this</span>.getIdCard(name);</span><br><span class="line">        context.setIdCard(idCard);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIdCard</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"00001"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试查询-1"><a href="#测试查询-1" class="headerlink" title="测试查询"></a>测试查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecuteTask</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> QueryFormDBAction queryFormDBAction = <span class="keyword">new</span> QueryFormDBAction();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> QueryFormHttpAction queryFormHttpAction = <span class="keyword">new</span> QueryFormHttpAction();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        queryFormDBAction.execute();</span><br><span class="line">        queryFormHttpAction.execute();</span><br><span class="line">        Context context = ApplicationContext.getApplication().getContext();</span><br><span class="line">        System.out.println(<span class="string">"The name is "</span> + context.getName() + <span class="string">" and idCard is "</span> + context.getIdCard() + <span class="string">" ."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> ExecuteTask().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;采用了ThreadLocal的方式，使用ApplicationContext上下文来获取Context。因为每一份线程获取到的Context是一样的，避免参数的大量传递。</p><p>&emsp;&emsp;但是通过这样定义的线程上下文很有可能造成内存泄露，因为ThreadLocal是以当前线程作为key的一个map数据结构，当线程的生命周期结束以后，但是ThreadLocal不会释放实例，那么与之对应的value也不会得到回收，那么可以采用soft reference或者weak reference等引用类型使得JVM主动尝试回收。若是采用了线程池，那么线程复用的时候也可能出现执行下一个任务的时候获取到了上一个线程残留的数据，这个时候就需要做一些数据清理的工作了。</p><h2 id="ThreadLocal详解"><a href="#ThreadLocal详解" class="headerlink" title="ThreadLocal详解"></a>ThreadLocal详解</h2><p><img src="/image/hexo/image-20200611195727939.png" alt="image-20200611195727939"></p><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>&emsp;&emsp;1.主要是涉及到对象跨层传输，避免参数多次传递，打破层次间的约束。</p><p>&emsp;&emsp;2.事务操作，用于存储线程事务信息</p><p>&emsp;&emsp;一般情况下每一个线程的ThreadLocal存储的都是一个全新的对象，否则多个线程存放了一个相同对象的引用那么将可能引起一系列的线程问题，比如资源竞争或者数据不一致等问题。</p><h3 id="initialValue"><a href="#initialValue" class="headerlink" title="initialValue"></a>initialValue</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> T <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Object&gt; threadLocal2 = <span class="keyword">new</span> ThreadLocal&lt;Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Object();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;initialValue主要为ThreadLocal需要存储的数据指定了一个默认值。可以重写该方法进行数据的初始化操作。</p><h3 id="withInitial"><a href="#withInitial" class="headerlink" title="withInitial"></a>withInitial</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ThreadLocal&lt;S&gt; <span class="title">withInitial</span><span class="params">(Supplier&lt;? extends S&gt; supplier)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SuppliedThreadLocal&lt;&gt;(supplier);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Object&gt; threadLocal1 = ThreadLocal.withInitial(Object::<span class="keyword">new</span>);</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;也是进行默认数据的一个设置，但是可以更加简洁的使用Java8函数式接口。</p><p>&emsp;&emsp;通过输出可以发现每一个线程获取到的数据其实是不一样的（线程私有的数据拷贝）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    IntStream.range(<span class="number">0</span>, <span class="number">5</span>).forEach(i -&gt; <span class="keyword">new</span> Thread(() -&gt; System.out.println(threadLocal1.get())).start());</span><br><span class="line">    System.out.println(<span class="string">"----------------------------"</span>);</span><br><span class="line">    IntStream.range(<span class="number">0</span>, <span class="number">5</span>).forEach(i -&gt; <span class="keyword">new</span> Thread(() -&gt; System.out.println(threadLocal2.get())).start());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><p><img src="/image/hexo/image-20200611195842265.png" alt="image-20200611195842265"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</span><br><span class="line">        map.set(<span class="keyword">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We don't use a fast path as with get() because it is at</span></span><br><span class="line">    <span class="comment">// least as common to use set() to create new entries as</span></span><br><span class="line">    <span class="comment">// it is to replace existing ones, in which case, a fast</span></span><br><span class="line">    <span class="comment">// path would fail more often than not.</span></span><br><span class="line"></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Entry e = tab[i];</span><br><span class="line">         e != <span class="keyword">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</span><br><span class="line">            replaceStaleEntry(key, value, i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tab[i] = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line">    <span class="keyword">int</span> sz = ++size;</span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">        rehash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.获取当前线程的Thread.currentThread();</p><p>&emsp;&emsp;2.根据当前线程获取相关联的ThreadLocalMap数据结构;</p><p>&emsp;&emsp;3.如果map为null，则创建一个ThreadLocalMap,当前现场ThreadLocal实例作为key，对应到ThreadLocalMap则是创建了一个Enrty。否则，遍历整个map的Enrty，发现如果ThreadLocal相同则使用当前新的数据覆盖旧的数据，set过程结束。</p><p>&emsp;&emsp;4.在遍历的过程中，如果发现有Enrty的key为null的数据则逐出并且使用新的数据占用被逐出的位置，主要是为了防止内存泄漏。</p><p>&emsp;&emsp;5.创建新的Enrty，ThreadLocal作为key。</p><p>&emsp;&emsp;6.检测存在的元素大小与阀值，再次进行key为null的数据清理。</p><h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            T result = (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    T value = initialValue();</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</span><br><span class="line">        map.set(<span class="keyword">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.获取当前线程的Thread.currentThread(),进而获取与之相关联的ThreadLocalMap;</p><p>&emsp;&emsp;2.如果map已经实例化，那么通过ThreadLocal作为key获取对应的Enrty，如果Enrty不为null则返回对应数据，否则进入setInitialValue方法;</p><p>&emsp;&emsp;3.map未实例化，则进入setInitialValue方法。</p><p>&emsp;&emsp;4.setInitialValue首先获取initialValue，如果此刻ThreadLocalMap不为null，则指定initialValue作为值，map.set(this, value)实际上new了一个Enrty对象。</p><p>&emsp;&emsp;5.如果是首次使用ThreadLocalMap,则创建一个新的ThreadLocalMap,并且与Thread对象的threadlocals属性相关联，可以发现ThreadLocalMap也是采用的拦截在模式。</p><p>&emsp;&emsp;6.返回initialValue,如果未重写该方法则获取到的为null。</p><h3 id="ThreadLocalMap详解"><a href="#ThreadLocalMap详解" class="headerlink" title="ThreadLocalMap详解"></a>ThreadLocalMap详解</h3><p>&emsp;&emsp;不管是get还是set方法都要去操作ThreadLocalMap和Enrty。ThreadLocalMap是一个类似与HashMap的数据结构，仅仅用于存放线程在ThreadLocal中的数据备份，ThreadLocalMap中的所有方法都对外部不可见。</p><p>&emsp;&emsp;在ThreadLocalMap中用于存放数据的是Enrty对象，它是一个WeakRenference类型的子类。主要是为了JVM在发生垃圾回收事件时，能够自动防止内存溢出的情况出现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/** The value associated with this ThreadLocal. */</span></span><br><span class="line">    Object value;</span><br><span class="line"></span><br><span class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">        <span class="keyword">super</span>(k);</span><br><span class="line">        value = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="hash算法"><a href="#hash算法" class="headerlink" title="hash算法"></a>hash算法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">    table = <span class="keyword">new</span> Entry[INITIAL_CAPACITY];</span><br><span class="line">    <span class="comment">//i就是当前key在散列表中数组的下标位置</span></span><br><span class="line">    <span class="keyword">int</span> i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">    table[i] = <span class="keyword">new</span> Entry(firstKey, firstValue);</span><br><span class="line">    size = <span class="number">1</span>;</span><br><span class="line">    setThreshold(INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_INCREMENT = <span class="number">0x61c88647</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> threadLocalHashCode = nextHashCode();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nextHashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;每创建一个ThreadLocal对象那么threadLocalHashCode这个值就会增长HASH_INCREMENT，HASH_INCREMENT它是一个斐波那契数，也叫做黄金分割数，由于hash的增量是这样，那么会使得分布非常的均匀。</p><h4 id="hash冲突"><a href="#hash冲突" class="headerlink" title="hash冲突"></a>hash冲突</h4><p><img src="/image/hexo/image-20200611201241907.png" alt="image-20200611201241907"></p><p>&emsp;&emsp;虽然斐波那契数能降低hash冲突的概率，但是也是不可避免的。如果插入数据时候发现槽位已经有了数据，那么就会线性往后查询，直达Enrty为null的槽位才会停止。</p><h4 id="set-1"><a href="#set-1" class="headerlink" title="set"></a>set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    <span class="comment">//计算索引</span></span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Entry e = tab[i];</span><br><span class="line">         e != <span class="keyword">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//key相同则更新</span></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//清算过期数据</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</span><br><span class="line">            replaceStaleEntry(key, value, i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tab[i] = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line">    <span class="keyword">int</span> sz = ++size;</span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">        rehash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.计算出槽位对应的Entitiy为空则直接放入数据。</p><p>&emsp;&emsp;2.槽位的数据不为空，但是key一致就更新数据。</p><p>&emsp;&emsp;3.槽位数据不为空，往后遍历的过程中，找到Enrty为null之前没有遇到过期的Enrty则放入Enrty为null的槽位。</p><h4 id="getEntry"><a href="#getEntry" class="headerlink" title="getEntry"></a>getEntry</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">    Entry e = table[i];</span><br><span class="line">    <span class="comment">//key相同直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="keyword">int</span> i, Entry e)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="comment">//往后迭代遇到相同key则返回</span></span><br><span class="line">        <span class="keyword">if</span> (k == key)</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        <span class="comment">//遇到过期数据则清理</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>)</span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">//继续下一次迭代</span></span><br><span class="line">            i = nextIndex(i, len);</span><br><span class="line">        <span class="comment">//如果还没找到说明没有数据</span></span><br><span class="line">        e = tab[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="replaceStaleEntry"><a href="#replaceStaleEntry" class="headerlink" title="replaceStaleEntry"></a>replaceStaleEntry</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceStaleEntry</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value,<span class="keyword">int</span> staleSlot)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    Entry e;</span><br><span class="line">    <span class="comment">//初始化slotToExpunge,过期桶的位置staleSlot</span></span><br><span class="line">    <span class="keyword">int</span> slotToExpunge = staleSlot;</span><br><span class="line">    <span class="comment">//从staleSlot开始往前不断遍历</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = prevIndex(staleSlot, len);</span><br><span class="line">         (e = tab[i]) != <span class="keyword">null</span>;</span><br><span class="line">         <span class="comment">//获取往前的索引</span></span><br><span class="line">         i = prevIndex(i, len))</span><br><span class="line">        <span class="comment">//直到查询到Enrty为null的情形才会停止，同时更新slotToExpunge</span></span><br><span class="line">        <span class="comment">//目的将slotToExpunge更新到最前面，好用于后面清算</span></span><br><span class="line">        <span class="keyword">if</span> (e.get() == <span class="keyword">null</span>)</span><br><span class="line">            slotToExpunge = i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//往后遍历</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = nextIndex(staleSlot, len);</span><br><span class="line">         (e = tab[i]) != <span class="keyword">null</span>;</span><br><span class="line">         <span class="comment">//获取往后的索引</span></span><br><span class="line">         i = nextIndex(i, len)) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果key值相同，此操作后没有key相同的Entry</span></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line"><span class="comment">//数据赋值，位置交换</span></span><br><span class="line">            tab[i] = tab[staleSlot];</span><br><span class="line">            tab[staleSlot] = e;</span><br><span class="line"><span class="comment">//如果还存在，说明prevIndex没移动过</span></span><br><span class="line">            <span class="keyword">if</span> (slotToExpunge == staleSlot)</span><br><span class="line">                <span class="comment">//数据交换则slotToExpunge也执行交换</span></span><br><span class="line">                slotToExpunge = i;</span><br><span class="line">            <span class="comment">//执行清算操作，从slotToExpunge开始</span></span><br><span class="line">            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//存在过期的数据，slotToExpunge从当前开始</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span> &amp;&amp; slotToExpunge == staleSlot)</span><br><span class="line">            slotToExpunge = i;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">//过期的数据置为null，前置条件k == key或者存在过期数据</span></span><br><span class="line">    tab[staleSlot].value = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//重新赋值</span></span><br><span class="line">    tab[staleSlot] = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行清算</span></span><br><span class="line">    <span class="keyword">if</span> (slotToExpunge != staleSlot)</span><br><span class="line">        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//往前遍历</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">prevIndex</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((i - <span class="number">1</span> &gt;= <span class="number">0</span>) ? i - <span class="number">1</span> : len - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//往后遍历</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nextIndex</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((i + <span class="number">1</span> &lt; len) ? i + <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="expungeStaleEntry"><a href="#expungeStaleEntry" class="headerlink" title="expungeStaleEntry"></a>expungeStaleEntry</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">expungeStaleEntry</span><span class="params">(<span class="keyword">int</span> staleSlot)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line"><span class="comment">//过期的槽位置空，并且减少空间</span></span><br><span class="line">    tab[staleSlot].value = <span class="keyword">null</span>;</span><br><span class="line">    tab[staleSlot] = <span class="keyword">null</span>;</span><br><span class="line">    size--;</span><br><span class="line"></span><br><span class="line">    Entry e;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">//往后遍历</span></span><br><span class="line">    <span class="keyword">for</span> (i = nextIndex(staleSlot, len);</span><br><span class="line">         (e = tab[i]) != <span class="keyword">null</span>;</span><br><span class="line">         i = nextIndex(i, len)) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="comment">//key为null的情况下，清理数据</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</span><br><span class="line">            e.value = <span class="keyword">null</span>;</span><br><span class="line">            tab[i] = <span class="keyword">null</span>;</span><br><span class="line">            size--;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//计算当前槽位的hash值，如果不相等就说明产生了hash冲突</span></span><br><span class="line">            <span class="keyword">int</span> h = k.threadLocalHashCode &amp; (len - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (h != i) &#123;</span><br><span class="line">                tab[i] = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//往后寻找下一个槽位</span></span><br><span class="line">                <span class="keyword">while</span> (tab[h] != <span class="keyword">null</span>)</span><br><span class="line">                    h = nextIndex(h, len);</span><br><span class="line">                tab[h] = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="扩容机制"><a href="#扩容机制" class="headerlink" title="扩容机制"></a>扩容机制</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> sz = ++size;</span><br><span class="line">    <span class="comment">//未清理到任何数据，且当前散列数组中Entry的数量已经达到了列表的扩容阈值(len*2/3)，就开始执行rehash()逻辑：</span></span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">        rehash();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//扩容因子</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> threshold; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setThreshold</span><span class="params">(<span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    threshold = len * <span class="number">2</span> / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rehash</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//执行一次清理数据操作</span></span><br><span class="line">    expungeStaleEntries();</span><br><span class="line"> <span class="comment">//清理完以后判断当前容量是否大于扩容因子的3/4来决定扩容</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt;= threshold - threshold / <span class="number">4</span>)</span><br><span class="line">        resize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//清理</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expungeStaleEntries</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        Entry e = tab[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e.get() == <span class="keyword">null</span>)</span><br><span class="line">            expungeStaleEntry(j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Entry[] oldTab = table;</span><br><span class="line">    <span class="keyword">int</span> oldLen = oldTab.length;</span><br><span class="line">    <span class="comment">//扩容2倍</span></span><br><span class="line">    <span class="keyword">int</span> newLen = oldLen * <span class="number">2</span>;</span><br><span class="line">    Entry[] newTab = <span class="keyword">new</span> Entry[newLen];</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldLen; ++j) &#123;</span><br><span class="line">        Entry e = oldTab[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">            <span class="comment">//处理过期数据</span></span><br><span class="line">            <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</span><br><span class="line">                e.value = <span class="keyword">null</span>; <span class="comment">// Help the GC</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//处理hash冲突</span></span><br><span class="line">                <span class="keyword">int</span> h = k.threadLocalHashCode &amp; (newLen - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">while</span> (newTab[h] != <span class="keyword">null</span>)</span><br><span class="line">                    h = nextIndex(h, newLen);</span><br><span class="line">                newTab[h] = e;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//重新加载扩容因子</span></span><br><span class="line">    setThreshold(newLen);</span><br><span class="line">    size = count;</span><br><span class="line">    table = newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ThreadLocal内存溢出问题"><a href="#ThreadLocal内存溢出问题" class="headerlink" title="ThreadLocal内存溢出问题"></a>ThreadLocal内存溢出问题</h2><p>&emsp;&emsp;在上面的演示中已经说明了内存溢出的问题。</p><p>&emsp;&emsp;1.Enrty设计成为WeakReference类型可以触发任意GC时都会导致Enrty的回收。</p><p>&emsp;&emsp;2.在get数据的时候做检测，清除已经被垃圾回收器回收的Enrty。否则执行replaceStaleEntry方法，主要用于替换过期数据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="keyword">int</span> i, Entry e)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="keyword">if</span> (k == key)</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>)</span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            i = nextIndex(i, len);</span><br><span class="line">        e = tab[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//删除key==null的操作</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">expungeStaleEntry</span><span class="params">(<span class="keyword">int</span> staleSlot)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// expunge entry at staleSlot</span></span><br><span class="line">    tab[staleSlot].value = <span class="keyword">null</span>;</span><br><span class="line">    tab[staleSlot] = <span class="keyword">null</span>;</span><br><span class="line">    size--;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rehash until we encounter null</span></span><br><span class="line">    Entry e;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = nextIndex(staleSlot, len);</span><br><span class="line">         (e = tab[i]) != <span class="keyword">null</span>;</span><br><span class="line">         i = nextIndex(i, len)) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</span><br><span class="line">            e.value = <span class="keyword">null</span>;</span><br><span class="line">            tab[i] = <span class="keyword">null</span>;</span><br><span class="line">            size--;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> h = k.threadLocalHashCode &amp; (len - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (h != i) &#123;</span><br><span class="line">                tab[i] = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Unlike Knuth 6.4 Algorithm R, we must scan until</span></span><br><span class="line">                <span class="comment">// null because multiple entries could have been stale.</span></span><br><span class="line">                <span class="keyword">while</span> (tab[h] != <span class="keyword">null</span>)</span><br><span class="line">                    h = nextIndex(h, len);</span><br><span class="line">                tab[h] = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;3.set数据时也增加了数据检测。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We don't use a fast path as with get() because it is at</span></span><br><span class="line">    <span class="comment">// least as common to use set() to create new entries as</span></span><br><span class="line">    <span class="comment">// it is to replace existing ones, in which case, a fast</span></span><br><span class="line">    <span class="comment">// path would fail more often than not.</span></span><br><span class="line"></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Entry e = tab[i];</span><br><span class="line">         e != <span class="keyword">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</span><br><span class="line">            replaceStaleEntry(key, value, i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tab[i] = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line">    <span class="keyword">int</span> sz = ++size;</span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">        rehash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">cleanSomeSlots</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> removed = <span class="keyword">false</span>;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        i = nextIndex(i, len);</span><br><span class="line">        Entry e = tab[i];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e.get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            n = len;</span><br><span class="line">            removed = <span class="keyword">true</span>;</span><br><span class="line">            i = expungeStaleEntry(i);<span class="comment">//删除操作</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> ( (n &gt;&gt;&gt;= <span class="number">1</span>) != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这样可以在一定程度上保证不发生内存泄漏问题。但是内存泄漏和内存溢出是有区别的，内存泄漏是导致内存溢出的原因之一，内存泄漏更多的是程序中不再持有某个对象的引用，但是该对象任然无法被垃圾回收器回收，主要是因为该对象引用根Root的链路是可达的。</p><p><img src="/image/hexo/image-20200608223818546.png" alt="image-20200608223818546"></p><p>&emsp;&emsp;上图中，实线代表强引用，虚线代表的是弱引用，如果threadLocal外部强引用被置为null(threadLocalInstance=null)的话，threadLocal实例就没有一条引用链路可达，很显然在gc(垃圾回收)的时候势必会被回收，<strong>因此entry就存在key为null的情况，无法通过一个Key为null去访问到该entry的value</strong>。同时，就存在了这样一条引用链：threadRef-&gt;currentThread-&gt;threadLocalMap-&gt;entry-&gt;valueRef-&gt;valueMemory,导致在垃圾回收的时候进行可达性分析的时候,value可达从而不会被回收掉，但是该value永远不能被访问到，这样就存在了<strong>内存泄漏</strong>。</p><h2 id="ThreadLocal扩展（InheritableThreadLocal）"><a href="#ThreadLocal扩展（InheritableThreadLocal）" class="headerlink" title="ThreadLocal扩展（InheritableThreadLocal）"></a>ThreadLocal扩展（InheritableThreadLocal）</h2><p>&emsp;&emsp;TheradLocal主要用于当前线程，如果在某些业务场景下有耗时的操作需要开辟子线程，这个时候ThreadLocal将不再适用，因为子线程里面获取不到父线程的数据，所以就有了InheritableThreadLocal来解决这个问题。它主要继承了父线程的变量。</p><p>&emsp;&emsp;主要在父线程创建子线程的时候，new Thread()构造方法在调用init方法的时候将父线程的数据拷贝到了子线程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">long</span> stackSize, AccessControlContext acc,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">boolean</span> inheritThreadLocals)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">//拷贝父线程的inheritableThreadLocals</span></span><br><span class="line">            <span class="keyword">this</span>.inheritableThreadLocals =</span><br><span class="line">                ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">this</span>.stackSize = stackSize;</span><br><span class="line"></span><br><span class="line">        tid = nextThreadID();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritableThreadLocal</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ThreadLocal</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> T <span class="title">childValue</span><span class="params">(T parentValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parentValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//跟ThreadLocal中的差别在于把ThreadLocal中的threadLocals换成了inheritableThreadLocals</span></span><br><span class="line">    <span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> t.inheritableThreadLocals;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//调用get、set方法都要调用createMap,子类重写了该方法</span></span><br><span class="line">        t.inheritableThreadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="父子间变量的可见性"><a href="#父子间变量的可见性" class="headerlink" title="父子间变量的可见性"></a>父子间变量的可见性</h3><h4 id="父子间正常传递数据"><a href="#父子间正常传递数据" class="headerlink" title="父子间正常传递数据"></a>父子间正常传递数据</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritableThreadLocalTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; inheritableThreadLocal = <span class="keyword">new</span> InheritableThreadLocal&lt;Integer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line">    <span class="comment">//正常操作：子线程获取父线程的数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//mian线程</span></span><br><span class="line">        <span class="keyword">int</span> value = random.nextInt(<span class="number">100</span>);</span><br><span class="line">        System.out.println(<span class="string">"main Thread set Value: "</span> + value);</span><br><span class="line">        inheritableThreadLocal.set(value);</span><br><span class="line">        <span class="comment">//开辟子线线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">"child Thread set Value: "</span> + inheritableThreadLocal.get());</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        test01();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="父子间可变对象传递-初始化父线程"><a href="#父子间可变对象传递-初始化父线程" class="headerlink" title="父子间可变对象传递(初始化父线程)"></a>父子间可变对象传递(初始化父线程)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritableThreadLocalTest1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Student&gt; inheritableThreadLocal = <span class="keyword">new</span> InheritableThreadLocal&lt;Student&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 可变对象：初始化父线程，子线程更改父线程中的数据以后也会随之更改</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//main线程并且初始化</span></span><br><span class="line">        inheritableThreadLocal.set(<span class="keyword">new</span> Student(<span class="string">"乔治"</span>));</span><br><span class="line">        System.out.println(<span class="string">"main Thread set Value: "</span> + inheritableThreadLocal.get().getUserName());</span><br><span class="line">        <span class="comment">//开辟子线线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            Student student = inheritableThreadLocal.get();</span><br><span class="line">            student.setUserName(<span class="string">"佩奇"</span>);</span><br><span class="line">            System.out.println(<span class="string">"child Thread set Value: "</span> + student.getUserName());</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"main Thread set Value: "</span> + inheritableThreadLocal.get().getUserName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        test01();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="父子间可变对象传递（父线程不进行初始化）"><a href="#父子间可变对象传递（父线程不进行初始化）" class="headerlink" title="父子间可变对象传递（父线程不进行初始化）"></a>父子间可变对象传递（父线程不进行初始化）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritableThreadLocalTest1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Student&gt; inheritableThreadLocal = <span class="keyword">new</span> InheritableThreadLocal&lt;Student&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 可变对象：不初始化父线程，没有进行数据浅拷贝，父子间都是单独的引用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//main线程并且初始化</span></span><br><span class="line">        System.out.println(<span class="string">"main Thread set Value: "</span> + inheritableThreadLocal.get());</span><br><span class="line">        <span class="comment">//开辟子线线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            Student student = <span class="keyword">new</span> Student(<span class="string">"佩奇"</span>);</span><br><span class="line">            inheritableThreadLocal.set(student);</span><br><span class="line">            System.out.println(<span class="string">"child Thread set Value: "</span> + student.getUserName());</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"main Thread set Value: "</span> + inheritableThreadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        test01();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String userName = <span class="string">"No Anything"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="父子间不可变对象传递（父线程不初始化）"><a href="#父子间不可变对象传递（父线程不初始化）" class="headerlink" title="父子间不可变对象传递（父线程不初始化）"></a>父子间不可变对象传递（父线程不初始化）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritableThreadLocalTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="keyword">new</span> InheritableThreadLocal&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不可变对象：不初始化父线程，没有进行数据浅拷贝，父子间都是单独的引用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//main线程并且初始化</span></span><br><span class="line">        System.out.println(<span class="string">"main Thread set Value: "</span> + inheritableThreadLocal.get());</span><br><span class="line">        <span class="comment">//开辟子线线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            inheritableThreadLocal.set(<span class="string">"佩奇"</span>);</span><br><span class="line">            System.out.println(<span class="string">"child Thread set Value: "</span> + inheritableThreadLocal.get());</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"main Thread set Value: "</span> + inheritableThreadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        test01();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="父子间不可变对象传递（父线程初始化）"><a href="#父子间不可变对象传递（父线程初始化）" class="headerlink" title="父子间不可变对象传递（父线程初始化）"></a>父子间不可变对象传递（父线程初始化）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritableThreadLocalTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="keyword">new</span> InheritableThreadLocal&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不可变对象：初始化父线程，由于不可变对象的特性每一次都是一个新的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//main线程并且初始化</span></span><br><span class="line">        inheritableThreadLocal.set(<span class="string">"乔治"</span>);</span><br><span class="line">        System.out.println(<span class="string">"main Thread set Value: "</span> + inheritableThreadLocal.get());</span><br><span class="line">        <span class="comment">//开辟子线线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            inheritableThreadLocal.set(<span class="string">"佩奇"</span>);</span><br><span class="line">            System.out.println(<span class="string">"child Thread set Value: "</span> + inheritableThreadLocal.get());</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"main Thread set Value: "</span> + inheritableThreadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        test01();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="使用线程池复用线程导致的问题"><a href="#使用线程池复用线程导致的问题" class="headerlink" title="使用线程池复用线程导致的问题"></a>使用线程池复用线程导致的问题</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritableThreadLocalTest3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="keyword">new</span> InheritableThreadLocal&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池下使用:复用线程可以获取到上次执行业务执行单元所残留的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IntStream.range(<span class="number">1</span>,<span class="number">30</span>).forEach(i-&gt;&#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                System.out.println(<span class="string">"for Each index before = "</span> + i + <span class="string">"  inheritableThreadLocal thread get value = "</span> + inheritableThreadLocal.get());</span><br><span class="line">                inheritableThreadLocal.set(String.valueOf(i));</span><br><span class="line">                System.out.println(<span class="string">"for Each index after = "</span> + i + <span class="string">"  inheritableThreadLocal thread get value = "</span> + inheritableThreadLocal.get());</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        test01();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="可变对象"><a href="#可变对象" class="headerlink" title="可变对象"></a>可变对象</h4><p>&emsp;&emsp;针对可变对象，父线程初始化：由于使用的是Thread Construct浅拷贝，子线程修改同时父线程也会跟着变化。子线程初始化：没有Thread Construct浅拷贝,父子间都是单独的引用，两者间没有影响。</p><h4 id="不可变对象"><a href="#不可变对象" class="headerlink" title="不可变对象"></a>不可变对象</h4><p>&emsp;&emsp;由于不可变对象的设计，每次都是新的一个对象，所以两者间也是没有任何影响的。</p><h4 id="实现父子间无影响"><a href="#实现父子间无影响" class="headerlink" title="实现父子间无影响"></a>实现父子间无影响</h4><p>&emsp;&emsp;可以重写childValue()方法，根据需要实现数据拷贝以达到目的。</p><h4 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h4><p>&emsp;&emsp;一般用于异步处理，但是大多数情况下都是使用线程池进行工作，由于线程复用的问题，而InheritableThreadLocal是在Thread中的init()方法进行赋值的，所以这个地方也会存在问题。</p><h2 id="ThreadLocal扩展（TransmittableThreadLocal）"><a href="#ThreadLocal扩展（TransmittableThreadLocal）" class="headerlink" title="ThreadLocal扩展（TransmittableThreadLocal）"></a>ThreadLocal扩展（TransmittableThreadLocal）</h2><p>&emsp;&emsp;解决InheritableThreadLocal线程池的问题。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritableThreadLocalTest3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用TransmittableThreadLocal</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; inheritableThreadLocal = <span class="keyword">new</span> TransmittableThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池使用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ExecutorService executorService = TtlExecutors.getTtlExecutorService(Executors.newFixedThreadPool(<span class="number">10</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池下使用:复用线程获取到的是null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IntStream.range(<span class="number">1</span>,<span class="number">30</span>).forEach(i-&gt;&#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                System.out.println(<span class="string">"for Each index before = "</span> + i + <span class="string">"  inheritableThreadLocal thread get value = "</span> + inheritableThreadLocal.get());</span><br><span class="line">                inheritableThreadLocal.set(String.valueOf(i));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        test01();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="hoder"><a href="#hoder" class="headerlink" title="hoder"></a>hoder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//WeakHashMap同样也是弱引用，主要是解决内存泄漏问题</span></span><br><span class="line"><span class="comment">//引入holder，保持ThreadLocal.ThreadLocalMap的封装性</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> InheritableThreadLocal&lt;WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt;&gt; holder =</span><br><span class="line">    <span class="keyword">new</span> InheritableThreadLocal&lt;WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt;&gt;() &#123;</span><br><span class="line">    <span class="comment">//重写了初始化方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; initialValue() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//同样将父线程的数据拷贝了一份</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; childValue(WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; parentValue) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;(parentValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addThisToHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!holder.get().containsKey(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        holder.get().put((TransmittableThreadLocal&lt;Object&gt;) <span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;发现 holder 就是 InheritableThreadLocal，也就是说子线程是可以获取到父线程中 holder 的数据的，可以继承。即当前 TransmittableThreadLocal 类是一个中心，它的 holder 维护了所有的TransmittableThreadLocal。</p><h3 id="get-set"><a href="#get-set" class="headerlink" title="get/set"></a>get/set</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.set(value);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == value) removeValue();</span><br><span class="line">    <span class="keyword">else</span> addValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    T value = <span class="keyword">super</span>.get();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != value) addValue();</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    holder.get().remove(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!holder.get().containsKey(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        holder.get().put(<span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TtlExecutors-getTtlExecutorService"><a href="#TtlExecutors-getTtlExecutorService" class="headerlink" title="TtlExecutors.getTtlExecutorService"></a>TtlExecutors.getTtlExecutorService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExecutorTtlWrapper</span> <span class="keyword">implements</span> <span class="title">Executor</span>, <span class="title">TtlWrapper</span>&lt;<span class="title">Executor</span>&gt;, <span class="title">TtlEnhanced</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Executor executor;</span><br><span class="line"></span><br><span class="line">    ExecutorTtlWrapper(<span class="meta">@NonNull</span> Executor executor) &#123;</span><br><span class="line">        <span class="keyword">this</span>.executor = executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将runnable进行了包装TtlRunnable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(@NonNull Runnable command)</span> </span>&#123;</span><br><span class="line">        executor.execute(TtlRunnable.get(command));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">unwrap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Runnable包装类TtlRunnable"><a href="#Runnable包装类TtlRunnable" class="headerlink" title="Runnable包装类TtlRunnable"></a>Runnable包装类TtlRunnable</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取一个TtlRunnable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TtlRunnable <span class="title">get</span><span class="params">(@Nullable Runnable runnable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> get(runnable, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TtlRunnable <span class="title">get</span><span class="params">(@Nullable Runnable runnable, <span class="keyword">boolean</span> releaseTtlValueReferenceAfterRun, <span class="keyword">boolean</span> idempotent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == runnable) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果runnable已经使用TtlEnhanced包装过了那么直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (runnable <span class="keyword">instanceof</span> TtlEnhanced) &#123;</span><br><span class="line">        <span class="comment">// avoid redundant decoration, and ensure idempotency</span></span><br><span class="line">        <span class="keyword">if</span> (idempotent) <span class="keyword">return</span> (TtlRunnable) runnable;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already TtlRunnable!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//执行初始化动作</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TtlRunnable(runnable, releaseTtlValueReferenceAfterRun);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行初始化动作</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">TtlRunnable</span><span class="params">(@NonNull Runnable runnable, <span class="keyword">boolean</span> releaseTtlValueReferenceAfterRun)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//进行了数据拷贝</span></span><br><span class="line">    <span class="keyword">this</span>.capturedRef = <span class="keyword">new</span> AtomicReference&lt;Object&gt;(capture());</span><br><span class="line">    <span class="keyword">this</span>.runnable = runnable;</span><br><span class="line">    <span class="keyword">this</span>.releaseTtlValueReferenceAfterRun = releaseTtlValueReferenceAfterRun;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//主要获取父线程的数据</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">capture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Snapshot(captureTtlValues(), captureThreadLocalValues());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//属于Ttl</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; captureTtlValues() &#123;</span><br><span class="line">    WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; ttl2Value = <span class="keyword">new</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line">    <span class="keyword">for</span> (TransmittableThreadLocal&lt;Object&gt; threadLocal : holder.get().keySet()) &#123;</span><br><span class="line">        ttl2Value.put(threadLocal, threadLocal.copyValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ttl2Value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//属于Tl</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> WeakHashMap&lt;ThreadLocal&lt;Object&gt;, Object&gt; captureThreadLocalValues() &#123;</span><br><span class="line">    <span class="keyword">final</span> WeakHashMap&lt;ThreadLocal&lt;Object&gt;, Object&gt; threadLocal2Value = <span class="keyword">new</span> WeakHashMap&lt;ThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;ThreadLocal&lt;Object&gt;, TtlCopier&lt;Object&gt;&gt; entry : threadLocalHolder.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">final</span> ThreadLocal&lt;Object&gt; threadLocal = entry.getKey();</span><br><span class="line">        <span class="keyword">final</span> TtlCopier&lt;Object&gt; copier = entry.getValue();</span><br><span class="line"></span><br><span class="line">        threadLocal2Value.put(threadLocal, copier.copy(threadLocal.get()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> threadLocal2Value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//capturedRef这个是父线程的数据作为当前的数据</span></span><br><span class="line">    Object captured = capturedRef.get();</span><br><span class="line">    <span class="keyword">if</span> (captured == <span class="keyword">null</span> || releaseTtlValueReferenceAfterRun &amp;&amp; !capturedRef.compareAndSet(captured, <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"TTL value reference is released after run!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//backup是子线程的本地变量，任务执行完毕归还数据</span></span><br><span class="line">    Object backup = replay(captured);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        runnable.run();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//最终进行数据恢复</span></span><br><span class="line">        restore(backup);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回子线程当前的数据</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">replay</span><span class="params">(@NonNull Object captured)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Snapshot capturedSnapshot = (Snapshot) captured;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Snapshot(replayTtlValues(capturedSnapshot.ttl2Value), replayThreadLocalValues(capturedSnapshot.threadLocal2Value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//来自父线程captured数据</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; replayTtlValues(<span class="meta">@NonNull</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; captured) &#123;</span><br><span class="line">    WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; backup = <span class="keyword">new</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> Iterator&lt;TransmittableThreadLocal&lt;Object&gt;&gt; iterator = holder.get().keySet().iterator(); iterator.hasNext(); ) &#123;</span><br><span class="line">        TransmittableThreadLocal&lt;Object&gt; threadLocal = iterator.next();</span><br><span class="line"><span class="comment">//复制数据</span></span><br><span class="line">        backup.put(threadLocal, threadLocal.get());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!captured.containsKey(threadLocal)) &#123;</span><br><span class="line">            iterator.remove();</span><br><span class="line">            threadLocal.superRemove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置新的数据</span></span><br><span class="line">    setTtlValuesTo(captured);</span><br><span class="line"></span><br><span class="line">    doExecuteCallback(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> backup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> WeakHashMap&lt;ThreadLocal&lt;Object&gt;, Object&gt; replayThreadLocalValues(<span class="meta">@NonNull</span> WeakHashMap&lt;ThreadLocal&lt;Object&gt;, Object&gt; captured) &#123;</span><br><span class="line">    <span class="keyword">final</span> WeakHashMap&lt;ThreadLocal&lt;Object&gt;, Object&gt; backup = <span class="keyword">new</span> WeakHashMap&lt;ThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;ThreadLocal&lt;Object&gt;, Object&gt; entry : captured.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">final</span> ThreadLocal&lt;Object&gt; threadLocal = entry.getKey();</span><br><span class="line">        backup.put(threadLocal, threadLocal.get());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Object value = entry.getValue();</span><br><span class="line">        <span class="keyword">if</span> (value == threadLocalClearMark) threadLocal.remove();</span><br><span class="line">        <span class="keyword">else</span> threadLocal.set(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> backup;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进行数据还原</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">restore</span><span class="params">(@NonNull Object backup)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Snapshot backupSnapshot = (Snapshot) backup;</span><br><span class="line">    restoreTtlValues(backupSnapshot.ttl2Value);</span><br><span class="line">    restoreThreadLocalValues(backupSnapshot.threadLocal2Value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//原子线程backup的数据</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">restoreTtlValues</span><span class="params">(@NonNull WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; backup)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// call afterExecute callback</span></span><br><span class="line">    doExecuteCallback(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> Iterator&lt;TransmittableThreadLocal&lt;Object&gt;&gt; iterator = holder.get().keySet().iterator(); iterator.hasNext(); ) &#123;</span><br><span class="line">        TransmittableThreadLocal&lt;Object&gt; threadLocal = iterator.next();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!backup.containsKey(threadLocal)) &#123;</span><br><span class="line">            iterator.remove();</span><br><span class="line">            threadLocal.superRemove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将原有的数据恢复backup避免当前任务执行修改了上下文数据会影响下一次线程的使用</span></span><br><span class="line">    setTtlValuesTo(backup);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//主要负责数据赋值</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setTtlValuesTo</span><span class="params">(@NonNull WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; ttlValues)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; entry : ttlValues.entrySet()) &#123;</span><br><span class="line">        TransmittableThreadLocal&lt;Object&gt; threadLocal = entry.getKey();</span><br><span class="line">        <span class="comment">//调用的TransmittableThreadLocal的set方法</span></span><br><span class="line">        threadLocal.set(entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//再次回到set方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!disableIgnoreNullValueSemantics &amp;&amp; <span class="keyword">null</span> == value) &#123;</span><br><span class="line">        <span class="comment">// may set null to remove value</span></span><br><span class="line">        remove();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.set(value);</span><br><span class="line">        addThisToHolder();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addThisToHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!holder.get().containsKey(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        holder.get().put((TransmittableThreadLocal&lt;Object&gt;) <span class="keyword">this</span>, <span class="keyword">null</span>); <span class="comment">// WeakHashMap supports null value.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;TransmittableThreadLocal中最主要的就是提前存储数据到全局的 <code>holder</code> 中，主要为了解决线程池生成线程的时间问题导致了数据无法传递,以及在子线程的数据恢复。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-16-Guarded Suspension模式</title>
      <link href="/2020/06/08/13488/hub/"/>
      <url>/2020/06/08/13488/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200608203803918.png" alt="image-20200608203803918"></p><p>&emsp;&emsp;Guarded Suspension是确保挂起的意思。当线程访问某个资源的时候，发现条件不满足的情形下就将挂起当前线程等待条件满足以后继续执行。它的设计非常的简单，主要是关注这个警戒条件，如果达到警戒条件则将操作的线程正确的挂起，防止出现数据不一致或者引发的其他一系列问题。</p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GuardedSuspensionQueue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;Integer&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> LIMIT_MAX = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span><span class="params">(Integer data)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (queue.size() &gt;= LIMIT_MAX) &#123;</span><br><span class="line">                System.out.println(<span class="string">"offer wait."</span>);</span><br><span class="line">                <span class="keyword">this</span>.wait();</span><br><span class="line">            &#125;</span><br><span class="line">            queue.addLast(data);</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (queue.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.wait();</span><br><span class="line">                System.out.println(<span class="string">"take wait."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">            <span class="keyword">return</span> queue.removeFirst();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        GuardedSuspensionQueue queue = <span class="keyword">new</span> GuardedSuspensionQueue();</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">10</span>).forEach(i -&gt; <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; <span class="number">100</span>; index++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    queue.offer(index);</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start());</span><br><span class="line"></span><br><span class="line">        IntStream.range(<span class="number">0</span>,<span class="number">1</span>).forEach(i -&gt; <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(queue.take());</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-15-Future模式</title>
      <link href="/2020/06/07/4200/hub/"/>
      <url>/2020/06/07/4200/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200607212954975.png" alt="image-20200607212954975"></p><p>&emsp;&emsp;如果有些任务执行耗时比较久，通常需要等待任务执行完毕或者出错才能返回结果，在这个期间调用者只能陷入等待。对此Future提供了一种基于凭证式的解决方案。JDK1.5提供了比较强大的Future接口，而JDK1.8更是引入了CompletableFuture，结合函数式接口可以实现更加强大的功能。</p><h2 id="Future设计与实现"><a href="#Future设计与实现" class="headerlink" title="Future设计与实现"></a>Future设计与实现</h2><p><img src="/image/hexo/image-20200607213923588.png" alt="image-20200607213923588"></p><h3 id="Future接口"><a href="#Future接口" class="headerlink" title="Future接口"></a>Future接口</h3><p>&emsp;&emsp;需要提供执行计算结果的接口，以及判断任务是否执行完毕的判断接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取执行结果，如果没有执行完毕调用则会使线程陷入阻塞</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">T <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断任务是否执行完毕</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">done</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FutureTask实现"><a href="#FutureTask实现" class="headerlink" title="FutureTask实现"></a>FutureTask实现</h3><p>&emsp;&emsp;主要对Future接口的实现，如果任务没有执行完毕那么企图获取计算结果则会导致线程陷入阻塞，直到任务执行完毕再次唤醒其他等待中的线程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTask</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Future</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务是否完成</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isDone = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object LOCK = <span class="keyword">new</span> Object();</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            <span class="keyword">while</span> (!isDone) &#123;</span><br><span class="line">                LOCK.wait();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 程序执行完毕</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(T result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">            <span class="keyword">if</span>(isDone)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.result = result;</span><br><span class="line">            <span class="keyword">this</span>.isDone = <span class="keyword">true</span>;</span><br><span class="line">            LOCK.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isDone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Task接口"><a href="#Task接口" class="headerlink" title="Task接口"></a>Task接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Task</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算返回的执行结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">R <span class="title">get</span><span class="params">(T t)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FutureService接口"><a href="#FutureService接口" class="headerlink" title="FutureService接口"></a>FutureService接口</h3><p>&emsp;&emsp;主要用于提交任务，一种是无需返回值，而另一种是需要返回最终的执行结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FutureService</span>&lt;<span class="title">T</span>,<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交任务无需返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> runnable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Future&lt;?&gt; submit(Runnable runnable);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交任务返回最终结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Future&lt;R&gt; <span class="title">submit</span><span class="params">(Task&lt;T, R&gt; task, T t)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &lt;T,R&gt; <span class="function">FutureService&lt;T,R&gt; <span class="title">newService</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FutureServiceImpl&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="FutureServiceImpl实现"><a href="#FutureServiceImpl实现" class="headerlink" title="FutureServiceImpl实现"></a>FutureServiceImpl实现</h3><p>&emsp;&emsp;主要在方法内开辟了一个线程去执行任务，实现了异步的方式，任务执行完毕会调用Future的finish方法通知任务执行完毕。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureServiceImpl</span>&lt;<span class="title">T</span>,<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">FutureService</span>&lt;<span class="title">T</span>,<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String FUTURE_THREAD_PREFIX = <span class="string">"FUTURE_"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger nextCounter = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNextName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FUTURE_THREAD_PREFIX + nextCounter.getAndIncrement();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Future&lt;?&gt; submit(Runnable runnable) &#123;</span><br><span class="line">        <span class="keyword">final</span> FutureTask&lt;Void&gt; future = <span class="keyword">new</span> FutureTask&lt;&gt;();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            runnable.run();</span><br><span class="line">            <span class="comment">//逻辑单元执行完毕通知finish</span></span><br><span class="line">            future.finish(<span class="keyword">null</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">return</span> future;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Future&lt;R&gt; <span class="title">submit</span><span class="params">(Task&lt;T, R&gt; task, T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> FutureTask&lt;R&gt; future = <span class="keyword">new</span> FutureTask&lt;&gt;();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            R result = task.get(t);</span><br><span class="line">            <span class="comment">//逻辑单元执行完毕通知finish</span></span><br><span class="line">            future.finish(result);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">return</span> future;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试运行无返回值"><a href="#测试运行无返回值" class="headerlink" title="测试运行无返回值"></a>测试运行无返回值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        FutureService&lt;Void, Void&gt; futureService = FutureService.newService();</span><br><span class="line">        Future&lt;?&gt; future = futureService.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"I am finish done."</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(<span class="string">"---------------------------------------"</span>);</span><br><span class="line">        System.out.println(<span class="string">"do something."</span>);</span><br><span class="line">        System.out.println(<span class="string">"---------------------------------------"</span>);</span><br><span class="line">        System.out.println(<span class="string">"-----------------Block--------------"</span>);</span><br><span class="line">        future.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200607220432625.png" alt="image-20200607220432625"></p><h3 id="测试运行带返回值"><a href="#测试运行带返回值" class="headerlink" title="测试运行带返回值"></a>测试运行带返回值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        FutureService&lt;String, Integer&gt; futureService = FutureService.newService();</span><br><span class="line">        Future&lt;Integer&gt; future = futureService.submit(input -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> input.length();</span><br><span class="line">        &#125;, <span class="string">"Hello Future"</span>);</span><br><span class="line">        System.out.println(<span class="string">"---------------------------------------"</span>);</span><br><span class="line">        System.out.println(<span class="string">"do something."</span>);</span><br><span class="line">        System.out.println(<span class="string">"---------------------------------------"</span>);</span><br><span class="line">        System.out.println(<span class="string">"-----------------Block--------------"</span>);</span><br><span class="line">        Optional.ofNullable(future.get()).ifPresent(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200607221900090.png" alt="image-20200607221900090"></p><h2 id="Future支持回调"><a href="#Future支持回调" class="headerlink" title="Future支持回调"></a>Future支持回调</h2><h3 id="Callback接口定义"><a href="#Callback接口定义" class="headerlink" title="Callback接口定义"></a>Callback接口定义</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span><br><span class="line">public interface Callback&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回调接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="variable">t</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> call(T t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="增强FutureService"><a href="#增强FutureService" class="headerlink" title="增强FutureService"></a>增强FutureService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">* 提交任务返回最终结果并且设置回调函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function">Future&lt;R&gt; <span class="title">submit</span><span class="params">(Task&lt;T, R&gt; task, T t,Callback&lt;R&gt; callback)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="FutureServiceImpl实现回调接口"><a href="#FutureServiceImpl实现回调接口" class="headerlink" title="FutureServiceImpl实现回调接口"></a>FutureServiceImpl实现回调接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;R&gt; <span class="title">submit</span><span class="params">(Task&lt;T, R&gt; task, T t, Callback&lt;R&gt; callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> FutureTask&lt;R&gt; future = <span class="keyword">new</span> FutureTask&lt;&gt;();</span><br><span class="line">    <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        R result = task.get(t);</span><br><span class="line">        <span class="comment">//逻辑单元执行完毕通知finish</span></span><br><span class="line">        future.finish(result);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != callback) &#123;</span><br><span class="line">            callback.call(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试携带回调函数"><a href="#测试携带回调函数" class="headerlink" title="测试携带回调函数"></a>测试携带回调函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        FutureService&lt;String, Integer&gt; futureService = FutureService.newService();</span><br><span class="line">        Future&lt;Integer&gt; future = futureService.submit(input -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> input.length();</span><br><span class="line">        &#125;, <span class="string">"Hello Future"</span>, System.out::println);</span><br><span class="line">        System.out.println(<span class="string">"---------------------------------------"</span>);</span><br><span class="line">        System.out.println(<span class="string">"do something."</span>);</span><br><span class="line">        System.out.println(<span class="string">"---------------------------------------"</span>);</span><br><span class="line">        System.out.println(<span class="string">"-----------------Block--------------"</span>);</span><br><span class="line">        future.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果某个任务比较耗时导致线程进入了阻塞，那么阻塞的时间其实已经浪费了，可以在这段时间处理其他的业务逻辑，可以极大程度上节约资源。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-14-Immutable不可变对象模式</title>
      <link href="/2020/06/07/26489/hub/"/>
      <url>/2020/06/07/26489/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200607180212257.png" alt="image-20200607180212257"></p><p>&emsp;&emsp;不管是synchronized关键字还是显式锁的方式，都会牺牲系统的性能。Java核心类库中提供了大量不可变对象的范例，例如String的所有方法都没有使用synchronized修饰，但是也是线程安全的。有些非线程安全的对象被不可变机制处理以后也可以具备不可变性。比如ArrayList在stream并行处理也是线程安全的。</p><h2 id="非线程安全的累加器"><a href="#非线程安全的累加器" class="headerlink" title="非线程安全的累加器"></a>非线程安全的累加器</h2><p>&emsp;&emsp;不可变对象的核心就是不提供给外部修改共享资源的机会，这样就能够避免多线程情况下数据冲突问题以及锁带来的性能开销。由于IntegerAccumulator没有任何保护共享资源的机制，所以会出现Error的情形。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerAccumulator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> init;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IntegerAccumulator</span><span class="params">(<span class="keyword">int</span> init)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.init = init;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.init += i;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.init;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.init;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        IntegerAccumulator integerAccumulator = <span class="keyword">new</span> IntegerAccumulator(<span class="number">0</span>);</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">3</span>).forEach(i -&gt; <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> inc = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">//获取旧值</span></span><br><span class="line">                <span class="keyword">int</span> oldValue = integerAccumulator.getValue();</span><br><span class="line">                <span class="comment">//改变数据</span></span><br><span class="line">                <span class="keyword">int</span> result = integerAccumulator.add(inc);</span><br><span class="line">                System.out.println(oldValue + <span class="string">"+"</span> + inc + <span class="string">" = "</span> + result);</span><br><span class="line">                <span class="comment">//计算结果</span></span><br><span class="line">                <span class="keyword">if</span> (inc + oldValue != result) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Error:"</span> + oldValue + <span class="string">"+"</span> + inc + <span class="string">" = "</span> + result);</span><br><span class="line">                &#125;</span><br><span class="line">                inc++;</span><br><span class="line">                slowly();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">slowly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200607182001845.png" alt="image-20200607182001845"></p><h2 id="方法同步增加线程安全"><a href="#方法同步增加线程安全" class="headerlink" title="方法同步增加线程安全"></a>方法同步增加线程安全</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    IntegerAccumulator integerAccumulator = <span class="keyword">new</span> IntegerAccumulator(<span class="number">0</span>);</span><br><span class="line">    IntStream.range(<span class="number">0</span>, <span class="number">3</span>).forEach(i -&gt; <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">int</span> inc = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> oldValue;</span><br><span class="line">            <span class="keyword">int</span> result;</span><br><span class="line">            <span class="keyword">synchronized</span> (IntegerAccumulator<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="comment">//获取旧值</span></span><br><span class="line">                oldValue = integerAccumulator.getValue();</span><br><span class="line">                <span class="comment">//改变数据</span></span><br><span class="line">                result = integerAccumulator.add(inc);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(oldValue + <span class="string">"+"</span> + inc + <span class="string">" = "</span> + result);</span><br><span class="line">            <span class="comment">//计算结果</span></span><br><span class="line">            <span class="keyword">if</span> (inc + oldValue != result) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Error:"</span> + oldValue + <span class="string">"+"</span> + inc + <span class="string">" = "</span> + result);</span><br><span class="line">            &#125;</span><br><span class="line">            inc++;</span><br><span class="line">            slowly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;synchronized关键字使用在了线程内部业务执行单元，而没有放入IntegerAccumulator，因为该类中有多个方法，如果在方法上使用synchronized关键字修饰，仅仅是保证了单个方法的原子性，但是多个方法组合起来也无法保证其原子性。</p><h2 id="不可变累加器"><a href="#不可变累加器" class="headerlink" title="不可变累加器"></a>不可变累加器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IntegerAccumulator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> init;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IntegerAccumulator</span><span class="params">(<span class="keyword">int</span> init)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.init = init;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IntegerAccumulator</span><span class="params">(IntegerAccumulator integerAccumulator, <span class="keyword">int</span> init)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.init = integerAccumulator.getValue() + init;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IntegerAccumulator <span class="title">add</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IntegerAccumulator(<span class="keyword">this</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.init;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        IntegerAccumulator integerAccumulator = <span class="keyword">new</span> IntegerAccumulator(<span class="number">0</span>);</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">3</span>).forEach(i -&gt; <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> inc = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">//获取旧值</span></span><br><span class="line">                <span class="keyword">int</span> oldValue = integerAccumulator.getValue();</span><br><span class="line">                <span class="comment">//改变数据</span></span><br><span class="line">                <span class="keyword">int</span> result = integerAccumulator.add(inc).getValue();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + oldValue + <span class="string">"+"</span> + inc + <span class="string">" = "</span> + result);</span><br><span class="line">                <span class="comment">//计算结果</span></span><br><span class="line">                <span class="keyword">if</span> (inc + oldValue != result) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Error:"</span> + oldValue + <span class="string">"+"</span> + inc + <span class="string">" = "</span> + result);</span><br><span class="line">                &#125;</span><br><span class="line">                inc++;</span><br><span class="line">                slowly();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">slowly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;使用了final修饰防止子类重写可能导致失去线程安全的特性，init也使用final修饰以后，构造函数中赋值成功后就将不会再变化，并没有机会修改值的机会。所以实现了线程安全的特性。</p><h2 id="不可变对象内部的可变对象"><a href="#不可变对象内部的可变对象" class="headerlink" title="不可变对象内部的可变对象"></a>不可变对象内部的可变对象</h2><p>&emsp;&emsp;如果一个对象设计成为了不可变，而其内部还存在例如final修饰List的对象，如果提供了get的操作，那么可能在其他线程会去修改此对象，那么也将导致整个对象的不可变性失效。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Immutable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Immutable</span><span class="params">(List&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Immutable immutable = <span class="keyword">new</span> Immutable(<span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(<span class="string">"A"</span>, <span class="string">"B"</span>)));</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            immutable.getList().add(<span class="string">"C"</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        immutable.getList().stream().forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200607183714647.png" alt="image-20200607183714647"></p><p>&emsp;&emsp;可以发现已经修改了Immutable内部的List，此时要想实现真正的不可变，那么可以在返回的时候增加不可修改的约束或者克隆一个全新的List返回,使用克隆方式要留意深度克隆。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unmodifiableList</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.unmodifiableList(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//deepCopy</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getList</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> deepCopy(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">deepCopy</span><span class="params">(List&lt;T&gt; src)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ByteArrayOutputStream outputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(outputStream);</span><br><span class="line">    out.writeObject(src);</span><br><span class="line">    ByteArrayInputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(outputStream.toByteArray());</span><br><span class="line">    ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(inputStream);</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    List&lt;T&gt; copyList = (List&lt;T&gt;) in.readObject();</span><br><span class="line">    <span class="keyword">return</span> copyList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-13-读写分离模式</title>
      <link href="/2020/06/07/3037/hub/"/>
      <url>/2020/06/07/3037/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200607162404772.png" alt="image-20200607162404772"></p><p>&emsp;&emsp;在多线程场景下，由于对共享资源进行保护通常采用了synchronized关键字实现或者采用显示锁。对资源的访问一般概括为两种类型的操作，读和写，如果某个资源的读操作明显多于写操作，那么synchronized就显得比较粗暴，而且降低了效率，那么在只读情况下不加锁那将大大提升执行效率。</p><h2 id="读写分离程序设计"><a href="#读写分离程序设计" class="headerlink" title="读写分离程序设计"></a>读写分离程序设计</h2><p><img src="/image/hexo/image-20200607163903465.png" alt="image-20200607163903465"></p><h3 id="Lock接口定义"><a href="#Lock接口定义" class="headerlink" title="Lock接口定义"></a>Lock接口定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ReadWriteLock接口定义"><a href="#ReadWriteLock接口定义" class="headerlink" title="ReadWriteLock接口定义"></a>ReadWriteLock接口定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ReadWriteLock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建读取锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Lock <span class="title">readLock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建写入锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Lock <span class="title">writeLock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前执行写入操作的线程数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getWritingWriters</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前等待写入操作的线程数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getWaitingWriters</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前等待获取读取锁的线程数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getWaitingReaders</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建ReadWriteLock</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> ReadWriteLock <span class="title">readWriteLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReadWriteLockImpl();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建ReadWriteLock</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> ReadWriteLock <span class="title">readWriteLock</span><span class="params">(<span class="keyword">boolean</span> preferWriter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReadWriteLockImpl(preferWriter);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ReadWriteLockImpl实现"><a href="#ReadWriteLockImpl实现" class="headerlink" title="ReadWriteLockImpl实现"></a>ReadWriteLockImpl实现</h3><p>&emsp;&emsp;实现基本操作，对几个数量的操作接口以及偏好设置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadWriteLockImpl</span> <span class="keyword">implements</span> <span class="title">ReadWriteLock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object MUTEX = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正在写入线程数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> writingWriters = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 等待获取写入锁线程数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> waitingWriters = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 等待获取读取锁线程数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> readingReaders = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 偏好设置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> preferWriter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReadWriteLockImpl</span><span class="params">(<span class="keyword">boolean</span> preferWriter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.preferWriter = preferWriter;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReadWriteLockImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Lock <span class="title">readLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Lock <span class="title">writeLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWritingWriters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.writingWriters;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWaitingWriters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.waitingWriters;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWaitingReaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.readingReaders;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getMUTEX</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.MUTEX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPreferWriter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> preferWriter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incrementReadingReaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.readingReaders++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrementReadingReaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.readingReaders--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changePrefer</span><span class="params">(<span class="keyword">boolean</span> prefer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.preferWriter = prefer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incrementWritingWriters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.waitingWriters++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrementWritingWriters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.waitingWriters--;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incrementWaitingWriters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.waitingWriters++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrementWaitingWriters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.waitingWriters++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ReadLock实现"><a href="#ReadLock实现" class="headerlink" title="ReadLock实现"></a>ReadLock实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadLock</span> <span class="keyword">implements</span> <span class="title">Lock</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLockImpl readWriteLock;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReadLock</span><span class="params">(ReadWriteLockImpl readWriteLock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.readWriteLock = readWriteLock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (readWriteLock.getMUTEX()) &#123;</span><br><span class="line">            <span class="comment">//有写入线程在工作，或者偏好设置了写入锁并且有等待写入的线程那么将挂起当前线程</span></span><br><span class="line">            <span class="keyword">while</span> (readWriteLock.getWritingWriters() &gt; <span class="number">0</span> ||</span><br><span class="line">                    (readWriteLock.isPreferWriter()) &amp;&amp; readWriteLock.getWaitingWriters() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                readWriteLock.getMUTEX().wait();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取到了写入锁,读取线程+1</span></span><br><span class="line">            readWriteLock.incrementReadingReaders();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (readWriteLock.getMUTEX()) &#123;</span><br><span class="line">            <span class="comment">//读取锁-1</span></span><br><span class="line">            readWriteLock.decrementReadingReaders();</span><br><span class="line">            <span class="comment">//更改偏好设置使写入锁有更多的机会</span></span><br><span class="line">            readWriteLock.changePrefer(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//唤醒wait set中线程</span></span><br><span class="line">            readWriteLock.getMUTEX().notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="WriteLock实现"><a href="#WriteLock实现" class="headerlink" title="WriteLock实现"></a>WriteLock实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WriteLock</span> <span class="keyword">implements</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLockImpl readWriteLock;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WriteLock</span><span class="params">(ReadWriteLockImpl readWriteLock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.readWriteLock = readWriteLock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (readWriteLock.getMUTEX()) &#123;</span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">              <span class="comment">//等待线程自增</span></span><br><span class="line">              readWriteLock.incrementWaitingWriters();</span><br><span class="line">              <span class="comment">//其他线程有在工作则挂起当前线程</span></span><br><span class="line">              <span class="keyword">while</span> (readWriteLock.getWaitingReaders() &gt; <span class="number">0</span> || readWriteLock.getWritingWriters() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                  readWriteLock.getMUTEX().wait();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">              <span class="comment">//等待线程-1</span></span><br><span class="line">              readWriteLock.decrementWaitingWriters();</span><br><span class="line">          &#125;</span><br><span class="line">            <span class="comment">//获取写入锁+1</span></span><br><span class="line">            readWriteLock.incrementWritingWriters();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (readWriteLock.getMUTEX()) &#123;</span><br><span class="line">            <span class="comment">//写入线程-1</span></span><br><span class="line">            readWriteLock.decrementWritingWriters();</span><br><span class="line">            <span class="comment">//更改偏好设置</span></span><br><span class="line">            readWriteLock.changePrefer(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//唤醒wait set中等待的线程</span></span><br><span class="line">            readWriteLock.getMUTEX().notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ReadWriteLockImpl锁的实现"><a href="#ReadWriteLockImpl锁的实现" class="headerlink" title="ReadWriteLockImpl锁的实现"></a>ReadWriteLockImpl锁的实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Lock <span class="title">readLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReadLock(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Lock <span class="title">writeLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WriteLock(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="定义共享资源"><a href="#定义共享资源" class="headerlink" title="定义共享资源"></a>定义共享资源</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShareData</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 共享资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Character&gt; characters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * readWriteLock</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock readWriteLock = ReadWriteLock.readWriteLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock readLock = readWriteLock.readLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 写入锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock writeLock = readWriteLock.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> length;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShareData</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.length = length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            characters.add(i, <span class="string">'A'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">char</span>[] read() <span class="keyword">throws</span> InterruptedException&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取读取锁</span></span><br><span class="line">            readLock.lock();</span><br><span class="line">            <span class="keyword">char</span>[] newBuffer = <span class="keyword">new</span> <span class="keyword">char</span>[length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">                newBuffer[i] = characters.get(i);</span><br><span class="line">            &#125;</span><br><span class="line">            slowly();</span><br><span class="line">            <span class="keyword">return</span> newBuffer;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">char</span> c)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//获取写入锁</span></span><br><span class="line">            writeLock.lock();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">                characters.add(i, c);</span><br><span class="line">            &#125;</span><br><span class="line">            slowly();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">slowly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试使用"><a href="#测试使用" class="headerlink" title="测试使用"></a>测试使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String text = <span class="string">"qwertyuiopasdfghjklzzxcvbnm"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ShareData shareData = <span class="keyword">new</span> ShareData(<span class="number">50</span>);</span><br><span class="line">        <span class="comment">//开启两个写入线程</span></span><br><span class="line">        IntStream.rangeClosed(<span class="number">0</span>, <span class="number">1</span>).forEach(i-&gt;&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; text.length(); index++) &#123;</span><br><span class="line">                    <span class="keyword">char</span> c = text.charAt(index);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        shareData.write(c);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(Thread.currentThread() + <span class="string">" write "</span> + c);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启五个读取线程</span></span><br><span class="line">        IntStream.rangeClosed(<span class="number">0</span>,<span class="number">9</span>).forEach(i-&gt;&#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        System.out.println(Thread.currentThread() + <span class="string">" read "</span> + String.valueOf(shareData.read()));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;JDK版本几乎每一次升级都会看到对锁的优化，synchronized关键字的性能也得到了很大的提升，在JDK的并发包下提供了读写锁的实现，也突出了Java官方对读写分离的重视。RW锁允许多个线程同一时刻同时对共享资源进行读取操作，这读操作比较多的情况下对性能的提升是非常明显的，但是使用不当也会带来弊端。比如在写的线程数量和读的线程数量接近甚至多于读的线程的数量，所以JDK1.8新增了StampedLock的解决方案。</p><h2 id="拓展-StampedLock"><a href="#拓展-StampedLock" class="headerlink" title="拓展-StampedLock"></a>拓展-StampedLock</h2><p>&emsp;&emsp;在JUC框架阶段再行补充。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-12-Single Thread Execution模式</title>
      <link href="/2020/06/06/5039/hub/"/>
      <url>/2020/06/06/5039/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200606204011222.png" alt="image-20200606204011222"></p><p>&emsp;&emsp;Single Thread Execution模式指的是在同一时刻仅有一个线程去访问共享资源，采用排他式的操作来保证。</p><h2 id="机场安检案例"><a href="#机场安检案例" class="headerlink" title="机场安检案例"></a>机场安检案例</h2><h3 id="非线程安全方式"><a href="#非线程安全方式" class="headerlink" title="非线程安全方式"></a>非线程安全方式</h3><p>&emsp;&emsp;FlightSecurity通过pass方法简单的去检验了乘客的信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlightSecurity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登机牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String boardingPass = <span class="string">"null"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 身份证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String idCard = <span class="string">"null"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pass</span><span class="params">(String boardingPass, String idCard)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.boardingPass = boardingPass;</span><br><span class="line">        <span class="keyword">this</span>.idCard = idCard;</span><br><span class="line">        <span class="keyword">this</span>.count++;</span><br><span class="line">        check();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//登机牌与身份证首字母不一致时表示拒绝</span></span><br><span class="line">        <span class="keyword">if</span> (boardingPass.charAt(<span class="number">0</span>) != idCard.charAt(<span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"------------------------&gt; "</span> + toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"The "</span> + count + <span class="string">" passengers,boardingPass ["</span> + boardingPass + <span class="string">"] , idCard [ "</span> + idCard + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlightSecurityTest</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//安检</span></span><br><span class="line">    <span class="keyword">private</span> FlightSecurity flightSecurity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String idCard;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String boardingPass;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FlightSecurityTest</span><span class="params">(FlightSecurity flightSecurity, String idCard, String boardingPass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.boardingPass = boardingPass;</span><br><span class="line">        <span class="keyword">this</span>.idCard = idCard;</span><br><span class="line">        <span class="keyword">this</span>.flightSecurity = flightSecurity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            flightSecurity.pass(boardingPass, idCard);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> FlightSecurity flightSecurity = <span class="keyword">new</span> FlightSecurity();</span><br><span class="line">        <span class="keyword">new</span> FlightSecurityTest(flightSecurity, <span class="string">"A123456"</span>, <span class="string">"AF123456"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> FlightSecurityTest(flightSecurity, <span class="string">"B123456"</span>, <span class="string">"BF123456"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> FlightSecurityTest(flightSecurity, <span class="string">"C123456"</span>, <span class="string">"CF123456"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> FlightSecurityTest(flightSecurity, <span class="string">"D123456"</span>, <span class="string">"DF123456"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> FlightSecurityTest(flightSecurity, <span class="string">"E123456"</span>, <span class="string">"EF123456"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;似乎看起来没有什么问题，但实际上在多线程的情况下会存在问题，本来理论上所有的乘客都是满足条件的，但是出现了身份比对失败的情况。</p><h4 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h4><h5 id="首字母相同出现验证失败的问题"><a href="#首字母相同出现验证失败的问题" class="headerlink" title="首字母相同出现验证失败的问题"></a>首字母相同出现验证失败的问题</h5><p><img src="/image/hexo/image-20200606212810825.png" alt="image-20200606212810825"></p><p>&emsp;&emsp;1.线程A调用了pass方法，传了A的身份证信息，并且赋值成功，此时CPU的调度导致线程B也调用了pass方法，此时可能将身份信息覆盖一部分，比如身份证，赋值成功。</p><p>&emsp;&emsp;2.线程A此刻重新获得了CPU的执行权，将A的登机牌赋值成功，此刻check方法无法通过，在此场景下登机牌是线程A的，身份证是线程B的，身份检验显然通过不了。</p><p>&emsp;&emsp;3.但是为什么显示了首字母相同的信息呢？主要是在toString的时候，CPU的轮转可能让线程B得到了执行机会，将登机牌改变成为了线程B的。</p><h5 id="首字母不相同的情况"><a href="#首字母不相同的情况" class="headerlink" title="首字母不相同的情况"></a>首字母不相同的情况</h5><p><img src="/image/hexo/image-20200606213659125.png" alt="image-20200606213659125"></p><p>&emsp;&emsp;也是类比首字母相同的情况下身份验证失败，两者没有什么差别，这也说明了当前模式是无法保证线程安全的。</p><h3 id="线程安全方式"><a href="#线程安全方式" class="headerlink" title="线程安全方式"></a>线程安全方式</h3><p>&emsp;&emsp;上面的主要导致线程不安全的原因主要是数据同步的问题，虽然传入的属性是能够比对的上的，但是在进行赋值操作的时候出现了多个线程间的交错，所以需要对共享资源进行保护。对pass方法使用synchronized关键字修饰即可保护共享资源</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">pass</span><span class="params">(String boardingPass, String idCard)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.boardingPass = boardingPass;</span><br><span class="line">    <span class="keyword">this</span>.idCard = idCard;</span><br><span class="line">    <span class="keyword">this</span>.count++;</span><br><span class="line">    check();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>&emsp;&emsp;在多线程情况下访问资源的时候，被synchronized同步的方法总是排他性的。</p><p>&emsp;&emsp;多个线程去对某个类的状态进行更改时，也可以使用Single Thread Execution模式。</p><h2 id="吃面案例"><a href="#吃面案例" class="headerlink" title="吃面案例"></a>吃面案例</h2><h3 id="吃面引起的死锁问题"><a href="#吃面引起的死锁问题" class="headerlink" title="吃面引起的死锁问题"></a>吃面引起的死锁问题</h3><p>&emsp;&emsp;synchronized能够保证single thread execution，但是使用不当也会导致线程死锁的问题。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tableware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//餐具名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String toolName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tableware</span><span class="params">(String toolName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.toolName = toolName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Tableware&#123;"</span> +</span><br><span class="line">                <span class="string">"toolName='"</span> + toolName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EatNoodleThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tableware leftToolName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tableware rightToolName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EatNoodleThread</span><span class="params">(String name, Tableware leftToolName, Tableware rightToolName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.leftToolName = leftToolName;</span><br><span class="line">        <span class="keyword">this</span>.rightToolName = rightToolName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.eat();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (leftToolName) &#123;</span><br><span class="line">            System.out.println(name + <span class="string">" take up "</span> + leftToolName + <span class="string">" ( left )."</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (rightToolName) &#123;</span><br><span class="line">                System.out.println(name + <span class="string">" take up "</span> + rightToolName + <span class="string">" ( right )."</span>);</span><br><span class="line">                System.out.println(name + <span class="string">" is eating now."</span>);</span><br><span class="line">                System.out.println(name + <span class="string">" put down "</span> + rightToolName + <span class="string">" ( right )."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(name + <span class="string">" put down "</span> + leftToolName + <span class="string">" ( left )."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Tableware fork = <span class="keyword">new</span> Tableware(<span class="string">"fork"</span>);</span><br><span class="line">        Tableware knife = <span class="keyword">new</span> Tableware(<span class="string">"knife"</span>);</span><br><span class="line">        <span class="keyword">new</span> EatNoodleThread(<span class="string">"A"</span>, fork,  knife).start();</span><br><span class="line">        <span class="keyword">new</span> EatNoodleThread(<span class="string">"B"</span>, knife, fork).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以发现A手持叉要去获取刀，而此时B手持刀想要去获取叉，这样导致线程陷入阻塞，出现了死锁。主要还是交叉锁导致了两个线程间的相互等待彼此释放持有的锁。</p><h3 id="解决死锁问题"><a href="#解决死锁问题" class="headerlink" title="解决死锁问题"></a>解决死锁问题</h3><p>&emsp;&emsp;封装一下左右手使用的工具,避免使用交叉锁，这样只能在同一时刻仅有一个线程获取到刀和叉。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TablewarePair</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tableware leftWare;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tableware rightWare;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TablewarePair</span><span class="params">(Tableware leftWare, Tableware rightWare)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.leftWare = leftWare;</span><br><span class="line">        <span class="keyword">this</span>.rightWare = rightWare;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Tableware <span class="title">getLeftWare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> leftWare;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Tableware <span class="title">getRightWare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> rightWare;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EatNoodleThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TablewarePair tablewarePair;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EatNoodleThread</span><span class="params">(String name, TablewarePair tablewarePair)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.tablewarePair = tablewarePair;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.eat();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (tablewarePair) &#123;</span><br><span class="line">            System.out.println(name + <span class="string">" take up "</span> + tablewarePair.getLeftWare() + <span class="string">" ( left )."</span>);</span><br><span class="line">            System.out.println(name + <span class="string">" take up "</span> + tablewarePair.getRightWare() + <span class="string">" ( right )."</span>);</span><br><span class="line">            System.out.println(name + <span class="string">" is eating now."</span>);</span><br><span class="line">            System.out.println(name + <span class="string">" put down "</span> + tablewarePair.getRightWare() + <span class="string">" ( right )."</span>);</span><br><span class="line">            System.out.println(name + <span class="string">" put down "</span> + tablewarePair.getLeftWare() + <span class="string">" ( left )."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Tableware fork = <span class="keyword">new</span> Tableware(<span class="string">"fork"</span>);</span><br><span class="line">        Tableware knife = <span class="keyword">new</span> Tableware(<span class="string">"knife"</span>);</span><br><span class="line">        <span class="keyword">new</span> EatNoodleThread(<span class="string">"A"</span>, <span class="keyword">new</span> TablewarePair(fork,knife)).start();</span><br><span class="line">        <span class="keyword">new</span> EatNoodleThread(<span class="string">"B"</span>, <span class="keyword">new</span> TablewarePair(knife,fork)).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-11-观察者模式</title>
      <link href="/2020/06/05/7740/hub/"/>
      <url>/2020/06/05/7740/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200605223557127.png" alt="image-20200605223557127"></p><p>&emsp;&emsp;当某个对象发生状态改变需要通知第三方时，观察者模式就特别适合这样的工作。观察者模式需要有事件源，也就是引发状态发生改变的源头，很明显Thread负责执行的逻辑单元，它最清楚整个过程的始末周期。而事件的接收者则是通知接受者一方，严格意义上的观察者模式是需要Observer集合的。</p><h2 id="观察者与线程Thread的奇遇"><a href="#观察者与线程Thread的奇遇" class="headerlink" title="观察者与线程Thread的奇遇"></a>观察者与线程Thread的奇遇</h2><h3 id="Observer接口定义"><a href="#Observer接口定义" class="headerlink" title="Observer接口定义"></a>Observer接口定义</h3><p>&emsp;&emsp;主要是提供给调用者使用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//枚举</span></span><br><span class="line">    <span class="keyword">enum</span> Cycle &#123;</span><br><span class="line">        STARTED,RUNNING,DONE,ERROR</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前任务生命周期状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Cycle <span class="title">getCycle</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打断线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TaskLifecycle接口定义"><a href="#TaskLifecycle接口定义" class="headerlink" title="TaskLifecycle接口定义"></a>TaskLifecycle接口定义</h3><p>&emsp;&emsp;主要定义了在任务执行时期可能被触发的接口。EmptyLifecycle主要是一个空的实现，保留使用者对Thread的使用习惯。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskLifecycle</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动时触发</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Thread thread)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 运行时触发</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onRunning</span><span class="params">(Thread thread)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 运行结束时触发</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onFinish</span><span class="params">(Thread thread,T result)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务发生异常触发</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Thread thread,Exception e)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 空实现</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">EmptyLifecycle</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">TaskLifecycle</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Thread thread)</span> </span>&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRunning</span><span class="params">(Thread thread)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFinish</span><span class="params">(Thread thread, T result)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Thread thread, Exception e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Task函数接口定义"><a href="#Task函数接口定义" class="headerlink" title="Task函数接口定义"></a>Task函数接口定义</h3><p>&emsp;&emsp;需要对线程中的任务增加可观察的能力，并且需要获得最后的计算结果，所以把Runnable接口取代为Task接口。主要用于承载任务执行单元。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Task</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务执行接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">T <span class="title">call</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200606160853316.png" alt="image-20200606160853316"></p><h3 id="ObserverThread实现"><a href="#ObserverThread实现" class="headerlink" title="ObserverThread实现"></a>ObserverThread实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverThread</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Thread</span> <span class="keyword">implements</span> <span class="title">Observer</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TaskLifecycle&lt;T&gt; lifecycle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务执行单元</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Task&lt;T&gt; task;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前执行状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Cycle cycle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lifecycle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObserverThread</span><span class="params">(TaskLifecycle&lt;T&gt; lifecycle,Task&lt;T&gt; task)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The task is required."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.lifecycle = lifecycle;</span><br><span class="line">        <span class="keyword">this</span>.task = task;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认实现</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObserverThread</span><span class="params">(Task&lt;T&gt; task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> TaskLifecycle.EmptyLifecycle&lt;&gt;(),task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态更新</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cycle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> result</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Cycle cycle, T result, Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cycle = cycle;</span><br><span class="line">        <span class="keyword">if</span> (lifecycle == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread currentThread = Thread.currentThread();</span><br><span class="line">            <span class="keyword">switch</span> (cycle) &#123;</span><br><span class="line">                <span class="keyword">case</span> STARTED:</span><br><span class="line">                    <span class="keyword">this</span>.lifecycle.onStart(currentThread);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RUNNING:</span><br><span class="line">                    <span class="keyword">this</span>.lifecycle.onRunning(currentThread);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DONE:</span><br><span class="line">                    <span class="keyword">this</span>.lifecycle.onFinish(currentThread,result);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ERROR:</span><br><span class="line">                    <span class="keyword">this</span>.lifecycle.onError(currentThread,e);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cycle == Cycle.ERROR) &#123;</span><br><span class="line">                <span class="keyword">throw</span> exception;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//开始执行</span></span><br><span class="line">        <span class="keyword">this</span>.update(Cycle.STARTED, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//运行中</span></span><br><span class="line">            <span class="keyword">this</span>.update(Cycle.RUNNING, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            T result = <span class="keyword">this</span>.task.call();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//执行结束</span></span><br><span class="line">            <span class="keyword">this</span>.update(Cycle.DONE, result, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//执行出错</span></span><br><span class="line">            <span class="keyword">this</span>.update(Cycle.DONE, <span class="keyword">null</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cycle <span class="title">getCycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cycle;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;重写了Thread的run方法，并且声明该方法为final类型，不允许子类再次重写，run方法在线程运行期间，可以监控任务在执行过程中各个生命周期截断，任务每经过一个阶段相当于发生了一次事件。</p><h3 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> TaskLifecycle&lt;String&gt; lifecycle = <span class="keyword">new</span> TaskLifecycle.EmptyLifecycle&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(Thread thread)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"The thread is start."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRunning</span><span class="params">(Thread thread)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"The thread is running."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFinish</span><span class="params">(Thread thread, String result)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"The thread is finish and result = "</span> + result + <span class="string">" ."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Thread thread, Exception e)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"The thread is error ."</span>);</span><br><span class="line">                System.out.println(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> ObserverThread&lt;&gt;(lifecycle, () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Hello Observer"</span>;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;ObserverThread本身的run方法充当了事件源的发起者，而TaskLifecycle则扮演了事件回调的响应者。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-10-单例模式与扩展</title>
      <link href="/2020/06/05/61297/hub/"/>
      <url>/2020/06/05/61297/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200605211833544.png" alt="image-20200605211833544"></p><h2 id="饿汉式"><a href="#饿汉式" class="headerlink" title="饿汉式"></a>饿汉式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * static静态初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">new</span> Singleton();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;饿汉式的关键在于instance作为类变量直接得到了初始化，也就是再多线程的情况下不会实例化多次。但是instance被ClassLoader加载后可能很长一段时间才会被使用，这样也就意味着instance所开辟的堆内存空间会驻留更长的时间。虽然保证了多个线程下的唯一示例，getInstance方法性能也比较高，但是也导致了无法进行懒加载。</p><h2 id="懒汉式"><a href="#懒汉式" class="headerlink" title="懒汉式"></a>懒汉式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * static静态初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/image/hexo/image-20200605215418689.png" alt="image-20200605215418689"></p><p>&emsp;&emsp;懒汉式就是在使用的时候才去创建，这样可以避免提前创建，但是也会导致一些问题。该模式在单线程情况下是没有问题的，但是在多线程情况下就不一定了。如果有多个线程判断到了instance == null，由于多线程导致CPU的调度，可能会多次实例化instance，这样就不能保证单例的唯一性。</p><h2 id="懒汉式-同步方法"><a href="#懒汉式-同步方法" class="headerlink" title="懒汉式+同步方法"></a>懒汉式+同步方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取实例</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;针对懒汉式，最直接的方式就是getInstance方法使用关键字synchronized修饰，保证在同一时刻只有一个线程能够访问，但是所带来的问题也是无法避免的，极大程度上降低了程序的性能。</p><h2 id="Double-Check"><a href="#Double-Check" class="headerlink" title="Double-Check"></a>Double-Check</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * static静态初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    Connection connection;</span><br><span class="line"></span><br><span class="line">    Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.socket = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果有多个线程进入第一个判断instance == null，由于同步代码块，只能有一个线程在同一时刻去执行实例化操作，但是第二个线程在抢到锁后，由于第一个线程已经完成了初始化，所以这个时候还需要判断一次instance == null,非常巧妙的解决了懒加载与instance实例的唯一性。但是也会带来一定的问题，在多线程的情况下还是可能引起空指针异常。</p><p><img src="/image/hexo/image-20200605220457628.png" alt="image-20200605220457628"></p><p>&emsp;&emsp;可能Singleton()实例化方法内部含有了比较多的操作，由于JVM运行时的指令重排序以及happens-before原则，极有可能instance先完成了实例化操作，但是内部的操作还没有执行完成，这样导致下一个线程直接会拿着instance使用，由于某些操作没有实例化完成，可能会导致空指针异常。</p><h2 id="Volatile-Double-Check"><a href="#Volatile-Double-Check" class="headerlink" title="Volatile+Double-Check"></a>Volatile+Double-Check</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * static静态初始化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton instance = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;Double-Check的方式出现问题的原因主要是指令重排序，而采用volatile关键字修饰，禁止了指令重排序的发生，那么即可实现懒加载以及高性能的单例模式。</p><h2 id="Holder"><a href="#Holder" class="headerlink" title="Holder"></a>Holder</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态内部类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Holder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;Singleton中并没有instance的静态成员，而是放入了静态内部类Holder中，因此Singleton类的初始化过程并不会创建Singleton实例，Holder类中定义的Singleton的静态变量，直接得到了初始化，当Holder被主动引用的时候才会去创建Singleton实例。它是单例设计模式最好的实现方式之一，也是使用比较广泛的方式。</p><h2 id="枚举方式"><a href="#枚举方式" class="headerlink" title="枚举方式"></a>枚举方式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span>  Singleton &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * static静态初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Singleton()&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;由于枚举的特殊性，本身就是不可继承，同样是线程安全的且只能实例化一次，但是不能够实现懒加载，但是也可以使用类似Holder的方式实现懒加载。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * static静态初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> EnumHolder&#123;</span><br><span class="line">        INSTANCE;</span><br><span class="line">        <span class="keyword">private</span> Singleton singleton;</span><br><span class="line"></span><br><span class="line">        EnumHolder() &#123;</span><br><span class="line">            <span class="keyword">this</span>.singleton = <span class="keyword">new</span> Singleton();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EnumHolder.INSTANCE.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程进阶-09-volatile关键字介绍与深入</title>
      <link href="/2020/06/04/31866/hub/"/>
      <url>/2020/06/04/31866/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200604173028965.png" alt="image-20200604173028965"></p><h2 id="volatile关键字解决的问题"><a href="#volatile关键字解决的问题" class="headerlink" title="volatile关键字解决的问题"></a>volatile关键字解决的问题</h2><p>&emsp;&emsp;只能修饰类变量和实例变量，对于方法参数、局部变量以及实例常量，类常量都不能进行修饰。</p><h3 id="CPU缓存一致性问题"><a href="#CPU缓存一致性问题" class="headerlink" title="CPU缓存一致性问题"></a>CPU缓存一致性问题</h3><h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><p>&emsp;&emsp;在计算机中，所有的运算都是依靠CPU的寄存器完成的。CPU指令的执行过程需要涉及数据的读取与写入操作，CPU所访问的所有数据只能是计算机的主存（一般指RAM），虽然CPU的发展频率不断得到提升，但是受制于制造工艺以及成本的限制，计算机的内存反倒在访问速度上没有多大的突破。因此，CPU的处理速度和内存的访问速度差距越来越大，通常这种差距可以达到上千倍，极端情况下可以达到上万倍。</p><h4 id="CPU-cache模型"><a href="#CPU-cache模型" class="headerlink" title="CPU cache模型"></a>CPU cache模型</h4><p>&emsp;&emsp;在这种差距的情况下，大大降低了CPU整体的吞吐量，于是有了在CPU和主内存之间增加缓存的设计。Cache的出现是为了解决CPU直接访问内存导致效率低下的问题，程序在运行过程中，会将运算所需要的数据从主内存复制一份到CPU Cache中，这样CPU可以直接对Cache进行操作，当运算结束以后再将最新的数据刷新到主内存中，这样通过Cache的方式大大的提高了吞吐能力。</p><p><img src="/image/hexo/image-20200604174337130.png" alt="image-20200604174337130"></p><h4 id="缓存一致性问题"><a href="#缓存一致性问题" class="headerlink" title="缓存一致性问题"></a>缓存一致性问题</h4><p>&emsp;&emsp;由于缓存机制的出现，极大程度的提高了CPU的吞吐能力，但是也会带来缓存不一致的问题。比如i++的操作，在程序运行的过程中。首先，需要将主内存中的数据复制一份存放到CPU Cache中，那么CPU寄存器在进行数值计算的时候就直接到Cache中读取与写入，当整个过程运算结束以后再将Cache中的数据刷新到主内存中。</p><p>&emsp;1.读取主内存的i到CPU Cache中。</p><p>&emsp;2.对i进行加一操作。</p><p>&emsp;3.将数据结果写入Cache中。</p><p>&emsp;4.将数据从Cache刷新到主内存中。</p><p>&emsp;i++在单线程中是不会有任何问题的，如果在多线程的情况下，每个线程都有自己的工作内存，变量i会在多个线程的本地内存中都会存在一个副本。如果有多个线程同时进行i++操作，那么每个线程操作完以后都会将自己的结果刷新到主内存，但是每一个线程操作的最终结果可能不一致，那么就会出现典型的缓存不一致的问题。</p><p>&emsp;&emsp;为了避免这种情况，主流的解决方案主要是：1.通过总线加锁的方式，2.通过缓存一致性协议。</p><h5 id="数据总线加锁"><a href="#数据总线加锁" class="headerlink" title="数据总线加锁"></a>数据总线加锁</h5><p><img src="/image/hexo/image-20200604175316826.png" alt="image-20200604175316826"></p><p>&emsp;&emsp;这种方式主要在早期的CPU中，是一种悲观的实现方式，CPU和其他组件都是通过总线进行的，如果采用总线加锁的方式，会阻塞其他CPU的运行，仅有一个CPU能够抢到总线锁，这种方式能够解决缓存的问题，但是也导致了效率低效的问题。</p><h5 id="缓存一致性协议"><a href="#缓存一致性协议" class="headerlink" title="缓存一致性协议"></a>缓存一致性协议</h5><p>&emsp;&emsp;在缓存一致性协议中最为出名的是Intel的MESI协议，MESI协议保证了每一个缓存中使用的共享变量副本都是一致的。当CPU操作了Cache中的数据时，如果发现该变量是一个共享变量，那么：</p><p>&emsp;&emsp;1.读取操作，不做任何处理，只是将Cache中的数据读取到寄存器。</p><p>&emsp;&emsp;2.写入操作，发出信号通知其他CPU将该变量的Cache line设置为无效状态，其他CPU在进行读取该变量的时候不得不到主内存中再次获取。</p><h3 id="Java内存模型"><a href="#Java内存模型" class="headerlink" title="Java内存模型"></a>Java内存模型</h3><p><img src="/image/hexo/image-20200604202041341.png" alt="image-20200604202041341"></p><p>&emsp;&emsp;Java内存模型（Java Memory Mode，JMM）指定了Java虚拟机如何与计算机的主内存进行工作。Java的内存模型决定了一个线程对共享变量的写入何时对其他线程可见，Java内存模型定义了线程和主内存之间的抽线关系。</p><p>&emsp;&emsp;1.共享变量储存于主内存中，每个线程都可以访问。</p><p>&emsp;&emsp;2.每个线程都有私有的工作内存或者称为本地内存。</p><p>&emsp;&emsp;3.工作内存值存储该线程对共享变量的副本。</p><p>&emsp;&emsp;4.线程不能直接操作主内存，只有先操作了工作内存后才能写入主内存。</p><p>&emsp;&emsp;5.工作内存和Java内存模型一样，也是一个抽象的概念，它其实并不存在，它涵盖了缓存，寄存器，编译器优化以及硬件等。</p><p><img src="/image/hexo/image-20200604204310907.png" alt="image-20200604204310907"></p><h2 id="并发编程的几大特性"><a href="#并发编程的几大特性" class="headerlink" title="并发编程的几大特性"></a>并发编程的几大特性</h2><h3 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h3><p>&emsp;&emsp;指在一次操作或者多次操作中，要么所有的操作全部得到了执行并且不会受到任何因素的干扰而中断，要么所有的操作都不执行。两个原子性的操作结合在一起未必还是原子性的操作，volatile关键字并没有保证数据的原子性而是有synchronized关键字保证的，从JDK1.5开始，提供了原子类型的变量也可以保证原子性。</p><h3 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h3><p>&emsp;&emsp;当前线程对共享变量进行了修改，那么另外的线程可以立即看到修改后的结果。</p><h3 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h3><p>&emsp;&emsp;指在程序代码执行过程中的先后顺序，由于Java在编译以及运行时期做了一些优化，导致代码的执行顺序未必是原始代码的顺序。</p><p>&emsp;&emsp;Java会在运行期间发生指令重排序，导致最终代码的执行顺序可能与原始编写的代码不一致，但是会保证最终结果的一致，这也就是俗称的：最终一致性。</p><h3 id="JMM怎么保证三大特性"><a href="#JMM怎么保证三大特性" class="headerlink" title="JMM怎么保证三大特性"></a>JMM怎么保证三大特性</h3><p>&emsp;&emsp;Java内存模型规定了所有的变量都是存在于主内存当中的，而每个线程都有自己的工作内存，线程对变量的所有操作都必须在自己的工作内存中进行，而不能直接操作主内存，并且每一个线程不能访问其他线程工作内存。</p><h4 id="JMM与原子性"><a href="#JMM与原子性" class="headerlink" title="JMM与原子性"></a>JMM与原子性</h4><p>&emsp;&emsp;1.多个原子性的操作结合在一起就不再是原子性操作了。</p><p>&emsp;&emsp;2.简单的读取与赋值操作都是原子性操作，将一个变量赋值给另一个变量将不再是原子性操作。</p><p>&emsp;&emsp;3.Java内存模型仅仅保证了基本的读取与赋值为原子性操作，其余的操作想要具备原子性，则需要synchronized关键字去实现，或者JUC里面的lock。如果想使int等类型自增操作具备原子性，则可以使用JUC包下的原子封装类型。</p><h4 id="JMM与可见性"><a href="#JMM与可见性" class="headerlink" title="JMM与可见性"></a>JMM与可见性</h4><p>&emsp;&emsp;在多线程的环境下，如果某个线程首次读取共享变量，则首先到主内存中获取放入自己的工作内存中，然后后续的操作在工作线程中完成，最后操作结束后再次写入主内存。但是什么时候刷新这个最终结果到主内存中的时机是不确定的。</p><p>&emsp;&emsp;1.使用关键字volatile。当一个变量被volatile修饰的时候，对于共享资源的读取会直接在主内存中进行（也会缓存到工作内存），当其他线程对该共享资源进行了修改，会导致当前工作线程的缓存失效，必须再次到主内存获取再次放入工作内存。对于共享资源的写操作是需要先修改工作内存，随后立即刷新到主内存。对于共享资源的操作会时刻保持与主内存的数据一致。因为被volatile关键字修饰的变量，如果某个线程对其进行了更改，它就会立马进行一次工作内存刷新同步至主内存的操作；同理，如果某个线程读取volatile关键字修饰的变量，那么该线程返回自己工作内存中的变量时，每次都会被要求从主内存再同步一次到工作内存中。</p><p>&emsp;&emsp;2.通过关键字synchronized，它保证在同一时刻仅有一个线程获取到锁，然后执行同步方法，并且还会确保在释放锁之前，会将对变量的修改刷新到主内存。</p><p>&emsp;&emsp;3.通过JUC提供的显式锁Lock也可以保证内存的可见性。</p><h4 id="JMM与有序性"><a href="#JMM与有序性" class="headerlink" title="JMM与有序性"></a>JMM与有序性</h4><p>&emsp;&emsp;在Java内存模型运行编译器和处理器对指令进行重排序，在单线程情况下并不会出现什么问题。但是在多线程的情况下，重排序可能会影响到程序的正常的运行。</p><p>&emsp;&emsp;1.使用volatile关键字保证有序性。</p><p>&emsp;&emsp;2.使用synchronized关键字保证有序性。</p><p>&emsp;&emsp;3.使用显式锁Lock保证有序性。</p><p>&emsp;&emsp;后两者采用了同步机制，同步代码在执行的过程中与在单线程下执行一致，也就能够保证了有序性（最终结果的顺序）。</p><h4 id="happens-before原则"><a href="#happens-before原则" class="headerlink" title="happens-before原则"></a>happens-before原则</h4><p>&emsp;&emsp;1.程序次序原则：在一个线程内，代码按照编写的次序执行，编写在后面的操作要发生在编写在前面的操作之后（似乎有点废话）。</p><p>&emsp;&emsp;2.锁定规则：一个unlock的操作要先行发生于对同一个锁的lock操作。无论在单线程还是多线程的情况下，如果同一个锁是锁定状态，那么必须先对它进行释放锁操作才能继续进行lock操作。</p><p>&emsp;&emsp;3.volatile原则：对一个变量的写操作要早于对这个变量的读操作。一个线程对它进行读操作，另一个线程对它进行写操作，那么写入操作肯定要先行发生于读操作。</p><p>&emsp;&emsp;4.传递原则：如果操作A先于B，而操作B又先于操作C。那么操作A肯定要先于操作C。</p><p>&emsp;&emsp;5.线程启动规则：Thread对象的start()方法先行发生于对线程的任何操作。</p><p>&emsp;&emsp;6.线程中断原则：对象线程进行打断（interrupt）要优先于捕获到中断信号。</p><p>&emsp;&emsp;7.线程终结原则：线程中所有的操作都要先行发生于线程的终止操作。</p><p>&emsp;&emsp;8.对象的终结原则：一个对象的初始化完成先行发生于finalize（）方法之前。</p><h2 id="volatile关键字深入"><a href="#volatile关键字深入" class="headerlink" title="volatile关键字深入"></a>volatile关键字深入</h2><h3 id="volatile的语义"><a href="#volatile的语义" class="headerlink" title="volatile的语义"></a>volatile的语义</h3><p>&emsp;&emsp;1.保证了不同线程间的共享变量的内存可见性，如果一个线程修改了volatile修饰的共享变量，那么另一个线程可以马上看到修改之后的结果。</p><p>&emsp;&emsp;2.禁止对指令进行重排序操作。</p><p>&emsp;&emsp;3.读操作后：插入<strong>LoadLoad</strong>屏障(禁止后面所有普通读和上面<strong>volatile</strong>读重排序)，插入<strong>LoadStore</strong>屏障（静止后面普通写和上面<strong>volatile</strong>读重排序）</p><p>&emsp;&emsp;4.写操作前：插入<strong>StoreStore</strong>屏障（保证<strong>volatile</strong>写之前，其前面所有的普通写已经对任意处理器可见）</p><p>&emsp;&emsp;5.写操作后：插入<strong>StoreLoad</strong>屏障（避免<strong>volatile</strong>写后面可能有<strong>volatile</strong>读写操作重排序）</p><h3 id="原理与实现机制"><a href="#原理与实现机制" class="headerlink" title="原理与实现机制"></a>原理与实现机制</h3><p>&emsp;&emsp;其实使用volatile修饰的变量，存在了一个lock；的前缀。相当于一个内存屏障，该屏障可以提供以下几个保障。</p><p>&emsp;&emsp;1.确保指令重排序不会将其后面的代码排到内存屏障之前。</p><p>&emsp;&emsp;2.确保指令重排序不会将其前面的代码排到内存屏障之后。</p><p>&emsp;&emsp;3.确保在执行到内存屏障修饰的指令时前面的代码全部执行完成。</p><p>&emsp;&emsp;4.强制将线程工作内存中的值刷新到主内存。</p><p>&emsp;&emsp;5.如果是写操作，则会导致其他线程的工作内存中的缓存数据失效。</p><h2 id="volatile与synchronized"><a href="#volatile与synchronized" class="headerlink" title="volatile与synchronized"></a>volatile与synchronized</h2><h3 id="使用区别"><a href="#使用区别" class="headerlink" title="使用区别"></a>使用区别</h3><p>&emsp;&emsp;1.volatile关键字只能修饰实例变量或类变量，不能修饰方法以及方法参数、局部变量、常量等。</p><p>&emsp;&emsp;2.volatile关键字修饰的变量可以为null,synchronized关键字同步代码块的monitor对象不能为null。</p><p>&emsp;&emsp;3.synchronized关键字不能对于变量修饰，只能用于修饰方法或者语句代码块。</p><h3 id="对原子性的保证"><a href="#对原子性的保证" class="headerlink" title="对原子性的保证"></a>对原子性的保证</h3><p>&emsp;&emsp;1.volatile无法保证原子性。</p><p>&emsp;&emsp;2.synchronized关键字是一种排他机制，因此它所修饰的代码块是无法打断的，故此能够保证带代码的原子性。</p><h3 id="对可见性的保证"><a href="#对可见性的保证" class="headerlink" title="对可见性的保证"></a>对可见性的保证</h3><p>&emsp;&emsp;1.两者都可以保证共享资源在多线程之间的可见性，但是实现机制却完全不同。</p><p>&emsp;&emsp;2.synchronized借助JCM指令monitor enter与monitor exit通过排他的形式使得代码实现了串行化，在monitor exit时会将所有的共享资源刷新到主内存。</p><p>&emsp;&emsp;3.相比较于synchronized关键字，volatile关键字使用机器指令lock;的方式迫使其他线程的工作内存的缓存强制失效，不得已到主内存再次读取数据。</p><h3 id="对有序性的保证"><a href="#对有序性的保证" class="headerlink" title="对有序性的保证"></a>对有序性的保证</h3><p>&emsp;&emsp;1.volatile关键字静止JVM编译器以及处理器对其进行重排序操作，故此能够保证代码的有序性。</p><p>&emsp;&emsp;2.synchronized关键字修饰的代码也可以保证顺序性芒担石这种顺序性是通过同步代码串行化所换来的，在同步代码中的代码也会发现重排序操作。</p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>&emsp;&emsp;volatile不会使线程陷入阻塞状态，而synchronized关键字由于串行化操作会导致线程陷入阻塞状态。</p><h2 id="Lock指令"><a href="#Lock指令" class="headerlink" title="Lock指令"></a>Lock指令</h2><p>&emsp;&emsp;Lock指令前缀会进行数据总线加锁，阻止其他的处理器接管总线去访问内存，知道Lock前缀的指令执行结束，那么这样会导致该指令的执行变为原子性操作。若是进行了写操作，则会发出<strong>RFO</strong>指令，使缓存中的数据遵守缓存一致性协议，从而达到可见性。</p><h2 id="内存屏障"><a href="#内存屏障" class="headerlink" title="内存屏障"></a>内存屏障</h2><p>&emsp;&emsp;1.存在的原因：主要是因为<strong>mov</strong>指令在CPU级别是原子性操作，但是这个操作是存在于缓存之中的。</p><p>&emsp;&emsp;2.CPU的关系：CPU-&gt;寄存器-&gt;缓存-&gt;内存。其中CPU只与寄存器进行存取操作。</p><p>&emsp;&emsp;3.寄存器：临时存放数据，并不是每次都从内存中获取，而是从缓存中获取，仅仅是一个临时存放数据的空间。</p><p>&emsp;&emsp;4.在<strong>mov</strong>指令中，寄存器会从缓存中获取值，例如进行了<strong>+1</strong>的操作，然后又存放进了缓存。在这个时间段内，并没有和内存产生交互，所以会加上一层内存屏障。</p><p>&emsp;&emsp;5.内存屏障：由于CPU为了在一定程度上提升性能会将无关内存的操作进行乱序化处理，那么在多核CPU间或者在CPU与IO设备间的交互时会产生问题。它主要是为了解决这一系列问题而产生的，其实它是一类同步屏障指令，是CPU或者编译器在对内存的随机访问的操作中的一个同步点，这样可以时在此同步点之前的所有的读写操作都执行完毕后才开始执行该点以后的操作。</p><p>&emsp;&emsp;6.那么内存屏障主要就是保证所有的写的操作都进入到内存，内存屏障以后的操作都能获取内存屏障之前写操作的结果。从而保证了可见性，并且禁止了重排序。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程基础-08-线程池原理以及自定义线程池</title>
      <link href="/2020/05/26/16504/hub/"/>
      <url>/2020/05/26/16504/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200526214756699.png" alt="image-20200526214756699"></p><h2 id="线程池原理"><a href="#线程池原理" class="headerlink" title="线程池原理"></a>线程池原理</h2><p>&emsp;&emsp;所谓线程池，通俗来讲就是有一个池子，里面存放了已经创建好的线程。当有任务提交给线程池时，就会从线程池中拿出线程去执行任务。当线程池中的线程不足以满足任务提交时，则需要自动扩充新的线程加入到池子中，但是线程数量肯定是有限的，并不能进行无限的扩充。若是提交的任务变得越少时，线程池中的线程可以自动进行回收，释放资源，为了能够异步的提交任务和缓存未被执行的任务，则需要一个任务队列。</p><p>&emsp;&emsp;一个完整的线程池应该具有以下的要素：</p><p>&emsp;&emsp;1.任务队列：用于缓存提交的任务，需要有数量限制，防止内存溢出。</p><p>&emsp;&emsp;2.线程数量管理功能：最大线程数量max，最小线程数量min,核心线程数量core。</p><p>&emsp;&emsp;3.任务拒绝策略：如果线程达到了最大线程并且任务队列已满，则需要有相应的策略去拒绝提交新的任务加入线程池。</p><p>&emsp;&emsp;4.线程工厂：主要用于个性化定制线程。</p><p>&emsp;&emsp;5.Keepedalive：主要决定线程各个重要参数的自动维护时间的间隔。</p><h2 id="线程池实现"><a href="#线程池实现" class="headerlink" title="线程池实现"></a>线程池实现</h2><h3 id="线程池接口定义"><a href="#线程池接口定义" class="headerlink" title="线程池接口定义"></a>线程池接口定义</h3><h4 id="ThreadPool接口"><a href="#ThreadPool接口" class="headerlink" title="ThreadPool接口"></a>ThreadPool接口</h4><p>&emsp;&emsp;主要定义一个线程池应该具备的基本操作。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ThreadPool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> runnable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable runnable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线程池的初始化大小</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getInitSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线程池最大的线程数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMaxSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线程池核心线程数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getCoreSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线程池中缓存队列大小</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getQueueSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线程池中活跃的线程数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getActiveCount</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看线程池是否已经被shutdown</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isShutdown</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="RunnableQueue任务队列"><a href="#RunnableQueue任务队列" class="headerlink" title="RunnableQueue任务队列"></a>RunnableQueue任务队列</h4><p>&emsp;&emsp;主要用于存放提交的任务队列，并且有数量限制。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RunnableQueue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加入任务队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> runnable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">offer</span><span class="params">(Runnable runnable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工作线程通过take方式获取任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Runnable <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取任务队列的大小</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ThreadFactory工厂"><a href="#ThreadFactory工厂" class="headerlink" title="ThreadFactory工厂"></a>ThreadFactory工厂</h4><p>&emsp;&emsp;主要提供创建线程的方法，便于个性化定制Thread。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ThreadFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建线程</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> runnable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Thread <span class="title">createThread</span><span class="params">(Runnable runnable)</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="DenyPolicy策略"><a href="#DenyPolicy策略" class="headerlink" title="DenyPolicy策略"></a>DenyPolicy策略</h4><p>&emsp;&emsp;主要用于任务队列达到了上限以后执行何种策略通知提交者。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DenyPolicy</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reject</span><span class="params">(Runnable runnable,ThreadPool threadPool)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 直接丢弃任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DiscardDenyPolicy</span> <span class="keyword">implements</span> <span class="title">DenyPolicy</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reject</span><span class="params">(Runnable runnable, ThreadPool threadPool)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抛出异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbortDenyPolicy</span> <span class="keyword">implements</span> <span class="title">DenyPolicy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reject</span><span class="params">(Runnable runnable, ThreadPool threadPool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RunnableDenyException(<span class="string">"The runnable "</span> + runnable + <span class="string">" will be abort."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在提交者所在线程执行任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RunnerDenyPolicy</span> <span class="keyword">implements</span> <span class="title">DenyPolicy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reject</span><span class="params">(Runnable runnable, ThreadPool threadPool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!threadPool.isShutdown())&#123;</span><br><span class="line">            runnable.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RunnableDenyException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RunnableDenyException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="InternalTask"><a href="#InternalTask" class="headerlink" title="InternalTask"></a>InternalTask</h4><p>&emsp;&emsp;主要用于线程池内部，不断的从任务队列中获取Runnable并且执行任务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RunnableQueue runnableQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> running = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InternalTask</span><span class="params">(RunnableQueue runnableQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.runnableQueue = runnableQueue;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//当前任务running并且没有被打断将获取take执行任务</span></span><br><span class="line">        <span class="keyword">while</span> (running &amp;&amp; !Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">           <span class="keyword">try</span>&#123;</span><br><span class="line">               Runnable take = runnableQueue.take();</span><br><span class="line">               take.run();</span><br><span class="line">           &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">               running = <span class="keyword">false</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止当前任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.running = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="线程池详细实现"><a href="#线程池详细实现" class="headerlink" title="线程池详细实现"></a>线程池详细实现</h3><h4 id="LinkedRunnableQueue"><a href="#LinkedRunnableQueue" class="headerlink" title="LinkedRunnableQueue"></a>LinkedRunnableQueue</h4><p>&emsp;&emsp;任务队列接口实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedRunnableQueue</span> <span class="keyword">implements</span> <span class="title">RunnableQueue</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务队列最大数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> limit;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务队列达到上限执行的拒绝策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DenyPolicy denyPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存放任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;Runnable&gt; runnableList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPool threadPool;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LinkedRunnableQueue</span><span class="params">(<span class="keyword">int</span> limit, DenyPolicy denyPolicy, ThreadPool threadPool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.limit = limit;</span><br><span class="line">        <span class="keyword">this</span>.denyPolicy = denyPolicy;</span><br><span class="line">        <span class="keyword">this</span>.threadPool = threadPool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">offer</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//runnableList上锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (runnableList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (runnableList.size() &gt;= limit) &#123;</span><br><span class="line">                <span class="comment">//执行拒绝策略</span></span><br><span class="line">                denyPolicy.reject(runnable,threadPool);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//加入末尾，唤醒阻塞的线程</span></span><br><span class="line">                runnableList.addLast(runnable);</span><br><span class="line">                runnableList.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Runnable <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (runnableList) &#123;</span><br><span class="line">            <span class="keyword">while</span> (runnableList.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">//没有任务可以执行，挂起当前线程，进入runnableList的monitor关联的wait set等待唤醒</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    runnableList.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//从头部获取一个任务</span></span><br><span class="line">            <span class="keyword">return</span> runnableList.removeFirst();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (runnableList) &#123;</span><br><span class="line">            <span class="keyword">return</span> runnableList.size();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="工作线程"><a href="#工作线程" class="headerlink" title="工作线程"></a>工作线程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTask</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InternalTask internalTask;    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadTask</span><span class="params">(Thread thread, InternalTask internalTask)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.thread = thread;</span><br><span class="line">        <span class="keyword">this</span>.internalTask = internalTask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="默认线程工程"><a href="#默认线程工程" class="headerlink" title="默认线程工程"></a>默认线程工程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger GROUP_COUNTER = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadGroup group = <span class="keyword">new</span> ThreadGroup(<span class="string">"MyThreadPoll-"</span> + GROUP_COUNTER.getAndDecrement());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger COUNTER = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Thread <span class="title">createThread</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Thread(group, runnable, <span class="string">"thread-pool_"</span> + COUNTER.getAndDecrement());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="初始化线程池"><a href="#初始化线程池" class="headerlink" title="初始化线程池"></a>初始化线程池</h4><p>&emsp;&emsp;一般拥有数量控制属性、创建线程工程、任务队列、拒绝策略等功能。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicThreadPool</span> <span class="keyword">extends</span> <span class="title">Thread</span> <span class="keyword">implements</span> <span class="title">ThreadPool</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化线程数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> initSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池最大线程数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池最小线程数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> minSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池核心线程数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> coreSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前活跃线程数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> activeCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程工厂</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadFactory threadFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RunnableQueue runnableQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池是否被shutdown</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isShutdown = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工作线程队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;ThreadTask&gt; threadTaskQueue = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认拒绝策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DenyPolicy DEFAULT_DENY_POLICY = <span class="keyword">new</span> DiscardDenyPolicy();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认线程工程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadFactory DEFAULT_FACTORY = <span class="keyword">new</span> DefaultThreadFactory();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> keepAliveTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TimeUnit timeUnit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BasicThreadPool</span><span class="params">(<span class="keyword">int</span> initSize, <span class="keyword">int</span> maxSize, <span class="keyword">int</span> minSize,<span class="keyword">int</span> coreSize, <span class="keyword">int</span> queueSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(initSize,minSize,maxSize,coreSize,DEFAULT_DENY_POLICY,queueSize,DEFAULT_FACTORY,<span class="number">10</span>,TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BasicThreadPool</span><span class="params">(<span class="keyword">int</span> initSize, <span class="keyword">int</span> minSize,<span class="keyword">int</span> maxSize, <span class="keyword">int</span> coreSize, DenyPolicy denyPolicy, <span class="keyword">int</span> queueSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                           ThreadFactory factory, <span class="keyword">long</span> keepAliveTime, TimeUnit timeUnit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.initSize = initSize;</span><br><span class="line">        <span class="keyword">this</span>.minSize = minSize;</span><br><span class="line">        <span class="keyword">this</span>.maxSize = maxSize;</span><br><span class="line">        <span class="keyword">this</span>.coreSize = coreSize;</span><br><span class="line">        <span class="keyword">this</span>.threadFactory = factory;</span><br><span class="line">        <span class="keyword">this</span>.runnableQueue = <span class="keyword">new</span> LinkedRunnableQueue(queueSize, denyPolicy, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.keepAliveTime = keepAliveTime;</span><br><span class="line">        <span class="keyword">this</span>.timeUnit = timeUnit;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;默认的一些初始化方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; initSize; i++) &#123;</span><br><span class="line">        newThread();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">newThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    InternalTask internalTask = <span class="keyword">new</span> InternalTask(runnableQueue);</span><br><span class="line">    Thread thread = <span class="keyword">this</span>.threadFactory.createThread(internalTask);</span><br><span class="line">    ThreadTask threadTask = <span class="keyword">new</span> ThreadTask(thread, internalTask);</span><br><span class="line">    threadTaskQueue.offer(threadTask);</span><br><span class="line">    <span class="keyword">this</span>.activeCount++;</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ThreadTask remove = threadTaskQueue.remove();</span><br><span class="line">    remove.internalTask.stop();</span><br><span class="line">    <span class="keyword">this</span>.activeCount--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!isShutdown &amp;&amp; !isInterrupted()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            timeUnit.sleep(keepAliveTime);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            isShutdown = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isShutdown) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//线程的扩充与释放</span></span><br><span class="line">            <span class="keyword">if</span> (runnableQueue.size() &gt; <span class="number">0</span> &amp;&amp; activeCount &lt; coreSize) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = initSize; i &lt; coreSize; i++) &#123;</span><br><span class="line">                    newThread();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (runnableQueue.size() &gt;= coreSize &amp;&amp; activeCount &lt; maxSize) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = coreSize; i &lt; maxSize; i++) &#123;</span><br><span class="line">                    newThread();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (runnableQueue.size() == <span class="number">0</span> &amp;&amp; activeCount &gt; coreSize) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = coreSize; i &lt; activeCount; i++) &#123;</span><br><span class="line">                    removeThread();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isShutdown)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The thread pool is shutdown."</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (runnableQueue) &#123;</span><br><span class="line">        <span class="keyword">if</span> (threadTaskQueue.size() &gt; runnableQueue.size())</span><br><span class="line">            DEFAULT_DENY_POLICY.reject(runnable,<span class="keyword">this</span>);</span><br><span class="line">        runnableQueue.offer(runnable);</span><br><span class="line">        runnableQueue.notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isShutdown) <span class="keyword">return</span>;</span><br><span class="line">        isShutdown = <span class="keyword">true</span>;</span><br><span class="line">        threadTaskQueue.forEach(threadTask -&gt; &#123;</span><br><span class="line">            threadTask.internalTask.stop();</span><br><span class="line">            threadTask.thread.interrupt();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInitSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isShutdown)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The thread pool is shutdown."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.initSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isShutdown)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The thread pool is shutdown."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.maxSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCoreSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isShutdown)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The thread pool is shutdown."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.coreSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getQueueSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isShutdown)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The thread pool is shutdown."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.runnableQueue.size();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getActiveCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isShutdown)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The thread pool is shutdown."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.activeCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isShutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.isShutdown;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ThreadPool threadPool = <span class="keyword">new</span> BasicThreadPool(<span class="number">2</span>, <span class="number">10</span>, <span class="number">4</span>, <span class="number">6</span> , <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">        threadPool.execute(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" is running and done."</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">"getActiveCount "</span> + threadPool.getActiveCount());</span><br><span class="line">        System.out.println(<span class="string">"getQueueSize "</span> + threadPool.getQueueSize());</span><br><span class="line">        System.out.println(<span class="string">"getCoreSize "</span> + threadPool.getCoreSize());</span><br><span class="line">        System.out.println(<span class="string">"getMaxSize "</span> + threadPool.getMaxSize());</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程基础-07-获取线程运行时的异常</title>
      <link href="/2020/05/25/41839/hub/"/>
      <url>/2020/05/25/41839/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200525223013435.png" alt="image-20200525223013435"></p><h2 id="获取线程运行时的异常"><a href="#获取线程运行时的异常" class="headerlink" title="获取线程运行时的异常"></a>获取线程运行时的异常</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static Thread.UncaughtExceptionHandler getDefaultUncaughtExceptionHandler() </span><br><span class="line">返回当线程由于未捕获异常突然终止而调用的默认处理程序 </span><br><span class="line">static void setDefaultUncaughtExceptionHandler(Thread.UncaughtExceptionHandler eh) </span><br><span class="line">设置当线程由于未捕获的异常突然终止而调用的默认处理程序，并且没有为该线程定义其他处理程序。  </span><br><span class="line">void setUncaughtExceptionHandler(Thread.UncaughtExceptionHandler eh) </span><br><span class="line">设置当该线程由于未捕获的异常而突然终止时调用的处理程序。  </span><br><span class="line">Thread.UncaughtExceptionHandler getUncaughtExceptionHandler() </span><br><span class="line">返回由于未捕获的异常，此线程突然终止时调用的处理程序。</span><br></pre></td></tr></table></figure><h3 id="UncaughtExceptionHandler介绍"><a href="#UncaughtExceptionHandler介绍" class="headerlink" title="UncaughtExceptionHandler介绍"></a>UncaughtExceptionHandler介绍</h3><p>&emsp;&emsp;线程的执行单元中是不允许抛出checked异常的，而且线程运行在自己的上下文中，派生它的线程将无法直接获得它运行中的异常信息。所以，Java提供了一个UncaughtExceptionHandler接口。当线程在运行过程出现了异常情况时，会回调UncaughtExceptionHandler接口，从而可以知道具体是哪个线程出现了问题。当线程出现了问题JVM会调用Thread的dispatchUncaughtException方法将对应的线程示例以及异常错误信息传递给回调接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UncaughtExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Method invoked when the given thread terminates due to the</span></span><br><span class="line"><span class="comment">    * given uncaught exception.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;Any exception thrown by this method will be ignored by the</span></span><br><span class="line"><span class="comment">    * Java Virtual Machine.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> t the thread</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> e the exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Dispatch an uncaught exception to the handler. This method is</span></span><br><span class="line"><span class="comment">* intended to be called only by the JVM.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchUncaughtException</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">    getUncaughtExceptionHandler().uncaughtException(<span class="keyword">this</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="UncaughtExceptionHandler示例"><a href="#UncaughtExceptionHandler示例" class="headerlink" title="UncaughtExceptionHandler示例"></a>UncaughtExceptionHandler示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Thread.setDefaultUncaughtExceptionHandler((t,e)-&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">"Thread name is "</span> + t.getName());</span><br><span class="line">        System.out.println(<span class="string">"error  "</span> + e.getMessage());</span><br><span class="line">    &#125;);</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="number">1</span>/<span class="number">0</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这种场景是比较常见的，比如异步执行方法通常会在执行完成以后执行一个回调函数。</p><h3 id="UncaughtExceptionHandler源码分析"><a href="#UncaughtExceptionHandler源码分析" class="headerlink" title="UncaughtExceptionHandler源码分析"></a>UncaughtExceptionHandler源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Returns the handler invoked when this thread abruptly terminates</span></span><br><span class="line"><span class="comment">* due to an uncaught exception. If this thread has not had an</span></span><br><span class="line"><span class="comment">* uncaught exception handler explicitly set then this thread's</span></span><br><span class="line"><span class="comment">* &lt;tt&gt;ThreadGroup&lt;/tt&gt; object is returned, unless this thread</span></span><br><span class="line"><span class="comment">* has terminated, in which case &lt;tt&gt;null&lt;/tt&gt; is returned.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@since</span> 1.5</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the uncaught exception handler for this thread</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UncaughtExceptionHandler <span class="title">getUncaughtExceptionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> uncaughtExceptionHandler != <span class="keyword">null</span> ?</span><br><span class="line">        uncaughtExceptionHandler : group;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;首先getUncaughtExceptionHandler会进行判空处理，当先线程是否设置了handle，如果没有就从ThreadGroup中获取。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        parent.uncaughtException(t, e);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Thread.UncaughtExceptionHandler ueh =</span><br><span class="line">            Thread.getDefaultUncaughtExceptionHandler();</span><br><span class="line">        <span class="keyword">if</span> (ueh != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ueh.uncaughtException(t, e);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(e <span class="keyword">instanceof</span> ThreadDeath)) &#123;</span><br><span class="line">            System.err.print(<span class="string">"Exception in thread \""</span> + t.getName() + <span class="string">"\" "</span>);</span><br><span class="line">            e.printStackTrace(System.err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;1.如果group存在父group，那么直接调用父group的uncaughtException方法。</p><p>&emsp;&emsp;2.如果设置了全局的DefaultUncaughtExceptionHandler，那么直接调用全局的uncaughtException方法。</p><p>&emsp;&emsp;3.如果两者都不存在那就直接将异常的堆栈信息定向到System.err中。</p><p><img src="/image/hexo/image-20200525225744355.png" alt="image-20200525225744355"></p><p>&emsp;&emsp;</p><h2 id="注入钩子程序"><a href="#注入钩子程序" class="headerlink" title="注入钩子程序"></a>注入钩子程序</h2><h3 id="Hook线程介绍"><a href="#Hook线程介绍" class="headerlink" title="Hook线程介绍"></a>Hook线程介绍</h3><p>&emsp;&emsp;JVM进程的退出时由于JVM中没有active的非守护线程，或者系统收到了中断信号，向JVM程序注入了一个Hook线程，在JVM进程退出的时候，Hook线程会执行启动。可以使用Runtime向JVM注入一个钩子程序。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">"The hook thread is running"</span>);</span><br><span class="line">    &#125;));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注入多个</span></span><br><span class="line">    Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">"The hook thread2 is running"</span>);</span><br><span class="line">    &#125;));</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(<span class="string">"SHUT_DOWN!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>&emsp;&emsp;Hook线程只有在收到退出信号的时候才会被执行，如果使用kill -9 强制杀死进程，那么钩子程序将无法生效，所以都建议使用kill命令优雅的关闭程序。</p><p>&emsp;&emsp;Hook线程也可以执行一些资源释放的操作，比如关闭文件句柄、socket链接等。</p><p>&emsp;&emsp;对于一些耗时较长的操作，是非常不建议在Hook线程中进行操作的，这样会导致进程迟迟不能退出。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程基础-06-ThroupGroup详解</title>
      <link href="/2020/05/25/45426/hub/"/>
      <url>/2020/05/25/45426/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200525221647389.png" alt="image-20200525221647389"></p><h2 id="Thread与ThreadGroup"><a href="#Thread与ThreadGroup" class="headerlink" title="Thread与ThreadGroup"></a>Thread与ThreadGroup</h2><p>&emsp;&emsp;一个新的线程，在默认情况下都会加入main线程所在的group中，如同线程一样，ThreadGroup也存在父子关系。</p><h3 id="创建ThreadGroup"><a href="#创建ThreadGroup" class="headerlink" title="创建ThreadGroup"></a>创建ThreadGroup</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ThreadGroup(String name) </span><br><span class="line">构造一个新的线程组。  </span><br><span class="line">ThreadGroup(ThreadGroup parent, String name) </span><br><span class="line">创建一个新的线程组。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;第一个构造函数，可以指定线程组的名称，但是它的父线程组是创建它的线程的父线程组。第二个构造函数，可以显式的指定父线程组，同时赋予了它名称。</p><h3 id="复制Thread数组和ThreadGroup数组"><a href="#复制Thread数组和ThreadGroup数组" class="headerlink" title="复制Thread数组和ThreadGroup数组"></a>复制Thread数组和ThreadGroup数组</h3><h3 id="复制Thread数组"><a href="#复制Thread数组" class="headerlink" title="复制Thread数组"></a>复制Thread数组</h3><p>&emsp;&emsp;在一个ThreadGroup中可以加入若干个线程以及子ThreadGroup,ThreadGroup为我们提供了复制出线程和线程组的方法。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int enumerate(Thread[] list) </span><br><span class="line">将此线程组及其子组中的每个活动线程复制到指定的数组中。  </span><br><span class="line">int enumerate(Thread[] list, boolean recurse) </span><br><span class="line">将此线程组中的每个活动线程复制到指定的数组中。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;这两个方法会将ThreadGroup中的active线程全部复制到list数组中，recurse参数为true表示会将所有的子ThreadGroup中active线程全部递归到list数组中。最终他们实际也是调用了ThreadGroup的私有方法enumerate：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">enumerate</span><span class="params">(Thread list[], <span class="keyword">int</span> n, <span class="keyword">boolean</span> recurse)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ngroupsSnapshot = <span class="number">0</span>;</span><br><span class="line">    ThreadGroup[] groupsSnapshot = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (destroyed) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> nt = nthreads;</span><br><span class="line">        <span class="keyword">if</span> (nt &gt; list.length - n) &#123;</span><br><span class="line">            nt = list.length - n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nt; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (threads[i].isAlive()) &#123;</span><br><span class="line">                list[n++] = threads[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (recurse) &#123;</span><br><span class="line">            ngroupsSnapshot = ngroups;</span><br><span class="line">            <span class="keyword">if</span> (groups != <span class="keyword">null</span>) &#123;</span><br><span class="line">                groupsSnapshot = Arrays.copyOf(groups, ngroupsSnapshot);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                groupsSnapshot = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (recurse) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; ngroupsSnapshot ; i++) &#123;</span><br><span class="line">            n = groupsSnapshot[i].enumerate(list, n, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;enumerate方法获取的仅仅是一个预估值，并不能百分之百的保证当前group的活跃线程，比如在调用了以后，某个线程结束了生命周期或者新的线程加入，都会导致数据的不一致。</p><p>&emsp;&emsp;enumerate方法的返回值相比list的长度更加的真实，比如定义了list长度的数组，那么enumerate方法仅仅是将活跃的线程放入数组，而返回的int表示的是真实的数量。</p><h3 id="复制ThreadGroup数组"><a href="#复制ThreadGroup数组" class="headerlink" title="复制ThreadGroup数组"></a>复制ThreadGroup数组</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int enumerate(ThreadGroup[] list) </span><br><span class="line">复制到该线程组及其子组中每个活动子组的指定数组引用。  </span><br><span class="line">int enumerate(ThreadGroup[] list, boolean recurse) </span><br><span class="line">复制到该线程组中每个活动子组的指定数组引用。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;其实它和Thread的复制基本没有什么区别，recurse同样决定是否以递归的方式去进行复制操作。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ThreadGroup g1 = <span class="keyword">new</span> ThreadGroup(<span class="string">"G1"</span>);</span><br><span class="line">    ThreadGroup g2 = <span class="keyword">new</span> ThreadGroup(g1,<span class="string">"G2"</span>);</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    ThreadGroup mainGroup = Thread.currentThread().getThreadGroup();</span><br><span class="line"></span><br><span class="line">    ThreadGroup[] arr = <span class="keyword">new</span> ThreadGroup[mainGroup.activeGroupCount()];</span><br><span class="line">    <span class="keyword">int</span> enumerate = mainGroup.enumerate(arr);</span><br><span class="line">    System.out.println(enumerate);</span><br><span class="line"></span><br><span class="line">    enumerate = mainGroup.enumerate(arr, <span class="keyword">false</span>);</span><br><span class="line">    System.out.println(enumerate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ThreadGroup操作"><a href="#ThreadGroup操作" class="headerlink" title="ThreadGroup操作"></a>ThreadGroup操作</h2><h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int activeCount() </span><br><span class="line">返回此线程组及其子组中活动线程数的估计。  </span><br><span class="line">int activeGroupCount() </span><br><span class="line">返回此线程组及其子组中活动组数的估计。  </span><br><span class="line">int getMaxPriority() </span><br><span class="line">返回此线程组的最大优先级。  </span><br><span class="line">String getName() </span><br><span class="line">返回此线程组的名称。  </span><br><span class="line">ThreadGroup getParent() </span><br><span class="line">返回此线程组的父级。  </span><br><span class="line">void list() </span><br><span class="line">将有关此线程组的信息打印到标准输出。  </span><br><span class="line">boolean parentOf(ThreadGroup g) </span><br><span class="line">测试此线程组是线程组参数还是其祖先线程组之一。  </span><br><span class="line">void setMaxPriority(int pri) </span><br><span class="line">设置组的最大优先级。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;值得注意的是setMaxPriority方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setMaxPriority</span><span class="params">(<span class="keyword">int</span> pri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ngroupsSnapshot;</span><br><span class="line">    ThreadGroup[] groupsSnapshot;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        checkAccess();</span><br><span class="line">        <span class="keyword">if</span> (pri &lt; Thread.MIN_PRIORITY || pri &gt; Thread.MAX_PRIORITY) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        maxPriority = (parent != <span class="keyword">null</span>) ? Math.min(pri, parent.maxPriority) : pri;</span><br><span class="line">        ngroupsSnapshot = ngroups;</span><br><span class="line">        <span class="keyword">if</span> (groups != <span class="keyword">null</span>) &#123;</span><br><span class="line">            groupsSnapshot = Arrays.copyOf(groups, ngroupsSnapshot);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            groupsSnapshot = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; ngroupsSnapshot ; i++) &#123;</span><br><span class="line">        groupsSnapshot[i].setMaxPriority(pri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果线程组中以及拥有了线程，如果在此过程中将线程组的优先级调整到线程Thread还低的优先级，那么在操作更改优先级的操作以后，原来在Group里面的线程的优先级是保持不变的，但是后面新加入的线程Thread是不能够超过Group的最大优先级的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ThreadGroup g1 = <span class="keyword">new</span> ThreadGroup(<span class="string">"G1"</span>);</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(g1,()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    System.out.println(<span class="string">"Group --&gt; "</span> + g1.getMaxPriority());</span><br><span class="line">    System.out.println(<span class="string">"Thread --&gt; "</span> + t1.getPriority());</span><br><span class="line">    g1.setMaxPriority(<span class="number">3</span>);</span><br><span class="line">    System.out.println(<span class="string">"Thread --&gt; "</span> + t1.getPriority());</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(g1, () -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t2.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">    System.out.println(<span class="string">"Thread --&gt; "</span> + t2.getPriority());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="interrupt操作"><a href="#interrupt操作" class="headerlink" title="interrupt操作"></a>interrupt操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void interrupt() </span><br><span class="line">中断此线程组中的所有线程。</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ngroupsSnapshot;</span><br><span class="line">    ThreadGroup[] groupsSnapshot;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        checkAccess();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; nthreads ; i++) &#123;</span><br><span class="line">            threads[i].interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        ngroupsSnapshot = ngroups;</span><br><span class="line">        <span class="keyword">if</span> (groups != <span class="keyword">null</span>) &#123;</span><br><span class="line">            groupsSnapshot = Arrays.copyOf(groups, ngroupsSnapshot);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            groupsSnapshot = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; ngroupsSnapshot ; i++) &#123;</span><br><span class="line">        groupsSnapshot[i].interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;通过源码可以发现，它会将所有的active线程都被打断。它实际是循环执行了每个线程的interrupt（）方法。</p><h3 id="destory"><a href="#destory" class="headerlink" title="destory"></a>destory</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void destroy() </span><br><span class="line">销毁此线程组及其所有子组 </span><br><span class="line">boolean isDestroyed() </span><br><span class="line">测试此线程组是否已被破坏。</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ngroupsSnapshot;</span><br><span class="line">    ThreadGroup[] groupsSnapshot;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        checkAccess();</span><br><span class="line">        <span class="keyword">if</span> (destroyed || (nthreads &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">        &#125;</span><br><span class="line">        ngroupsSnapshot = ngroups;</span><br><span class="line">        <span class="keyword">if</span> (groups != <span class="keyword">null</span>) &#123;</span><br><span class="line">            groupsSnapshot = Arrays.copyOf(groups, ngroupsSnapshot);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            groupsSnapshot = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            destroyed = <span class="keyword">true</span>;</span><br><span class="line">            ngroups = <span class="number">0</span>;</span><br><span class="line">            groups = <span class="keyword">null</span>;</span><br><span class="line">            nthreads = <span class="number">0</span>;</span><br><span class="line">            threads = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; ngroupsSnapshot ; i += <span class="number">1</span>) &#123;</span><br><span class="line">        groupsSnapshot[i].destroy();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        parent.remove(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;主要用于销毁ThreadGroup,不过只是针对一个没有任何active线程的group进行一个destory标记,调用该方法的最终结果是在父group中异常自己。如果还有active线程存在，那么就会抛出IllegalThreadStateException异常。</p><h3 id="守护ThreadGroup"><a href="#守护ThreadGroup" class="headerlink" title="守护ThreadGroup"></a>守护ThreadGroup</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void setDaemon(boolean daemon) </span><br><span class="line">更改此线程组的守护程序状态。  </span><br><span class="line">boolean isDaemon() </span><br><span class="line">测试此线程组是否是守护线程组。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;线程可以设置为守护线程，ThreadGroup也提供了相应的方法设置为守护ThreadGroup,如果设置为守护的ThreadGroup其实也并不会影响到内部线程的daemon。而仅仅只是在Group中没有了active的线程将会进行自动的destroy。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ThreadGroup g1 = <span class="keyword">new</span> ThreadGroup(<span class="string">"G1"</span>);</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread(g1, () -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.start();</span><br><span class="line">    g1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(g1.isDaemon());</span><br><span class="line">    System.out.println(g1.isDestroyed());</span><br><span class="line">    System.out.println(<span class="string">"-----------------------"</span>);</span><br><span class="line">    ThreadGroup g2 = <span class="keyword">new</span> ThreadGroup(<span class="string">"G2"</span>);</span><br><span class="line">    Thread thread2 = <span class="keyword">new</span> Thread(g2, () -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread2.start();</span><br><span class="line">    System.out.println(g2.isDaemon());</span><br><span class="line">    System.out.println(g2.isDestroyed());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;</p><p>&emsp;&emsp;</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程基础-05-线程间通信</title>
      <link href="/2020/05/24/12342/hub/"/>
      <url>/2020/05/24/12342/hub/</url>
      
        <content type="html"><![CDATA[<h2 id="单线程间通信"><a href="#单线程间通信" class="headerlink" title="单线程间通信"></a>单线程间通信</h2><h3 id="wait和notify详解"><a href="#wait和notify详解" class="headerlink" title="wait和notify详解"></a>wait和notify详解</h3><p>&emsp;&emsp;wait和notify并不是Thread特有的方法，而是Object中的方法，也就是JDK中的每一个类都拥有这两个方法。</p><h4 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">wait</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">wait</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> InterruptedException</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">wait</span><span class="params">(<span class="keyword">long</span> timeout,<span class="keyword">int</span> nanos)</span> <span class="keyword">throws</span> InterruptedException</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;wait方法的这三个重载方法都将调用wait(long timeout)这个方法，我们常用的wait()方法等价于wait(0)，0表示永不超时。</p><p>&emsp;&emsp;Object的wait方法对导致当前线程进入阻塞状态，直到有其他线程调用了Object的notify或者notifyAll方法才能将其唤醒，或者阻塞时间达到了timeout时间而自动唤醒。</p><p>&emsp;&emsp;wait方法必须拥有该对象的monitor，也就说wait方法必须在同步方法中使用。</p><p>&emsp;&emsp;当前线程执行了该对象的wait方法后，会放弃对monitor的所有权并进入与该对象相关联的wait set中，其他线程也会有机会去争夺该monitor的所有权。</p><h4 id="notify"><a href="#notify" class="headerlink" title="notify"></a>notify</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;唤醒单个正在执行该对象wait方法的线程。</p><p>&emsp;&emsp;如果有某个线程由于执行该对象的wait方法而进入阻塞则会被唤醒，如果没有则会忽略。</p><p>&emsp;&emsp;被唤醒的线程需要重新获取该对象所关联的monitor的lock才能继续往下执行。</p><h4 id="关于wait与notify的注意事项"><a href="#关于wait与notify的注意事项" class="headerlink" title="关于wait与notify的注意事项"></a>关于wait与notify的注意事项</h4><p>&emsp;&emsp;wait是可中断方法，也就是说，当前线程一旦调用了wait方法进入了阻塞状态，其他线程是可以使用interrupt方法进行打断的;可中断方法被打断后会收到异常InterruptedException，同时interrupt标识会被擦除。</p><p>&emsp;&emsp;线程执行了某个对象的wait方法后，会加入与之对应的wait set中，每个对象的monitor都有一个与之关联的wait set。</p><p>&emsp;&emsp;当线程进入了wait set后，notify方法可以将之唤醒，也就是从wait set中弹出，同时中断wait中的线程也会被唤醒。</p><p>&emsp;&emsp;必须在同步方法中使用wait和notify方法，因为执行wait和notify的前提条件是必须要持有同步方法的monitor的所有权。</p><p>&emsp;&emsp;同步代码的monitor必须与执行wait，notify方法的monitor一致，简单来说用哪个对象的monitor进行同步，就只能用哪个对象的monitor进行wait和notify操作。</p><h4 id="wait和sleep"><a href="#wait和sleep" class="headerlink" title="wait和sleep"></a>wait和sleep</h4><p>&emsp;&emsp;从表面上看，两者都是让线程进入了阻塞状态，但是实际上两者拥有本质的区别。</p><p>&emsp;&emsp;wait和sleep方法都可以让线程进入阻塞状态。</p><p>&emsp;&emsp;wait和sleep方法均是可中断方法，被打断后都可以接受到中断异常。</p><p>&emsp;&emsp;wait是Object的方法，而sleep是Thread特有的方法。</p><p>&emsp;&emsp;wait方法需要在同步方法中去执行，而sleep不需要。</p><p>&emsp;&emsp;线程在同步方法中执行sleep方法时，并不会释放monitor锁，而 wait方法则会释放monitor锁。</p><p>&emsp;&emsp;sleep方法短暂休眠以后会主动退出阻塞，而wait方法在没有指定超时时间的情况下则需要被其他线程打断才能退出阻塞。</p><h2 id="多线程间通讯"><a href="#多线程间通讯" class="headerlink" title="多线程间通讯"></a>多线程间通讯</h2><h3 id="notifyAll"><a href="#notifyAll" class="headerlink" title="notifyAll"></a>notifyAll</h3><p>&emsp;&emsp;多线程间的通讯需要用到Object的notifyAll方法，该方法与notify方法类型，它们两者都能唤醒被阻塞的线程，不过notify方法只能唤醒其中的一个线程，而notifyAll可以同时唤醒全部的线程。同样的，被唤醒的线程依旧也要去争夺monitor锁资源。</p><h2 id="线程休息室wait-set"><a href="#线程休息室wait-set" class="headerlink" title="线程休息室wait set"></a>线程休息室wait set</h2><p><img src="/image/hexo/image-20200524223029320.png" alt="image-20200524223029320"></p><p>&emsp;&emsp;在虚拟机规范中存在一个wait set（线程休息室）的概念，至于它是怎么样的数据结构，JDK官方并没有给出明确的定义，不同的JDK厂商有着不同的实现方式。不管怎么样，线程调用了某个对象的wait方法都会被加入该对象monitor所关联的wait set中，并且释放monitor的所有权。若一个线程调用了该对象的notify方法之后，其中一个线程就会从wait set中弹出，至于是随机弹出，还是先进先出的方式弹出，虚拟机规范同样也没有给出强制的要求，而执行notifyAll则不需要考虑哪种方式会被弹出，因为wait set中的线程都会被弹出。</p><p><img src="/image/hexo/image-20200524225038000.png" alt="image-20200524225038000"></p><h2 id="自定义显示锁"><a href="#自定义显示锁" class="headerlink" title="自定义显示锁"></a>自定义显示锁</h2><h3 id="synchronized关键字的缺陷"><a href="#synchronized关键字的缺陷" class="headerlink" title="synchronized关键字的缺陷"></a>synchronized关键字的缺陷</h3><p>&emsp;&emsp;synchronized关键字提供了一种拍它式的数据同步机制，某个线程在获取monitor lock可能会被阻塞，而这种阻塞有两个很明显的缺陷：第一,无法控制阻塞时长。第二，阻塞不可中断。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SynchronizedDefect</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        SynchronizedDefect defect = <span class="keyword">new</span> SynchronizedDefect();</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(defect::syncMethod, <span class="string">"T1"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(<span class="number">2</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(defect::syncMethod, <span class="string">"T2"</span>);</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">syncMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;上述代码启动了两个线程去执行syncMethod方法，为了保证T1线程能够最先进入同步方法，所以main线程休眠了2毫秒，再次去启动T2线程，T2线程执行syncMethod方法时会进入阻塞，T2线程什么时候能够获取syncMethod的执行权完全取决于T1线程何时释放monitor锁的所有权，这也就是说阻塞时长不可控制。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    SynchronizedDefect defect = <span class="keyword">new</span> SynchronizedDefect();</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(defect::syncMethod, <span class="string">"T1"</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(<span class="number">2</span>);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(defect::syncMethod, <span class="string">"T2"</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">    Thread.sleep(<span class="number">2</span>);</span><br><span class="line">    t2.interrupt();</span><br><span class="line">    System.out.println(t2.isInterrupted());</span><br><span class="line">    System.out.println(t2.getState());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;第二个缺陷是T2若因为争抢某个monitor的锁而进入阻塞状态，那么它是无法中断的，虽然可以设置T2线程的interrupt标识，但是synchronized阻塞不像wait和sleep方法一样能够捕获到中断信号。</p><h2 id="显示锁BooleanLock"><a href="#显示锁BooleanLock" class="headerlink" title="显示锁BooleanLock"></a>显示锁BooleanLock</h2><h3 id="定义lock接口"><a href="#定义lock接口" class="headerlink" title="定义lock接口"></a>定义lock接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Lock</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">long</span> mills)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Thread&gt; <span class="title">getBlockThreads</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;lock()方法永远阻塞，除非获取到了锁，这一点和synchronized非常的类似，但是该方法是可以中断的，中断的时候抛出InterruptedException异常。</p><p>&emsp;&emsp;lock(long mills)方法除了可以被中断外，还增加了对应的超时功能。</p><p>&emsp;&emsp;unlock()方法可以用来进行锁的释放。</p><p>&emsp;&emsp;getBlockThreads()可以用于获取当前有哪些线程被阻塞。</p><h3 id="实现BoobleanLock"><a href="#实现BoobleanLock" class="headerlink" title="实现BoobleanLock"></a>实现BoobleanLock</h3><h4 id="实现lock（）方法"><a href="#实现lock（）方法" class="headerlink" title="实现lock（）方法"></a>实现lock（）方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooleanLock</span> <span class="keyword">implements</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前拥有锁的线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Thread currentThread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * false表示当前该锁没有被任何线程获取或者已经被释放</span></span><br><span class="line"><span class="comment">     * true表示锁已经被currentThread线程获取</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> locked = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用来存储已经阻塞的线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Thread&gt; lockedList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"><span class="keyword">while</span> (locked) &#123;</span><br><span class="line">                <span class="comment">//如果锁已经被其他线程抢夺，那么加入阻塞队列，并且释放当前monitor的所有权</span></span><br><span class="line">                <span class="keyword">if</span> (!lockedList.contains(currentThread())) &#123;</span><br><span class="line">                    lockedList.add(currentThread());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.wait();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果当前锁没有被其他线程获取，那么从阻塞队列中移除自己</span></span><br><span class="line">            lockedList.remove(currentThread());</span><br><span class="line">            <span class="comment">//将开关置为true</span></span><br><span class="line">            <span class="keyword">this</span>.locked = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//记录当前获取锁的线程</span></span><br><span class="line">            <span class="keyword">this</span>.currentThread = currentThread();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现lock-long-mills-方法"><a href="#实现lock-long-mills-方法" class="headerlink" title="实现lock(long mills)方法"></a>实现lock(long mills)方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">(<span class="keyword">long</span> mills)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mills &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.lock();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//计算结束的时间</span></span><br><span class="line">            <span class="keyword">long</span> remainingMills = mills;</span><br><span class="line">            <span class="keyword">long</span> endMills = System.currentTimeMillis() + remainingMills;</span><br><span class="line">            <span class="keyword">while</span> (locked) &#123;</span><br><span class="line">                <span class="comment">//当前线程被其他现线程唤醒或在指定的wait时间内没有获取到锁</span></span><br><span class="line">                <span class="keyword">if</span> (remainingMills &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(<span class="string">"can not get the lock during "</span> + mills);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!lockedList.contains(currentThread())) &#123;</span><br><span class="line">                    <span class="comment">//加入阻塞队列</span></span><br><span class="line">                    lockedList.add(currentThread());</span><br><span class="line">                    <span class="comment">//等待时间</span></span><br><span class="line">                    <span class="keyword">this</span>.wait(remainingMills);</span><br><span class="line">                    <span class="comment">//计算时间</span></span><br><span class="line">                    remainingMills = endMills - System.currentTimeMillis();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取到锁</span></span><br><span class="line">            lockedList.remove(currentThread());</span><br><span class="line">            <span class="keyword">this</span>.locked = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.currentThread = currentThread();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现unlock（）方法"><a href="#实现unlock（）方法" class="headerlink" title="实现unlock（）方法"></a>实现unlock（）方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//只有加了锁的线程才有资格解锁</span></span><br><span class="line">        <span class="keyword">if</span> (currentThread == currentThread()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.locked = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//唤醒所有的线程，可以再次去争夺锁资源</span></span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="多个线程争夺锁lock"><a href="#多个线程争夺锁lock" class="headerlink" title="多个线程争夺锁lock()"></a>多个线程争夺锁lock()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    UseLock useLock = <span class="keyword">new</span> UseLock();</span><br><span class="line">    IntStream.rangeClosed(<span class="number">0</span>,<span class="number">10</span>)</span><br><span class="line">        .mapToObj(i -&gt; <span class="keyword">new</span> Thread(useLock::syncMethod))</span><br><span class="line">        .forEach(Thread::start);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="可中断被阻塞的线程"><a href="#可中断被阻塞的线程" class="headerlink" title="可中断被阻塞的线程"></a>可中断被阻塞的线程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">syncMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">int</span> nextInt = <span class="keyword">new</span> Random().nextInt(<span class="number">10</span>);</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">" get the lock."</span>);</span><br><span class="line">        System.out.println(<span class="string">"nextInt = "</span> + nextInt);</span><br><span class="line">        TimeUnit.SECONDS.sleep(nextInt);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    UseLock u1 = <span class="keyword">new</span> UseLock();</span><br><span class="line">    <span class="keyword">new</span> Thread(u1::syncMethod).start();</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(u1::syncMethod);</span><br><span class="line">    t2.start();</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">    t2.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="阻塞的线程可以超时"><a href="#阻塞的线程可以超时" class="headerlink" title="阻塞的线程可以超时"></a>阻塞的线程可以超时</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">syncMethodTimeOut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        lock.lock(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">int</span> nextInt = <span class="keyword">new</span> Random().nextInt(<span class="number">10</span>);</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">" get the lock."</span>);</span><br><span class="line">        TimeUnit.SECONDS.sleep(nextInt);</span><br><span class="line">        System.out.println(<span class="string">"nextInt = "</span> + nextInt);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException | TimeoutException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    UseLock u1 = <span class="keyword">new</span> UseLock();</span><br><span class="line">    <span class="keyword">new</span> Thread(u1::syncMethod).start();</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(u1::syncMethodTimeOut);</span><br><span class="line">    t2.start();</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程基础-04-Thread API</title>
      <link href="/2020/05/24/16108/hub/"/>
      <url>/2020/05/24/16108/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200524181123778.png" alt="image-20200524181123778"></p><h2 id="线程sleep"><a href="#线程sleep" class="headerlink" title="线程sleep"></a>线程sleep</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static void sleep(long millis) </span><br><span class="line">使当前正在执行的线程以指定的毫秒数暂停（暂时停止执行），具体取决于系统定时器和调度程序的精度和准确性。  </span><br><span class="line">static void sleep(long millis, int nanos) </span><br><span class="line">导致正在执行的线程以指定的毫秒数加上指定的纳秒数来暂停（临时停止执行），这取决于系统定时器和调度器的精度和准确性。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;sleep是一个静态方法，其中有两个重载方法，一个需要传入毫秒数，另一个在传入毫秒数的同时也要传入纳秒数。它会使当前线程进入指定时间的休眠，暂停执行，最终都要以系统的定时器和调度器的精度为准，休眠的时候有一个特性，那就是不会放弃monitor锁的所有权。</p><p>&emsp;&emsp;在JDK1.5以后，JDK引入了一个枚举TimeUnit，对sleep方法提供了很好的封装，可以省去时间单位的换算步骤。</p><h2 id="线程yield"><a href="#线程yield" class="headerlink" title="线程yield"></a>线程yield</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">static void yield() </span><br><span class="line">对调度程序的一个暗示，即当前线程愿意产生当前使用的处理器。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;yield方法属于一种启发式的方法，会提醒调度去我愿意放弃当前CPU的资源，如果CPU的资源不紧张则会忽略这种提醒。方法调用会使当前线程从RUNNING状态切换到RUNNABLE状态。</p><p>&emsp;&emsp;但是，yield只是一个提示，CPU调度器定不会担保每次都能满足yield提示。</p><h3 id="sleep与yield"><a href="#sleep与yield" class="headerlink" title="sleep与yield"></a>sleep与yield</h3><p>&emsp;&emsp;1.sleep会导致当前线程休眠指定的时间，没有CPU时间片的消耗。</p><p>&emsp;&emsp;2.yeild只是对CPU的一个提示，如果CPU没有忽略这个提示，会导致线程上下文的切换，从RUNNING状态切换到RUNNABLE状态。</p><p>&emsp;&emsp;3.sleep会导致线程短暂block，会在给定时间内释放CPU的资源。</p><p>&emsp;&emsp;4.sleep几乎百分百完成了给定时间的休眠，而yield并不会一定担保完成。</p><p>&emsp;&emsp;5.一个线程sleep另一个线程interrput会捕获到中断信号，而yield不会。</p><h2 id="线程的优先级"><a href="#线程的优先级" class="headerlink" title="线程的优先级"></a>线程的优先级</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void setPriority(int newPriority) </span><br><span class="line">更改此线程的优先级。  </span><br><span class="line">int getPriority() </span><br><span class="line">返回此线程的优先级。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;进程拥有进程的优先级，线程同样也有线程的优先级，理论上是优先级比较高的线程会优先获取到CPU调度的机会。但是，事实上往往并不会如你所愿。如果CPU比较繁忙，设置优先级可能会获得更多的CPU调度的机会，但是闲时优先级的高低几乎不会有任何作用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MIN_PRIORITY = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_PRIORITY = <span class="number">10</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setPriority</span><span class="params">(<span class="keyword">int</span> newPriority)</span> </span>&#123;</span><br><span class="line">    ThreadGroup g;</span><br><span class="line">    checkAccess();</span><br><span class="line">    <span class="keyword">if</span> (newPriority &gt; MAX_PRIORITY || newPriority &lt; MIN_PRIORITY) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>((g = getThreadGroup()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (newPriority &gt; g.getMaxPriority()) &#123;</span><br><span class="line">            newPriority = g.getMaxPriority();</span><br><span class="line">        &#125;</span><br><span class="line">        setPriority0(priority = newPriority);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;从源码上可以看出，线程的优先级不能小于1也不能大于10。如果指定的线程优先级大于了所在group的优先级，那么指定的优先级将会无效，取而代之的是group的最大优先级。</p><h2 id="获取线程ID"><a href="#获取线程ID" class="headerlink" title="获取线程ID"></a>获取线程ID</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">long getId() </span><br><span class="line">返回此线程的标识符。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;获取线程的唯一ID，线程ID在整个JVM进程中都会是唯一的，并且从0开始递增。如果在main线程中开启了一个唯一的线程，其实可以发现它并不是从0开始的，实际上在JVM进程启动的时候，已经开启了很多个线程，自增序列已经有了一定的消耗。</p><h2 id="获取当前线程"><a href="#获取当前线程" class="headerlink" title="获取当前线程"></a>获取当前线程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">static Thread currentThread() </span><br><span class="line">返回对当前正在执行的线程对象的引用。</span><br></pre></td></tr></table></figure><h2 id="线程上下文类加载器"><a href="#线程上下文类加载器" class="headerlink" title="线程上下文类加载器"></a>线程上下文类加载器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void setContextClassLoader(ClassLoader cl) </span><br><span class="line">设置此线程的上下文ClassLoader。  </span><br><span class="line">ClassLoader getContextClassLoader() </span><br><span class="line">返回此Thread的上下文ClassLoader。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;getContextClassLoader用于获取线程上下文的类加载器，简单来说就是这个线程是由哪个类加载器加载的，如果是在没有修改线程上下文类加载器的情况下，则保持与父线程相同的类加载器。</p><p>&emsp;&emsp;setContextClassLoader用于设置该线程的类加载器，这个方法可以打破JAVA类加载的父委托机制，有时候该方法也被称为JAVA类加载器的后门。</p><h2 id="线程的interrupt"><a href="#线程的interrupt" class="headerlink" title="线程的interrupt"></a>线程的interrupt</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">boolean isInterrupted() </span><br><span class="line">测试这个线程是否被中断。  </span><br><span class="line">void interrupt() </span><br><span class="line">中断这个线程。  </span><br><span class="line">static boolean interrupted() </span><br><span class="line">测试当前线程是否中断。</span><br></pre></td></tr></table></figure><h3 id="interrupt"><a href="#interrupt" class="headerlink" title="interrupt"></a>interrupt</h3><p>&emsp;&emsp;调用如下的方法可以使当前线程进入阻塞状态，而调用当前线程的interrupt方法可以打断阻塞。打断一个线程并不等于该线程的生命周期结束，仅仅是打断了当前线程的阻塞状态。一旦线程在一个阻塞的情况下被打断，都会抛出一个InterruptedException的异常，这个异常就像一个信号一样通知当前线程被打断了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Object的wait方法</span><br><span class="line">Object的wait(long)方法</span><br><span class="line">Object的wait(long,int)方法</span><br><span class="line">Thread的sleep(long)方法</span><br><span class="line">Thread的sleep(long,int)方法</span><br><span class="line">Thread的join()方法</span><br><span class="line">Thread的join(long)方法</span><br><span class="line">Thread的join(long,int)方法</span><br><span class="line">InterruptibleChannel的IO操作</span><br><span class="line">Selector的wakeup操作</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;在线程的内部存在了一个interrupt flag的标识，调用interrupt方法将其中断，反而会导致flag被清除，如果一个线程已经是死亡状态的时候，企图对其interrupt的操作将被忽略。</p><h3 id="isInterrupted"><a href="#isInterrupted" class="headerlink" title="isInterrupted"></a>isInterrupted</h3><p>&emsp;&emsp;isInterrupted是Thread的一个成员方法，主要是对flag进行一个判断。并不会产生任何的影响。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//demo-01</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread.start();</span><br><span class="line">    System.out.println(<span class="string">"The interrupt is "</span> + thread.isInterrupted());</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    thread.interrupt();</span><br><span class="line">    System.out.println(<span class="string">"The interrupt is "</span> + thread.isInterrupted());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">The interrupt is <span class="keyword">false</span></span><br><span class="line">The interrupt is <span class="keyword">true</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//demo-02</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Thread interrupt is "</span> + isInterrupted());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread.start();</span><br><span class="line">    System.out.println(<span class="string">"The interrupt is "</span> + thread.isInterrupted());</span><br><span class="line">    Thread.sleep(<span class="number">2</span>);</span><br><span class="line">    thread.interrupt();</span><br><span class="line">    System.out.println(<span class="string">"The interrupt is "</span> + thread.isInterrupted());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">The interrupt is <span class="keyword">false</span></span><br><span class="line">The interrupt is <span class="keyword">false</span></span><br><span class="line">Thread interrupt is <span class="keyword">false</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以发现两个demo的运行结果是不一样的，因为demo-02中的run方法使用了sleep这个可中断方法，他会捕获到中断的信号，并且会擦除interrupt的标识。可中断方法捕获到了中断信号后为了不影响其他方法的执行，将线程的interrupt标识复位是一种很合理的设计。</p><h3 id="interrupted"><a href="#interrupted" class="headerlink" title="interrupted"></a>interrupted</h3><p>&emsp;&emsp;interrupted是Thread的一个静态方法，虽然也用于判断当前线程是否被中断，但是与成员方法有很大的区别。调用该方法会直接擦除线程的interrupt flag，如果当前线程被打断了，第一次调用interrupted方法会返回true，并且立即擦除了标识，第二次包括以后调用永远都是false,除非再此期间线程再一次的被打断。</p><h2 id="线程join"><a href="#线程join" class="headerlink" title="线程join"></a>线程join</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void join() </span><br><span class="line">等待这个线程死亡。  </span><br><span class="line">void join(long millis) </span><br><span class="line">等待这个线程死亡最多 millis毫秒。  </span><br><span class="line">void join(long millis, int nanos) </span><br><span class="line">等待最多 millis毫秒加上 nanos纳秒这个线程死亡。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;join某个线程A，会使当前线程B进入等待，直到线程A结束生命周期，或者传达一个给定的时间，那么在此期间B线程是处于BLOCKED的，而不是线程A。</p><h2 id="关闭线程"><a href="#关闭线程" class="headerlink" title="关闭线程"></a>关闭线程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">void stop() </span><br><span class="line">已弃用 </span><br><span class="line">这种方法本质上是不安全的。 使用Thread.stop停止线程可以解锁所有已锁定的监视器（由于未ThreadDeath ThreadDeath异常在堆栈中ThreadDeath的自然结果）。 如果先前受这些监视器保护的任何对象处于不一致的状态，则损坏的对象将变得对其他线程可见，可能导致任意行为。 stop许多用途应该被替换为只是修改一些变量以指示目标线程应该停止运行的代码。 目标线程应该定期检查此变量，如果变量表示要停止运行，则以有序方式从其运行方法返回。 如果目标线程长时间等待（例如，在interrupt变量上），则应该使用interrupt方法来中断等待。 有关详细信息，请参阅Why are Thread.stop, Thread.suspend and Thread.resume Deprecated? 。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;针对stop方法，JDK已经废弃了，根据官网的描述，该方法在关闭线程的时候可能不会释放monitor锁资源。</p><h3 id="正常关闭"><a href="#正常关闭" class="headerlink" title="正常关闭"></a>正常关闭</h3><p>&emsp;&emsp;当线程执行完自己的逻辑单元后，正常的结束生命周期。</p><h3 id="捕获中断信号进行关闭"><a href="#捕获中断信号进行关闭" class="headerlink" title="捕获中断信号进行关闭"></a>捕获中断信号进行关闭</h3><p>&emsp;&emsp;一个线程中往往执行了一些循环的任务，比如心跳检查，可以借助中断信号的方式去结束逻辑单元的执行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">                System.out.println(<span class="string">"I will work!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"I will be exiting!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    thread.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    System.out.println(<span class="string">"system shutdown!"</span>);</span><br><span class="line">    thread.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="volatile开关进行控制"><a href="#volatile开关进行控制" class="headerlink" title="volatile开关进行控制"></a>volatile开关进行控制</h3><p>&emsp;&emsp;由于interrupt flag可能被擦除，或者逻辑单元中不会调用任何的中断方法，所以可以考虑使用volatile修饰的开关去进行操作。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> closedFlag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"I will work!"</span>);</span><br><span class="line">        <span class="keyword">while</span> (!closedFlag) &#123;</span><br><span class="line">            System.out.println(<span class="string">"I working!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"I will be exiting!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.closedFlag = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    MyTask myTask = <span class="keyword">new</span> MyTask();</span><br><span class="line">    myTask.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    System.out.println(<span class="string">"System will be shutdown."</span>);</span><br><span class="line">    myTask.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="异常退出"><a href="#异常退出" class="headerlink" title="异常退出"></a>异常退出</h3><p>&emsp;&emsp;在一个线程的执行单元中，是不允许抛出checked异常的，不论是Thread的run方法还是Runnable的run方法，如果线程在运行的过程中需要捕获checked异常并且判断是否还有运行下去的必要，那么此时可以考虑将checked异常封装程unchecked异常抛出进而结束线程的生命周期。</p><h3 id="进程假死"><a href="#进程假死" class="headerlink" title="进程假死"></a>进程假死</h3><p>&emsp;&emsp;所谓假死就是进程虽然存在，但是没有日志等输出，程序不进行任何作业，看起来像是死了一样，但事实上它并没有死。程序之所以出现这种情况，绝大部分原因是某个线程阻塞了，或者线程出现了死锁的情况。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程基础-03-Thread的构造函数详解</title>
      <link href="/2020/05/24/1724/hub/"/>
      <url>/2020/05/24/1724/hub/</url>
      
        <content type="html"><![CDATA[<p><img src="/image/hexo/image-20200524143238845.png" alt="image-20200524143238845"></p><h2 id="线程的命名"><a href="#线程的命名" class="headerlink" title="线程的命名"></a>线程的命名</h2><h3 id="默认的线程名称"><a href="#默认的线程名称" class="headerlink" title="默认的线程名称"></a>默认的线程名称</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Thread() </span><br><span class="line">分配一个新的 Thread对象。  </span><br><span class="line">Thread(Runnable target) </span><br><span class="line">分配一个新的 Thread对象。  </span><br><span class="line">Thread(String name) </span><br><span class="line">分配一个新的 Thread对象。  </span><br><span class="line">Thread(ThreadGroup group, Runnable target) </span><br><span class="line">分配一个新的 Thread对象。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以看见上述的构造函数并没有传入name参数，此时可以查看源代码发现没有显式置顶一个名字，会以”Thread-“作为前缀与一个自增的数字进行组合，这个自增数字会在JVM进程中将不断会自增。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以Thread() 为例</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Thread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    init(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="string">"Thread-"</span> + nextThreadNum(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> threadInitNumber;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">nextThreadNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> threadInitNumber++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;而其他的构造函数可以设置线程的名称，在构造Thread的时候为线程赋予一个特殊的名字是一种比较的方式。</p><h3 id="修改线程的名称"><a href="#修改线程的名称" class="headerlink" title="修改线程的名称"></a>修改线程的名称</h3><p>&emsp;&emsp;不管是默认了线程的名字还是指定了线程的名字，在线程启动之前都还有机会对其进行修改，一旦线程启动，名字修改将不会生效。我们可以从源代码中分析：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    checkAccess();</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"name cannot be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">if</span> (threadStatus != <span class="number">0</span>) &#123;<span class="comment">//不是NEW状态将不执行修改</span></span><br><span class="line">        setNativeName(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="线程之间的父子关系"><a href="#线程之间的父子关系" class="headerlink" title="线程之间的父子关系"></a>线程之间的父子关系</h2><p>&emsp;&emsp;我们继续跟踪Thread的构造函数，发现都会去调用一个静态方法init。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">long</span> stackSize, AccessControlContext acc,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> inheritThreadLocals)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"name cannot be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line"></span><br><span class="line">    Thread parent = currentThread();<span class="comment">//获取当前线程作为此线程的父线程</span></span><br><span class="line">    SecurityManager security = System.getSecurityManager();</span><br><span class="line">    ...</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        tid = nextThreadID();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以看出，currentThread（）获取了当前的线程作为此线程的父线程，此时可以明确:</p><p>&emsp;&emsp;1.一个线程的创建肯定是由另一个线程完成的。</p><p>&emsp;&emsp;2.被创建线程的父线程市创建它的线程。</p><h2 id="线程与线程组"><a href="#线程与线程组" class="headerlink" title="线程与线程组"></a>线程与线程组</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Thread(ThreadGroup group, Runnable target) </span><br><span class="line">分配一个新的 Thread对象。  </span><br><span class="line">Thread(ThreadGroup group, Runnable target, String name) </span><br><span class="line">分配一个新的 Thread对象，使其具有 target作为其运行对象，具有指定的 name作为其名称，属于 group引用的线程组。  </span><br><span class="line">Thread(ThreadGroup group, Runnable target, String name, long stackSize) </span><br><span class="line">分配一个新的 Thread对象，以便它具有 target作为其运行对象，将指定的 name正如其名，以及属于该线程组由称作 group ，并具有指定的 堆栈大小 。  </span><br><span class="line">Thread(ThreadGroup group, String name) </span><br><span class="line">分配一个新的 Thread对象。</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;在构造函数中提供了显式的指定线程的group。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">long</span> stackSize, AccessControlContext acc,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> inheritThreadLocals)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"name cannot be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line"></span><br><span class="line">    Thread parent = currentThread();</span><br><span class="line">    SecurityManager security = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            g = security.getThreadGroup();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</span><br><span class="line">            g = parent.getThreadGroup();<span class="comment">//获取父线程的group</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        tid = nextThreadID();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;可以看见如果没有显示的指定ThreadGroup，那么子线程获取加入父线程的线程组。</p><p>&emsp;&emsp;1.mian线程所在的ThreadGroup称为main。</p><p>&emsp;&emsp;2.构造一个线程的时候没有显式的指定ThreadGroup那么它将和父线程同属一个ThreadGroup。当然，它还会拥有和父线程一样的优先级，同样的daemon。</p><h2 id="Thread与JVM虚拟机栈"><a href="#Thread与JVM虚拟机栈" class="headerlink" title="Thread与JVM虚拟机栈"></a>Thread与JVM虚拟机栈</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Thread(ThreadGroup group, Runnable target, String name, long stackSize) </span><br><span class="line">分配一个新的 Thread对象，以便它具有 target作为其运行对象，将指定的 name正如其名，以及属于该线程组由称作 group ，并具有指定的 堆栈大小 。 </span><br><span class="line">@param stackSize the desired stack size for the new thread, or zero to indicate that this parameter is to be ignored.</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;在Thread的构造函数中提供了一个特殊的stackSize参数。一般情况下不会去手动指定栈内存的大小，统一通过xss参数进行设置，stackSize设置的越大代表正在线程内方法调用递归的深度就越深，stackSize越小则代表着创建的线程的数量越多。不过，stackSize肯定是对平台的依赖性比较高。</p><p><img src="/image/hexo/image-20200524150539644.png" alt="image-20200524150539644"></p><h3 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h3><p>&emsp;&emsp;程序计数器在JVM中起到的作用主要就是存放当前线程接下来要执行的字节码的指令、分支、循环、跳转、异常处理等信息。在任何时候，一个处理器执行其中一个线程中的指令，为了能够在CPU的时间轮转切换上下文之后顺利回到正确的执行位置，所以每条线程都需要具有一个独立的程序计数器，各个线程间互不影响，因此JVM将此内存区域设计成为了私有的。</p><h3 id="Java虚拟机栈"><a href="#Java虚拟机栈" class="headerlink" title="Java虚拟机栈"></a>Java虚拟机栈</h3><p><img src="/image/hexo/image-20200524151140188.png" alt="image-20200524151140188"></p><p>&emsp;&emsp;这里与程序计数器内存类型，也是线程私有的，它的生命周期与线程相同，在JVM运行时所创建的。在线程中，方法在执行的时候都会创建一个名为栈帧的数据结构。</p><h4 id="栈帧"><a href="#栈帧" class="headerlink" title="栈帧"></a>栈帧</h4><p>&emsp;&emsp;主要用于存放局部变量表、操作栈、动态链接、方法出口等信息，方法的调用对应这虚拟机栈中的压栈和弹栈过程。</p><p>&emsp;&emsp;每一个线程创建的时候，JVM都会为其创建对应的虚拟机栈，虚拟机栈的内存大小可以通过-xss配置。同等的虚拟机栈如果局部变量表等占用的内存越小那么可被压入的栈帧就越多，反之亦然。一般将栈帧内存的大小成为宽度，而栈帧的数量则成为深度。</p><h3 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h3><p>&emsp;&emsp;Java中提供了调用本地方法的接口，也就是C/C++程序，在线程的执行过程中，经常会碰到调用JNI方法的情况。比如网络通信、文件操作的底层等。JVM为本地方法所划分的内存区域便是本地方法栈，同样也是属于线程私有的。</p><h3 id="堆内存"><a href="#堆内存" class="headerlink" title="堆内存"></a>堆内存</h3><p>&emsp;&emsp;堆内存是JVM中最大的内存区域，被所有的线程共享。Java在运行期间创建的所有对象几乎都放在该内存区域，同样也是垃圾回收器重点照顾的区域，因此有时候堆内存又被成为“GC堆”。</p><h3 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h3><p>&emsp;&emsp;方法区也是被多个线程所共享的内存区域，主要用于存储已经被虚拟机加载的类信息、常量、静态变量、即时编译器（JIT）编译后的代码等数据。</p><h2 id="守护线程"><a href="#守护线程" class="headerlink" title="守护线程"></a>守护线程</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Thread is running."</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.setDaemon(<span class="keyword">true</span>);<span class="comment">//设置为守护线程</span></span><br><span class="line">    thread.start();</span><br><span class="line"></span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(<span class="string">"Main Thread is finished."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;设置了守护线程，那么main函数的生命周期JVM也会随之退出，否则在上述代码中JVM将永远不会退出，即使main线程已经正常结束了自己的生命周期。</p><p>&emsp;&emsp;设置守护线程的方式很简单，只需要调用setDaemon方法即可，true表示守护线程，false表示正常线程。线程是否为守护线程和它的父线程也有关系，如果父线程是正常线程，那么子线程也是正常线程，反之亦然。可以通过isDaemon方法判断该线程是否是守护线程。并且setDaemon方法在线程启动之前才能生效。</p><p>&emsp;&emsp;守护线程经常用于执行一些后台任务，有时候也被成为后台线程。当你希望关闭某些线程的时候，或者退出JVM进程的时候，一些线程能够自动关闭，此时可以考虑使用守护线程的方法完成相应的工作。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程基础-02-线程的start方法剖析</title>
      <link href="/2020/05/23/15964/hub/"/>
      <url>/2020/05/23/15964/hub/</url>
      
        <content type="html"><![CDATA[<h2 id="Thread-start源码分析"><a href="#Thread-start源码分析" class="headerlink" title="Thread.start源码分析"></a>Thread.start源码分析</h2><p><img src="/image/hexo/image-20200523235212301.png" alt="image-20200523235212301"></p><h3 id="先看一下Thread-start的源码"><a href="#先看一下Thread-start的源码" class="headerlink" title="先看一下Thread.start的源码"></a>先看一下Thread.start的源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (threadStatus != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line"></span><br><span class="line">    group.add(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        start0();</span><br><span class="line">        started = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!started) &#123;</span><br><span class="line">                group.threadStartFailed(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">start0</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;其实可以看出，它主要是调用到了start0这个本地方法（JNI方法）。而start0做了什么呢？它主要</p><p>在开始执行这个线程时，JVM会调用该线程的run方法。并且：</p><p>&emsp;&emsp;1.当Thread实例化后，threadStatus的属性值默认为0。</p><p>&emsp;&emsp;2.不能多次启动Thread，否则抛出IllegalThreadStateException异常。</p><p>&emsp;&emsp;3.线程启动后会加入一个ThreadGroup中。</p><p>&emsp;&emsp;4.一个线程生命周期的结束，再次调用start方法是不被允许的，也就是TERMINED状态没办法回到RUNNING/RUNNABLE状态。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//demo-01</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">"I am running"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.start();<span class="comment">//启动线程</span></span><br><span class="line">    thread.start();<span class="comment">//重复启动</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//demo-02</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">        System.out.println(<span class="string">"I am running"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.start();<span class="comment">//启动线程</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);<span class="comment">//确报thread生命周期结束</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    thread.start();<span class="comment">//企图重新激活启动</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;以上两个demo都会抛出IllegalThreadStateException异常，但是demo-01是属于重复启动，而demo-02的启动是不被允许的，但是demo-01的线程是处于运行状态的，而第demo-02企图重新启动抛出了非法状态异常，此时线程生命周期已经结束。</p><h2 id="模板设计模式在Thread中的应用"><a href="#模板设计模式在Thread中的应用" class="headerlink" title="模板设计模式在Thread中的应用"></a>模板设计模式在Thread中的应用</h2><p>&emsp;&emsp;可以看出线程真正的逻辑其实在于run方法（线程的执行单元）。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">        target.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;如果我们没有使用Runnable接口对其进行构造，那么Thread的run方法就是一个空的实现。其实Thread的run和start就是一个比较经典的模板设计模式，父类编写算法结构代码，子类负责去实现具体业务逻辑。</p><h2 id="Runnable接口简述"><a href="#Runnable接口简述" class="headerlink" title="Runnable接口简述"></a>Runnable接口简述</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * When an object implementing interface &lt;code&gt;Runnable&lt;/code&gt; is used</span></span><br><span class="line"><span class="comment">     * to create a thread, starting the thread causes the object's</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;run&lt;/code&gt; method to be called in that separately executing</span></span><br><span class="line"><span class="comment">     * thread.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * The general contract of the method &lt;code&gt;run&lt;/code&gt; is that it may</span></span><br><span class="line"><span class="comment">     * take any action whatsoever.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span>     java.lang.Thread#run()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;它使用@FunctionalInterface修饰，作为一个函数接口。只有一个无参数无返回值的run方法。在JDK中代表线程的只有Thread类，而通常所说的创建线程实现Runnable接口实际上只是实现了线程的执行单元，仅仅是将Runnable实例用作构造Thread的参数。</p><p>&emsp;&emsp;无论是Thread的run方法还是Runnable的run方法，它们都是想将线程的控制与实际业务逻辑的运行分离开来。但是，它们还有一个很重要的不同，Thread的run方法是不能共享的，也就是A线程不能把B线程的run方法当作自己的执行单元，而Runnable接口则很容易的可以实现这一点，使用同一个Runnable实例可以构造出不同的Thread实例。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多线程基础-01(线程的生命周期)</title>
      <link href="/2020/05/23/34947/hub/"/>
      <url>/2020/05/23/34947/hub/</url>
      
        <content type="html"><![CDATA[<h2 id="线程的生命周期的五大阶段"><a href="#线程的生命周期的五大阶段" class="headerlink" title="线程的生命周期的五大阶段"></a>线程的生命周期的五大阶段</h2><h3 id="图解"><a href="#图解" class="headerlink" title="图解"></a>图解</h3><p><img src="/image/hexo/image-20200523212349727.png" alt="image-20200523212349727"></p><p>可以知道线程的生命周期大致分为以下5个阶段：</p><h3 id="线程的状态"><a href="#线程的状态" class="headerlink" title="线程的状态"></a>线程的状态</h3><h4 id="NEW（初始化）"><a href="#NEW（初始化）" class="headerlink" title="NEW（初始化）"></a>NEW（初始化）</h4><h4 id="RUNNABLE（就绪）"><a href="#RUNNABLE（就绪）" class="headerlink" title="RUNNABLE（就绪）"></a>RUNNABLE（就绪）</h4><h4 id="RUNNING（运行）"><a href="#RUNNING（运行）" class="headerlink" title="RUNNING（运行）"></a>RUNNING（运行）</h4><h4 id="BLOCKED（阻塞）"><a href="#BLOCKED（阻塞）" class="headerlink" title="BLOCKED（阻塞）"></a>BLOCKED（阻塞）</h4><h4 id="TERMINTED（死亡）"><a href="#TERMINTED（死亡）" class="headerlink" title="TERMINTED（死亡）"></a>TERMINTED（死亡）</h4><h2 id="线程的NEW状态"><a href="#线程的NEW状态" class="headerlink" title="线程的NEW状态"></a>线程的NEW状态</h2><p>&emsp;&emsp;当我们用关键字new创建出一个Thread对象时，此刻他不属于执行状态，在没有调用start方法启动该线程，此刻为NEW状态。严格意义上，仅仅只是Thread对象的状态，在未调用start方法前，该线程并不存在。此刻与普通的new一个Java对象并没有什么区别。  </p><p>&emsp;&emsp;NEW状态通过start方法进入RUNNABLE状态。</p><h2 id="线程的RUNNABLE状态"><a href="#线程的RUNNABLE状态" class="headerlink" title="线程的RUNNABLE状态"></a>线程的RUNNABLE状态</h2><p>&emsp;&emsp;线程对象进入RUNNABLE状态必须调用start方法，此时此刻才是在JVM进程中创建了一个线程，可以简单描述这个状态为就绪状态（可执行状态），因为在start方法调用后，线程并不是立即执行的，而是需要听令于CPU的调度。</p><p>&emsp;&emsp;所以，此刻线程处于就绪状态，等待CPU的调度。</p><h2 id="线程的RUNNING状态"><a href="#线程的RUNNING状态" class="headerlink" title="线程的RUNNING状态"></a>线程的RUNNING状态</h2><p>&emsp;&emsp;经过CPU的轮询或其他方式从任务可执行队列中选中该线程，此刻它才能执行自己的逻辑代码。</p><p>&emsp;&emsp;此状态下，可以发生如下状态转换：</p><p>&emsp;&emsp;1.直接进入TERMINED状态。例如调用JDK已经不推荐使用的stop方法。</p><p>&emsp;&emsp;2.进入BLOCKED状态。例如调用sleep方法，或者wait方法从而加入了waitSet(所有的对象都会有一个waitSet，用来存放调用了该对象的wait方法之后进入block状态的线程)。还可能争夺锁或者进行某个阻塞的IO操作。</p><p>&emsp;&emsp;3.CPU的调度器使得该线程放弃了执行权，或者主动调用yield方法放弃CPU执行权，进入RUNNABLE状态。(Thread.yield():暂停当前执行的线程，使其进入RUNNABLE状态，并执行其他线程。但是实际上并不能完美的达到让步，因为执行让步的线程还有可能被CPU调度再次进入RUNNING状态)</p><h2 id="线程的BLOCKED状态"><a href="#线程的BLOCKED状态" class="headerlink" title="线程的BLOCKED状态"></a>线程的BLOCKED状态</h2><p>&emsp;&emsp;此状态下可以完成下列几个状态的切换：</p><p>&emsp;&emsp;1.直接进入TERMINED状态。例如调用stop方法（不推荐使用），或者JVM Crash。</p><p>&emsp;&emsp;2.线程阻塞的操作结束。例如读取到了理想的数据，进入RUNNABLE状态。</p><p>&emsp;&emsp;3.完成了指定时间的休眠，进入RUNNABLE状态。</p><p>&emsp;&emsp;4.wait状态中被其他线程唤醒（notify、notifyAll），进入RUNNABLE状态。</p><p>&emsp;&emsp;5.获取到了锁资源，进入RUNNABLE状态。</p><p>&emsp;&emsp;6.线程在阻塞过程中被打断（interrupt），进入RUNNABLE状态。</p><h2 id="线程的TERMINED状态"><a href="#线程的TERMINED状态" class="headerlink" title="线程的TERMINED状态"></a>线程的TERMINED状态</h2><p>&emsp;&emsp;该状态为线程的最终状态，不会再切换到任何状态，此时线程的生命周期结束。</p><p>&emsp;&emsp;1.正常操作，线程终止，结束生命周期。</p><p>&emsp;&emsp;2.线程逻辑运行异常结束。</p><p>&emsp;&emsp;3.JVM Crash导致所有线程结束。</p>]]></content>
      
      
      <categories>
          
          <category> JAVA </category>
          
          <category> 多线程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVA </tag>
            
            <tag> 多线程 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
